import{bq as $,X as N,_ as R,S as j,l as E,f as J,u as T,Q as L,bs as O,r as M,o as y,b as A,w as m,e as z,h as b,t as g,s as B,v as F,i as k,j as w}from"../bundle.js";import{M as V}from"./Modal.76578f76.js";const q=s=>new Promise((e,o)=>{$({onError:i=>{console.warn("error",i),o(i)}}).then(i=>{const{layerMap:r,chunkSize:a}=s;i.addListener("processedCoordinateData",u=>{e(u),i.terminate()}),i.sendQuery("processClearCoordinatesRecords",{batchSize:a,layerMap:r})})}),P=({chunks:s,includeVerified:e=!1},o=()=>{})=>{const i=async a=>{const{success:u,data:c}=await MAPS.Utils.Apex.invoke("maps.RemoteFunctions.processAJAXRequest",[a]);let n=0;const t={};let l=0,d=0;if(u)c.forEach(h=>{if(d++,h.success)n+=1;else{l+=1;const{queryId:f,recordId:_}=h;t[f]||(t[f]={records:{}}),t[f].records[_]=h}}),o({status:"working",success:n,failure:l,total:d,failureMap:t});else{const{serializedQueriesToClear:h}=a,f=JSON.parse(h),[_]=f,{recordIds:C,queryId:p}=_;l=C.length,d=C.length,t[p]||(t[p]={records:{}}),C.forEach(S=>{const[,v]=S.split("::");t[p].records[v]={}}),o({status:"working",success:n,failure:l,total:d,failureMap:t})}};new N({maxConcurrency:6,workers:s.map(a=>i.bind(globalThis,{ajaxResource:"TooltipAJAXResources",action:"clear_coordinates",includeVerifiedCoordinates:e,serializedQueriesToClear:JSON.stringify([a])})),done:()=>{o({status:"done"})}}).start()},Q={components:{Modal:V,Spinner:j,SLDSButton:E},props:{modalOptions:{type:Object,default:()=>{}}},emits:["close-modal"],setup(){const s=J(),e=T();return{mainStore:s,listStore:e}},data(){return{chunks:[],isLoading:!1,status:{success:0,failure:0,remaining:0}}},async created(){let s=this.modalOptions.actionData||{};s=JSON.parse(JSON.stringify(s)),Object.keys(s).forEach(o=>{const i=s[o];if(this.status.remaining+=i.features.length,i.type==="sfMarkerLayer"&&this.listStore.listMap.has(o)){const a=this.listStore.listMap.get(o).recordMap;s[o].records=JSON.parse(JSON.stringify(Object.fromEntries(a)))}});const{chunks:e}=await q({layerMap:s,chunkSize:this.mainStore?.settings?.general?.MassFieldUpdateScopeSize});e.length===0?(this.mainStore.toast({message:this.$Labels.Clear_Coordinates_Cannot_Clear_Coordinates,subMessage:this.$Labels.Change_Owner_No_Records_Found,state:"warning",duration:5e3}),this.$nextTick(()=>{this.close()})):this.chunks=e},methods:{close(){this.$emit("close-modal")},formatTotalComplete(s){return L(this.$Labels.Layers_Processing_Remaining,[s])},processClearCoordinates(s=!1){this.isLoading=!0;const e={};try{P({chunks:this.chunks,includeVerified:s},o=>{const{status:i,success:r,failure:a,total:u,failureMap:c}=o;if(i==="working"){this.status.success+=r,this.status.failure+=a,this.status.remaining-=u,Object.keys(c).forEach(t=>{e[t]||(e[t]={records:{}});const l=c[t],{records:d}=l;e[t].records={...e[t].records,...d}});return}let n=this.modalOptions.actionData;if(Object.keys(e).length>0){const t=this.modalOptions.actionData;n={},Object.keys(e).forEach(l=>{const d=e[l],{records:h}=d,f=t[l],{features:_,type:C}=f;_.forEach(p=>{const{linkId:S}=p;h[S]||(n[l]||(n[l]={features:[],type:C}),n[l].features.push(p))})})}this.status.failure>0?(this.mainStore.toast({message:this.$Labels.MA_Clear_Coordinates_Info,subMessage:L(this.$Labels.Clear_Coordinates_Cannot_Clear,[this.status.failure]),state:"warning",duration:5e3}),this.status.success>0&&O(n)):(O(n),this.mainStore.toast({message:this.$Labels.MA_Clear_Coordinates_Info,subMessage:L(this.$Labels.Change_Owner_Records_Updated,[this.status.success,this.status.failure]),state:"success",duration:5e3})),MAPS.view.closePopup(),this.$emit("close-modal"),this.isLoading=!1})}catch(o){console.warn(o),this.$emit("close-modal"),this.isLoading=!1,this.mainStore.toast({message:this.$Labels.MA_Clear_Coordinates_Info,subMessage:this.$Labels.Clear_Coordinates_Cannot_Clear_Coordinates,state:"warning",duration:5e3})}}}},D={class:"popup-instructions"},x={class:"slds-grid"},X={class:"slds-col_bump-left"};function W(s,e,o,i,r,a){const u=M("Spinner"),c=M("SLDSButton"),n=M("Modal");return y(),A(n,{title:s.$Labels.MA_Clear_Coordinates,labels:{close:s.$Labels.MA_Close},class:"permission-modal",onClose:a.close},{content:m(()=>[r.isLoading?(y(),A(u,{key:0})):z("",!0),b("p",D,g(s.$Labels.MA_Clear_Coord_Info),1)]),footer:m(()=>[b("div",x,[B(b("div",null,[b("div",null,g(a.formatTotalComplete(r.status.remaining)),1)],512),[[F,r.isLoading]]),b("div",X,[k(c,{disabled:r.isLoading,class:"slds-button slds-button_neutral",onClick:a.close},{default:m(()=>[w(g(s.$Labels.MA_Cancel),1)]),_:1},8,["disabled","onClick"]),k(c,{disabled:r.isLoading,class:"slds-button slds-button_brand",onClick:e[0]||(e[0]=t=>a.processClearCoordinates(!1))},{default:m(()=>[w(g(s.$Labels.MA_Clear_Coord_Unverified),1)]),_:1},8,["disabled"]),k(c,{disabled:r.isLoading,class:"slds-button slds-button_brand",onClick:e[1]||(e[1]=t=>a.processClearCoordinates(!0))},{default:m(()=>[w(g(s.$Labels.MA_Clear_Coord_Verified),1)]),_:1},8,["disabled"])])])]),_:1},8,["title","labels","onClose"])}const K=R(Q,[["render",W]]);export{K as default};
