import{_ as S,l as _,S as v,f as A,bi as m,bu as C,bv as O,bw as L,r as u,o as y,b as f,w as d,h as k,j as l,t as p,e as b,i as g,p as F,k as I}from"../bundle.js";import{M as D}from"./Modal.76578f76.js";import{c as w,b as $}from"./click-2-create-mixin.44f9d4c1.js";import"./DatePicker.899772b4.js";import"./TimePicker.bfa4e2f9.js";const q={name:"CustomDispositionModalJQeury",components:{Modal:D,SLDSButton:_,Spinner:v},mixins:[w],props:{modalOptions:{type:Object,default:()=>{}}},emits:["close-modal"],setup(){return{mainStore:A()}},data(){return{loadingText:"Verifying Location...",isLoading:!1,dispositionData:{fields:"",fieldSet:""},isCheckOut:!1,checkInId:""}},async created(){this.isCheckOut=this.modalOptions.isCheckOut,this.checkInId=this.modalOptions.checkInId,await this.initDispositionForm()},methods:{async queryTaskData(){let t="Select Subject,";const s=new Set,e=this.mainStore?.settings?.checkIn?.general||{};Object.keys(e).forEach(i=>{const o=e[i];i!=="AutoCheckOutEnabled"&&i!=="Activity-FieldSet"&&o!=="Select"&&s.add(o)}),t+=Array.from(s).join(),t=t.replace(/,\s*$/,""),t+=` From Task Where Id = '${this.checkInId}'`;const c={ajaxResource:"TooltipAJAXResources",action:"do_query",q:t};try{const{success:i,records:o=[]}=await MAPS.Utils.Apex.invoke("maps.RemoteFunctions.processAJAXRequest",[c]);if(i){const[a]=o;if(a){const{feature:r}=this.$props.modalOptions,n=MAPS.myPosition?.graphic?.attributes||{},h=MAPS.myPosition.tracking?await m.distanceBetweenPoints([n.longitude,n.latitude],[r.lng,r.lat]):"";return{subject:a.Subject||"",createdLatitude:a[e["Activity-CreatedLatitude"]]||"",createdLongitude:a[e["Activity-CreatedLongitude"]]||"",checkOutAccuracy:n.accuracy,createdLocationAccuracy:a[e["Activity-CreatedLocationAccuracy"]]||"",distanceFromRecord:a[e["Activity-DistanceFromRecord"]],checkOutDistanceFromRecord:h===""?"":h*621371e-9,checkOutLatitude:n.latitude,checkOutLongitude:n.longitude}}}return{}}catch(i){return console.warn(i),{}}},async verifyCheckin(){const{feature:t}=this.$props.modalOptions,{success:s,data:e}=await C(t);s||(this.mainStore.toast({message:e,state:"warning"}),this.close())},async initDispositionForm(){const{feature:t}=this.$props.modalOptions;this.isLoading=!0,this.isCheckOut||await this.verifyCheckin();const s=this.mainStore?.settings?.checkIn?.general?.["Activity-FieldSet"],e="dispositionForm";await this.base_buildFieldSetHTML({fieldSet:s,htmlElementId:e,sObject:"Task",visualForcePage:"maps__ClickToCreateForm"}),await this.$nextTick(),this.base_attachCssIcons({htmlElementId:e});const c=MAPS.myPosition?.graphic?.attributes||{},i=MAPS.myPosition.tracking?await m.distanceBetweenPoints([c.longitude,c.latitude],[t.lng,t.lat]):"";let o={subject:`CheckIn @ ${t.title}`,createdLatitude:c.latitude,createdLongitude:c.longitude,checkOutAccuracy:c.accuracy,createdLocationAccuracy:c.accuracy,distanceFromRecord:i===""?"":i*621371e-9,checkOutDistanceFromRecord:i===""?"":i*621371e-9,checkOutLatitude:c.latitude,checkOutLongitude:c.longitude};this.isCheckOut&&(o=await this.queryTaskData()),this.attachDataToForm(o),this.isLoading=!1},async attachDataToForm(t){const s=this.mainStore?.settings?.checkIn?.general||{};try{document.querySelector('#dispositionForm .fieldInput[data-field="Subject"] .get-input').value=t.subject||""}catch{}try{document.querySelector('#dispositionForm .fieldInput[data-field="Status"] .get-input').value="Completed"}catch{}try{document.querySelector(`#dispositionForm .fieldInput[data-field="${s["Activity-CheckOutAccuracy"]}"] .get-input`).value=t.checkOutAccuracy||""}catch{}try{const e=MAPS.app.config.globalProperties.$F("DateTime",new Date,{});document.querySelector(`#dispositionForm .fieldInput[data-field="${s["Activity-CheckOutDate"]}"] .get-input`).value=e}catch{}try{document.querySelector(`#dispositionForm .fieldInput[data-field="${s["Activity-CheckOutDistanceFromRecord"]}"] .get-input`).value=t.checkOutDistanceFromRecord||""}catch{}try{document.querySelector(`#dispositionForm .fieldInput[data-field="${s["Activity-CheckOutLatitude"]}"] .get-input`).value=t.checkOutLatitude||""}catch{}try{document.querySelector(`#dispositionForm .fieldInput[data-field="${s["Activity-CheckOutLongitude"]}"] .get-input`).value=t.checkOutLongitude||""}catch{}try{document.querySelector(`#dispositionForm .fieldInput[data-field="${s["Activity-CreatedLatitude"]}"] .get-input`).value=t.createdLatitude||""}catch{}try{document.querySelector(`#dispositionForm .fieldInput[data-field="${s["Activity-CreatedLongitude"]}"] .get-input`).value=t.createdLongitude||""}catch{}try{document.querySelector(`#dispositionForm .fieldInput[data-field="${s["Activity-CreatedLocationAccuracy"]}"] .get-input`).value=t.createdLocationAccuracy||""}catch{}try{document.querySelector(`#dispositionForm .fieldInput[data-field="${s["Activity-DistanceFromRecord"]}"] .get-input`).value=t.distanceFromRecord||""}catch{}},close(){this.modalOptions.callback({success:!1}),this.$emit("close-modal")},async processDispositionData(){this.loadingText="",this.isLoading=!0,document.querySelector("#checkinPopup .slds-modal__content").scrollTop=0;let{fields:t}=$("dispositionForm");const s=[];Object.keys(t).forEach(o=>{const a=t[o];s.push({name:o,value:a})}),t=s;const c=(this.mainStore?.settings?.checkIn?.general||{})["Activity-FieldSet"];this.dispositionData.fields=JSON.stringify(t),this.dispositionData.fieldSet=c;const{feature:i}=this.$props.modalOptions;if(this.isCheckOut){const{success:o}=await O({feature:i,dispositionData:this.dispositionData,layerUID:i.layerId,checkInId:this.checkInId});this.isLoading=!1,o&&(this.modalOptions.callback({success:!0}),this.$emit("close-modal"))}else{const{success:o}=await L({feature:i,dispositionData:this.dispositionData,isMapIt:!1});this.isLoading=!1,o&&(this.modalOptions.callback({success:!0}),this.$emit("close-modal"))}}}},M=t=>(F("data-v-82580423"),t=t(),I(),t),P={class:"slds-grid",style:{"min-height":"100px",width:"100%"}},T=M(()=>k("div",{id:"dispositionForm",style:{width:"100%"}},null,-1));function j(t,s,e,c,i,o){const a=u("Spinner"),r=u("SLDSButton"),n=u("Modal");return y(),f(n,{id:"checkinPopup",title:t.$Labels.MA_Custom_Disposition,onClose:o.close},{content:d(()=>[k("div",P,[i.isLoading?(y(),f(a,{key:0,adjustForOverflow:""},{description:d(()=>[l(p(i.loadingText),1)]),_:1})):b("",!0),T])]),footer:d(()=>[g(r,{class:"slds-button slds-button_neutral",variant:"brand",disabled:i.isLoading,onClick:o.processDispositionData},{default:d(()=>[l(p(t.$Labels.MA_Finish),1)]),_:1},8,["disabled","onClick"]),g(r,{class:"slds-button slds-button_neutral",disabled:i.isLoading,onClick:o.close},{default:d(()=>[l(p(t.$Labels.MA_Cancel),1)]),_:1},8,["disabled","onClick"])]),_:1},8,["title","onClose"])}const J=S(q,[["render",j],["__scopeId","data-v-82580423"]]);export{J as default};
