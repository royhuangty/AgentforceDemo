import{F as b,i as k}from"./index.2826ab44.js";import{i as C}from"./index.a18e5735.js";import{_ as M,S as P,l as w,P as D,O as L,aO as O,aT as T,f as N,r as i,o as _,b as R,w as h,e as f,h as v,i as u,j as g,t as A}from"../bundle.js";import{M as V}from"./Modal.76578f76.js";import{P as F}from"./Popover.93a0feed.js";import{R as I}from"./RouteSaveMixin.1664df7a.js";const $={name:"RouteCalendar",components:{FullCalendar:b,Modal:V,Spinner:P,SLDSButton:w,Picklist:D,Popover:F,TextInput:L},mixins:[I],props:{modalOptions:{type:Object,required:!0}},emits:["close-modal"],setup(){const t=O(),e=T(),o=N();return{routesStore:t,mainStore:o,scheduleStore:e}},data(){return{asset:{},searchTerm:"",newRoute:{name:"",date:null},month:"",year:"",showSaveRoutePopover:!1,saveRoutePopoverBindTo:null,assetSearch:[{options:t=>new Promise(async e=>{const o=await this.getAssets({searchTerm:t});e(o)})}],loading:!1,calendarOptions:{plugins:[C,k],headerToolbar:{left:"",center:"",right:""},datesSet:this.updateEvents,events:[],initialView:"dayGridMonth",selectable:!0,contentHeight:400,select:this.handleDateSelect},currentEvents:[]}},computed:{initialDate(){return`${this.year}-${this.month}-2`},months(){return[{key:"0",value:this.$Labels.MA_January},{key:"1",value:this.$Labels.MA_February},{key:"2",value:this.$Labels.MA_March},{key:"3",value:this.$Labels.MA_April},{key:"4",value:this.$Labels.MA_May},{key:"5",value:this.$Labels.MA_June},{key:"6",value:this.$Labels.MA_July},{key:"7",value:this.$Labels.MA_August},{key:"8",value:this.$Labels.MA_September},{key:"9",value:this.$Labels.MA_October},{key:"10",value:this.$Labels.MA_November},{key:"11",value:this.$Labels.MA_December}]},years(){return this.getYears()}},created(){this.asset={...this.routesStore.asset},this.month=String(this.routesStore.month),this.year=this.routesStore.year,this.newRoute.name=this.routesStore.currentRoute.Name,this.searchTerm=this.asset.Name},mounted(){this.updateCalendarDate(),this.updateEvents()},methods:{async handleDateSelect(t){this.showSaveRoutePopover=!1,await this.$nextTick();const{jsEvent:e}=t;this.saveRoutePopoverBindTo=e.target,await this.$nextTick(),this.showSaveRoutePopover=!0,this.newRoute.date=t.start},hideSaveRoutePopover(){this.showSaveRoutePopover=!1},getYears(){const t=[],e=new Date,o=e.getFullYear()-5,r=e.getFullYear()+5;for(let s=o;s<=r;s++)t.push(s);return t},async updateCalendarDate(){const t=this.$refs.fullCalendar.getApi(),e=new Date(Date.UTC(this.year,Number(this.month),15));t.gotoDate(e),await this.updateEvents()},async updateEvents(){this.loading=!0,this.calendarOptions.events=[];const e=this.$refs.fullCalendar.getApi().getDate(),o={ajaxResource:"WaypointAJAXResources",action:"getRoutes",month:e.getMonth()+1,year:e.getFullYear(),lookupField:this.asset.field,lookupId:this.asset.Id};try{const{success:r,routes:s}=await MAPS.Utils.Apex.invoke("maps.RemoteFunctions.processAJAXRequest",[o]);r&&Object.keys(s).forEach(a=>{const d=s[a],c=Number(a);!Number.isNaN(c)&&Array.isArray(d)&&d.forEach(l=>{let p=null;const m=l?.routeId||l?.route?.Id,S=MAPS.Utils.String.htmlDecode(l?.route?.Name),y=l?.route.maps__Date__c||l?.route?.maps__RouteDate__c;p={id:m,title:S,date:y,allDay:!0},this.calendarOptions.events.push(p)})})}catch(r){console.error(r)}finally{this.loading=!1}},async getAssets({searchTerm:t}){const e={ajaxResource:"WaypointAJAXResources",action:"getRouteUserOptions",roleIds:JSON.stringify(this.scheduleStore.subRoleIdsList),term:t,usersOnly:!1};try{const{success:o,data:r}=await MAPS.Utils.Apex.invoke("maps.RemoteFunctions.processAJAXRequest",[e]);return o?r:(console.error(r),[])}catch(o){return console.error(o),[]}},async setAsset(t){const e=t?.fields||[],[o]=e;this.asset={Id:t.id,Name:t.label,field:o.apiName,type:o.label},await this.updateEvents()},async routePopoverSaveRoute(){this.loading=!0,this.hideSaveRoutePopover();let{summary:{totaltraveltime:t,distance:e}}=this.routesStore.currentRoute;t&&(t/=60),e&&(e=(e*621371e-9).toFixed(1));const{name:o,date:r}=this.newRoute,s={name:MAPS.Utils.String.htmlDecode(o),day:r.getDate(),month:r.getMonth(),year:r.getFullYear(),lookupId:this.asset.Id,lookupField:this.asset.field,user:this.currentRoute.User,options:{DriveProfile:this.currentRoute.travelMode,TimeBasedOptions:this.currentRoute.timeBasedOptions},distance:e,totaltraveltime:t,waypoints:this.getWaypointRecordsForSave()};try{const{success:a,routeId:d}=await this.routesStore.saveRoute(s);a?(this.mainStore.toast({message:this.$Labels.MA_Success}),this.asset&&this.asset.Id!==this.routesStore.asset.Id&&(this.routesStore.asset={...this.asset,...this.routesStore.asset}),this.modalOptions.callback({routeId:d}),this.$emit("close-modal")):this.mainStore.toast({message:"Could not save route",state:"error"})}catch(a){console.warn("error while saving route.",a),this.mainStore.toast({message:String(a),state:"error"})}finally{this.loading=!1}}}},x={style:{"min-height":"400px"}},B={class:"slds-grid slds-gutters"},U={class:"slds-grid slds-grid_vertical-align-end"},E={class:"slds-p-left_x-small slds-col"};function Y(t,e,o,r,s,a){const d=i("Spinner"),c=i("Picklist"),l=i("FullCalendar"),p=i("TextInput"),m=i("SLDSButton"),S=i("Popover"),y=i("Modal");return _(),R(y,{id:"routeSaveModalResource",title:t.$Labels.MA_Save_Route,size:"medium",onClose:e[5]||(e[5]=n=>t.$emit("close-modal"))},{content:h(()=>[s.loading?(_(),R(d,{key:0})):f("",!0),v("div",x,[v("div",B,[u(c,{modelValue:s.searchTerm,"onUpdate:modelValue":e[0]||(e[0]=n=>s.searchTerm=n),inputAttrs:{id:"routeCalendarUserPicklistResource"},class:"slds-col slds-size_2-of-8",filterable:"",idKey:"id",titleKey:"label",options:s.assetSearch,onSelectedOption:a.setAsset},null,8,["modelValue","options","onSelectedOption"]),u(c,{modelValue:s.month,"onUpdate:modelValue":e[1]||(e[1]=n=>s.month=n),inputAttrs:{id:"routeCalendarMonthPicklistResource"},options:a.months,idKey:"key",class:"slds-col slds-grow-none",titleKey:"value",onSelectedOption:a.updateCalendarDate},null,8,["modelValue","options","onSelectedOption"]),u(c,{modelValue:s.year,"onUpdate:modelValue":e[2]||(e[2]=n=>s.year=n),inputAttrs:{id:"routeCalendarYearPicklistResource"},options:a.years,class:"slds-col slds-grow-none",onSelectedOption:a.updateCalendarDate},null,8,["modelValue","options","onSelectedOption"])]),u(l,{ref:"fullCalendar",options:s.calendarOptions},null,8,["options"]),s.showSaveRoutePopover?(_(),R(S,{key:0,id:"routeCalendarRoutePopoverDialogResource",bindTo:s.saveRoutePopoverBindTo,width:"medium",onClose:a.hideSaveRoutePopover},{content:h(()=>[v("div",U,[u(p,{modelValue:s.newRoute.name,"onUpdate:modelValue":e[3]||(e[3]=n=>s.newRoute.name=n),inputAttrs:{id:"routeCalendarPopoverRouteNameResource"},required:"",labels:{name:t.$Labels.MA_Route_Name,placeholder:t.$Labels.routes_Give_Route_Name,required:t.$Labels.MA_Required},class:"slds-col"},null,8,["modelValue","labels"]),v("div",E,[u(m,{id:"routeCalendarPopoverRouteSaveBtnResource",variant:"brand",onClick:a.routePopoverSaveRoute},{default:h(()=>[g(A(t.$Labels.MA_Save),1)]),_:1},8,["onClick"])])])]),_:1},8,["bindTo","onClose"])):f("",!0)])]),footer:h(()=>[u(m,{id:"routeCalendarCancelBtnResource",class:"slds-button",variant:"neutral",onClick:e[4]||(e[4]=n=>t.$emit("close-modal"))},{default:h(()=>[g(A(t.$Labels.MA_Cancel),1)]),_:1})]),_:1},8,["title"])}const z=M($,[["render",Y],["__scopeId","data-v-0743ae6b"]]);export{z as default};
