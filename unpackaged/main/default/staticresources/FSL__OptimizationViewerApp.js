!function(){var e=angular.module("serviceExpert",["uiGmapgoogle-maps","angularMoment","ui.bootstrap","chart.js","MstResolver"]);e.run(["amMoment",function(e){var t=userLocale;-1!=userLocale.indexOf("iw")&&(t=userLocale.replace("iw","he")),e.changeLocale(t)}]),e.config(["$sceDelegateProvider","$compileProvider","MstResolverProvider",function(e,t,n){var i=null,s=_.debounce(window.scheduler.updateView,100).bind(window.scheduler),t=(window.updateViewDebounced=function(){i||0!==document.body.clientWidth?0!==document.body.clientWidth&&(i&&(clearInterval(i),i=null),s()):i=setInterval(window.updateViewDebounced,1e3)},debugMode||t.debugInfoEnabled(!1),n.setConfig({fslOperationRemoteAction:RemoteActions.getFslOperation,getAsyncApexJobRemoteAction:RemoteActions.getAsyncApexJob,apiVersion:"41.0",fieldNames:fieldNames.FslOperation,autoConnect:!1}),["self","https://**.force.com"]);window.orgUrl&&t.push(window.orgUrl),e.resourceUrlWhitelist(t)}])}(),angular.module("serviceExpert").controller("ctrlGantt",["$scope","$rootScope","$q","BundleService","BundleActions","sfdcService","servicesService","utils","calendarsService","userSettingsManager","resourceFilterHelper","monthlyViewHelperService","ResourcesAndTerritoriesService","TimePhasedDataService","StateService","CapacityLightboxService","ResourceSmallMenu","AbsencesService","SkillsService","DeltaService","AbsenceLightboxService","ResourceLightboxService","ServiceAppointmentLightboxService","kpiCalculationsService","ResourceCapacitiesService","ResourceCrewsService","SERVICE_STATUS","SERVICE_CATEGORY","GetSlotsService","bulkScheduleService","GeneralLightbox","StreamingClientResolverService","StreamingAPIService","RegisterService","OptimizationRequestsService","GanttPalettesService","PushServices","AgentforceSchedulingIntroLightboxService",function(g,s,t,v,f,a,S,b,G,n,r,B,c,d,y,H,V,l,o,u,p,U,m,h,z,j,W,q,Z,K,w,Y,J,e,T,X,L,Q){var A="",I="",C={},k=!0,D=new dhtmlXMenuObject({parent:"contextZone_A",context:!0}),R=new dhtmlXMenuObject({parent:"contextZone_A",context:!0}),F=null,i={};function ee(){g.currentViewOptions.numOfMonths<=2?(scheduler.matrix.LongView.x_unit="day",scheduler.matrix.LongView.x_length=7,scheduler.matrix.LongView.x_size=30*g.currentViewOptions.numOfMonths):(scheduler.matrix.LongView.x_unit="week",scheduler.matrix.LongView.x_size=Math.ceil(4.5*g.currentViewOptions.numOfMonths),scheduler.matrix.LongView.x_length=1)}D.setOverflowHeight(15),R.setOverflowHeight(15),g.selectedGanttServices={},g.resourceFilterHelper=r,g.StateService=y,g.resources=[],g.searchEmployee="",g.resourceFieldToSortyBy="Name",g.successfullyScheduled=0,g.currentSchedulingIndex=0,g.timelineName="",g.nowTimespans=[],g.seachSkillsText="",g.selectedSkills={},g.selectedSkillCounter=0,g.showSelectedList=!1,g.searchSkillsResults=[],g.pinnedStatusesSF=CustomSettings.pinnedStatusesSF.split(","),g.hasCustomPermission=b.hasCustomPermission,g.crewViewActive=!1,g.crewsFilter=b.crewsFilter,g.useResourceSkillFilter=useResourceSkillFilter,g.numberOfDaysInUtilizationView=14,g.skillsLogicOperator=n.GetUserSettingsProperty("Skills_Logic_Operator__c")||"and",g.location=n.GetUserSettingsProperty("locations")||[],g.horizontalScrolling={enabled:n.GetUserSettingsProperty("HorizontalScrolling__c")||!1},g.showCalendarWeeks={enabled:n.GetUserSettingsProperty("Show_Calendar_Weeks__c")||!1},__gantt.horizontalScrolling=g.horizontalScrolling.enabled,__gantt.showCalendarWeeks=g.showCalendarWeeks.enabled,g.editPalette=b.hasCustomPermission("Gantt_Palettes_Edit"),g.viewPalette=b.hasCustomPermission("Gantt_Palettes_View"),scheduler.attachEvent("onTemplatesReady",function(){scheduler.matrix.MonthlyView&&(scheduler.matrix.MonthlyView.x_size=n.GetUserSettingsProperty("DaysInUtilizationView__c")||14,g.numberOfDaysInUtilizationView=scheduler.matrix.MonthlyView.x_size),ee()}),__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Gantt_Locker?g.ganttLocked=n.GetUserSettingsProperty("Lock_Gantt__c")||!1:(g.ganttLocked=!0,scheduler.config.readonly=!0),scheduler.config.readonly=g.ganttLocked,g.currentViewOptions={highlightWeekeneds:n.GetUserSettingsProperty("Highlight_Weekeneds__c")||!1,minServiceDuration:void 0===n.GetUserSettingsProperty("Longterm_Min_Service_Duration__c")?8:n.GetUserSettingsProperty("Longterm_Min_Service_Duration__c"),minNaDuration:void 0===n.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c")?8:n.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c"),numOfMonths:n.GetUserSettingsProperty("Longterm_Num_Of_Months__c")||1,showMdt:n.GetUserSettingsProperty("Show_Only_MDT_In_Longterm__c")||!1},window.__currentViewOptions=g.currentViewOptions,g.saveMdtFilterSa=_.debounce(function(){n.SetUserSettingsProperty("Show_Only_MDT_In_Longterm__c",g.currentViewOptions.showMdt),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.getTimePhasedObjects()},400),g.saveHighlightWeekends=_.debounce(function(){n.SetUserSettingsProperty("Highlight_Weekeneds__c",g.currentViewOptions.highlightWeekeneds),updateViewDebounced()},400),g.saveMinimumLongtermServiceDuration=_.debounce(function(){n.SetUserSettingsProperty("Longterm_Min_Service_Duration__c",g.currentViewOptions.minServiceDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.getTimePhasedObjects()},400),g.saveMinimumLongtermAbsenceDuration=_.debounce(function(){n.SetUserSettingsProperty("Longterm_Min_Absence_Duration__c",g.currentViewOptions.minNaDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.getTimePhasedObjects()},400),g.handleLongTermViewSizeChange=_.debounce(function(){var e=n.GetUserSettingsProperty("Longterm_Num_Of_Months__c");g.currentViewOptions.numOfMonths||(g.currentViewOptions.numOfMonths=1),n.SetUserSettingsProperty("Longterm_Num_Of_Months__c",g.currentViewOptions.numOfMonths),ee(),"LongView"===scheduler._mode&&scheduler.setCurrentView(),e<g.currentViewOptions.numOfMonths&&g.getTimePhasedObjects()},200),g.shouldShowSkill=function(e,t){return e.toUpperCase().includes(t.toUpperCase())},g.searchSkills=function(e){2<=e.length?a.callRemoteAction(RemoteActions.getSkillsSearchStartWith,e).then(function(e){g.searchSkillsResults=ie(e,"MasterLabel")}).catch(function(e){console.log(e),console.warn("unable to get skill list")}):g.searchSkillsResults=[]},g.selectSkillFromCheckbox=function(e,t){e.target.checked&&oe(t,!0)},g.selectSkillFromSearchInput=function(t){g.selectedSkills[t.Id]||(g.skillsList.some(function(e){return t.Id===e.Id})||(g.skillsList=g.skillsList.concat(t)),oe(t,!1)),se()},g.updateSelectedCount=function(e){e&&e.stopPropagation(),g.selectedSkillCounter=0;var t,n=[];for(t in g.selectedSkills)g.selectedSkills.hasOwnProperty(t)&&!0===g.selectedSkills[t]&&(g.selectedSkillCounter++,n.push(t));0===g.selectedSkillCounter&&(g.showSelectedList=!1),ne(n),g.skillsFilter=0<g.selectedSkillCounter};var te,ne=_.debounce(function(e){n.SetUserSettingsProperty("Filter_Resources_BySkills__c",JSON.stringify(e))},800);function ie(e,n){return e.sort(function(e,t){return e[n].localeCompare(t[n])})}function se(){g.searchSkillsResults=[],g.seachSkillsText=""}function re(e,t){g.selectedSkills[e]=!!t||(g.selectedSkills[e]=!g.selectedSkills[e]),g.updateSelectedCount()}function oe(e,t){var n,i;o.cachedServerSideSkillIds[e.Id]?re(e.Id):(n=scheduler.getState().min_date,i=scheduler.getState().max_date,n.setMonth(n.getMonth()-1),i.setFullYear(i.getFullYear()+1),o.getResourcesWithSelectedSkillIdFromServer(e.Id,b.getFilteredLocations(),n,i).then(function(){o.cachedServerSideSkillIds[e.Id]=!0,o.setServerSkill({Id:e.Id}),t||re(e.Id,!0)}))}function ae(e){o.getSkillsFromResourcesList(e).then(function(e){g.skillsList=ie(e,"MasterLabel"),g.needToLoadSkills=!1}).catch(function(e){console.log(e),console.warn("unable to get skill list"),g.skillsList=[],g.needToLoadSkills=!1})}g.showSelectedSkillsList=function(e){g.showSelectedList=!g.showSelectedList},n.GetUserSettingsProperty("Filter_Resources_BySkills__c")&&((te=JSON.parse(n.GetUserSettingsProperty("Filter_Resources_BySkills__c"))).forEach(function(e){g.selectedSkills[e]=!0,o.cachedServerSideSkillIds[e]=!0}),g.selectedSkillCounter=te.length),g.skillsFilter=!!n.GetUserSettingsProperty("Filter_Resources_BySkills__c")&&0<JSON.parse(n.GetUserSettingsProperty("Filter_Resources_BySkills__c")).length,g.setFilterShowButtonLabel=function(){return g.showSelectedList?customLabels.ShowAllSkills_Filter:customLabels.ShowSelectedSkills_Filter.replace("{0}",g.selectedSkillCounter)},g.saveUserPropSkillsLogic=function(){n.SetUserSettingsProperty("Skills_Logic_Operator__c",g.skillsLogicOperator)},g.paletteViewActive=!1,g.showPaletteView=function(){window.paletteViewActive=!0,g.paletteViewActive=!0,updateViewDebounced()},g.hidePaletteView=function(){window.paletteViewActive=!1,g.paletteViewActive=!1,updateViewDebounced()},g.$watch("StateService.isLoadingNewLocations",function(e,t){void 0!==t&&!1!==t||1!=e||(g.paletteViewActive=!1),o.cachedServerSideSkillIds={},!0===g.filterVisibility.skills&&ae(g.selectedSkills)}),s.statusTranslations=b.statusTranslations,s.$on("moveToCrewView",function(){s.crewViewActive=!0,g.crewViewActive=!0,d.isCrewViewActive=!0}),g.$watch("resourceFilterHelper",function(e,t){$("#resourceExplainCrap").html(g.resourceFilterHelper.generateFilterExplanation(g.resourceFilters.showWorkingResource)),angular.equals(e,t)||n.SetUserSettingsProperty("Resource_Filter__c",JSON.stringify({sortBy:g.resourceFilterHelper.resourceFieldToSortyBy,asc:g.resourceFilterHelper.descending,showWorkingResource:g.resourceFilters.showWorkingResource,booleanFields:g.resourceFilterHelper.selectionInfo.resourceFilteringOptions,picklistField:g.resourceFilterHelper.selectionInfo.selectedPicklist,picklistOptions:g.resourceFilterHelper.selectionInfo.picklistOptions,picklistOptionsModel:g.resourceFilterHelper.selectionInfo.picklistOptionsModel,picklistNullValues:g.resourceFilterHelper.selectionInfo.picklistNullValues,crewsOption:g.resourceFilterHelper.selectionInfo.crewsSelectionOptions.selectedPicklist}))},!0),g.absencesTypeLoaded=!1,g.defaultDragNa={selectedNaDuration:JSON.parse(n.GetUserSettingsProperty("Drag_Na_Duration__c"))||60,selectedNaType:n.GetUserSettingsProperty("Drag_Na_Type__c"),selectedNaLabel:n.GetUserSettingsProperty("Drag_Na_Label__c")},g.defaultDragNa.selectedHours=Math.floor(g.defaultDragNa.selectedNaDuration/60),g.defaultDragNa.selectedMinutes=g.defaultDragNa.selectedNaDuration%60,g.getNaDurationFormatted=function(){var e=Math.floor(g.defaultDragNa.selectedNaDuration/60),t=g.defaultDragNa.selectedNaDuration%60;return window.customLabels.AbsenceCreatorFormat.replaceAll(e,t)},g.getEmployeeAbsenceTypes=function(){g.absencesTypeLoaded||l.getEmployeeAbsenceTypes().then(function(e){g.absencesTypeLoaded=!0,g.nonAvailabilityTypes=e,g.defaultDragNa.selectedNaType=n.GetUserSettingsProperty("Drag_Na_Type__c")||g.nonAvailabilityTypes[Object.keys(g.nonAvailabilityTypes)[0]]})},g.businessHoursRange={start:b.ganttSettings.startHour,end:b.ganttSettings.finishHour,includeWeekends:n.GetUserSettingsProperty("Include_Weekends__c")},g.resourceFilters={showWorkingResource:!!JSON.parse(n.GetUserSettingsProperty("Resource_Filter__c"))&&JSON.parse(n.GetUserSettingsProperty("Resource_Filter__c")).showWorkingResource,resourcesWorkingInRange:{}},g.isInConsole=y.isInConsole,g.openConsoleTab=b.openConsoleTab,g.capacityFields=B.capacityCalculationFields,Object.defineProperty(g.selectedGanttServices,"getSelected",{enumrable:!1,value:function(){var e,t=[];for(e in this)this[e]&&t.push(e);return t}}),g.isGanttFilterApplied=function(){return b.crewsFilter||window.useResourceSkillFilter&&g.skillsFilter||r.isResourceFilterApplied()||g.resourceFilters.showWorkingResource},cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix"));var le=!0;function ce(){var e;le?le=!1:(setHoursToDisplay(g.businessHoursRange.start,g.businessHoursRange.end,g.businessHoursRange.includeWeekends),scheduler.setCurrentView(),b.ganttSettings.startHour=g.businessHoursRange.start,b.ganttSettings.finishHour=g.businessHoursRange.end,(e={}).Gantt_View_Start_Hour__c=b.ganttSettings.startHour,e.Gantt_View_Finish_Hour__c=b.ganttSettings.finishHour,e.Include_Weekends__c=g.businessHoursRange.includeWeekends,n.SetUserSettingProperties(e))}function O(e,t){null!==(t=""===t?prompt(customLabels.msg_to_post_to_chatter,""):t)&&(""===t?alert(customLabels.no_empty_msg_to_chatter):(1===e.length&&(S.recentlyUsed[e[0]]=!0),S.postToChatter(e,t).then(function(e){})))}g.$watchCollection("businessHoursRange",ce),c.promises.resources().then(function(){g.resources=c.getResources}),g.saveDragNaDefaults=function(e){if(null!=g.defaultDragNa.selectedHours&&null!=g.defaultDragNa.selectedMinutes)switch(e){case"duration":var t=60*g.defaultDragNa.selectedHours+g.defaultDragNa.selectedMinutes;g.defaultDragNa.selectedNaDuration=t||60,n.SetUserSettingsProperty("Drag_Na_Duration__c",t);break;case"type":n.SetUserSettingsProperty("Drag_Na_Type__c",g.defaultDragNa.selectedNaType);break;case"label":n.SetUserSettingsProperty("Drag_Na_Label__c",g.defaultDragNa.selectedNaLabel)}},g.getTimePhasedObjects=function(e){var t=scheduler.getState().min_date,n=scheduler.getState().max_date,i=864e5;return"LongView"===scheduler._mode&&(i*=scheduler.matrix.LongView.x_length),y.isRtlDirection()&&(i*=-1),"left"===e?(t.setTime(t.getTime()-i),n.setTime(n.getTime()-i)):"right"===e&&(t.setTime(t.getTime()+i),n.setTime(n.getTime()+i)),L.isPushServiceActive()&&L.updateSession({operation:L.MESSAGE_OPERATIONS.UPDATE}),d.getTimePhasedObjects(t,n).then(function(e){var t;s.$broadcast("ganttFinishedLoadingServices"),updateViewDebounced(),k&&("Always"!==window.__gantt.checkRulesMode&&h.calculateKpis(),k=!1,updateViewDebounced(),t=null,-1<document.URL.indexOf("service=")&&(t=document.URL.substr(document.URL.indexOf("service=")+8,18)),scheduler._events[t]?(scheduler._select_id=t,scheduler.select(t),setTimeout(function(){b.showOnGantt(t)},0)):t&&alert(customLabels.cant_display_service))})},g.changeDatesByArrows=function(e){updateViewDebounced(),g.getTimePhasedObjects(e)},scheduler.attachEvent("onDblClick",function(e,t){scheduler._events[e].isDummy||(N(),b.safeApply(g,function(){("service"===scheduler.getEvent(e).type?(S.recentlyUsed[e]=!0,m):"contractorcapacity"===scheduler.getEvent(e).type?H:p).open(e)}))}),scheduler.attachEvent("onBeforeFolderToggle",function(e,t){return folderJustToggled=!0,b.safeApply(g,function(){y.ganttOpenedTerritories[e.key]=t,de()}),!0});var de=_.debounce(function(){n.SetUserSettingsProperty("Toggled_Territories__c",JSON.stringify(y.ganttOpenedTerritories))},800);function M(){for(var e in g.selectedGanttServices)delete g.selectedGanttServices[e]}scheduler.attachEvent("onBeforeViewChange",function(e,t,n,i){return"MonthlyView"===e&&"MonthlyView"!==n&&"__Utilization__"===r.resourceFieldToSortyBy&&(r.resourceFieldToSortyBy="Name"),!0}),g.handleDoubleScrollBar=function(){var e=document.getElementsByClassName("dhx_cal_data")[0];g.horizontalScrolling.enabled&&["ZoomLevel5","ZoomLevel6","ZoomLevel7","LongView"].includes(scheduler._mode)?e.style.overflowY="hidden":e.style.overflowY=null},scheduler.attachEvent("onViewChange",function(e,t){removeAllHolidayPopovers(),b.safeApply(g,function(){switch(g.handleDoubleScrollBar(),scheduler._mode){case"ZoomLevel2":g.timelineName=customLabels.In_Day;break;case"ZoomLevel3":g.timelineName=customLabels.Daily;break;case"ZoomLevel4":g.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":g.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":g.timelineName=customLabels.Weekly;break;case"ZoomLevel7":g.timelineName=customLabels.TwoWeeks;break;case"MonthlyView":g.timelineName=customLabels.Utilization;break;case"MTDView":g.timelineName=customLabels.MDTVIEW;break;case"LongView":g.timelineName=customLabels.LongView}$("#MonthlyLocationViewTooltip").remove(),P(),updateViewDebounced(),scheduler._old.mode===e&&scheduler._old.date===t||h.calculateKpis()})}),scheduler.attachEvent("onBeforeDrag",function(e,t,n){if(!e||!scheduler._events[e].isDummy&&!window.__lockedServicesIds[e]){var i=void 0,n=n.ctrlKey||n.metaKey;if(!e||"create"===t){if(N(),!n)for(i in g.selectedGanttServices)g.selectedGanttServices[i]=!1,scheduler.getRenderedEvent(i)&&scheduler.updateEvent(i);return!1}if("resize"===t&&window.__gantt.currentResizableEvent===e?F=e:"move"===t&&(F=null,N()),e&&"service"===scheduler.getEvent(e).type){if(n)return F=null,R.hide(),g.selectedGanttServices[e]?g.selectedGanttServices[e]=!1:g.selectedGanttServices[e]=!0,scheduler.updateEvent(e),!1;for(i in g.selectedGanttServices[e]=!0,g.selectedGanttServices)i!==e&&(g.selectedGanttServices[i]=!1,scheduler.getEvent(i))&&scheduler.getSection(scheduler.getEvent(i).resourceId)&&scheduler.updateEvent(i)}else if(!n&&1<=g.selectedGanttServices.getSelected().length)for(i in g.selectedGanttServices)g.selectedGanttServices[i]=!1,scheduler.getRenderedEvent(i)&&scheduler.updateEvent(i);if(window.__gantt.currentResizableEvent!==e&&N(),(window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Drag_And_Drop||!scheduler._events[e])&&!("service"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type||e&&"service"===scheduler.getEvent(e).type&&scheduler.getEvent(e).pinned&&preventUpdateOfPinned))return!0}}),g.$watchCollection("selectedGanttServices",function(e,t){globalSelectedGanttServices=g.selectedGanttServices}),g.jumpToDate=function(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"JumpToDate",date:scheduler._date,navigation:!0,handler:function(e,t){scheduler.setCurrentView(e),scheduler.destroyCalendar(),g.changeDatesByArrows()}})};var E=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});E.setOverflowHeight(15),E.addNewChild(E.topId,0,"details",b.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),E.attachEvent("onClick",function(e,t,n){switch(N(),e){case"details":b.safeApply(g,function(){p.open(I)});break;case"resizeAbsence":I in scheduler._events&&!scheduler._events[I].isDummy&&(scheduler.config.drag_resize=!0,window.__gantt.currentResizableEvent=I,scheduler._events[I].hideTravelForResize(),scheduler.updateView());break;case"delete":b.safeApply(g,function(){confirm(customLabels.naDeleteConfirm)&&l.deleteAbsence(I).then(function(e){e?scheduler.deleteEvent(I):alert(customLabels.Failed_To_Delete_Break)})});break;default:var i,s,r,o;0===e.indexOf("custom_")&&(i=scheduler._events[I].type,r=parseInt(e.split("_")[1]),(s=b.getCustomActions(i)[r]).visualforce?(r=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),o=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),w.open(s.name,s.visualforce+"?id="+I+"&type="+i+"&start="+r+"&end="+o)):a.callRemoteAction(RemoteActions.runCustomAbsenceAction,s.className,I,i,scheduler._min_date,scheduler._max_date).then(function(e){u.updateGantt(),e&&b.addNotification(s.name,e,null,null)}).catch(function(e){return b.addNotification(s.name,e.message,null,null)}))}}),D.addNewChild(D.topId,0,"details",b.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),D.addNewChild(D.topId,3,"reschedule",b.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),D.addNewChild(D.topId,4,"resizeService",b.getSVGIconHTML(lsdIcons.sort,"rotateIcon90")+customLabels.resize_event_action_label,!1),window.customPermissions.Enable_Check_Rules&&D.addNewChild(D.topId,12,"validate",b.getSVGIconHTML(lsdIcons.violation)+customLabels.check_rules_action_label,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,4,"candidates",b.getSVGIconHTML(lsdIcons.candidates)+customLabels.Get_Candidates,!1),D.addNewChild(D.topId,10,"reshuffle",b.getSVGIconHTML(lsdIcons.retweet)+customLabels.Reshuffle,!1),D.addNewChild(D.topId,11,"groupNearby",b.getSVGIconHTML(lsdIcons.groupNearby)+customLabels.GroupNearby,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,5,"status",b.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),D.addNewChild(D.topId,6,"map",b.getSVGIconHTML(lsdIcons.world)+customLabels.Map,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,8,"unschedule",b.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),fieldTrackingEnabled.service&&(D.addNewChild(D.topId,7,"chatter",b.getSVGIconHTML(lsdIcons.chat)+customLabels.Chatter+"<i id='chatterArrowContext' class='fa fa-caret-right chatter-carret'></i>",!1),D.addNewChild("chatter",0,"chatter_welldone",b.getSVGIconHTML(lsdIcons.like)+customLabels.well_done,!1),D.addNewChild("chatter",1,"chatter_hurryup",b.getSVGIconHTML(lsdIcons.hurry)+customLabels.Hurry_up,!1),D.addNewChild("chatter",2,"chatter_requestupdate",b.getSVGIconHTML(lsdIcons.help)+customLabels.Request_update,!1),D.addNewChild("chatter",3,"chatter_custom",b.getSVGIconHTML(lsdIcons.threedots)+customLabels.Custom_message,!1)),b.customActionsPromise.then(function(){b.getCustomActions("gantt").forEach(function(e,t){e.icon?D.addNewChild(D.topId,12+t,"custom_"+t,b.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1):D.addNewChild(D.topId,12+t,"custom_"+t,e.name.encodeHTML(),!1)})}),v.isActive()&&b.hasCustomPermission("Bundle_Unbundle")&&(D.addNewChild(D.topId,41,"bundler",b.getSVGIconHTML(f.Bundle.icon)+f.Bundle.label,!1),D.addNewChild(D.topId,42,"unbundler",b.getSVGIconHTML(f.Unbundle.icon)+f.Unbundle.label,!1));var x={};function ue(e){for(var t in g.selectedGanttServices)g.selectedGanttServices[t]&&(S.flagged[t]=e);updateViewDebounced()}scheduler.attachEvent("onContextMenu",function(e,t){if(!scheduler.config.readonly){if(e&&"service"!==scheduler.getEvent(e).type&&"break"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type)return!1;var n;if(v.isActive()&&(i=g.selectedGanttServices.getSelected(),n=[],i.map(function(e){n.push(scheduler._events[e])}),b.hasCustomPermission("Bulk_Bundle")&&(R.hideItem("bundler"),f.Bundle.canInvoke(n))&&R.showItem("bundler"),b.hasCustomPermission("Bulk_Unundle"))&&(R.hideItem("unbundler"),f.Unbundle.canInvoke(n))&&R.showItem("unbundler"),e){D.hide(),R.hide(),E.hide(),scheduler.dhtmlXTooltip.hide();var i=0,s=0;if(t.pageX||t.pageY?(i=t.pageX,s=t.pageY):(t.clientX||t.clientY)&&(i=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,s=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),g.selectedGanttServices.getSelected().length<2)if("break"===scheduler._events[e].type)E.removeItem("delete"),E.removeItem("resizeAbsence"),b.getCustomActions("na").forEach(function(e,t){E.removeItem("custom_"+t)}),b.getCustomActions("break").forEach(function(e,t){E.removeItem("custom_"+t)}),b.getCustomActions("break").forEach(function(e,t){E.addNewChild(D.topId,t+10,"custom_"+t,b.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1)}),E.showContextMenu(i,s),I=e;else if("na"===scheduler._events[e].type)E.removeItem("delete"),E.removeItem("resizeAbsence"),b.hasCustomPermission("Enable_Event_Resizing")&&E.addNewChild(E.topId,1,"resizeAbsence",b.getSVGIconHTML(lsdIcons.sort,"rotateIcon90")+customLabels.resize_event_action_label,!1),E.addNewChild(E.topId,2,"delete",b.getSVGIconHTML(lsdIcons.delete)+customLabels.Delete,!1),b.getCustomActions("na").forEach(function(e,t){E.removeItem("custom_"+t)}),b.getCustomActions("break").forEach(function(e,t){E.removeItem("custom_"+t)}),b.getCustomActions("na").forEach(function(e,t){E.addNewChild(D.topId,12+t,"custom_"+t,b.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1)}),(I=e)in scheduler._events&&!scheduler._events[I].isDummy&&E.showContextMenu(i,s);else{for(var r=e,o=!1,a=0;a<g.pinnedStatusesSF.length;a++)scheduler._events[r].status===g.pinnedStatusesSF[a]&&(o=!0);if(v.isActive()&&b.hasCustomPermission("Bundle_Unbundle")&&(f.Bundle.canInvoke([scheduler._events[r]])?D.showItem("bundler"):D.hideItem("bundler"),f.Unbundle.canInvoke([scheduler._events[r]])?D.showItem("unbundler"):D.hideItem("unbundler")),scheduler._events[r].pinned||o?(D.hideItem("reschedule"),D.hideItem("candidates"),D.hideItem("unschedule"),D.hideItem("status"),D.hideItem("reshuffle"),D.hideItem("groupNearby"),D.hideItem("resizeService")):(D.showItem("reschedule"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)&&D.showItem("candidates"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&D.showItem("unschedule"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&D.showItem("status"),D.showItem("reshuffle"),D.showItem("groupNearby")),scheduler._events[r].pinned?D.hideItem("status"):(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&D.showItem("status"),scheduler._events[r].latitude&&scheduler._events[r].longitude&&b.hasCustomPermission("Group_Nearby")?D.showItem("groupNearby"):D.hideItem("groupNearby"),b.hasCustomPermission("Schedule")?scheduler._events[r].relatedService1&&scheduler._events[r].isImmidietlyFollow&&!scheduler._events[r].isInO2Territory?(D.hideItem("reschedule"),D.hideItem("candidates")):scheduler._events[r].isImmidietlyFollow&&!scheduler._events[r].isInO2Territory||D.showItem("reschedule"):D.hideItem("reschedule"),b.hasCustomPermission("Reshuffle")?D.showItem("reshuffle"):D.hideItem("reshuffle"),b.hasCustomPermission("Enable_Event_Resizing")?D.showItem("resizeService"):D.hideItem("resizeService"),D.removeItem("showRelated"),(scheduler._events[r].isServiceInChain||scheduler._events[r].relatedTo||scheduler._events[r].relatedFather)&&D.addNewChild(D.topId,5,"showRelated",b.getSVGIconHTML(lsdIcons.related)+customLabels.Show_related,!1),y.isMapEnabled()&&null!==scheduler._events[r].latitude?D.showItem("map"):D.hideItem("map"),D.removeItem("flag"),S.flagged[r]?D.addNewChild(D.topId,1,"flag","<span class='emptyFlag'>"+b.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Unflag,!1):D.addNewChild(D.topId,1,"flag","<span class='fullFlag'>"+b.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Flag,!1),D.removeItem("pin"),scheduler._events[r].pinned?(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,9,"pin","<span class='emptyFlag'>"+b.getSVGIconHTML(lsdIcons.unpin)+"</span>"+customLabels.Unpin,!1):(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,9,"pin","<span class='fullFlag'>"+b.getSVGIconHTML(lsdIcons.pin)+"</span>"+customLabels.Pin,!1),D.removeItem("consoleTab"),g.isInConsole()&&D.addNewChild(D.topId,1,"consoleTab",b.getSVGIconHTML(lsdIcons.external)+customLabels.Open_Tab,!1),!scheduler.getEvent(e).pinned){var l=scheduler.getEvent(e).status,c=void 0,d=0;if(_.isEmpty(b.statusFlow)){if(D.removeItem("status"),!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)for(var u in D.addNewChild(D.topId,5,"status",b.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),b.statuses)c="ContextMenu_"+b.statusTranslations[b.statuses[u]].split(" ").join(""),D.addNewChild("status",d,"status_change_"+d,"<span class='StatusColorChanger "+c+" "+b.getCssClassForContextBasedOnStatus(b.statuses[u])+"'></span>"+b.statusTranslations[b.statuses[u]],!1),x["status_change_"+d++]=b.statuses[u]}else if(b.statusFlow[l]&&0<b.statusFlow[l].length)for(D.removeItem("status"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,5,"status",b.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),x={},d=0;d<b.statusFlow[l].length;d++)c="ContextMenu_"+b.statusFlow[l][d].split(" ").join(""),D.addNewChild("status",d,"status_change_"+d,"<span class='StatusColorChanger "+c+" "+b.getCssClassForContextBasedOnStatus(b.statusFlow[l][d])+"'></span>"+b.statusTranslations[b.statusFlow[l][d]],!1),x["status_change_"+d]=b.statusFlow[l][d];else D.removeItem("status")}(A=e)in scheduler._events&&!scheduler._events[A].isDummy&&D.showContextMenu(i,s)}else{if(R.removeItem("selectedNumber"),R.addNewChild(R.topId,0,"selectedNumber","<i class='fa fa-check-square-o'></i> "+customLabels.x_services_selected.replaceAll(g.selectedGanttServices.getSelected().length),!0),R.removeItem("status"),!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226){R.addNewChild(R.topId,4,"status",b.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),x={};var p,m=0;for(p in b.statuses){var h="ContextMenu_"+b.statusTranslations[b.statuses[p]].split(" ").join("");R.addNewChild("status",m,"status_change_"+m,"<span class='StatusColorChanger "+h+" "+b.getCssClassForContextBasedOnStatus(b.statuses[p])+"'></span>"+b.statusTranslations[b.statuses[p]],!1),x["status_change_"+m++]=b.statuses[p]}}R.showContextMenu(i,s)}return!1}I=A=""}return!0}),D.attachEvent("onShow",function(e){contextShown=!0}),D.attachEvent("onHide",function(e){contextShown=!1}),E.attachEvent("onShow",function(e){contextShown=!0}),E.attachEvent("onHide",function(e){contextShown=!1}),D.attachEvent("onClick",function(r,e,t){g.$evalAsync(function(){var e=void 0;switch(r){case"bundler":f.Bundle.invoke([scheduler._events[A]],y.selectedPolicyId).then(function(e){M()},function(e){});break;case"unbundler":f.Unbundle.invoke([scheduler._events[A]],y.selectedPolicyId).then(function(){M()},function(){M()});break;case"details":b.safeApply(g,function(){m.open(A)});break;case"consoleTab":g.openConsoleTab(null,A);break;case"flag":e="Flag",g.$evalAsync(function(){S.flagged[A]=!S.flagged[A],scheduler.updateEvent(A)});break;case"pin":S.changePin([scheduler._events[A].id],!scheduler._events[A].pinned).then(function(){return updateViewDebounced()});break;case"resizeService":A in scheduler._events&&!scheduler._events[A].isDummy&&(scheduler.config.drag_resize=!0,window.__gantt.currentResizableEvent=A,scheduler._events[A].hideTravelForResize(),scheduler.updateView());break;case"reschedule":e="Reschedule",g.$evalAsync(function(){S.autoScheduleService(A).then(function(e){var t;0===e.services.length&&alert(customLabels.NoCandidates),e.mst?(t="On Demand"!==window.__gantt.checkRulesMode,u.getDelta(t)):S.drawServicesAndAbsences(e.services,e.absences)}).catch(function(e){var t=d.serviceAppointments()[A].name;b.addNotification(t+" - "+customLabels.Action_Could_Not_Be_Performed,e.message,function(){m.open(A)})})});break;case"reshuffle":g.$evalAsync(function(){a.callRemoteAction(RemoteActions.runReshuffle,A,y.selectedPolicyId).then(function(e){u.updateOptimizationRequest(e)},function(e){b.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)})});break;case"groupNearby":g.$evalAsync(function(){a.callRemoteAction(RemoteActions.runGroupNearby,A,y.selectedPolicyId).then(function(e){u.updateOptimizationRequest(e)},function(e){b.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)})});break;case"candidates":e="GetCandidates",Z.get(A);break;case"einstein":e="Einstein",Q.open();break;case"chatter_welldone":O([A],customLabels.Well_done_mate);break;case"chatter_hurryup":O([A],customLabels.hurry_up_with_this_service);break;case"chatter_requestupdate":O([A],customLabels.please_update_service);break;case"chatter_custom":O([A],"");break;case"unschedule":e="Unschedule",g.$evalAsync(function(){ge([A])});break;case"map":g.showOnMap(A);break;case"showRelated":if(usingNewMstModel||scheduler._events[A].isServiceInChain)return void w.open(customLabels.ComplexRelatedServicesForGanttLB+" "+scheduler._events[A].name,mstPage+"?ingantt=true&id="+A);if(scheduler._events[scheduler._events[A].relatedFather])return void b.showOnGantt(scheduler._events[A].relatedFather);if(scheduler._events[scheduler._events[A].relatedTo])return void b.showOnGantt(scheduler._events[A].relatedTo);scheduler._events[A].relatedFather?alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[A].relatedFather].name)):alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[A].relatedTo].name));break;case"validate":S.checkRules([A]).then(S.drawViolationsOnGantt);break;default:if(0===r.indexOf("custom_")){var e="CustomAction",t=parseInt(r.split("_")[1]),n=[A],i=b.getCustomActions("gantt")[t];if(i.visualforce){var t=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),s=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();w.open(i.name,i.visualforce+"?id="+A+"&start="+t+"&end="+s);break}a.callRemoteAction(RemoteActions.runCustomServiceAction,i.className,n,scheduler._min_date,scheduler._max_date).then(function(e){u.updateGantt(),e&&b.addNotification(i.name,e,null,null)}).catch(function(e){return b.addNotification(i.name,e.message,null,null)})}else 0===r.indexOf("status")&&(e="StatusChanged"),g.$evalAsync(function(){ve([A],x[r])})}e&&a.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"RightClickAction",value:e,count:1})})}),$(".dhtmlxMenu_dhx_skyblue_SubLevelArea_Polygon").mouseover(function(){scheduler.dhtmlXTooltip.hide()}),R.addNewChild(R.topId,1,"flag",b.getSVGIconHTML(lsdIcons.flag)+customLabels.Flag,!1),R.addNewChild(R.topId,2,"unflag","<span class='emptyFlag'>"+b.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Unflag,!1),R.addNewChild(R.topId,3,"reschedule",b.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),window.customPermissions.Enable_Check_Rules&&R.addNewChild(R.topId,12,"validate",b.getSVGIconHTML(lsdIcons.violation)+customLabels.check_rules_action_label,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&R.addNewChild(R.topId,5,"unschedule",b.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),(!window.customPermissions.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.customPermissions.ignoreReadonlyGantt226)&&(R.addNewChild(R.topId,7,"pin",b.getSVGIconHTML(lsdIcons.pin)+customLabels.Pin,!1),R.addNewChild(R.topId,8,"unpin","<span class='emptyFlag'>"+b.getSVGIconHTML(lsdIcons.unpin)+"</span>"+customLabels.Unpin,!1)),b.customActionsPromise.then(function(){b.getCustomActions("gantt").forEach(function(e,t){e.icon?R.addNewChild(R.topId,t+12,"custom_"+t,b.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1):R.addNewChild(R.topId,t+12,"custom_"+t,e.name.encodeHTML(),!1)})}),v.isActive()&&(b.hasCustomPermission("Bulk_Bundle")&&R.addNewChild(R.topId,41,"bundler",b.getSVGIconHTML(f.Bundle.icon)+f.Bundle.label,!1),b.hasCustomPermission("Bulk_Unbundle"))&&R.addNewChild(R.topId,42,"unbundler",b.getSVGIconHTML(f.Unbundle.icon)+f.Unbundle.label,!1),R.attachEvent("onShow",function(e){contextShown=!0}),R.attachEvent("onHide",function(e){contextShown=!1}),R.attachEvent("onClick",function(r,e,t){g.$evalAsync(function(){var e=void 0;switch(r){case"flag":e="Flag",b.safeApply(g,function(){ue(!0)});break;case"unflag":b.safeApply(g,function(){ue(!1)});break;case"bundler":var t=(g.selectedGanttServices.getSelected()||[]).map(function(e){return scheduler._events[e]});f.Bundle.invoke(t,y.selectedPolicyId).then(function(e){M()},function(e){});break;case"unbundler":t=(g.selectedGanttServices.getSelected()||[]).map(function(e){return scheduler._events[e]});f.Unbundle.invoke(t,y.selectedPolicyId).then(function(e){M()},function(e){});break;case"reschedule":e="Reschudule",K.schedule(g.selectedGanttServices.getSelected());break;case"pin":S.changePin(g.selectedGanttServices.getSelected(),!0).then(function(){return updateViewDebounced()});break;case"unpin":S.changePin(g.selectedGanttServices.getSelected(),!1).then(function(){return updateViewDebounced()});break;case"unschedule":e="Unschedule",ge(g.selectedGanttServices.getSelected());break;case"validate":S.checkRules(g.selectedGanttServices.getSelected()).then(S.drawViolationsOnGantt);break;default:if(0===r.indexOf("custom_")){var e="CustomAction",t=parseInt(r.split("_")[1]),n=g.selectedGanttServices.getSelected(),i=b.getCustomActions("gantt")[t];if(i.visualforce){var t=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),s=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();w.open(i.name,i.visualforce+"?services="+n.join(",")+"&start="+t+"&end="+s);break}a.callRemoteAction(RemoteActions.runCustomServiceAction,i.className,g.selectedGanttServices.getSelected(),scheduler._min_date,scheduler._max_date).then(function(e){u.updateGantt(),e&&b.addNotification(i.name,e,null,null)}).catch(function(e){return b.addNotification(i.name,e.message,null,null)})}else 0===r.indexOf("status")&&(e="StatusChanged"),ve(g.selectedGanttServices.getSelected(),x[r])}e&&a.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"RightClickAction",value:e,count:g.selectedGanttServices.getSelected().length})})}),g.lockGanttToggle=function(){(window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Gantt_Locker)&&(scheduler.config.readonly=!scheduler.config.readonly,g.ganttLocked=scheduler.config.readonly,N(),scheduler.updateView(),n.SetUserSettingsProperty("Lock_Gantt__c",g.ganttLocked))},g.unSelecteAllSkills=function(){for(var e in g.selectedSkills)g.selectedSkills[e]=!1;g.selectedSkillCounter=0,g.showSelectedList=!1,g.skillsFilter=!1,ne([])},scheduler.attachEvent("onYScaleClick",function(e,t,n){n.stopPropagation(),n.preventDefault(),window.__lastResourceClicked=t;for(var i=["resourceMenuBtn","resourceMenuIcon"],s=0;s<i.length;s++)if(n.target.classList&&n.target.classList.contains(i[s])||n.target.parentNode&&n.target.parentNode.classList.contains(i[s]))return void V.open(t.resourceId,t.key,n.target);t.children||U.open(t.resourceId,t.key)});var pe=void 0;function me(e){var e=0<arguments.length&&void 0!==e?e:1,t=Math.abs(scheduler._max_date.getTime()-scheduler._min_date.getTime()),t=Math.ceil(t/864e5)*e,e=new Date(scheduler._min_date);e.setDate(e.getDate()+t),scheduler.setCurrentView(e,scheduler._mode)}function P(){if(scheduler._is_initialized()&&g.datalessMethods){for(var e=0;e<g.nowTimespans.length;e++)scheduler.deleteMarkedTimespan(g.nowTimespans[e]);g.nowTimespans.length=0;for(var t=scheduler.serverList("resources"),n=getMinAndMaxHoursToDisplay(),i=0;i<t.length;i++){var s,r={timeZone:userTimeZone,year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"},o=new Date(new Intl.DateTimeFormat("en-us",r).format(new Date));if(useLocationTimezone&&(s=c.allTerritories[t[i].key].operatingHours,s=c.operatingHours[s].timezone,r.timeZone=s,o=new Date(new Intl.DateTimeFormat("en-us",r).format(new Date))),n.min<=o.getHours()&&o.getHours()<n.max&&!g.datalessMethods.isDateInsideWeekend(o)&&"MonthlyView"!==scheduler._mode){var a={};a[scheduler.getState().mode]=[];for(var l=0;l<t[i].children.length;l++)a[scheduler.getState().mode].push(t[i].children[l].key);g.nowTimespans.push(scheduler.addMarkedTimespan({start_date:o,end_date:scheduler.date.add(o,1,"minute"),css:"dhx_now_time dhx_matrix_now_time",sections:a}))}}}}scheduler.attachEvent("onBeforeTooltip",function(e){return clearTimeout(pe),pe=setTimeout(function(){var e=$(".dhtmlXTooltip");0!==e.length&&(e.position().top<0?e.css("height",e.height()+e.position().top-15+"px"):15<e.position().top&&e.css("height","initial"))},400),!0}),g.$on("keypress",function(e,t){if($("#MonthlyViewTooltip").remove(),!y.isLightboxOpened()&&!y.isLoadingNewLocations&&!$("*:focus").is("textarea, input"))switch(t.which){case 13:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(S.recentlyUsed[scheduler._selected_id]=!0,m.open(scheduler._select_id));break;case 27:N();break;case 37:t.shiftKey?(me(-1),g.changeDatesByArrows()):$(".dhx_cal_prev_button").click();break;case 38:var n=$(".dhx_cal_data").scrollTop();$(".dhx_cal_data").scrollTop(n-30);break;case 39:t.shiftKey?(me(),g.changeDatesByArrows()):$(".dhx_cal_next_button").click();break;case 40:n=$(".dhx_cal_data").scrollTop(),$(".dhx_cal_data").scrollTop(n+30);break;case 87:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&scheduler.getEvent(scheduler._select_id).parentRecord&&(g.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._events[scheduler._select_id].parentRecord],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):b.openLightningPrimaryTab(scheduler._events[scheduler._select_id].parentRecord)}):window.open("../"+scheduler._events[scheduler._select_id].parentRecord));break;case 83:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&!scheduler.getEvent(scheduler._select_id).isDummy&&(g.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._select_id],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):b.openLightningPrimaryTab(scheduler._select_id)}):window.open("../"+scheduler._select_id));break;case 84:g.jumpToToday();break;case 70:1===g.selectedGanttServices.getSelected().length&&""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(S.flagged[scheduler._select_id]?S.flagged[scheduler._select_id]=!1:S.flagged[scheduler._select_id]=!0,scheduler.updateEvent(scheduler._select_id));break;case 48:case 96:g.changeTimeline(0);break;case 49:case 97:g.changeTimeline(1);break;case 50:case 98:g.changeTimeline(2);break;case 51:case 99:g.changeTimeline(3);break;case 55:g.changeTimeline(7);break;case 77:b.hasCustomPermission("MDT_View")&&!b.hasCustomPermission("Longterm_View")&&g.changeTimeline(35);break;case 85:b.hasCustomPermission("Monthly_Utilization")&&monthlyViewSettings.isMonthlyAvailable&&g.changeTimeline(30);break;case 103:g.changeTimeline(7)}}),g.changeTimeline=function(e){var t=scheduler._min_date,n=scheduler._max_date,i=void 0;switch(e){case 0:if((i="ZoomLevel2")===scheduler._mode)return;g.timelineName=customLabels.In_Day;break;case 1:if((i="ZoomLevel3")===scheduler._mode)return;g.timelineName=customLabels.Daily;break;case 2:if((i="ZoomLevel4")===scheduler._mode)return;g.timelineName=customLabels.X2_Days;break;case 3:if((i="ZoomLevel5")===scheduler._mode)return;g.timelineName=customLabels.X3_Days;break;case 7:if((i="ZoomLevel6")===scheduler._mode)return;g.timelineName=customLabels.Weekly;break;case 14:if((i="ZoomLevel7")===scheduler._mode)return;g.timelineName=customLabels.TwoWeeks;break;case 30:if((i="MonthlyView")===scheduler._mode)return;g.timelineName=customLabels.Utilization;break;case 35:if((i="MTDView")===scheduler._mode)return;g.timelineName=customLabels.MDTVIEW;break;case 180:if((i="LongView")===scheduler._mode)return;g.timelineName=customLabels.LongView}a.callRemoteAction(RemoteActions.collectViewsForSplunk,{feature:"ganttView",value:{0:"In-Day",1:"Daily",2:"2 Days",3:"3 Days",7:"Weekly",14:"2 Weeks",30:"Utilization",180:"Long-Term"}[e]}),scheduler.setCurrentView(t,i),g.changeDatesByArrows(n)},setInterval(P,6e5),g.jumpToToday=function(){var e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),scheduler.setCurrentView(e),g.changeDatesByArrows()},s.$on("afterShowEvent",function(){setTimeout(function(){g.changeDatesByArrows(),P(),updateViewDebounced()},800)}),g.showOnMap=function(e){s.$broadcast("showServiceOnMap",e),b.safeApply(g)},scheduler.attachEvent("onBeforeEventChanged",function(e,t,n,i){var s=e.resourceId.split("_"),s=T.isTerritoryHasInDayOptimizationInProgress(e.start_date,e.end_date,s[1]);if(s){if(!1===confirm(customLabels.In_Day_Optimization_In_Progress_Confirm))return!1;"Rollback"===b.getSchedulingPolicyObject(s.policy)[fieldNames.SchedulingPolicy.Commit_Mode__c]&&T.updateProgressStatus(s.id,"Aborted")}var r,o,a;if(!t.ctrlKey||e.isImmidietlyFollow&&!e.isInO2Territory||S.handleSnap(e,t),e.resourceId===i.resourceId&&F!==e.id&&(s=e.start_date.getTime(),r=e.end_date.getTime(),o=i.start_date.getTime(),a=i.end_date.getTime(),Math.abs((s-o)/1e3/60)<minDragMinutes||Math.abs((r-a)/1e3/60)<minDragMinutes))return cachedDomElements.timesDragFix.hide(),!1;if(y.areContractorsSupported()&&"service"===e.type&&c.getResources()[e.getGanttResource()].isCapacityBased){for(var l in d.resourceCapacities()){l=d.resourceCapacities()[l];if(l.resource===c.getResources()[e.getGanttResource()].id&&(e.start.getTime()>=l.start_date.getTime()&&e.start.getTime()<=l.end_date.getTime()))return e.resourceBeforeDrag=i.resourceId,e.eventBeforeDrag=i,fe(e),!0}return cachedDomElements.timesDragFix.hide(),alert(customLabels.serviceCantBeAssignedWithoutCapacity),!1}return C=GanttService.copy(i),snapTo=t.ctrlKey,fe(e),e.resourceBeforeDrag=i.resourceId,e.eventBeforeDrag=i,!0}),g.updateMonthlyKpi=function(){"MonthlyView"===scheduler._mode&&updateViewDebounced(),he()};var he=_.debounce(function(){n.SetUserSettingsProperty("Utilization_Properties__c",JSON.stringify(g.capacityFields))},800);function ge(e){var t,n;confirm(customLabels.are_you_sure_unschedule)&&(t=[],n=[],e.forEach(function(e){n.push(d.serviceAppointments()[e]),t.push(d.serviceAppointments()[e].resource),S.recentlyUsed[e]=!0}),S.unscheduleServices(e,y.selectedPolicyId).then(function(e){M(),S.drawServicesAndAbsences(e.services,e.absences),h.calculateKpis()}).catch(function(e){b.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}))}function ve(e,t){var n,i;t===W.CANCELED&&!confirm(customLabels.AreYouSureYouWantToCancel)||(n=[],i=[],e.forEach(function(e){i.push(d.serviceAppointments()[e]),n.push(d.serviceAppointments()[e].resource),S.recentlyUsed[e]=!0}),S.changeStatus(e,t).then(function(e){M(),S.drawServicesAndAbsences(e.services)}).catch(function(e){b.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}))}function fe(e){var t,n=(e.start_date.getMinutes()+e.travelTo/60)%60,i="na"===e.type?e.end-e.start:e.schedEndTime-e.schedStartTime,s=(s=e,new Date(s.start).getTime()!==new Date(s.start_date).getTime()),r=(n=window.__gantt.currentResizableEvent===e.id?s?n:(e.end_date.getMinutes()+e.travelFrom/60)%60:n)%serviceJumpsOnGantt,n=serviceJumpsOnGantt-n%serviceJumpsOnGantt;0!=r&&(window.__gantt.currentResizableEvent===e.id?(t=Se(t=s?e.start_date:e.end_date,r,n),e.start_date=s?t:e.start_date,e.end_date=s?e.end_date:t):(e.start_date=Se(e.start_date,r,n),e.end_date=new Date(e.start_date.getTime()+i+1e3*e.travelFrom+1e3*e.travelTo)),e.schedStartTime=e.start_date.getTime()+1e3*e.travelTo,e.schedEndTime=e.end_date.getTime()-1e3*e.travelFrom)}function Se(e,t,n){return e=n<t?new Date(e.getTime()+60*n*1e3):new Date(e.getTime()-60*t*1e3)}function N(){var e;b.hasCustomPermission("Enable_Event_Resizing")&&(scheduler.config.drag_resize=!1,window.__gantt.currentResizableEvent&&!i[window.__gantt.currentResizableEvent]&&(scheduler._events[window.__gantt.currentResizableEvent].restoreTravelForResize(),e=window.__gantt.currentResizableEvent,setTimeout(function(){scheduler.updateEvent(e)},0)),i[window.__gantt.currentResizableEvent]||(window.__gantt.currentResizableEvent=null,F=null))}g.cancelCrewView=function(){s.crewViewActive=!1,g.crewViewActive=!1,d.isCrewViewActive=!1,d.selectedCrewIdToShow=null},s.$on("gotNewTimePhasedObjects",function(e,t){S.drawServicesAndAbsences(t.serviceAppointments,t.resourceAbsences,[],t.resourceCapacities)}),s.$on("timePhasedObjectsCheckRules",function(e,t){S.checkRules(t).then(S.drawViolationsOnGantt)}),window.__gantt.pushService.pushServiceSettingEnabled?s.$broadcast("copilotInit",!0):a.callRemoteAction(RemoteActions.isStreamingShouldBeActive).then(function(e){"true"===e?(s.$broadcast("copilotInit",!1),y.setStreamingActiveState(!0)):(s.$broadcast("copilotInit",!0),y.setStreamingActiveState(!1),"false"!==e&&b.addNotification(customLabels.GanttLiveRefreshNotSupported,e,null,null)),Y.initStreaming()}),e.register("services",function(e){S.drawServicesAndAbsences(e.updated||[],[],e.deleted||[])}),e.register("absences",function(e){S.drawServicesAndAbsences([],e.updated||[],e.deleted||[])}),e.register("capacities",function(e){S.drawServicesAndAbsences([],[],e.deleted||[],e.updated||[])}),e.register("rules",function(e,t){t&&S.checkRules(e).then(S.drawViolationsOnGantt)}),scheduler.attachEvent("onEventChanged",function(e,n){"service"!==n.type&&"na"!==n.type||b.safeApply(g,function(){var t;("na"===n.type?(i[n.id]=!0,scheduler._events[n.id]&&(scheduler._events[n.id].isDummy=!0),l.saveChangesToAbsence(C,n,y.selectedPolicyId).then(function(e){}).catch(function(e){console.warn("Couldn't update absence"),e[0].error?b.addNotification(customLabels.Action_Could_Not_Be_Performed,e[0].error):b.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")})):(i[n.id]=!0,scheduler._events[n.id]&&(scheduler._events[n.id].isDummy=!0),M(),t=F===n.id,S.saveChangesToServiceAppointment(C,n,t).then(function(e){}).catch(function(e){t&&scheduler._events[n.id].restoreTravelForResize(),console.warn("Couldn't update service. "+e[2]),b.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message.substr(e[0].message.indexOf(",")+1)||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json"),d.serviceAppointments()[e[1].id]=e[1]}))).finally(function(){F=null,i[n.id]=!1,window.__gantt.currentResizableEvent=null,scheduler.updateEvent(n.id),scheduler._events[n.id]&&(scheduler._events[n.id].isDummy=!1)})})}),g.$on("JumpToDate",function(e,t){scheduler.setCurrentView(t),g.changeDatesByArrows()}),g.$on("GotSlots",function(e,t){var n=getMinAndMaxHoursToDisplay();(t.minDateOfCandidate.getHours()<n.min||t.minDateOfCandidate.getHours()>=n.max)&&confirm(customLabels.confirmChangeBusinessHours)&&(t.minDateOfCandidate.getHours()<n.min?g.businessHoursRange.start=t.minDateOfCandidate.getHours():g.businessHoursRange.end=24,ce())}),g.changeUtilizaionDays=function(e){-1===e&&1===g.numberOfDaysInUtilizationView||1===e&&30===g.numberOfDaysInUtilizationView||(g.numberOfDaysInUtilizationView+=e,g.daysInUtilizationChanged())},g.daysInUtilizationChanged=function(){scheduler.matrix.MonthlyView.x_size=g.numberOfDaysInUtilizationView,n.SetUserSettingsProperty("DaysInUtilizationView__c",g.numberOfDaysInUtilizationView),"MonthlyView"===scheduler._mode&&(scheduler.updateView(),g.getTimePhasedObjects())},g.getRowSizeClass=function(){return b.ganttSettings.resourceRowHeight+"-css"},g.filterVisibility={hours:!0,resources:!1,skills:!1,utilization:!1,palettes:!1},g.needToLoadSkills=!0,g.werePalettesLoaded=X.werePalettesLoaded,g.changeGanttFilterTab=function(e){for(var t in"skills"===e&&ae(g.selectedSkills),g.filterVisibility)g.filterVisibility[t]=t===e},g.toggleShowCalendarWeeks=_.debounce(function(){n.SetUserSettingsProperty("Show_Calendar_Weeks__c",g.showCalendarWeeks.enabled),__gantt.showCalendarWeeks=g.showCalendarWeeks.enabled,updateViewDebounced()},400),g.toggleHorizontalScrolling=_.debounce(function(){g.handleDoubleScrollBar(),g.horizontalScrolling.enabled?(scheduler.matrix.ZoomLevel5.scrollable=!0,scheduler.matrix.ZoomLevel5.x_size=72,scheduler.matrix.ZoomLevel5.x_step=60,scheduler.matrix.ZoomLevel5.x_length=24,scheduler.matrix.ZoomLevel6.scrollable=!0,scheduler.matrix.ZoomLevel6.x_size=168,scheduler.matrix.ZoomLevel6.x_step=60,scheduler.matrix.ZoomLevel6.x_length=24,scheduler.matrix.ZoomLevel7.scrollable=!0,scheduler.matrix.ZoomLevel7.x_size=336,scheduler.matrix.ZoomLevel7.x_step=60,scheduler.matrix.ZoomLevel7.x_length=24,scheduler.matrix.LongView.scrollable=!0):(scheduler.matrix.ZoomLevel5.scrollable=!1,scheduler.matrix.ZoomLevel5.x_size=18,scheduler.matrix.ZoomLevel5.x_step=240,scheduler.matrix.ZoomLevel5.x_length=6,scheduler.matrix.ZoomLevel6.scrollable=!1,scheduler.matrix.ZoomLevel6.x_size=28,scheduler.matrix.ZoomLevel6.x_step=360,scheduler.matrix.ZoomLevel6.x_length=4,scheduler.matrix.ZoomLevel7.scrollable=!1,scheduler.matrix.ZoomLevel7.x_size=28,scheduler.matrix.ZoomLevel7.x_step=720,scheduler.matrix.ZoomLevel7.x_length=2,scheduler.matrix.LongView.scrollable=!1),__gantt.horizontalScrolling=g.horizontalScrolling.enabled,n.SetUserSettingsProperty("HorizontalScrolling__c",g.horizontalScrolling.enabled),scheduler._is_initialized()&&(scheduler.updateView(),updateViewDebounced())},300),g.horizontalScrolling.enabled&&g.toggleHorizontalScrolling(),scheduler.attachEvent("onAfterEventDisplay",function(e){setTimeout(function(){e.showEventPopupEffect=!1,h.calculateKpis(),s.$broadcast("afterShowEvent")},2500)}),g.updateWorkingReosourcesFilter=_.debounce(function(){g.resourceFilterHelper.showWorkingResource=g.resourceFilters.showWorkingResource},300),s.$on("flagService",function(e,t){S.flagged[t]?S.flagged[t]=!S.flagged[t]:S.flagged[t]=!0,scheduler.updateEvent(t)}),scheduler.attachEvent("onBeforeLightbox",function(e){scheduler.updateEvent(e);e=$("#timesDragFix");return e&&e.hide(),!1})}]),angular.module("serviceExpert").controller("ctrlIframeMap",["$scope","sfdcService","$rootScope","MapService","servicesService","TimePhasedDataService",function(n,e,t,i,s,r){n.filter=s.filter,n.$on("showServiceOnMap",function(e,t){i.showServiceOnMap(t,n.floatingMapOn,n.workingState)}),n.$on("gotNewResources",function(e,t){i.initializeGanttMap(!0)}),n.$watch("filter",function(e,t){"map"!==n.workingState&&!n.floatingMapOn||i.updateGanttMapFilter()},!0),n.$watch("floatingMapOn",function(e){e&&i.updateGanttMapFilter()}),n.$watch("workingState",function(e){"map"!==e&&!n.floatingMapOn||i.updateGanttMapFilter()}),t.$on("paletteUpdated",function(){i.updateGanttMapServices(r.serviceAppointments(),{})}),t.$on("updateTimePhaseData",function(e,t){i.updateGanttMapServices(t,{})}),t.$on("deleteTimePhaseData",function(e,t){i.updateGanttMapServices({},t)}),t.$on("gotNewTimePhasedObjects",function(e,t){i.initializeGanttMap(!1),i.updateGanttMapServices(t.serviceAppointments,[],!0),i.updateGanttMapView()}),scheduler.attachEvent("onViewChange",function(){"map"!==n.workingState&&!n.floatingMapOn||(i.updateGanttMapView(),i.updateGanttMapServices(s.filteredServices.servicesArray,[]))})}]),angular.module("serviceExpert").controller("mainController",["$scope","StateService",function(e,t){e.isOSX=t.isOSX,e.lang=t.lang,e.isRtlDirection=t.isRtlDirection(),e.isUserIdle=t.isUserIdle,e.refreshPage=function(){location.reload()},e.focusOnInactiveButton=function(){document.getElementById("ReloadButtonFsl").focus()}}]),angular.module("serviceExpert").controller("ctrlMap",["$scope","sfdcService","$rootScope","$q","userSettingsManager","servicesService","bulkScheduleService","$timeout","$filter","utils","ServiceAppointmentLightboxService","ResourceLightboxService","TimePhasedDataService","FieldSetFieldsService","ResourcesAndTerritoriesService","LastKnownPositionService","DeltaService","SERVICE_STATUS","SERVICE_CATEGORY","DRAWING_STATES","StreamingAPIService","RegisterService","GeneralLightbox",function(A,o,n,d,r,a,l,s,N,I,c,u,C,e,k,D,p,m,i,h,G,t,g){A.SERVICE_STATUS=m,A.invokedActions={},A.allMarkersArray=[],A.reports={},A.reportsData={},A.map=null,A.markersControl={},A.territoriesMarkers=[],A.firstMapShow=!0,A.trafficLayerEnabled=!1,A.mapControl={center:{latitude:0,longitude:0},zoom:19},A.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}};var v=JSON.parse(r.GetUserSettingsProperty("Map_Object_Markers__c"))||{services:!0,resources:!0,positions:!0,territories:!0};function f(e){if(A.allMarkersArray=[],A.showResources){var t,n=scheduler.getState().min_date,i=scheduler.getState().max_date,s=C.resourcesByPrimariesAndRelocations();for(t in s){var r,o=s[t];for(r in o){var a=o[r];isIntersect(n,i,a.effectiveStartDate,a.effectiveEndDate)&&!function(e){var t;e.latitude&&(t=k.getResources()[e.serviceResource])&&(A.isEmpty(A.filteredResources)||A.filteredResources[t.id])&&(e={id:e.id,icon:staticResources.homebase_png,type:"resource",resourceId:t.id,serviceTerritory:e.serviceTerritory,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:t.name})},A.allMarkersArray.push(e))}(a)}}}if(A.showServices){for(var l=A.filteredServices.servicesArray,c=0;c<l.length;c++){var d=l[c];d.id!=A.currentShowOnMapServiceId&&R(d)}A.currentShowOnMapServiceId&&R(C.serviceAppointments()[A.currentShowOnMapServiceId])}if(A.showLivePositions){var u,p=scheduler.getState().min_date,m=scheduler.getState().max_date,h=C.resourcesAndTerritories(),g=D.lastKnownPositions();for(u in g){var v,f=h[u];for(v in f){var S=f[v];if(isIntersect(p,m,S.effectiveStartDate,S.effectiveEndDate)){!function(e){var t=k.getResources()[e.id];(A.isEmpty(A.filteredResources)||A.filteredResources[t.id])&&((e={id:e.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:e.id,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:t.name})}).item.lastModifiedDate=I.convertDateBetweenTimeZones(e.item.lastModifiedDate,"UTC",userTimeZone),A.allMarkersArray.push(e))}(g[u]);break}}}}A.showTerritories&&F();var _,b=e,y=maxReportMarkers;for(_ in A.reportsData){var w=A.reportsData[_];if(w.show)for(var T=w.displayCount=0;T<w.data.length;T++){var L=w.data[T];if(0==y){b&&(A.showTooManyReportsAlert=!0);break}(function(e,t){var n;if(e.latitude)return n=staticResources.report,"ServiceAppointment"===e.sObjectType?n=staticResources.service_png:void 0!==staticResources[e.sObjectType.toLowerCase().replace(/ /g,"_")]&&(n=staticResources[e.sObjectType.toLowerCase().replace(/ /g,"_")]),t={id:t,icon:n,type:"report",coords:{latitude:e.latitude,longitude:e.longitude},item:e},A.allMarkersArray.push(t),!0})(L,_+w.displayCount)&&(w.displayCount++,y--)}}}function S(e,t){for(var n=new google.maps.LatLngBounds,i=0;i<e.length;i++){var s=(t?e[i].coords:e[i]).latitude,r=(t?e[i].coords:e[i]).longitude;s&&r&&(s=new google.maps.LatLng(s,r),n.extend(s))}return n}function R(e){var t;e.latitude&&A.showServices&&(t=e.getGanttResource(),A.isEmpty(A.filteredResources)||null!=t&&A.filteredResources[t])&&(t=staticResources.service_png,e.statusCategory==i.COMPLETED&&(t=staticResources.service_completed_png),A.allMarkersArray.push({id:e.id,icon:t,type:"service",animation:2,coords:{latitude:e.latitude,longitude:e.longitude},item:e}))}function F(){var e,t=k.territories();for(e in t)t[e].latitude&&A.allMarkersArray.push({id:e,icon:staticResources.territory_map_icon,type:"territory",animation:2,coords:{latitude:t[e].latitude,longitude:t[e].longitude},item:t[e]})}function B(e,t){if(A.polygons[e])A.polygons[e].polygon.setVisible(t),b(e,t);else if(k.territories()[e]||"NoTerritoryPolygon"==e){b(e);for(var n=A.myTreeView.getSubItems(e),i=0;i<n.length;i++)s=n[i],t?A.myTreeView.checkItem(s):A.myTreeView.uncheckItem(s)}var s;r.SetUserSettingsProperty("Invisible_Polygons__c",JSON.stringify(A.InvisiblePolygons))}function b(e,t){for(var n=0;n<A.InvisiblePolygons.length;n++)if(A.InvisiblePolygons[n]==e)return void A.InvisiblePolygons.splice(n,1);t||A.InvisiblePolygons.push(e)}function y(){A.selectedShape&&("marker"!==A.selectedShape.type&&A.selectedShape.setEditable(!1),A.selectedShape.set("strokeWeight",1),A.selectedShape=null,A.currentEditPolygon=null,A.polygonName="",A.polygonTerritory="null"),A.drawState=A.drawState==h.DRAW?h.EDIT:h.NONE}function w(e){if(this&&(e=this),A.drawState==h.INTERSECT)return A.currentIntersectingId==e.id?void 0:(A.selectedIntersectingPolygons[e.id]?delete A.selectedIntersectingPolygons[e.id]:A.selectedIntersectingPolygons[e.id]=!0,void A.$apply());"marker"!==e.type&&(y(),A.selectedColor=A.selectedShapeColor=e.get("fillColor"),A.drawState!=h.EDIT)&&(A.drawState=h.SELECTED),A.polygonName=e.name,A.polygonTerritory=e.territory||"null",A.selectedShape=e,A.selectedShape&&A.selectedShape.set("strokeWeight",3),e.id!=A.myTreeView.getSelectedId()&&(A.shouldBound=!1,A.myTreeView.selectItem(e.id)),A.$apply()}function T(e){A.geoXmlParser.parseKmlString(e[fieldNames.Polygon.KML__c]);for(var t=A.geoXmlParser.docs.length-1,n=0;n<A.geoXmlParser.docs[t].placemarks.length;n++)A.geoXmlParser.docs[t].placemarks[n].id=e.Id,A.geoXmlParser.docs[t].placemarks[n].polygon.id=e.Id,A.geoXmlParser.docs[t].placemarks[n].polygon.name=e.Name,A.geoXmlParser.docs[t].placemarks[n].polygon.territory=e[fieldNames.Polygon.Service_Territory__c],A.geoXmlParser.docs[t].placemarks[n].polygon.addListener("click",function(){A.shouldBound=!1,M.hide(),w(this)}),A.geoXmlParser.docs[t].placemarks[n].polygon.addListener("rightclick",x),A.polygons[e.Id]=e,A.polygons[e.Id].polygon=A.geoXmlParser.docs[t].placemarks[n].polygon}A.showServices=v.services,A.showResources=v.resources,A.showLivePositions=v.positions,A.showTerritories=v.territories,A.showOnMap=!1,A.setMapMarkerUserSettings=function(){r.SetUserSettingsProperty("Map_Object_Markers__c",JSON.stringify({services:A.showServices,resources:A.showResources,positions:A.showLivePositions,territories:A.showTerritories}))},A.showTooManyReportsAlert=!1,A.resourcesFilterList=[],A.filterResourceInputValue="",A.filteredResources={},A.selectedReport="null",A.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},report:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},A.serviceInfoWindow={show:!1,control:{}},A.resourceInfoWindow={show:!1,control:{}},A.territoryInfoWindow={show:!1,control:{}},A.reportInfoWindow={show:!1,control:{}},A.livePosInfoWindow={show:!1,control:{}},A.filteredServices=a.filteredServices,A.filter=a.filter,A.currentShowOnMapServiceId=null,A.drawingStates=h,A.drawState=h.NONE,A.selectedShape=null,A.selectedShapeColor=A.selectedColor,A.setSelectedShapeColor=function(e){A.selectedShape&&(A.selectedShape.set("fillColor",e),A.selectedShapeColor=e);A.selectedColor=e},A.polygons={},A.polygonName="",A.polygonTerritory="null",A.territories={},A.selectedIntersectingPolygons={},A.shouldBound=!0,A.cancelDrawingShape=!1,A.InvisiblePolygons=null==r.GetUserSettingsProperty("Invisible_Polygons__c")?[]:JSON.parse(r.GetUserSettingsProperty("Invisible_Polygons__c")),A.hasCustomPermission=I.hasCustomPermission,A.getServiceInfoRowClass=I.getServiceInfoRowClass,A.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,A.getReportsError=function(){return A.reportsError},I.getReports().then(function(e){if(e)for(var t=0;t<e.length;t++)A.reports[e[t].Id]=e[t]}).catch(function(e){A.reportsError=!0}),D.getLastKnownPositions(),A.redrawAllMarkers=f,A.$watch("workingState",function(e){"map"==e?(A.map=A.mapControl.getGMap(),s(function(){A.resourcesFilterList=[];var e,t=scheduler.getState().min_date,n=scheduler.getState().max_date,i=C.resourcesAndTerritories(),s=k.getResources();for(e in s){var r,o=i[e],a=s[e];for(r in o){var l=o[r];if(isIntersect(t,n,l.effectiveStartDate,l.effectiveEndDate)){A.resourcesFilterList.push({label:a.name,value:a.id});break}}}if(f(),google.maps.event.trigger(A.mapControl.getGMap(),"resize"),A.firstMapShow){if(!A.showOnMap){var c=new google.maps.LatLng(37.794024,-122.394837),d=S(A.filteredServices.servicesArray);(d=d.isEmpty()?S(_.values(C.serviceAppointments())):d).isEmpty()?A.map.setCenter(c):A.map.fitBounds(d)}var c=A.map.getStreetView(),d={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}},u=(c.setOptions(d),{fillOpacity:.5,strokeWeight:1,editable:!0,draggable:!0,fillColor:A.selectedColor});if(A.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:null,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER,drawingModes:["polygon"]},polygonOptions:u,rectangleOptions:u}),A.drawingManager.setMap(A.map),google.maps.event.addListener(A.drawingManager,"overlaycomplete",function(e){var n=e.overlay;A.cancelDrawingShape?(A.cancelDrawingShape=!1,n.setMap(null)):(n.type=e.type,n.set("fillColor",A.selectedColor),n.set("name",A.polygonName),n.set("territory",A.polygonTerritory),A.drawingManager.setDrawingMode(null),google.maps.event.addListener(n,"click",function(e){var t;void 0!==e.vertex&&n.type===google.maps.drawing.OverlayType.POLYGON&&((t=n.getPaths().getAt(e.path)).removeAt(e.vertex),t.length<3)&&n.setMap(null),w(n)}),w(n))}),"function"!=typeof google.maps.Polygon.prototype.ToWKT&&(google.maps.Polygon.prototype.ToWKT=function(){for(var e="POLYGON(",t=this.getPaths(),n=0;n<t.getLength();n++){var i=t.getAt(n);e+="(";for(var s=0;s<i.getLength();s++)e+=i.getAt(s).lng().toString()+" "+i.getAt(s).lat().toString()+",";e+=i.getAt(0).lng().toString()+" "+i.getAt(0).lat().toString()+"),"}return e=e.substring(0,e.length-1)+")"}),A.geoXmlParser=new geoXML3.parser({map:A.map,suppressInfoWindows:!0,zoom:!1}),!A.isEmpty(A.polygons)){var p=0;try{for(var m in A.polygons){A.geoXmlParser.parseKmlString(A.polygons[m][fieldNames.Polygon.KML__c]);for(var h,g=0;g<A.geoXmlParser.docs[p].placemarks.length;g++)A.geoXmlParser.docs[p].placemarks[g].polygon&&(A.geoXmlParser.docs[p].placemarks[g].id=A.polygons[m].Id,A.geoXmlParser.docs[p].placemarks[g].polygon.id=A.polygons[m].Id,A.geoXmlParser.docs[p].placemarks[g].polygon.name=A.polygons[m].Name,A.geoXmlParser.docs[p].placemarks[g].polygon.territory=A.polygons[m][fieldNames.Polygon.Service_Territory__c],h=-1==A.InvisiblePolygons.indexOf(m),A.geoXmlParser.docs[p].placemarks[g].polygon.setVisible(h),A.geoXmlParser.docs[p].placemarks[g].polygon.addListener("click",function(){A.shouldBound=!1,M.hide(),w(this)}),A.geoXmlParser.docs[p].placemarks[g].polygon.addListener("rightclick",x),A.polygons[m].polygon=A.geoXmlParser.docs[p].placemarks[g].polygon);p++}}catch(e){alert("Problem parsing KML string"),console.error(e)}}google.maps.event.addListener(A.map,"click",function(){A.map.setOptions({draggableCursor:"grab"}),M.hide()}),M=new E(A.map,L),A.firstMapShow=!1,A.showOnMap=!1}},0)):A.currentShowOnMapServiceId=null}),A.$on("resizeMap",function(e,t){google.maps.event.trigger(A.mapControl.getGMap(),"resize")}),A.$on("showServiceOnMap",function(e,t){A.currentShowOnMapServiceId=t,n.$broadcast("changeWorkingState","map"),A.map=A.mapControl.getGMap(),A.showOnMap=!0,s(function(){google.maps.event.trigger(A.mapControl.getGMap(),"resize");var e=C.serviceAppointments()[t],e=new google.maps.LatLng(e.latitude,e.longitude);A.map.setCenter(e),A.map.setZoom(20),s(function(){A.markersControl.getPlurals().get(t)&&A.markersControl.getPlurals().get(t).gObject.setAnimation(google.maps.Animation.BOUNCE),s(function(){var e=A.markersControl.getPlurals().get(t);e&&e.gObject.setAnimation(null)},3500)},150)},0)}),e.fieldsSetFields().then(function(e){A.serviceFields=e.MapInfo}),A.isEmpty=function(e){return!e||_.isEmpty(e)},A.markerCloseClicked=function(){A.serviceInfoWindow.show=!1,A.resourceInfoWindow.show=!1,A.territoryInfoWindow.show=!1,A.reportInfoWindow.show=!1,A.livePosInfoWindow.show=!1,A.$apply()},A.openLink=function(e,t){"Resource__r"==t.APIName?A.openLightbox(e.resourceId,"resource"):I.openLink(e,t)},A.openReportLink=function(e){e.isReference&&("ServiceResource"==e.APIName?A.openLightbox(e.Value,"resource"):"ServiceAppointment"==e.APIName?A.openLightbox(e.Value,"service"):I.openConsoleTab(null,e.Value)||window.open("../"+e.Value,"_blank"))},A.markerClicked=function(e,t,n){var i=n,n=i.type;switch(A.serviceInfoWindow.show=!1,A.resourceInfoWindow.show=!1,A.territoryInfoWindow.show=!1,A.reportInfoWindow.show=!1,A.livePosInfoWindow.show=!1,A.currentMarker=i,n){case"service":A.serviceInfoWindow.show=!0,A.currentMarker.item=C.serviceAppointments()[i.id];break;case"lastKnownPosition":A.livePosInfoWindow.show=!0;break;case"resource":A.resourceInfoWindow.show=!0;break;case"territory":A.territoryInfoWindow.show=!0;break;case"report":A.reportFields=[],A.reportFields.push.apply(A.reportFields,i.item.otherProperties),A.reportInfoWindow.show=!0}s(function(){A.$apply(),I.setMapCloseButtonPosition()},0)},A.openLightbox=function(e,t,n){var i=null;switch(n&&(i=I.generateResourceId(e,n)),t){case"service":a.recentlyUsed[e]=!0,c.open(e);break;case"resource":u.open(e,i);break;case"homeBase":A.$emit("showResourceLightbox",A.resources[e])}},A.$watch("filter",function(e,t){"map"===A.workingState&&f()},!0),A.clearResource=function(e){delete A.filteredResources[e],f()},A.clearAllResources=function(){A.filteredResources={},f()},A.addResourceToFilterList=function(){var e=k.getResources();""!=A.filterResourceInputValue&&e[A.filterResourceInputValue.value]&&(A.filteredResources[A.filterResourceInputValue.value]=e[A.filterResourceInputValue.value],A.filterResourceInputValue="",f())},A.toggleReportMarkers=function(e){e=A.reportsData[e];e.show=!e.show,f()},A.removeReportFromMap=function(e){delete A.reportsData[e],f()},A.removeAllReportsFromMap=function(){A.reportsData={},f()},A.showReportOnMap=function(){"null"!=A.selectedReport&&o.callRemoteAction(RemoteActions.getReportRowsForMap,A.selectedReport).then(function(e){A.reportsData[A.selectedReport]={show:!0,data:e,displayCount:0};f(!0)})},t.register("positions",function(e){f()}),A.isPinnedStatus=function(){if(A.currentMarker){for(var e=A.pinnedStatusesSF.split(","),t=0;t<e.length;t++)if(A.currentMarker.item.status===e[t])return!0;return!1}},A.needToShowScheduleButton=function(){return A.currentMarker&&"service"==A.currentMarker.type&&!A.currentMarker.item.pinned&&!A.isPinnedStatus()&&A.hasCustomPermission("Schedule")},A.needToShowDispatchButton=function(){return A.currentMarker&&"service"==A.currentMarker.type&&A.currentMarker.item.statusCategory!=i.DISPATCHED&&A.currentMarker.item.statusCategory==i.SCHEDULED},A.isServiceCurrentlyDispatching=function(){return A.currentMarker&&"dispatched"==A.invokedActions[A.currentMarker.id]},A.changeStatusToDispatch=function(e){A.invokedActions[e]?alert(customLabels.another_operation_running):(A.invokedActions[A.currentMarker.id]="dispatched",a.changeStatus([e],m.DISPATCHED).then(function(e){0<e.services.length&&(A.currentMarker.item=e.services[0])}).finally(function(){delete A.invokedActions[A.currentMarker.id]}))},A.isServiceCurrentlyScheduling=function(){return A.currentMarker&&"schedule"==A.invokedActions[A.currentMarker.id]},A.autoScheduleService=function(t){t=A.currentMarker.id;A.invokedActions[t]?alert(customLabels.another_operation_running):(a.recentlyUsed[t]=!0,A.invokedActions[t]="schedule",a.autoScheduleService(t).then(function(e){a.drawServicesAndAbsences(e.services,e.absences),delete A.invokedActions[t]}))},A.myTreeView={},A.lastSelectedLeafId=null,d.all([I.getPolygons(),k.promises.territories()]).then(function(e){var t,n=e[0];if(n)for(var i=0;i<n.length;i++)n[i][fieldNames.Polygon.KML__c]&&(A.polygons[n[i].Id]=n[i]);for(t in k.territories())-1!=I.getFilteredLocations().indexOf(t)&&(A.territories[t]=k.territories()[t]);F(),function(){var e,t,n,i=d.defer(),s=k.territories(),r={},o=[],a=(I.getFilteredLocations(),{NoTerritoryPolygon:{id:"NoTerritoryPolygon"}});for(e in A.polygons)r[e]={id:e,parent:A.polygons[e][fieldNames.Polygon.Service_Territory__c]?s[A.polygons[e][fieldNames.Polygon.Service_Territory__c]]:a.NoTerritoryPolygon,text:A.polygons[e].Name,icons:{file:"fa-square"},icon_color:A.polygons[e][fieldNames.Polygon.Color__c],checked:-1==A.InvisiblePolygons.indexOf(e)?1:0,items:[]};for(t in s)r[t]={id:t,parent:k.territories()[t].parentTerritory?k.territories()[t].parentTerritory:0,text:k.territories()[t].name,icons:{file:"fa-building-o"},checked:-1==A.InvisiblePolygons.indexOf(t)?1:0,items:[]};for(n in r.NoTerritoryPolygon={id:"NoTerritoryPolygon",parent:0,text:customLabels.Polygons_without_Service_Territory,icons:{file:"fa-building-o"},checked:-1==A.InvisiblePolygons.indexOf("NoTerritoryPolygon")?1:0,items:[]},r){var l=r[n],c=function e(t){if(!t.id||!t.parent)return;{var n;return r[t.parent.id]?t.parent:(n={},k.allTerritories[t.parent.id]&&(n={id:k.allTerritories[t.parent.id].id,parent:k.allTerritories[t.parent.id].parentTerritory||0}),e(n))}}(l);(0!==l.parent&&c?r[c.id].items:o).push(l)}return i.resolve(o),i.promise}().then(function(e){A.locationsTree=e,A.myTreeView=new dhtmlXTreeView({parent:"polygonsByTerritoriesTree",iconset:"font_awesome",checkboxes:!0,items:A.locationsTree}),A.myTreeView.attachEvent("onSelect",function(e,t){if(A.drawState!=h.NONE&&A.drawState!=h.SELECTED)return!1;A.lastSelectedLeafId||(A.lastSelectedLeafId=e),!A.polygons[e]||null==A.lastSelectedLeafId||A.lastSelectedLeafId==e&&null==A.polygons[e]?y():(t&&(w(A.polygons[e].polygon),A.shouldBound&&A.selectedShape.getVisible()&&A.map.fitBounds(A.selectedShape.bounds),A.shouldBound=!0),A.lastSelectedLeafId=A.polygons[e].Id)}),A.myTreeView.attachEvent("onCheck",B)})}),A.toggleDrawMode=function(){var e,t;A.drawState!=h.INTERSECT&&(A.drawingManager.setDrawingMode("polygon"),y(),e=A.selectedColor,(t=A.drawingManager.get("polygonOptions")).fillColor=e,A.drawingManager.set("polygonOptions",t),A.drawState=h.DRAW)},A.cancelPolygon=function(){null!=A.drawingManager.getDrawingMode()&&(A.cancelDrawingShape=!0,A.drawingManager.setDrawingMode(null)),A.drawState==h.EDIT&&A.selectedShape&&(A.selectedShape.setMap(null),s(function(){A.currentEditPolygon&&T(A.currentEditPolygon),A.polygonName="",A.polygonTerritory="null"},0)),A.drawState=h.NONE,A.selectedIntersectingPolygons={}},A.editPolygon=function(){A.drawState==h.SELECTED&&A.selectedShape.getVisible()&&(A.currentEditPolygon=A.polygons[A.selectedShape.id],A.drawState=h.EDIT,A.selectedShape.setEditable(!0),A.selectedShape.setDraggable(!0))},A.savePolygon=function(){var n,i,e,t,s,r;A.selectedShape&&(n=[],A.selectedShape.getPath().forEach(function(e,t){n.push({lat:e.lat(),lng:e.lng()})}),i=A.selectedShape.id||null,e="null"!=A.polygonTerritory?A.polygonTerritory:null,A.polygonName?(o.callRemoteAction(RemoteActions.savePolygon,(t=n,s=A.selectedShapeColor,'<?xml version="1.0" encoding="UTF-8"?> \n                            <kml xmlns="http://www.opengis.net/kml/2.2">\n                                <Style id="'+(r=A.polygonName).replace(" ","")+'Style"> \n                                    <LineStyle> \n                                        <width>1</width> \n                                    </LineStyle> \n                                    <PolyStyle> \n                                        <color>'+function(e,t){return t+e.substring(5,7)+e.substring(3,5)+e.substring(1,3)}(s,80)+"</color> \n                                    </PolyStyle> \n                                </Style> \n                                <Placemark> \n                                    <name>"+r.replace(" ","")+"</name> \n                                    <styleUrl>#"+r.replace(" ","")+"Style</styleUrl> \n                                    <Polygon> \n                                        <outerBoundaryIs> \n                                            <LinearRing>\n                                                <coordinates>"+function(e){for(var t="",n=0;n<e.length;n++)t+=e[n].lng+","+e[n].lat+",0\n";return t+=e[0].lng+","+e[0].lat+",0"}(t)+"</coordinates> \n                                            </LinearRing> \n                                        </outerBoundaryIs> \n                                    </Polygon> \n                                </Placemark> \n                            </kml>"),A.polygonName,A.selectedShapeColor,e,i).then(function(e){A.selectedShape.setMap(null),T(e);var t=e,n=i;n&&A.myTreeView.deleteItem(n),n=t[fieldNames.Polygon.Service_Territory__c]||"NoTerritoryPolygon",A.myTreeView.addItem(t.Id,t.Name,n),A.myTreeView.checkItem(t.Id),A.myTreeView.setItemIcons(t.Id,{file:"fa-square"}),A.myTreeView.setIconColor(t.Id,t[fieldNames.Polygon.Color__c]),A.selectedShape=A.polygons[e.Id].polygon}),A.drawState=h.NONE):alert(customLabels.Polygon_name_field_is_empty))},A.deletePolygon=function(){var t;A.selectedShape?confirm(customLabels.This_will_delete_the_selected_polygon.replaceAll(A.selectedShape.name))&&(t=A.selectedShape.id||null,o.callRemoteAction(RemoteActions.deletePolygon,t).then(function(e){A.selectedShape.setMap(null),A.myTreeView.deleteItem(t),y()}),A.drawState=h.NONE):A.drawState=h.NONE};var L={},O=[],M=void 0;function E(e,t){t=t||{},this.setMap(e),this.mapDiv=e.getDiv(),this.menuItems=t.menuItems||{},this.isVisible=!1}function x(e){M.hide(),w(this.clickedPolygon_=this);e=M.getProjection().fromLatLngToDivPixel(e.latLng);M.show(e),A.map.setOptions({draggableCursor:"pointer"})}function P(e){for(var t=[],n=0;n<A.filteredServices.servicesArray.length;n++){var i,s=A.filteredServices.servicesArray[n];null!=s.latitude&&null!=s.longitude&&(i=new google.maps.LatLng(s.latitude,s.longitude),google.maps.geometry.poly.containsLocation(i,e))&&t.push(s.id)}return t}(E.prototype=new google.maps.OverlayView).onAdd=function(){$("<div id='cMenu' class='context-menu-polygon'></div>").appendTo($("#map"));for(var e=$("#cMenu").get(0),t=0;t<this.menuItems.length;t++){var n=this.menuItems[t];$('<div id="'+n.id+'" class="truncate context-menu-polygon-item" title="'+n.name+'">'+n.label+"</div>").appendTo(e)}this.div_=e;this.getPanes().overlayMouseTarget.appendChild(this.div_);for(var r=this,t=0;t<this.menuItems.length;t++){n=this.menuItems[t];google.maps.event.addDomListener($("#"+n.id).get(0),"click",$.proxy(function(){r.clickedItem=this.id,google.maps.event.trigger(r,"click")},n))}google.maps.event.addListener(r,"click",function(){var e,t,n,i,s=r.clickedItem;switch(s){case"menu-edit-polygon":A.mapOptionsToggle=!0,$(".polygonsTab").click(),A.editPolygon();break;case"menu-intersect-polygon":A.mapOptionsToggle=!0,$(".polygonsTab").click(),A.currentIntersectingId=angular.copy(A.selectedShape.id),A.drawState=h.INTERSECT,A.$apply();break;case"menu-delete-polygon":A.deletePolygon();break;case"menu-schedule-polygon":l.schedule(P(A.selectedShape)),A.$apply();break;case"menu-unschedule-polygon":a.unscheduleServices(P(A.selectedShape));break;case"menu-dispatch-polygon":a.changeStatus(P(A.selectedShape),m.DISPATCHED).then(function(e){a.drawServicesAndAbsences(e.services)}).catch(function(e){I.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)});break;case"menu-joepardy-polygon":a.setInJeopardy(P(A.selectedShape));break;default:0===s.indexOf("custom_")&&(n=parseInt(s.split("_")[1]),e=P(A.selectedShape),(t=I.getCustomActions("map")[n]).visualforce?(n=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),i=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===e.length?g.open(t.name,t.visualforce+"?id="+e[0]+"&start="+n+"&end="+i):g.open(t.name,t.visualforce+"?services="+e.join(",")+"&start="+n+"&end="+i)):o.callRemoteAction(RemoteActions.runCustomServiceAction,t.className,P(A.selectedShape),scheduler._min_date,scheduler._max_date).then(function(e){p.updateGantt(),e&&I.addNotification(t.name,e,null,null)}).catch(function(e){return I.addNotification(t.name,e.message,null,null)}))}event.stopPropagation(),M.hide()})},E.prototype.draw=function(){},E.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_),this.div_=null},E.prototype.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},E.prototype.show=function(e){var t;this.div_&&((t=this.div_).style.left=e.x+5+"px",t.style.top=e.y+10+"px",this.div_.style.visibility="visible")},A.hasCustomPermission("Polygons_create_update")&&O.push({id:"menu-intersect-polygon",className:"context_menu_item",eventName:"intersect",label:I.getSVGIconHTML(lsdIcons.cut)+customLabels.Cut_Intersections,name:customLabels.Cut_Intersections}),A.hasCustomPermission("Bulk_Schedule")&&O.push({id:"menu-schedule-polygon",className:"context_menu_item",eventName:"schedule",label:I.getSVGIconHTML(lsdIcons.calendar)+customLabels.Schedule,name:customLabels.Schedule}),A.hasCustomPermission("Bulk_Unschedule")&&O.push({id:"menu-unschedule-polygon",className:"context_menu_item",eventName:"unschedule",label:I.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,name:customLabels.Unschedule}),A.hasCustomPermission("Bulk_Dispatch")&&O.push({id:"menu-dispatch-polygon",className:"context_menu_item",eventName:"dispatch",label:I.getSVGIconHTML(lsdIcons.dispatch)+customLabels.Dispatch,name:customLabels.Dispatch}),O.push({id:"menu-joepardy-polygon",className:"context_menu_item",eventName:"joepardy",label:I.getSVGIconHTML(lsdIcons.jeopardy)+customLabels.In_Jeopardy,name:customLabels.In_Jeopardy}),A.hasCustomPermission("Polygons_create_update")&&O.push({id:"menu-delete-polygon",className:"context_menu_item",eventName:"delete",label:I.getSVGIconHTML(lsdIcons.delete)+customLabels.Delete_polygon,name:customLabels.Delete_polygon}),L.menuItems=O,I.customActionsPromise.then(function(){I.getCustomActions("map").forEach(function(e,t){O.push({id:"custom_"+t,className:"context_menu_item",eventName:"custom_"+t,label:e.icon?I.getSVGIconHTML(e.icon)+e.name:e.name,name:e.name})})}),A.getIntersectionsForPolygons=function(){if(!A.isEmpty(A.selectedIntersectingPolygons))try{var e,t=new jsts.io.WKTReader,n=t.read(A.selectedShape.ToWKT());for(e in A.selectedIntersectingPolygons)var i=t.read(A.polygons[e].polygon.ToWKT()),n=n.difference(i);for(var s=(new jsts.io.WKTWriter).write(n),r=s.slice(9,s.length-2).split(","),o=[],a=0;a<r.length;a++){var l=r[a].split(" ");o.push(new google.maps.LatLng({lat:parseFloat(l[1]),lng:parseFloat(l[0])}))}A.selectedShape.setPath(o),A.savePolygon(),A.selectedIntersectingPolygons={}}catch(e){alert("Problem finding intersections in given polygons."),console.error(e)}}}]),angular.module("serviceExpert").controller("ctrlRightSide",["$q","$scope","$rootScope","$filter","$sce","$injector","sfdcService","MapService","utils","servicesService","kpiCalculationsService","StateService","DeltaService","TimePhasedDataService","StreamingAPIService","RegisterService","OptimizationRequestsService","LeftSideLocationFilteringService","FieldSetFieldsService",function(e,n,t,i,s,r,o,a,l,c,d,u,p,m,h,g,v,f,S){var _={opacity:1,left:null,top:null,height:400,width:600};n.isMapEnabled=u.isMapEnabled(),n.startLoadMap=!0,n.servicesObjects=c.servicesObjects,n.servicesScheduledToCapacity={},n.notifications=l.butlerNotifications,n.unreadNotifications=0,n.showServiceList=l.showServiceList,n.workingState="gantt",n.openConsoleTab=l.openConsoleTab,n.openSObjectLink=l.openSObjectLink,n.activeRequests=o.activeRequests,n.activeRuleCheckRequests=o.activeRuleCheckRequests,n.kpi=d.kpis,n.marginLeftForBox=0,n.mapAvailable=mapMode,n.optimizationRequests=v.optimizationRequests,n.floatingMapOn=!1,n.optRequestPercentage=0,n.OptimizationRequestsProgressStatus=v.OptimizationRequestsProgressStatus,n.generateRequestResultText=v.generateRequestResultText,n.canAbortOR=v.canAbortOR,n.abortOptRequest=v.abortOptRequest,n.isUseEdge=l.isUseEdge,n.isNoTerritoryLoadded=f.isNoTerritoryLoadded,n.reachedMaxRows=m.reachedMaxRows,n.maxResourceRowsOnGantt=window.__gantt.maxResourceRowsOnGantt,n.isLoadingNewLocations=function(){return u.isLoadingNewLocations},window.isOptimizationViewer&&(c=r.get("LoadOptiViewerDataService"),n.isOptimizationLoaded=c.isOptimizationLoaded,n.isShowingOutputJson=c.isShowingOutputJson),n.$watch("workingState",function(e){"gantt"===e&&setTimeout(function(){scheduler._is_initialized()&&updateViewDebounced()},0)}),S.fieldsSetFields().then(function(e){n.serviceFields=e.MapInfo}),n.getServiceInfoRowClass=l.getServiceInfoRowClass,n.openLink=l.openLink,n.order=function(e,t){n.orderByField=e,n.reverse=t},n.$on("changeWorkingState",function(e,t){"gantt"===(n.workingState=t)?setTimeout(function(){updateViewDebounced()},100):$(".dhtmlXTooltip").remove()}),n.showNotifications=function(){n.unreadNotifications=0,l.butlerNotifications().forEach(function(e){return e.unread=!1})},n.calcUnreadNotifications=function(){return n.unreadNotifications=0,l.butlerNotifications().forEach(function(e){e.unread&&n.unreadNotifications++}),n.unreadNotifications},n.numOfNotifications=function(){var t=0;return l.butlerNotifications().forEach(function(e){e.show&&t++}),t},n.formatTravel=function(e){var t=Math.floor(e/60/60),e=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+e+customLabels.kpi_m},n.toggleServiceList=function(){n.showServiceList.show=!0,setTimeout(function(){updateViewDebounced(),t.$broadcast("resizeMap",{})},830)},n.isEmpty=function(e){return Object.keys(e).length},n.getRequestCss=function(e){switch(e){case"Hold":case"Post Processing":case"In Progress":return"smart_in_progress";case"Completed":return"smart_completed";case"Completed First Optimization Day":return"smart_completed_first_day";case"Finalizing":return"smart_finalizing";case"Failed":return"smart_failed";case"Open":return"smart_open";case"Queued":return"smart_queued";case"Aborting":return"smart_in_progress";case"Aborted":return"smart_failed"}},n.moveLocalDtToUserTimezoneDt=function(e){e=new Date(e);return l.convertDateBetweenTimeZones(e,"GMT",userTimeZone)},n.getNumOfRunningRequests=function(){return v.getNumOfActiveOptimizationRequests()},n.openSomethingBox=function(e,t){n.marginLeftForBox="smart"===t?e.target.offsetLeft-227:e.target.offsetLeft-200},n.shouldShowLongTermError=function(){return"LongView"===scheduler._mode&&"gantt"===n.workingState&&(window.__gantt.reachedMaxNumberOfServicesInLongView||window.__gantt.reachedMaxNumberOfAbsencesInLongView)},window.__gantt.shouldShowLongTermError=n.shouldShowLongTermError,n.showFloatingMap=function(e){e.stopPropagation(),n.floatingMapOn=!0;e=$("#MapContainer");e.css("opacity",_.opacity),e.css("height",_.height+"px"),e.css("width",_.width+"px"),_.left&&(e.css("left",_.left+"px"),e.css("top",_.top+"px"),e.css("bottom","auto"))},n.changeWorkingState=function(e){e!==n.workingState&&(n.workingState=e,n.floatingMapOn=!1,"map"===e?$("#MapContainer").removeAttr("style").resizable("disable"):$("#MapContainer").removeAttr("style").resizable("enable"))},n.closeFloatingMap=function(){n.floatingMapOn=!1,$("#MapContainer").removeAttr("style").resizable("disable")},setTimeout(function(){$("#MapContainer").draggable({handle:"#FloatingMapControls",containment:"document",start:function(){},stop:function(e,t){_.left=t.position.left,_.top=t.position.top}}).resizable({maxHeight:window.innerHeight-75,maxWidth:window.innerWidth-75,minHeight:300,minWidth:450,handles:"all",containment:"document",distance:10,start:function(){},stop:function(e,t){_.width=t.size.width,_.height=t.size.height,_.left=t.position.left,_.top=t.position.top}}),$("#FloatingMapOpacity").slider({range:"min",min:40,max:100,value:100,slide:function(e,t){$("#MapContainer").css("opacity",t.value/100),_.opacity=t.value/100}})},2e3)}]);var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(i.push(o.value),!n||i.length!==n);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}angular.module("serviceExpert").controller("serviceListCtrl",["$scope","$compile","$rootScope","$filter","utils","$timeout","$sce","servicesService","sfdcService","ResourcesAndTerritoriesService","GetSlotsService","userSettingsManager","StateService","TimePhasedDataService","LoadServiceListService","FieldSetFieldsService","ServiceAppointmentLightboxService","ServiceSelectorService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","RegisterService","GanttFilterService","GeneralLightbox","LeftSideLocationFilteringService","$q","BundleService","BundleActions","listQuickActionsService","PushServices",function(a,N,s,i,o,d,G,l,c,r,B,u,p,t,H,V,U,n,e,m,h,g,v,f,S,z,b,y,j,w){a.bundleService=b,a.bundlerActions=y,a.isRtlDir=p.isRtlDirection(),a.tooltipDirection=a.isRtlDir?"left-bottom":"right",a.serversideServiceListFilter=window.serversideServiceListFilter,a.absenceOverlapHeight=u.GetUserSettingsProperty("Absence_Overlap_Height__c"),__gantt.absenceOverlapHeight=a.absenceOverlapHeight;var T=!0,L=null;function A(e){delete a.filtersMap[e];for(var t=-1,n=0;n<a.filterOptions.length;n++)if(a.filterOptions[n].Id===e){t=n;break}-1!==t&&a.filterOptions.splice(t,1),a.filter.selectedFilter="All",u.GetUserSettingsProperty("Selected_List_View__c")!==a.filter.selectedFilter&&u.SetUserSettingsProperty("Selected_List_View__c",a.filter.selectedFilter)}function W(e){var t,n,i,e=0<arguments.length&&void 0!==e&&e;a.filtersMap&&(t=a.filtersMap[a.filter.selectedFilter])&&!t.old&&(n=new Date(a.filter.endDate),i=new Date(a.filter.endDate),"Invalid Date"===a.filter.endDate.toString()&&(n=new Date(scheduler._max_date),i=new Date(scheduler._max_date)),t.List_only_appointments_on_the_gantt?(n=scheduler._min_date,i=scheduler._max_date):(n.setDate(n.getDate()-t.Days_before_horizon-1),i.setDate(i.getDate()+t.Days_after_horizon)),M(i,Math.ceil((i-n)/1e3/60/60/24),[],null,e))}angular.element(document).ready(function(){var l=!1,c=a.isRtlDir;function e(){var e,t,n=u.GetUserSettingsProperty("Left_Panel_Width_Percentage__c"),i=400,s=$("#contentWrapper"),r=u.GetUserSettingsProperty("Services_List_Height_Percentage__c"),o=250,a=$("#SmartPanelContainer");0===s.length&&(s=$(window)),0===a.length&&(a=$(window)),0!=!s.width()||l||(l=!0,n=(i=(i=null!=n&&0<n&&n<100?s.width()*n*.01:i)<400?400:i)+3,c?(e=document.getElementById("LeftSideContainer"),t=document.getElementById("RightSideContainer"),e.before(t),$("#LeftSideContainer").width("calc(100% - "+n+"px)"),Split(["#RightSideContainer","#LeftSideContainer"],{sizes:[i+"px"],minSize:[700,400],snapOffset:10,gutterSize:3,onDragEnd:function(){updateViewDebounced();var e=$(c?"#RightSideContainer":"#LeftSideContainer").width()/s.width();u.SetUserSettingsProperty("Left_Panel_Width_Percentage__c",e*=100)}})):($("#RightSideContainer").width("calc(100% - "+n+"px)"),Split(["#LeftSideContainer","#RightSideContainer"],{sizes:[i+"px"],minSize:[400,700],snapOffset:10,gutterSize:3,onDragEnd:function(){updateViewDebounced();var e=$(c?"#RightSideContainer":"#LeftSideContainer").width()/s.width();u.SetUserSettingsProperty("Left_Panel_Width_Percentage__c",e*=100)}}))),d(function(){var e,t;100!==a.height()&&(e=(o=250<(o=null!=r&&0<r&&r<100?a.height()*r*.01:o)?250:o)+5,$("#ServiceListBottomContainer").height("calc(100% - "+e+"px"),e=a.height()-250,(t=a.find(".gutter-vertical")).length&&t.remove(),Split(["#ServiceListTopContainer","#ServiceListBottomContainer"],{direction:"vertical",sizes:[o+"px"],minSize:[5,e],snapOffset:10,gutterSize:5,onDragEnd:function(){var e=$("#ServiceListTopContainer").height()/a.height();u.SetUserSettingsProperty("Services_List_Height_Percentage__c",e*=100)}}))},0)}e(),$(window).bind("resize",e)}),"territories"===u.GetUserSettingsProperty("DefaultLeftPanel__c")&&u.GetUserSettingsProperty("locations").length&&S.open(),useNewFilters&&v.filtersPromise.then(function(e){var i=[];a.filterOptions.forEach(function(e){var t,n={};for(t in e)n[t]=e[t];n.Name=e.name,n.old=!0,n.Id=e.value,n.group=customLabels.Standard_Filters,n.Description=a.OOTBFilterDescription[e.value],i.push(n)}),e.forEach(function(e){e.group=customLabels.My_Custom_Filters,e.value=e.Id}),a.copilotGroups=[customLabels.My_Copilot_Summaries,customLabels.My_Copilot_Searches],a.filterOptions=[].concat(i,_toConsumableArray(e)),a.schedulingIssuesCategory="SchedulingIssues",a.serviceQueryCategory="ServicesQuery",a.groupedFilters=[{groupName:customLabels.My_Copilot_Summaries,groupFilters:[]},{groupName:customLabels.My_Copilot_Searches,groupFilters:[]},{groupName:customLabels.Standard_Filters,groupFilters:i},{groupName:customLabels.My_Custom_Filters,groupFilters:e}],a.filter.isPlatformEventFilter=!1,a.filtersMap={},a.filterOptions.forEach(function(e){return a.filtersMap[e.Id]=e})}).finally(function(){a.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0}),v.setFilterMap(a.filtersMap)}),window.__closeFilterLightbox=function(t){o.safeApply(a,function(){var e=f.closeLightboxFromOutside();e&&e(),t&&(v.getFilterFromSalesforce(t).then(function(e){if(e.value=e.Id,e.group=customLabels.My_Custom_Filters,a.filtersMap[e.Id]){for(var t=0;t<a.filterOptions.length;t++)if(a.filterOptions[t].Id===e.Id){a.filterOptions[t]=e;break}}else a.filterOptions.push(e),a.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0});a.filtersMap[e.Id]=e}),a.serversideServiceListFilter)&&a.servicesListVisitedDays[t]&&W(!0)})},a.openGanttFilterLightbox=function(e){var t=a.filtersMap[a.filter.selectedFilter];switch(e){case"new":f.open(customLabels.FilterEditor,filterEditorPage);break;case"edit":f.open(customLabels.FilterEditor,filterEditorPage+"?&id="+t.Id);break;case"delete":confirm(customLabels.ConfirmFilterDelete)&&(a.copilotGroups.includes(a.filtersMap[t.Id].group)||a.filter.isPlatformEventFilter?(A(t.Id),a.groupedFilters.forEach(function(e){(t.group===customLabels.My_Custom_Filters&&e.groupName===customLabels.My_Custom_Filters||a.copilotGroups.includes(e.groupName))&&(e.groupFilters=e.groupFilters.filter(function(e){return e.Id!==t.Id}))})):v.deleteFilter(t.Id).then(A));break;case"hide":confirm(customLabels.ConfirmFilterHide)&&v.hideFilter(t.Id).then(A)}},a.showNewFilterButton=function(){return customPermissions.Create_custom_Gantt_filters},a.showEditFilterButton=function(){var e;return!!a.filtersMap&&!(!(e=a.filtersMap[a.filter.selectedFilter])||e.old||(!customPermissions.Create_custom_Gantt_filters||customPermissions.Publish_custom_Gantt_filters||e.CreatedById!==userId)&&!customPermissions.Publish_custom_Gantt_filters)},a.showDeleteFilterButton=function(){var e;return!!a.filtersMap&&!(!(e=a.filtersMap[a.filter.selectedFilter])||e.old)&&customPermissions.Create_custom_Gantt_filters&&e.CreatedById===userId},a.showHideFilterButton=function(){var e;return!!a.filtersMap&&!(!(e=a.filtersMap[a.filter.selectedFilter])||e.old)&&customPermissions.Publish_custom_Gantt_filters&&customPermissions.Create_custom_Gantt_filters},a.updateDeltaDatesOnCustomFilter=function(){var e,t;a.filtersMap[a.filter.selectedFilter]&&!a.filtersMap[a.filter.selectedFilter].old&&(e=24*a.filtersMap[a.filter.selectedFilter].Days_before_horizon*60*60*1e3,t=24*a.filtersMap[a.filter.selectedFilter].Days_after_horizon*60*60*1e3,e=new Date(a.filter.endDate.getTime()-e+6e4),t=new Date(a.filter.endDate.getTime()+t),p.setDeltaDates(e,t))},a.loadCopilotSummaryFilter=function(){a.loadingServicesToList=1,l.getServicesById(a.filter.platformEventFilters[a.filter.selectedFilter]).then(function(e){a.loadingServicesToList=0})},a.$watch("filter.selectedFilter",function(e,t){useNewFilters&&e!==t&&"SearchOnServer"!==e&&(a.copilotGroups.includes(a.filtersMap[e].group)||a.filtersMap[e].Id.includes("customSearchFilter")?a.filter.isPlatformEventFilter=!0:a.filter.isPlatformEventFilter=!1)}),a.newFilterChanged=function(){if(w.isPushServiceActive()&&w.updateSession({operation:w.MESSAGE_OPERATIONS.UPDATE}),"SearchOnServer"!==a.filterOptions[a.filterOptions.length-1].Id)if("SearchOnServer"!==a.filter.selectedFilter.Id&&"SearchOnServer"===a.filterOptions[a.filterOptions.length-1].Id&&(a.filterOptions.pop(),a.groupedFilters.forEach(function(e){e.groupName===customLabels.Standard_Filters&&e.groupFilters.pop()})),useNewFilters){if(!a.filtersMap)return!1;var e=a.filtersMap[a.filter.selectedFilter]||a.filtersMap.All;a.filtersMap[a.filter.selectedFilter]||(a.filter.selectedFilter="All",e.selectedFilter="All"),a.filtersMap[a.filter.selectedFilter].group!==customLabels.My_Copilot_Summaries||a.copilotSummaryFiltersCache[a.filter.selectedFilter]||(a.copilotSummaryFiltersCache[a.filter.selectedFilter]=!0,a.loadCopilotSummaryFilter()),a.copilotGroups.includes(a.filtersMap[a.filter.selectedFilter].group)||u.GetUserSettingsProperty("Selected_List_View__c")===a.filter.selectedFilter||(u.SetUserSettingsProperty("Selected_List_View__c",a.filter.selectedFilter),a.updateDeltaDatesOnCustomFilter()),!e||e.old?a.loadServiceAppointmentsToList():W()}else a.loadServiceAppointmentsToList()},a.fieldsTypes=o.fieldsTypes,a.openConsoleTab=o.openConsoleTab,a.useNewFilters=window.useNewFilters,a.isMapEnabled=p.isMapEnabled(),a.contractorSupport=p.areContractorsSupported(),a.statuses=e,a.statusCategory=m,a.statusTranslations=o.statusTranslations,a.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,a.ganttSettings=o.ganttSettings,a.showServiceList=o.showServiceList,a.hasCustomPermission=o.hasCustomPermission,a.isLightning=o.isLightning,a.loadingServicesToList=0,a.isServicePreviewAvailable=!1,a.isOptimizationEnabled=isOptimizationEnabled,a.bulkActionsOrder=bulkActionsOrder,a.isInConsole=p.isInConsole,a.matchGantt=u.GetUserSettingsProperty("Match_Gantt_Dates__c"),a.fullScreen=!1,window.location.search.match(/[&?]fullScreen=(\d)/)&&(a.fullScreen="1"===window.location.search.match(/[&?]fullScreen=(\d)/)[1]?"0":"1"),a.servicesObjects=t.serviceAppointments,a.selectedServiceId=null,a.lastSelectedServiceId=null,a.servicesListVisitedDays={},a.servicesListInited=!1;var I={},C=[],k=(a.flagged=l.flagged,a.loadedTerritories=[],a.selectorService=n,a.servicesSelection=a.selectorService.SelectedServices,a.selectedPolicy=null,a.policyOptions=[],a.showGanttSettings=!1,a.ganttSettingDraft=null,a.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],a.reallyHideList=!1,a.showAdvancedFilter=!1,a.invokedAction={},a.invokedActionFor={},a.showCustomFilterDropdown=!1,a.storageFilters=null,a.prevEndDate=null,a.sortingColumn="start",a.sortingColumnName={start:customLabels.Start_time,finish:customLabels.Finish_time,accountName:customLabels.Account,serviceTypeName:customLabels.Service_type,priority:customLabels.Priority,resourceName:customLabels.Resource,earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,locationName:customLabels.Location},a.defaultFilterDescription=customLabels.Default_Description_Filter,a.OOTBFilterDescription={All:customLabels.All_Filter_Description,inJeopardy:customLabels.InJeopardy_Filter_Description,Violating:customLabels.Violating_Filter_Description,Unscheduled:customLabels.Unscheduled_Filter_Description,Todo:customLabels.ToDo_Filter_Description,Selected:customLabels.Selected_Filter_Description,Recent:customLabels.Recently_Filter_Description,Scheduled:customLabels.Scheduled_Filter_Description,"Gantt filter":customLabels.Gantt_Filter_Description,Flagged:customLabels.Flagged_Filter_Description,"Crews filter":customLabels.Crews_Filter_Description,"Contractors filter":customLabels.Contractors_Filter_Description,"Cancelled filter":customLabels.Canceled_Filter_Description},a.selectedDates={earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,appStart:customLabels.Appointment_start,appEnd:customLabels.Appointment_finish,start_date:customLabels.Start,end_date:customLabels.Finish},a.filter=l.filter,a.orderByField=l.filter.orderByField,a.reverse=l.filter.reverse,a.filteredServices=l.filteredServices,a.filterOptions=[],o.hasCustomPermission("Service_List_Todo")&&a.filterOptions.push({name:customLabels.Todo,value:"Todo"}),a.filterOptions.push({name:customLabels.AllServices,value:"All"}),a.filterOptions.push({name:customLabels.Recently_used,value:"Recent"}),o.hasCustomPermission("Service_List_Flagged")&&a.filterOptions.push({name:customLabels.Flagged,value:"Flagged"}),o.hasCustomPermission("Service_List_Selected")&&a.filterOptions.push({name:customLabels.Selected_Capital,value:"Selected"}),o.hasCustomPermission("Service_List_Unscheduled")&&a.filterOptions.push({name:customLabels.UnscheduledCapital,value:"Unscheduled"}),o.hasCustomPermission("Service_List_Scheuled")&&a.filterOptions.push({name:customLabels.Scheduled,value:"Scheduled"}),o.hasCustomPermission("Service_List_In_Jeopardy")&&a.filterOptions.push({name:customLabels.In_Jeopardy,value:"inJeopardy"}),o.hasCustomPermission("Service_List_Rule_Violating")&&a.filterOptions.push({name:customLabels.Rules_violating,value:"Violating"}),o.hasCustomPermission("Service_List_Gantt")&&a.filterOptions.push({name:customLabels.Gantt,value:"Gantt filter"}),o.hasCustomPermission("Service_List_Canceled")&&a.filterOptions.push({name:customLabels.Cancelled,value:"Cancelled filter"}),p.areContractorsSupported()&&o.hasCustomPermission("Service_List_Contractors")&&a.filterOptions.push({name:customLabels.Contractors,value:"Contractors filter"}),p.areCrewsSupported()&&o.hasCustomPermission("Service_List_Crews")&&a.filterOptions.push({name:customLabels.crews,value:"Crews filter"}),b.isActive()&&o.hasCustomPermission("Service_List_Exclude_Bundle_Members")&&a.filterOptions.push({name:customLabels.Exclude_Bundle_Members_Filter,value:"Exclude Bundle Members"}),a.filterOptions.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0}),V.fieldsSetFields().then(function(e){for(var t in I=e,Array.isArray(e.servicePreview)&&0<e.servicePreview.length&&(a.isServicePreviewAvailable=!0),e)e[t].forEach(function(e){C[e.FullAPIName]=e});a.ListExpandedFieldSet=e.ListExpanded,n.setAllfieldsSetFieldsObject(I),n.setAllfieldsSetFieldsObjectOneLevel(C)}),a.getColumnsToDisplay=function(){var t,e=v.getFilterById(a.filter.selectedFilter);return e&&e.Displayed_Fields&&0<e.Displayed_Fields.length?(t=[],e.Displayed_Fields.forEach(function(e){C[e]&&t.push(C[e])}),t):I.ListColumns},{}),D=(a.getColumnWidthCss=function(e){return k[e.FullAPIName]?(94===(e={width:k[e.FullAPIName]+"px"}).width&&(e["padding-right"]=0),e):{}},a.getSingleTaskColumnClass=function(e){var t={SingleTaskColumn:!0,truncate:!0};return t["Field-"+e.Type]=!0,t},a.getHeaderTaskColumnClass=function(e){var t={SortingTasksListColumn:!0};return t["Field-"+e.Type]=!0,t},a.changeListSorting=function(e,t){a.order(e.APIName,!a.filter.reverse);for(var n=document.getElementsByClassName("SortingTasksListColumn"),i=0;i<n.length;i++){var s=n[i],r=s.style.width;r&&(r=parseInt(r.slice(0,-2)),k[s.dataset.fieldApi]=94<r?r:94)}t.stopPropagation()},a.scrollPosition={x:0},null),R=null,F=null,O=null,q=(document.addEventListener("mouseup",function(){o.safeApply(a,function(){var e;null!=O&&null!=F&&(D=D||document.getElementById("TaskListItems"),R=R||document.getElementById("TaskListSorting"),e=(e=F.style.width)&&parseInt(e.slice(0,-2)),k[O]=94<e?e:94,D.scrollLeft=R.scrollLeft,F=O=null)})}),a.setColumnResizeData=function(e,t){O=e.FullAPIName,F=t.currentTarget},window.syncServiceListScrollbars=function(){D=D||document.getElementById("TaskListItems"),R=R||document.getElementById("TaskListSorting");var e=D.scrollLeft;R.scrollLeft=e,q(e)},_.debounce(function(e){o.safeApply(a,function(){p.isRtlDirection()?a.scrollPosition.x=e+"px":a.scrollPosition.x="-"+e+"px"})},100,{maxWait:2e3}));function M(t,n,i){var e,s=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,r=4<arguments.length&&void 0!==arguments[4]&&arguments[4];null===s&&(M.loadedSoFar=0),M.loadedSoFar>=maxNumberOfServicesToLoad?(o.addNotification(customLabels.Too_Many_Services_Header_Services_List,customLabels.Too_Many_Services_Services_List),M.loadedSoFar=0):(e=!a.filtersMap||!a.filtersMap[a.filter.selectedFilter].old,useNewFilters&&e&&a.updateDeltaDatesOnCustomFilter(),a.loadingServicesToList++,H.loadServicesInBulk(a.servicesObjects(),a.servicesListVisitedDays,t,n,s,a.filter.selectedFilter,e,r).then(function(e){e.totalFetched===numberOfServicesToLoadInEachBulk?(M.loadedSoFar+=e.totalFetched,i.push.apply(i,_toConsumableArray(e.needToCheckRules)),M(t,n,i,e.lastFetchedId)):e.scheduledServices&&(i.push.apply(i,_toConsumableArray(e.needToCheckRules)),0<i.length)&&"Always"===window.__gantt.checkRulesMode&&l.checkRules(i).then(l.drawViolationsOnGantt),window.splunkLoggingFinestFlagEnabled&&T&&(e=M.loadedSoFar+e.totalFetched,T=!1,c.callRemoteAction(RemoteActions.sendDataToSplunk,"serviceListCount",null,null,null,e,null))}).catch(function(e){console.warn("loadServiceAppointmentsToList failed "+e)}).finally(function(){return a.loadingServicesToList--}))}function E(){var e=scheduler.getState().max_date;return 0===e.getHours()&&0===e.getMinutes()?e=new Date(e.getTime()-6e4):(e.setHours(23),e.setMinutes(59),e.setSeconds(0)),e}a.getQuickActionContainerWidth=function(){return(L=L||document.getElementById("LeftSideContainer")).clientWidth<400?"380px":L.clientWidth-20+"px"},a.loadServiceAppointmentsToList=function(){M(a.endDate,o.ganttSettings.backHorizon,[])},a.formatServiceField=function(e,t){var n=e[t.APIName];switch(t.Type){case o.fieldsTypes.DateTime:n=i("amDateFormat")(n,"lll");break;case o.fieldsTypes.Date:n=i("amDateFormat")(n,"L")}return n},a.getRefFieldID=function(e,t){return e[t.JsAPIName.replace("__r","__c")]},a.isFieldEmpty=function(e,t){return void 0===i("displayFieldSetField")(e,t)},a.openCalendarAdvanceFilterStart=function(){a.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(a.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(a,function(){e>new Date(a.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):a.filter.advancedFilter.minDate=e}),scheduler.destroyCalendar()}}))},a.openCalendarAdvanceFilterFinish=function(){a.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMax",date:new Date(a.endDate),navigation:!0,handler:function(e,t){o.safeApply(a,function(){e<new Date(a.filter.advancedFilter.minDate)?alert(customLabels.startBeforeEnd):a.filter.advancedFilter.maxDate=e}),scheduler.destroyCalendar()}}))},a.openCalendarAdvanceFilterStart=function(){a.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(a.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(a,function(){e>new Date(a.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):a.filter.advancedFilter.minDate=e}),scheduler.destroyCalendar()}}))},p.promises.policies().then(function(e){a.policyOptions=e;for(var t=!1,n=u.GetUserSettingsProperty("Gantt_Policy__c"),i=0;i<e.length;i++)if(n){if(e[i].Id===n){a.selectedPolicy=e[i],t=!0;break}}else if(e[i].Id===defaultPolicy){a.selectedPolicy=e[i],t=!0;break}t||(a.selectedPolicy=a.policyOptions[0]),p.selectedPolicyId=a.selectedPolicy.Id}).catch(function(e){console.warn(e),cantLoadGantt(customLabels.no_policy_found)}),a.showGlobalCheckRules=function(){return window.customPermissions.Enable_Check_Rules_For_All_Services},a.checkRulesForAllServices=function(){if("Always"!==window.__gantt.checkRulesMode){var e,t=[];for(e in scheduler._events)"service"===scheduler._events[e].type&&t.push(e);0<t.length&&l.checkRules(t).then(l.drawViolationsOnGantt)}},a.changePolicy=function(){if(p.selectedPolicyId=a.selectedPolicy.Id,u.SetUserSettingsProperty("Gantt_Policy__c",a.selectedPolicy.Id),"Always"===window.__gantt.checkRulesMode){var e,t=[];for(e in scheduler._events)"service"===scheduler._events[e].type&&t.push(e);0<t.length&&l.checkRules(t).then(l.drawViolationsOnGantt)}},a.policySelectorDisabled=function(){return!window.__gantt.ignoreReadonlyGantt226&&!window.customPermissions.Enable_Gantt_Policy_Picker||0===a.policyOptions.length},a.order=function(e,t){a.filter.orderByField=e,a.filter.reverse=t},a.selectService=function(e){e===a.selectedServiceId?(a.selectedServiceId=null,a.lastSelectedServiceId=e):(a.lastSelectedServiceId=a.selectedServiceId,a.selectedServiceId=e)},a.violationsTooltip=function(e){if(!e.violations&&!e.jeopardy){if(b.isBundleMember(e))return customLabels.BundleMemberToolTip;if(b.isBundle(e))return customLabels.BundleToolTip;if(e.isMDT)return customLabels.Multi_Day_Service}if(e.violations||e.jeopardy){if(e.jeopardy&&e.jeopardyReason)return e.jeopardyReason;if(e.violations){for(var t="",n=0;n<e.violations.length;n++)t+=e.violations[n].RuleName+"\n";return t=t&&t.substring(0,t.length-1)}}},a.getStatusClass=function(e){return o.getCSSClassByStatusCategory(e.statusCategory,m)},a.$on("initCompleted",function(e){a.initEndDate();var t=u.GetUserSettingsProperty("locations");a.territories=[];for(var n=0;n<t.length;n++)void 0!==r.territories()[t[n]]&&a.territories.push(r.territories()[t[n]]);if(!useNewFilters){a.storageFilters=Y();for(var i=0;i<a.storageFilters.length;i++)a.filterOptions.push({name:a.storageFilters[i].name,value:a.storageFilters[i].name});0<a.storageFilters.length?P(a.storageFilters[0].name):P(null)}}),a.initEndDate=function(){a.endDate=E(),a.matchGantt||(a.endDate=o.addDaysToDate(a.endDate,1)),a.prevEndDate=a.endDate,a.filter.endDate=a.endDate,a.horizonDateChanged()},a.horizonDateChanged=function(){var e;moment(a.filter.endDate).isValid()&&(e=o.addDaysToDate(a.filter.endDate,-o.ganttSettings.backHorizon),p.setDeltaDates(e,a.filter.endDate))},a.$on("ganttFinishedLoadingServices",function(){!a.matchGantt&&!1!==a.servicesListInited||(a.servicesListInited||null!==a.endDate&&!isNaN(a.endDate.getTime())||a.initEndDate(),a.servicesListInited=!0,a.newFilterChanged())}),scheduler.attachEvent("onBeforeViewChange",function(e,t){return scheduler._old={mode:e,date:t},!0});var Z=!0,K=(scheduler.attachEvent("onViewChange",function(e,t){scheduler._old.mode===e&&t===scheduler._old.date&&"LongView"!==scheduler._mode&&"MonthlyView"!==scheduler._mode||p.isLoadingNewLocations||(p.setDeltaDates(scheduler.getState().min_date,E()),o.safeApply(a,function(){var e;a.matchGantt&&(e=E(),a.filter.endDate=e,a.endDate=e,a.matchGantt&&!Z?a.newFilterChanged():Z=!1)}))}),a.matchGanttClicked=function(){var e;a.matchGantt?("Invalid Date"===(e=a.prevEndDate).toString()&&(e=scheduler._min_date),a.filter.endDate=e,a.endDate=e,u.SetUserSettingsProperty("Match_Gantt_Dates__c",!1)):(a.prevEndDate=a.endDate,a.filter.endDate=E(),a.endDate=a.filter.endDate,u.SetUserSettingsProperty("Match_Gantt_Dates__c",!0)),a.newFilterChanged()},a.openLightBox=function(e){c.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"cardAction",value:"Edit"}),l.recentlyUsed[e]=!0,U.open(e)},a.flagging=function(e){l.flagged[e]?l.flagged[e]&&(c.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"cardAction",value:"Unflag"}),l.flagged[e]=!l.flagged[e],scheduler.updateEvent(e)):(c.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"cardAction",value:"Flag"}),l.flagged[e]=!0,scheduler.updateEvent(e))},a.showOnGantt=function(e){c.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"cardAction",value:"showOnGantt"});var t=!(l.recentlyUsed[e.id]=!0);e&&((e=b.verifyShowSaOnGantt(e))?l.recentlyUsed[e.id]=!0:t=!0),t||!scheduler._events[e.id]?alert(customLabels.location_not_loaded):"none"===$("#GanttMapContainer").css("display")?(s.$broadcast("changeWorkingState","gantt"),d(function(){updateViewDebounced()},20),d(function(){o.showOnGantt(e.id)},120)):o.showOnGantt(e.id)},a.changeStatusToDispatch=function(t){a.invokedActionFor[t]||p.schedulingRunningFor[t]?alert(customLabels.another_operation_running):(c.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"cardAction",value:"Dispatch"}),l.recentlyUsed[t]=!0,a.invokedAction[t]="dispatch",a.invokedActionFor[t]=!0,l.changeStatus([t],e.DISPATCHED).then(function(e){l.drawServicesAndAbsences(e.services),a.invokedAction[t]=null,a.invokedActionFor[t]=!1}).catch(function(e){o.addNotification(customLabels.Service_Appointment_Update_ErrorMsgTitle,e.message)}).finally(function(){a.invokedAction[t]=null,a.invokedActionFor[t]=!1}))},a.showOnMap=function(e){c.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"cardAction",value:"showOnMap"}),s.$broadcast("showServiceOnMap",e)},a.shouldShowQuickActionBtn=function(e,t){return j.shouldShowQuickActionBtn(e,t)},a.bundleSA=function(e){y.Bundle.canInvoke([e])&&(a.invokedActionFor[e.id]?alert(customLabels.another_operation_running):(l.recentlyUsed[e.id]=!0,a.invokedAction[e.id]="bundle",a.invokedActionFor[e.id]=!0,y.Bundle.invoke([e]).then(function(){}).catch(function(e){}).finally(function(){a.invokedAction[e.id]=null,a.invokedActionFor[e.id]=!1})))},a.unbundleSA=function(e){y.Unbundle.canInvoke([e])&&(a.invokedActionFor[e.id]?alert(customLabels.another_operation_running):(l.recentlyUsed[e.id]=!0,a.invokedAction[e.id]="unbundle",a.invokedActionFor[e.id]=!0,y.Unbundle.invoke([e]).then(function(){}).catch(function(e){}).finally(function(){a.invokedAction[e.id]=null,a.invokedActionFor[e.id]=!1})))},["Recent","Flagged","Selected","Gantt filter"]);function Y(){return u.GetUserSettingsProperty("Filters__c")?JSON.parse(u.GetUserSettingsProperty("Filters__c")):[]}function x(){u.SetUserSettingsProperty("Filters__c",JSON.stringify(a.storageFilters))}function P(e){if(a.lastSelectedFilter=e){for(var t=0;t<a.storageFilters.length;t++)a.storageFilters[t].name===e&&(a.filter.advancedFilter=angular.copy(a.storageFilters[t].filter));a.customFilterName=e,a.DisplayComboBowArrow=!0,a.IsCustomFilterReadonly=!0,a.displayNew=!0,a.displayEdit=!0,a.displayDelete=!0}else a.filter.advancedFilter=J(),a.customFilterName="",a.DisplayComboBowArrow=!1,a.IsCustomFilterReadonly=!0,a.displayNew=!0,a.displayEdit=!1,a.displayDelete=!1}function J(){var t={statusCheckboxs:{},minDate:new Date,maxDate:new Date,servicePriority:10,unScheduled:!0,violations:!0,jeopardies:!0,noLocation:!0,locationsCheckboxs:{}};if(0<Object.keys(a.statusTranslations).length)for(var e in a.statusTranslations)t.statusCheckboxs[a.statusTranslations[e]]=!0;else s.$on("gotStatuses",function(){for(var e in a.statusTranslations)t.statusCheckboxs[a.statusTranslations[e]]=!0});for(var n=0;n<a.territories.length;n++){var i=a.territories[n];t.locationsCheckboxs[i.name]=!0}return t}a.isDateSelectionEnabled=function(e){return!(e&&a.matchGantt||!window.useNewFilters&&K.includes(a.filter.selectedFilter)||window.useNewFilters&&"SearchOnServer"==a.filter.selectedFilter||window.useNewFilters&&a.filtersMap&&a.filtersMap[a.filter.selectedFilter]&&K.includes(a.filtersMap[a.filter.selectedFilter].value)||window.useNewFilters&&a.filtersMap&&a.filtersMap[a.filter.selectedFilter].group!=customLabels.Standard_Filters&&a.filtersMap[a.filter.selectedFilter].group!=customLabels.My_Custom_Filters)},a.openDateEndCalendar=function(){a.isDateSelectionEnabled(!0)&&(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"DateStart",date:new Date(a.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(a,function(){a.endDate=e,a.endDate.setHours(23),a.endDate.setMinutes(59),a.endDate.setSeconds(0),a.filter.endDate=a.endDate,a.horizonDateChanged(),a.newFilterChanged()}),scheduler.destroyCalendar()}}))},a.openFullScreen=function(){var e=window.location.search.match(/[&?]fullScreen=(\d)/);e?(e="1"===e[1]?"0":"1",window.location.search=window.location.search.replace(/[&?]fullScreen=\d/,"&fullScreen="+e)):window.location.search+="&fullScreen=1"},a.getSlots=function(e){l.recentlyUsed[e]=!0,"none"===$("#GanttMapContainer").css("display")&&(s.$broadcast("changeWorkingState","gantt"),setTimeout(function(){updateViewDebounced()},20)),a.invokedActionFor[e]||p.schedulingRunningFor[e]?alert(customLabels.another_operation_running):(c.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"cardAction",value:"getCandidates"}),B.get(e))},a.scheduleAndReshuffle=function(i){c.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"cardAction",value:"Reshuffle"}),a.invokedActionFor[i]?alert(customLabels.another_operation_running):(l.recentlyUsed[i]=!0,a.invokedAction[i]="reshuffle",a.invokedActionFor[i]=!0,c.callRemoteAction(RemoteActions.runReshuffle,i,p.selectedPolicyId).then(function(n){h.updateOptimizationRequest(n),g.register("optimizationRequests",function t(e){e.forEach(function(e){e=new OptimizationRequest(e);e.id!==n.Id||"Completed"!==e.status&&"Failed"!==e.status||(a.invokedAction[i]=null,a.invokedActionFor[i]=!1,g.unRegister("optimizationRequests",t))})})},function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message),a.invokedAction[i]=null,a.invokedActionFor[i]=!1}))},a.groupNearby=function(i){a.invokedActionFor[i]?alert(customLabels.another_operation_running):(l.recentlyUsed[i]=!0,a.invokedAction[i]="groupNearby",a.invokedActionFor[i]=!0,c.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"cardAction",value:"groupNearby"}),c.callRemoteAction(RemoteActions.runGroupNearby,i,p.selectedPolicyId).then(function(n){h.updateOptimizationRequest(n),g.register("optimizationRequests",function t(e){e.forEach(function(e){e=new OptimizationRequest(e);e.id!==n.Id||"Completed"!==e.status&&"Failed"!==e.status||(a.invokedAction[i]=null,a.invokedActionFor[i]=!1,g.unRegister("optimizationRequests",t))})})},function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message),a.invokedAction[i]=null,a.invokedActionFor[i]=!1}))},a.autoScheduleService=function(e){a.invokedActionFor[e]||p.schedulingRunningFor[e]?alert(customLabels.another_operation_running):(c.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"cardAction",value:"Schedule/Reschedule"}),l.recentlyUsed[e]=!0,a.invokedAction[e]="schedule",a.invokedActionFor[e]=!0,l.autoScheduleService(e).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),e.mst||l.drawServicesAndAbsences(e.services,e.absences)}).catch(function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)}).finally(function(){a.invokedAction[e]=null,a.invokedActionFor[e]=!1}))},a.$on("autoScheduleServiceFinished",function(e,t){a.invokedAction[t]=null,a.invokedActionFor[t]=!1}),a.openGanttSettings=function(){a.showGanttSettings=!0,o.ganttSettings?a.ganttSettings=o.ganttSettings:(a.ganttSettings.filterCandidates=!0,a.ganttSettings.servicesPerPage=200,a.ganttSettings.backHorizon=14,a.ganttSettings.capacityDuration="Day"),a.ganttSettingDraft=angular.copy(a.ganttSettings),setTimeout(function(){$("#ganttSettingsLightbox").draggable({containment:"document",handle:"#ganttSettingsLightboxHeader"}),$("#ganttSettingsLightbox").children().find("input[type=checkbox]").first().focus()},500)},a.closeSettingsLightbox=function(){a.showGanttSettings=!1,$("#ganttSettingsLightbox").attr("style",""),a.ganttSettingDraft=angular.copy(a.ganttSettings)},a.parseGanttSettingsToUserSetting=function(e){var t={};return t.Gantt_View_Start_Hour__c=e.startHour,t.Gantt_View_Finish_Hour__c=e.finishHour,t.Filter_Candidates__c=e.filterCandidates,t.Services_Per_Page__c=e.servicesPerPage,t.Resource_Row_Height__c=e.resourceRowHeight,t.Scheduling_horizon_limit__c=e.backHorizon,t.View_Capacity_Type__c=e.capacityDuration,t.Load_On_Today__c=e.loadOnToday,t.DefaultLeftPanel__c=e.leftPanel,t.ServiceListColoring__c=e.serviceColoring,t.Absence_Overlap_Height__c=e.absenceOverlapHeight,t},a.saveGanttSettings=function(){void 0===a.ganttSettingDraft.backHorizon?alert(customLabels.backHorizonInvalid):(schedulerConfig.setRowHeights(a.ganttSettingDraft.resourceRowHeight,!0),setCapacityFilter(a.ganttSettingDraft.capacityDuration,!0),window.__gantt.absenceOverlapHeight=a.ganttSettingDraft.absenceOverlapHeight,a.ganttSettings=angular.copy(a.ganttSettingDraft),o.ganttSettings=angular.copy(a.ganttSettingDraft),a.filter.servicesPerPage=parseInt(a.ganttSettings.servicesPerPage),u.SetUserSettingProperties(a.parseGanttSettingsToUserSetting(a.ganttSettings)).then(function(){a.loadServiceAppointmentsToList()}),a.showGanttSettings=!1)},a.$on("keypress",function(e,t){27===t.which&&a.closeSettingsLightbox()}),a.createArray=function(e,t){var n;return"number"!=typeof e||isNaN(e)||"number"!=typeof t||isNaN(t)?[]:(n=Math.floor(e/t),0<e%t&&n++,new Array(n))},a.changePage=function(e){switch(e){case"right":a.filter.totalPages!=a.filter.currentPage&&(a.filter.currentPage=parseInt(a.filter.currentPage)+1,a.filter.currentPage=a.filter.currentPage.toString());break;case"left":1<a.filter.currentPage&&(a.filter.currentPage=parseInt(a.filter.currentPage)-1,a.filter.currentPage=a.filter.currentPage.toString());break;case"first":1<a.filter.currentPage&&(a.filter.currentPage="1");break;case"last":a.filter.totalPages!=a.filter.currentPage&&(a.filter.currentPage=a.filter.totalPages.toString())}},a.hideServiceList=function(){a.showServiceList.show=!1,a.reallyHideList=!0,d(function(){updateViewDebounced(),s.$broadcast("resizeMap",{})},0)},a.$watch("showServiceList.show",function(e,t){e&&(a.reallyHideList=!1)}),a.isDraggable=function(e){return!(!window.__gantt.ignoreReadonlyGantt226&&!window.customPermissions.Enable_Drag_And_Drop||!(e=a.servicesObjects()[e])||scheduler._events[e.id+"_dummy"]||e.resourceId||e.statusCategory!==m.NONE||e.pinned&&preventUpdateOfPinned||b.isActive()&&b.isBundleMember(e))},a.isBeingSavedNow=function(e){return!!scheduler._events[e+"_dummy"]},a.showAdvancedFilterFunc=function(){$("#AdvancedFilteringOptions").css("display","block"),d(function(){$("#SmartPanelContainer").find(".gutter-vertical").hide(),a.showAdvancedFilter=!0},100)},a.hideAdvancedFilterFunc=function(){a.showAdvancedFilter=!1,setTimeout(function(){$("#SmartPanelContainer").find(".gutter-vertical").show(),$("#AdvancedFilteringOptions").css("display","none")},700)},a.removeSpaces=function(e){return e?e.split(" ").join("+"):""},a.filterChanged=function(){var e=Y(),e=function(e,t){for(var n=0;n<t.length;n++)if(t[n].name==e)return t[n].filter;return!1}(a.filter.selectedFilter,e);e?(a.filter.advancedFilter=e,a.customFilterSelected=!0,a.customFilterName=a.filter.selectedFilter):a.customFilterSelected=!1,u.GetUserSettingsProperty("Selected_List_View__c")!==a.filter.selectedFilter&&u.SetUserSettingsProperty("Selected_List_View__c",a.filter.selectedFilter)},a.$on("gotNewResources",function(e,t){a.territories=[];for(var n=t.show,i=0;i<n.length;i++)void 0!==r.territories()[n[i]]&&a.territories.push(r.territories()[n[i]]);a.servicesListVisitedDays={},a.newFilterChanged()}),a.createCustomFilter=function(){a.isEditMode=!1,a.customFilterName="",a.displayCancel=!0,a.IsCustomFilterReadonly=!1,a.DisplayComboBowArrow=!1,a.displayNew=!1,a.displayEdit=!1,a.displaySave=!0,a.displayDelete=!1,a.filter.advancedFilter=J()},a.CancelSaveOrEditCustomFilter=function(){a.displayNew=!0,a.displayEdit=!0,a.DisplayComboBowArrow=!0,a.displaySave=!1,a.displayDelete=!0,a.displayCancel=!1,a.IsCustomFilterReadonly=!0,P(a.lastSelectedFilter)},a.saveCustomFilter=function(){if(0===a.customFilterName.length)alert(customLabels.Please_give_a_name_to_the_custom_filter);else{for(var e=0;e<a.filterOptions.length;e++)if(!a.isEditMode&&a.filterOptions[e].name===a.customFilterName||a.isEditMode&&a.filterOptions[e].name===a.customFilterName&&a.filterOptions[e].name!==a.lastSelectedFilter)return void alert("Please select another name");if(a.displayNew=!0,a.displayEdit=!0,a.DisplayComboBowArrow=!0,a.displaySave=!1,a.displayDelete=!0,a.displayCancel=!1,a.IsCustomFilterReadonly=!0,a.isEditMode){for(var t=0;t<a.storageFilters.length;t++)if(a.storageFilters[t].name===a.lastSelectedFilter){a.storageFilters[t].filter=a.filter.advancedFilter,a.storageFilters[t].name=a.customFilterName,x();for(var n=0;n<a.filterOptions.length;n++)if(a.filterOptions[n].name===a.lastSelectedFilter){a.filterOptions[n].name=a.customFilterName,a.filterOptions[n].value=a.customFilterName;break}a.filter.selectedFilter===a.lastSelectedFilter&&(a.filter.selectedFilter=a.customFilterName);break}}else a.storageFilters.push({name:angular.copy(a.customFilterName),filter:angular.copy(a.filter.advancedFilter)}),a.filterOptions.push({name:angular.copy(a.customFilterName),value:angular.copy(a.customFilterName)}),x(),a.customFilterSelected=!0,a.filter.selectedFilter=a.customFilterName;a.lastSelectedFilter=a.customFilterName}},a.EditCustomFilter=function(){a.isEditMode=!0,a.displayCancel=!0,a.DisplayComboBowArrow=!1,a.displayNew=!1,a.displayEdit=!1,a.displaySave=!0,a.displayDelete=!1,a.IsCustomFilterReadonly=!1,a.DisplayComboBowArrow=!1,a.filter.advancedFilter=angular.copy(a.filter.advancedFilter)},a.deleteCustomFilter=function(){a.IsCustomFilterReadonly=!0,a.DisplayComboBowArrow=!0,a.displayNew=!0,a.displayEdit=!0,a.displaySave=!1,a.displayDelete=!0;for(var e=0;e<a.storageFilters.length;e++)if(a.storageFilters[e].name===a.customFilterName){a.storageFilters.splice(e,1);break}for(var t=a.customFilterName,n=0;n<a.filterOptions.length;n++)a.filterOptions[n].name===t&&a.filterOptions.splice(n,1);x(),a.filter.selectedFilter===a.customFilterName&&(a.filter.selectedFilter=customPermissions.Service_List_Todo?"Todo":"All"),0<a.storageFilters.length?P(a.storageFilters[0].name):P(null)},a.customFilterChanged=function(e){a.customFilterName=e,P(e)},a.showDropdownCustomFilters=function(e){e.stopPropagation(),0<a.storageFilters.length&&(a.showCustomFilterDropdown=!a.showCustomFilterDropdown)},a.toggleStatus=function(e,t){a.IsCustomFilterReadonly||(a.filter.advancedFilter.statusCheckboxs[t]=!a.filter.advancedFilter.statusCheckboxs[t])},a.toggleLocation=function(e){a.IsCustomFilterReadonly||(e?a.filter.advancedFilter.locationsCheckboxs[e]=!a.filter.advancedFilter.locationsCheckboxs[e]:a.filter.advancedFilter.noLocation=!a.filter.advancedFilter.noLocation)},a.clearRecentlyViewed=function(){for(var e in l.recentlyUsed)delete l.recentlyUsed[e]},a.openLocationFiltering=function(){LeftLocationFilteringService.open()},a.getStyleForServiceInList=function(e){return window.paletteViewActive&&e.ganttPaletteColor?{background:e.ganttPaletteColor.color}:{background:e.ganttColor}};var X=null,Q=_.debounce(function(){var e=i("servicesListFilter"),t=i("pagination"),n=e(a.servicesObjects(),a.filter,a.getColumnsToDisplay(),a.filtersMap);X===n.checksum&&!__gantt.inday.isInDayRunning||(X=n.checksum,o.safeApply(a,function(){a.filteredServices.servicesArray=t(n,a.filter.currentPage,a.filter.servicesPerPage)}))},400,{maxWait:2e3}),ee=(a.getServiceListFilter=function(){return Q(),a.filteredServices.servicesArray},a.searchServiceByIdOrName=function(e){a.notFoundOnServer=!1,l.searchServiceByIdOrName(e).then(function(e){var t,n;e?(w.isPushServiceActive()&&w.updateSession({services:[e],operation:w.MESSAGE_OPERATIONS.UPDATE}),"Always"===window.__gantt.checkRulesMode&&l.checkRules([e]).then(l.drawViolationsOnGantt),a.filter.searchOnServer=e,t=a.filterOptions.find(function(e){return"SearchOnServer"===e.Id}),n={Name:customLabels.searchOnServer,name:customLabels.searchOnServer,old:!0,Id:"SearchOnServer",value:"SearchOnServer",group:customLabels.Standard_Filters},t||a.filterOptions.push(n),a.filter.lastSelectedFilter=a.filter.selectedFilter,a.filter.selectedFilter="SearchOnServer",a.groupedFilters.forEach(function(e){e.groupName!==customLabels.Standard_Filters||t||e.groupFilters.push(n)})):a.notFoundOnServer=!0}).catch(function(e){console.warn(e)})},a.addFilterFromCopilot=function(e,t){a.filter.selectedFilter.includes("copilotSummaryFilter")&&(a.filter.selectedFilter="All"),a.filter.platformEventFilters=a.filter.platformEventFilters||{},a.filter.platformEventFilters[t.Id]=e,a.filterOptions.push(t),a.filtersMap[t.Id]=t,a.groupedFilters.forEach(function(e){e.groupName===t.group&&e.groupFilters.push(t)})},a.platformEventFiltersIdsCounter=0,a.createFiltersForSummary=function(e){var t=r.allTerritories,n=[],i="";e.forEach(function(e){e=t[e];e&&n.push(e.name)}),1<n.length?i=n.slice(0,-1).join(", ")+(" "+customLabels.and)+" "+n[n.length-1]:1===n.length&&(i=n[0]),c.callRemoteAction(RemoteActions.getDataForCopilotSummary,n).then(function(t){var e;t&&(e=ee(t,i),a.copilotSummaryFiltersCache={},function(){var e,t,n=customLabels.My_Copilot_Summaries;if(a.filter.platformEventFilters)for(var i in a.filter.platformEventFilters)a.filter.platformEventFilters.hasOwnProperty(i)&&(e=a.filtersMap[i])&&e.group===n&&delete a.filter.platformEventFilters[i];for(t in a.filterOptions=a.filterOptions.filter(function(e){return e.group!==n}),a.filtersMap)a.filtersMap.hasOwnProperty(t)&&a.filtersMap[t].group===n&&delete a.filtersMap[t];a.groupedFilters.forEach(function(e){e.groupName===n&&(e.groupFilters=[])})}(),e.forEach(function(e){a.copilotSummaryFiltersCache[e.Id]=!1,a.addFilterFromCopilot(t[e.reportName],e)}),0<e.length)&&o.addNotification(customLabels.Summary_Notification_Title,customLabels.Summary_Notification_Content,null,null)}).catch(function(e){return console.log(e.message)})},function(e,t){var n,i,s,r,o=[];for(n in e)e.hasOwnProperty(n)&&0<e[n].length&&(i=new Date,i=new Intl.DateTimeFormat(jsUserLocale,{hour:"2-digit",minute:"2-digit",timeZone:userTimeZone}).format(i).split(":"),r=(i=_slicedToArray(i,2))[0],i=i[1],s="copilotSummaryFilter_"+a.platformEventFiltersIdsCounter++,r=customLabels.Copilot_Summary_Description.replace("{0}",r).replace("{1}",i).replace("{2}",t),o.push({Name:"Summary: "+n,name:"Summary: "+n,Id:s,value:s,CreatedById:userId,group:customLabels.My_Copilot_Summaries,Description:r,reportName:n}));return o}),te=(a.createFilterFromPlatformEvent=function(e,n,t,i){a.loadingServicesToList=1;var s=customLabels.My_Copilot_Searches,r=void 0,o=void 0,o=t!==a.serviceQueryCategory?(e.length>maxServicesToLoadGeneralPlatformEventFilter&&(e=e.slice(0,maxServicesToLoadGeneralPlatformEventFilter)),s=customLabels.My_Custom_Filters,r=i,"customSearchFilter_"+a.platformEventFiltersIdsCounter++):(t=new Intl.DateTimeFormat(jsUserLocale,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",timeZone:userTimeZone}).format(new Date),r=customLabels.Copilot_Search+" "+t,"copilotSearchFilter_"+a.platformEventFiltersIdsCounter++);l.getServicesById(e).then(function(e){var t={Name:r,name:r,Id:o,value:o,CreatedById:userId,group:s,Description:n};a.addFilterFromCopilot(e,t),a.filter.selectedFilter=t.Id,a.loadingServicesToList=0})},a.cometdConnection=null,a.$on("copilotInit",function(e,t){t=t,useNewFilters&&!a.cometdConnection&&($.cometd.configure({url:window.location.protocol+"//"+window.location.hostname+(null!=window.location.port?":"+window.location.port:"")+"/cometd/61.0/",requestHeaders:{Authorization:"OAuth "+sessionId}}),t&&$.cometd.handshake(),$.cometd.addListener("/meta/handshake",function(e){e.successful?(a.cometdConnection=e,e="/event/"+window.fslNamespace+"__CreateFilterEvent__e",$.cometd.subscribe(e,function(e){if(window.userId==e.data.payload.CreatedById)try{var t,n=e.data.payload[window.fslNamespace+"__TerritoryIds__c"]?JSON.parse(e.data.payload[window.fslNamespace+"__TerritoryIds__c"]):[],i=e.data.payload[window.fslNamespace+"__ServiceApptIds__c"]?JSON.parse(e.data.payload[window.fslNamespace+"__ServiceApptIds__c"]):[],s=e.data.payload[window.fslNamespace+"__Description__c"]||null,r=e.data.payload[window.fslNamespace+"__FilterCategory__c"],o=e.data.payload[window.fslNamespace+"__FilterName__c"];r===a.schedulingIssuesCategory?a.createFiltersForSummary(n):r===a.serviceQueryCategory?(t=customLabels.Copilot_Search_Filter_Description+" "+s,"select"===s.split(" ")[0].toLowerCase()&&(t=a.defaultFilterDescription),a.createFilterFromPlatformEvent(i,t,r)):"GENERAL"===r&&a.createFilterFromPlatformEvent(i,s,r,o)}catch(e){console.log(e.message)}})):console.error("Unable to connect to channel.")}))}),a.resetSearchText=function(){a.notFoundOnServer=null,a.filter.SearchText="","SearchOnServer"===a.filter.selectedFilter&&(a.filter.selectedFilter=a.filter.lastSelectedFilter,"SearchOnServer"===a.filterOptions[a.filterOptions.length-1].Id)&&(a.filterOptions.pop(),a.groupedFilters.forEach(function(e){e.groupName===customLabels.Standard_Filters&&e.groupFilters.pop()}))},a.saveSettingsOfHorizonDates=function(){te()},_.debounce(function(){u.SetUserSettingsProperty("Date_Horizon_Properties__c",JSON.stringify(a.filter.selectedFiled))},800));function ne(e){switch(e){case m.NONE:return"#a5e2d6";case m.SCHEDULED:return"#F9D058";case m.DISPATCHED:return"#8DD8FA";case m.IN_PROGRESS:return"#D68EF9";case m.COMPLETED:return"#95d155";case m.COULD_NOT_COMPLETE:return"#f58556";case m.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}}a.customActions=[],o.customActionsPromise.then(function(){var e,t=o.getCustomActions("list");(e=a.customActions).push.apply(e,_toConsumableArray(t))}),a.runCustomServiceAction=function(e,t){var n,e=parseInt($(e.currentTarget).attr("actionId")),t=[t],i=o.getCustomActions("list")[e];i.visualforce?(e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),n=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===t.length?f.open(i.name,i.visualforce+"?id="+t[0]+"&start="+e+"&end="+n):f.open(i.name,i.visualforce+"?services="+t.join(",")+"&start="+e+"&end="+n)):c.callRemoteAction(RemoteActions.runCustomServiceAction,i.className,t,scheduler._min_date,scheduler._max_date).then(function(e){h.updateGantt(),e&&o.addNotification(i.name,e,null,null)}).catch(function(e){return o.addNotification(i.name,e.message,null,null)})},a.showTerritoriesFiltering=function(){S.open()},a.getStyleForServiceItem=function(e){var t,n={};return e.violations||e.jeopardy||("gradient"===a.ganttSettings.serviceColoring&&(window.paletteViewActive&&e.ganttPaletteColor?n.background="linear-gradient(to right, "+e.ganttPaletteColor.color+" -85%,#ffffff 65%)":e.ganttColor?n.background="linear-gradient(to right, "+e.ganttColor+" -85%,#ffffff 65%)":(t=ne(e.statusCategory),n.background="linear-gradient(to right, "+t+" -85%,#ffffff 65%)")),"full"===a.ganttSettings.serviceColoring&&"full"===a.ganttSettings.serviceColoring&&(window.paletteViewActive&&e.ganttPaletteColor?n.background=e.ganttPaletteColor.color+"70":e.ganttColor?n.background=e.ganttColor+"70":(t=ne(e.statusCategory),n.background=t+"70"))),n},a.isRelatedService=function(e){e=t.serviceAppointments()[e.id];return e&&(e.relatedFather||e.relatedTo||e.isServiceInChain)},a.highlightOnGantt=function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];window.__servicesInFilter={applied:e},e&&(i("servicesListFilter")(a.servicesObjects(),a.filter,a.getColumnsToDisplay(),a.filtersMap).forEach(function(e){return window.__servicesInFilter[e.id]=!0}),c.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"highlightServices",value:"true"})),updateViewDebounced()},a.shouldShowClearHighlight=function(){return!!window.__servicesInFilter&&window.__servicesInFilter.applied},a.changeToSelectedServiceList=function(){a.selectorService.countSelectedServices()&&o.hasCustomPermission("Service_List_Selected")&&(a.filter.selectedFilter="Selected")},a.getSelectedClickableClass=function(){return a.selectorService.countSelectedServices()&&o.hasCustomPermission("Service_List_Selected")?"list-selected-blue":""},a.clearSelectedServices=function(){n.unselectAll()},a.openLightboxLabel=function(){return window.__gantt.editOnServiceAppointment?customLabels.Edit:customLabels.Details},a.openLightboxIcon=function(){return window.__gantt.editOnServiceAppointment?lsdIcons.edit:lsdIcons.info},a.searchTermChanges=function(){a.notFoundOnServer=null,"SearchOnServer"===a.filter.selectedFilter&&""===a.filter.SearchText&&a.resetSearchText()},a.isLoadingNewLocations=function(){return p.isLoadingNewLocations}}]),angular.module("serviceExpert").controller("serviceExpertToastCtrl",["$scope","$timeout",function(n,e){n.modes=["SUCCESS","ERROR","INFO"];n.showTast=!1,n.mode="SUCCESS",n.data={},n.data.renderToast=!1,n.getStatusCssClass=function(){switch(n.mode){case"SUCCESS":return"slds-theme_success";case"ERROR":return"slds-theme_error";case"INFO":return"slds-theme_info"}return"slds-theme_info"},n.startAnimation=function(){e(function(){n.showTast=!0},10)},n.stopAnimation=function(){e(function(){n.showTast=!1},3e3)},n.removeToast=function(){e(function(){n.data.renderToast=!1},4e3)},n.render=function(){n.data.renderToast=!0,n.startAnimation(),n.stopAnimation(),n.removeToast()},n.calFunc=function(){e(function(){n.f&&n.p&&(n.f(n.p),n.f=null)},1500)},n.$on("showServiceExpertToast",function(e,t){n.message=t&&t.message?t.message:"",n.mode=t.status&&-1!=n.modes.indexOf(t.status)?t.status:"INFO",n.f=t.f||!1,n.p=t.p||!1,n.render()})}]),angular.module("serviceExpert").filter("ampmOr24",function(){return function(e,t,n){var i=parseInt(e),n=n?":00":"";return"ampm"==t?12===e?"12PM":0===e||24===e?"12AM":12<i?i-12+"PM":i+"AM":"24"==t?i<10?"0"+i+n:i+n:e}}),angular.module("serviceExpert").filter("displayFieldSetField",["utils","$filter",function(i,s){return function(e,t){if(e&&t){var n=e[t.APIName];if(n)if("Status"===t.APIName)n=i.statusTranslations[e.status]||e.status;else switch(t.Type){case i.fieldsTypes.DateTime:n=s("amDateFormat")(n,"l LT");break;case i.fieldsTypes.Date:n=s("amDateFormat")(n,"L");break;case i.fieldsTypes.Currency:n=s("currency")(n,defaultCurrency);break;case i.fieldsTypes.Picklist:n=e.fields[t.TranslatedToLabel]||n}return n=null==n?void 0:n}}}]).filter("displayReportField",["utils","$filter",function(e,n){return function(e){if(e){var t=e.Label;switch(e.Type){case"DATETIME_DATA":t=n("amDateFormat")(t,"l LT");break;case"DATE_DATA":t=n("amDateFormat")(t,"L")}return t=null==t?void 0:t}}}]),angular.module("serviceExpert").filter("orderObjectBy",function(){return function(e,n,t){var i=[];return angular.forEach(e,function(e){i.push(e)}),i.sort(function(e,t){return e[n]>t[n]?1:-1}),t&&i.reverse(),i}}),angular.module("serviceExpert").filter("pagination",["servicesService",function(r){return function(e,t,n){r.filter.totalServices=e.length,(null==r.filter.currentPage||parseInt(r.filter.currentPage)>r.filter.totalPages)&&(r.filter.currentPage="1",t=1);var i=[],s=(t-1)*n,t=(t-1)*n+n,i=e.length<=n?e:e.slice(s,t);return e.length==r.filter.servicesPerPage?r.filter.totalPages=1:(r.filter.totalPages=Math.floor(e.length/r.filter.servicesPerPage),0<e.length%r.filter.servicesPerPage&&r.filter.totalPages++),r.filter.firstVisibleService=1+s,r.filter.lastVisibleService=t,(e.length<=n||e.length<t)&&(r.filter.lastVisibleService=e.length),i}}]),angular.module("serviceExpert").filter("replaceLabels",function(){return function(e){for(var t=e,n=arguments.length,i=Array(1<n?n-1:0),s=1;s<n;s++)i[s-1]=arguments[s];for(var r=0;r<i.length;r++)t=t.replace("$"+r,i[r]);return t}});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}angular.module("serviceExpert").filter("servicesListFilter",["utils","$filter","servicesService","userSettingsManager","ServiceSelectorService","SERVICE_STATUS","SERVICE_CATEGORY","BundleService","ResourcesAndTerritoriesService",function(A,I,C,k,D,e,R,F,t){return function(t,e,n,i){var s,r=function(e,t){var n,i,s,r,o=Object.keys(e).length.toString();for(n in t)"object"!==_typeof(t[n])&&("boolean"==typeof t[n]?o+=t[n]?"1":"0":o+=t[n].toString());for(i in o+=t.endDate.getTime(),t.selectedFiled)o+=t.selectedFiled[i]?"1":"0";for(s in t.advancedFilter.selectedFiled)o+=t.advancedFilter.selectedFiled[s]?"1":"0";for(r in t.advancedFilter.statusCheckboxs)o+=t.advancedFilter.statusCheckboxs[r]?"1":"0";return o=(o=(o=(o=(o=(o+=t.advancedFilter.minDate.toString())+t.advancedFilter.maxDate.toString())+t.advancedFilter.servicePriority)+(t.advancedFilter.jeopardies?"1":"0"))+(t.advancedFilter.unScheduled?"1":"0"))+(t.advancedFilter.violations?"1":"0")}(t,e),o={};if("SearchOnServer"===e.selectedFilter)return a=t[e.searchOnServer]?[t[e.searchOnServer]]:[],s=0,a.forEach(function(e){return s+=e.totalModifiedTimes}),a.checksum+=s.toString(),a;e.isPlatformEventFilter&&e.platformEventFilters[e.selectedFilter].forEach(function(e){t[e]&&(o[e]=t[e])});var a=i&&i[e.selectedFilter]&&i[e.selectedFilter].old;if(useNewFilters&&!a)return i=e.isPlatformEventFilter?o:t,(a=I("servicesListFilterNew")(i,e,n)).checksum=r+a.totalChecksum.toString(),a;var l,c=[],d=new Date(e.endDate),u=A.addDaysToDate(d,-A.ganttSettings.backHorizon),p=scheduler.getState().min_date,m=scheduler.getState().max_date,h=function(e){if(null!=k.GetUserSettingsProperty("Filters__c"))for(var t="object"===_typeof(k.GetUserSettingsProperty("Filters__c"))?k.GetUserSettingsProperty("Filters__c"):JSON.parse(k.GetUserSettingsProperty("Filters__c")),n=0;n<t.length;n++)if(t[n].name===e)return t[n].filter;return null}(e.selectedFilter),i=null,g=[],v=(-1<e.SearchText.indexOf(",")&&""===(i=e.SearchText.replace(/, /g,",").split(","))[i.length-1]&&i.length--,i?g=i:g.push(e.SearchText),0),f=k.GetUserSettingsProperty("Show_Orphan_Services__c"),S=k.GetUserSettingsProperty("locations")||[];for(l in t)if(t[l]instanceof GanttService&&!A.shouldFilterServiceFromList(t[l],S,f))for(var _=0;_<g.length;_++){var b=function(e,t,n){{if(e.name&&-1!=e.name.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.ganttLabel&&-1!=e.ganttLabel.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.accountName&&-1!==e.accountName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.resourceName&&-1!==e.resourceName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(18==t.length&&e.id&&e.id.toLowerCase()==t.toLowerCase())return!0;if(e.serviceTerritoryName&&-1!==e.serviceTerritoryName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(A.statusTranslations[e.status]&&-1!==A.statusTranslations[e.status].toLowerCase().indexOf(t.toLowerCase()))return!0}for(var i=0;i<n.length;i++){var s=n[i].Type,r=e[n[i].APIName]?e[n[i].APIName].toString():null;if((s===A.fieldsTypes.String||s===A.fieldsTypes.TextArea||s===A.fieldsTypes.Reference||s===A.fieldsTypes.Picklist||s===A.fieldsTypes.Double)&&r&&-1!==r.toLowerCase().indexOf(t.toLowerCase()))return!0}return!1}(t[l],g[_],n),y=function(e,t,n,i){i=new Date(i);{if(void 0!==t.earlyStart&&t.earlyStart&&e.earlyStart&&e.earlyStart>n&&e.earlyStart<=i)return!0;if(void 0!==t.dueDate&&t.dueDate&&e.dueDate&&e.dueDate>n&&e.dueDate<=i)return!0;if(void 0!==t.appStart&&t.appStart&&e.appStart&&e.appStart>n&&e.appStart<=i)return!0;if(void 0!==t.appEnd&&t.appEnd&&e.appEnd&&e.appEnd>n&&e.appEnd<=i)return!0;if(void 0!==t.finish&&t.finish&&e.finish&&e.finish>n&&e.finish<=i)return!0;if(void 0!==t.start&&t.start&&e.start&&e.start>n&&e.start<=i)return!0;if(void 0!==t.display&&t.display&&e.ganttDisplay&&e.ganttDisplay>n&&e.ganttDisplay<=i)return!0}return!1}(t[l],e.selectedFiled,u,d);if("Selected"===e.selectedFilter){if(D.SelectedServices[l]&&D.SelectedServices[l]&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}else if("Flagged"===e.selectedFilter&&b){if(C.flagged[l]){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}else if("Recent"===e.selectedFilter&&b){if(C.recentlyUsed[l]){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}else if("Todo"===e.selectedFilter){if((t[l].statusCategory===R.NONE||t[l].violations||t[l].jeopardy)&&t[l].statusCategory!==R.CANCELED&&t[l].statusCategory!==R.COMPLETED&&y){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}else if("All"===e.selectedFilter){if(y){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}else if("Unscheduled"===e.selectedFilter){if(!t[l].resource&&t[l].statusCategory!=R.CANCELED&&y){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}else if("Violating"===e.selectedFilter){if(t[l].violations&&t[l].statusCategory!=R.CANCELED&&y){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}else if("inJeopardy"===e.selectedFilter){if(t[l].jeopardy&&t[l].statusCategory!=R.CANCELED&&y){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}else if("Scheduled"===e.selectedFilter){if(t[l].resource&&y){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}else if("Gantt filter"===e.selectedFilter){if(t[l].resource&&t[l].start<=m&&t[l].finish>=p){var w,T,L=!0;if("LongView"===scheduler._mode&&(w=(t[l].finish-t[l].start)/1e3/60/60,L=window.__currentViewOptions.showMdt?(T=0===window.mdtBooleanField.indexOf("FSL__")?window.mdtBooleanField.substr(5,window.mdtBooleanField.length-5):window.mdtBooleanField,w>=window.__currentViewOptions.minServiceDuration&&t[l].fields[T]):w>=window.__currentViewOptions.minServiceDuration),1<g[_].length&&b&&L){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1&&L){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}else if("Contractors filter"===e.selectedFilter){if(t[l].resourceContractor&&y){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}else if("Cancelled filter"===e.selectedFilter){if(t[l].statusCategory===R.CANCELED&&y){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}else if("Crews filter"===e.selectedFilter){if(t[l].isAssignToCrew){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}else if(void 0!==t[l].parentFields.MinimumCrewSize||void 0!==t[l].parentFields.RecommendedCrewSize){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}else if("Exclude Bundle Members"===e.selectedFilter){if(!F.isBundleMember(t[l])&&y){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}else if(h&&h.statusCheckboxs[statusTranslations[t[l].status]]&&function(e,t,n){var i,s=new Date(e.minDate),r=new Date(e.maxDate);for(i in s.setHours(0),s.setMinutes(0),r.setDate(r.getDate()+1),r.setHours(0),r.setMinutes(0),t)if(t[i]&&function(e,t,n,i){return void 0!==e[t]&&n<=e[t]&&e[t]<=i}(n,i,s,r))return 1;return}(h,e.selectedFiled,t[l])&&(T=t[l],w=h.servicePriority,T.priority<=w)&&(L=h,!((y=t[l]).jeopardy&&!L.jeopardies||y.violations&&!L.violations||null===y.start_date&&!L.unScheduled))&&function(e,t,n){if(n&&!e.location)return 1;for(var i in t)if(e.serviceTerritoryName===i&&t[i])return 1;return}(t[l],h.locationsCheckboxs,h.noLocation)){if(1<g[_].length&&b){v+=t[l].totalModifiedTimes,c.push(t[l]);break}if(g[_].length<=1){v+=t[l].totalModifiedTimes,c.push(t[l]);break}}}a=I("orderBy")(c,e.orderByField,e.reverse);return a.checksum=r+v.toString(),a}}]),!function(){function e(B,$,H,V,e,U,z,j,W,q,Z,t,K,n,i,Y){var J=(new Date).getTime();return setInterval(function(){return J+=6e4},6e4),i.register("positions",function(e){var t,n=H.getResources();for(t in e)n[t]&&(n[t].lastKnownLongitude=e[t].longitude,n[t].lastKnownLocationDate=e[t].lastModifiedDate.getTime()-1e3*e[t].lastModifiedDate.getTimezoneOffset()*60,n[t].lastKnownLatitude=e[t].latitude)}),function(P,e,t,n,i,s,r){var o=[],a={},l=[],c=e.replace(/, /g,",").split(","),d=V.resourcesAndTerritories(),u=V.resourceToServiceCrewMembers(),e=V.isOptimizationViewer()?Object.values(H.territories()):$.getTerritoriesSortedByTree(),p=V.isOptimizationViewer()?Object.keys(H.territories()):j.GetUserSettingsProperty("locations");if(__gantt.inday.isInDayRunning=!1,(e=e.filter(function(t){return p.find(function(e){return e===t.id})})).forEach(function(e){o.push(new Q(e,H.getOperatingHours()[e.operatingHours],q)),a[e.id]=o.length-1}),t)for(var m in n)n[m]&&l.push(m);var h,g=B.ganttSettings&&B.ganttSettings.filterCandidates;for(h in d){var v=d[h],f=H.getResources()[h];if(f&&(function(e,t){if(0===t.length)return 1;for(var n=0;n<t.length;n++)if(-1<e.toLowerCase().indexOf(t[n].toLowerCase()))return 1;return}(f.name,c)&&(!("and"===i&&0<l.length&&t)||U.doesHaveSkills(h,l,scheduler._min_date,scheduler._max_date))&&(!("or"===i&&0<l.length&&t)||U.doesHaveSomeSkills(h,l,scheduler._min_date,scheduler._max_date)))){var S,_=!1;for(S in r.resourceFilteringOptions)if(r.resourceFilteringOptions[S]&&!f.sobject[S]){_=!0;break}if(!_){if("select_a_field"!==r.selectedPicklist){if(0<r.picklistOptions.length&&-1===r.picklistOptions.indexOf(f.sobject[r.selectedPicklist])){if(!r.picklistNullValues)continue;if(void 0!==f.sobject[r.selectedPicklist])continue}if(0===r.picklistOptions.length&&r.picklistNullValues&&void 0!==f.sobject[r.selectedPicklist])continue}if(V.isCrewViewActive){var b=V.currentCrewToShow;if(void 0===b[h])continue;if(void 0!==b[h].members){var y,w=!1;for(y in b[h].members){var T,L,A=b[h].members[y].serviceCrew===V.selectedCrewIdToShow;if(useLocationTimezone)for(var I in v)X(scheduler._min_date,scheduler._max_date,v[I].effectiveStartDate,v[I].effectiveEndDate)&&(T=B.convertDateBetweenTimeZones(b[h].members[y].startDate,"GMT",v[I].timezone),L=B.convertDateBetweenTimeZones(b[h].members[y].endDate,"GMT",v[I].timezone),X(scheduler._min_date,scheduler._max_date,T,L))&&A&&(w=!0);else T=B.convertDateBetweenTimeZones(b[h].members[y].startDate,"GMT",userTimeZone),L=B.convertDateBetweenTimeZones(b[h].members[y].endDate,"GMT",userTimeZone),X(scheduler._min_date,scheduler._max_date,T,L)&&A&&(w=!0)}if(!1===w)continue}}if(r.crewsSelectionOptions.selectedPicklist!==customLabels.showAll){if(B.crewsFilter=!0,r.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewMembers){if("C"!==f.sobject.ResourceType){var C,k=!1;for(C in u[h])X(scheduler._min_date,scheduler._max_date,u[h][C].tzStartDate,u[h][C].tzEndDate)&&(k=!0);if(!0===k)continue}}else if(r.crewsSelectionOptions.selectedPicklist===customLabels.showCrewsAndCrewMembers){if("C"!==f.sobject.ResourceType){var D,R=!1;for(D in u[h])X(scheduler._min_date,scheduler._max_date,u[h][D].tzStartDate,u[h][D].tzEndDate)&&(R=!0);if(!0!==R)continue}}else if(r.crewsSelectionOptions.selectedPicklist===customLabels.showOnlyCrews){if("C"!==f.sobject.ResourceType)continue}else if(r.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewsAndCrewMembers){if("C"===f.sobject.ResourceType)continue;var F,O=!1;for(F in u[h])X(scheduler._min_date,scheduler._max_date,u[h][F].tzStartDate,u[h][F].tzEndDate)&&(O=!0);if(!0===O)continue}}else B.crewsFilter=!1;if(!g||!W.getCandidatesIds()||W.getCandidatesIds()[h])for(var M in v){var E=B.generateResourceId(v[M].serviceResource,v[M].serviceTerritory);s.showWorkingResource&&!function(e,t,n){var i=new Date(scheduler._min_date),s=t.resourceToWorkingDates[e];if(s)for(;i<scheduler._max_date;){var r=s[n.formatDayToString(i)];if(r&&(0<r.regular||0<r.overtime))return 1;i.setDate(i.getDate()+1)}return}(E,z,B)||p&&-1==p.indexOf(v[M].serviceTerritory)||X(scheduler._min_date,scheduler._max_date,v[M].effectiveStartDate,v[M].effectiveEndDate)&&(E=o[a[v[M].serviceTerritory]],M=new ee(B.generateResourceId,c,H.getResources()[v[M].serviceResource],v[M].serviceTerritory,function(e){if(!window.customPermissions.Hide_Gantt_Last_Seen_Indicator&&!isLastKnownFieldsNotAllowed){if(e.lastKnownLocationDate&&e.onlineOffset){var t=moment(J).tz(window.userTimeZone)._offset;if(e.lastSeen=parseInt((J-e.lastKnownLocationDate)/1e3/60+t),e.lastKnownLocationDate+60*(e.onlineOffset-t)*1e3>J&&0<=e.lastSeen)return e.online=!0}e.online=!1}return!1}(H.getResources()[v[M].serviceResource]),!1,"S"===v[M].serviceTerritoryType,K,q),E)&&-1===E.children.map(function(e){return e.key}).indexOf(M.key)&&E.children.push(M)}}}}var x=[],N=0;return o.forEach(function(e,t){return 0===e.children.length&&x.push(t)}),x.forEach(function(e){return o.splice(e-N++,1)}),o.forEach(function(e){e.children.sort(G);var t=Y.isTerritoryHasInDayOptimizationInProgress(scheduler._min_date,scheduler._max_date,e.key);t&&(__gantt.inday.isInDayRunning=!0,e.addInDayOptimizationInProgress(t,Y.calculateIndayProgress,H.allTerritories[e.key].o2Enabled))}),B.hasCustomPermission("Utilization_on_Service_Territory")&&showDailyUtilization&&"MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode&&"LongView"!==scheduler._mode&&o.forEach(function(e){for(var t=[],n=new Date(scheduler._min_date);n<scheduler._max_date;n.setDate(n.getDate()+1))t.push(K.calculateLocation(e.children,n));var i=t.reduce(function(e,t){return e.break+=t.break,e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{break:0,capacity:0,overtime:0,service:0,travel:0,na:0}),i=K.calculateLocationUtilization(i);e.addUtilizationHtml(i)}),o;function G(e,t){var e=H.getResources()[e.resourceId].sobject[Z.resourceFieldToSortyBy],t=H.getResources()[t.resourceId].sobject[Z.resourceFieldToSortyBy],n=Z.descending?1:-1;return void 0===e&&void 0===t?0:void 0===e&&void 0!==t?-1*n:void 0!==e&&void 0===t||t<e?n:e<t?-1*n:0}}}function X(e,t,n,i){return isIntersect(e,t,n,i)}function Q(e,t,n){this.key=e.id,this.name=e.name,this.children=[],this.generateHtml(e,t.timezone),void 0===n.ganttOpenedTerritories[e.id]&&(n.ganttOpenedTerritories[e.id]=!0),this.open=n.ganttOpenedTerritories[e.id]}angular.module("serviceExpert").filter("timelineFilter",e),e.$inject=["utils","LeftSideLocationFilteringService","ResourcesAndTerritoriesService","TimePhasedDataService","ResourceCrewsService","SkillsService","calendarsService","userSettingsManager","GetSlotsService","StateService","resourceFilterHelper","LastKnownPositionService","monthlyViewHelperService","DeltaService","RegisterService","OptimizationRequestsService"];function ee(e,t,n,i,s,r,o,a,l){this.key=e(n.id,i),this.resourceId=n.id,this.name=n.name,this.contractor=n.isCapacityBased,this.online=s,this.lastSeen=n.lastSeen,this.secondary=o,this.isUndestaffOrOverstaff=r,this.utilization=null,this.calculatePeriodUtilization(a,n),n.isUndestaffOrOverstaff=r,this.searchResourceNameArray=t,this.generateHtml(n,l.isRtlDirection())}Q.prototype.generateHtml=function(e,t){var n,i,s;e.parentTerritory?this.label='<div class="truncate ParentName" title="'+e.parentTerritory.name.encodeHTML()+'">'+e.parentTerritory.name.encodeHTML()+'</div>\n                          <div class="truncate LocationName" title="'+e.name.encodeHTML()+'">'+e.name.encodeHTML()+"</div>":this.label='<div class="truncate LocationName no-parent-location" title="'+e.name.encodeHTML()+'">'+e.name.encodeHTML()+"</div>","MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode&&(i={timeZone:t,weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"},s=window.jsUserLocale,n=new Date,i=new Intl.DateTimeFormat(s,i).format(n),e=e.parentTerritory?"margin-top:-26px;":"",s=new Intl.DateTimeFormat(s,{timeZone:t,timeZoneName:"long"}).formatToParts(n).find(function(e){return"timeZoneName"===e.type}).value,this.label+="<div class='timeZoneFolder' style=\""+e+'">'+s+" - "+i+"</div>")},Q.prototype.addInDayOptimizationInProgress=function(e,t,n){var i=this.label.indexOf("</div>"),s=customLabels.PreparingData,r={percent:0},t='<div class="left-territory-info-box" >'+('<div class="inDayOptimizationRunningContainer '+(n?"o2InDayBar":"")+'"><span>'+('<div class="inday-opt-progress">\n                            <span class="opt-progress-preparing">'+(s=null!=e.objectToScheduled?(r=t(e)).text:s)+'</span>\n                                <span class="opt-progress-text">'+(n?"":r.percent+"%")+'</span>\n\n                                <div class="opt-progress-bar inday-progress-animation" style="width:'+r.percent+'%">\n                            </div>\n\n                        </div>')+"</span></div>")+"</div>";this.label=this.label.slice(0,i+6)+t+this.label.slice(i+6)},Q.prototype.addUtilizationHtml=function(e){var t=this.label.indexOf("</div>"),n="green-daily-utlz",i=this.label.indexOf("inDayOptimizationRunningContainer"),s=-1==i&&-1<this.label.indexOf("Parent")?'style="margin-top: -9px"':"",r=(e>=monthlyViewSettings.high&&e<monthlyViewSettings.critical?n="yellow-daily-utlz":monthlyViewSettings.critical<=e&&(n="red-daily-utlz"),"");-1<navigator.userAgent.indexOf("rv:11.0")&&(r="dailyViewUtilizationIE"),null!==e&&(n='<b class="'+n+'">'+e+"%</b>",-1<i?(e='<div class="dailyViewUtilization '+r+' utilizationWithInday"><span>'+customLabels.UtilizationDaily.replace("$0",n)+" </span></div>",this.label=this.label.slice(0,i-12)+e+this.label.slice(i-12)):(e='<div class="dailyViewUtilization '+r+'" '+s+"><span>"+customLabels.UtilizationDaily.replace("$0",n)+"</span> </div>",this.label=this.label.slice(0,t+6)+e+this.label.slice(t+6)))},ee.prototype.calculatePeriodUtilization=function(e,t){if("MonthlyView"===scheduler._mode){for(var n=[],i=new Date(scheduler._min_date);i<scheduler._max_date;i.setDate(i.getDate()+1))n.push(e.calculateDailyResourceCapacity(this,i));var s=n.reduce(function(e,t){return e.break+=t.break,e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{break:0,capacity:0,overtime:0,service:0,travel:0,na:0});this.utilization=e.calculateLocationUtilization(s),t.sobject.__Utilization__=this.utilization}},ee.prototype.generateHtml=function(e,t){var n=function(e,t){for(var n=0;n<t.length;n++){var i=t[n],s=e.toLowerCase().indexOf(i.toLowerCase());if(-1!==s)return{beforeMatch:e.substring(0,s),matchedPart:e.substr(s,i.length),afterMatch:e.substring(s+i.length)}}}(e.name,this.searchResourceNameArray),i=(this.label="",this.online?"online-indicator":"online-indicator offline-indicator"),s=scheduler.matrix.ZoomLevel3.dy<33,t=(t&&(i=s?i+" rtl-small-icon-indicator":i+" rtl-big-icon-indicator"),this.secondary?"<span class='secondaryGanttLabel' title=\""+customLabels.Secondary+'">('+customLabels.Secondary+")</span>":""),i=e.lastKnownLocationDate&&this.lastSeen<1440&&0<=this.lastSeen?'<div class="'+i+'" title="'+utils.hoursMinutes(this.lastSeen,customLabels.SeenXMinsHoursAgo,customLabels.SeenXAgoHours,customLabels.SeenXAgo)+'"></div>':"",s=(void 0!==e.serviceCrew__r?(s=s?"SmallResourceCrewPhoto":"ResourceCrewPhoto",r=e.serviceCrew__r[fieldNames.ServiceCrew.GanttColor__c]?'style="background-color: '+e.serviceCrew__r[fieldNames.ServiceCrew.GanttColor__c]+' !important;"':"",this.label+=e.pictureLink?"<img src='"+e.pictureLink+"' title='"+e.description.encodeHTML()+"' class='"+s+"' />":"<span class='"+s+'\'><svg aria-hidden="true" class="crew-slds-icon crewContextMenuIcon" '+r+"><use xlink:href='"+lsdIcons.crew+"'></use></svg></span>",this.label+=i):e.pictureLink?(s=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhoto":"ResourcePhoto",this.label+="<img src='"+e.pictureLink+"' title='"+e.description.encodeHTML()+"' class='"+s+"' />"+i):(r=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhotoDefault":"NormalResourcePhotoDefault",this.label+="<div title='"+e.description.encodeHTML()+"' class=\"ResourcePhotoIcon "+r+'"></div>'+i),this.label+='<div class="resourceMenuBtn">\n                            <svg aria-hidden="true" class="slds-icon resourceMenuIcon">\n                                <use xlink:href="'+lsdIcons.threedots+'"></use>\n                            </svg>\n                        </div>',e.ganttLabel?utils.escapeResourceName(e.ganttLabel):""),r=n.beforeMatch.encodeHTML()+'<span class="resource-highlight-on-search">'+n.matchedPart.encodeHTML()+"</span>"+n.afterMatch.encodeHTML(),i=(utils.escapeResourceName(this.name),utils.escapeResourceName(this.name));e.description&&(i=this.name.encodeHTML()+" - "+e.description.encodeHTML()),"MonthlyView"===scheduler._mode&&null!==this.utilization?(n="resource-utiliz-low",s=customLabels.TotalUtilizationResource,monthlyViewSettings.critical<=this.utilization?n="resource-utiliz-high":monthlyViewSettings.high<=this.utilization&&(n="resource-utiliz-med"),s+=' <span class="'+n+'">'+this.utilization+"%</span>",scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.resourceId+"' class=\"truncate smallResourceNameField\" title='"+i+"'>"+r+" "+t+"\n                    <div class='smallResourceGanttLabel truncate'>"+s+"</div></a>":this.label+="<a resource='"+this.resourceId+"' class='truncate smallResourceName resourceYup' title='"+i+"'>"+r+" "+t+"\n                    <div class='resourceGanttLabel truncate'>"+s+"</div></a>"):e.ganttLabel?scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.resourceId+"' class=\"truncate smallResourceNameField\" title='"+i+"'>"+r+" "+t+"\n                        <div class='smallResourceGanttLabel truncate'>"+s+"</div></a>":this.label+="<a resource='"+this.resourceId+"' class='truncate smallResourceName resourceYup' title='"+i+"'>"+r+" "+t+"\n                        <div class='resourceGanttLabel truncate'>"+s+"</div></a>":scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.resourceId+"' class='truncate smallResourceName resourceYup resource-no-label' style='margin-top:1px;' title='"+i+"'>"+r+" "+t+"</a>":this.label+='<a class="truncate resource-no-label" resource=\''+this.resourceId+"' style='margin-top:1px;' title='"+i+"'>"+r+" "+t+"</a>",this.label='<div class="resourceY-container">'+this.label+"</div>"}}(),angular.module("serviceExpert").filter("toArray",function(){return function(e){var n=[];return angular.forEach(e,function(e,t){n.push(e)}),n}}),!function(){function stringifySingleCondition(e,t,n){return e[getPropertyName(t.property)]||!1===e[getPropertyName(t.property)]||(e[getPropertyName(t.property)]=""),"FSL__RULE_VIOLATIONS__FSL"===t.property?(e="true"===t.value.toString(),"equals"===t.operator&&e||"not equal to"===t.operator&&!e?"(Array.isArray(__evalRealService.violations) && __evalRealService.violations.length > 0)":"(!__evalRealService.violations || (Array.isArray(__evalRealService.violations) && __evalRealService.violations.length === 0))"):(e=evaluateOperator(t.operator),t.value&&t.value.indexOf&&-1<t.value.indexOf(",")&&(t.value=t.value.replace(/, /g,",").split(",").map(function(e){return e.trim()})),Array.isArray(t.value)?(t.value=t.value.map(function(e){return e.toLowerCase?e.toLowerCase():e}),__picklistArrayForFilter[n]=t.value,evaluateArrayValue(t.operator,t.property,n)):(evaluateValue(t.property,t.value,__ganttFilterFieldSet,n),e?"STRING"===(e=__ganttFilterFieldSet[t.property].Type)||"TEXTAREA"===e||"EMAIL"===e||"REFERENCE"===e?"__evalService."+getPropertyName(t.property)+".toLowerCase() "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+n+".toLowerCase()":"__evalService."+getPropertyName(t.property)+" "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+n:evaluateSepcialOperator(t.operator,t.value,t.property,n)))}function evaluateArrayValue(e,t,n){switch(e){case"contains":return"new RegExp(__picklistArrayForFilter["+n+"].join(\"|\").replace(/\\(/g, '\\\\(').replace(/\\)/g, '\\\\)').replace(/\\+/g, '\\\\+'), 'i').test(__evalService."+getPropertyName(t)+") === true";case"does not contain":return"new RegExp(__picklistArrayForFilter["+n+"].join(\"|\").replace(/\\(/g, '\\\\(').replace(/\\)/g, '\\\\)').replace(/\\+/g, '\\\\+'), 'i').test(__evalService."+getPropertyName(t)+") === false";case"start with":return"new RegExp('^' + __picklistArrayForFilter["+n+"].join(\"|^\"), 'i').test(__evalService."+getPropertyName(t)+") === true";case"equals":return"__picklistArrayForFilter["+n+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) > -1";case"not equal to":return"__picklistArrayForFilter["+n+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) === -1";default:return"__picklistArrayForFilter["+n+"].some( element => __evalService."+getPropertyName(t)+" "+evaluateOperator(e)+" element)"}}function getPropertyName(e){return"FSL__RULE_VIOLATIONS__FSL"===e?"FSL__RULE_VIOLATIONS__FSL":removeNamespace(__ganttFilterFieldSet[e].APIName)}function evaluateCondition(service,conditions,logic){var serviceFields=service.fields,stringConditions=(window.__evalService=serviceFields,window.__evalRealService=service,logic?replaceLogicOperators(logic):""),conditionsMapped={},i,_i;for(i in conditions)conditionsMapped[i]=stringifySingleCondition(serviceFields,conditions[i],i-1),logic||(stringConditions+="{"+i.toString()+"} && ");for(_i in logic||(stringConditions=stringConditions.substr(0,stringConditions.length-3)),conditionsMapped)stringConditions=stringConditions.replace("{"+_i+"}",conditionsMapped[_i]);return""===stringConditions?1:eval(stringConditions)}function evaluateValue(e,t,n,i){if(n[e])switch(n[e].Type){case"BOOLEAN":"boolean"==typeof t?window.__evalConditionValue[e+"_"+i]=!0===t:window.__evalConditionValue[e+"_"+i]="true"===t;break;case"DATE":window.__evalConditionValue[e+"_"+i]=new Date(t).setHours(0,0,0,0);break;case"DATETIME":window.__evalConditionValue[e+"_"+i]=new Date(t);break;case"STRING":case"EMAIL":case"TEXTAREA":case"REFERENCE":window.__evalConditionValue[e+"_"+i]=t?t.toLowerCase():"";break;default:window.__evalConditionValue[e+"_"+i]=t}else window.__evalConditionValue[e]=null}function evaluateOperator(e){switch(e){case"equals":return"==";case"not equal to":return"!=";case"less than":return"<";case"greater than":return">";case"less or equal":return"<=";case"greater or equal":return">=";default:return null}}function evaluateSepcialOperator(e,t,n,i){switch(e){case"contains":return t?"__evalService."+getPropertyName(n)+".toLowerCase().indexOf('"+t.toLowerCase().replace(/'/g,"\\'")+"') > -1":"__evalService."+getPropertyName(n)+".toLowerCase() == __evalConditionValue."+n+"_"+i+".toLowerCase()";case"does not contain":return t?"__evalService."+getPropertyName(n)+".toLowerCase().indexOf('"+t.toLowerCase().replace(/'/g,"\\'")+"') === -1":"__evalService."+getPropertyName(n)+".toLowerCase() != __evalConditionValue."+n+"_"+i+".toLowerCase()";case"start with":return t?"__evalService."+getPropertyName(n)+".toLowerCase().indexOf('"+t.toLowerCase().replace(/'/g,"\\'")+"') === 0":"__evalService."+getPropertyName(n)+".toLowerCase() == __evalConditionValue."+n+"_"+i+".toLowerCase()"}}function replaceLogicOperators(e){return e=(e=(e=e.split("AND").join("&&")).split("OR").join("||")).split("NOT").join("!")}function removeNamespace(e){var t;return fslNamespace&&0===e.indexOf(fslNamespace+"__")?(t=fslNamespace.length+2,e.substr(t,e.length-t)):e}function isServiceInDateRange(e,t,n,i){var s=scheduler._min_date,r=scheduler._max_date;return i.List_only_appointments_on_the_gantt?e.end_date&&isIntersectIncludeLimits(s,r,e.end_date,e.end_date)||!(!e.start_date||!isIntersectIncludeLimits(s,r,e.start_date,e.start_date)):(s=new Date(n),r=new Date(n),s.setDate(s.getDate()-i.Days_before_horizon),r.setDate(r.getDate()+i.Days_after_horizon+1),r.setMinutes(r.getMinutes()-1),t.earlyStart&&e.earlyStart&&isIntersectIncludeLimits(s,r,e.earlyStart,e.earlyStart)||t.dueDate&&e.dueDate&&isIntersectIncludeLimits(s,r,e.dueDate,e.dueDate)||t.start&&e.start&&isIntersectIncludeLimits(s,r,e.start,e.start)||t.finish&&e.finish&&isIntersectIncludeLimits(s,r,e.finish,e.finish)||t.appStart&&e.appStart&&isIntersectIncludeLimits(s,r,e.appStart,e.appStart)||t.appEnd&&e.appEnd&&isIntersectIncludeLimits(s,r,e.appEnd,e.appEnd)||!!(t.display&&e.ganttDisplay&&isIntersectIncludeLimits(s,r,e.ganttDisplay,e.ganttDisplay)))}function searchOnService(e,t,n){if(e.name&&-1!==e.name.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.ganttLabel&&-1!==e.ganttLabel.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.accountName&&-1!==e.accountName.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.resourceName&&-1!==e.resourceName.toLowerCase().indexOf(t.toLowerCase()))return 1;if(18==t.length&&e.id&&e.id.toLowerCase()==t.toLowerCase())return 1;if(e.serviceTerritoryName&&-1!==e.serviceTerritoryName.toLowerCase().indexOf(t.toLowerCase()))return 1;if(utils.statusTranslations[e.status]&&-1!==utils.statusTranslations[e.status].toLowerCase().indexOf(t.toLowerCase()))return 1;for(var i=0;i<n.length;i++){var s=n[i].Type,r=e[n[i].APIName]?e[n[i].APIName].toString():null;if((s===utils.fieldsTypes.String||s===utils.fieldsTypes.TextArea||s===utils.fieldsTypes.Reference||s===utils.fieldsTypes.Picklist||s===utils.fieldsTypes.Double)&&r&&-1!==r.toLowerCase().indexOf(t.toLowerCase()))return 1}}window.__ganttFilterFieldSet={},window.__picklistArrayForFilter=[],window.__evalConditionValue={},angular.module("serviceExpert").filter("servicesListFilterNew",["utils","$filter","GanttFilterService","FieldSetFieldsService","userSettingsManager",function(g,v,f,e,S){return e.fieldsSetFields().then(function(e){e.ganttFilter.forEach(function(e){return __ganttFilterFieldSet[e.FullAPIName]=e})}),function(e,t,n){var i=0,s=[],r=t.isPlatformEventFilter?t.selectedFilter:f.getFilterById(t.selectedFilter),o=new Set;if(r){t.isPlatformEventFilter&&t.platformEventFilters[r]&&(o=new Set(t.platformEventFilters[r]));var a,l=null,c=[],d=(-1<t.SearchText.indexOf(",")&&""===(l=t.SearchText.replace(/, /g,",").split(","))[l.length-1]&&l.length--,l?c=l:c.push(t.SearchText),S.GetUserSettingsProperty("Show_Orphan_Services__c")),u=S.GetUserSettingsProperty("locations")||[];for(a in e)if(t.isPlatformEventFilter||!g.shouldFilterServiceFromList(e[a],u,d)){if(t.SearchText){for(var p=!1,m=0;m<c.length;m++)if(searchOnService(e[a],c[m],n)){p=!0,t.isPlatformEventFilter&&o.has(a)&&(s.push(e[a]),i+=e[a].totalModifiedTimes);break}if(!p)continue}else t.isPlatformEventFilter&&o.has(a)&&(s.push(e[a]),i+=e[a].totalModifiedTimes);t.isPlatformEventFilter||(t.pivotDate=new Date(t.endDate),t.pivotDate.setHours(0),t.pivotDate.setMinutes(0),isServiceInDateRange(e[a],t.selectedFiled,t.pivotDate,r)&&evaluateCondition(e[a],r.Criterias,r.Logic)&&(i+=e[a].totalModifiedTimes,s.push(e[a])))}}else for(var h in e)i+=e[h].totalModifiedTimes,s.push(e[h]);l=v("orderBy")(s,t.orderByField,t.reverse);return l.totalChecksum=i,l}}])}(),!function(){function e(){function e(n,s,r,o,a,l,c,d,e,u,p,m,h,t,g){n.bulkActionsOrder=bulkActionsOrder,n.customActions=[],n.actionNames={Schedule:{name:"Schedule",nameLabel:customLabels.Schedule,icon:lsdIcons.calendar},Dispatch:{name:"Dispatch",nameLabel:customLabels.Dispatch,icon:lsdIcons.dispatch},Optimize:{name:"Optimize",nameLabel:customLabels.Optimize,icon:lsdIcons.magicwand},"Flag-Unflag":{name:"Flag-Unflag",nameLabel:customLabels.Flag_Unflag,icon:lsdIcons.flag},Unschedule:{name:"Unschedule",nameLabel:customLabels.Unschedule,icon:lsdIcons.na},"Check Rules":{name:"Check Rules",nameLabel:customLabels.check_rules_action_label,icon:lsdIcons.violation,isAvailable:function(){return window.customPermissions.Enable_Bulk_Check_Rules}},Bundle:{name:"Bundle",nameLabel:h.Bundle.label,icon:h.Bundle.icon,isAvailable:function(){return t.isActive()}},Unbundle:{name:"Unbundle",nameLabel:h.Unbundle.label,icon:h.Unbundle.icon,isAvailable:function(){return t.isActive()}}},r.customActionsPromise.then(function(){var e,t=r.getCustomActions("bulk");(e=n.customActions).push.apply(e,_toConsumableArray(t))}),n.runCustomServiceAction=function(t){var e,n,i=l.getSelected();t.visualforce?(e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),n=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===i.length?p.open(t.name,t.visualforce+"?id="+i[0]+"&start="+e+"&end="+n):p.open(t.name,t.visualforce+"?services="+i.join(",")+"&start="+e+"&end="+n)):0!==i.length&&u.callRemoteAction(RemoteActions.runCustomServiceAction,t.className,i,scheduler._min_date,scheduler._max_date).then(function(e){g.updateGantt(),e&&r.addNotification(t.name,e,null,null)}).catch(function(e){return r.addNotification(t.name,e.message,null,null)})},n.isActionAvailable=function(e){return!n.actionNames[e]||!n.actionNames[e].isAvailable||n.actionNames[e].isAvailable()},n.checkHasCustomPermission=function(e){return null==r.hasCustomPermission("Bulk_"+e)||r.hasCustomPermission("Bulk_"+e)},n.openBulkAction=function(e){switch(e){case"Schedule":d.schedule(l.getSelected());break;case"Dispatch":o.open();break;case"Unschedule":a.open();break;case"Optimize":c.open();break;case"Flag-Unflag":for(var t=l.getSelected(),n=0;n<t.length;n++)s.flagged[t[n]]=!s.flagged[t[n]];u.callRemoteAction(RemoteActions.collectMetricsForSplunk,{feature:"bulkAction",value:"bulkFlagUnflag",count:t.length}),updateViewDebounced();break;case"Check Rules":var i=l.getSelected();0<i.length&&s.checkRules(i).then(s.drawViolationsOnGantt);break;case"Bundle":i=l.getSelected().map(function(e){return m.serviceAppointments()[e]});h.Bundle.invoke(i).then(function(){}).catch(function(e){});break;case"Unbundle":i=l.getSelected().map(function(e){return m.serviceAppointments()[e]});h.Unbundle.invoke(i).then(function(){}).catch(function(e){})}}}return e.$inject=["$scope","servicesService","utils","bulkDispatchService","bulkUnscheduleService","ServiceSelectorService","optimizeLightboxService","bulkScheduleService","rdOptimizeLightboxService","sfdcService","GeneralLightbox","TimePhasedDataService","BundleActions","BundleService","DeltaService"],{restrict:"E",template:'<div id="quickActionsButtons">\n\t\t\t                    <div fsl-key-press tabindex="0" id="actionQuickFirst" class="truncate quickActionBtn" ng-show="bulkActionsOrder.first.length && checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name) && isActionAvailable(actionNames[bulkActionsOrder.first[0].title].name)" ng-click="openBulkAction(bulkActionsOrder.first[0].title)" title="{{actionNames[bulkActionsOrder.first[0].title].nameLabel}}">\n\t\t\t\t\t\t\t\t\t{{actionNames[bulkActionsOrder.first[0].title].nameLabel}}\n\t\t\t\t\t\t\t\t</div>\n\t                        \t<div fsl-key-press tabindex="0" id="actionQuickSecond"\n\t\t\t\t\t\t\t\t\t class="truncate quickActionBtn"\n\t\t\t\t\t\t\t\t\t ng-show="bulkActionsOrder.second.length && checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name) && isActionAvailable(actionNames[bulkActionsOrder.second[0].title].name)"\n\t\t\t\t\t\t\t\t\t ng-click="openBulkAction(bulkActionsOrder.second[0].title)"\n                                     title="{{actionNames[bulkActionsOrder.second[0].title].nameLabel}}">\n                                     {{actionNames[bulkActionsOrder.second[0].title].nameLabel}}\n                                </div>\n\t\t                    \t<div fsl-key-press tabindex="0" class="truncate" id="ActionButton" ng-show="bulkActionsOrder.dropdown.length || customActions.length" cs-toggle="MainActionContainer">\n                                    <span ng-show="(!bulkActionsOrder.first.length &&\n                                                   !bulkActionsOrder.second.length) ||\n                                                   ( (!checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name)  || !isActionAvailable(actionNames[bulkActionsOrder.first[0].title].name )) &&\n                                                     (!checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name) || !isActionAvailable(actionNames[bulkActionsOrder.second[0].title].name)) )">\n                                           '+customLabels.Actions+'\n                                    </span>\n                                    <i class="fa fa-caret-down"></i>\n\t\t                    \t</div>\n\t                    \t</div>\n\t                    \t\n\t                        <div id="MainActionContainer">\n\t\t\t                    <div class="truncate BulkActionMenuItem" tabindex="0" role="select" fsl-tab-switch fsl-key-press ng-repeat="action in bulkActionsOrder.dropdown" ng-show="checkHasCustomPermission(actionNames[action.title].name) && isActionAvailable(actionNames[action.title].name)" ng-click="openBulkAction(action.title)">\n\t\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon mainActionIcon">\n\t\t\t\t\t\t\t\t\t\t<use xlink:href="{{actionNames[action.title].icon}}"></use>\n\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t\t{{actionNames[action.title].nameLabel}}\n                                </div>\n                                \n                                \n                                <div class="truncate BulkActionMenuItem" tabindex="0" role="select" fsl-tab-switch fsl-key-press ng-repeat="action in customActions" ng-click="runCustomServiceAction(action)">\n                                \n                                    <svg aria-hidden="true" class="slds-icon mainCustomActionIcon">\n\t\t\t\t\t\t\t\t\t\t<use xlink:href="{{action.icon}}"></use>\n\t\t\t\t\t\t\t\t\t</svg>\n                                \n\t\t\t\t\t\t\t\t\t{{action.name}}\n                                </div>\n                                                               \n                                \n\t                        </div>',scope:{},controller:e}}angular.module("serviceExpert").directive("bulkActionsButton",e),e.$inject=[]}(),angular.module("serviceExpert").directive("bulkOptimizeOptions",function(){return{template:customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n\t\t\t\t\t\t\t\t<option value="all">'+customLabels.All+'</option>\n\t\t\t\t\t\t\t\t<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n\t\t\t\t\t\t\t</select>")}}).directive("bulkOptimizePolicy",function(){return{template:customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n\t\t\t\t\t\t\t\t \t<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n\t\t\t\t\t\t\t\t \t<option value="noFilter">'+customLabels.None+"</option>\n\t\t\t\t\t\t\t\t </select>")}}).directive("bulkChangeStatusDates",function(){return{template:customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartChangeStatus" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartChangeStatus\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishChangeStatus" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishChangeStatus\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>')}}).directive("bulkUnscheduleDates",function(){return{template:customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>')}}).directive("bulkChangeStatusPicklist",function(){return{template:customLabels.changeStatusBulkMsg.replace("$0",'<select class="selectChangeStatusBulk bulkStatusWidth" ng-model="bulkStatus">\n\t\t\t\t\t\t\t\t<option ng-repeat="(statusType,statusLabel) in statuses" value="{{statusLabel}}" >{{getStatusTranslations()[statusLabel]}}</option>\n\t\t\t\t\t\t\t</select>')}}),!function(){function e(){function e(i){i.colors=[{Name:"Red",Hex:"#E53935"},{Name:"Pink",Hex:"#D81B60"},{Name:"Purple",Hex:"#8E24AA"},{Name:"Indigo",Hex:"#3949AB"},{Name:"Blue",Hex:"#1E88E5"},{Name:"Cyan",Hex:"#00ACC1"},{Name:"Teal",Hex:"#00897B"},{Name:"Green",Hex:"#43A047"},{Name:"Lime",Hex:"#C0CA33"},{Name:"Yellow",Hex:"#FDD835"},{Name:"Amber",Hex:"#FFB300"},{Name:"Orange",Hex:"#FB8C00"},{Name:"Brown",Hex:"#6D4C41"},{Name:"Grey",Hex:"#757575"},{Name:"Blue Grey",Hex:"#546E7A"},{Name:"Black",Hex:"#000"}],i.selectColor=function(e){i.selectedColor=e.Hex,i.setSelectedShapeColor(e.Hex),i.showColorMenu=!1},i.showMenuClick=function(e){i.drawState!=i.drawingStates.EDIT&&i.drawState!=i.drawingStates.DRAW||(i.showColorMenu=!i.showColorMenu)},i.selectedColor="#546E7A",i.showColorMenu=!1,angular.element("#mapOptionsContainer").on("click",function(e){for(var t=["color-square","color-button"],n=0;n<t.length;n++)if(e.target.classList.contains(t[n])||e.target.parentNode&&e.target.parentNode.classList.contains(t[n]))return;i.showColorMenu&&(i.showColorMenu=!1)})}return e.$inject=["$scope"],{restrict:"E",template:'<div id="select-color-btn" title="'+customLabels.Select_color+'" class="color-button truncate"  ng-click="showMenuClick()" ng-class="{disabledButton: drawState != drawingStates.EDIT && drawState != drawingStates.DRAW}">\n                            <span class="color-square" ng-style="{\'background-color\': selectedColor}"></span><span>'+customLabels.Select_color+'</span>\n                        </div>\n                        <div class="color-menu" id="colorMenu" ng-show="showColorMenu == true">\n                            <span class="color-box" ng-repeat="color in colors" ng-click="selectColor(color)" ng-style="{\'background-color\': color.Hex}"></span>\n                        </div>',scope:!1,controller:e}}angular.module("serviceExpert").directive("csColorPicker",e),e.$inject=[]}(),angular.module("serviceExpert").directive("fieldInCard",["$filter","utils",function(i,s){return{restrict:"E",link:function(n,e,t){n.fieldsTypes=s.fieldsTypes,n.isFieldEmpty=function(e,t){return void 0===i("displayFieldSetField")(n.service,n.field)},n.getRefFieldID=function(e,t){return e[t.JsAPIName.replace("__r","__c")]},n.openConsoleTab=s.openConsoleTab},scope:{service:"=",field:"="},template:'\n            \n                <span>\n                \n                    <div class="extra-info-title" title="{{field.Label}}">{{field.Label}}</div>\n                    <span class="extra-info-content" ng-show="field.Type != fieldsTypes.Reference && field.Type != fieldsTypes.Phone" title="{{service | displayFieldSetField : field}}"><service-list-column service="service" field="field"></service-list-column></span>\n                    <span ng-show="isFieldEmpty(service, field)">-</span>\n                    <a draggable="false" ng-show="field.Type == fieldsTypes.Reference" ng-click="openConsoleTab($event, getRefFieldID(service, field))" target="_blank" href="../{{ getRefFieldID(service, field) }}" title="{{service | displayFieldSetField : field}}">{{service | displayFieldSetField : field}}</a>\n                    <span ng-if="field.Type == fieldsTypes.Phone && !isFieldEmpty(service, field)">\n                        <cs-click-to-dial number="{{service[field.APIName]}}" user-id="\'{!$User.Id}\'" user-first-name="\'{!JSENCODE($User.FirstName)}\'" user-last-name="\'{!JSENCODE($User.LastName)}\'"></cs-click-to-dial>\n                    </span>\n\n                </span>\n            '}}]);var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(i.push(o.value),!n||i.length!==n);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}!function(){function e(){function e(r,t,n,i,o,a,s){r.isEmpty=t.isEmpty,r.paletteApplied=!1,r.updatePaletteView=function(){var i,s;r.calculatePaletteColors=!1,(r.paletteDataIsValid=!0)===r.paletteApplied&&r.clearPalette(),r.selectedPalette!==customLabels.None&&void 0!==r.GanttPalettes[r.selectedPalette]||o.SetUserSettingsProperty("Gantt_Palette__c",null),void 0!==r.GanttPalettes[r.selectedPalette]&&(r.currentPalette=r.GanttPalettes[r.selectedPalette],r.picklistMap={},t.serviceFieldsMap().then(function(e){var t,e=e[r.currentPalette.ServiceProperty];try{e.Type===FieldTypes.PICKLIST&&(i=Object.keys(r.currentPalette.ColorScheme.picklist[e.Name]),s=Object.values(r.currentPalette.ColorScheme.picklist[e.Name])),e.Type===FieldTypes.BOOLEAN&&(i=[customLabels.Selected,customLabels.Deselected],s=[r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorScheme.min.color]),e.Type!==FieldTypes.DATE&&e.Type!==FieldTypes.DATETIME||(t=a.convertMomentDtToDt(moment().tz(userTimeZone)),s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),i=function(e,t,n,i,s,r){for(var i=p(i,t),t=p(s,n),o=e.getTime()+i,a=(e.getTime()+t-o)/r,l=[],c=0;c<r;c++){var d=moment(o+c*a),u=moment(o+(c+1)*a);l.push(0===c?m([customLabels.Earlierthan,u.format("dddd, MMMM Do YYYY, h:mm:ss a")]):c===r-1?m([customLabels.LaterThan,d.format("dddd, MMMM Do YYYY, h:mm:ss a")]):customLabels.Between_x_and_y.replaceAll(d.format("dddd, MMMM Do YYYY, h:mm:ss a"),u.format("dddd, MMMM Do YYYY, h:mm:ss a")))}return l}(t,r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorScheme.min.type,r.currentPalette.ColorScheme.max.type,r.currentPalette.ColorLevel)),e.Type===FieldTypes.DOUBLE&&(s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),i=l(r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorLevel)),e.Type!==FieldTypes.INTEGER&&e.Type!==FieldTypes.PERCENT||(s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),i=function(e,t,n){e=parseInt(e);for(var i=((t=parseInt(t))-e)/n,s=(i=Math.round(i),[]),r=0;r<n;r++){var o=e+r*i,a=e+(r+1)*i;s.push(0===r?m([a,customLabels.OrLower]):r===n-1?m([customLabels.HigherThan,o]):customLabels.Between_x_and_y.replaceAll(o,a))}return s}(r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorLevel)),e.Type!==FieldTypes.LOCATION&&e.Type!==FieldTypes.ADDRESS||(s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),i=l(r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorLevel,!0)),r.picklistLength=s.length;for(var n=0;n<s.length;n++)r.picklistMap[i[n]]=s[n]}catch(e){r.paletteDataIsValid=!1}}))},r.clearPalette=function(){r.hidePaletteView(),r.selectedPalette=customLabels.None,o.SetUserSettingsProperty("Gantt_Palette__c",null),r.paletteApplied=!1,s.$broadcast("paletteUpdated")},s.$on("applyPalette",function(){r.applyPalette()}),r.applyPalette=function(){var e;r.calculatePaletteColors||(r.calculatePaletteColors=!0,void 0!==(e=r.GanttPalettes[r.selectedPalette])?t.applyNewPaletteForGantt(e,n.serviceAppointments()).then(function(e){r.showPaletteView(),r.paletteApplied=!0,r.calculatePaletteColors=!1,s.$broadcast("paletteUpdated")}):(alert("No palette selected"),r.calculatePaletteColors=!1))},r.openPalettesLightbox=function(e){"edit"===e&&i.open(customLabels.GanttPalettes,GanttPalettePage)},r.calculatePalettePortionStyle=function(e){return{background:e,width:100/r.picklistLength+"%",height:"12px"}},t.getGanttPalettes().then(function(e){r.GanttPalettes=Object.fromEntries(Object.entries(e).sort(function(e,t){e=_slicedToArray(e,2)[1],t=_slicedToArray(t,2)[1];return e.Name.localeCompare(t.Name)})),r.selectedPalette=o.GetUserSettingsProperty("Gantt_Palette__c")||(null==r.GanttPalettes||r.isEmpty(r.GanttPalettes)?customLabels.NoPalettes:customLabels.None),r.updatePaletteView()}),r.getTranslatedPicklistValue=function(e){return r.GanttPalettes[r.selectedPalette]&&r.GanttPalettes[r.selectedPalette].translations&&r.GanttPalettes[r.selectedPalette].translations[e]||e}}function l(e,t,n,i){e=parseFloat(e);for(var s=((t=parseFloat(t))-e)/n,r=[],o=0;o<n;o++){var a=e+o*s,l=e+(o+1)*s;r.push(i?0===o?m([l,distanceUnit,customLabels.OrLower]):o===n-1?m([customLabels.HigherThan,a,distanceUnit]):customLabels.Between_x_and_y.replaceAll(m([a,distanceUnit]),m([l,distanceUnit])):0===o?m([l,customLabels.OrLower]):o===n-1?m([customLabels.HigherThan,a]):customLabels.Between_x_and_y.replaceAll(a,l))}return r}function p(e,t){var n;switch(e){case"Minutes":n=60*t*1e3;break;case"Hours":n=60*t*60*1e3;break;case"Days":n=24*t*60*60*1e3}return n}function c(e,t,n){for(var i=[],s=e.substr(1,2),r=e.substr(3,4).substr(0,2),e=e.substr(5,6),o=t.substr(1,2),a=t.substr(3,4).substr(0,2),t=t.substr(5,6),l=parseInt(s,16),c=parseInt(r,16),d=parseInt(e,16),u=(parseInt(o,16)-l)/n,p=(parseInt(a,16)-c)/n,m=(parseInt(t,16)-d)/n,h=0;h<n;h++){var g=Math.round(Math.abs(l+u*h))%256,v=Math.round(Math.abs(c+p*h))%256,f=Math.round(Math.abs(d+m*h))%256,g=g.toString(16),v=(1===g.length&&(g="0"+g),v.toString(16)),f=(1===v.length&&(v="0"+v),f.toString(16)),g="#"+g+v+(f=1===f.length?"0"+f:f);i.push(g)}return i}function m(e){for(var t="",n=0;n<e.length;n++)t+=e[n]+" ";return t}return e.$inject=["$scope","GanttPalettesService","TimePhasedDataService","GeneralLightbox","userSettingsManager","utils","$rootScope"],{restrict:"E",template:'<div>\n                            <div class="palette-explain-headline">\n                                <div class="palette-explain">\n                                    '+customLabels.PaletteChangeExplain+'\n                                </div>\n\n                                <button ng-if="showPaletteEdit" class="globalWhiteButton truncate palette-editor-button" title="'+customLabels.OpenPaletteEditor+'" ng-click="openPalettesLightbox(\'edit\')">\n                                    '+customLabels.OpenPaletteEditor+'\n                                </button>\n                            </div>\n\n                            <div>\n                                <span>\n                                    <select class="ganttPaletteSelector" ng-model="selectedPalette" ng-change="updatePaletteView()">\n                                        <option ng-if="isEmpty(GanttPalettes) == true" value="'+customLabels.NoPalettes+'">--- '+customLabels.NoPalettes+' ---</option>\n                                        <option ng-if="isEmpty(GanttPalettes) == false" value="'+customLabels.None+'">--- '+customLabels.None+' ---</option>\n                                        <option ng-repeat="(key,value) in GanttPalettes" value="{{key}}">{{value.Name}}</option>\n                                    </select>\n                                </span>\n                            </div>\n\n                            <div class="palette-details-container" ng-if="GanttPalettes[selectedPalette] !== undefined">\n                                \n                                <div ng-if="paletteDataIsValid">\n\n                                    '+customLabels.HoverPaletteColor+'\n                                \n                                    <div style="padding-top: 10px">\n                                        <div class="paletteBox">\n                                            <span title="{{getTranslatedPicklistValue(key)}}" ng-class="{\'roundBoxRight\': $last, \'roundBoxLeft\': $first}" ng-style="calculatePalettePortionStyle(value)" ng-repeat="(key, value) in picklistMap"></span>\n                                        </div>\n                                    </div>\n\n                                    <div class="palette-description" ng-hide="currentPalette.Description === \'\' || currentPalette.Description === undefined">\n                                        <div class="description-label-heading">\n                                            '+customLabels.Description+'\n                                        </div>\n                                        <div class="palette-description-content">\n                                            {{currentPalette.Description}}\n                                        </div>\n                                    </div>\n                                    \n                                    <div class="apply-palette-button-container">\n                                        <button ng-show="paletteApplied === false" ng-class="{ quickActionBtnForPaletteDisabled : calculatePaletteColors, quickActionBtnForPalette: !calculatePaletteColors}"  class="" ng-click="applyPalette()">'+customLabels.ApplyPalette+'</button>\n                                        <button ng-show="paletteApplied === true" ng-class="{ quickActionBtnForPaletteDisabled : calculatePaletteColors, quickActionBtnForPalette: !calculatePaletteColors}"  class="" ng-click="clearPalette()">'+customLabels.UseDefaultPalette+'</button>\n                                    </div>\n\n                                </div>\n\n                                <div class="palette-details-error" ng-if="paletteDataIsValid == false">\n                                    '+customLabels.PaletteDataIsInvalid+"\n                                </div>\n\n                            </div>\n                        </div>",scope:{showPaletteView:"=",showPaletteEdit:"=",hidePaletteView:"="},controller:e}}angular.module("serviceExpert").directive("ganttPalette",e),e.$inject=[]}(),!function(){function e(){function e(t,n,e){t.open=!1,t.selected={},t.numOfSelected=0,t.selectButtonMessage=customLabels.SelectFromTheFilteredTerritories,t.servicesWithoutTerritory=!1,t.toggleDropdown=function(){t.open=!t.open},e.on("click",function(e){e=e.target.closest(".multiselect-component-container");t.open&&!e&&t.$apply(function(){t.toggleDropdown()})}),t.updateCheckbox=function(e){"orphan"===e?t.servicesWithoutTerritory=!t.servicesWithoutTerritory:(t.selected[e]?t.selected[e]=!t.selected[e]:t.selected[e]=!0,t.numOfSelected=Object.values(t.selected).filter(function(e){return e}).length,1===t.numOfSelected?t.selectButtonMessage=customLabels.OneTerritorySelected:t.selectButtonMessage=0<t.numOfSelected?t.numOfSelected+" "+customLabels.XTerritoriesSelected:customLabels.SelectFromTheFilteredTerritories),n(function(){"territories"===t.type&&("orphan"===e?t.$parent.orphanServices=t.servicesWithoutTerritory:t.$parent.selectedLocations=t.selected,t.$parent.onSelectTerritory())})}}return e.$inject=["$scope","$timeout","$document"],{restrict:"E",scope:{options:"=",type:"@"},controller:e,template:'\n        <div class="multiselect-component-container" ng-show="selected">\n            <div>\n                <div class="multi-dropdown-button" ng-click="toggleDropdown()">\n                    <label>{{selectButtonMessage}}</label>\n                    <svg>\n                        <use xlink:href="'+lsdIcons.down+'"></use>\n                    </svg>\n                </div>\n                <ul class="multi-dropdown" ng-show="open">\n                    <li class="multiselect-li-item" ng-repeat="o in options track by $index" id="filteredTerritory{{$index}}" ng-click="updateCheckbox(o.id)">\n                        <svg ng-show="selected[o.id]" class="multi-select-icon">\n                            <use xlink:href="'+lsdIcons.check+'"></use>\n                        </svg>\n                        <svg ng-hide="selected[o.id]" class="multi-select-icon">\n                            <use xlink:href=""></use>\n                        </svg>\n                        <label>{{o.name}}</label>\n                    </li>\n                    <li class="multiselect-li-item" id="filteredTerritoryOrphan" ng-click="updateCheckbox(\'orphan\')">\n                        <svg ng-show="servicesWithoutTerritory" class="multi-select-icon">\n                            <use xlink:href="'+lsdIcons.check+'"></use>\n                        </svg>\n                        <svg ng-hide="servicesWithoutTerritory" class="multi-select-icon">\n                            <use xlink:href=""></use>\n                        </svg>\n                        <label>'+customLabels.IncludeServicesNoLocations+"</label>\n                    </li>\n                </ul>\n            </div>\n        </div>"}}angular.module("serviceExpert").directive("multiDropdown",e),e.$inject=[]}(),!function(){function e(){return{restrict:"E",scope:{request:"=",apptCount:"@",progressStatus:"="},template:'<div class="opt-progress">\n                            <span class="opt-progress-preparing"></span>\n\n                            <div class="opt-progress-bar smart_in_progress">\n                                <span class="opt-progress-text"></span>\n                            </div>\n\n                        </div>',link:function(a,n,e){var l,c,i,d,s;function r(){var e,t,n,i,s,r,o;a.progressStatus[a.request.id].progressInterval||(e=a.request.objectToScheduled,t=d.maxRunTimeSingleService*e,n=(new moment).diff(moment(a.request.requestProgressStart),"seconds"),t>=d.maxRuntimeOverall&&(e=d.maxRuntimeOverall/d.maxRunTimeSingleService,t=d.maxRuntimeOverall),i=n/t*100,s=7,r=0,o=90/e,t<=n&&"In Progress"==a.request.status&&(s=7+(n-t)/d.maxRunTimeSingleService*.1,r=90),a.progressStatus[a.request.id].progressInterval=setInterval(function(){"Aborted"!==a.request.status&&"Aborting"!==a.request.status||u(),90<(i+=o)&&(i=90),r<90?r=i:100<=r?(r=100,clearInterval(a.progressStatus[a.request.id].progressInterval),delete a.progressStatus[a.request.id].progressInterval):90<=r&&(s+=.1,r=Math.round(Math.atan(s)/(Math.PI/2)*100*1e3)/1e3),l.css("width",r+"%"),c.text(r.toFixed(2)+"%")},1e3*d.maxRunTimeSingleService))}function u(){clearInterval(a.progressStatus[a.request.id].progressInterval),delete a.progressStatus[a.request.id].progressInterval}"Global Optimization"===a.request.type&&(l=angular.element(n[0].querySelector(".opt-progress-bar")),c=angular.element(n[0].querySelector(".opt-progress-text")),i=angular.element(n[0].querySelector(".opt-progress-preparing")),d=__gantt[e.optType],a.progressStatus[a.request.id]||(a.progressStatus[a.request.id]={status:a.request.status,objectToScheduled:a.request.objectToScheduled}),a.progressStatus[a.request.id].objectToScheduled||(l.css("width","0%"),i.text(customLabels.PreparingData)),s=a.$watchCollection("[request.objectToScheduled, request.status]",function(e,t){""!=e[0]&&null!=e[0]&&e[0]!=a.progressStatus[a.request.id].objectToScheduled?(i.text(""),a.progressStatus[a.request.id].objectToScheduled=e[0],r()):"In Progress"==e[1]&&null!=e[0]&&"In Progress"==a.progressStatus[a.request.id].status&&(i.text(""),r()),"In Progress"!==e[1]&&"In Progress"==a.progressStatus[a.request.id].status?(a.progressStatus[a.request.id].status=e[1],u(),s()):"Completed"==a.progressStatus[a.request.id].status&&(angular.element(n[0].querySelector(".opt-progress")).remove(),s())}))}}}angular.module("serviceExpert").directive("csOptimizationProgress",e),e.$inject=[]}(),angular.module("serviceExpert").directive("csRange",["$filter","utils",function(a,l){return{restrict:"CAE",link:function(n,e,i){var s=$($(e[0]).find(".showingDates")),r=isAMPM?"ampm":"24",o=$($(e[0]).find(".sliderSelector"));n.$watchCollection(i.ngModel,function(e,t){!o.slider("instance")||e.start===t.start&&e.end===t.end||(o.slider("values",[e.start,e.end]),s.text(i.showingText.replace("{1}",a("ampmOr24")(parseInt(e.start),r,!0)).replace("{2}",a("ampmOr24")(parseInt(e.end),r,!0))))}),o.slider({range:!0,min:parseInt(i.min),max:parseInt(i.max),values:[parseInt(i.defaultStart),parseInt(i.defaultEnd)],slide:function(e,t){e.stopPropagation(),s.text(i.showingText.replace("{1}",a("ampmOr24")(parseInt(t.values[0]),r,!0)).replace("{2}",a("ampmOr24")(parseInt(t.values[1]),r,!0)))},stop:function(e,t){e.stopPropagation(),l.safeApply(n,function(){n[i.ngModel].start=t.values[0],n[i.ngModel].end=t.values[1]})}}),s.text(i.showingText.replace("{1}",a("ampmOr24")(parseInt(i.defaultStart),r,!0)).replace("{2}",a("ampmOr24")(parseInt(i.defaultEnd),r,!0)))},scope:!0,template:'<div class="sliderSelector"></div><span class="showingDates"></span>'}}]),angular.module("serviceExpert").directive("safeBinder",[function(){return{restrict:"A",scope:{safeBinder:"="},link:function(e,t,n){$(t[0]).html(e.safeBinder)}}}]),angular.module("serviceExpert").directive("serviceListColumn",["utils","$filter",function(a,l){return{restrict:"E",link:function(r,o,e){r.isFormulaForImage=a.isFormulaForImage,r.getType=function(){var e,t,n,i=o,s=r;return r.field.FullAPIName===window.fieldNames.Service_Appointment.GanttIcon__c?"gantt-icons":"STRING"!==r.field.Type&&"TEXTAREA"!==r.field.Type||!a.isFormulaForImage(r.service[r.field.FullAPIName])?("BOOLEAN"!==r.field.Type&&(null==(n=l("displayFieldSetField")(r.service,r.field))?i[0].innerText="":(n=n.toString(),""!==s.pattern&&(e=s.pattern,s=s.pattern?s.pattern.toLowerCase():null,t=(t=n?n.toLowerCase():null)?t.indexOf(s):-1,s)&&-1<t?(s=n.substring(0,t).encodeHTML(),s=(s+='<span class="resource-highlight-on-search">'+n.substr(t,e.length).encodeHTML()+"</span>")+n.substring(t+e.length).encodeHTML(),i[0].innerHTML=s):i[0].innerText=n)),"normal"):void(i[0].innerHTML.includes("<img")||(i[0].innerHTML='<span>\n                                               <img class="img-on-service-list" src="'+a.isFormulaForImage(r.service[r.field.FullAPIName])+'" />\n                                           </span>'))}},scope:{service:"=",field:"=",pattern:"="},template:'\n            \n            <span>\n                <input type="checkbox" class="checkbox-on-service-list" ng-if="getType() == \'normal\' && \'BOOLEAN\' == field.Type" ng-checked="service | displayFieldSetField : field" disabled></input>\n                <span ng-if="getType() == \'normal\' && \'BOOLEAN\' != field.Type"></span>\n                <img ng-if="getType() == \'gantt-icons\'" class="img-on-service-list" ng-repeat="img in service.icons track by $index" ng-src="{{img}}" track by $index/>\n                <img ng-if="getType() == \'url-icon\'" class="img-on-service-list" ng-src="{{service[field.FullAPIName]}}" />\n            </span>    \n            '}}]),angular.module("serviceExpert").directive("serviceListPreview",["utils","FieldSetFieldsService","StateService",function(e,t,n){var i=[],o=n.isRtlDirection();return t.fieldsSetFields().then(function(e){i=e.servicePreview}),{restrict:"E",link:function(e,r,t){e.fields=function(){return i},e.handleOver=function(e){e.stopPropagation();var t=document.body.getBoundingClientRect(),n=$(r).find(".service-quick-view")[0].getBoundingClientRect(),i=n.x-t.x+37,s=n.top-t.top,t=t.right-n.right+37,n=$(r).find(".service-preview")[0],e=e.clientY;n.style.display="inline-block",document.body.clientHeight<n.clientHeight+e&&(s=document.body.clientHeight-n.clientHeight-26),o?n.style.right=t+"px":n.style.left=i+"px",n.style.top=s+"px"},e.handleOut=function(e){$(r).find(".service-preview")[0].style.display="none"},e.getPreviewPosition=function(){return o?{left:e.position.x}:{right:e.position.x}}},scope:{service:"=",position:"="},template:'\n            \n            <div>\n                <div class="service-quick-view" ng-mouseenter="handleOver($event)" ng-mouseleave="handleOut($event)" ng-style="getPreviewPosition()">\n                    <svg aria-hidden="true" class="slds-icon">\n                        <use xlink:href="'+window.lsdIcons.info+'"></use>\n                    </svg>\n                </div>\n\n                <div class="service-preview"> \n                    <div class="preview-field-container" ng-repeat="field in fields() track by $index">\n                        <b class="label-preview">{{field.Label}}</b>: <span ng-if="!service[field.APIName] && field.Type !== \'BOOLEAN\'">-</span> <service-list-column service="service" field="field"></service-list-column>\n                    </div>                    \n                </div>\n\n                \n            </div>    \n            '}}]),!function(){function e(){function e(e){e.callMe=function(e,t,n,i){n=n+" "+i;return sendCTIMessage("/CLICK_TO_DIAL?DN="+encodeURIComponent(e)+"&amp;ID="+t+"&amp;ENTITY_NAME=User&amp;OBJECT_NAME="+encodeURIComponent(n)+"&amp;DISPLAY_NAME="+encodeURIComponent("User")),!1}}e.$inject=["$scope"];return{restrict:"E",template:'<span class="tel" style="display: none;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, false);"></img>{{number}}\n                                <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" title="Click to dial disabled"></img>\n                            </span> \n                            <span style="display: block;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, true);"></img>\n                                <a href="javascript:void(0);" onclick="disableClicked(this, \'Click to dial disabled\');" ng-click="callMe(number, userId, userFirstName, userLastName)" title="">{{number}}\n                                    <img src="/img/btn_dial_inline.gif" alt="Click to dial" width="16" height="10" title="Click to dial" style="display: inline;"></img>\n                                    <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" style="display: none;" title="Click to dial disabled"></img>\n                                </a>\n                            </span>',scope:{number:"@",userId:"@",userFirstName:"@",userLastName:"@"},controller:e}}angular.module("serviceExpert").directive("csClickToDial",e),e.$inject=[]}(),angular.module("serviceExpert").directive("dhxScheduler",["$rootScope","$timeout","userSettingsManager","$q","sfdcService","ResourcesAndTerritoriesService","FieldSetFieldsService","TimePhasedDataService",function(c,d,u,p,e,m,h,g){return{restrict:"C",transclude:!0,template:'<div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div>',link:function(e,t,n){window.utils=angular.element("#serviceExpertApp").injector().get("utils");var i=_.debounce(function(e){scheduler.updateCollection("resources",e)},500),n=(e.$watch(n.resources,function(e){folderJustToggled?folderJustToggled=!1:i(e)},!0),t.addClass("dhx_cal_container"),schedulerConfig.configTimelines(),schedulerConfig.setConfigurations(),u.GetUserSettingsProperty("Gantt_View_Start_Hour__c")),s=u.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),r=u.GetUserSettingsProperty("Resource_Row_Height__c"),o=u.GetUserSettingsProperty("View_Capacity_Type__c"),a=u.GetUserSettingsProperty("Include_Weekends__c"),l=u.GetUserSettingsProperty("Load_On_Today__c");null!==r&&schedulerConfig.setRowHeights(r,!1),null!==o&&setCapacityFilter(o),null!==n&&null!==s&&setHoursToDisplay(n,s,a),c.policy=defaultPolicy,p.all([m.promises.territories(),m.promises.resources(),h.fieldsSetFields()]).then(function(){scheduler.init(t[0],new Date,"ZoomLevel3"),e.scheduler=scheduler,e.datalessMethods=attchDatalessSchedulerEvents(),d(function(){l&&scheduler.setCurrentView(new Date),g.promises.initialStmsPhasedData.then(function(){$("#FirstTimeLoading").remove()}),e.getTimePhasedObjects().then(function(){}).catch(function(e){bootstrap.handleError(e)}),c.$broadcast("initCompleted")},20)}).catch(function(e){console.log("err:"+e)})}}}]),angular.module("serviceExpert").directive("dragNA",function(){return{restrict:"CAE",scope:{dragService:"="},link:function(e,t,n,i){cachedDomElements.draggedBreak||(cachedDomElements.draggedBreak=$("#draggedBreak")),cachedDomElements.draggedBreakDiv||(cachedDomElements.draggedBreakDiv=$("#draggedBreak div")),t.bind("dragstart",function(e){var t,n=document.querySelector("#breakDuration").dataset.duration,n=parseInt(n),i=(e.originalEvent.dataTransfer.setData("text","absenceNA_"+n),Math.floor(n/60)),i=(cachedDomElements.draggedBreakDiv.html(window.customLabels.AbsenceCreatorFormat.replaceAll(i,n%60)),getMinAndMaxHoursToDisplay()),s=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60),i=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60),n=(i.setMinutes(i.getMinutes()+n),getXPositionOfEvent({start_date:s,end_date:i},!1,scheduler.matrix[scheduler._mode])),s=getXPositionOfEvent({start_date:s,end_date:i},!0,scheduler.matrix[scheduler._mode])-n+4,i=(cachedDomElements.draggedBreak.css("width",s+"px"),document.getElementById("draggedBreak").cloneNode(!0));document.body.appendChild(i),"setDragImage"in window.DataTransfer.prototype&&(t="rtl"===document.querySelector("html").getAttribute("dir")?s:0),e.originalEvent.dataTransfer.setDragImage(i,t,40)})}}}),angular.module("serviceExpert").directive("draggableService",["utils","servicesService","SERVICE_STATUS","SERVICE_CATEGORY","StateService",function(a,e,t,l,c){return{restrict:"CAE",scope:{dragService:"="},link:function(o,e,t,n){cachedDomElements.draggedEvent||(cachedDomElements.draggedEvent=$("#draggedEvent")),cachedDomElements.draggedEventDiv||(cachedDomElements.draggedEventDiv=$("#draggedEvent div")),e.bind("dragstart",function(e){e.originalEvent.dataTransfer.setData("text",o.dragService.id);var t="<b>"+(o.dragService.ganttLabel||o.dragService.name)+"</b><br/>"+o.dragService.estDuration+" "+o.dragService.durationType,t=(cachedDomElements.draggedEventDiv.html(t),getMinAndMaxHoursToDisplay()),n=new Date(scheduler._min_date.getTime()+1e3*t.min*60*60),t=new Date(scheduler._min_date.getTime()+1e3*t.min*60*60),i=(o.dragService.durationType?o.dragService.durationType===a.durationTypes.minutes?t.setMinutes(t.getMinutes()+o.dragService.estDuration):o.dragService.durationType===a.durationTypes.hours?t.setMinutes(t.getMinutes()+Math.floor(60*o.dragService.estDuration)):o.dragService.durationType===a.durationTypes.days&&t.setMinutes(t.getMinutes()+Math.floor(60*o.dragService.estDuration*24)):o.dragService.setMinutes(t.getMinutes()+60),getXPositionOfEvent({start_date:n,end_date:t},!1,scheduler.matrix[scheduler._mode])),n=getXPositionOfEvent({start_date:n,end_date:t},!0,scheduler.matrix[scheduler._mode])-i+4,s="";switch(o.dragService.statusCategory){case l.NONE:s=" eventStatusNew";break;case l.SCHEDULED:s=" eventStatusAssigned";break;case l.DISPATCHED:s="eventStatusDispatched";break;case l.IN_PROGRESS:s=" eventStatusTravel";break;case l.COMPLETED:s=" eventStatusCompleted";break;case l.COULD_NOT_COMPLETE:s=" eventStatusCouldntComplete";break;case l.CANCELED:s=" eventStatusCancelled";break;default:s=" eventCustomStatus"}cachedDomElements.draggedEvent.css("width",n+"px"),cachedDomElements.draggedEvent.removeClass(),cachedDomElements.draggedEvent.addClass(s),o.dragService.ganttColor?cachedDomElements.draggedEvent.css("background",o.dragService.ganttColor):cachedDomElements.draggedEvent.css("background","");var r,t=document.getElementById("draggedEvent").cloneNode(!0);document.body.appendChild(t),"setDragImage"in window.DataTransfer.prototype&&(r=c.isRtlDirection()?n:0),e.originalEvent.dataTransfer.setDragImage(t,r,28)})}}}]).directive("dragTarget",["$rootScope","$filter","utils","servicesService","sfdcService","kpiCalculationsService","ResourcesAndTerritoriesService","AbsencesService","TimePhasedDataService","SERVICE_CATEGORY","StateService","OptimizationRequestsService",function(e,t,_,b,n,y,w,T,L,A,I,C){return{restrict:"CAE",link:function(S,e,t,n){var o=Date.now();e.bind("dragover",function(e){var t,n,i,s,r;cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix")),e.preventDefault(),scheduler.config.readonly||Date.now()-o<500||(o=Date.now(),i=scheduler.getActionData(e.originalEvent),t=w.getResources()[i.section.split("_")[0]],n=i.section.split("_")[1],t&&n&&(n=_.getLocationOffset(i.date,n)-_.getUserOffset(i.date),(r=new Date(i.date)).setMinutes(r.getMinutes()+n),t.name&&(!t.isCapacityBased||t.isCapacityBased&&!contractorSupport)?(r=new Date(i.date),s=(i=i.date.getMinutes())%serviceJumpsOnGantt,r=(i=serviceJumpsOnGantt-i%serviceJumpsOnGantt)<s?new Date(r.getTime()+60*i*1e3):new Date(r.getTime()-60*s*1e3),i=moment(r).format("lll"),(s=new Date(r)).setMinutes(s.getMinutes()+n),r=moment(s).format("lll"),e.originalEvent.ctrlKey?cachedDomElements.timesDragFix.html("<b>"+t.name.encodeHTML()+"</b> "+customLabels.SnapOn+" "+i+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+r)):cachedDomElements.timesDragFix.html("<b>"+t.name.encodeHTML()+"</b> "+customLabels.on+" "+i+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+r)),cachedDomElements.timesDragFix.show()):cachedDomElements.timesDragFix.hide()))}),e.bind("dragleave",function(e){cachedDomElements.timesDragFix.hide(),e.preventDefault()}),e.bind("drop",function(e){if(e.preventDefault(),void 0!==cachedDomElements.draggedEvent&&cachedDomElements.draggedEvent.removeClass(),cachedDomElements.timesDragFix.hide(),!scheduler.config.readonly){var t=scheduler.getActionData(e.originalEvent),n=new Date(t.date),i=t.date.getMinutes(),s=i%serviceJumpsOnGantt,i=serviceJumpsOnGantt-i%serviceJumpsOnGantt,r=t.section,n=i<s?new Date(n.getTime()+60*i*1e3):new Date(n.getTime()-60*s*1e3),i=(t.date=n,w.getResources()[t.section.split("_")[0]]);w.territories()[t.section.split("_")[1]];if(i&&i.name){var o,a,s=e.originalEvent.dataTransfer.getData("text");if(-1<s.indexOf("absenceNA_"))$("#naOptionsContainer").hide(),n=s.substr(10,s.length-10),n=parseInt(n),(o=new Date(t.date)).setMinutes(o.getMinutes()+n),a={end_date:o,resource:i.id,start_date:t.date,start:t.date,absenceType:"None"==S.defaultDragNa.selectedNaType?null:S.defaultDragNa.selectedNaType,ganttLabel:S.defaultDragNa.selectedNaLabel,resourceId:r},_.safeApply(S,function(){b.handleSnap(a,e),T.saveNewAbsence(a,I.selectedPolicyId).then(function(e){}).catch(function(e){console.warn("Couldn't update absence"),e.error?_.addNotification(customLabels.Action_Could_Not_Be_Performed,e.error):_.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})});else{var l=L.serviceAppointments()[s];if(l){n=new Date(t.date);if(l.durationType?l.durationType==_.durationTypes.minutes?n.setMinutes(n.getMinutes()+l.estDuration):l.durationType==_.durationTypes.hours?n.setMinutes(n.getMinutes()+Math.floor(60*l.estDuration)):l.durationType==_.durationTypes.days&&n.setDate(n.getDate()+Math.floor(l.estDuration)):n.setMinutes(n.getMinutes()+60),!C.isTerritoryHasInDayOptimizationInProgress(t.date,n,t.section.split("_")[1])||!1!==confirm(customLabels.In_Day_Optimization_In_Progress_Confirm)){if(contractorSupport&&i.isCapacityBased){for(var c=!1,d=!0,u=scheduler.getEvents(t.date,n),p=0;p<u.length;p++)-1<u[p].resourceId.indexOf(t.section)&&"contractorcapacity"==u[p].type&&(c=!0,u[p].timePeriod==_.ganttSettings.capacityDuration)&&(d=!1);if(!c)return void alert(customLabels.serviceCantBeAssignedWithoutCapacity);d&&alert(customLabels.is_assigned_to_contractor.replaceAll(l.name,i.name)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}var m,h,g=angular.copy(l),v=(g.end_date=n,g.resourceId=t.section,g.start_date=new Date(t.date),g.assignedResource=null,{statusCategory:A.SCHEDULED,isDummy:!0,id:g.id+"_dummy"}),f=angular.copy(g);for(h in v)f[h]=v[h];m=scheduler.addEvent(f),_.safeApply(S,function(){b.handleSnap(g,e.originalEvent),b.saveChangesToServiceAppointment(l,g).then(function(e){y.calculateKpis()}).catch(function(e){console.warn("Couldn't update service. "+e[2]),_.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message||customLabels.user_is_not_allowed_to_perform_action),scheduler.deleteEvent(m)&&scheduler.parse([e[1]],"json")})})}}}}}})}}}]),angular.module("serviceExpert").directive("googlePlaces",function(){return{restrict:"E",replace:!0,scope:{myMap:"=",searchMarker:"="},template:'<input id="google_places_ac" name="google_places_ac" type="text" class="input-block-level"/>',link:function(t,e,n){var i=new google.maps.places.Autocomplete($("#google_places_ac")[0],{});google.maps.event.addListener(i,"place_changed",function(){var e=i.getPlace();t.searchMarker?t.searchMarker.setPosition(e.geometry.location):t.searchMarker=new google.maps.Marker({map:t.myMap,position:e.geometry.location}),e.geometry.viewport?t.myMap.fitBounds(e.geometry.viewport):(t.myMap.setCenter(e.geometry.location),t.myMap.setZoom(17))})}}}),angular.module("serviceExpert").directive("csGroupActions",["$compile",function(u){function p(e,t,n){return Math.ceil($(e).offset().top)>=t+n}return{restrict:"A",link:function(a,l){var c=$('<ul class="moreQuickActionsContainer"></ul>'),d=void 0;angular.element(l[0]).on("click",function(e){e.stopPropagation(),$("#MainActionContainer").hide();var t=$(l).parent().parent().children(),e=$(t).last(),n=$(t).first(),i=$(n).offset().top,s=$(n).outerHeight(!0);if(c.hasClass("viewMoreActive"))c.removeClass("viewMoreActive"),c.empty(),c.remove();else{if(p($(e),i,s)){for(var r,o=t.length-1;1<o;o--)d=$(t[o]),p(d,i,s)&&(r=$("<li></li>"),d.find("> div:first-child").clone().removeClass("quickActionGoLeft quickCustomActionGoLeft").addClass("menuQuickAction").css({marginBottom:"0",border:"none",width:"87%"}).appendTo(r),r.css({display:"block"}).appendTo(c),u(r)(a));$(c.children().get().reverse()).appendTo(c),$(l).append(c),c.addClass("viewMoreActive"),c.show();n=c.offset().top,e=c.outerHeight(!0);p($("#TaskListPagination"),n,e)||$("#TaskListItems").animate({scrollTop:$("#TaskListItems").scrollTop()+(180<36*c.children().length?180:36*c.children().length)},500)}angular.element("body").on("mousedown",function(e){for(var t=["moreQuickActionsBtn","menuQuickAction","fa-caret-down"],n=0;n<t.length;n++)if(e.target.classList.contains(t[n])||e.target.parentNode&&e.target.parentNode.classList.contains(t[n]))return;c.hasClass("viewMoreActive")&&(c.removeClass("viewMoreActive"),c.empty(),c.remove(),angular.element("body").off("mousedown"))})}})}}}]).directive("csLastAction",["utils","listQuickActionsService",function(s,r){return{restrict:"A",link:function(e,t,n){var t=$(t),e=e.service,n=n.csLastAction,i=s.getCustomActions("list");r.isLastVisibleQuickAction(n,e)&&0===i.length&&((n=t).hide(),n.parent().children()[0].classList.add("lastQuickAction"))}}}]),angular.module("serviceExpert").directive("keypressEvents",["$rootScope","StateService",function(t,n){var i=[13,16,18,27,37,38,39,40,48,49,50,51,55,69,70,73,77,79,83,84,85,87,90,96,97,98,99,103];return{restrict:"C",link:function(){angular.element("body").bind("keydown",function(e){n.isUserIdle()||(-1<i.indexOf(e.which)?t.$broadcast("keypress",e):e.stopPropagation())})}}}]).directive("fslKeyPress",function(){return{restrict:"A",link:function(e,t,n){t.bind("keypress",function(e){e.stopPropagation(),13!==e.keyCode&&32!==e.keyCode||angular.element(e.target).trigger("click")})}}}).directive("fslTabSwitch",function(){var a=37,l=38,c=39,d=40,u={37:-1,38:-1,39:1,40:1};return{restrict:"A",link:function(e,t,o){t.bind("keydown",function(e){if(e.keyCode===a||e.keyCode===c||e.keyCode===l||e.keyCode===d){for(var t=e,n=o.role,i=t.keyCode,s=t.target.parentElement.querySelectorAll('[role="'+n+'"]'),r=0;r<s.length;++r)s[r].index=r;void 0!==u[i]&&void 0!==(n=t.target).index&&(s[n.index+u[i]]?s[n.index+u[i]].focus():i===a||i===l?s[s.length-1]&&s[s.length-1].focus():i!==c&&i!==d||s[0]&&s[0].focus()),e.stopPropagation(),e.preventDefault()}})}}}),!function(){function e(e,o,t){return{restrict:"E",link:function(r){r.optimizationRequests={},r.optRunning=0,r.optQueued=0,r.replaceText=function(e,t){return customLabels[e].replaceAll(t.toString())},t.register("optimizationRequests",function(e){for(var t=0,n=0,i=0;i<e.length;i++){var s=new OptimizationRequest(e[i]);"Queued"==s.status&&n++,"In Progress"==s.status&&t++,r.optimizationRequests[s.id]&&"Completed"==s.status&&"Completed"!=r.optimizationRequests[s.id].status&&o.addNotification(customLabels.Optimization_Completed,customLabels.x_services_were_sched_out_of.replaceAll(s.scheduledAmount,s.objectToScheduled)+".",function(e){o.openSObjectLink("../"+e)},s.id),r.optimizationRequests[s.id]&&"Failed"==s.status&&"Failed"!=r.optimizationRequests[s.id].status&&o.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){o.openSObjectLink("../"+e)},s.id),r.optimizationRequests[s.id]=s}r.optQueued=n,r.optRunning=t})},scope:{},template:'\n                <div id="optInProgress" ng-show="optRunning">\n                    '+customLabels.Optimization_in_progress+"\n\t            \t<span ng-show=\"optRunning > 1\">{{ replaceText('XoptimizationRunning',optRunning) }}</span>\n\t            \t<span ng-show=\"optQueued\">{{ replaceText('XoptimizationQueued',optQueued) }}</span>\n        \t\t</div>"}}e.$inject=["DeltaService","utils","RegisterService"],angular.module("serviceExpert").directive("optimizationIndicator",e)}(),angular.module("serviceExpert").directive("csStopPropagation",[function(){return{restrict:"A",link:function(e,t,n){angular.element(t[0]).on(n.csStopPropagation,function(e){e.stopPropagation()})}}}]),angular.module("serviceExpert").directive("csToggle",[function(){return{restrict:"A",link:function(e,t,n){for(var i=$("#"+n.csToggle),s=$("[cs-toggle]"),r={},o=0;o<s.length;o++){var a=$(s[o]);r[a.attr("id")]=$("#"+a.attr("cs-toggle"))}1===i.length&&(angular.element(t[0]).on("click",function(e){for(var t in e.stopPropagation(),$(".moreQuickActionsContainer").hide(),scheduler.isCalendarVisible()&&scheduler.destroyCalendar(),r)t!==e.currentTarget.id?(r[t].hide(),$(".dhx_mini_calendar").hide()):i.toggle()}),angular.element(t[0]).on("keyup",function(e){13===e.keyCode&&i.children()[0].focus()}),angular.element("body").on("click",function(e){for(var t in r)r[t].hide()}),i.children().on("keydown",function(e){if(27===e.keyCode)for(var t in r)r[t].hide()}))}}}]),angular.module("serviceExpert").directive("csTooltip",[function(){return{restrict:"E",transclude:!0,template:'<div class="gantt-tooltip-info-button">\n                                    <svg aria-hidden="true" class="slds-icon info-tooltip-icon">\n                                        \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                                    \u2028</svg>\n                                </div>\n                                <span class="gantt-tooltip-wrapper" ng-transclude></span>',link:function(e,i,t){var s=!0;i.find(".gantt-tooltip-info-button").bind("mouseenter mouseleave",function(){var e=i.find(".gantt-tooltip-wrapper"),t=e.outerHeight(),n=i.offset();e.toggleClass("active-tooltip"),s&&(s=!1,e.css("top",n.top-t-10+"px"),e.css("position","fixed"),e.css("bottom","initial"))})}}}]),angular.module("serviceExpert").factory("SERVICE_CATEGORY",function(){return{NONE:"None",SCHEDULED:"Scheduled",DISPATCHED:"Dispatched",IN_PROGRESS:"InProgress",COULD_NOT_COMPLETE:"CannotComplete",COMPLETED:"Completed",CANCELED:"Canceled"}}),angular.module("serviceExpert").factory("SERVICE_STATUS",function(){return serviceStatuses}),angular.module("serviceExpert").constant("PARENT_RECORD_TYPE",{WORKORDER:"WorkOrder",LINEITEM:"WorkOrderLineItem",ACCOUNT:"Account"}),angular.module("serviceExpert").constant("DRAWING_STATES",{NONE:0,EDIT:1,DRAW:2,SELECTED:3,INTERSECT:4}),angular.module("serviceExpert").constant("POST_MESSAGE_TYPE",{INIT:0,SHOW_ON_MAP:1,DRAW_MARKERS:2}),!function(){function e(e,t,c,n,d,i,s){var l={},u={},r={},o={},p={};function a(e){if(e.type===o.IN_DAY){if("In Progress"===e.status||"Completed"===e.status&&p[e.id]&&"Completed"!==p[e.id].status||"In Progress"===e.status&&p[e.id]&&"Aborted"!==p[e.id].status)e.timespan=function(e){var t=[];if(e.territories){for(var n={},i=0;i<e.territories.length;i++)n[e.territories[i].serviceTerritory]=!0;var s,r=d.getGanttSectionsIdsByTerritory(n,e.start);for(s in r){var o,a={start:e.start,end:e.finish};for(o in useLocationTimezone||(a.start=c.convertDateBetweenTimeZones(e.start,userTimeZone,r[s].tz),a.end=c.convertDateBetweenTimeZones(e.finish,userTimeZone,r[s].tz)),u[s]||(u[s]={}),u[s][e.id]=a,r[s].resources){var l=scheduler.addMarkedTimespan({start_date:a.start,end_date:a.end,sections:{ZoomLevel2:o+"_"+s,ZoomLevel3:o+"_"+s,ZoomLevel4:o+"_"+s,ZoomLevel5:o+"_"+s,ZoomLevel6:o+"_"+s,ZoomLevel7:o+"_"+s},css:"smart-on-gantt-inday-body"});t.push(l)}}}return t}(e);else if("Completed"===e.status||"Failed"===e.status||"Aborted"===e.status)for(var t=0;t<e.territories.length;t++)u[e.territories[t].serviceTerritory]&&u[e.territories[t].serviceTerritory][e.id]&&delete u[e.territories[t].serviceTerritory][e.id]}else"Failed"!==e.status&&"Aborted"!==e.status&&"Completed"!==e.status&&"Global Optimization"!==e.type&&e.start&&e.finish&&(e.timespan=[function(e){if(!e.resource)return(new Date).getTime();var t=void 0,n=d.getResoruceGanttIdByDate(e.resource,e.start),i="reshufle-on-gantt",s="";{if(!n)return(new Date).getTime();t=n.split(",")}switch(e.type){case"Fix Overlaps":i="fix-overlaps-on-gantt",s=customLabels.FixOverlaps;break;case"SA Reshuffle":i="reshufle-on-gantt",s=customLabels.Reshuffle;break;case"Fill-In Schedule":i="fillin-on-gantt",s=customLabels.Fill_in_Schedule;break;case"Group Nearby SAs":i="group-near-on-gantt",s=customLabels.GroupNearby;break;case"Resource Schedule Optimization":i="resource-day-on-gantt",s=customLabels.RDOptimize;break;default:i="reshufle-on-gantt"}{var r;window.useLocationTimezone&&e.territories&&e.territories[0]&&"Resource Schedule Optimization"!==e.type?(n=c.getLocationOffset(e.start,e.territories[0].serviceTerritory),r=c.getLocationOffset(e.finish,e.territories[0].serviceTerritory),e.start.setMinutes(e.start.getMinutes()+n),e.finish.setMinutes(e.finish.getMinutes()+r)):e.territories&&e.territories[0]&&"Resource Schedule Optimization"===e.type&&(n=c.getLocationOffset(e.start,e.territories[0].serviceTerritory),r=c.getLocationOffset(e.finish,e.territories[0].serviceTerritory),e.start=new Date(e.start.getTime()-60*n*1e3+60*c.getUserOffset(e.start)*1e3),e.finish=new Date(e.finish.getTime()-60*r*1e3+60*c.getUserOffset(e.finish)*1e3))}return scheduler.addMarkedTimespan({start_date:e.start,end_date:e.finish,sections:{ZoomLevel2:t,ZoomLevel3:t,ZoomLevel4:t,ZoomLevel5:t,ZoomLevel6:t,ZoomLevel7:t},css:"smart-on-gantt "+i,html:"<div><span>"+s+"</span></div>"})}(e)])}function m(e){if(c.hasCustomPermission("Abort_Optimization_Request")&&!(p[e.id]&&p[e.id].aborting||"Completed"===e.status||"Aborted"===e.status||"Failed"===e.status||"Finalizing"===e.status))for(var t in o)if(e.type==o[t])return!0;return!1}return e.all([d.promises.initialPhasedData,i.promises.policies(),t.getOptimizationRequests(),t.callRemoteAction(RemoteActions.getOptimizationsRequestTypes)]).then(function(e){e[1].forEach(function(e){r[e.Id]=e}),o=e[3],e[2].forEach(function(e){l[e.Id]=new OptimizationRequest(e),p[e.Id]={canAbort:m(l[e.Id]),status:l[e.Id].status,objectToScheduled:l[e.Id].objectToScheduled,aborting:!1,progressInterval:null},a(l[e.Id])})}),n.register("optimizationRequests",function(e){e.forEach(function(e){var t=new OptimizationRequest(e);if(l[e.Id]&&l[e.Id].timespan)for(var n=0;n<l[e.Id].timespan.length;n++)scheduler.deleteMarkedTimespan(l[e.Id].timespan[n]);if(l[e.Id]&&"Global Optimization"===l[e.Id].type)for(var i in t)l[e.Id][i]=t[i];else l[e.Id]=t;p[e.Id]?p[e.Id].canAbort=m(t):p[e.Id]={canAbort:m(t),status:t.status,objectToScheduled:t.objectToScheduled,aborting:!1,progressInterval:null},a(t)}),updateViewDebounced()}),{getNumOfActiveOptimizationRequests:function(){var e,t=0;for(e in l)"Completed"!==l[e].status&&"Failed"!==l[e].status&&"Aborted"!==l[e].status&&t++;return t},optimizationRequests:function(){return l},isTerritoryHasInDayOptimizationInProgress:function(e,t,n){if(u[n])for(var i in u[n])if(isIntersect(u[n][i].start,u[n][i].end,e,t))return l[i];return!1},policies:r,OptimizationRequestsProgressStatus:p,generateRequestResultText:function(e){if(e.failureReason&&0<e.failureReason.length)return"User Aborted"===e.failureReason?e.failureDetails:e.failureReason;if(e.type==o.RSO&&s.getResources()[e.resource])return customLabels.rso_optimization_request_for_name.replaceAll(e.resourceName);if(e.type==o.IN_DAY||e.type==o.BGO){var t=[];if(e.territories.forEach(function(e){t.push(e.serviceTerritoryName)}),t=3<t.length?t.length+" "+customLabels.UTterr:t.join(", "),"In Progress"==e.status)return customLabels.optimization_for_terr_in_progress.replaceAll(e.type,t);if("Completed"==e.status)return(e.scheduledAmount||0===e.scheduledAmount?customLabels.optimization_for_terr_completed:customLabels.o2_optimization_for_terr_completed).replaceAll(e.type,t,e.scheduledAmount)}return e.result},calculateIndayProgress:function(n){var e=void 0;if("Completed"==n.status)return p[n.id].status="Completed",setTimeout(function(){if(l[n.id]&&l[n.id].timespan)for(var e=0;e<l[n.id].timespan.length;e++)scheduler.deleteMarkedTimespan(l[n.id].timespan[e]);for(var t=0;t<n.territories.length;t++)u[n.territories[t].serviceTerritory]&&u[n.territories[t].serviceTerritory][n.id]&&delete u[n.territories[t].serviceTerritory][n.id]},2e3),{percent:100,text:customLabels.In_Day_Optimization_Completed};"In Progress"==n.status&&p[n.id]&&"Aborted"==p[n.id].status?e=customLabels.In_Day_Optimization_Aborting:(e=customLabels.In_Day_Optimization_In_Progress,p[n.id].status="In Progress");var t=__gantt.inday,i=t.maxRunTimeSingleService*n.objectToScheduled,s=null!=n.requestProgressStart?(new moment).diff(moment(n.requestProgressStart),"seconds"):0,r=0!==(i=t.maxRuntimeOverall<=i?t.maxRuntimeOverall:i)?s/i*100:0,o=7,a=0;return i<=s&&"In Progress"==n.status&&(o=7+(s-i)/t.maxRunTimeSingleService*.1,a=90),100<=(a=a<90?r:a)&&100<=r?a=100:90<=a&&(o+=.1,a=Math.round(Math.atan(o)/(Math.PI/2)*100*1e3)/1e3),{percent:100!==a?a.toFixed(1):a,text:e}},updateProgressStatus:function(e,t){p[e]?p[e].status=t:p[e]={status:t}},canAbortOR:m,abortOptRequest:function(e){confirm(customLabels.confirm_abort_current_optimization)&&(e.status="Aborting",p[e.id]?(p[e.id].aborting=!0,p[e.id].canAbort=!1):p[e.id]={aborting:!0,canAbort:!1},t.callRemoteAction(RemoteActions.abortOptimizationRequest,e.id).then().catch(function(e){console.warn(e)}))}}}e.$inject=["$q","sfdcService","utils","RegisterService","TimePhasedDataService","StateService","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("OptimizationRequestsService",e)}(),angular.module("serviceExpert").factory("listQuickActionsService",["BundleActions","BundleService","utils","SERVICE_STATUS","SERVICE_CATEGORY","StateService",function(t,n,i,s,r,o){var a=[];function l(e){for(var t=CustomSettings.pinnedStatusesSF.split(","),n=0;n<t.length;n++)if(e===t[n])return 1}i.customActionsPromise.then(function(){var e=i.getCustomActions("list");a.push.apply(a,_toConsumableArray(e))});var c={flagUnflag:function(e){return!0},schedule:function(e){return!e.pinned&&e.status!=s.COMPLETED&&e.statusCategory!=r.CANCELED&&!l(e.status)&&i.hasCustomPermission("Schedule")&&(!n.isActive()||!n.isBundleMember(e))},getCandidates:function(e){return!(!(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)||e.pinned||e.status==s.COMPLETED||e.statusCategory==r.CANCELED||l(e.status)||n.isActive()&&n.isBundleMember(e))},edit:function(e){return!0},reshuffle:function(e){return!e.pinned&&i.hasCustomPermission("Reshuffle")&&(!n.isActive()||!n.isBundleMember(e))},groupNearby:function(e){return e.isScheduled()&&e.latitude&&e.longitude&&i.hasCustomPermission("Group_Nearby")&&(!n.isActive()||!n.isBundleMember(e))},dispatch:function(e){return!(e.pinned||e.status!=s.SCHEDULED||n.isActive()&&n.isBundleMember(e))},gantt:function(e){return!!(e=n.verifyShowSaOnGantt(e))&&e.isScheduled()},map:function(e){return o.isMapEnabled()&&e.latitude&&e.longitude},bundle:function(e){return i.hasCustomPermission("Bundle_Unbundle")&&t.Bundle.canInvoke([e])},unbundle:function(e){return i.hasCustomPermission("Bundle_Unbundle")&&t.Unbundle.canInvoke([e])}},e={shouldShowQuickActionBtn:function(e,t){return!(!t||!c[e])&&c[e](t)},isLastVisibleQuickAction:function(e,t){if(0<a.length)return!1;var n,i=!1;for(n in c)if(i){if(this.shouldShowQuickActionBtn(n,t))return!1}else if(e==n){if(!this.shouldShowQuickActionBtn(e,t))return!1;i=!0}return i}};return e}]);var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(i.push(o.value),!n||i.length!==n);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}angular.module("serviceExpert").factory("servicesService",["$q","$rootScope","$timeout","BundleService","sfdcService","utils","userSettingsManager","monthlyViewHelperService","TimePhasedDataService","ServiceAppointmentLightboxService","kpiCalculationsService","bulkResultsService","SERVICE_STATUS","SERVICE_CATEGORY","StateService","MstResolver","DeltaService","PushServices",function(S,e,t,p,b,y,a,n,w,h,T,g,i,s,L,v,f,m){var r=new Date,A=(r.setDate(r.getDate()+3),window.globalStatuses=i,window.globalCategories=s,{servicesObjects:{},recentlyUsed:{},flagged:flaggedServices,filteredServices:{servicesArray:[]},filter:{searchOnServer:null,advancedFilter:{statusCheckboxs:{New:!0,Assigned:!0,Dispatched:!0,Travel:!0,"On Site":!0,Incomplete:!0},selectedDates:{dueDate:!0,appEnd:!0,end_date:!0},minDate:new Date(Date.now()-6048e5),maxDate:new Date(Date.now()+6048e5),servicePriority:10,jeopardies:!0,violations:!0,unScheduled:!0},selectedFiled:{appEnd:!0,appStart:!0,dueDate:!0,earlyStart:!0,finish:!0,start:!0,display:!0},selectedFilter:a.GetUserSettingsProperty("Selected_List_View__c")||(customPermissions.Service_List_Todo?"Todo":"All"),orderByField:"start",reverse:!1,SearchText:"",endDate:r,currentPage:1,servicesPerPage:200,totalServices:0,totalPages:1}});if(a.GetUserSettingsProperty("Date_Horizon_Properties__c")){var o,l=JSON.parse(a.GetUserSettingsProperty("Date_Horizon_Properties__c"));for(o in l)A.filter.selectedFiled[o]=l[o]}function I(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}y.ganttSettings&&(A.filter.servicesPerPage=parseInt(y.ganttSettings.servicesPerPage)),A.checkRules=function(e){var t,p=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],m=2<arguments.length&&void 0!==arguments[2]?arguments[2]:-1;if(-1===m&&(m=window.__gantt.maxIterationsOfCheckRules),0===(e=e.filter(function(e){return w.serviceAppointments()[e]&&w.serviceAppointments()[e].isScheduled()})).length)return(t=S.defer()).resolve([]),t.promise;for(var h=function(e){var t=window.__gantt.maxResourcesForCheckRules,n=window.__gantt.dayRangeForCheckRules,i=window.__gantt.maxServicesForCheckRules,s={},r=[],o=null,a=null,l={},c=0,d=0,u=0,p=0;e.forEach(function(e){var t=w.serviceAppointments()[e],n=I(t.start);(!o||t.start<o)&&(o=t.start),(!a||a<t.start)&&(a=t.start),s[t.resource]=s[t.resource]||{},s[t.resource][n]=s[t.resource][n]||[],s[t.resource][n].push(e)});for(var a=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1),m=new Date(o);m<a;m.setDate(m.getDate()+1)){var h,g=I(m);for(h in++p===n&&(u++,p=c=d=0,l={}),s){if(s[h][g])if(r[u]=r[u]||[],(v=r[u]).push.apply(v,_toConsumableArray(s[h][g])),i<=(d+=s[h][g].length)&&(u++,p=c=d=0,l={}),!l[h]&&(l[h]=!0,++c===t)){if(d<=i){var v=new Date(m),f=(v.setDate(v.getDate()+1),new Date(v));f.setDate(f.getDate()+n-p+1);for(var S=v;S<f;S.setDate(S.getDate()+1)){var _,b,y=I(S);for(_ in l)if(s[_][y]&&((b=r[u]).push.apply(b,_toConsumableArray(s[_][y])),d+=s[_][y].length),delete s[_][y],i<=d)break;if(i<=d)break}}u++,p=c=d=0,l={}}delete s[h][g]}}return r=r.filter(function(e){return e})}(e),g=[],v={},f=S.defer(),n=0;n<h.length;n++)g.push(S.defer()),g[n].promise.then(function(u){b.checkRules(h[u],L.selectedPolicyId).then(function(e){m--,h[u].forEach(function(e){return v[e]=!0});var t,n,i={};for(t in e){delete v[t];var s=w.serviceAppointments()[t];if(0<e[t].length&&s){for(var r=!1,o=e[t].length;o--;){var a,l,c,d=e[t][o].ViolationString||"";d&&-1<d.indexOf("__WORK-CAPACITY__")?(-1<(d=d.replace("__WORK-CAPACITY__","")).indexOf("PAST_TIME")||(d=d.split("__DATA__"),c=(d=_slicedToArray(d,2))[0],d=d[1],c=c.split("XXX"),a=(c=_slicedToArray(c,3))[0],l=c[1],c=c[2],i[d]?i[d].body=i[d].body+"<div> "+c+"</div>":i[d]={header:a,body:"<div>"+l+"</div><div>"+c+"</div>"}),e[t].splice(o,1)):e[t]&&e[t][o]&&e[t][o].RuleName&&null!=e[t][o].RuleName&&(r=!0)}r&&(s.violations=e[t],p.push(t))}else s&&(s.violations=null)}for(n in i)y.addNotification(i[n].header,i[n].body,function(){});0===m?(T.calculateKpis(),f.resolve(p),g[u+1]&&y.addNotification(window.customLabels.ValidateRulesApiExceededTitle,window.customLabels.ValidateRulesApiExceededMessage)):g[u+1]?g[u+1].resolve(u+1):0===Object.keys(v).length?(T.calculateKpis(),f.resolve(p)):A.checkRules(Object.keys(v),p,m).then(function(e){T.calculateKpis(),f.resolve([].concat(_toConsumableArray(e),_toConsumableArray(p)))})}).catch(function(e){y.addNotification(customLabels.Rule_validation_failed,e.message),f.reject(e),console.warn("rule checking failed"),console.log(e)})});return g[0].resolve(0),f.promise},A.postToChatter=function(e,t){var n=S.defer();return b.callRemoteAction(RemoteActions.postToChatter,e,t).then(function(e){n.resolve(e)}),n.promise},A.sortServicesByPriority=function(e){var t=S.defer();return b.callRemoteAction(RemoteActions.sortServicesByPriority,e).then(function(e){t.resolve(e)}),t.promise},A.autoScheduleService=function(s){var r=1<arguments.length&&void 0!==arguments[1]&&arguments[1],o=S.defer();return null==window.userHasAdminPermissions&&b.callRemoteAction(RemoteActions.userHasAdminPermissions).then(function(e){window.userHasAdminPermissions=e}),b.autoScheduleService(s,L.selectedPolicyId).then(function(e){var t,n,i;e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&(n=e.schedulingResult[0].PartialResults||[],t="",0<n.length)&&(window.userHasAdminPermissions?n.forEach(function(e){t+=customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)+"<br/>"}):t+=customLabels.ContactSysAdmin,""!==t)&&y.addNotification(customLabels.NotAllResult.replace("$0",e.schedulingResult[0].Service.AppointmentNumber),t),e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&e.schedulingResult[0].LongOperationId?v.getUpdates(e.schedulingResult[0].LongOperationId).then(function(e){e.services&&(e.mst=!0,r?f.getDeltaPromise(!1).then(function(e){var t={services:[],absences:[]};e.updatedGanttServices.forEach(function(e){e=w.serviceAppointments()[e.Id];e&&t.services.push(e)}),e.updatedAbsence.forEach(function(e){e=w.resourceAbsences()[e.Id];e&&t.absences.push(e)}),o.resolve(t)}):o.resolve(e))}).catch(function(e){console.error(e),o.reject("string"==typeof e?{eventType:"exception",message:e}:e)}):(e.services=e.deltaResult.updatedGanttServices,e.na=e.deltaResult.updatedAbsence,n="On Demand"!==window.__gantt.checkRulesMode,f.handleDeltaResponse(e.deltaResult,n),e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&(n=e.schedulingResult[0].PartialResults||[],i="",0<n.length)&&(window.userHasAdminPermissions?n.forEach(function(e){i+=customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)+"<br/>"}):i+=customLabels.ContactSysAdmin,""!==i)&&y.addNotification(customLabels.NotAllResult.replace("$0",e.schedulingResult[0].Service.AppointmentNumber),i),function(n,i,s){var r=3<arguments.length&&void 0!==arguments[3]&&arguments[3],o={};n.schedulingResult&&Array.isArray(n.schedulingResult)&&n.schedulingResult[0]&&(o.partialResults=n.schedulingResult[0].PartialResults||[],0===n.services.length)?b.callRemoteAction(RemoteActions.getServicesById,[s]).then(function(e){o.absences=w.updateTimePhaseData(n.na,"na",!r).absences,o.services=w.updateTimePhaseData(n.services,"service",!r).services,(t=o.services).push.apply(t,_toConsumableArray(w.updateTimePhaseData(e,"service",!r).services));var t=a.GetUserSettingsProperty("locations");1===e.length&&-1===t.indexOf(o.services[o.services.length-1].ServiceTerritoryId)&&y.addNotification(customLabels.SchedulingResult,customLabels.WasScheduledToFilteredTeritory.replace("$0",o.services[o.services.length-1].AppointmentNumber)),i.resolve(o),"On Demand"!==window.__gantt.checkRulesMode&&A.checkRules(y.getRelatedServices(s)).then(A.drawViolationsOnGantt)}):(o.absences=w.updateTimePhaseData(n.na,"na",!r).absences,o.services=w.updateTimePhaseData(n.services,"service",!r).services,i.resolve(o),"On Demand"!==window.__gantt.checkRulesMode&&A.checkRules(y.getRelatedServices(s)).then(A.drawViolationsOnGantt))}(e,o,s))}).catch(function(e){var t;e.message&&(e.message.includes("Too many SOQL queries")||e.message.includes("Apex CPU time limit"))?(t="On Demand"!==window.__gantt.checkRulesMode,f.getDelta(t)):console.log(e),o.reject(e)}),o.promise},A.saveChangesToServiceAppointment=function(o,a){var e,t=2<arguments.length&&void 0!==arguments[2]&&arguments[2],l=S.defer(),c=new Date(a.start_date.getTime()+1e3*a.travelTo),d=new Date(a.end_date.getTime()-1e3*a.travelFrom),n=!!a.savedFromScheduleHereAndConsecutive,i=(useLocationTimezone&&(e=w.getIntersectingSrstOffset(a,a.getGanttResource()),i=y.getUserOffset(c),s=y.getUserOffset(d),c.setMinutes(c.getMinutes()+i-e),d.setMinutes(d.getMinutes()+s-e)),A.recentlyUsed[o.id]=!0,a.snapToId&&a.ServiceAppointmentLastModifiedDate--,null),s=null;if(a.snapToId){var r,u,p=[],m=scheduler._events[a.snapToId].end||scheduler._events[a.snapToId].finish;for(r in scheduler._events)r!==a.id&&((u=scheduler._events[r]).resourceId===a.resourceId&&"break"!==u.type&&u.latitude&&isIntersect(u.start_date,u.end_date,scheduler._min_date,m))&&p.push(r);p.sort(function(e,t){return scheduler._events[e].start>scheduler._events[t].start?-1:scheduler._events[e].start<scheduler._events[t].start?1:0}),0<p.length&&(i=scheduler._events[p[0]].latitude,s=scheduler._events[p[0]].longitude)}var h=null;return a.isInO2Territory||!a.isImmidietlyFollow||window.__lockedServicesIds[a.id]||(window.__lockedServicesIds[a.id]=!0,h={id:a.relatedService1||a.relatedService2,isFirst:!!a.relatedService1},w.serviceAppointments()[h.id]&&(window.__lockedServicesIds[h.id]=!0)),b.saveChangesToServiceAppointment(a.id,a.getGanttResource(showSecondarySTMs),a.resource,a.assignedResource,c,d,L.selectedPolicyId,a.scheduleMode,a.snapToId||null,a.snapToType||null,a.snapDirection||null,i,s,n,t).then(function(t){scheduler._events[a.id+"_dummy"]&&scheduler.deleteEvent(a.id+"_dummy");var n,e,i,s,r="On Demand"!==window.__gantt.checkRulesMode;f.handleDeltaResponse(t,r),t.ValidationError?(window.__lockedServicesIds[a.id]=!1,_.isEmpty(o)?l.reject(["",a.eventBeforeDrag,t.ValidationError]):l.reject(["",o,t.ValidationError])):h&&h.id?(r=w.serviceAppointments()[h.id]||{id:h.id,scheduleMode:a.scheduleMode},n=angular.copy(r),e=scheduler._events[a.id],i=h.isFirst?"left":"right",s=y.getServiceDurationInTheory(r)/1e3/60,n.start_date=new Date(r.start),n.end_date=new Date(r.start),n.start_date.setMinutes(e.start.getMinutes()+1),n.end_date.setMinutes(e.start.getMinutes()+s+1),(d=new Date(c)).setMinutes(d.getMinutes()+s),b.saveChangesToServiceAppointment(n.id,a.getGanttResource(showSecondarySTMs),a.resource,null,c,d,L.selectedPolicyId,n.scheduleMode,a.id,"service",i,null,null).then(function(){window.__lockedServicesIds[a.id]=!1,window.__lockedServicesIds[n.id]=!1;var e="On Demand"!==window.__gantt.checkRulesMode;f.handleDeltaResponse(t,e),l.resolve({})})):l.resolve({})}).catch(function(e){window.__lockedServicesIds[a.id]=!1,a.relatedService1&&(window.__lockedServicesIds[a.relatedService1]=!1),a.relatedService2&&(window.__lockedServicesIds[a.relatedService2]=!1),_.isEmpty(o)?l.reject([e,a.eventBeforeDrag,e.message]):l.reject([e,o,e.message]),console.warn(e)}),l.promise},A.handleSnap=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(t.ctrlKey){var i,s=[];for(i in scheduler._events){var r=scheduler._events[i];"service"!==r.type&&"na"!==r.type||-1<r.id.indexOf("dummy")||r.id===e.id||e.resourceId&&-1===r.resourceId.indexOf(e.resourceId)||isIntersect(r.start_date,r.end_date,e.start_date,e.end_date)&&s.push(r)}s.sort(function(e,t){return e.start>t.start?1:e.start<t.start?-1:0}),(n?1:0)<s.length&&(t=new Date(e.start_date),n="right",(t=e.travelTo?t.setSeconds(t.getSeconds()+e.travelTo):t)<s[s[0].isDummy?1:0].start&&(n="left"),s[t=s[t=0].isDummy?1:t])?(e.snapToId=s[t].id,e.snapToType=s[t].type,e.snapDirection=n):(e.snapToId=null,e.snapToType=null,e.snapDirection=null)}},A.unscheduleServices=function(c,e,d,u){var p=S.defer(),t=u?b.unscheduleServicesByLocationsId:b.unscheduleServicesByServicesId,m=null;return u||(m=y.getRelatedServices(c)),t(c,e,d,u).then(function(e){var n,l={};e.nothingToUnschedule?p.resolve(e):(n=S.defer(),e.fslOperation?v.getUpdates(e.fslOperation).then(function(t){console.log(t);var e=t.fslOperation.result.services||c;b.callRemoteAction(RemoteActions.getServicesById,e).then(function(e){w.updateTimePhaseData(e,"service").services,n.resolve({services:e,resourceAbsences:[],resourceCapacities:[],failedResults:t.fslOperation.result.failedResults||{}})})}).catch(function(e){n.reject("string"==typeof e?{eventType:"exception",message:e}:e)}):n.resolve(e),n.promise.then(function(t){l.absences=w.updateTimePhaseData(t.resourceAbsences,"na",!0).absences,l.services=w.updateTimePhaseData(t.services,"service",!0).services,l.capacities=w.updateTimePhaseData(t.resourceCapacities,"capacity").capacities,l.failedResults=t.failedResults,A.drawServicesAndAbsences(l.services,l.absences),u||"On Demand"===window.__gantt.checkRulesMode||A.checkRules(m).then(A.drawViolationsOnGantt),u&&"On Demand"!==window.__gantt.checkRulesMode&&A.checkRules(y.getServicesOfLocations(c,d,u)).then(A.drawViolationsOnGantt);var n,i,s,r,e,o=void 0,a=void 0;1!==c.length||u?(n=[],i=[],u?t.services.forEach(function(e){(t.failedResults[e.Id]&&w.serviceAppointments()[e.Id].isScheduled()?i:n).push(e.Id)}):c.forEach(function(e){(w.serviceAppointments()[e].isScheduled()?i:n).push(e)}),o=customLabels.x_services_were_unscheduled.replaceAll(n.length),a=u?customLabels.x_services_were_unscheduled_out_of_y.replaceAll(n.length,n.length,i.length+n.length):customLabels.x_services_were_unscheduled_out_of_y.replaceAll(n.length,n.length,c.length),0<i.length&&(a+="<div title='"+i.map(function(e){return w.serviceAppointments()[e].name}).join(", ")+"' class='dashedBorder' style='display:inline-block;'> "+customLabels.failed_to_unschedule.replaceAll(i.length)+". "+customLabels.View_services+"</div>"),s=angular.copy(t),r=[],s.services.forEach(function(e){if(u)e.Fields.SchedStartTime||r.push(e);else for(var t=0;t<c.length;t++)e.Id===c[t]&&r.push(e)}),s.services=r,y.addNotification(o,a,function(){var e={success:customLabels.SuccessfullyUnscheduled,fail:customLabels.FailToUnschedule};g.open(s,e)})):(e=w.serviceAppointments()[c[0]].name,a=w.serviceAppointments()[c[0]].isScheduled()?(o=customLabels.Couldnt_unschedule.replaceAll(e),customLabels.Couldnt_unschedule.replaceAll(e)+". "+t.failedResults[c[0]].errorMessage):(o=customLabels.was_unscheduled.replaceAll(e),customLabels.was_unscheduled_successfully.replaceAll(e)),y.addNotification(o,a,function(){A.recentlyUsed[c[0]]=!0,h.open(c[0])})),p.resolve(l)}))}).catch(function(e){p.reject(e),console.warn(e)}),p.promise},A.drawServicesAndAbsences=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:[];if(0!==e.length||0!==t.length||0!==n.length||0!==i.length){var s,r,o={},a={},l={},c={scheduledServices:[],unscheduledServices:[],deletedIds:n};for(r in Array.isArray(e)?e.forEach(function(e){return o[e.id||e.Id]=e instanceof GanttService?e:new GanttService(e)}):o=e,Array.isArray(t)?t.forEach(function(e){return a[e.id||e.Id]=e}):a=t,Array.isArray(i)?i.forEach(function(e){return l[e.id||e.Id]=e}):l=i,s=angular.extend({},o,a,l)){var d=s[r];(!function(e){if((!p.isActive()||!p.isBundleMember(e))&&e.isScheduled())return e.setGanttResource(w.resourcesAndTerritories(),y.generateResourceId),1;return scheduler._events[e.id]&&delete scheduler._events[e.id],0}(d)?c.unscheduledServices:c.scheduledServices).push(d)}if(n.forEach(function(e){return delete scheduler._events[e]}),0<c.scheduledServices.length)scheduler.parse(c.scheduledServices,"json");else for(var u in c)if(Array.isArray(c[u])&&0<c[u].length){updateViewDebounced();break}return c}},A.changeStatus=function(a,l,e,c){var d=4<arguments.length&&void 0!==arguments[4]&&arguments[4],u=S.defer();return(c?b.changeStatusServicesByLocationsId:b.changeStatusServicesByServicesId)(a,l,e,c).then(function(e){var n,o={};e.nothingToDispatch?u.resolve(e):(n=S.defer(),e.fslOperation?v.getUpdates(e.fslOperation).then(function(t){console.log(t);var e=t.fslOperation.result.services||a;b.callRemoteAction(RemoteActions.getServicesById,e).then(function(e){n.resolve({services:e,failedResults:t.fslOperation.result.failedResults||{}})})}).catch(function(e){n.reject("string"==typeof e?{eventType:"exception",message:e}:e)}):n.resolve(e),n.promise.then(function(t){o.services=w.updateTimePhaseData(t.services,"service",d).services,o.failedResults=t.failedResults;var n,i,e,s=void 0,r=void 0;1!==a.length||c?(n=[],i=[],c?t.services.forEach(function(e){(w.serviceAppointments()[e.Id].status!==l?n:i).push(e.Id)}):a.forEach(function(e){(w.serviceAppointments()[e].status===l?i:n).push(e)}),s=customLabels.x_services_were_changed.replaceAll(i.length,y.statusTranslations[l]||l),r=customLabels.x_services_were_changed_out_of_y.replaceAll(i.length,i.length,i.length+n.length,y.statusTranslations[l]||l),0<n.length&&(r+="<div title='"+n.map(function(e){return w.serviceAppointments()[e].name}).join(", ")+"' class='dashedBorder' style='display:inline-block;'> "+customLabels.failed_to_change_status.replaceAll(n.length)+". "+customLabels.View_services+"</div>"),y.addNotification(s,r,function(){var e={success:customLabels.SuccessfullyDispatched,fail:customLabels.FailToDispatch};g.open(t,e)})):(e=w.serviceAppointments()[a[0]].name,w.serviceAppointments()[a[0]].status!==l&&t.failedResults&&!y.isEmpty(t.failedResults)&&(s=customLabels.could_not_change_title.replaceAll(e),r=customLabels.could_not_change_status.replaceAll(e,y.statusTranslations[l],t.failedResults[a[0]].errorMessage),y.addNotification(s,r,function(){h.open(a[0])})),A.recentlyUsed[a[0]]=!0),u.resolve(o)}))}).catch(function(e){u.reject(e),console.warn(e)}),u.promise},A.changePin=function(e,t){var n=S.defer();return b.callRemoteAction(RemoteActions.changePins,e,t).then(function(e){var t=fieldNames.Service_Appointment.pinned;e.forEach(function(e){return w.serviceAppointments()[e.Id].pinned=e[t]}),n.resolve()}).catch(function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message,null,null),n.reject(e),console.warn(e)}),n.promise},A.setInJeopardy=function(e){var t=S.defer();return b.callRemoteAction(RemoteActions.setServiceAppointmentsInJeopardy,e).then(function(e){e.forEach(function(e){return w.serviceAppointments()[e.Id].jeopardy=e[fieldNames.Service_Appointment.InJeopardy__c]}),y.addNotification(customLabels.Update_for_service,customLabels.Appointments_marked.replace("$0",customLabels.In_Jeopardy).replace("$1",e.length)),t.resolve()}).catch(function(e){t.reject(e),console.warn(e)}),t.promise},A.drawViolationsOnGantt=function(e){updateViewDebounced()},A.searchServiceByIdOrName=function(e){var n=S.defer();return b.callRemoteAction(RemoteActions.searchServiceByIdOrName,e).then(function(e){var t;null===e?n.resolve(null):((t=w.updateTimePhaseData(e,"service")).services&&0<t.services.length&&A.drawServicesAndAbsences(t.services),n.resolve(e[0].Id))}).catch(function(e){n.reject(e),console.warn(e)}),n.promise};return A.getServicesById=async function(e){var t=S.defer(),n=[],e=function(e){for(var t=[],n=0;n<e.length;n+=numberOfServicesToLoadInEachBulk)t.push(e.slice(n,n+numberOfServicesToLoadInEachBulk));return t}([].concat(_toConsumableArray(new Set(e))));try{var i=!0,s=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(i=(o=a.next()).done);i=!0){var l=o.value,c=await b.callRemoteAction(RemoteActions.getServicesById,l),d=w.updateTimePhaseData(c,"service"),u=(d.services&&0<d.services.length&&A.drawServicesAndAbsences(d.services),c.map(function(e){return e.Id})),n=[].concat(_toConsumableArray(n),_toConsumableArray(u));m.isPushServiceActive()&&m.updateSession({services:u,operation:m.MESSAGE_OPERATIONS.UPDATE}),n=[].concat(_toConsumableArray(n),_toConsumableArray(c.map(function(e){return e.Id})))}}catch(e){s=!0,r=e}finally{try{!i&&a.return&&a.return()}finally{if(s)throw r}}t.resolve(n)}catch(e){console.warn(e),t.reject(e)}return t.promise},A}]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=(angular.module("serviceExpert").factory("userSettingsManager",["$q",function(s){function n(e){var t,n=s.defer();for(t in e){var i=e[t];e[t]=i+":"+(void 0===i?"undefined":_typeof(i))}return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperties,e,function(e,t){t=JSON.parse(t.result);t.FailedLocations?(bootstrap.loadedUserSettings=t,n.reject(t)):(bootstrap.loadedUserSettings=t,n.resolve())},{buffer:!1,escape:!1,timeout:12e4}),n.promise}return{GetUserSettingsProperty:function(e){return bootstrap.loadedUserSettings[e]},SetUserSettingsProperty:function(e,t){var n=s.defer(),i=void 0===t?"undefined":_typeof(t);return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperty,e,t,i,function(e,t){null!==t.result&&(bootstrap.loadedUserSettings=JSON.parse(t.result),n.resolve())},{buffer:!1,escape:!1,timeout:12e4}),n.promise},SetUserSettingProperties:n,SetUserSettingPropertiesPromise:function(e){var t=s.defer();return n(e),bootstrap.loadedUserSettings=JSON.parse(ev.result),t.promise}}}]),function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(i.push(o.value),!n||i.length!==n);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")});function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}!function(){function e(e,t,i,n,s,p,m,r,o,x,a){var l=void 0,c=[],d=[],u=[],h=[],g={},v={},f={},S={},_={},b={DateTime:"DATETIME",Date:"DATE",String:"STRING",TextArea:"TEXTAREA",Picklist:"PICKLIST",Reference:"REFERENCE",Currency:"CURRENCY",Phone:"PHONE",Double:"DOUBLE"},y={minutes:"Minutes",hours:"Hours",days:"Days"},w={None:"serviceList_new",Scheduled:"serviceList_assigned",Dispatched:"serviceList_dispatched","In Progress":"serviceList_travel","Cannot Complete":"serviceList_couldnt_complete",Completed:"serviceList_completed",Canceled:"serviceList_cancelled"},T=[],L=e.defer(),A={},I=new DOMParser;function C(e){var t;this.name=e[fieldNames.CustomGanttAction.Label],this.className=e[fieldNames.CustomGanttAction.Class],this.order=e[fieldNames.CustomGanttAction.Order],this.permission=e[fieldNames.CustomGanttAction.Permission],this.section=e[fieldNames.CustomGanttAction.Section],this.visualforce=e[fieldNames.CustomGanttAction.Visualforce],e[fieldNames.CustomGanttAction.Icon]&&(e=e[fieldNames.CustomGanttAction.Icon].encodeHTML(),this.icon=(e=e.split(","),t=(e=_slicedToArray(e,2))[0],window.lsdIcons.globalIcon+"/"+t+"-sprite/svg/symbols.svg#"+e[1]))}function k(e,t){t*=864e5;return new Date(e.getTime()+t)}function D(e){R(null,e)||window.open("../"+e,"_blank")}function R(e,t){return!!m.isInConsole()&&(e&&e.preventDefault(),sforce.console.generateConsoleUrl(["/"+t],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):F(t)}),!0)}function F(e){sforce.console.openPrimaryTab(null,"/"+e,!0)}function O(e,t){return moment.tz({year:e.getFullYear(),month:e.getMonth(),date:e.getDate(),hours:e.getHours(),minutes:e.getMinutes()},t)}function M(e){return new Date(e.year(),e.month(),e.date(),e.hours(),e.minutes())}function E(e){return customPermissions[e]}return String.prototype.decodeHTML=function(){var e=I.parseFromString(this,"text/html");return""!==e.documentElement.textContent?e.documentElement.textContent:this},String.prototype.encodeHTML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},i.callRemoteAction(RemoteActions.getCustomActions).then(function(e){e.forEach(function(e){var t=e[fieldNames.CustomGanttAction.Permission];window.customPermissions[t]&&T.push(new C(e))}),L.resolve(T)}),i.callRemoteAction(RemoteActions.getAllFormulaFields).then(function(e){l=e}),i.callRemoteAction(RemoteActions.getWorkOrderPriority).then(function(e){c.push.apply(c,_toConsumableArray(e))}),g.startHour=p.GetUserSettingsProperty("Gantt_View_Start_Hour__c"),null===g.startHour&&(g.startHour=0),g.finishHour=p.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),null===g.finishHour&&(g.finishHour=24),g.filterCandidates=p.GetUserSettingsProperty("Filter_Candidates__c"),null===g.filterCandidates&&(g.filterCandidates=!0),g.servicesPerPage=p.GetUserSettingsProperty("Services_Per_Page__c"),null===g.servicesPerPage&&(g.servicesPerPage="75"),g.resourceRowHeight=p.GetUserSettingsProperty("Resource_Row_Height__c"),null===g.resourceRowHeight&&(g.resourceRowHeight="medium"),g.capacityDuration=p.GetUserSettingsProperty("View_Capacity_Type__c"),null===g.capacityDuration&&(g.capacityDuration="Day"),g.backHorizon=p.GetUserSettingsProperty("Scheduling_horizon_limit__c"),null===g.backHorizon&&(g.backHorizon=14),g.loadOnToday=p.GetUserSettingsProperty("Load_On_Today__c"),null===g.loadOnToday&&(g.loadOnToday=!0),g.absenceOverlapHeight=p.GetUserSettingsProperty("Absence_Overlap_Height__c"),g.absenceOverlapHeight||(g.absenceOverlapHeight="partial"),g.leftPanel=p.GetUserSettingsProperty("DefaultLeftPanel__c")||"salist",g.serviceColoring=p.GetUserSettingsProperty("ServiceListColoring__c")||"default",i.callRemoteAction(RemoteActions.getCustomizationFiles).then(function(e){var t,n="";__gantt.communityNetworkId&&window.location.href.includes("apex")&&(n=window.location.href.split("apex")[0]),e&&e.CSS&&((t=jQuery("<link>")).attr({rel:"stylesheet",type:"text/css",href:n+e.CSS}),$("head").append(t)),e&&e.JSPWR?((t=document.createElement("script")).src=e.JSPWR,t.type="text/javascript",document.head.appendChild(t)):e&&e.JS&&$.ajax({url:n+e.JS,dataType:"script"})}),window.openConsoleTabFromModal=function(t){m.isInConsole()&&sforce.console.generateConsoleUrl([t],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):F(t)})},String.prototype.replaceAll=function(){for(var e=this,t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var s=0;s<n.length;s++)e=e.replace("$"+s,n[s]);return e},i.callRemoteAction(RemoteActions.getStatusFlow).then(function(e){if(e)for(var t in angular.merge(v,e),v)v[t]=v[t].sort()}).catch(function(e){console.warn("could not get status flow :("),console.log(e)}),i.callRemoteAction(RemoteActions.getStatusTranslations).then(function(e){angular.merge(f,e),window.statusTranslations=f}).catch(function(e){console.warn("could not get status translations :("),console.log(e)}),i.callRemoteAction(RemoteActions.getStatusesWithCategories).then(function(e){for(var t in angular.merge(_,e),_)A[t]=w[_[t]]||"serviceList_other"}).catch(function(e){console.warn("could not get status with categories :("),console.log(e)}),i.callRemoteAction(RemoteActions.getStatuses).then(function(e){angular.merge(S,e)}).catch(function(e){console.warn("could not get status :("),console.log(e)}),{getFilteredLocations:function(){var e=p.GetUserSettingsProperty("locations");return e||[]},getSVGIconHTMLCustom:function(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use width="17px" height="17px" xlink:href="'+e+'"></use></svg>'},getSVGIconHTML:function(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon '+(1<arguments.length&&void 0!==arguments[1]?arguments[1]:null)+'"><use xlink:href="'+e+'"></use></svg>'},getRelatedServices:function(e,t){var n,i,s,r=Array.isArray(e)?e.concat():[e],o=(n=Number.MAX_VALUE,i=Number.MIN_VALUE,r.forEach(function(e){var t,e=scheduler._events[e];e&&((t=e.start_date)<n&&(n=t),i<(t=e.end_date))&&(i=t)}),i=new Date(Date.parse(i)+6048e5),{minStartDate:n=new Date(Date.parse(n)-6048e5),maxEndDate:i});for(s in t+=r.reduce(function(e,t){return scheduler._events[t]?e+","+scheduler._events[t].resource:e},""),scheduler._events){var a=scheduler._events[s];("service"===a.type&&-1!=t.indexOf(a.resource)||a.relatedService1&&-1!=e.indexOf(a.relatedService1)||a.relatedService2&&-1!=e.indexOf(a.relatedService2))&&isIntersect(a.start_date,a.end_date,o.minStartDate,o.maxEndDate)&&(r.push(a.id),a.relatedTo&&r.push(a.relatedTo),a.relatedFather&&r.push(a.relatedFather),a.relatedService2&&r.push(a.relatedService2),a.relatedService1)&&r.push(a.relatedService1)}return r},getServicesOfLocations:function(e,t,n){var i,s=[],r=(e=Array.isArray(e)?e:[e]).join(",");for(i in scheduler._events){var o=scheduler._events[i];"service"===o.type&&r.indexOf(o.serviceTerritory)&&isIntersect(o.start_date,o.end_date,t,n)&&(s.push(o.id),o.relatedTo&&s.push(o.relatedTo),o.relatedFather&&s.push(o.relatedFather),o.relatedService2&&s.push(o.relatedService2),o.relatedService1)&&s.push(o.relatedService1)}return s},getServicesBetweenDates:function(e,t){var n,i=[];for(n in scheduler._events){var s=scheduler._events[n];"service"===s.type&&isIntersect(s.start_date,s.end_date,e,t)&&(i.push(s.id),s.relatedTo&&i.push(s.relatedTo),s.relatedFather&&i.push(s.relatedFather),s.relatedService2&&i.push(s.relatedService2),s.relatedService1)&&i.push(s.relatedService1)}return i},getServiceDuration:function(e){var t=0;if(e.resourceBeforeDrag=e.resourceId,e.eventBeforeDrag=angular.copy(e),e.isScheduled())t=e.finish.getTime()-e.start.getTime();else switch(e.durationType){case y.minutes:t=60*e.estDuration*1e3;break;case y.hours:t=60*e.estDuration*60*1e3;break;case y.days:t=24*e.estDuration*60*60*1e3;break;default:t=6e4}return t},safeApply:function(e,t){var n=e.$root.$$phase;"$apply"===n||"$digest"===n?t&&"function"==typeof t&&t():e.$apply(t)},formatDayToString:function(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()},showOnGantt:function(e){if("MonthlyView"===scheduler._mode)alert(customLabels.serviceCantDisplayMonthlyMsg);else{var t=scheduler._events[e],n=getMinAndMaxHoursToDisplay(),i=t.start_date.getHours(),s=t.end_date.getHours();if((scheduler._min_date>t.start||t.start>scheduler._max_date)&&scheduler.setCurrentView(new Date(t.start)),0===t.end_date.getHours()&&t.end_date.getDate()>t.start_date.getDate()&&(s=24),"ZoomLevel2"!==scheduler._mode&&(n.min>s||n.max<=i))alert(customLabels.serviceCantDisplayMsg);else{for(var r=!0,o=scheduler.serverList("resources"),a=0;a<o.length;a++)for(var l=0;l<o[a].children.length;l++)if(-1<t.resourceId.indexOf(o[a].children[l].key)){r=!1;break}if(r)alert(customLabels.resource_filtered_out);else{if(m.areContractorsSupported()){var c=!0;if(t.resourceContractor){for(var d=scheduler.getEvents(t.start,t.finish),u=0;u<d.length;u++)if(d[u].resourceId===t.resourceId&&"contractorcapacity"===d[u].type&&d[u].timePeriod===p.GetUserSettingsProperty("View_Capacity_Type__c")){t=d[u],e=d[u].id,c=!1;break}if(c)return void alert(customLabels.is_assigned_to_contractor.replaceAll(t.name,t.resourceName)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}}try{scheduler._els.dhx_cal_data[0].scrollTop=0,t.showEventPopupEffect=!0,scheduler.showEvent(e)}catch(e){scheduler.callEvent("onAfterEventDisplay",[t,scheduler._mode])}}}}},openConsoleTab:R,trust:function(e){return"string"==typeof e?t.trustAsHtml(e):null},openLink:function(e,t){t.Type==b.Reference&&D(e[t.JsAPIName.replace("__r","__c")])},openSObjectLink:D,openLightningSubtab:function(t){sforce.console.getEnclosingPrimaryTabId(function(e){e=e.id;sforce.console.openSubtab(e,"/"+t,!0)})},openLightningPrimaryTab:F,getServiceInfoRowClass:function(e){var t;if(e)return t={},e.Type==b.Reference&&(t.resourceOnServiceTT=!0),t},isEmpty:function(e){return!Object.keys(e).length},generateResourceId:function(t,n){return Array.isArray(t)&&!Array.isArray(n)?t.map(function(e){return e+"_"+n}).join(","):Array.isArray(t)&&Array.isArray(n)?t.map(function(e,t){return e+"_"+n[t]}).join(","):Array.isArray(t)||Array.isArray(n)?!Array.isArray(t)&&Array.isArray(n)?n.map(function(e){return t+"_"+e}).join(","):void 0:t+"_"+n},addNotification:function(e,t,n,i){var s=4<arguments.length&&void 0!==arguments[4]&&arguments[4],r=(void 0===i&&(i=null),new Date);h.push({title:e,text:t,action:function(){n(i),this.show=!s},when:new Date(r.getTime().valueOf()+60*r.getTimezoneOffset()*1e3),unread:!0,param:i,show:!0})},addDaysToDate:k,setDatesByStartAndMode:function(e){var t=new Date(e);switch(scheduler._mode){case"ZoomLevel2":case"ZoomLevel3":t=k(t,1);break;case"ZoomLevel4":t=k(t,2);break;case"ZoomLevel5":t=k(t,3);break;case"ZoomLevel6":t=k(t,7);break;case"ZoomLevel7":t=k(t,14);break;case"MonthlyView":t=k(t,30);break;case"MTDView":t=k(t,35);break;case"LongView":t=k(t,scheduler.matrix.LongView.x_size)}return{start:new Date(e),end:t}},sortByTime:function(e,t){return e.start>t.start?1:e.start.getTime()==t.start.getTime()?0:-1},getReports:function(){var n=e.defer();return i.callRemoteAction(RemoteActions.getReportsWithGeolocationCols).then(function(e){if(e){for(var t=0;t<e.length;t++)d.push(e[t]);n.resolve(d)}else n.resolve(null)}).catch(function(e){return n.reject(e)}),n.promise},getPolygons:function(){var n=e.defer();if(E("Polygons_view"))return i.getPolygons().then(function(e){if(e){for(var t=0;t<e.length;t++)u.push(e[t]);n.resolve(u)}else n.resolve(null)}),n.promise;n.resolve(null)},intersectDates:function(e,t){for(var n={},i=[],s=(e.start>=t.start&&e.start<t.finish?(n.start=e.start,e.finish<t.finish?n.finish=e.finish:(n.finish=t.finish,i.push({start:t.finish,finish:e.finish,isStart:!1}))):t.start<e.finish&&e.finish<=t.finish?(t.start<e.start?n.start=e.start:(n.start=t.start,i.push({start:e.start,finish:t.start,isStart:!0})),n.finish=e.finish):e.start<t.start&&t.finish<e.finish?(n=angular.copy(t),i.push({start:e.start,finish:t.start,isStart:!0}),i.push({start:t.finish,finish:e.finish,isStart:!1})):n=null,[]),r=0;r<i.length;r++){var o=i[r];o.start.getTime()!=o.finish.getTime()&&s.push(o)}return{intersection:n,remainderFrom1:s}},getCSSClassByStatusCategory:function(e,t){switch(e){case t.NONE:return"serviceList_new";case t.SCHEDULED:return"serviceList_assigned";case t.DISPATCHED:return"serviceList_dispatched";case t.IN_PROGRESS:return"serviceList_travel";case t.COMPLETED:return"serviceList_completed";case t.COULD_NOT_COMPLETE:return"serviceList_couldnt_complete";case t.CANCELED:return"serviceList_cancelled";default:return"serviceList_other"}},getCssClassForContextBasedOnStatus:function(e){return A[e]},fieldsTypes:b,ganttSettings:g,butlerNotifications:function(){return h},getIdsOfSObjectsAbsence:function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n]);return t},showServiceList:{show:!0},checkBoxFields:function(){return l},woPriorities:c,durationTypes:y,statusFlow:v,statusTranslations:f,statuses:S,statusesWithCategories:_,convertDateBetweenTimeZones:function(e,t,n){return M(O(e,t).tz(n))},convertDtToMomentDt:O,convertMomentDtToDt:M,getUserOffset:function(e){return-moment.tz.zone(userTimeZone).utcOffset(O(e,userTimeZone).valueOf())},getLocationOffset:function(e,t){return t?(t=o.territories()[t],t=o.getOperatingHours()[t.operatingHours].timezone,-moment.tz.zone(t).utcOffset(O(e,t).valueOf())):null},setMapCloseButtonPosition:function(){s(function(){var e=$(".gm-style-iw");$($(".gm-ui-hover-effect")[0]).css({right:"0px",top:"0px",opacity:1}),e.next().css({right:"12px",left:"",opacity:1})},0)},getIdsOfSObjects:function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n].id);return t},hoursMinutes:function(e,t,n,i){return e<60?i.replaceAll([e]):(i=e%60,e=Math.round(e/60),0==i?n.replaceAll([e]):t.replace("$0",e).replace("$1",i))},hasCustomPermission:E,formatDateWithDayOfWeek:function(e){(e=new Date(e)).setHours(12);try{return e.toLocaleDateString(userLocale.replace("_","-"),{weekday:"short",month:"long",day:"numeric",year:"numeric"})}catch(e){return null}},isLightning:function(){return"undefined"!=typeof sforce&&sforce&&!!sforce.one},getCustomActions:function(t){return T.filter(function(e){return e.section===t})},customActionsPromise:L.promise,removeFSLNamespace:function(e){return 0===e.indexOf("FSL__")?e.substr(5,e.length):e},crewsFilter:!1,generateDateKey:function(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()},isUseEdge:function(e){return __gantt[e].useEdge},getColorHexByCategory:function(e){switch(e){case a.NONE:return"#a5e2d6";case a.SCHEDULED:return"#F9D058";case a.DISPATCHED:return"#8DD8FA";case a.IN_PROGRESS:return"#D68EF9";case a.COMPLETED:return"#95d155";case a.COULD_NOT_COMPLETE:return"#f58556";case a.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}},getRelevantDataForDraggingService:function(e){var t={},n=(t.label=e.ganttLabel||e.name,t.estimatedDurationText=e.estDuration+" "+e.durationType,getMinAndMaxHoursToDisplay()),i=new Date(scheduler._min_date.getTime()+1e3*n.min*60*60),n=new Date(scheduler._min_date.getTime()+1e3*n.min*60*60),e=(e.durationType?e.durationType===y.minutes?n.setMinutes(n.getMinutes()+e.estDuration):e.durationType===y.hours?n.setMinutes(n.getMinutes()+Math.floor(60*e.estDuration)):e.durationType===y.days&&n.setMinutes(n.getMinutes()+Math.floor(60*e.estDuration*24)):n.setMinutes(n.getMinutes()+60),getXPositionOfEvent({start_date:i,end_date:n},!1,scheduler.matrix[scheduler._mode])),i=getXPositionOfEvent({start_date:i,end_date:n},!0,scheduler.matrix[scheduler._mode]);return t.meetingLengthInPx=i-e+4,t},getSchedulingPolicyObject:function(e){for(var t=0;t<m.policies.length;t++)if(m.policies[t].Id===e)return m.policies[t]},getServiceDurationInTheory:function(e){switch(e.durationType){case y.minutes:return 60*e.estDuration*1e3;case y.hours:return 60*e.estDuration*60*1e3;case y.days:return 24*e.estDuration*60*60*1e3;default:return 6e4}},isUrlImg:function(e){return t=e,!!new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(t)&&null!==e.match(/\.(jpeg|jpg|gif|png|svg)$/);var t},isFormulaForImage:function(e){return e&&e.startsWith("<img")&&(e=e.split(" ")[1]).includes("src=")?e.substr(5,e.length-6):null},escapeResourceName:function(e){return e=(e=(e=e.encodeHTML()).split("'").join("&lsquo;")).split('"').join("&ldquo;")},shouldFilterServiceFromList:function(e,t,n){if(!e.isScheduled()){if(!n&&!e.ServiceTerritoryId)return!0;if(e.ServiceTerritoryId&&!t.includes(e.ServiceTerritoryId))return!0}return!1}}}e.$inject=["$q","$sce","sfdcService","$rootScope","$timeout","userSettingsManager","StateService","kpiCalculationsService","ResourcesAndTerritoriesService","$injector","SERVICE_CATEGORY"],angular.module("serviceExpert").factory("utils",e)}(),angular.module("serviceExpert").factory("sfdcService",["$q","$rootScope","userSettingsManager","$injector",function(_,u,s,b){var y={servicesArray:[],servicesObjs:{},activeRequests:{active:0},activeRuleCheckRequests:{active:0},serviceChangesQueue:[],resourceOperationsCounter:{}},l=(window.__isCheckingRules=function(){return!!y.activeRuleCheckRequests.active},window.Visualforce.remoting.timeout=12e4,{}),c={};function w(){return s.GetUserSettingsProperty("locations")||[]}function d(){return JSON.parse(s.GetUserSettingsProperty("Show_Orphan_Services__c"))}return c[RemoteActions.GetTimePhasedObjects]=!0,c[RemoteActions.GetResourcesAndTerritories]=!0,c[RemoteActions.getDelta]=!0,c[RemoteActions.getReportsWithGeolocationCols]=!0,c[RemoteActions.collectMetricsForSplunk]=!0,c[RemoteActions.collectViewsForSplunk]=!0,c[RemoteActions.getOptimizationRequests]=!0,y.callRemoteAction=function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var s=e===RemoteActions.getDelta,r=e in l,o=!(e in c),a=_.defer(),e=[e].concat(n).concat(function(e,t){s||y.activeRequests.active--,t.status?a.resolve(e):a.reject(t)}).concat({buffer:o,escape:r,timeout:12e4}).map(function(e){return void 0===e?null:e});return s||y.activeRequests.active++,window.Visualforce.remoting.Manager.invokeAction.apply(window.Visualforce.remoting.Manager,e),a.promise},y.checkRules=function(e,t){var n=_.defer();return y.activeRuleCheckRequests.active++,u.policy||(u.policy=null),t=t||u.policy,window.Visualforce.remoting.Manager.invokeAction(RemoteActions.checkRules,e,t,function(e,t){y.activeRuleCheckRequests.active--,t.status?n.resolve(e):n.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),n.promise},y.getOptimiztionRequestsUpdate=function(e){return y.callRemoteAction(RemoteActions.getOptimiztionRequestsUpdate,e,w())},y.getGanttServiceOnAssignedResourceUpdate=function(e){return y.callRemoteAction(RemoteActions.getGanttServiceOnAssignedResourceUpdate,e,w())},y.getUpdatedAbsences=function(e){return y.callRemoteAction(RemoteActions.getUpdatedAbsences,e,w())},y.getDeletedAbsences=function(e){return y.callRemoteAction(RemoteActions.getDeletedAbsences,e,w())},y.getUpdatedServices=function(e,t){return y.callRemoteAction(RemoteActions.getUpdatedServices,e,t,w())},y.getUpdatedResourceCapacities=function(e){return y.callRemoteAction(RemoteActions.getUpdatedResourceCapacities,e,w())},y.getLivePositionsStreaming=function(e){return y.callRemoteAction(RemoteActions.getLivePositionsStreaming,e,w())},y.getLivePositions=function(){return y.callRemoteAction(RemoteActions.getLivePositions,w())},y.getDelta=function(e,t,n){var i;return u.isOptimizationViewer?((i=_.defer()).resolve({updateTime:(new Date).getTime()-15e3,oldTime:null,updatedAbsence:[],deletedAbsence:[],updatedCapacities:[],deletedCapacities:[],updatedGanttServices:[],deletedGanttServices:[],updatedLivePositions:[],optimizationRequests:[]}),i.promise):y.callRemoteAction(RemoteActions.getDelta,e,w(),t,n)},y.getSlots=function(e,t){var i=_.defer();return y.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getSlots,e,t,function(e,t){var n={};n.value=e,n.eventType=t.type,"exception"===t.type&&(n.event=t,i.resolve(n),--y.activeRequests.active),t.status?i.resolve(n):i.reject(t),--y.activeRequests.active},{buffer:!0,escape:!0,timeout:12e4}),i.promise},y.getPolygons=function(){return y.callRemoteAction(RemoteActions.getPolygons,w())},y.autoScheduleService=function(e,t){return y.callRemoteAction(RemoteActions.autoScheduleService,e,t,w())},y.unscheduleServicesByServicesId=function(e,t){return t=t||s.GetUserSettingsProperty("Gantt_Policy__c"),y.callRemoteAction(RemoteActions.unscheduleServicesByServicesId,e,t,!1)},y.unscheduleServicesByLocationsId=function(e,t,n,i){return t=t||s.GetUserSettingsProperty("Gantt_Policy__c"),y.callRemoteAction(RemoteActions.unscheduleServicesByLocationsId,e,t,n,i)},y.GetResourcesAndTerritories=function(e){return y.callRemoteAction(RemoteActions.GetResourcesAndTerritories,e||w(),!0,!1)},y.GetTimePhasedObjects=function(e,t){var n,i=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],s=3<arguments.length&&void 0!==arguments[3]&&arguments[3],r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null,o=5<arguments.length&&void 0!==arguments[5]?arguments[5]:null,a=6<arguments.length&&void 0!==arguments[6]?arguments[6]:null,l=7<arguments.length&&void 0!==arguments[7]?arguments[7]:null,c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:null,d=9<arguments.length&&void 0!==arguments[9]&&arguments[9];return u.isOptimizationViewer?((n=_.defer()).resolve({services:[],resourceAbsences:[],resourceCapacities:[],serviceCrewMembers:[],shifts:[],holidays:[],resourcesAndTerritories:[]}),n.promise):y.callRemoteAction(RemoteActions.GetTimePhasedObjects,e,t,w(),i,s,r,o,a,maxServicesToLoadEachBulkInGantt,maxAbsencesToLoadEachBulkInGantt,maxShiftsToLoadEachBulkInGantt,l,c,d)},y.loadServicesInBulk=function(e,t,n,i,s,r,o){var a;return u.isOptimizationViewer?((a=_.defer()).resolve({ganttServiceAppointments:[],stms:[],remainingCount:0}),a.promise):y.callRemoteAction(RemoteActions.loadServicesInBulk,e,w(),d(),t,n,i,s,r,o)},y.saveChangesToAbsence=function(e,t,n,i,s,r){return y.callRemoteAction(RemoteActions.saveChangesToAbsence,e,t,n,i,s,r,6<arguments.length&&void 0!==arguments[6]?arguments[6]:null,7<arguments.length&&void 0!==arguments[7]?arguments[7]:null,8<arguments.length&&void 0!==arguments[8]?arguments[8]:null,9<arguments.length&&void 0!==arguments[9]?arguments[9]:null,w())},y.saveChangesToServiceAppointment=function(e,n,i,t,s,r,o,a,l,c,d,u,p){var m=13<arguments.length&&void 0!==arguments[13]&&arguments[13],h=14<arguments.length&&void 0!==arguments[14]&&arguments[14],g=(y.resourceOperationsCounter[n]=y.resourceOperationsCounter[n]||0,i&&(y.resourceOperationsCounter[i]=y.resourceOperationsCounter[i]||0),_.defer()),v=_.defer();y.resourceOperationsCounter[n]?y.serviceChangesQueue.push({deferred:v,srcResource:i,destResource:n,valid:!0}):i&&!y.resourceOperationsCounter[i]?(y.resourceOperationsCounter[n]++,y.resourceOperationsCounter[i]++,v.resolve()):i&&y.resourceOperationsCounter[i]?y.serviceChangesQueue.push({deferred:v,srcResource:i,destResource:n,valid:!0}):i||(y.resourceOperationsCounter[n]++,v.resolve());var f=b.get("TimePhasedDataService").serviceAppointments()[e],S=!1;return f&&(S=!!f.fromGetCandidateFlow),v.promise.then(function(){y.activeRequests.active++,Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToServiceAppointment,e,n,t,s,r,o,a,l,c,d,u,p,w(),m,S,h,function(e,t){y.activeRequests.active--,i&&y.resourceOperationsCounter[i]--,y.resourceOperationsCounter[n]--,y.serviceChangesQueue.forEach(function(e){!e.valid||y.resourceOperationsCounter[e.destResource]||(!e.srcResource||y.resourceOperationsCounter[e.srcResource])&&e.srcResource||(y.resourceOperationsCounter[e.srcResource]++,y.resourceOperationsCounter[e.destResource]++,e.valid=!1,e.deferred.resolve())}),t.status?g.resolve(e):g.reject(t)},{buffer:!1,escape:!1,timeout:12e4})}),g.promise},y.changeStatusServicesByServicesId=function(e,t){return y.callRemoteAction(RemoteActions.changeStatusServicesByServicesId,e,t,!1)},y.changeStatusServicesByLocationsId=function(e,t,n,i){return y.callRemoteAction(RemoteActions.changeStatusServicesByLocationsId,e,t,n,i)},y.getOptimizationRequests=function(){return y.callRemoteAction(RemoteActions.getOptimizationRequests,w(),d())},y.runFillInSchedule=function(e,t,n){return y.callRemoteAction(RemoteActions.runFillInSchedule,e,t,n)},y.runFixOverlaps=function(e,t,n){return y.callRemoteAction(RemoteActions.runFixOverlaps,e,t,n)},y.getFslOperation=function(e){return y.callRemoteAction(RemoteActions.getFslOperation,e,resourceId,policyId)},y.isOptimizationViewer=function(){return u.isOptimizationViewer},y}]),!function(){function e(n,i,s,r,o,a,t){var l=null;function c(){var e;a.getStreamingActiveState()||(e="On Demand"!==window.__gantt.checkRulesMode,t.getDelta(e))}function d(){window.__updateGantt=null,a.setLightBoxStatus(!1),l.$destroy()}function u(e){e!==l.selectedTab&&(l.selectedTab=e)}return{open:function(e){(l=n.$new(!0)).lightboxAbsence=i.resourceAbsences()[e],l.selectedTab="details",l.urls={chatter:s.trustAsResourceUrl(customAbsenceChatterPage+"?id="+e+"&isdtp=p1").toString(),details:s.trustAsResourceUrl(customAbsencePage+"?id="+e).toString()},l.changeTab=u,l.closeLightbox=d,l.chatterAvailable=fieldTrackingEnabled.absence,l.openConsoleTab=o.openConsoleTab;var t=angular.element('<div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="AbsenceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="AbsenceLightboxHeader">\n\n                            <svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                            <h1 class="lightboxHeader">\n                                <i ng-show="lightboxAbsence.type == \'na\'">'+customLabels.NA+":</i>\n                                <i ng-show=\"lightboxAbsence.type == 'break'\">"+customLabels.Break+':</i>\n                                {{ lightboxAbsence.name }}\n                            </h1>\n\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'details\')" ng-class="{lightboxSelectedTab: selectedTab == \'details\'}">\n                                '+customLabels.Details+'\n                            </button>\n\n                            <button fsl-tab-switch role="tab" ng-show="chatterAvailable" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </button>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxAbsence.id)" target="_blank" href="../{{ lightboxAbsence.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'details\'" ng-src="{{ urls.details }}"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'chatter\'" ng-src="{{ urls.chatter }}" ng-if="chatterAvailable"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>");t.find("#AbsenceLightbox").draggable({containment:"document",handle:"#AbsenceLightboxHeader"}),a.setLightBoxStatus(),l.$on("$destroy",function(){return t.remove()}),l.$on("keypress",function(e,t){27==t.which&&l.$evalAsync(l.closeLightbox)}),window.__updateGantt=c,r(t)(l),o.safeApply(l,function(){angular.element("body").append(t)})}}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","StateService","DeltaService"],angular.module("serviceExpert").factory("AbsenceLightboxService",e)}(),!function(){function e(c,d,u,p,e,m){var i={};return{saveChangesToAbsence:function(n,e,t){var i,s,r,o=c.defer(),a=new Date(e.start_date.getTime()+1e3*e.travelTo),l=new Date(e.end_date.getTime()-1e3*e.travelFrom);return useLocationTimezone&&(i=d.getIntersectingSrstOffset(e,e.getGanttResource()),s=m.getUserOffset(a),r=m.getUserOffset(l),a.setMinutes(a.getMinutes()+s-i),l.setMinutes(l.getMinutes()+r-i)),u.saveChangesToAbsence(e.id,e.getGanttResource(),t,a,l,null,e.ganttLabel,e.snapToId||null,e.snapToType||null,e.snapDirection||null).then(function(e){var t="On Demand"!==window.__gantt.checkRulesMode;p.handleDeltaResponse(e,t),e.error?o.reject([e,n]):o.resolve()}).catch(function(e){o.reject([e,n])}),o.promise},saveNewAbsence:function(e,t){var n,i,s,r=c.defer(),o=(useLocationTimezone&&(n=d.getIntersectingSrstOffset(e,e.resource),i=m.getUserOffset(e.start_date),s=m.getUserOffset(e.end_date),e.start_date.setMinutes(e.start_date.getMinutes()+i-n),e.end_date.setMinutes(e.end_date.getMinutes()+s-n)),e.type="na",e.isDummy=!0,scheduler.addEvent(e));return u.saveChangesToAbsence(null,e.resource,t,e.start_date,e.end_date,e.absenceType,e.ganttLabel,e.snapToId||null,e.snapToType||null,e.snapDirection||null).then(function(e){scheduler.deleteEvent(o);var t="On Demand"!==window.__gantt.checkRulesMode;p.handleDeltaResponse(e,t),e.error?r.reject(e):r.resolve()}).catch(function(e){scheduler.deleteEvent(o),r.reject(e)}),r.promise},deleteAbsence:function(e){var t=c.defer();return u.callRemoteAction(RemoteActions.deleteResourceAbsence,e).then(function(e){e?(e="On Demand"!==window.__gantt.checkRulesMode,p.getDelta(e)):m.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.Failed_To_Delete_Break,null,null)}).catch(function(e){t.reject(e)}),t.promise},getEmployeeAbsenceTypes:function(){var t=c.defer();try{sforce.connection.sessionId=sessionId;var e=sforce.connection.describeLayout("ResourceAbsence"),n={};e.recordTypeMappings.forEach(function(e){"Non_Availability"===e.developerName&&e.picklistsForRecordType.forEach(function(e){"Type"===e.picklistName&&(e=e.picklistValues,(e=Array.isArray(e)?e:[e]).forEach(function(e){n[e.value]=e.label}))})}),i=n,t.resolve(i)}catch(e){u.callRemoteAction(RemoteActions.getEmployeeAbsenceTypes).then(function(e){e&&(i=e,t.resolve(i))}).catch(function(e){t.reject(e)})}return t.promise}}}e.$inject=["$q","TimePhasedDataService","sfdcService","DeltaService","servicesService","utils"],angular.module("serviceExpert").factory("AbsencesService",e)}(),!function(){function e(t,n,i,s,r){var o=null,a=void 0;function l(e){r.setLightBoxStatus(!1),o.$destroy()}function c(){console.log("Entered applyIntroClicked. hideIntroModal is: "+o.hideIntroModal),s.SetUserSettingsProperty("HideSchedulingAgentIntro__c",o.hideIntroModal),l()}return{open:function(){var e;if((o=i.$new(!0)).deffered=t.defer(),a=o.deffered,o.hideIntroModal=s.GetUserSettingsProperty("HideSchedulingAgentIntro__c"),!o.hideIntroModal)return o.einstein=staticResources.ASAIntro_astro_png,o.applyIntroClicked=c,o.$on("keypress",function(e,t){27==t.which&&(o.$evalAsync(o.closeLightbox),a.reject("closed"))}),(e=angular.element('\n            <div class="LightboxBlackContainer" id="ASAIntroPopup" >\n                <div id="ASALightbox" class="LightboxContainer introModalWindow " >\n                    <div class="lightboxHeaderContainer introHeaderContainer" id="HideIntroModalLightboxHeader">\n                        <svg ng-click="closeLightbox(false)" aria-hidden="true" class="slds-icon CloseLightbox" fsl-key-press tabindex="0">\n                            <use xlink:href="'+lsdIcons.close+'"></use>\n                        </svg>\n                            \x3c!-- Icon on the left side --\x3e\n                         <svg aria-hidden="true" class="slds-icon introHeaderIcon">\n                            <use xlink:href="'+lsdIcons.sparkles+'"></use>\n                          </svg>\n                        <h1 class="introHeaderText">'+customLabels.ASAIntroModalTitle+'</h1>\n                    </div>\n                    \n                    \n                     <div class="lightboxContentContainer">\n                        \x3c!-- First Row: The ASAIntroModalBodyText1 --\x3e\n                        <div>\n                            <label class="onboardingText" >\n                                '+customLabels.ASAIntroModalBodyText1+'\n                            </label>\n                        </div>\n\n                    \n                        \x3c!-- Second Row: Image on the left and Text (list) on the right --\x3e\n                        <div class="slds-grid slds-m-top_large" style="display: flex;">\n                            \x3c!-- Image on the left side --\x3e\n                            <div class="slds-col slds-size_1-of-3 slds-p-right_large slds-flex slds-align-top">\n                                <img  class="einstein-dd-onboarding-image"  src={{einstein}} alt="'+customLabels.ASAIntroModalImageAlt+'" />\n                            </div>\n                    \n                            \x3c!-- Text content on the right side --\x3e\n                            <div class="slds-col slds-size_2-of-3 slds-text-align_left slds-p-left_large slds-flex slds-flex_column"  style="margin-top: 16px;">\n                                <span>\n                                    <label class="onboardingBoldText" >\n                                    '+customLabels.ASAIntroModalBodyText2+'</label>\n                                </span>\n                                \x3c!--style="list-style-type: decimal; padding-left: 20px; line-height: 20px;"--\x3e\n                                <ol class="onboardingText" >\n                                    <li>'+customLabels.ASAIntroModalBodyOl1+"</li>\n                                    <li>"+customLabels.ASAIntroModalBodyOl2+"</li>\n                                    <li>"+customLabels.ASAIntroModalBodyOl3+'</li>\n                                </ol>\n                            </div>\n                        </div>\n                    </div>\n                    \n                     <div class="introFooterControllers ">\n                        <div class="hideIntroCheckbox">\n                              <input type="checkbox" ng-model="hideIntroModal">\n                               <label>'+customLabels.ASAIntroModalBodyCheckbox+'\n                            </label>\n                        </div>\n                        <div class="buttonContainer">\n                            <button class="introBtnCancel introBtnCancelText introButtonsText" ng-click="closeLightbox(false)">'+customLabels.ASAIntroModalCancel+'</button>\n                            <button class="introApplyBtn introButtonsText"  ng-click="applyIntroClicked()" ng-disabled="errorMode == 3" >\n                            <svg aria-hidden="true" class="introApplyBtnIcon">\n                                <use xlink:href="'+lsdIcons.sparkles+'"></use>\n                            </svg>\n    \n                            '+customLabels.ASAIntroModalGetStarted+'</button> \x3c!-- ng-disabled="nonSelected()"--\x3e\n                        </div>\n                     </div>   \n            </div>\n            ')).find("#ASALightbox").draggable({containment:"document",handle:"#HideIntroModalLightboxHeader"}),angular.element("body").append(e),o.closeLightbox=l,o.$on("$destroy",function(){return e.remove()}),n(e)(o),e.show(),r.setLightBoxStatus(),o.deffered.promise}}}e.$inject=["$q","$compile","$rootScope","userSettingsManager","StateService"],angular.module("serviceExpert").factory("AgentforceSchedulingIntroLightboxService",e)}(),!function(){function e(n,i,s,r,o,a,l,c,d){for(var u=null,p=[],e=0;e<60;e++)p.push(e);var m=a.isRtlDirection();function h(){"running"!==u.bulkState&&(a.setLightBoxStatus(!1),u.$destroy())}function g(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function f(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function S(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function _(e){l.flagged[e]=!l.flagged[e]}function b(e){return l.flagged[e]}function y(e){return c.serviceAppointments()[e].name}function w(){var n=[],e=void 0,t=void 0;if("locations"===u.targetServices){for(var i in e=u.actionStart,t=u.actionFinish,e.setHours(u.startHour),e.setMinutes(u.startMinutes),t.setHours(u.endHour),t.setMinutes(u.endMinutes),u.selectedLocations)u.selectedLocations[i]&&n.push(i);if(0===n.length)return void alert(customLabels.noLocationWasSelected)}else n=r.getSelected();a.setBulkActionRunning(),u.bulkState="running",l.changeStatus(n,d.DISPATCHED,e,t,!0).then(function(e){if(e.nothingToDispatch)u.nothingToDispatch=!0;else{l.drawServicesAndAbsences(e.services),u.results.dispatched=[],n="locations"===u.targetServices?e.services.map(function(e){return e.id}):n;for(var t=0;t<n.length;t++)c.serviceAppointments()[n[t]].status===d.DISPATCHED&&u.results.dispatched.push(c.serviceAppointments()[n[t]]);u.results.failed=0<Object.keys(e.failedResults).length?e.failedResults:null}}).catch(function(e){console.warn("bulk dispatch failed :("),console.log(e)}).finally(function(){a.setBulkActionRunning(!1),u.bulkState="finished"})}return{open:function(){(u=i.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)});var e=o.GetUserSettingsProperty("locations"),t=(u.filteredLocations=e.map(function(e){return s.territories()[e]}),u.selectedCount=r.countSelectedServices(),u.contractorSupport=a.areContractorsSupported(),u.minutes=p,u.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=g,u.dateSelectStartWidget=v,u.validateDatesStart=f,u.validateDatesEnd=S,u.targetServices=0==u.selectedCount?"locations":"selectedServices",u.bulkState="form",u.bulkDispatch=w,u.results={},u.toggleFlag=_,u.isFlagged=b,u.getServiceName=y,u.selectedLocations={},u.nothingToDispatch=!1,u.isAmpm=isAMPM?"ampm":"24",u.selectedMashu=customLabels.x_selected,e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>'),angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox" ng-class="{\'rtlDirection\': '+m+' }" >\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" id="CloseDispatchLightbox" fsl-key-press tabindex="0">\n                            <use xlink:href="'+lsdIcons.close+'"></use>\n                        </svg>\n                        <h1 class="light-box-header">'+customLabels.BulkDispatch+'</h1>\n                    </div>\n\n                    \n                    <div id="bulkDispatchModalCont" ng-show="bulkState == \'finished\'">\n                        <div ng-show="bulkState == \'finished\'">\n    \n                            <div ng-show="nothingToDispatch" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n    \n                            <div ng-show="results.dispatched.length" class="lightboxResultContainer dispatchResultsContainer1">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyDispatched+'</div>\n    \n                                <div ng-repeat="dispatced in results.dispatched" class="lightboxTableRow">\n                                    {{ dispatced.name }}\n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(dispatced.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(dispatced.id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(dispatced.id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToDispatch+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkLightboxExplainCell">{{ failedReason.errorMessage }}</span>\n    \n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n    \n                        </div>\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.DispatchingPleaseWait+'\n                    </div>\n\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.DispatchLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ selectedMashu | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+"</label>\n                                </div>\n\n                                <div class=\"bulkOptimizeOptions\" ng-class=\"{'disabled-area': targetServices != 'locations'}\">\n                                    "+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <button class="lightboxSaveButton" ng-click="bulkDispatch()">'+customLabels.Dispatch+"</button>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            "));t.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(t),u.closeLightbox=h,u.$on("$destroy",function(){return t.remove()}),n(t)(u),t.show(),a.setLightBoxStatus(),t.children().find("input[type=checkbox]").focus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","SERVICE_STATUS"],angular.module("serviceExpert").factory("bulkDispatchService",e)}(),!function(){function e(s,r,o,t,a){for(var l=null,c=null,e=[],n=0;n<60;n++)e.push(n);var d=o.isRtlDirection();function u(e){l.flagged[e]=!l.flagged[e]}function p(e){return l.flagged[e]}function m(e){return t.serviceAppointments()[e].name}function h(){o.setLightBoxStatus(!1),c.$destroy()}return{open:function(e,t){l=a.get("servicesService"),(c=r.$new(!0)).getServiceName=m,c.results={success:[],failed:0<Object.keys(e.failedResults).length?e.failedResults:null},c.labels=t,c.toggleFlag=u,c.isFlagged=p;for(var n=0;n<e.services.length;n++)e.failedResults[e.services[n].Id]||c.results.success.push(e.services[n].Id);c.$on("keypress",function(e,t){27==t.which&&c.$evalAsync(c.closeLightbox)});var i=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox" ng-class="{\'rtlDirection\': '+d+' }">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                <use xlink:href="'+lsdIcons.close+'"></use>\n                            </svg>\n                            <h1 class="light-box-header">'+customLabels.BulkActionResults+'</h1>\n                        </div>\n\n                        <div class="resultsContainerOverflow">\n                            <div ng-show="results.success && results.success.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">{{labels.success}}</div>\n    \n                                <div ng-repeat="id in results.success" class="lightboxTableRow">\n                                    {{ getServiceName(id) }}\n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed && results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">{{labels.fail}}</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkResultLine">{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+"</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                </div>\n            ");i.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(i),c.closeLightbox=h,c.$on("$destroy",function(){return i.remove()}),s(i)(c),i.show(),o.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkResultsService",e)}(),!function(){function e(s,r,o,t,a){var l=null,c=o.isRtlDirection();function d(e){return angular.isObject(e)}function u(e){return t.serviceAppointments()[e]}function p(e){l.flagged[e]=!l.flagged[e]}function m(e){return l.flagged[e]}function h(e){o.setLightBoxStatus(!1),e.$destroy()}return{open:function(e){var t,n=null;for(t in l=a.get("servicesService"),(n=r.$new(!0)).isAdmin=!1,null==window.userHasAdminPermissions?sfdcService.callRemoteAction(RemoteActions.userHasAdminPermissions).then(function(e){window.userHasAdminPermissions=!!e&&(n.isAdmin=!0)}):n.isAdmin=window.userHasAdminPermissions,n.toggleFlag=p,n.isFlagged=m,n.results=e,n.getService=u,n.isError=d,n.successfullyScheduled=0,n.globalSelectedCount=Object.keys(e).length,n.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},n.replaceLabelsForSebas=function(){return customLabels.x_services_scheduled_of_y_here_are_results.replaceAll(n.successfullyScheduled,n.globalSelectedCount)},e)"scheduled"===e[t].textResult&&n.successfullyScheduled++;n.$on("keypress",function(e,t){27==t.which&&n.$evalAsync(n.closeLightbox)}),n.closeLightbox=h,n.$on("$destroy",function(){return i.remove()});var i=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox" ng-class="{\'rtlDirection\': '+c+' }">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox(this)" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.BulkScheduleResults+'</h1>\n                        </div>\n\n                        <div style="padding:0 15px">\n                        \n                            <p>{{ replaceLabelsForSebas() }}</p>\n            \n                            <div id="ResultTableHeader">\n                                <span>'+customLabels.ID+'</span>\n                                <span id="ResultHeaderStart">'+customLabels.Start+"</span>\n                                <span>"+customLabels.Finish+'</span>\n                                <span id="ResultResourceHeader">'+customLabels.Resource+'</span>\n                            </div>\n            \n                            <div id="ScheduledResultsTable">\n                                <div ng-repeat="(id,res) in results" class="ScheduleResultRow">\n                                \n                                    <span class="scheduledResultColName">{{ getService(id).name }}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).start | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).finish | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).resourceName}}</span>\n                                    <span class="ScheduleResultUnscheduled" ng-if="isError(res)">{{ res.msg }}</span>\n                                    \x3c!--<span class="ScheduleResultUnscheduled" ng-if="isError(res)">'+customLabels.NoCandidates+'</span>--\x3e\n                                    <span class="ScheduleResultUnscheduled" ng-if="res.textResult == \'no candidates\'">'+customLabels.NoCandidates+'</span>\n                                    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                    \n                                    <div class="PartialResultsBulk" ng-show="res.partialResults.length > 0" ng-init="res.showDetails = false;">\n                                        <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="res.showDetails = !res.showDetails">'+customLabels.ShowDetails+'</u></div>\n            \n                                        <div ng-show="res.showDetails">\n                                            <ul>\n                                                <li ng-repeat="partial in res.partialResults">\n                                                    {{ generatePartialResult(partial) }}\n                                                </li>\n                                            </ul>\n                                        </div>\n                                    </div>\n                                    \n                                </div>\n                            </div>\n                            \n                        </div>\n                    </div>\n\n                </div>\n            ');i.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),s(i)(n),angular.element("body").append(i),i.show(),o.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkScheduleResultsService",e)}(),!function(){function e(o,t,n,a,l,c,e,i){var d=null;function s(){(d=n.$new(!0)).isInConsole=c.isInConsole(),d.actionName="Schedule",d.currentSchedulingIndex=0,d.successfullyScheduled=0,d.afterSchedulingServiceObjects={},d.close=r,d.showResults=u,d.progressBarStyle=p,d.getLabel=function(e){return customLabels[e]};var e=angular.element('\n            <div id="SchedulingInProgress" class="slideInProgressBox" ng-class="{SchedulingInProgressConsole: isInConsole}">\n\n\t\t\t\t<div ng-show="currentSchedulingIndex != globalSelectedCount">\n\t\t\t\t\t<i class="fa fa-spinner fa-spin"></i> '+customLabels.Scheduling_Services+'\n\t\t\t\t\t<div class="ProgressBar">\n\t\t\t\t\t\t<div ng-style="progressBarStyle()"></div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div ng-cloak class="ProgressBarLabel">{{ getLabel(\'Scheduling_service\') | replaceLabels : (currentSchedulingIndex+1) : globalSelectedCount }}</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div ng-show="currentSchedulingIndex == globalSelectedCount">\n\t\t\t\t\t<i class="fa fa-check"></i> '+customLabels.Scheduling_Complete+'\n\t\t\t\t\t<div ng-cloak class="HowManyWereScheduled">{{  getLabel(\'Scheduled_x_out_of_y\') | replaceLabels : successfullyScheduled : globalSelectedCount }}</div>\n\t\t\t\t\t<span ng-cloak class="InProgressAction" ng-click="close()">'+customLabels.Close+'</span>\n\t\t\t\t\t<span ng-cloak class="InProgressAction" ng-click="showResults()">'+customLabels.View_services+"</span>\n\t\t\t\t</div>\n\n\t\t\t</div>");angular.element("body").append(e),d.$on("$destroy",function(){return e.remove()}),t(e)(d),e.show()}function r(){d.$destroy()}function u(){e.open(d.afterSchedulingServiceObjects),d.$destroy()}function p(){return{width:(d.currentSchedulingIndex+1)/d.globalSelectedCount*100+"%"}}return{schedule:function(e){0===e.length||c.isScheduleRunning||(0===(e=e.filter(function(e){e=l.serviceAppointments()[e];return!(e.relatedService1&&e.isImmidietlyFollow&&!e.isInO2Territory)})).length?alert(window.customLabels.AllServicesAreFollowing):(d&&d.$destroy(),s(),c.isScheduleRunning=!0,d.globalSelectedCount=e.length,a.sortServicesByPriority(e).then(function(e){var i=[],s=[];e.forEach(function(e){s.push(l.serviceAppointments()[e.ServiceId])}),d.globalSelectedServiceObjects=s;for(var t=0;t<d.globalSelectedCount;t++){var n=o.defer();n.promise.then(r),i.push(n)}function r(n){c.schedulingRunningFor[s[n].id]=!0,a.autoScheduleService(s[n].id,!0).then(function(e){a.drawServicesAndAbsences(e.services,e.absences),d.afterSchedulingServiceObjects[s[n].id]={},d.afterSchedulingServiceObjects[s[n].id].partialResults=e.partialResults,d.afterSchedulingServiceObjects[s[n].id].textResult="no candidates",e.services.forEach(function(e){e.id===s[n].id&&(d.afterSchedulingServiceObjects[s[n].id].textResult="scheduled",d.successfullyScheduled++)})}).catch(function(e){var t={};t.msg=e.message,d.afterSchedulingServiceObjects[s[n].id]=t}).finally(function(){if(d.currentSchedulingIndex++,c.schedulingRunningFor[s[n].id]=!1,n+1<d.globalSelectedCount&&i[n+1].resolve(n+1),n+1===d.globalSelectedCount){var e,t=[];for(e in scheduler._events)"service"===scheduler._events[e].type&&t.push(e);0<t.length&&"On Demand"!==window.__gantt.checkRulesMode&&a.checkRules(t).then(a.drawViolationsOnGantt),c.isScheduleRunning=!1}})}i[0].resolve(0)})))}}}e.$inject=["$q","$compile","$rootScope","servicesService","TimePhasedDataService","StateService","bulkScheduleResultsService","utils"],angular.module("serviceExpert").factory("bulkScheduleService",e)}(),!function(){function e(n,i,s,r,o,a,l,c,d){for(var u=null,p=[],e=0;e<60;e++)p.push(e);var m=a.isRtlDirection();function h(){"running"!==u.bulkState&&(a.setLightBoxStatus(!1),u.$destroy())}function g(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function f(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function S(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function _(e){l.flagged[e]=!l.flagged[e]}function b(e){return l.flagged[e]}function y(e){return c.serviceAppointments()[e].name}function w(){var n=[],e=void 0,t=void 0;if("locations"===u.targetServices){for(var i in e=u.actionStart,t=u.actionFinish,e.setHours(u.startHour),e.setMinutes(u.startMinutes),t.setHours(u.endHour),t.setMinutes(u.endMinutes),u.selectedLocations)u.selectedLocations[i]&&n.push(i);if(0===n.length)return void alert(customLabels.noLocationWasSelected)}else n=r.getSelected();a.setBulkActionRunning(),u.bulkState="running",l.unscheduleServices(n,a.selectedPolicyId,e,t).then(function(e){if(e.nothingToUnschedule)u.nothingToUnschedule=!0;else{l.drawServicesAndAbsences(e.services,e.absences,[],e.capacities),u.results.unscheduled=[],n="locations"===u.targetServices?e.services.map(function(e){return e.id}):n;for(var t=0;t<n.length;t++)c.serviceAppointments()[n[t]].isScheduled()||u.results.unscheduled.push(c.serviceAppointments()[n[t]]);u.results.failed=0<Object.keys(e.failedResults).length?e.failedResults:null}}).catch(function(e){console.warn("bulk unschedule failed :("),console.log(e),u.exception=e}).finally(function(){a.setBulkActionRunning(!1),u.bulkState="finished",d.calculateKpis()})}return{open:function(){(u=i.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)});var e=o.GetUserSettingsProperty("locations"),t=(u.filteredLocations=e.map(function(e){return s.territories()[e]}),u.selectedCount=r.countSelectedServices(),u.contractorSupport=a.areContractorsSupported(),u.minutes=p,u.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=g,u.dateSelectStartWidget=v,u.validateDatesStart=f,u.validateDatesEnd=S,u.targetServices=0==u.selectedCount?"locations":"selectedServices",u.bulkState="form",u.bulkUnschedule=w,u.results={},u.toggleFlag=_,u.isFlagged=b,u.getServiceName=y,u.selectedLocations={},u.nothingToUnschedule=!1,u.isAmpm=isAMPM?"ampm":"24",u.exception=null,e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>'),angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="UnschduleLightbox" ng-class="{\'rtlDirection\': '+m+' }">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" fsl-key-press tabindex="0">\n                            <use xlink:href="'+lsdIcons.close+'"></use>\n                        </svg>\n                        <h1 class="light-box-header">'+customLabels.BulkUnschedule+'</h1>\n                    </div>\n\n                    <div ng-show="bulkState == \'finished\'">\n\n\n                        <div ng-show="nothingToUnschedule" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n\n                        <div class="resultsContainerOverflow class="unschedule_res_thingy_qa_halash">\n                        \n                            <div class="bulk-exception" ng-show="exception">\n                                <svg aria-hidden="true" class="slds-icon kpiIcon">\n                                    <use xlink:href="'+lsdIcons.violation+'"></use>\n                                </svg>\n                                {{ exception.message }} \n                            </div>\n                        \n                            <div ng-show="results.unscheduled.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyUnscheduled+'</div>\n    \n                                <div ng-repeat="unscheduled in results.unscheduled track by $index" class="lightboxTableRow">\n                                    {{ unscheduled.name }}\n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(unscheduled.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(unscheduled.id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(unscheduled.id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToUnschedule+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed track by $index" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkLightboxExplainCell">{{ failedReason.errorMessage }}</span>\n    \n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.UnschedulingPleaseWait+'\n                    </div>\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.UnscheduleLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ getCustomLabel(\'x_selected\') | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+'</label>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    '+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <button class="lightboxSaveButton" ng-click="bulkUnschedule()">'+customLabels.Unschedule+"</button>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            "));t.find("#UnschduleLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(t),u.closeLightbox=h,u.getCustomLabel=function(e){return customLabels[e]},u.$on("$destroy",function(){return t.remove()}),n(t)(u),t.show(),a.setLightBoxStatus(),t.children().find("input[type=checkbox]").focus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","kpiCalculationsService"],angular.module("serviceExpert").factory("bulkUnscheduleService",e)}(),!function(){function e(r,i,o,s){return{Bundle:{label:customLabels.Bundle,icon:lsdIcons.bundleIcons+"#ad_set",canInvoke:function(e){if(!r.isActive()||!e||0===e.length)return!1;if(1<e.length)return!0;for(var t=!0,n=0;n<e.length;n++){if(e[n]&&-1<e[n].id.indexOf("_dummy")){t=!1;break}var i=e[n];if(!i||i.pinned||i.isBundle||i.isBundleMember){t=!1;break}}return t},invoke:function(e,t){var n=o.defer();return 0!==e.length?i.open(e,t):(e={message:customLabels.BundleNotSelected,status:"ERROR"},s.$broadcast("showServiceExpertToast",e),utils.addNotification(customLabels.BundleCreatedFailedNTitle,customLabels.BundleNotSelected,function(){}),n.reject(),n.promise)}},Unbundle:{label:customLabels.UnBundle,icon:lsdIcons.bundleIcons+"#archive",canInvoke:function(e){if(!r.isActive()||!e||0===e.length)return!1;if(1<e.length)return!0;for(var t=!0,n=0;n<e.length;n++){if(e[n]&&-1<e[n].id.indexOf("_dummy")){t=!1;break}var i=e[n];if(!i||i.pinned||!i.isBundle){t=!1;break}}return t},invoke:function(t,n){var i=void 0,s=void 0,e=(r.checkFieldAndRetrieveBoolean("ApptBundleConfig","DoesDeleteEmptyBundles").then(function(e){if(i=e,s=1<t.length?i?customLabels.VerifyUnBundleActionMulti:"Unbundling these service appointments removes all bundle members from the bundles and empty bundle service appointments remain. Do you want to continue?":i?customLabels.VerifyUnBundleAction:"Unbundling this service appointment removes all bundle members from the bundle and an empty bundle service appointment remains. Do you want to continue?",window.confirm(s))return e=t.map(function(e){return e.id}),r.unBundleServiceAppointment(e,t,n)}),o.defer());return e.reject(null),e.promise}},UpdateBundle:{label:customLabels.Bundle,icon:lsdIcons.bundleIcons+"#ad_set",canInvoke:function(e){return!0},invoke:function(e,t,n){e=e.map(function(e){return e.id});return r.updateBundleServiceAppointments(e,t,n)}}}}e.$inject=["BundleService","BundlerAddCreateLightboxService","$q","$rootScope","utils"],angular.module("serviceExpert").factory("BundleActions",e)}(),!function(){function e(s,r,d,u,e,n,p,m){function i(){return"0"!==isSchedulingBundlingEnabled&&!!isSchedulingBundlingEnabled}function o(e){return e.isBundleMember}return{isBundleMember:o,isBundle:function(e){return e.isBundle},isActive:i,bundleServiceAppointments:function(e,t,n){var i,l=s.defer(),c=!1;return 0===(e=Array.isArray(e)?e:[e]).length?(i={message:customLabels.BundleNotSelected,status:"ERROR"},p.$broadcast("showServiceExpertToast",i),l.reject()):(1===n.length&&(c=n[0].name),i=window.location.search,n=new URLSearchParams(i).get("token"),r.callRemoteAction(RemoteActions.createBundleManually,e,t,n).then(function(e){var t="",n=e.bundleStatus,i=void 0,s=void 0;if(e&&e.error_msg&&-1<e.error_msg.indexOf("Setup->Security->Remote site settings")){try{var r=e.error_msg.split("/bundleflow"),i=r[0]+" or ask your Salesforce admin for help.",s=r[0].split("endpoint =")[1]}catch(e){i="Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings",s="the URL"}alert(i),u.addNotification(customLabels.BundleCreatedFailedNTitle,"Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings to "+s,function(){});r={message:customLabels.BundleCreationFailedM,status:"ERROR"};p.$broadcast("showServiceExpertToast",r),l.resolve(a)}else{if(e&&e.debugMode)for(var o in console.log("--createBundleManually--"),console.log(e),e)console.log(o+": "+e[o]);t=e.bundle||{AppointmentNumber:e.AppointmentNumber,Id:e.bundleId};var a=e.bundledMembers;"COMPLETE_BUNDLE"==n?(i=String.format(customLabels.BundleSuccessfullyCreated,t.AppointmentNumber),u.addNotification(customLabels.BundleCreatedNTitle,String.format(customLabels.BundleSuccessfullyCreated,t.AppointmentNumber),function(){m.open(t.Id)}),s={message:i,status:"SUCCESS",f:function(e){m.open(e)},p:t.Id},p.$broadcast("showServiceExpertToast",s),l.resolve(a)):(r="",n=r=c?String.format(customLabels.BundleCreationFailedSingle,c):customLabels.BundleCreationFailedM,i={message:n=e.shortMsg&&""!=e.shortMsg?e.shortMsg:n,status:"ERROR"},p.$broadcast("showServiceExpertToast",i),s=r,e.longMsg&&""!=e.longMsg&&(s=e.longMsg),u.addNotification(customLabels.BundleCreatedFailedNTitle,s,function(){}),l.reject(e.bundleStatus))}}).catch(function(e){var t="",n=t=c?String.format(customLabels.BundleCreationFailedSingle,c):customLabels.BundleCreationFailedM;p.$broadcast("showServiceExpertToast",{message:n,status:"ERROR"}),u.addNotification(customLabels.BundleCreatedFailedNTitle,t,function(){}),console.warn(e),l.reject(e)})),l.promise},updateBundleServiceAppointments:function(e,t,o,a){var e=Array.isArray(e)?e:[e],l=s.defer();return r.callRemoteAction(RemoteActions.updateBundleManually,e,t,o).then(function(e){var t=void 0,n=void 0;if(e&&e.error_msg&&-1<e.error_msg.indexOf("Setup->Security->Remote site settings")){try{var i=e.error_msg.split("/bundleflow"),t=i[0]+" or ask your Salesforce admin for help.",n=i[0].split("endpoint =")[1]}catch(e){t="Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings",n="the URL"}alert(t),u.addNotification(customLabels.BundleUpdateFailedNT,"Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings to "+n,function(){});i={message:customLabels.BundleUpdateFailedNT,status:"ERROR"};p.$broadcast("showServiceExpertToast",i),l.resolve(r)}else{if(e&&e.debugMode)for(var s in console.log("+++"),console.log(e),e)console.log(s+": "+e[s]);var t=e.bundleStatus,n=void 0,r=(n=e.bundle||{AppointmentNumber:e.AppointmentNumber,Id:e.bundleId},e.bundledMembers);"COMPLETE_BUNDLE"==t?(i=String.format(customLabels.BundleUpdateSuccessfully,a),t=customLabels.BundleUpdateSuccessfullyNT,u.addNotification(t,i,function(){m.open(o)}),t={message:i,status:"SUCCESS",f:function(e){m.open(e)},p:n.Id},p.$broadcast("showServiceExpertToast",t),l.resolve(r)):(i=String.format(customLabels.BundleUpdateFailed,a),n={message:i=e.shortMsg&&""!=e.shortMsg?e.shortMsg:i,status:"ERROR"},p.$broadcast("showServiceExpertToast",n),t=String.format(customLabels.BundleUpdateFailed,a),e.longMsg&&""!=e.longMsg&&(t=e.longMsg),u.addNotification(customLabels.BundleUpdateFailedNT,t,function(){}),l.reject(e.bundleStatus))}}).catch(function(e){var t={message:String.format(customLabels.BundleUpdateFailed,a),status:"ERROR"};p.$broadcast("showServiceExpertToast",t),u.addNotification(customLabels.BundleUpdateFailedNT,String.format(customLabels.BundleUpdateFailed,a),function(){}),l.reject(e)}),l.promise},unBundleServiceAppointment:function(e,n,t){var i,o,a,l,c=s.defer();return 0===(e=Array.isArray(e)?e:[e]).length?(i={message:customLabels.UnbundledNotSelected,status:"ERROR"},p.$broadcast("showServiceExpertToast",i),u.addNotification(customLabels.FailedUnbundledNT,customLabels.UnbundledNotSelected,function(){}),c.reject()):(o=(1===n.length&&n[0].name,[]),l=a="",r.callRemoteAction(RemoteActions.unbundleManually,e,t).then(function(e){var t=void 0,n=void 0;if(e&&e.error_msg&&-1<e.error_msg.indexOf("Setup->Security->Remote site settings")){try{var i=e.error_msg.split("/bundleflow"),t=i[0]+" or ask your Salesforce admin for help.",n=i[0].split("endpoint =")[1]}catch(e){t="Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings",n="the URL"}alert(t),u.addNotification(customLabels.FailedUnbundledM,"Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings to "+n,function(){});i={message:customLabels.FailedUnbundledM,status:"ERROR"};p.$broadcast("showServiceExpertToast",i),c.resolve(resBundledMembers)}else{if(e&&e.debugMode)for(var s in console.log("--unbundle---"),console.log(e),e)console.log(s+": "+e[s]);var t="On Demand"!==window.__gantt.checkRulesMode,n=(d.getDelta(t),e.unbundleStatus),r=e.unbundle;"STATUS_MULTI_UNBUNDLE_COMPLETE"==n?(i=customLabels.SuccessfullyUnbundledM,p.$broadcast("showServiceExpertToast",{message:i,status:"SUCCESS"}),t=customLabels.SuccessfullyUnbundledM,u.addNotification(customLabels.SuccessfullyUnbundledNT,t,function(){}),c.reject(e.bundleStatus)):"STATUS_MULTI_UNBUNDLE_FAILED"==n?(i=customLabels.FailedUnbundledM,p.$broadcast("showServiceExpertToast",{message:i,status:"ERROR"}),t=customLabels.FailedUnbundledM,u.addNotification(customLabels.FailedUnbundledNTM,t,function(){}),c.reject(e.bundleStatus)):"STATUS_MULTI_UNBUNDLE_PARTIAL"==n?(i=customLabels.PartialUnbundledM,p.$broadcast("showServiceExpertToast",{message:i,status:"ERROR"}),t=customLabels.PartialUnbundledM,u.addNotification(customLabels.FailedUnbundledNT,t,function(){}),c.reject(e.bundleStatus)):"COMPLETE_UNBUNDLE"==n?(e.AppointmentNumber?o.push(e.AppointmentNumber):Object.keys(r).map(function(e){r[e]&&r[e].AppointmentNumber&&o.push(r[e].AppointmentNumber)}),i={message:a=1<o.length?customLabels.SuccessfullyUnbundledM:(l=o[0],String.format(customLabels.SuccessfullyUnbundled,l)),status:"SUCCESS"},p.$broadcast("showServiceExpertToast",i),u.addNotification(customLabels.SuccessfullyUnbundledNT,a,function(){}),c.resolve(r)):(t="",n={message:t=e.shortMsg&&""!=e.shortMsg?e.shortMsg:t,status:"ERROR"},p.$broadcast("showServiceExpertToast",n),i="",e.longMsg&&""!=e.longMsg&&(i=e.longMsg),u.addNotification(customLabels.FailedUnbundledNT,i,function(){}),c.reject(r))}}).catch(function(e){console.warn(e),Object.keys(n).map(function(e){n[e]&&n[e].AppointmentNumber&&o.push(n[e].AppointmentNumber)});var t={message:a=1<o.length?customLabels.FailedUnbundledM:(l=o[0],String.format(customLabels.FailedUnbundled,l)),status:"ERROR"};p.$broadcast("showServiceExpertToast",t),u.addNotification(customLabels.FailedUnbundledNT,a,function(){}),c.reject(e)})),c.promise},verifyShowSaOnGantt:function(e){var t;return i()&&e?(t=e,i()&&o(t)?n.serviceAppointments()[t.RelatedBundle]:t):e},checkFieldAndRetrieveBoolean:function(e,t){var n=s.defer();return e&&t?r.callRemoteAction(RemoteActions.checkFieldExistsAndGetValue,e,t).then(function(e){e.fieldExists?n.resolve(e.fieldValue):n.reject(e.errorMessage||"Field does not exist on the object.")}).catch(function(e){console.error("Error in Remote Action:",e),n.reject(e)}):n.reject("Object or Field name not provided."),n.promise}}}e.$inject=["$q","sfdcService","DeltaService","utils","$timeout","TimePhasedDataService","$rootScope","ServiceAppointmentLightboxService"],angular.module("serviceExpert").factory("BundleService",e)}(),!function(){function e(c,d,u,p,t,o,m,h,e,g,i,v){var f=null,S=void 0,n=200,a=1,l=2,_=3,b=4,y=5,w=6;function T(e){1==e&&(f.openTableMode1=f.openTableMode1+2,3<f.openTableMode1&&(f.openTableMode1=1),f.openTableMode2=4-f.openTableMode1),2==e&&(f.openTableMode2=f.openTableMode2+2,3<f.openTableMode2&&(f.openTableMode2=1),f.openTableMode1=4-f.openTableMode2)}function L(e){g.setLightBoxStatus(!1),f.$destroy(),e||f.deffered.reject("closed")}function A(){var t=0;return Object.keys(f.selectedSa).map(function(e){f.selectedSa[e]&&t++}),t}function I(){var e,t;f.errorMode==b&&(f.errorMode=0,f.showErrorPopupVar=0),f.errorMode||(e=A(),n<e&&(f.errorMode=b,d(function(){f.showErrorPopupVar=1},500),t=(t=customLabels.SelectedServiceAppointmentMax).replace("(0)",n),f.errorMsg=t.replace("(1)",e-n)))}function C(e){f.mode=e}function k(e){t.open(e)}function D(e,t){f.selectedAddSa=e,f.apNumber=t,f.clearError()}function R(e){f.selectedSa[e]=!f.selectedSa[e],I()}function F(){var t=!0;return Object.keys(f.selectedSa).map(function(e){f.selectedSa[e]||(t=!1)}),t}function O(){f.data.searchText="",f.bundlersView=[],f.bundlers.forEach(function(e){e&&e.AppointmentNumber&&f.bundlersView.push(e)})}function M(){var e=f.data.searchText||"";f.serverSearchDisabled=!0,""==e?d(function(){f.serverSearchDisabled=!1},500):v.callRemoteAction(RemoteActions.bundleServerSearch,e).then(function(e){f.serverSearchDisabled=!1;e&&0<e.length&&(e.forEach(function(e){if(null==e.fields&&null!=e.Fields)for(var t in e.fields={},e.Fields)e.fields[t]=e.Fields[t];if(null==e.Fields&&null!=e.fields)for(var n in e.Fields={},e.fields)e.Fields[n]=e.fields[n];var i=new Date(e.Fields.DueDate).toLocaleString(void 0,{timeZone:"UTC"}),s=new Date(e.Fields.EarliestStartTime).toLocaleString(void 0,{timeZone:"UTC"});e.id=e.Id,e.parentRecord=e.Fields.ParentRecordId,e.DurationInMinutes=e.Fields.DurationInMinutes,e.earlyStartView=u("amDateFormat")(s,"l LT"),e.dueDateView=u("amDateFormat")(i,"l LT"),e.AppointmentNumber=e.name=e.Fields.AppointmentNumber,e.City=e.Fields.City,e.Street=e.Fields.Street,e.accountName=e.Fields["Account.Name"],e.Fields&&e.Fields.WorkTypeId&&f.WorkTypeIds.push(e.Fields.WorkTypeId),e.Fields&&e.Fields.ParentRecordId&&f.WorkOrderIds.push(e.Fields.ParentRecordId)}),f.bundlersView=[e[0]],v.callRemoteAction(RemoteActions.getWorkOrders,f.WorkOrderIds).then(function(e){e.forEach(function(e){if(e&&e.SkillRequirements){f.skills[e.Id]=[];for(var t=0;t<e.SkillRequirements.length;t++)f.skills[e.Id]=f.skills[e.Id]||[],f.skills[e.Id].push(e.SkillRequirements[t].Skill.MasterLabel)}}),f.bundlersView.forEach(function(e){f.skills&&f.skills[e.parentRecord]&&(e.SkillText=f.skills[e.parentRecord].join(","))})}),v.callRemoteAction(RemoteActions.getWorkTypes,f.WorkTypeIds).then(function(e){e.forEach(function(e){f.workTypes[e.Id]=e.Name}),f.bundlersView.forEach(function(e){e.workTypesText=f.workTypes[e.Fields.WorkTypeId]})}))})}function E(){var t=f.data.searchText||"";f.bundlersView=[],f.bundlers.forEach(function(e){(""==t||null==t||null==e.name||-1<e.name.indexOf(t))&&e&&e.AppointmentNumber&&f.bundlersView.push(e)})}function x(){var t=!0;return Object.keys(f.selectedSa).map(function(e){f.selectedSa[e]&&(t=!1)}),f.data.selectedBundlePolicy&&f.bundlerPolicyMapLookup[f.data.selectedBundlePolicy]||"NEW"!==f.mode||(t=!0),t=f.isNativeMode&&"NEW"===f.mode?!1:t}function P(){f.getAllSelected()?f.lightboxServices.forEach(function(e){f.selectedSa[e.id]=!1}):f.lightboxServices.forEach(function(e){f.selectedSa[e.id]=!0}),I()}function N(){f.errorMode!=_&&(f.errorMode=0,f.showErrorPopupVar=0,I())}function G(){if(f.errorMode!=_&&f.errorMode!=b)if(0==A())f.errorMode=y,f.errorMsg=customLabels.ReviewBundleErrors,d(function(){f.showErrorPopupVar=1},500);else{f.errorMsg=customLabels.ReviewBundleErrors,f.errorMode=0,f.showErrorPopupVar=0;var e=f.isNativeMode?f.selectedPolicyId:f.bundlerPolicyMapLookup[f.data.selectedBundlePolicy],t=f.selectedAddSa,n=0!=f.bundlers.length||0!=f.bundlersView.length,i=f.apNumber,s=[],r=[];if(Object.keys(f.selectedSa).map(function(e){f.selectedSa[e]&&(s.push(e),r.push(f.fullSaAll[e]))}),"NEW"==f.mode){if(null==e&&0==f.isNativeMode)return f.errorMode=a,void d(function(){f.showErrorPopupVar=1},500);o.bundleServiceAppointments(s,e,r).then(function(e){console.log(e),S.resolve(e)},function(){S.reject("closed")})}else{if(!n)return f.errorMode=w,void d(function(){f.showErrorPopupVar=1},500);if(null==t)return f.errorMode=l,void d(function(){f.showErrorPopupVar=1},500);o.updateBundleServiceAppointments(s,null,t,i).then(function(e){S.resolve(e)},function(){S.reject("closed")})}L(!0)}}return{open:function(e,t){for(var n in(f=m.$new(!0)).deffered=c.defer(),S=f.deffered,f.lightboxServices=e,f.mode="NEW",f.serverSearchDisabled=!1,f.errorMode=0,f.showErrorPopupVar=0,f.errorMsg=customLabels.ReviewBundleErrors,f.errorMsgMissing="",f.isNativeMode=!0,f.workTypes={},f.fullSaAll={},f.openTableMode1=3,f.openTableMode2=1,f.selectedAddSa=void 0,f.data={},f.data.searchText="",f.skills={},f.WorkTypeIds=[],f.WorkOrderIds=[],e.forEach(function(e){e.earlyStartView=u("amDateFormat")(e.earlyStart,"l LT"),e.dueDateView=u("amDateFormat")(e.dueDate,"l LT"),f.WorkTypeIds.push(e.fields.WorkTypeId),f.WorkOrderIds.push(e.ParentRecordId)}),h.serviceAppointments()){n=h.serviceAppointments()[n];n&&n.isBundle&&n.fields&&n.fields.WorkTypeId&&f.WorkTypeIds.push(n.fields.WorkTypeId),n&&n.isBundle&&n.fields&&n.fields.ParentRecordId&&f.WorkOrderIds.push(n.fields.ParentRecordId)}v.callRemoteAction(RemoteActions.getWorkTypes,f.WorkTypeIds).then(function(e){e.forEach(function(e){f.workTypes[e.Id]=e.Name}),f.showData2=!0,f.lightboxServices.forEach(function(e){e.workTypesText=f.workTypes[e.fields.WorkTypeId]}),f.lightboxServices.forEach(function(e){e.addrText=e.City+" "+e.Street})}),v.callRemoteAction(RemoteActions.getWorkOrders,f.WorkOrderIds).then(function(e){e.forEach(function(e){if(e&&e.SkillRequirements)for(var t=0;t<e.SkillRequirements.length;t++)f.skills[e.Id]=f.skills[e.Id]||[],f.skills[e.Id].push(e.SkillRequirements[t].Skill.MasterLabel)}),f.lightboxServices.forEach(function(e){f.skills&&f.skills[e.parentRecord]&&(e.SkillText=f.skills[e.parentRecord].join(","))}),f.bundlersView.forEach(function(e){f.skills&&f.skills[e.parentRecord]&&(e.SkillText=f.skills[e.parentRecord].join(","))}),f.showData=!0}),v.callRemoteAction(RemoteActions.getBundleApexMode).then(function(e){(f.isNativeMode=e)||v.callRemoteAction(RemoteActions.getBundlePolicy).then(function(e){f.bundlerPolicyArr=[],f.bundlerPolicyMap={},0==e.length&&f.errorMode!=_&&(f.errorMode=_,f.errorMsgMissing=customLabels.NoBundlePolicies,d(function(){f.showErrorPopupVar=1},500)),e.forEach(function(e){o=36<e.Name.length?e.Name.substring(0,33)+"...":e.Name,f.bundlerPolicyNamesMapLookup[o]=e.Name,f.bundlerPolicyArr.push(o),f.bundlerPolicyMapLookup[o]=e.Id,f.bundlerPolicyMap[e.Id]=o},function(e){console.error(e)})})}),f.selectedValue="cleared",f.cleared=!1,f.fraudulent=!1,f.reviewed=!1,f.selectedPolicyId=t,f.selectedSa={},f.lightboxServices.forEach(function(e){f.selectedSa[e.id]=!0,f.fullSaAll[e.id]=e}),f.$on("keypress",function(e,t){27==t.which&&(f.$evalAsync(f.closeLightbox),S.reject("closed"))}),f.bundlers=[],f.bundlersView=[],f.bundlersIds=[],f.bundlerPolicyMap={},f.bundlerPolicyMapLookup={},f.bundlerPolicyNamesMapLookup={},f.bundlerPolicyArr=[],f.bundledMap={};var i,s,r,o="";for(i in f.tabe1order="name",f.table1reverse=!1,f.tabe2order="name",f.table2reverse=!1,h.serviceAppointments()){var a=h.serviceAppointments()[i];a.isBundle&&(f.bundledMap[a.id]=a)}for(s in f.bundledMap)f.bundledMap[s].earlyStartView=u("amDateFormat")(f.bundledMap[s].earlyStart,"l LT"),f.bundledMap[s].dueDateView=u("amDateFormat")(f.bundledMap[s].dueDate,"l LT");for(r in f.bundlers=[],f.bundledMap)f.bundlers.push(f.bundledMap[r]),f.bundlersIds.push(r);f.bundlers.forEach(function(e){e&&e.AppointmentNumber&&f.bundlersView.push(e)});var l=angular.element('\n            <style>\n                .searchServerBtn:hover {\n                    background: #f4f6f9 !important;\n                }\n            </style>\n                <div class="LightboxBlackContainer" id="createUpdateBundlePopup" >\n                    <div id="BundlerLightbox" class="LightboxContainer">\n\n                        <div class="lightboxHeaderContainer" id="BundlerLightboxHeader">\n                            <svg ng-click="closeLightbox(false)" aria-hidden="true" class="slds-icon CloseLightbox" fsl-key-press tabindex="0">\n                                <use xlink:href="'+lsdIcons.close+'"></use>\n                            </svg>\n                            <h1 class="light-box-header">'+customLabels.BundleCaption+'</h1>\n                        </div>\n\n                        <div class="lightboxContentContainer">\n\n                       <div  ng-show="false" class=\'slds-theme_error bundle-error\'> \n                            <svg aria-hidden="true" class="slds-icon bundler-error-icon">\n                                        <use xlink:href="'+lsdIcons.violation+'"></use>\n                                    </svg>\n                         {{errorMsg}}\n                        </div> \n                       \n\n                            <p class="saHeader">{{selectedCount()}} '+customLabels.SelectedServiceAppointment+'    <span  ng-class="{\'tableDivIconOpen\': openTableMode1==3}" class="openCloseTable fa fa-angle-left"  ng-click="closeOpenTable(1)" ></span></p>\n                            <div  ng-if="errorMode == 5" class="field-required-lable"> '+customLabels.BundleNotSelected+'</div>\n                            <div class="tableDiv slds"  ng-class="{\'tableDivClose\': openTableMode1==1, \'tableDivBig\': openTableMode1==3}">\n                                \n                                <table id="saTable" class="slds slds-table slds-table_cell-buffer slds-table_bordered" >\n                                        <thead>\n                                        <tr class="slds slds-line-height_reset">\n                                        <th><input ng-checked="getAllSelected()" ng-click="allSelection()" type="checkbox" > </th>\n                                        <th ng-click="setOrderreverse(\'name\',1);">'+customLabels.SANumberHeader+'\n                                            <div class="bundleArrowSpace">\n                                                <svg ng-show ="table1reverse && tabe1order == \'name\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                                </svg>\n                                                <svg ng-show ="!table1reverse && tabe1order == \'name\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                                </svg>\n                                            </div>\n                                        </th>\n                                        <th ng-click="setOrderreverse(\'DurationInMinutes\',1)">'+customLabels.DurationHeader+'\n                                            <div class="bundleArrowSpace">\n                                                <svg ng-show ="table1reverse && tabe1order == \'DurationInMinutes\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                                </svg>\n                                                <svg ng-show ="!table1reverse && tabe1order == \'DurationInMinutes\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                                </svg>\n                                            </div>    \n                                        </th>\n                                        <th ng-click="setOrderreverse(\'addrText\',1)">'+customLabels.AddressHeader+'\n                                            <div class="bundleArrowSpace">\n                                                <svg ng-show ="table1reverse && tabe1order == \'addrText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                                </svg>\n                                                <svg ng-show ="!table1reverse && tabe1order == \'addrText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                                </svg>\n                                            </div>    \n                                        </th>\n\n\n                                        <th ng-click="setOrderreverse(\'earlyStartView\',1)">'+customLabels.EarlyStartHeader+'\n                                            <div class="bundleArrowSpace">\n                                                <svg ng-show ="table1reverse && tabe1order == \'earlyStartView\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                                </svg>\n                                                <svg ng-show ="!table1reverse && tabe1order == \'earlyStartView\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                                </svg>\n                                            </div>\n                                        </th>\n\n                                        <th ng-click="setOrderreverse(\'dueDateView\',1)">'+customLabels.DueDateHeader+'\n                                            <div class="bundleArrowSpace">\n                                                <svg ng-show ="table1reverse && tabe1order == \'dueDateView\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                    <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                                </svg>\n                                                <svg ng-show ="!table1reverse && tabe1order == \'dueDateView\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                    <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                                </svg>\n                                            </div>\n\n                                        </th>\n\n                                        <th ng-click="setOrderreverse(\'workTypesText\',1)">'+customLabels.WorkTypeHeader+'\n                                            <div class="bundleArrowSpace">\n                                                <svg ng-show ="table1reverse && tabe1order == \'workTypesText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                    <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                                </svg>\n                                                <svg ng-show ="!table1reverse && tabe1order == \'workTypesText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                    <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                                </svg>\n                                            </div>\n                                        </th>\n\n                                        <th ng-click="setOrderreverse(\'accountName\',1)">'+customLabels.AccountHeader+'\n                                            <div class="bundleArrowSpace">\n                                                <svg ng-show ="table1reverse && tabe1order == \'accountName\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                    <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                                </svg>\n                                                <svg ng-show ="!table1reverse && tabe1order == \'accountName\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                    <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                                </svg>\n                                             </div>   \n                                        </th>\n\n                                        <th ng-click="setOrderreverse(\'SkillText\',1)">'+customLabels.RequiredSkillsHeader+'\n                                            <div class="bundleArrowSpace">\n                                                <svg ng-show ="table1reverse && tabe1order == \'SkillText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                    <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                                </svg>\n                                                <svg ng-show ="!table1reverse && tabe1order == \'SkillText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                    <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                                </svg>\n                                            </div>\n                                        </th>\n\n                                        </tr>\n\n                                        </thead>\n                                        <tbody class=\'slds slds-tbody\'> \n                                        <tr class="slds slds-hint-parent dataRow maxHight30" ng-repeat="sa in lightboxServices | orderBy:tabe1order:table1reverse " >   \n                                        <td class="Width20">\n                                        <input ng-checked="showData && showData2 && selectedSa[sa.id]" ng-click="toggleSelection(sa.id)" type="checkbox" value="{{sa.id}}">\n                                        </td> \n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.name}}">\n                                                <a class="saLink ng-click="" target="_blank" href="../{{ sa.id }}" title="{{sa.name}}">{{showData && showData2 ? sa.name : \'\'}}</a>\n                                            </td>\n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.DurationInMinutes}}">\n                                                <span class="">{{showData && showData2 ? sa.DurationInMinutes : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.City + \' \' + sa.Street}}">\n                                                <span class="">{{showData && showData2 ? sa.City + \' \' + sa.Street : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width150" ng-attr-title="{{sa.earlyStartView}}" ng-bind="showData && showData2 ? sa.earlyStartView  : \'\' "> \n                                            </td>\n                                            <td class="slds slds-truncate Width150" ng-attr-title="{{sa.dueDateView}}" ng-bind="showData && showData2 ? sa.dueDateView  : \'\' "> \n                                            </td>\n                                            <td class="slds slds-truncate Width100" ng-attr-title="{{sa.fields[\'WorkTypeId\'] ? workTypes[sa.fields[\'WorkTypeId\']] : \'\'}}">\n                                                <span class="">{{sa.fields[\'WorkTypeId\'] ? workTypes[sa.fields[\'WorkTypeId\']] : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width100" ng-attr-title="{{sa.accountName}}">\n                                                <span class="">{{showData && showData2 ? sa.accountName : \'\'}}</span>\n                                            </td>\n\n                                            <td class="slds slds-truncate Width100 " ng-attr-title="{{ skills[sa.parentRecord].join(\',\') }}" >\n                                            <span class=""> {{ showData && showData2 ? skills[sa.parentRecord].join(\',\') : \'\' }}</span>\n                                        </td>\n                                           \n                                        </tr>\n                                        </tbody>\n                                </table>\n                                </div>\n                                \n                                \n                                <div class="bundleButtonsContainer" >\n                                    <div class="bundleButtons" ng-click="mode = \'NEW\' " ng-class="mode == \'NEW\'  ? \'bundle_settings-tab-selected\' : \'bundle_settings-tab\' "  class="modeRadioButton" > \x3c!-- ng-change="clearError()" --\x3e\n                                        <label class="radioLables" >'+customLabels.CreateNewBundle+'</label>\n                                    </div>   \n                                    \n                                    <div class="bundleButtons"   ng-click="mode = \'UPDATE\' " ng-class="mode == \'UPDATE\'  ? \'bundle_settings-tab-selected\' : \'bundle_settings-tab\' " class="modeRadioButton"   > \x3c!-- ng-change="clearError()" --\x3e\n                                        <label class="radioLables" >'+customLabels.AddToExistingBundle+'</label>\n                                    </div>   \n                                    <span ng-class="{\'tableDivIconOpen\': openTableMode2==3}" class="openCloseTable fa fa-angle-left"  ng-click="closeOpenTable(2)" ></span>\n                                </div>\n\n                                 \n\n                                    <div ng-if="mode !== \'UPDATE\'" class="newB">\n                                        <div class="selectBundler" ng-hide="isNativeMode == true">\n                                            <div><span class="required">*</span><span>'+customLabels.BundlePolicy+'</span></div>\n                                            \n                                            <div >\n                                                <input type="text" ng-class="errorMode == 1  ? \'error-field\' : \'\' " list="bundlerPolicyList" ng-change="clearError()" placeholder="'+customLabels.SelectBundlePolicyDrop+'" ng-model="data.selectedBundlePolicy"  title="{{bundlerPolicyNamesMapLookup[ data.selectedBundlePolicy ]}}" class="bundlerInput" ng-disabled="mode === \'UPDATE\' || errorMode == 3">\n                                                \n                                                <datalist id="bundlerPolicyList" ng-model="bundlerPolicyList" >\n                                                    <option ng-repeat="(key, value) in bundlerPolicyMap"  [key]="{{value}}">{{value}}</option>\n                                                </datalist>\n                                            </div>\n\n                                            <div ng-class="errorMode == 1 ? \'field-required-lable\' : \'error-hide\' ">'+customLabels.SelectAPolicy+'</div>\n                                            <div ng-class="errorMode == 3 ? \'field-required-lable\' : \'error-hide\'"> {{errorMsgMissing}}</div>\n                                        </div>\n                                    </div>\n                                <div>\n                                </div>\n                            <div class="tableDiv slds"   ng-class="{\'tableDivClose\': openTableMode2==1, \'tableDivBig\': openTableMode2==3}">\n                                <table ng-if="mode === \'UPDATE\'" id="addSaTable" class="slds slds-table slds-table_cell-buffer slds-table_bordered" >\n                                        <thead>\n                                        <tr class="slds slds-line-height_reset">\n                                        <th ng-click="openTableMode2 = !openTableMode2"  ></th>\n                                        <th ng-click="setOrderreverse(\'name\',2);">'+customLabels.SANumberHeader+'\n                                        <div class="bundleArrowSpace">\n                                        <svg ng-show ="table2reverse && tabe2order == \'name\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                        <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                        </svg>\n                                        <svg ng-show ="!table2reverse && tabe2order == \'name\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                        <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                        </svg>\n                                    </div>\n                                        </th>\n                                        <th ng-click="setOrderreverse(\'DurationInMinutes\',2)">'+customLabels.DurationHeader+'\n                                        <div class="bundleArrowSpace">\n                                            <svg ng-show ="table2reverse && tabe2order == \'DurationInMinutes\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                            <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="!table2reverse && tabe2order == \'DurationInMinutes\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                            <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </div>    \n                                    </th>\n                                    <th ng-click="setOrderreverse(\'addrText\',2)">'+customLabels.AddressHeader+'\n                                        <div class="bundleArrowSpace">\n                                            <svg ng-show ="table2reverse && tabe2order == \'addrText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                            <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="!table2reverse && tabe2order == \'addrText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                            <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </div>    \n                                    </th>\n\n\n                                    <th ng-click="setOrderreverse(\'earlyStartView\',2)">'+customLabels.EarlyStartHeader+'\n                                        <div class="bundleArrowSpace">\n                                            <svg ng-show ="table2reverse && tabe2order == \'earlyStartView\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                            <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="!table2reverse && tabe2order == \'earlyStartView\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                            <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </div>\n                                    </th>\n\n                                    <th ng-click="setOrderreverse(\'dueDateView\',2)">'+customLabels.DueDateHeader+'\n                                        <div class="bundleArrowSpace">\n                                            <svg ng-show ="table2reverse && tabe2order == \'dueDateView\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="!table2reverse && tabe2order == \'dueDateView\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </div>\n\n                                    </th>\n\n                                    <th ng-click="setOrderreverse(\'workTypesText\',2)">'+customLabels.WorkTypeHeader+'\n                                        <div class="bundleArrowSpace">\n                                            <svg ng-show ="table2reverse && tabe2order == \'workTypesText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="!table2reverse && tabe2order == \'workTypesText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </div>\n                                    </th>\n\n                                    <th ng-click="setOrderreverse(\'accountName\',2)">'+customLabels.AccountHeader+'\n                                        <div class="bundleArrowSpace">\n                                            <svg ng-show ="table2reverse && tabe2order == \'accountName\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="!table2reverse && tabe2order == \'accountName\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                         </div>   \n                                    </th>\n\n                                    <th ng-click="setOrderreverse(\'SkillText\',2)">'+customLabels.RequiredSkillsHeader+'\n                                        <div class="bundleArrowSpace">\n                                            <svg ng-show ="table2reverse && tabe2order == \'SkillText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="!table2reverse && tabe2order == \'SkillText\'" aria-hidden="true" class="slds-icon arrowIcon bundleArrowIcon">\n                                                <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </div>\n                                    </th>\n                                        </tr>\n\n                                        </thead>\n                                        <input ng-if="mode === \'UPDATE\'" class="searchBundleSa" placeholder="'+customLabels.SearchAnExistingBundle+'" ng-model="data.searchText" ng-change="search()"  type="text" >\n\n                                       \n                                        <button ng-disabled="serverSearchDisabled == true" ng-if="mode === \'UPDATE\'" style="height:29px;\n                                        padding: 0px 19px 1px 24px;position: relative;top: 1px;" class="btn cancelButton searchServerBtn" ng-click="serverSearch(false)">'+customLabels.SearchAllRecords+'</button>\n\n                                        <button ng-disabled="serverSearchDisabled == true" ng-if="mode === \'UPDATE\'" style="height: 29px;\n                                        padding: 0px 19px 1px 24px;position: relative;top: 1px;" class="btn cancelButton searchServerBtn" ng-click="clearSearch(false)">'+customLabels.ClearField+' </button>\n                                       \n                                        <tbody class=\'slds slds-tbody\'> \n                                        <tr class="slds slds-hint-parent dataRow maxHight30" ng-repeat="sa in bundlersView | orderBy:tabe2order:table2reverse " >   \x3c!-- in bundlersView --\x3e\n                                        <td class="Width20">\n                                        <input  name="addToBundle"  ng-checked="selectedAddSa == sa.id" ng-click="toggleAddSelection(sa.id,sa.name)" type="radio" value="{{sa.id}}">\n                                        </td> \n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.name}}">\n                                                <a class="saLink ng-click="" target="_blank" href="../{{ sa.id }}" title="{{sa.name}}">{{showData && showData2 ? sa.name : \'\'}}</a>\n                                            </td>\n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.DurationInMinutes}}">\n                                                <span class="">{{showData && showData2 ?  sa.DurationInMinutes : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.City + \' \' + sa.Street}}">\n                                                <span class="">{{showData && showData2 ? sa.City + \' \' + sa.Street : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width150" ng-attr-title="{{sa.earlyStartView}}" ng-bind="showData && showData2 ? sa.earlyStartView  : \'\' "> \n                                            </td>\n                                            <td class="slds slds-truncate Width150" ng-attr-title="{{sa.dueDateView}}" ng-bind="showData && showData2 ? sa.dueDateView  : \'\' "> \n                                            </td>\n                                            <td class="slds slds-truncate Width100" ng-attr-title="{{sa.fields[\'WorkTypeId\'] ? workTypes[sa.fields[\'WorkTypeId\']] : \'\'}}">\n                                                <span class="">{{sa.fields[\'WorkTypeId\'] ? workTypes[sa.fields[\'WorkTypeId\']] : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width100" ng-attr-title="{{sa.accountName}}">\n                                                <span class="">{{showData && showData2 ? sa.accountName : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width100 " ng-attr-title="{{ skills[sa.parentRecord].join(\',\') }}" >\n                                                <span class=""> {{ showData && showData2 ? skills[sa.parentRecord].join(\',\') : \'\' }}</span>\n                                            </td>\n                                         \n                                           \n                                        </tr>\n                                        </tbody>\n                                </table>\n                                \n                            </div>\n\n                            <div class="updateB">\n                            <div class="selectBundler">\n                          \n                                <div ng-class="errorMode == 2 ? \'field-required-lable\' : \'error-hide\' ">'+customLabels.SelectAnExistingBundle+"</div>\n                                <div ng-class=\"errorMode == 6 ? 'field-required-lable' : 'error-hide'\"> "+customLabels.NoBundle+'</div>\n                            </div>\n                        </div>    \n                        </div>\n\n                        <div class="lightboxControllers">\n                          \n\n                            <div class="errorPopupShowcontainer" >\n                             <div  ng-click="showErrorPopup()" ng-show="errorMode != 0" class=\'\' style="cursor: pointer;"> \n                             <svg aria-hidden="true" class="slds-icon bundler-error-icon-btn" style="fill:red;">\n                                <use xlink:href="'+lsdIcons.na+'"></use>\n                            </svg>\n                                   \n                              </div> \n                              <div ng-class="showErrorPopupVar != 0  ? \'errorPopupShow\' : \'\' "  class="errorPopupShowStart" >\n                                  <div class="errorHeader errorHeaderPopupShow" >\n                                  <p class="errorHeaderPopupShowP" style="font-size: 18px;" >\n                                    <svg aria-hidden="true" class="slds-icon bundler-error-icon-btn-header" style="fill:white;height: 15px;vertical-align: middle;">\n                                    <use xlink:href="'+lsdIcons.na+'"></use>\n                                    </svg>\n                                    '+customLabels.WeHitAsnag+'\n                                    <svg ng-click="showErrorPopup()" aria-hidden="true" class="slds-icon CloseErrorBundleBox" fsl-key-press tabindex="0">\n                                        <use xlink:href="'+lsdIcons.close+'"></use>\n                                    </svg>\n                                  </p>\n                                  </div>\n                                  <p class="errorHeaderPopupShowText" >{{errorMsg}} </p>\n                              </div>\n                            </div>\n                            <button class="btn cancelButton" ng-click="closeLightbox(false)">'+customLabels.CancelButton+'</button>\n                            <button class="btn apllyButton"  ng-click="apply()" ng-disabled="errorMode == 3" >'+customLabels.SaveButton+'</button> \x3c!-- ng-disabled="nonSelected()"--\x3e\n                        </div>\n\n                    </div>\n                </div>\n            ');return l.find("#BundlerLightbox").draggable({containment:"document",handle:"#BundlerLightboxHeader"}),angular.element("body").append(l),f.closeLightbox=L,f.setMode=C,f.apply=G,f.clearError=N,f.toggleSelection=R,f.toggleAddSelection=D,f.search=E,f.serverSearch=M,f.clearSearch=O,f.allSelection=P,f.nonSelected=x,f.getAllSelected=F,f.editSa=k,f.checkMax=I,f.selectedCount=A,f.setOrderreverse=function(e,t){1==t?f.tabe1order==e?f.table1reverse=!f.table1reverse:(f.table1reverse=!1,f.tabe1order=e):f.tabe2order==e?f.table2reverse=!f.table2reverse:(f.table2reverse=!1,f.tabe2order=e)},f.showErrorPopup=function(){f.showErrorPopupVar=!f.showErrorPopupVar},f.closeOpenTable=T,f.$on("$destroy",function(){return l.remove()}),p(l)(f),l.show(),g.setLightBoxStatus(),I(),f.deffered.promise}}}e.$inject=["$q","$timeout","$filter","$compile","ServiceAppointmentLightboxService","BundleService","$rootScope","TimePhasedDataService","userSettingsManager","StateService","utils","sfdcService"],angular.module("serviceExpert").factory("BundlerAddCreateLightboxService",e)}(),angular.module("serviceExpert").factory("calendarsService",["ResourcesAndTerritoriesService","TimePhasedDataService","HolidayService","$rootScope","utils",function(N,G,B,c,$){var d={},S={},H={},u={};function V(e,t){return $.convertDtToMomentDt(e,t)}function U(e){return $.convertMomentDtToDt(e)}function b(e,t,n,i,s){b(e,t,n,i,s,null,null)}function b(e,t,n,i,s,r){b(e,t,n,i,s,r,null)}function b(e,t,n,i,s,r,o){var a=N.getOperatingHours()[n]||r,l=a?a.timezone:null,c=useLocationTimezone?l:userTimeZone;if(s&&useLocationTimezone)for(var d=i.split(","),u=0;u<d.length;u++){var p=d[u].split("_")[1],p=N.territories()[p].operatingHours;N.getOperatingHours()[p]&&(c=N.getOperatingHours()[p].timezone)}for(var m,r=V(e,c),e=V(t,c),h=(r.clone().tz(l),e.clone().tz(l),U(r)),g=U(e),v=h,f=[r.clone().add(-1,"days"),r.clone(),r.clone().add(1,"days")],S=0;S<f.length;S++){var _=f[S],b=[];if(o){var y=o[$.formatDayToString(U(_))];if(y)for(var w=0;w<y.length;w++)y[w].serviceTerritoryId!=i.split("_")[1]&&y[w].serviceTerritoryId||b.push({slotStart:y[w].startTime,slotFinish:y[w].endTime,type:y[w].timeSlotType,record:"shift",hasTerritory:!!y[w].serviceTerritoryId,isHolidaySlot:!!isHolidayEnabled&&y[w].isHolidayShift,slotColor:y[w].backgroundColor})}if(a)for(var T=a.slots[_.get("day")]||[],L=0;L<T.length;L++){var A=T[L],I=z(_,A,"startHour","startMinute",l,c,s),P=(0==A.startHour&&24==A.endHour&&0!==A.endMinute&&(A.endHour=0),z(_,A,"endHour","endMinute",l,c,s));b.push({slotStart:I,slotFinish:P,type:A.type,record:"timeslot"})}var C=[],C=o&&!a||!o&&a?b:function(e,t){for(var n=[],i=0;i<e.length-1;i++){var s=void 0,r=e[i],o=e[i+1];if(r.getTime()!=o.getTime()){for(var a=0;a<t.length;a++){var l,c=t[a];$.intersectDates({start:r,finish:o},{start:c.slotStart,finish:c.slotFinish}).intersection&&(void 0===(l=s)||"timeslot"==l.record||"shift"==l.record&&(!l.hasTerritory&&c.hasTerritory||!l.isHolidaySlot&&c.isHolidaySlot)||(l.hasTerritory&&c.hasTerritory||!l.hasTerritory&&!c.hasTerritory)&&l.originalSlotStart>c.slotStart)&&(s={slotStart:r,slotFinish:o,type:c.type,record:c.record,hasTerritory:c.hasTerritory,originalSlotStart:c.slotStart,isHolidaySlot:c.isHolidaySlot,slotColor:c.slotColor})}s&&n.push(s)}}return n.reduce(function(e,t){var n;return e.length?(n=e.pop()).slotFinish==t.slotStart&&n.record==t.record&&n.type==t.type&&n.isHolidaySlot==t.isHolidaySlot&&"shift"!=n.record&&"shift"!=t.record?(n.slotFinish=t.slotFinish,e.push(n)):e.push(n,t):e.push(t),e},[])}((m=b)&&m.length?m.reduce(function(e,t){return e.push(t.slotStart,t.slotFinish),e},[]).sort(function(e,t){return e-t}):[],b.sort(function(e,t){return e.slotStart-t.slotStart}));a&&G.operatingHoursAndHolidays()&&!function(){var e=$.formatDayToString(U(_)),e=(G.operatingHoursAndHolidays()[n]||{})[e]||[],t=[];e.forEach(function(e){t.push(B.enhanceHoliday(e,i,l,c,n))}),B.addHolidaysIntoCollection(t),C=function(e,t,n,i){e.forEach(function(e){return B.trimHoliday(e,n,i)}),e.sort(function(e,t){return e.start-t.start||e.finish-t.finish});e=B.mergeHolidays(e);return B.excludeHolidaysFromSlots(e,t,"slotStart","slotFinish")}(t,C,h,g)}();for(var k=0;k<C.length;k++){var D,R,F,O,M,E,x=$.intersectDates({start:C[k].slotStart,finish:C[k].slotFinish},{start:h,finish:g}).intersection;x&&(D=x.start,x=x.finish,"shift"==C[k].record&&C[k].slotColor?(j(v,D,i,null),j(D,x,i,C[k].record,C[k].slotColor)):"Extended"==C[k].type?(j(v,D,i,null),j(D,x,i,C[k].type)):j(v,D,i,C[k].type),E=O=F=M=R=void 0,R=D,M=x,F=C[k].type,O=i,M=(M.getTime()-R.getTime())/6e4,(E=H[O])||(E={},H[O]=E),O=$.formatDayToString(R),(R=E[O])||(R={regular:0,overtime:0},E[O]=R),"Extended"==F?R.overtime+=M:R.regular+=M,v=x)}}j(v,g,i,null)}function z(e,t,n,i,s,r,o){e=U(e),e.setHours(t[n]),e.setMinutes(t[i]),n=useLocationTimezone?s:userTimeZone;return o&&useLocationTimezone&&(n=r),U(V(e,s).tz(n))}function j(e,t,n,i,s){if(e.getTime()!=t.getTime()){var r,o={};for(r in scheduler.matrix)"MonthlyView"!==r&&"LongView"!==r&&(o[r]=-1<n.indexOf(",")?n.split(","):[n]);var a="gray_section",l=void 0,s=("shift"===i&&s?(l='<div style="background-color: '+(s+="99").encodeHTML()+'; width:100%; height:100%;"></div>',a=void 0):"Extended"===i&&(a="overtime_section"),o[Object.keys(o)[0]]);"gray_section"===a&&u[s]&&(u[s].start_date<t&&u[s].end_date>e||u[s].start_date==t&&u[s].end_date==e)||(scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:o,css:a,html:l}),u[s]={start_date:e,end_date:t,sections:o,css:a,html:l})}}function y(e){var t,n={},i=e||G.resourcesByPrimariesAndRelocations();for(t in i){var s,r,o=i[t],a={};for(s in n[t]=a,o){var l=o[s],c=a[l.serviceTerritory];c||(a[l.serviceTerritory]=c=[]),c.push({start:l.effectiveStartDate||l.start,finish:l.effectiveEndDate||l.finish,serviceTerritory:l.serviceTerritory,operatingHours:l.operatingHours,type:l.serviceTerritoryType||l.type,id:l.id,ohTerr:l.ohTerr||null,serviceTerritory__r:l.serviceTerritory__r||null})}for(r in a)a[r].sort($.sortByTime)}return n}c.$on("gotNewTimePhasedSTMsAndShifts",function(e,t){for(var n=t.start,i=t.finish,s=new Date(n),r=null;s<i;){var o=$.formatDayToString(s);if(!d[o]||c.isOptimizationViewer){d[o]=!0,r=r||y(G.resourcesAndTerritories());var a,l=new Date(s);for(a in l.setDate(l.getDate()+1),N.getResources())!function(e,t,n,i,s){var r,o={P:[],R:[],S:[]},a={};for(r in i){for(var l=i[r].slice(),c=$.generateResourceId(n,r),d=e,u=0;u<l.length;u++){var p=l[u],m=$.intersectDates({start:d,finish:t},p);if(o[p.type].push(p),"S"==p.type)a[p.serviceTerritory]=p;else if(m.intersection){for(var h,g=0;g<m.remainderFrom1.length;g++){var v=m.remainderFrom1[g];v.isStart&&j(v.start,v.finish,c)}"R"!=p.type||S[p.id]||s||!function(e,t,n){var i=[];if(showSecondarySTMs)for(var s in t)for(var r=0;r<t[s].length;r++)"S"!=t[s][r].type&&-1==i.indexOf(s)&&i.push(s);else i=Object.keys(t);i.splice(i.indexOf(e.serviceTerritory),1);var o=e.serviceTerritory;{var a;N.territories()[o]&&(o=N.territories()[o].operatingHours,a=N.getOperatingHours()[o].timezone)}for(var l=0;l<i.length;l++){var c=[$.generateResourceId(n,i[l])],d=(S[e.id]=!0,e.start),u=e.finish,p=(useLocationTimezone&&N.territories()[i[l]]&&(p=N.territories()[i[l]].operatingHours,p=N.getOperatingHours()[p].timezone,d=U(V(d,a).tz(p)),u=U(V(u,a).tz(p))),N.territories()[e.serviceTerritory]?N.territories()[e.serviceTerritory].name:null),m=null,h=null;h=p?(m=customLabels.Relocated_to.replace("$0",_.escape(p)),_.escape(customLabels.Relocated_to_many_params.replaceAll(p||customLabels.Relocated_No_Permissions,moment(d).format("llll"),moment(u).format("llll")))):(m=customLabels.Relocated_No_Permissions,_.escape(customLabels.Relocated_to_no_permissions_many_params.replaceAll(moment(d).format("llll"),moment(u).format("llll"))));scheduler.addMarkedTimespan({start_date:d,end_date:u,sections:{ZoomLevel2:c,ZoomLevel3:c,ZoomLevel4:c,ZoomLevel5:c,ZoomLevel6:c,ZoomLevel7:c},html:"<div class='relocatedLabel' title='"+h+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg> "+m+"</div>",css:"relocation"}),scheduler.addMarkedTimespan({start_date:d,end_date:u,sections:{MonthlyView:c,MTDView:c,LongView:c},html:"<div class='relocatedLabel' title='"+h+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg></div>",css:"relocation_monthly"})}}(p,i,n),d=m.intersection.finish,N.allTerritories[r]&&(p=p.operatingHours||N.allTerritories[r].operatingHours,h=G.resourcesAndShifts()[n],p?b(m.intersection.start,m.intersection.finish,p,c,s,null,h):j(m.intersection.start,m.intersection.finish,c))}}d.getTime()==t.getTime()||a[c.split("_")[1]]||j(d,t,c)}{var f;!showSecondarySTMs||$.isEmpty(a)||s||(f=y(function(e,t){var n={};n[t]={};for(var i=0;i<e.P.length;i++){var s=e.P[i];if(0==e.R.length)n[t][s.id]=s;else for(var r=0;r<e.R.length;r++){var o=e.R[r],a=$.intersectDates(s,o);if(a.intersection||(n[t][s.id]=s),0<a.remainderFrom1.length)for(var l=0;l<a.remainderFrom1.length;l++){var c=angular.copy(s);c.start=a.remainderFrom1[l].start,c.finish=a.remainderFrom1[l].finish,n[t][s.id+"_"+l]=c}n[t][o.id]||((o=angular.copy(o)).serviceTerritory=s.serviceTerritory,n[t][o.id]=o)}}var d={};d[t]={};for(var u=0;u<e.S.length;u++){var p,m=e.S[u];for(p in n[t]){var h=n[t][p],g=$.intersectDates(h,m);g.intersection&&((h=angular.copy(h)).start=g.intersection.start,h.finish=g.intersection.finish,window.isShowSecondaryOperatingHours&&m.operatingHours&&(h.operatingHours=m.operatingHours),h.ohTerr=h.serviceTerritory,h.serviceTerritory=m.serviceTerritory,d[t][p+"_"+u]=h)}}return d}(o,n)),function(e,t,n,i,s){for(var r in i){for(var o=i[r].slice(),a=$.generateResourceId(n,r),l=e,c=0;c<o.length;c++){var d=o[c],u=$.intersectDates({start:l,finish:t},d);if(u.intersection){for(var p=0;p<u.remainderFrom1.length;p++){var m=u.remainderFrom1[p];m.isStart&&j(m.start,m.finish,a)}l=u.intersection.finish;var h=void 0;try{h=d.operatingHours||(N.allTerritories[d.ohTerr]?N.allTerritories[d.ohTerr].operatingHours:d.serviceTerritory__r?d.serviceTerritory__r.OperatingHoursId:void 0)}catch(e){h=null}var g,v=G.resourcesAndShifts()[n];h||v.length?(g=void 0,N.getOperatingHours()[h]||(g=d.serviceTerritory__r.OperatingHours),b(u.intersection.start,u.intersection.finish,h,a,s,g,v)):j(u.intersection.start,u.intersection.finish,a)}}l.getTime()!=t.getTime()&&j(l,t,a)}}(e,t,n,f[n],!0))}}(new Date(s),new Date(l),a,r[a])}s.setDate(s.getDate()+1)}scheduler.updateView()});var e={resourceToWorkingDates:H,relocationsOnGantt:S,reset:function(){d={},S={},H={},u={},e.resourceToWorkingDates=H}};return e}]),!function(){function e(n,s,r,e,i,o,a,t,l,c,d){var u=null;function p(){a.setLightBoxStatus(!1),u.$destroy()}function m(e){u.capacityKpi={hoursCapacity:0,hoursInUse:0,completed:0,jeopardy:0,workItemsCapacity:0,workItemsAllocated:0,minutesUsed:0},u.dummyServicesCount=0;var t=scheduler.getEvent(e),n=scheduler.getEvents(t.start_date,t.end_date);u.servicesScheduledToCapacity={},u.capacityKpi.hoursCapacity=t.hoursPerTimePeriod||0,u.capacityKpi.hoursInUse=t.hoursInUse||0,u.capacityKpi.completed=0,u.capacityKpi.jeopardy=0,u.capacityKpi.violations=0,u.capacityKpi.workItemsCapacity=t.workItemsPerTimePeriod||0,u.capacityKpi.workItemsAllocated=t.workItemsAllocated||0,u.capacityKpi.total=0,u.capacityKpi.minutesUsedO2=void 0===t.minutesUsed?void 0:t.minutesUsed,u.capacityKpi.workItemsAllocatedO2=void 0===t.workItemsAllocated?void 0:t.workItemsAllocated;for(var i=0;i<n.length;i++)n[i].resourceId===t.resourceId&&"service"===n[i].type&&(n[i].isDummy?u.dummyServicesCount++:("LongView"!==scheduler._mode||scheduler.filter_LongView(n[i].id,n[i],!1))&&n[i].start.getTime()>=t.start_date.getTime()&&n[i].start.getTime()<=t.end_date.getTime()&&(u.capacityKpi.total++,n[i].statusCategory===l.COMPLETED&&u.capacityKpi.completed++,n[i].jeopardy&&u.capacityKpi.jeopardy++,n[i].violations&&u.capacityKpi.violations++,u.servicesScheduledToCapacity[n[i].id]=n[i]))}function h(){return void 0===u.capacityKpi.minutesUsedO2&&void 0===u.capacityKpi.workItemsAllocatedO2}function g(){if(void 0===u.capacityKpi.minutesUsedO2&&void 0===u.capacityKpi.workItemsAllocatedO2)return 0<u.capacityKpi.hoursCapacity&&0<u.capacityKpi.workItemsCapacity?customLabels.maximum_service_appointments_and_hours_allowed.replaceAll(u.capacityKpi.workItemsCapacity,u.capacityKpi.hoursCapacity):0===u.capacityKpi.hoursCapacity?customLabels.maximum_service_appointments_allowed.replaceAll(u.capacityKpi.workItemsCapacity):0===u.capacityKpi.workItemsCapacity?customLabels.maximum_hours_allowed.replaceAll(u.capacityKpi.hoursCapacity):void 0}function v(){return customLabels.KPIsAreCalculatedFromTo.replaceAll(moment(u.kpiStart).format("llll"),moment(u.kpiEnd).format("llll"))}function f(e){return 0<Object.keys(e).length?Object.keys(e):0}function S(e){s.flagged[e]?s.flagged[e]&&(s.flagged[e]=!s.flagged[e]):s.flagged[e]=!0}function _(e,t){""===(t=""===t?prompt(customLabels.msg_to_post_to_chatter,""):t)?alert(customLabels.no_empty_msg_to_chatter):(s.recentlyUsed[e]=!0,s.postToChatter([e],t).then(function(e){}))}function b(t){if(u.unscheduleRunning||!confirm(customLabels.are_you_sure_unschedule))return!0;var n=[],i=[];t.forEach(function(e){u.invokedActionFor[e]=!0,i.push(r.serviceAppointments()[e]),n.push(r.serviceAppointments()[e].resource),s.recentlyUsed[e]=!0}),u.unscheduleRunning=!0,s.unscheduleServices(t).then(function(e){s.drawServicesAndAbsences(e.services,e.absences,[],e.capacities),m(u.lightboxCapacity.id),u.invokedActionFor[t[0]]=!1,u.unscheduleRunning=!1}).catch(function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),u.invokedActionFor[t[0]]=!1,u.unscheduleRunning=!0})}function y(e){if(e.violations){for(var t="",n=0;n<e.violations.length;n++)t+=e.violations[n].RuleName+" - "+e.violations[n].ViolationString+"\n";return t=t&&t.substring(0,t.length-1)}}return{open:function(e){(u=n.$new(!0)).lightboxCapacity=r.resourceCapacities()[e],u.fieldsTypes=o.fieldsTypes,u.selectedTab="details",u.kpiStart=u.lightboxCapacity.start_date,u.kpiEnd=u.lightboxCapacity.end_date,u.servicesScheduledToCapacity={},u.tableSort={orderByField:"",reverse:!1},u.flaggedServices=s.flagged,u.invokedActionFor={},u.SERVICE_CATEGORY=l,u.currentMenu=null,u.dummyServicesCount=0,u.closeLightbox=p,u.openConsoleTab=o.openConsoleTab,u.formatKpitText=v,u.getObjectKeys=f,u.flagService=S,u.unscheduleServices=b,u.postToChatter=_,u.getStatusClass=o.getCSSClassByStatusCategory,u.violationsTooltip=y,u.calculateKpisForCapacity=m,u.showLongTermWarning=function(){return"LongView"===scheduler._mode},u.unscheduleRunning=!1,u.hideKpisForCapacity=h,u.formatAllowedCapacity=g,d.fieldsSetFields().then(function(e){u.servicesListFields=e.CapacityServiceColumns,u.tableSort.orderByField=u.servicesListFields[0].FullAPIName}),u.order=function(e,t){u.tableSort.orderByField=e,u.tableSort.reverse=t},u.getRefFieldID=function(e,t){return e[t.FullAPIName.replace("__r","__c")]},u.setCurrentMenu=function(e){u.currentMenu===e?u.currentMenu=null:u.currentMenu=e},u.getStyleForServiceInList=function(e){return window.paletteViewActive&&e.ganttPaletteColor?{background:e.ganttPaletteColor.color}:{background:e.ganttColor}},m(e);var t=angular.element('<div class="LightboxBlackContainer">\n\t\t\t\t<div class="LightboxContainer" id="ContractorCapacityLightbox">\n\n\t\t\t\t\t<div class="lightboxHeaderContainer" id="ContractorCapacityLightboxHeader">\n\n\t\t\t\t\t\t<svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.close+'"></use>\n\t\t\t\t\t\t</svg>\n\n\t\t\t\t\t\t<h1 class="lightboxHeader">\n\t\t\t\t\t\t\t<i>'+customLabels.Capacity+':</i>\n\t\t\t\t\t\t\t{{ lightboxCapacity.name }}\n\t\t\t\t\t\t</h1>\n\n\t\t\t\t\t\t<span class="lightboxSelectedTab">\n\t\t\t\t\t\t\t'+customLabels.Details+'\n\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t<div class="ExtendedForm">\n\t\t\t\t\t\t\t<a ng-click="openConsoleTab($event,lightboxCapacity.id)" target="_blank" href="../{{ lightboxCapacity.id }}" title="'+customLabels.ExtandedForm+'">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon openExternalIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.external+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div id="KPIforCapacity" class="KPIforCapacity" ng-hide="hideKpisForCapacity()">\n\t\t\t\t\t\t<div class="kpiIndicator" ng-show="capacityKpi.hoursCapacity > 0">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.hoursInUse }}/{{ capacityKpi.hoursCapacity }}</div>\n\t\t\t\t\t\t\t'+customLabels.Hours_Capacity+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator" ng-show="capacityKpi.workItemsCapacity > 0">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.standard_objects+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.workItemsAllocated }}/{{ capacityKpi.workItemsCapacity }}</div>\n\t\t\t\t\t\t\t'+customLabels.Services_Capacity+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t\x3c!--<i class="fa fa-warning"></i>--\x3e\n\t\t\t\t\t\t\t\t{{ capacityKpi.violations }}</div>\n\t\t\t\t\t\t\t'+customLabels.Violations+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.jeopardy+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.jeopardy }}</div>\n\t\t\t\t\t\t\t'+customLabels.In_Jeopardy+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\n\t\t\t\t\t\t\t\t{{ capacityKpi.completed }}/{{ capacityKpi.total }}</div>\n\t\t\t\t\t\t\t'+customLabels.Completed+'\n\t\t\t\t\t\t</div>\n\n                        <div class="KpiRange">{{formatKpitText()}}</div>\n\t\t\t\t\t\t<div class="KpiRange updateKpiData" ng-if="dummyServicesCount > 0" fsl-key-press tabindex="0" ng-click="calculateKpisForCapacity(lightboxCapacity.id)">\n                            New KPI data is available - click to update\n                        </div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="allowedCapacity" ng-show="hideKpisForCapacity()">{{formatAllowedCapacity()}}</div>\n\n                    <div id="ContractorCapacityButtons">\n                    \n                            <span id="LongViewWarning" ng-if="showLongTermWarning()">'+customLabels.LongTermCapacityLBWarning+'</span>\n                    \n                            <button class="capacityServiceUnscheduleAll" ng-disabled="unscheduleRunning" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0" ng-click="unscheduleServices(getObjectKeys(servicesScheduledToCapacity))">\n                                <i class="fa fa-ban"></i>\n                                 '+customLabels.Unschedule_All+'\n                            </button>\n                        </div>\n\t\t\t\t\t<div id="ContractorCapacityLightboxContent">\n\t\t\t\t\t\n                            <div class="NoServicesFound" ng-show="!getObjectKeys(servicesScheduledToCapacity)">\n                                <i class="fa fa-times"></i>\n                                <div>'+customLabels.No_services+'</div>\n                            </div>\n                        \n                        <table id="CapacityServicesTable" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0">\n                          <thead>\n                            <tr class="table-header">\n                                <th></th>\n                                <th></th>\n                                <th></th>\n                                <th ng-attr-title="{{field.Label}}" ng-repeat="field in servicesListFields" ng-class="{sortCapacityServicesBy: tableSort.orderByField == field.FullAPIName}" class="truncate capacityServiceColName" ng-click="tableSort.reverse=!tableSort.reverse;order(field.FullAPIName, tableSort.reverse)">\n                                    <span class="">{{field.Label}}</span>\n                                    <span ng-show="tableSort.orderByField == field.FullAPIName">\n                                        <span>\n                                            <svg ng-show ="!tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </span>\n                                    </span>\n                                </th>\n                            </tr>\n                          </thead>\n                          <tbody>\n                            <tr ng-repeat="(key, capacityService) in servicesScheduledToCapacity | orderObjectBy:tableSort.orderByField:tableSort.reverse" class="capacityServiceRow">\n                                <td ng-style="getStyleForServiceInList(capacityService)" class="TaskStatusColor {{ getStatusClass(capacityService.statusCategory, SERVICE_CATEGORY) }}" ></td>\n                                <td class="moreOptions">\n                                    <button class="serviceCapacityActionsButton" title="Actions" ng-click="setCurrentMenu($index)">\n                                          <svg class="slds-icon carretDownIcon" aria-hidden="true" ng-show="!invokedActionFor[capacityService.id]">\n                                                <use xlink:href="'+lsdIcons.down+'"></use>\n                                          </svg>\n                                          <img class="capacityServiceLoading"\n                                             src="'+lsdIcons.spinnerGif+'"\n                                             ng-show="invokedActionFor[capacityService.id]"/>\n                                    </button>   \n                                    <div id="actions-menu-{{$index}}" class="serviceCapacityActions" ng-show="currentMenu == $index">\n                                        <a fsl-tab-switch role="select" class="saSingleAction" ng-click="openConsoleTab($event,capacityService.id); setCurrentMenu($index);" target="_blank" href="../{{ capacityService.id }}">'+customLabels.Details+'</a>\n                                        <button fsl-tab-switch role="select" class="saSingleAction" ng-click="flagService(capacityService.id); setCurrentMenu($index);">\n                                            <span ng-show="!flaggedServices[capacityService.id]">'+customLabels.Flag+'</span>\n                                            <span ng-show="flaggedServices[capacityService.id]">'+customLabels.Unflag+'</span>\n                                        </button>\n                                        <button fsl-tab-switch role="select" ng-disabled="unscheduleRunning" class="saSingleAction" ng-click="unscheduleServices([capacityService.id]); setCurrentMenu($index);">'+customLabels.Unschedule+'</button>\n                                        <button fsl-tab-switch role="select" class="saSingleAction" ng-click="postToChatter(capacityService.id, \'\'); setCurrentMenu($index);">'+customLabels.Chatter+'</button>\n                                    </div>\n                                </td>\n                                <td class="iconOnServiceRow"\n                                        title="{{ violationsTooltip(capacityService) }}"\n                                        ng-class="{\'serviceList_jeopardy\': capacityService.jeopardy, \'serviceList_violations\': !capacityService.jeopardy && capacityService.violations}">\n                                        <i class="fa fa-bell" ng-if="capacityService.jeopardy"></i>\n                                        <i class="fa fa-warning" ng-if="capacityService.violations && !capacityService.jeopardy"></i>\n                                </td>\n                                <td ng-attr-title="{{capacityService | displayFieldSetField : field}}" ng-repeat="field in servicesListFields" class="truncate">\n                                    <span ng-show="field.Type != fieldsTypes.Reference" title="{{capacityService | displayFieldSetField : field}}">{{capacityService | displayFieldSetField : field}}</span>\n                                    <a ng-show="field.Type == fieldsTypes.Reference" ng-click="openConsoleTab($event, getRefFieldID(capacityService, field))" target="_blank" href="../{{ getRefFieldID(capacityService, field) }}" title="{{capacityService | displayFieldSetField : field}}">\n                                        {{capacityService | displayFieldSetField : field}}\n                                    </a>\n\n                                </td>\n                            </tr>\n                          </tbody>\n                        </table>\n\n\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>');t.find("#ContractorCapacityLightbox").draggable({containment:"document",handle:"#ContractorCapacityLightboxHeader"}),angular.element("body").append(t),a.setLightBoxStatus(),u.$on("$destroy",function(){return t.remove()}),u.$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)}),i(t)(u),o.safeApply(u)}}}e.$inject=["$rootScope","servicesService","TimePhasedDataService","$sce","$compile","utils","StateService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","FieldSetFieldsService"],angular.module("serviceExpert").factory("CapacityLightboxService",e)}(),!function(){function e(i,s,e,p,m,h,g,t,r,v,o){var n,a,l,f=null,c=deltaInterval||10,d=null,S={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]};function u(){var e,t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];!1!==h.getStreamingActiveState()||o.isPushServiceActive()||(e=h.getDeltaDates(),s.getDelta(f,e.minDate,e.maxDate).then(function(e){y(e,t)}).catch(function(e){console.warn(e)}))}function _(e){var n=!(0<arguments.length&&void 0!==e)||e,i=new Date;!1!==h.getStreamingActiveState()||o.isPushServiceActive()?d=r(b,1e3*c):(e=h.getDeltaDates(),s.getDelta(f,e.minDate,e.maxDate).then(function(e){var t=1e3*c-(t=i,new Date-t);d=r(b,t<0?0:t),y(e,n)}).catch(function(e){g.addNotification(customLabels.DeltaFailureTitle,customLabels.DeltaFailureMessage,null,null),console.warn(e)}))}function b(){h.isUserIdle()||_(window.__gantt.checkRulesAfterDelta)}function y(t){var n,i,s,r,e,o,a,l,c,d=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],u=(f=t.updateTime,[]);(t.deletedAbsence&&0<t.deletedAbsence.length||t.updatedAbsence&&0<t.updatedAbsence.length)&&(n={},i={},t.updatedAbsence=t.updatedAbsence.filter(function(e){return e.RecordType}),0<t.updatedAbsence.length&&(t.updatedAbsence.forEach(function(e){var t;!e.RecordType||"Non_Availability"!==e.RecordType.DeveloperName||(t=p.resourceAbsences()[e.Id])&&!t.wasSchedulingChanged(e)||(i[e.Id]=!0)}),e=p.updateTimePhaseData(t.updatedAbsence,"na"),n.updated=e.absences,n.deleted=e.notApprovedAbsencesIds,0<Object.keys(i).length)&&(s=[],n.updated.forEach(function(e){i[e.id]&&s.push(e.resource)}),s.join(","),u.push.apply(u,_toConsumableArray(g.getRelatedServices(Object.keys(i),s)))),0<t.deletedAbsence.length&&(n.deleted=n.deleted?n.deleted.concat(p.deleteTimePhaseData(t.deletedAbsence,"na").absences):p.deleteTimePhaseData(t.deletedAbsence,"na").absences,u.push.apply(u,_toConsumableArray(g.getRelatedServices(n.deleted)))),n.updated||n.deleted)&&S.absences.forEach(function(e){return e(n)}),(t.updatedGanttServices&&0<t.updatedGanttServices.length||t.deletedGanttServices&&0<t.deletedGanttServices.length)&&(r={},0<t.deletedGanttServices.length&&(r.deleted=p.deleteTimePhaseData(t.deletedGanttServices,"service").services,u.push.apply(u,_toConsumableArray(g.getRelatedServices(r.deleted)))),0<t.updatedGanttServices.length&&(o=[],t.updatedGanttServices.forEach(function(e){var t=p.serviceAppointments()[e.Id];t&&!t.wasSchedulingChanged(e)||o.push(e.Id)}),r.updated=p.updateTimePhaseData(t.updatedGanttServices,"service").services,0<o.length)&&(e=new Set(g.getRelatedServices(o)),o=Array.from(e),u.push.apply(u,_toConsumableArray(o))),(r.updated||r.deleted)&&S.services.forEach(function(e){return e(r)}),v.calculateKpis()),t.updatedLivePositions&&(a=m.updatePositions(t.updatedLivePositions)).isUpdated&&S.positions.forEach(function(e){return e(a.dic)}),0<u.length&&(l=Array.from(new Set(u)),S.rules.forEach(function(e){return e(l,d)})),h.areContractorsSupported&&(t.deletedCapacities&&0<t.deletedCapacities.length||t.updatedCapacities&&0<t.updatedCapacities.length)&&(c={},0<t.deletedCapacities.length&&(c.deleted=p.deleteTimePhaseData(t.deletedCapacities,"capacity").capacities),0<t.updatedCapacities.length&&(c.updated=p.updateTimePhaseData(t.updatedCapacities,"capacity").capacities),c.updated||c.deleted)&&S.capacities.forEach(function(e){return e(c)}),h.isOptimizationEnabled&&t.optimizationRequests&&0<t.optimizationRequests.length&&S.optimizationRequests.forEach(function(e){return e(t.optimizationRequests)})}return d=r(b,1e3*c),h.getStreamingActiveState()?console.log("using streaming"):o.isPushServiceActive()?console.log("using push service"):(n=0,document.addEventListener("mousemove",function(){c=deltaInterval||10,300<n&&deltaInterval<60&&!h.isUserIdle()&&(r.cancel(d),d=r(b,1e3*c),console.warn("Delta interval back to normal.")),n=0}),window.Worker&&((a=new Worker(window.__gantt.InactivityMonitorWorker)).onmessage=function(e){300<=(n+=10)&&deltaInterval<60&&c<60&&(c=60,console.warn("Delta interval decreased.")),h.isUserIdle()&&a.terminate()}),l=setInterval(function(){300<=n&&deltaInterval<60&&60!==c&&(c=60,console.warn("Delta interval decreased.")),n>=window.__gantt.maxSecondsOfInactivity&&clearInterval(l)},30010)),{register:function(e,t){return S[e]&&S[e].push(t)},unRegister:function(e,t){S[e].splice(S[e].indexOf(t),1)},getDelta:u,getDeltaPromise:function(){var e,t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],n=i.defer();return!1!==h.getStreamingActiveState()||o.isPushServiceActive()?n.resolve():(e=h.getDeltaDates(),s.getDelta(f,e.minDate,e.maxDate).then(function(e){y(e,t),n.resolve(e)}).catch(function(e){console.warn(e),n.reject(res.ex)})),n.promise},updateOptimizationRequest:function(t){S.optimizationRequests.forEach(function(e){return e([t])})},handleDeltaResponse:y,updateGantt:function(){h.getStreamingActiveState()||o.isPushServiceActive()||u("On Demand"!==window.__gantt.checkRulesMode)}}}e.$inject=["$q","sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils","MstResolver","$timeout","kpiCalculationsService","PushServices"],angular.module("serviceExpert").factory("DeltaService",e)}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof=(!function(){function e(e,l){var c,d=e.defer(),u=e.defer();return e.all([l.callRemoteAction(RemoteActions.getServiceListFields),l.callRemoteAction(RemoteActions.getServiceMiniFormFields),l.callRemoteAction(RemoteActions.getServiceMapInfoWindowFields),l.callRemoteAction(RemoteActions.getServiceGanttTooltipFields),l.callRemoteAction(RemoteActions.getServiceCapacityColumns),l.callRemoteAction(RemoteActions.getGanttFilterFields),l.callRemoteAction(RemoteActions.getServicePreviewFields)]).then(function(e){if(c={ListColumns:e[0],ListExpanded:e[1],MapInfo:e[2],GanttToolTip:e[3],CapacityServiceColumns:e[4],ganttFilter:e[5],servicePreview:e[6]},l.isOptimizationViewer()){if("object"!==_typeof(GanttServiceOptiViewer.prototype.allFieldSets)){GanttServiceOptiViewer.prototype.allFieldSets=c;var t,n={};for(t in GanttServiceOptiViewer.prototype.allFieldSets)for(var i=GanttServiceOptiViewer.prototype.allFieldSets[t],s=0;s<i.length;s++)n[i[s].APIName]=i[s];GanttServiceOptiViewer.prototype.allFieldSetsSet=n}}else if("object"!==_typeof(GanttService.prototype.allFieldSets)){GanttService.prototype.allFieldSets=c;var r,o={};for(r in GanttService.prototype.allFieldSets)for(var a=GanttService.prototype.allFieldSets[r],s=0;s<a.length;s++)o[a[s].APIName]=a[s];GanttService.prototype.allFieldSetsSet=o,u.resolve(Object.keys(o))}d.resolve(c)}).catch(function(e){d.reject(),u.reject(),console.warn("FieldSetFieldsService: unable to get service appointment field sets")}),{fieldsSetFields:function(){return d.promise},serviceAppointmentFields:function(){return u.promise}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("FieldSetFieldsService",e)}(),!function(){function e(t,r,i,e){var n,o=t.defer(),a=[],s={};function l(e){for(var t,n,i=e,s=1;s<=10;s++)1===s&&-1<e.indexOf("1")?(t=i.indexOf(1),n=i.indexOf(10),-1!==t&&t===n&&(t=i.lastIndexOf(1)),i=i.substr(0,t)+"{1} "+i.substr(t+2)):-1!==i.indexOf(s)&&(i=i.replace(s,"{"+s+"}"));return i}function c(t){var e=!1,n=!1;try{t[fieldNames.GanttFilter.Criterias]&&(e=JSON.parse(t[fieldNames.GanttFilter.Criterias]))}catch(e){n=!0,i.addNotification(window.customLabels.CustomFilterInvalidCriteriaButlerMsg,window.customLabels.CustomFilterInvalidCriteriaButlerBody.replace("$0",t[fieldNames.GanttFilter.Name]),null,null)}return{Id:t.Id,Name:t[fieldNames.GanttFilter.Name],Description:t[fieldNames.GanttFilter.Description],Days_after_horizon:t[fieldNames.GanttFilter.Days_after_horizon],Days_before_horizon:t[fieldNames.GanttFilter.Days_before_horizon],Criterias:e,List_only_appointments_on_the_gantt:t[fieldNames.GanttFilter.List_only_appointments_on_the_gantt],Logic:function(e,t){if(e)return l(e);for(var n in e="",t)e+=n+" AND ";return l(e.substr(0,e.length-5))}(t[fieldNames.GanttFilter.Logic],e),Public:t[fieldNames.GanttFilter.Public],Hidden:t[fieldNames.GanttFilter.Hidden],CreatedById:t.CreatedById,Displayed_Fields:t[fieldNames.GanttFilter.Displayed_Fields]?JSON.parse(t[fieldNames.GanttFilter.Displayed_Fields]):null,disabled:n}}function d(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0}return useNewFilters&&(n=r.callRemoteAction(RemoteActions.getGanttFilters),e=e.fieldsSetFields(),t.all([n,e]).then(function(e){var t,n=e[1],e=e[0],i={FSL__RULE_VIOLATIONS__FSL:!0};for(t in n)n[t].forEach(function(e){i[e.FullAPIName]=!0,i[e.APIName]=!0});var s=[];e.forEach(function(e){e=c(e);!function(e,t){if(e.Criterias)for(var n in e.Criterias){if(-1<e.Criterias[n].property.indexOf("."))return console.warn("INVALID FILTER: "+e.Name+" (Id: "+e.Id+")"),0;if(!t[e.Criterias[n].property])return console.warn("INVALID FILTER: "+e.Name+" (Id: "+e.Id+")"),0}return 1}(e,i)||s.push(e)}),s.sort(d),a=s,o.resolve(s)})),{filtersPromise:o.promise,getFilterById:function(t){var n=null;return a.forEach(function(e){n=e.Id===t?e:n}),n},getFilterFromSalesforce:function(e){var s=t.defer();return r.callRemoteAction(RemoteActions.getFilterById,e).then(function(e){for(var t=c(e),n=!0,i=0;i<a.length;i++)if(a[i].Id===t.Id){a[i]=t,n=!1;break}n&&(a.push(t),a.sort(d)),s.resolve(t)}),s.promise},deleteFilter:function(n){var i=t.defer();return r.callRemoteAction(RemoteActions.deleteFilter,n).then(function(){for(var e=-1,t=0;t<a.length;t++)if(a[t].Id===n){e=t;break}-1!==e&&a.splice(e,1),i.resolve(n)}),i.promise},hideFilter:function(n){var i=t.defer();return r.callRemoteAction(RemoteActions.hideFilter,n).then(function(){for(var e=-1,t=0;t<a.length;t++)if(a[t].Id===n){e=t;break}-1!==e&&a.splice(e,1),i.resolve(n)}),i.promise},setFilterMap:function(e){s=Object.assign(e,{})},getFilterMap:function(){return s}}}e.$inject=["$q","sfdcService","utils","FieldSetFieldsService"],angular.module("serviceExpert").factory("GanttFilterService",e)}(),"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e});function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}!function(){function e(l,e,u,c,p,m){var d=void 0,h=void 0,g=void 0,a=!1,v=l.defer();function f(e,t){for(var n in e)t(e[n])}function S(e){e.ganttPaletteColor&&e.ganttPaletteColor.palleteId===h.Id||(!0===e.fields[h.ServicePropertyNoNamespace]?e.ganttPaletteColor={color:h.ColorScheme.max.color,palleteId:h.Id}:e.ganttPaletteColor={color:h.ColorScheme.min.color,palleteId:h.Id})}function _(e){var t;e.ganttPaletteColor&&e.ganttPaletteColor.palleteId===h.Id||(t=void 0===(t=e.fields[h.ServicePropertyNoNamespace])?h.ColorScheme.empty:h.ColorScheme.picklist[h.ServiceProperty][t],e.ganttPaletteColor={color:t,palleteId:h.Id})}function b(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t,n=e.fields[h.ServicePropertyNoNamespace],i=(useLocationTimezone&&(t=void 0,e.resourceId?(c=m.getRelevantSTMToGanttService(e))&&c.operatingHours?t=c.operatingHours:c.serviceTerritory&&(t=p.territories()[c.serviceTerritory].operatingHours):e.ServiceTerritoryId&&(t=p.territories()[e.ServiceTerritoryId].operatingHours),c=p.getOperatingHours()[t],t=c?c.timezone:userTimeZone,c=new Date(n),d=userTimeZone,n=u.convertDateBetweenTimeZones(c,t,d).getTime()),void 0),s=void 0,r=void 0,o=void 0,a=void 0;if(void 0===n)i=h.ColorScheme.empty;else{for(var l in g){if(g[l].start<n&&n<=g[l].end){i=l;break}(void 0===s||g[l].start<=s)&&(s=g[l].start,o=l),(void 0===r||g[l].end>r)&&(r=g[l].end,a=l)}void 0===i&&(i=r<n?a:o)}e.ganttPaletteColor={color:i,palleteId:h.Id}}var c,d}function y(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t=e.fields[h.ServicePropertyNoNamespace],n=void 0,i=void 0,s=void 0,r=void 0,o=void 0;if(void 0===t)n=h.ColorScheme.empty;else{for(var a in g){if(g[a].start<t&&t<=g[a].end){n=a;break}(void 0===i||g[a].start<=i)&&(i=g[a].start,r=a),(void 0===s||g[a].end>s)&&(s=g[a].end,o=a)}void 0===n&&(n=s<t?o:r)}e.ganttPaletteColor={color:n,palleteId:h.Id}}}function w(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t=e.fields[h.ServicePropertyNoNamespace],n=void 0,i=void 0,s=void 0,r=void 0,o=void 0;if(void 0===h.ColorScheme.geolocation.latitude||void 0===h.ColorScheme.geolocation.longitude)n=h.ColorScheme.empty;else{var a,l=A(h.ColorScheme.geolocation.latitude,h.ColorScheme.geolocation.longitude,t.latitude,t.longitude);for(a in g){if(g[a].start<l&&l<=g[a].end){n=a;break}(void 0===i||g[a].start<=i)&&(i=g[a].start,r=a),(void 0===s||g[a].end>s)&&(s=g[a].end,o=a)}void 0===n&&(n=s<l?o:r)}e.ganttPaletteColor={color:n,palleteId:h.Id}}}function T(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){e.fields[h.ServicePropertyNoNamespace];var t=void 0,n=void 0,i=void 0,s=void 0,r=void 0;if(void 0===h.ColorScheme.geolocation.latitude||void 0===h.ColorScheme.geolocation.longitude)t=h.ColorScheme.empty;else{var o,a=A(h.ColorScheme.geolocation.latitude,h.ColorScheme.geolocation.longitude,e.latitude,e.longitude);for(o in g){if(g[o].start<a&&a<=g[o].end){t=o;break}(void 0===n||g[o].start<=n)&&(n=g[o].start,s=o),(void 0===i||g[o].end>i)&&(i=g[o].end,r=o)}void 0===t&&(t=i<a?r:s)}e.ganttPaletteColor={color:t,palleteId:h.Id}}}function L(e,t){var n;switch(e){case"Seconds":n=1e3*t;break;case"Minutes":n=60*t*1e3;break;case"Hours":n=60*t*60*1e3;break;case"Days":n=24*t*60*60*1e3}return n}function A(e,t,n,i){e=Math.PI*e/180,n=Math.PI*n/180,t=Math.PI*(t-i)/180,i=Math.sin(e)*Math.sin(n)+Math.cos(e)*Math.cos(n)*Math.cos(t);return i=60*(180*Math.acos(i)/Math.PI)*1.1515,"km"===distanceUnit?1.609344*i:.8684*i}return{serviceFieldsMap:function(){var n=l.defer();return void 0!==d?setTimeout(function(){n.resolve(d)},0):e.callRemoteAction(RemoteActions.getServiceFieldsMap).then(function(e){for(var t in d={},e)d[t]=JSON.parse(e[t].replace(/&quot;/g,'"'));n.resolve(d)}).catch(function(e){n.reject(e)}),n.promise},applyNewPaletteForGantt:function(e,t){var n=l.defer();if(void 0===h||h.Id!==e.Id){c.SetUserSettingsProperty("Gantt_Palette__c",e.Id);var i,s,e=d[(h=e).ServiceProperty],r=e.Type,o=!1;if(g={},FieldTypes.DATETIME!==r&&FieldTypes.DATE!==r||(s=function(e,t,n,i,s){for(var r=u.convertMomentDtToDt(moment().tz(userTimeZone)),n=L(n,e),e=L(i,t),o=r.getTime()+n,a=(r.getTime()+e-o)/s,l=[],c=0;c<s;c++)l.push({start:o+c*a,end:o+(c+1)*a});return l}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorScheme.min.type,h.ColorScheme.max.type,h.ColorLevel),o=!0),FieldTypes.DOUBLE!==r&&FieldTypes.LOCATION!==r&&FieldTypes.ADDRESS!==r||(s=function(e,t,n){e=parseFloat(e);for(var i=((t=parseFloat(t))-e)/n,s=[],r=0;r<n;r++)s.push({start:e+r*i,end:e+(r+1)*i});return s}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorLevel),o=!0),FieldTypes.INTEGER!==r&&FieldTypes.PERCENT!==r||(s=function(e,t,n){e=parseInt(e);for(var i=((t=parseInt(t))-e)/n,s=(i=Math.round(i),[]),r=0;r<n;r++)s.push({start:e+r*i,end:e+(r+1)*i});return s}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorLevel),o=!0),o){i=function(e,t,n){for(var i=[],s=e.substr(1,2),r=e.substr(3,4).substr(0,2),e=e.substr(5,6),o=t.substr(1,2),a=t.substr(3,4).substr(0,2),t=t.substr(5,6),l=parseInt(s,16),c=parseInt(r,16),d=parseInt(e,16),s=parseInt(o,16),r=parseInt(a,16),e=parseInt(t,16),u=(s-l)/n,p=(r-c)/n,m=(e-d)/n,h=0;h<n;h++){var g=Math.round(Math.abs(l+u*h))%256,v=Math.round(Math.abs(c+p*h))%256,f=Math.round(Math.abs(d+m*h))%256,g=g.toString(16),v=(1===g.length&&(g="0"+g),v.toString(16)),f=(1===v.length&&(v="0"+v),f.toString(16));1===f.length&&(f="0"+f),i.push("#"+g+v+f)}return i}(h.ColorScheme.min.color,h.ColorScheme.max.color,h.ColorLevel);for(var a=0;a<i.length;a++)g[i[a]]=s[a]}switch(e.Type){case FieldTypes.BOOLEAN:f(t,S);break;case FieldTypes.PICKLIST:f(t,_);break;case FieldTypes.DATETIME:case FieldTypes.DATE:f(t,b);break;case FieldTypes.DOUBLE:case FieldTypes.INTEGER:case FieldTypes.PERCENT:f(t,y);break;case FieldTypes.LOCATION:f(t,w);break;case FieldTypes.ADDRESS:f(t,T);break;default:console.log("Other")}}return n.resolve(),n.promise},getGanttPalettes:function(){return e.callRemoteAction(RemoteActions.getGanttPalettes).then(function(e){for(var t,n=e.palettes,i=(a=!0,{}),s=0;s<n.length;s++){var r={};if(r.Id=n[s].Id,r.Name=n[s][fieldNames.GanttServicePalette.Name],r.ServiceProperty=n[s][fieldNames.GanttServicePalette.ServiceProperty],r.ServicePropertyNoNamespace=u.removeFSLNamespace(r.ServiceProperty),void 0!==n[s][fieldNames.GanttServicePalette.ColorScheme])try{r.ColorScheme=JSON.parse(n[s][fieldNames.GanttServicePalette.ColorScheme])}catch(e){r.ColorScheme=void 0}else r.ColorScheme=void 0;r.Description=n[s][fieldNames.GanttServicePalette.Description],r.ColorLevel=n[s][fieldNames.GanttServicePalette.ColorLevel],r.Active=n[s][fieldNames.GanttServicePalette.Active],i[r.Id]=r}for(t in i){var o=i[t]&&i[t].ServiceProperty;o&&e.translations[o]&&(i[t].translations=e.translations[o])}v.resolve(i)}).catch(function(e){v.reject(e)}),v.promise},updateGanttServicePaletteColor:function(e){if(void 0!==h)switch(d[h.ServiceProperty].Type){case FieldTypes.BOOLEAN:S(e);break;case FieldTypes.PICKLIST:_(e);break;case FieldTypes.DATETIME:case FieldTypes.DATE:b(e);break;case FieldTypes.DOUBLE:case FieldTypes.INTEGER:case FieldTypes.PERCENT:y(e);break;case FieldTypes.LOCATION:w(e);break;case FieldTypes.ADDRESS:T(e);break;default:console.log("Other")}},resetCurrentPalette:function(){h=void 0,window.paletteViewActive=!1},isEmpty:function(e){if(null!=e){if(0<e.length)return!1;if(0!==e.length&&"object"===(void 0===e?"undefined":_typeof(e)))for(var t in e)if(hasOwnProperty.call(e,t))return!1}return!0},werePalettesLoaded:function(){return a}}}e.$inject=["$q","sfdcService","utils","userSettingsManager","ResourcesAndTerritoriesService","TimePhasedDataService"],angular.module("serviceExpert").factory("GanttPalettesService",e)}(),!function(){function e(i,s,r,o,a,e){var l=null;function n(){return l.closeLightbox()}function c(){l.killWatch&&l.killWatch(),a.setLightBoxStatus(!1),e.updateGantt(),l.$destroy(),l=null}return window.addEventListener("message",function(e){var t;"closeLightbox"===e.data&&(e=e.origin,t=window.location.origin.split("."),e=e.split("."),t.at(-1)===e.at(-1))&&t.at(-2)===e.at(-2)&&n()},!1),{open:function(e,t){var n;l||((l=i.$new(!0)).url=s.trustAsResourceUrl(t).toString(),__gantt.communityNetworkId&&(l.url=l.url.replace("/apex/","")),t.includes("SFSPWR")&&(t=window.orgUrl+t.replace("c__SFSPWR.","SFSPWR__"),l.url=s.trustAsResourceUrl(t)),l.title=e,l.closeLightbox=c,(n=angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer lightbox-general" id="ResourceLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            \n                            <h1 class="light-box-header" ng-bind="title"></h1>\n                        </div>\n                        \n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ url }}" class="resourceLightboxIframe"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>")).find("#ResourceLightbox").draggable({containment:"document",handle:"#ResourceLightboxHeader"}),n.find("#ResourceLightbox").resizable({minHeight:560,minWidth:940,maxWidth:940,handles:"s"}),angular.element("body").append(n),a.setLightBoxStatus(),l.$on("$destroy",function(){return n.remove()}),l.$on("keypress",function(e,t){27==t.which&&l.$evalAsync(l.closeLightbox)}),r(n)(l),o.safeApply(l))},closeLightboxFromOutside:n}}e.$inject=["$rootScope","$sce","$compile","utils","StateService","DeltaService"],angular.module("serviceExpert").factory("GeneralLightbox",e)}(),!function(){function e(y,n,w,l,i,T,L,s,e,c,d,r,u,o){var a=2,A=null,I=null,p=!1,m={STAR:candidatesGrades.ideal,EXCELLENT:candidatesGrades.ideal,GOOD:candidatesGrades.reecommended},h=L.isRtlDirection();function g(e){A&&f(),A=y.$new(!0),window.__servicesInFilter&&(window.__servicesInFilter.applied=!1,updateViewDebounced()),I=null,A.StateService=L,A.wereSlotsAlreadyDrawnOnGantt=!1,A.gettingSlots=!0,A.closePanel=f,A.hideSlots=v,A.getResourceField=_,A.generateMstText=Y,A.formatDateIntervalFinish=k,A.formatDateInterval=b,A.service=w.serviceAppointments()[e],A.generateResultText=R,A.allSlotsArray=null,A.slotsTimespansIds=[],A.trustHtml=T.trust,A.jumpToDate=N,A.GRADES=m,A.scheduleToSlot=X,A.replaceLabels=G,A.openLightbox=B,A.showOnGantt=H,A.formatDateHeader=D,A.notifyWhenDoneGettingSlots=F,A.shouldNotify=!1,A.scheduledActionInvoked=!1,A.groupSlotsBy="Resource",A.roundGrade=S,A.bestSlot=null,A.gotSlots=!0,A.exception=null,A.isMst=!1,A.mstPromise=null,A.schedulingTakesLong=!1,A.rawTimespans=[],A.partialResults=[],A.showPartialData=!1,A.generateAsyncLabel=Z,A.getAriaLabel=K,A.formatTooltipHeader=W,A.formatAsapObjective=q,A.isRelatedSALength=0,A.generateRelatedSAO2Text=J,A.hideSlotsWasClicked=!1,A.handleSortByChanged=U,A.handleGroupByChanged=V,A.sortBy="name",A.sortOrder=1,A.lastSortBy="date",A.lastSortOrder=1,A.compareByName=z,A.compareByDate=j,A.sortGradeButtonClassName=h?"sort-button-grade rtl-button-sort-locator":"sort-button-grade",A.isAdmin=!1,void 0===window.userHasAdminPermissions?l.callRemoteAction(RemoteActions.userHasAdminPermissions).then(function(e){window.userHasAdminPermissions=!!e&&(A.isAdmin=!0)}):A.isAdmin=window.userHasAdminPermissions,A.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},p||l.getSlots(e,L.selectedPolicyId).then(function(e){A.hideSlotsWasClicked||(e&&e.value&&e.value.FSLOperationId?(A.isMst=!0,n(function(){return A.schedulingTakesLong=!0},1e3*a),A.mstPromise=r.getUpdates(e.value.FSLOperationId).then(function(e){return A.shouldNotify||O({value:e.fslOperation.result}),e}).catch(function(e){console.error(e);e={message:e.message||e};return A.shouldNotify||O({eventType:"exception",event:e}),o.reject({eventType:"exception",event:e})})):O(e))}).catch(function(e){var t={message:e.message||e};console.warn("could not get candidates"),console.log(e),A.shouldNotify||O({eventType:"exception",event:t})}),e="getResourceField( candidate.Resource.Resource.Id, 'serviceCrew__r')."+fieldNames.ServiceCrew.GanttColor__c,e='\n                <div id="GetSlotsPanel" xmlns="http://www.w3.org/1999/html">\n\n                    <div class="slots-panel-title-head">\n                        <div class="slots-panel-title">\n                            {{ replaceLabels(\'ShowingCandidatesTo\', [service.name] ) }}\n                        </div>\n                        <div class="clear-slots truncate" ng-click="hideSlots()" title="'+customLabels.HideSlots+'">'+customLabels.HideSlots+'</div>\n                    </div>\n\n\n                    <div ng-show="gettingSlots && !wereSlotsAlreadyDrawnOnGantt" class="getting-slots">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.FindingCandidates+'\n                        \n                        <div class="get-slots-mst" ng-show="isMst && schedulingTakesLong">\n                            {{ generateAsyncLabel() }}\n                            <div class="get-slots-mst-button" ng-click="notifyWhenDoneGettingSlots()">'+customLabels.MstNotifyMeWhenDone+'</div>\n                        </div>\n                    </div>\n                    \n                    \n                    <div ng-show="exception" class="get-slots-error">\n                        <svg aria-hidden="true" class="slds-icon">\n                          \u2028<use xlink:href=\''+lsdIcons.violation+"'></use>\n                        \u2028</svg>\n                        {{ exception.message }}\n                        \n                        <div>"+customLabels.ContactSysAdmin+'</div>\n                    </div>\n                    \n                    <div ng-show="!gotSlots && !exception" class="get-slots-error">\n                        <i class="fa fa-frown-o"></i>\n                        \n                        <div>'+customLabels.noCandidatesMessageGantt+'</div>\n                        \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                    </div>\n\n\n\n\n                    <div class="slots-results-recommendations" ng-if="allSlotsArray" ng-show="gotSlots">\n                        <span id="slotsSentence"></span>\n                        <div class="assign-to-recommended" ng-click="scheduleToSlot(bestSlot.Interval.Start, bestSlot.Resource.Resource.Id, StateService.selectedPolicyId,bestSlot)">'+customLabels.AssignToRecommended+'</div>\n                    </div>\n\n\n\n                    <div class="slots-grouping" ng-show="allSlotsArray" ng-show="gotSlots">\n                        <span class="truncate groupSlotsBy" title="'+customLabels.GroupSlotsBy+'">'+customLabels.GroupSlotsBy+'</span>\n                        <input type="radio" id="groupByResource" name="groupBy" ng-model="groupSlotsBy" value="Resource" checked="checked" ng-change="handleGroupByChanged()">\n                        <label class="groupSlotsBy slots-groupByResource truncate" for="groupByResource" title="'+customLabels.Resource+'">'+customLabels.Resource+'</label>\n                        <input type="radio" id="groupByName" name="groupBy" ng-model="groupSlotsBy" value="Date" ng-change="handleGroupByChanged()">\n                        <label class="groupSlotsBy truncate slots-groupByName" for="groupByName" title="'+customLabels.Date+'">'+customLabels.Date+'</label>\n\n                        <div class="button-on-grouping" ng-show="service.isScheduled()" ng-click="showOnGantt()" title="'+customLabels.Show_on_gantt+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.table+'"></use>\n                            \u2028</svg>\n                        </div>\n\n                        <div class="button-on-grouping" ng-click="openLightbox()" title="'+customLabels.OpenDetailsWindow+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                            \u2028</svg>\n                        </div>\n                    </div>\n                    \n                    <div class="slots-grouping sort-container" ng-show="allSlotsArray" ng-show="gotSlots">\n                        <span class="sort-button" ng-click="handleSortByChanged(\'name\')" ng-if="groupSlotsBy == \'Resource\'">\n                            '+customLabels.Name+'\n                                <span ng-if="sortBy == \'name\'">\n                                    <svg aria-hidden="true" class="slds-icon sort-arrow" ng-if="sortOrder == 1">\n                                        <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                    </svg>\n                                    <svg aria-hidden="true" class="slds-icon sort-arrow" ng-if="sortOrder == -1">\n                                        <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                    </svg>\n                                </span>\n                        </span>\n                        \n                        <span class="sort-button" ng-click="handleSortByChanged(\'date\')" ng-if="groupSlotsBy == \'Date\'">\n                            '+customLabels.Date+'\n                                <span ng-if="sortBy == \'date\'">\n                                    <svg aria-hidden="true" class="slds-icon sort-arrow" ng-if="sortOrder == 1">\n                                        <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                    </svg>\n                                    <svg aria-hidden="true" class="slds-icon sort-arrow" ng-if="sortOrder == -1">\n                                        <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                    </svg>\n                                </span>\n                        </span>\n                  \n                        <span class="{{sortGradeButtonClassName}}" ng-click="handleSortByChanged(\'grade\')">\n                            '+customLabels.Grade+'\n                                <span ng-if="sortBy == \'grade\'">\n                                    <svg aria-hidden="true" class="slds-icon sort-arrow" ng-if="sortOrder == 1">\n                                        <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                    </svg>\n                                    <svg aria-hidden="true" class="slds-icon sort-arrow" ng-if="sortOrder == -1">\n                                    <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                    </svg>\n                                </span>\n                        </span>\n                    </div>\n\n                    <div id="Slots-List-In-Panel" ng-show="gotSlots">\n                    \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                        \n                        \n                    \n                        <div ng-repeat="candidate in allSlotsArray| orderBy: candidate:false:compareByName" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Resource\'">\n    \n                            <div ng-show="getResourceField(candidate.Resource.Resource.Id, \'name\')" class="candidates-container-row" ng-click="candidate.showSlots = !candidate.showSlots">\n                                <div ng-show="getResourceField(candidate.Resource.Resource.Id, \'pictureLink\') == null && getResourceField(candidate.Resource.Resource.Id, \'serviceCrew\') == undefined" class="ResourcePhotoIcon"></div>\n                                <div ng-show="getResourceField(candidate.Resource.Resource.Id, \'serviceCrew\') != undefined && getResourceField(candidate.Resource.Resource.Id, \'pictureLink\') == null" ng-style="{\'background-color\': '+e+" ? "+e+' : \'#a99be8\'}" class="ResourcePhotoIcon CrewPhotoIcon"></div>\n                                <img ng-show="getResourceField(candidate.Resource.Resource.Id, \'pictureLink\') != null" ng-src="{{getResourceField(candidate.Resource.Resource.Id, \'pictureLink\')}}" class="ResourcePhotoIcon" />\n                                <h1>{{ getResourceField(candidate.Resource.Resource.Id, \'name\') }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [candidate.SchedulingOptions.length] ) }}\n                                \n                                <div ng-show="candidate.highest.Grade > -1" class="slot-grade slots-highest-grade" ng-class=\'{\n                                                "GS-grade-excellent": candidate.highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": candidate.highest.Grade >= GRADES.GOOD && candidate.highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": candidate.highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(candidate.highest.Grade)}}/100\n                                </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in candidate.SchedulingOptions" class="time-interval" ng-init="intervalItem.showExplain[\'Resource\'] = false; intervalItem.showExplain[\'Date\'] = false;" ng-show="candidate.showSlots">\n                               \n                                <svg class="AN-InfoIcon slds-icon" aria-hidden="true" aria-label="{{roundGrade(intervalItem.Grade)}}/100" ng-show="intervalItem.Grades && intervalItem.Grades.length > 0" ng-click="intervalItem.showExplain[groupSlotsBy] = !intervalItem.showExplain[groupSlotsBy]; $event.stopPropagation();">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                </svg>\n                               \n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start) }}</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, candidate.Resource.Resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions" title="{{generateMstText(intervalItem.MSTOptions)}}">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                <div class="mst-interval-for-tapuhi truncate" ng-show="isRelatedSALength" title="{{generateRelatedSAO2Text()}}">\n                                    {{generateRelatedSAO2Text()}}\n                                </div>\n                                \n                                \n                                \n                                <div class="gs-explain-container" ng-show="intervalItem.showExplain[groupSlotsBy] && intervalItem.Grades && intervalItem.Grades.length > 0" >\n                                    <div class="AN-SlotSingleInfo" ng-repeat="info in intervalItem.Grades" ng-if="info.Text" role="region" aria-label="{{roundGrade(intervalItem.Grade)}}" >\n                                        <div class="AN-ObjectGrade" aria-live="polite" \n                                             aria-label="{{ getAriaLabel(info.Grade) }}"\n                                             ng-class="{\n                                            \'AN-ObjectGradeGood\': info.Grade >= GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeAverage\': info.Grade >= GRADES.GOOD && info.Grade < GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeBad\': info.Grade <= GRADES.GOOD,\n                                        }"></div>\n                                        <b>{{info.HeaderText}}</b><br/>\n                                        <span ng-if="info.ObjectiveRecordTypeName !== \'Objective_Asap\'">{{ info.Text }}</span>\n                                        <span ng-if="info.ObjectiveRecordTypeName === \'Objective_Asap\'">{{ formatAsapObjective(info.Text) }}</span>\n                                    </div>\n                                </div>\n                                \n                               \n                            </div>\n    \n                        </div>\n                        \n                       \n                       \n                        <div ng-repeat="date in dateKeysArray | orderBy: date:false:compareByDate" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Date\'">\n                            <div class="candidates-container-row date-title-container" ng-click="slotsByDateObject[date].showDatesSlots = !slotsByDateObject[date].showDatesSlots">\n                                <h1>{{ formatDateHeader(date) }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [slotsByDateObject[date].length] ) }}\n                                \n                                        <div class="slot-grade slots-highest-grade" ng-show="slotsByDateObject[date].highest.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": slotsByDateObject[date].highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": slotsByDateObject[date].highest.Grade >= GRADES.GOOD && slotsByDateObject[date].highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": slotsByDateObject[date].highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(slotsByDateObject[date].highest.Grade)}}/100\n                                        </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in slotsByDateObject[date]" class="time-interval" ng-show="slotsByDateObject[date].showDatesSlots">\n                            \n                                <svg class="AN-InfoIcon slds-icon" aria-hidden="true" aria-label="{{roundGrade(intervalItem.Grade)}}/100" ng-show="intervalItem.Grades && intervalItem.Grades.length > 0" ng-click="intervalItem.showExplain[groupSlotsBy] = !intervalItem.showExplain[groupSlotsBy]; $event.stopPropagation();">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                </svg>\n                            \n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start, true)}}</span>\n                                <span> ({{intervalItem.Resource.Resource.Name}})</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, intervalItem.Resource.Resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                \n                                \n                                \n                                <div class="gs-explain-container" ng-show="intervalItem.showExplain[groupSlotsBy] && intervalItem.Grades && intervalItem.Grades.length > 0" >\n                                    <div class="AN-SlotSingleInfo" ng-repeat="info in intervalItem.Grades" ng-if="info.Text" role="region" aria-label="{{roundGrade(intervalItem.Grade)}}">\n                                        <div class="AN-ObjectGrade 1111" aria-live="polite" \n                                             aria-label="{{ getAriaLabel(info.Grade) }}""\n                                             ng-class="{\n                                            \'AN-ObjectGradeGood\': info.Grade >= GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeAverage\': info.Grade >= GRADES.GOOD && info.Grade < GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeBad\': info.Grade <= GRADES.GOOD,\n                                        }"></div>\n                                        <b>{{info.HeaderText}}</b><br/>\n                                        <span ng-if="info.ObjectiveRecordTypeName !== \'Objective_Asap\'">{{ info.Text }}</span>\n                                        <span ng-if="info.ObjectiveRecordTypeName === \'Objective_Asap\'">{{ formatAsapObjective(info.Text) }}</span>\n                                    </div>\n                                </div>\n                                \n                                \n                                \n                            </div>\n    \n                        </div>\n\n                </div>\n            ';var t=angular.element(e);angular.element("#LeftSideContainer").prepend(t),A.$on("$destroy",function(){return t.remove()}),window.__closeLeftSideTerritories&&window.__closeLeftSideTerritories(),i(t)(A),T.safeApply(A)}function v(){A.hideSlotsWasClicked=!0,f()}function f(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];A&&(I=null,e&&y.$broadcast("GotSlotsEnded"),showCandidates.on=!1,showCandidates.id=null,C(),updateViewDebounced(),e)&&A.$destroy()}function S(e){return Math.round(e)}function C(){for(var e=0;e<A.slotsTimespansIds.length;e++)scheduler.deleteMarkedTimespan(A.slotsTimespansIds[e])}function _(e,t){return e&&s.getResources()[e]?s.getResources()[e][t]:null}function b(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=60*new Date(e).getTimezoneOffset()*1e3,e=new Date(e+n);return t?moment(e).format("LT"):moment(e).format("llll")}function k(e,t){var n=60*new Date(e).getTimezoneOffset()*1e3,e=new Date(e+n);return new Date(t+n).getDate()!==e.getDate()?moment(e).format("llll"):moment(e).format("LT")}function D(e){e=e.split("_"),e=new Date(e[2],e[1],e[0],0,0,0,0);return moment(e).format("LL")}function R(e){var t,n;if(e)return n=t=0,e.forEach(function(e){t++,n+=e.SchedulingOptions.length}),customLabels.getSlotsExpText.replaceAll("<b>"+t+"</b>","<b>"+n+"</b>","<b>"+A.service.name+"</b>","<b>"+b(A.bestSlot.Interval.Start)+"</b>","<b>"+A.bestSlot.Resource.Resource.Name+"</b>","<b>"+Math.round(A.bestSlot.Grade)+"</b>")}function F(){A.shouldNotify=!0,A.mstPromise.then(function(t){T.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",A.service.AppointmentNumber),customLabels.MstFinishedGettingSlotsMessage,function(){var e;p=!0,g((e=t).fslOperation.result.Service.Id),"exception"===e.eventType&&O(e),O({value:e.fslOperation.result}),p=!1},null,!0)}).catch(function(e){console.error(e),T.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",A.service.AppointmentNumber),e,function(){})}),f(!0)}function O(e){if(A.gettingSlots=!1,"exception"===e.eventType)A.gotSlots=!1,A.exception=e.event;else{A.partialResults=e.value.PartialResults||[];var r,t,c=e.value,d="",u=null,p=!1;for(r in c.ResourceIDToScheduleData)if(c.ResourceIDToScheduleData[r].SchedulingOptions)for(var m=c.ResourceIDToScheduleData[r].SchedulingOptions,n=function(o){e=m[o].Interval,t=60*new Date(e.Start).getTimezoneOffset()*1e3,n=60*new Date(e.Finish).getTimezoneOffset()*1e3;var e,t,n,a={startDate:new Date(e.Start+t),endDate:new Date(e.Finish+n)},l=w.getResoruceGanttIdByDate(r,a.startDate);if(!(l=showSecondarySTMs&&A.service.ServiceTerritoryId?w.getResoruceGanttIdByDateAndTerritory(r,a.startDate,A.service.ServiceTerritoryId):l))return"continue";0===o&&(d+=c.ResourceIDToScheduleData[r].Resource.Resource.Name+", ",p=!0),(a.startDate<u||null===u)&&(u=new Date(a.startDate));function i(e){var t={},n=(t[e]=-1<l.indexOf(",")?l.split(","):[l],""),i=(m[o].MSTOptions&&(n=(new Date).getTime()+Math.floor(1e5*Math.random()),window.mstOptions=window.mstOptions||{},window.mstOptions[n]=m[o].MSTOptions),.11+parseInt(m[o].Grade)/100*.64),s=(s=m[o].Grade,i=i,parseInt(s)>=A.GRADES.EXCELLENT?"background-color: rgba(135, 220, 122,"+i+");":parseInt(s)>=A.GRADES.GOOD?"background-color: rgba(255, 214, 76,"+i+");":"background-color: rgba(255, 108, 69,"+i+");"),i=m[o].Grade<0?"":Math.round(m[o].Grade),r=customLabels.CandidateGradeGantt.replaceAll(moment(a.startDate).format("dddd LT"),moment(a.endDate).format("dddd LT"),i),e={start_date:a.startDate,end_date:a.endDate,sections:t,html:"ZoomLevel6"===e||"ZoomLevel7"===e?"<div oncontextmenu='scheduleSlot(event, \""+A.service.id+'", "'+a.startDate.getTime()+'", "'+l+'", "'+L.selectedPolicyId+'", "'+n+"\")', title='"+r+"' style='"+s+"'><span class='slotText'>"+i+"</span></div>":"<div oncontextmenu='scheduleSlot(event, \""+A.service.id+'", "'+a.startDate.getTime()+'", "'+l+'", "'+L.selectedPolicyId+'", "'+n+"\")', title='"+r+"' style='"+s+"'><span class='slotText'><span>"+i+'</span><span style="font-size: 8px">/100</span></span></div>',css:(t=m[o].Grade,"slot-mark "+(parseInt(t)>=A.GRADES.EXCELLENT?"slot-mark-green":parseInt(t)>=A.GRADES.GOOD?"slot-mark-yellow":"slot-mark-orange"))};A.slotsTimespansIds.push(scheduler.addMarkedTimespan(e)),A.rawTimespans.push(e)}for(var s in scheduler.matrix)i(s)},i=0;i<m.length;i++)n(i);if(p?((t=T.setDatesByStartAndMode(u)).start.setDate(t.start.getDate()-1),t.end.setDate(t.end.getDate()+1),w.getTimePhasedObjects(t.start,t.end).then(function(){if(!A.hideSlotsWasClicked){C();for(var e=0;e<A.rawTimespans.length;e++)A.slotsTimespansIds.push(scheduler.addMarkedTimespan(A.rawTimespans[e]));showCandidates.on=!0,showCandidates.id=A.service.id,T.ganttSettings&&T.ganttSettings.filterCandidates&&(A.service.resourceId&&-1===d.indexOf(A.service.resourceName)&&(d+=A.service.resourceName+", "),d=d.substr(0,d.length-2)),scheduler.setCurrentView(u),y.$broadcast("GotSlots",{resourceToFilter:d,minDateOfCandidate:u})}}).finally(function(){return A.wereSlotsAlreadyDrawnOnGantt=!0})):A.gotSlots=!1,A.gotSlots){A.allSlotsArray=[],A.slotsByDateObject={},A.dateKeysArray=[];var s,o=[],a=[];for(s in I={},e.value.ResourceIDToScheduleData){var l=e.value.ResourceIDToScheduleData[s];if(l.Resource.Resource){A.allSlotsArray.push(l);for(var h=0;h<l.SchedulingOptions.length;h++){var g=new Date(l.SchedulingOptions[h].Interval.Start),v=60*new Date(l.SchedulingOptions[h].Interval.Start).getTimezoneOffset()*1e3,v=(I[s]=!0,g.setMilliseconds(g.getMilliseconds()+v),g.getFullYear()+" "+g.getMonth()+" "+g.getDate()),v=(o.includes(v)||(o.push(v),a.push(g)),P(g));A.slotsByDateObject[v]=A.slotsByDateObject[v]||[],l.SchedulingOptions[h].Resource=e.value.ResourceIDToScheduleData[s].Resource,A.slotsByDateObject[v].push(l.SchedulingOptions[h])}}}a.sort(function(e,t){return e-t});for(var f=0;f<a.length;f++)A.dateKeysArray[f]=P(a[f]);A.allSlotsArray.sort(function(e,t){return e.Resource.Resource.Name>t.Resource.Resource.Name?1:e.Resource.Resource.Name<t.Resource.Resource.Name?-1:0});for(var S,_=0;_<A.allSlotsArray.length;_++)A.allSlotsArray[_].highest=M(A.allSlotsArray[_].SchedulingOptions);for(S in A.slotsByDateObject){var b=A.slotsByDateObject[S];b.sort(function(e,t){return e.Interval.Start>t.Interval.Start?1:e.Interval.Start<t.Interval.Start?-1:0}),b.highest=M(b),(!A.bestSlot||A.bestSlot.Grade<b.highest.Grade)&&(A.bestSlot=b.highest)}A.isRelatedSALength=e.value.relatedSACounter,setTimeout(function(){return angular.element("#slotsSentence").html(R(A.allSlotsArray))},100)}}}function M(e){for(var t=0,n=e,i=n[0],s=0;s<n.length;s++)n[t].Grade<n[s].Grade&&(i=n[t=s]);return i}function N(e){y.$broadcast("JumpToDate",new Date(e))}function G(e,t){return(e=customLabels[e]).replaceAll.apply(e,_toConsumableArray(t))}function B(){e.open(A.service.id)}function H(){T.showOnGantt(A.service.id)}function V(){var e=[A.lastSortBy,A.sortBy],e=(A.sortBy=e[0],A.lastSortBy=e[1],[A.lastSortOrder,A.sortOrder]);A.sortOrder=e[0],A.lastSortOrder=e[1]}function U(e){A.sortBy=e,A.sortOrder?A.sortOrder*=-1:A.sortOrder=1}function z(e,t){if(A.sortOrder)return e=e.value,t=t.value,"name"===A.sortBy?A.sortOrder*(e.Resource.Resource.Name<=t.Resource.Resource.Name?-1:1):A.sortOrder*(S(e.highest.Grade)<=S(t.highest.Grade)?-1:1)}function j(e,t){if(A.sortOrder)return e=e.value,t=t.value,"date"===A.sortBy?A.sortOrder*(new Date(D(e))<=new Date(D(t))?-1:1):A.sortOrder*(S(A.slotsByDateObject[e].highest.Grade)<=S(A.slotsByDateObject[t].highest.Grade)?-1:1)}function W(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:-1,t=0;return A.allSlotsArray.forEach(function(e){return t+=e.SchedulingOptions.length}),customLabels.AB_Explanation_Header.replace("{0}",e).replace("{1}",t)}function q(e){e=parseInt(e);return moment.tz(e,userTimeZone).format("llll")}function Z(){return A.service.Use_Async_Logic?customLabels.ServiceUsingAsync:customLabels.MstTakingLongTime}function K(e){return e>=A.GRADES.EXCELLENT?customLabels.Ideal:e>=A.GRADES.GOOD&&e<A.GRADES.EXCELLENT?customLabels.Recommended:"Not recommended"}function Y(e){var t,n="";for(t in e)n=customLabels.RelatedServiceSchedulingSentence.replace("$0",b(e[t].Interval.Start)).replace("$1",e[t].Resource.Resource.Name);return n}function J(){return 1<A.isRelatedSALength?customLabels.MultipleRelatedServicesSentence.replace("$0",A.isRelatedSALength):customLabels.SingleRelatedServicesSentence}function E(e,t,n){var i=e.Interval.Start,s=e.Interval.Finish,e=e.Resource.Resource.Id,r=w.serviceAppointments()[t],o=60*new Date(i).getTimezoneOffset()*1e3,a=w.getResoruceGanttIdByDate(e,i);i+=o,s+=o,r?(x(r,i,a||e,n),c.saveChangesToServiceAppointment(r,r).then(function(e){d.calculateKpis()})):(i=new Date(i),s=new Date(s),l.saveChangesToServiceAppointment(t,e,null,null,i,s,L.selectedPolicyId,"AutomaticGetSlots"),u.getDelta())}function X(t,e,n,i){if(!A.scheduledActionInvoked){if(A.scheduledActionInvoked=!0,A.hideSlotsWasClicked=!0,!A.service.isImmidietlyFollow&&i.MSTOptions&&0<Object.keys(i.MSTOptions).length)for(var s in i.MSTOptions)E(i.MSTOptions[s],s,n);var r=A.service,o=60*new Date(t).getTimezoneOffset()*1e3,o=(t+=o,r.resourceBeforeDrag=r.resourceId,r.eventBeforeDrag=angular.copy(r),r.fromGetCandidateFlow=!0,w.getResoruceGanttIdByDate(e,t));x(r,t,o||e,n),scheduler._events[r.id]?(scheduler.updateEvent(r.id),scheduler.callEvent("onEventChanged",[r.id,scheduler.getEvent(r.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),f()):c.saveChangesToServiceAppointment(r,r).then(function(e){d.calculateKpis(),y.$broadcast("JumpToDate",new Date(parseInt(t)))}).catch(function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),T.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])}).finally(function(){y.$broadcast("JumpToDate",new Date(parseInt(t))),f()}),f()}}function x(e,t,n,i){var s=T.getServiceDuration(e);e.start=new Date(t),e.finish=new Date(t+s),e.start_date=new Date(t),e.end_date=new Date(t+s),e.travelTo=0,e.travelFrom=0,n&&(e.resourceId=n),e.policyUsed=i,e.scheduleMode="AutomaticGetSlots",e.savedFromScheduleHereAndConsecutive=!e.isInO2Territory&&e.isImmidietlyFollow&&e.relatedService2}function P(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}return window.scheduleSlot=function(e,t,s,r,o,a){e.preventDefault(),$("#ScheduleOnSlot").remove(),$('<div id="ScheduleOnSlot">'+customLabels.ScheduleHere+"</div>").css("left",e.clientX-30+"px").css("top",e.clientY+5+"px").on("click",function(){var e=A.service;if(e){if(A.hideSlotsWasClicked=!0,e.fromGetCandidateFlow=!0,a&&!e.isImmidietlyFollow){var t,n=a,i=o;for(t in mstOptions[n])E(mstOptions[n][t],t,i)}e.resourceBeforeDrag=e.resourceId,e.eventBeforeDrag=angular.copy(e),(!e.start||e.start.getTime()===parseInt(s)&&e.resourceId===r)&&e.start||x(e,parseInt(s),r,o),$("#ScheduleOnSlot").remove(),scheduler._events[e.id]?(scheduler.updateEvent(e.id),scheduler.callEvent("onEventChanged",[e.id,scheduler.getEvent(e.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),f()):c.saveChangesToServiceAppointment(e,e).then(function(e){d.calculateKpis(),y.$broadcast("JumpToDate",new Date(parseInt(s)))}).catch(function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),T.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])}).finally(function(){y.$broadcast("JumpToDate",new Date(parseInt(s))),f()})}}).appendTo("body")},$("body").on("click",function(){$("#ScheduleOnSlot").remove()}),{get:g,close:f,getCandidatesIds:function(){return I}}}e.$inject=["$rootScope","$timeout","TimePhasedDataService","sfdcService","$compile","utils","StateService","ResourcesAndTerritoriesService","ServiceAppointmentLightboxService","servicesService","kpiCalculationsService","MstResolver","DeltaService","$q"],angular.module("serviceExpert").factory("GetSlotsService",e)}();var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(i.push(o.value),!n||i.length!==n);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}!function(){function e(a,l,c){var e=scheduler.serverList("holidays"),e=_slicedToArray(e,2),t=e[0],i=void 0===t?{}:t,t=e[1],s=void 0===t?{}:t;function n(e){var t=moment(e.start).startOf("day").toDate().toISOString(),n=(s[t]=r(e,s[t]||[]),i[t]=i[t]||{},i[t][e.id]);n||(delete(n=Object.assign({territories:{}},e)).territory,delete n.start,delete n.finish,i[t][n.id]=n),e.territory&&e.territory.id&&(n.territories[e.territory.id]=e.territory)}function r(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];if(e.isAllDay)return[{start:moment(e.start).startOf("day").toDate(),finish:moment(e.finish).endOf("day").toDate()}];for(var n=e.start,i=e.finish,s=0;s<t.length;)if(t[s].finish<n)s++;else{if(t[s].start>i)return t.splice(s,0,{start:n,finish:i}),t;t[s].start<n&&(n=t[s].start),t[s].finish>i&&(i=t[s].finish),t.splice(s,1)}return t.push({start:n,finish:i}),t}return{addHolidaysIntoCollection:function(e){e&&e.length&&(e.forEach(n),scheduler.serverList("holidays",[i,s]))},addHolidayIntoCollection:n,enhanceHoliday:function(e,t,n,i,s){var r=t.split("_")[0],o=t.split("_")[1],r=[(t=r&&Object.values(c.resourcesAndTerritories()[r]||{}).find(function(e){return e.serviceTerritory===o})||{}).operatingHours,(t.serviceTerritory__r||{}).OperatingHoursId].includes(s)?l.territories()[o]:null,t=moment(e.date).startOf("day"),s=(e.isAllDay?t:t.clone().add(e.startTimeInMinutes,"minute")).toDate(),t=(e.isAllDay?t.clone().endOf("day"):t.clone().add(e.endTimeInMinutes,"minute")).toDate();return Intl.DateTimeFormat().resolvedOptions().timeZone,Object.assign({start:a.convertDateBetweenTimeZones(s,n,i),finish:a.convertDateBetweenTimeZones(t,n,i),territory:r},e)},excludeHolidaysFromSlots:function(t,i,s,r){var o=[];e:for(;i&&i.length;)switch(function(){for(var e,n=i.shift();t.length&&t[0].finish<=n[s];)t.shift();return t.length?n[r]<=t[0].start||n.isHolidaySlot?(o.push(n),"continue"):void((e=a.intersectDates({start:n[s],finish:n[r]},t[0])).remainderFrom1&&e.remainderFrom1.length&&(e=e.remainderFrom1.map(function(e){var t;return Object.assign({},n,(_defineProperty(t={},s,e.start),_defineProperty(t,r,e.finish),t))}),i.unshift.apply(i,_toConsumableArray(e)))):(o.push.apply(o,[n].concat(_toConsumableArray(i))),"break")}()){case"break":break e;case"continue":continue}return o},mergeHolidayIntoDayIntervals:r,mergeHolidays:function(e){var t=[],n=void 0;return e.forEach(function(e){!n||e.start>n.finish?t.push(n=e):e.finish>n.finish&&(n.finish=e.finish)}),t},trimHoliday:function(e,t,n){e.start<t&&(e.start=t),n<e.finish&&(e.finish=n)},reset:function(){scheduler.serverList("holidays",[]);var e=scheduler.serverList("holidays"),t=(e=_slicedToArray(e,2))[0];i=void 0===t?{}:t,s=void 0===(t=e[1])?{}:t}}}e.$inject=["utils","ResourcesAndTerritoriesService","TimePhasedDataService"],angular.module("serviceExpert").factory("HolidayService",e)}(),!function(){function e(e,t,n,o){var a={};return{getLastKnownPositions:function(){return t.getLivePositions().then(function(e){for(var t in e)a[t]=new LastKnownPosition(e[t]);return a})},updatePositions:function(e){var t,n={},i=!1;for(t in e){var s=new LastKnownPosition(e[t]),r=void 0;e[t].ServiceCrewMembers&&e[t].ServiceCrewMembers[0].IsLeader&&(r=o.getCrewToResources()[e[t].ServiceCrewMembers[0].ServiceCrewId]),(!a[s.id]||a[s.id].lastModifiedDate<s.lastModifiedDate)&&(a[t]=n[t]=s,i=!0,r)&&(n[r.Id]=s,a[r.Id]=s)}return{dic:n,isUpdated:i}},lastKnownPositions:function(){return a}}}e.$inject=["$q","sfdcService","utils","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("LastKnownPositionService",e)}(),!function(){function e(e,i,t,m,h,g,v,s,r,o,a,l,c,d,u,n,p,f,S){var b=i.$new(!0),y=angular.element('\n                        <div class="LeftSideLocationFiltering" >\n\n                            <div class="leftFilteringContentContainer" ng-if="opened">\n\n                                <div id="TF-loadingTerritories" ng-show="currentlySavingTerritories">\n                                    <img src="'+window.lsdIcons.spinnerGif+'" />\n                                    Loading Service Territories\n                                </div>\n\n                                <div class="territories-list-type-tabs">\n                                    <button tabindex="0" fsl-tab-switch role="tab" ng-click="setShowTree(true)" ng-class="{\'active-territory-tab\' : showTree}">'+customLabels.TerritoriesTree+'</button>\n                                    <button fsl-tab-switch role="tab" ng-click="setShowTree(false)" ng-class="{\'active-territory-tab\' : !showTree}">'+customLabels.Favorites+'</button>\n                                </div>\n                                \n                                <div tabindex="0" role="tooltip" id="leftLocationFiltering-tooltip" aria-label="'+(showSecondarySTMs&&useLocationTimezone?customLabels.LocationFilteringParagraph+"\n\n "+customLabels.Stms_with_different_tz:customLabels.LocationFilteringParagraph)+'" tooltip-trigger="focus blur mouseenter mouseleave" tooltip-animation="false" tooltip-class="horizonTooltip tooltip-location-inner" tooltip-append-to-body="true" tooltip-placement="bottom" \n                                    tooltip="'+(showSecondarySTMs&&useLocationTimezone?customLabels.LocationFilteringParagraph+"\n\n "+customLabels.Stms_with_different_tz:customLabels.LocationFilteringParagraph)+'">\n                                    <svg aria-hidden="true" class="slds-icon info-tooltip-icon">\n                                        \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                                    \u2028</svg>\n                                </div>\n\n                                <div class="leftLocationFilteringConf">\n                                \n\n                                    <div class="addBorderBottom">\n                                        <input type="checkbox" ng-model="$parent.showOrphanServices" id="servicesNoLocations" />\n                                        <label for="servicesNoLocations">'+customLabels.unassosiated_filtering+'</label><br/>\n                                    </div>\n\n                                    <input \n                                        id="locationFilteringSearch" \n                                        ng-show="(!showAutocompleteTerritoryPicker)" \n                                        type="search" ng-model="locationSearchTerm.text" \n                                        placeholder="'+customLabels.Search_location+'" \n                                    />\n                                    \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-SelectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-click="selectAllLocations(true, filteredLocations, locationFilter, showTree)" \n                                        ng-hide="showAutocompleteTerritoryPicker" \n                                        title="'+customLabels.Select_all+'">\n                                            '+customLabels.Select_all+'\n                                        </span>\n                                        \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-DeselectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-click="selectAllLocations(false, filteredLocations, locationFilter, showTree)" \n                                        ng-hide="showAutocompleteTerritoryPicker"\n                                        title="'+customLabels.Select_none+'">\n                                            '+customLabels.Select_none+'\n                                    </span>\n                                    \n                                    \n                                    \n                                    <img class="tp-spinner" ng-show="$parent.currentlyLoading && showTree" src="'+window.lsdIcons.spinnerGif+'" />\n                                    \n                                    <svg aria-hidden="true" class="slds-icon tp-clear-territory-search" ng-show="$parent.searchText && !$parent.currentlyLoading && showTree" ng-click="clearAutocompleteSearch()">\n                                        \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                                    \u2028</svg>\n                                    \n                                    \n                                    <input type="text" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        class="tp-search-input"\n                                        placeholder="'+window.customLabels.SearchServiceTerritory+'" \n                                        ng-model="$parent.searchText" \n                                        ng-model-options="{ debounce: 333 }" \n                                        ng-change="searchTerritory(searchText)" \n                                        ng-click="setSearchResultBox($event)" \n                                    />\n                                    \n                                    \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-SelectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        ng-click="selectTerritoriesWithAutocomplete(true)" \n                                        title="'+customLabels.Select_all+'">\n                                            '+customLabels.Select_all+'\n                                        </span>\n                                        \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-DeselectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        ng-click="selectTerritoriesWithAutocomplete(false)"\n                                        title="'+customLabels.Select_none+'">\n                                            '+customLabels.Select_none+'\n                                    </span>\n                                    \n                                    \n                               \n                                </div>\n                                \n                                   \n                                   \n                                \x3c!-- Territories tree with auto complete --\x3e\n                                        \n                                <div id="TF-TerritoriesTreeWithAutoComplete" class="LocationsTree" ng-show="showAutocompleteTerritoryPicker && showTree">\n                                \n                                \n                                    \x3c!-- SEARCH RESULTS --\x3e\n                                    \n                                    <div class="tp-territories-found-summary" ng-show="$parent.searchText && !currentlyLoading && !noTerritoriesFoundOnSearch">\n                                        {{ searchResultText.replace(\'$0\', currentResults.length) }}\n                                    </div>\n                                \n                                    <div ng-repeat="territory in currentResults" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territory.Id]" id="location_{{ territory.Id }}" ng-change="addToCurrentLoadedTerritories(territory.Id, locationFilter[territory.Id])" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territory.Id)}" ng-click="toggleFavorite(territory.Id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territory.Id }}" ng-bind="territory.Name"></label>\n                                        <span class="ter-search-parent" ng-if="territory.ParentTerritory">({{ territory.ParentTerritory.Name }})</span>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territory.Id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                    \n                                    \n                                    \n                                    \x3c!-- CURRENTLY LOADED --\x3e\n                                    \n                                    <div ng-repeat="territoryId in currentlyLoadedTerritories" ng-show="!$parent.searchText" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territoryId]" id="location_{{ territoryId }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territoryId)}" ng-click="toggleFavorite(territoryId)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territoryId }}">{{territoriesIdsToNames[territoryId]}}</label>\n                                        <span class="ter-search-parent" ng-if="getParentTerritory(territoryId)">({{ getParentTerritory(territoryId).name }})</span>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territoryId)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                   \n                                    <div class="tp-no-territories-found" ng-show="noTerritoriesFoundOnSearch && !currentlyLoading">\n                                        '+customLabels.NoServiceTerritoriesWereFound+'\n                                    </div>\n                                    \n                                </div>\n                                   \n                                   \n                                <div id="TF-TerritoriesFavoritesAutoComplete" class="LocationsTree" ng-show="showAutocompleteTerritoryPicker && !showTree">\n                                    \n                                    <div ng-repeat="territoryId in favorites" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territoryId]" id="location_{{ territoryId }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territoryId)}" ng-click="toggleFavorite(territoryId)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territoryId }}">{{territoriesIdsToNames[territoryId]}}</label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territoryId)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                    \n                                </div>      \n                                   \n                                   \n                                   \n                                   \n                                \x3c!-- Territories tree without auto complete --\x3e\n                                        \n                                <div id="TF-TerritoriesTree" class="LocationsTree" ng-show="showTree && !showAutocompleteTerritoryPicker">\n                                    <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" class="locationFilterRow" ng-style="{{ styleForLocationTree(l.depth) }}" ng-click="selectLocation(l.id)">\n                                        <input type="checkbox" ng-model="locationFilter[l.id]" id="location_{{ l.id }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(l.id)}" ng-click="toggleFavorite(l.id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ l.id }}" ng-bind="l.text"></label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(l.id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                </div>\n                                \n                                \n                                \n                                \x3c!-- Territories list without auto complete --\x3e\n                                \n                                <div id="TF-TerritoriesListFavorites" class="LocationsTree" ng-show="!showTree && !showAutocompleteTerritoryPicker">\n                                \n                                    <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" ng-show="isTerritoryInFavorite(l.id)" class="locationFilterRow">\n                                        <input type="checkbox" ng-model="locationFilter[l.id]" id="location_f_{{ l.id }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(l.id)}" ng-click="toggleFavorite(l.id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_f_{{ l.id }}" ng-bind="l.text"></label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(l.id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                </div>\n                                    \n\n                            </div>\n                            \n\n                            <div class="lightboxControllers">\n                                <button class="lightboxSaveButton cancelButtonAndClose" ng-click="closeLightbox()">'+customLabels.Cancel+'</button>\n                                <button class="lightboxSaveButton" ng-click="applyFilterLocationWithRowsCheck()">'+customLabels.Save+"</button>\n                            </div>\n\n                        </div>\n                ").hide(),w=(angular.element("#LeftSideContainer").append(y),n.close(),b.trust=v.trust,b.showOrphanServices=!1,b.locationSearchTerm={text:""},b.showLocationFiltering=!1,b.noLocationsLoad=!1,b.locationFilter={},b.locationFilterCopy={},b.locationsFlat=[],b.territoriesSortedByTree=[],b.showTree=!0,b.showSecondaryTimezoneNotice=showSecondarySTMs&&useLocationTimezone,b.spinnerIcon=window.lsdIcons.spinnerGif,b.showAutocompleteTerritoryPicker=window.__gantt.shouldShowAutoCompleteUi,b.currentResults=[],b.showResults=!1,b.noTerritoriesFoundOnSearch=!1,b.cachedTerritoriesQueryResults={},b.currentlyLoading=!1,b.searchText=null,b.allTerritoriesQueried={},b.territoriesIdsToNames={},b.currentlyLoadedTerritories=[],b.currentlySavingTerritories=!1,b.searchResultText=window.customLabels.TerritoriesFoundInSearch,b.isRTL=r.isRtlDirection(),b.getParentTerritory=function(e){e=m.territories()[e];return e&&e.parentTerritory?m.territories()[e.parentTerritory.id]:null},null!==h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")&&(b.showTree=!h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")),b.favorites=h.GetUserSettingsProperty("FavoriteTerritories__c")?JSON.parse(h.GetUserSettingsProperty("FavoriteTerritories__c")):[],_.debounce(function(){h.SetUserSettingsProperty("FavoriteTerritories__c",JSON.stringify(b.favorites))},800));function T(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];b.opened=!0,b.showTree=!0,b.reload=e,e=h.GetUserSettingsProperty("locations"),b.currentlyLoadedTerritories=e?[].concat(_toConsumableArray(e)):[],null!==h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")&&(b.showTree=!h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")),b.favorites=h.GetUserSettingsProperty("FavoriteTerritories__c")?JSON.parse(h.GetUserSettingsProperty("FavoriteTerritories__c")):[],y.show("fast",function(){$(this).find(".territories-list-type-tabs").children()[0].focus()})}return b.saveTabDebounced=_.debounce(function(){h.SetUserSettingsProperty("ShowFavoriteTerritoriesTab__c",!b.showTree)},800),b.setShowTree=function(e){b.showTree=e,b.saveTabDebounced()},e(y)(b),window.__openLocationFilteringAndReload=function(){return T(!0)},b.toggleFavorite=function(e){var t=b.favorites.indexOf(e);-1<t?b.favorites.splice(t,1):b.favorites.push(e),w()},b.isTerritoryInFavorite=function(e){return b.favorites.includes(e)},b.$on("keypress",function(e,t){27===t.which&&b.closeLightbox()}),b.closeLightbox=function(){if(!b.noLocationsLoad){for(var e in b.locationFilterCopy)b.locationFilter[e]=b.locationFilterCopy[e];b.showOrphanServices=b.showOrphanServicesOldValue,y.hide(),window.__closeLeftSideTerritories=null,b.opened=!1}},window.__closeLeftSideTerritories=b.closeLightbox,b.styleForLocationTree=function(e){var t={};return t[b.isRTL?"margin-right":"margin-left"]=20*e+"px",t},b.switchToTerritory=function(e){for(var t in b.locationFilter)b.locationFilter[t]=!1;b.locationFilter[e]=!0,b.applyFilterLocation()},m.promises.territories().then(function(){var e,t,i={},n=[],s=[],r=[];for(e in m.territories()){var o=m.territories()[e];o.hasSharing&&(i[e]={id:e,parent:o.parentTerritory||0,text:o.name,items:[]},b.territoriesIdsToNames[o.id]=o.name)}for(t in i){var a=i[t],l=function e(t){if(!t.id||!t.parent)return;{var n;return i[t.parent.id]?t.parent:(n={},m.allTerritories[t.parent.id]&&(n={id:m.allTerritories[t.parent.id].id,parent:m.allTerritories[t.parent.id].parentTerritory||0}),e(n))}}(a);(0!==a.parent&&l?i[l.id].items:n).push(a)}b.locationsTree=n;for(var c,d,u=0;u<n.length;u++)!function e(t,n,i){t.depth=n;i.push(t);if(t.items)for(var s=0,r=t.items.length;s<r;s++)t.items[s].depth=n,e(t.items[s],n+1,i)}(n[u],0,b.locationsFlat);if(b.showOrphanServices=JSON.parse(h.GetUserSettingsProperty("Show_Orphan_Services__c")),b.showOrphanServicesOldValue=b.showOrphanServices,b.territoriesSortedByTree=(c=m.territories(),d=b.locationsFlat,Object.keys(c).map(function(e){return c[e]}).sort(function(n,i){var s=0,r=0;return d.forEach(function(e,t){e.id===n.id&&(s=t),e.id===i.id&&(r=t)}),r<s?1:s<r?-1:0})),null!==h.GetUserSettingsProperty("locations")&&(s=h.GetUserSettingsProperty("locations")),g.callRemoteAction(RemoteActions.getUnPrivilegeUserSettingsFields).then(function(e){if(1<e.length){for(var t=customLabels.Unprivileged_Usersettings_Fields_Msg.split("{1}"),n=t[0],i="",s=0;s<e.length&&s<3;++s)i+="<br>"+e[s];3<e.length&&(i+="<br>",n+=t[1].replace("{2}",e.length-3)),n=n.replace("{0}",i),v.addNotification(customLabels.Unprivileged_Usersettings_Fields,n)}}).catch(function(e){console.warn("GetUserSettingsProperty failed :-("),console.error(e)}),b.showAutocompleteTerritoryPicker&&0===b.locationsFlat.length||0===s.length)b.showLocationFiltering=!0,b.noLocationsLoad=!0,T(),0!==b.locationsFlat.length&&0!==s.length||$("#FirstTimeLoading").remove();else{for(var p=0;p<b.locationsFlat.length;p++)b.noLocationsLoad=!1,b.locationFilter[b.locationsFlat[p].id]=-1<s.indexOf(b.locationsFlat[p].id),b.locationFilter[b.locationsFlat[p].id]&&r.push(b.locationsFlat[p].id);b.locationFilterCopy=angular.copy(b.locationFilter),h.SetUserSettingsProperty("locations",JSON.stringify(r))}}),b.applyFilterLocationWithRowsCheck=function(){var e,t,n,i=[];for(e in b.locationFilter)b.locationFilter[e]&&i.push(e);0===i.length?alert(customLabels.One_loaded_location):(t=new Date(scheduler._min_date),n=new Date(scheduler._max_date),t.setDate(t.getDate()-window.daysToLoadOnGanttInit),n.setDate(n.getDate()+window.daysToLoadOnGanttInit),b.currentlySavingTerritories=!0,g.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,t,n,i).then(function(e){e?(b.currentlySavingTerritories=!1,alert(customLabels.MaxedRowsReachedOnGanttAlert)):b.applyFilterLocation()}))},b.applyFilterLocation=function(){var e,n=[],t=[];for(e in b.locationFilter)(b.locationFilter[e]?n:t).push(e);0===n.length?(b.currentlySavingTerritories=!1,alert(customLabels.One_loaded_location)):(b.noLocationsLoad=!1,angular.extend(b.locationFilterCopy,b.locationFilter),b.showOrphanServicesOldValue=b.showOrphanServices,r.isLoadingNewLocations=!0,u.resetCurrentPalette(),S.unselectAll(),h.SetUserSettingProperties(b.parseLocationSettings(JSON.stringify(n),b.showOrphanServices)).then(function(){b.reload?window.window.location.reload():m.getResourceAndTerritories(function(){a.reset(),m.reset(),scheduler._events={},scheduler.deleteMarkedTimespan();var e=p.filter.searchOnServer;s.reset(e),o.reset(),l.reset(),d.reset(),f.reset()}).then(function(){b.currentlySavingTerritories=!1,s.resetReachedMaxRows();var e=new Date(scheduler.getState().min_date),t=new Date(scheduler.getState().max_date);s.getTimePhasedObjects(e,t).then(function(){p.filter.searchOnServer&&s.serviceAppointments(p.filter.searchOnServer)&&i.$broadcast("gotNewTimePhasedObjects",{start:e,finish:t,serviceAppointments:s.serviceAppointments(p.filter.searchOnServer)}),updateViewDebounced(),i.$broadcast("gotNewResources",{show:n}),r.isLoadingNewLocations=!1,c.calculateKpis()})})}).catch(function(e){b.currentlySavingTerritories=!1;for(var t=customLabels.territories_r_failure_msg+"\n",n=JSON.parse(e.FailedLocations),i=0;i<n.length;i++)t+=n[i].Name+"\n";v.addNotification(customLabels.territories_r_failure,t),r.isLoadingNewLocations=!1}),b.closeLightbox())},b.parseLocationSettings=function(e,t){return{locations:e,Show_Orphan_Services__c:t}},b.selectLocation=function(e){var t=!b.locationFilter[e],e=function e(t,n){var i=null;for(var s=0;s<t.length;s++){if(t[s].id===n)return t[s];if(i=e(t[s].items,n))return i}return i}(b.locationsTree,e);e&&!function e(t,n){for(var i=0;i<t.items.length;i++)b.locationFilter[t.items[i].id]=n,e(t.items[i],n)}(e,t)},b.selectAllLocations=function(t,e,n,i){i?angular.forEach(e,function(e){n[e.id]=t}):b.selectAllFavoriteLocations(t,e,n)},b.selectAllFavoriteLocations=function(t,e,n){angular.forEach(e,function(e){b.isTerritoryInFavorite(e.id)&&(n[e.id]=t)})},b.searchTerritory=function(n){""===n?(b.currentResults=[],b.showResults=!1,b.noTerritoriesFoundOnSearch=!1):b.cachedTerritoriesQueryResults[n.toLocaleLowerCase()]?(b.currentResults=b.cachedTerritoriesQueryResults[n.toLocaleLowerCase()],b.showResults=!0,0===b.currentResults.length?b.noTerritoriesFoundOnSearch=!0:b.noTerritoriesFoundOnSearch=!1):(b.currentlyLoading=!0,window.Visualforce.remoting.Manager.invokeAction(window.RemoteActions.searchTerritories,n,function(e,t){t.status?v.safeApply(b,function(){b.cachedTerritoriesQueryResults[n.toLocaleLowerCase()]=e,b.showResults=!0,b.searchText===n&&(b.currentlyLoading=!1,0===(b.currentResults=e).length?b.noTerritoriesFoundOnSearch=!0:(b.noTerritoriesFoundOnSearch=!1,e.forEach(function(e){b.allTerritoriesQueried[e.Name]=e,b.territoriesIdsToNames[e.Id]=e.Name})))}):console.warn(t)},{buffer:!0,escape:!1,timeout:12e4}))},b.addToCurrentLoadedTerritories=function(e,t){var n=b.currentlyLoadedTerritories.indexOf(e);t&&-1===n&&b.currentlyLoadedTerritories.push(e),!t&&1<n&&b.currentlyLoadedTerritories.splice(n,1)},b.clearAutocompleteSearch=function(){b.currentResults=[],b.showResults=!1,b.noTerritoriesFoundOnSearch=!1,b.currentlyLoading=!1,b.searchText=""},b.selectTerritoriesWithAutocomplete=function(t){b.searchText?b.currentResults.forEach(function(e){b.locationFilter[e.Id]=t,b.addToCurrentLoadedTerritories(e.Id,t)}):b.currentlyLoadedTerritories.forEach(function(e){b.locationFilter[e]=t})},{isOpen:function(){return b&&b.opened},open:T,getFlatTerritoriesArray:function(){return b.locationsFlat},getTerritoriesSortedByTree:function(){return b.showAutocompleteTerritoryPicker?window._.toArray(m.territories()):b.territoriesSortedByTree},isNoTerritoryLoadded:function(){return b.noLocationsLoad}}}e.$inject=["$compile","$rootScope","$q","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","utils","TimePhasedDataService","StateService","calendarsService","monthlyViewHelperService","ResourceCrewsService","kpiCalculationsService","ResourceCapacitiesService","GanttPalettesService","GetSlotsService","servicesService","HolidayService","ServiceSelectorService"],angular.module("serviceExpert").factory("LeftSideLocationFilteringService",e)}(),!function(){function e(m,h,g,v,f,S,_){var b=window.serversideServiceListFilter,y=["Selected","Violating","Gantt filter","Flagged","Recent"];function w(e,t,n,i,s){var r=new Date(t),o=!1;if(b){if(!(i=function(e){if(["Recent","Flagged","Selected","Violating"].includes(e))return!1;if(["All","Crews filter","allServicesFilters"].includes(e))return"allServicesFilters";return e}(i)))return!1;s&&!e[i]&&(e[i]={})}for(;n;){var a=e[g.generateDateKey(r)];(a=b?!!e[i]&&e[i][g.generateDateKey(r)]:a)||(o=!0),s&&(b?e[i][g.generateDateKey(r)]=!0:e[g.generateDateKey(r)]=!0),r.setDate(r.getDate()-1),n--}return o}function T(e,t,n){var i=void 0,s=void 0,r=g.addDaysToDate(t,1-n),o=t;if(e[r]){for(s=r;s<=o&&e[s];)s=g.addDaysToDate(s,1);return i=(o.getTime()-s.getTime())/864e5,{date:o,horizon:++i}}for(s=o;r<=s&&e[s];)s=g.addDaysToDate(s,-1);return i=(s.getTime()-r.getTime())/864e5,{date:s,horizon:++i}}return{getBackHorizonToFetch:T,loadServicesInBulk:function(e,t,n,i,s){var r=5<arguments.length&&void 0!==arguments[5]?arguments[5]:"",o=6<arguments.length&&void 0!==arguments[6]&&arguments[6],a=7<arguments.length&&void 0!==arguments[7]&&arguments[7],l=m.defer(),c=T(t,n,i),d=g.addDaysToDate(c.date,1-c.horizon),e=function(e,t,n){var i,s=[],r=window.__gantt.maxIdsInListOfAlreadyLoaded;for(i in e)if(function(e,t,n){n=g.addDaysToDate(t,-n);if(e.earlyStart&&n<e.earlyStart&&e.earlyStart<=t)return 1;if(e.dueDate&&n<e.dueDate&&e.dueDate<=t)return 1;if(e.appStart&&n<e.appStart&&e.appStart<=t)return 1;if(e.appEnd&&n<e.appEnd&&e.appEnd<=t)return 1;if(e.finish&&n<e.finish&&e.finish<=t)return 1;if(e.start&&n<e.start&&e.start<=t)return 1;return}(e[i],t,n)){if(0===r)return s;s.push(i),r--}return s}(e,n,i);if(s&&(e=e.filter(function(e){return s<e})),b){var u=w(t,n,i,"allServicesFilters",!1),p=w(t,n,i,r,!1);if(!u&&p&&!s)return l.resolve([]),l.promise}return y.includes(r)?l.resolve([]):a||w(t,n,i,r,!0)||s?h.loadServicesInBulk(c.date,c.horizon,numberOfServicesToLoadInEachBulk,e,s,r,o).then(function(e){var t=g.addDaysToDate(c.date,-c.horizon),t=(_.setDeltaDates(t,c.date),e.ganttServiceAppointments.map(function(e){return e.Id})),n=(S.isPushServiceActive()?S.updateSession({services:t,operation:S.MESSAGE_OPERATIONS.UPDATE}):S.setCachedServices(t),[]),t=(e.ganttServiceAppointments.forEach(function(e){e.AssignedResource&&!scheduler._events[e.Id]&&n.push(e.Id)}),Array.isArray(e.stms)&&0<e.stms.length&&v.updateTimePhaseData(e.stms,"stm"),v.updateTimePhaseData(e.ganttServiceAppointments,"service")),i=v.resourcesAndTerritories(),s={needToCheckRules:n,scheduledServices:[],unscheduledServices:[],remainingCount:e.remainingCount,fetchedFromDate:d,horizon:c,totalFetched:e.ganttServiceAppointments.length,lastFetchedId:e.ganttServiceAppointments[e.ganttServiceAppointments.length-1]?e.ganttServiceAppointments[e.ganttServiceAppointments.length-1].Id:null};t.services.forEach(function(e){(e.isScheduled()?(e.setGanttResource(i,g.generateResourceId),s.scheduledServices):(scheduler._events[e.id]&&delete scheduler._events[e.id],s.unscheduledServices)).push(e)}),f.drawServicesAndAbsences(s.scheduledServices,[],[],[]),l.resolve(s)}).catch(function(e){l.reject(e),console.warn("loadServicesInBulk: something went wrong"),"(1847416333)"===e.message.split(" ")[5]?g.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.Service_List_Filter_Logic_Error||customLabels.user_is_not_allowed_to_perform_action):g.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}):l.resolve([]),l.promise}}}e.$inject=["$q","sfdcService","utils","TimePhasedDataService","servicesService","PushServices","StateService"],angular.module("serviceExpert").factory("LoadServiceListService",e)}();var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(i.push(o.value),!n||i.length!==n);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")},_slicedToArray=(!function(){function e(i,o,c,d,a,n,s,r,t,e,l,u,p,m,h,g,v){function f(e){var t=e;void 0!==(t=w.iframeMapMode===y.IFRAME_TYPE.NORMAL?e.data:t).type&&(t.type.includes(S)?A:L)(t)}var S="[POLYGONS]",b=!1,y={IFRAME_TYPE:{SECURED:"1",NORMAL:"2"},IFRAME_RECEIVED_MESSAGES_TYPES:{FSL_MAP_LOADED:"FSL_MAP_LOADED",FSL_MAP_INITIALIZATION:"FSL_MAP_INITIALIZATION",FSL_MAP_DATA_UPDATE:"FSL_MAP_DATA_UPDATE",VIEW_DETAILS:"VIEW_DETAILS",FLAG_SA:"FLAG_SA",API_REQUEST:"API_REQUEST",GET_ICON:"GET_ICON"},IFRAME_SEND_MESSAGES_TYPES:{API_REQUEST_SUCCEED:"API_REQUEST_SUCCEED",API_REQUEST_FAILED:"API_REQUEST_FAILED",FSL_MAP_INITIALIZATION:"FSL_MAP_INITIALIZATION",FSL_MAP_SERVICES_UPDATE:"FSL_MAP_SERVICES_UPDATE",SHOW_SERVICE_ON_MAP:"SHOW_SERVICE_ON_MAP",GET_ICON_SUCCEED:"GET_ICON_SUCCEED",GET_ICON_FAILED:"GET_ICON_FAILED",FSL_MAP_LIVE_POSITION:"FSL_MAP_LIVE_POSITION",FSL_MAP_UPDATE_FILTER:"FSL_MAP_UPDATE_FILTER",FSL_MAP_UPDATE_VIEW:"FSL_MAP_UPDATE_VIEW"},POLYGON_MENU_ACTIONS:{SCHEDULE:S+" SCHEDULE",UNSCHEDULE:S+" UNSCHEDULE",DISPATCH:S+" DISPATCH",IN_JEOPARDY:S+" IN_JEOPARDY",DELETE_POLYGON:S+" DELETE_POLYGON",CUSTOM_ACTION:S+" CUSTOM_ACTION"}},w={showServiceOnMapId:void 0,showServiceOnMap:!1,reactDomain:void 0,targetOrigin:void 0,reactMapInitialize:!1,iframeMapMode:window.iframeMapMode,debugMode:window.debugMode,iframeWindow:void 0,serviceFields:[],dynamicIcons:{}},T=(d.getLastKnownPositions(),e.fieldsSetFields().then(function(e){w.serviceFields=e.MapInfo}),setTimeout(function(){var e,t,n;w.iframeMapMode===y.IFRAME_TYPE.SECURED&&SfdcApp.iframe&&(w.debugMode?SfdcApp.iframe.addMessageHandler("GanttReactMapIframeDebug",f):SfdcApp.iframe.addMessageHandler("GanttReactMapIframe",f)),w.iframeMapMode===y.IFRAME_TYPE.NORMAL&&(w.targetOrigin=window.location.origin+window.location.pathname,w.iframeWindow=document.getElementById("GanttReactMapIframeSF").contentWindow,e=window,t="message",n=f,e.addEventListener?e.addEventListener(t,n):e.attachEvent&&e.attachEvent("on"+t,n))},0),function(e){w.iframeMapMode===y.IFRAME_TYPE.SECURED&&SfdcApp.iframe&&(w.debugMode?SfdcApp.iframe.sendMessage("GanttReactMapIframeDebug",e):SfdcApp.iframe.sendMessage("GanttReactMapIframe",e)),w.iframeMapMode===y.IFRAME_TYPE.NORMAL&&w.iframeWindow.postMessage(e,w.targetOrigin)}),L=function(t){switch(t.type){case y.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_LOADED:break;case y.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_INITIALIZATION:w.reactMapInitialize=!0,M(),O(),E();break;case y.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_DATA_UPDATE:w.showServiceOnMap&&w.showServiceOnMapId&&setTimeout(function(){var e={serviceId:w.showServiceOnMapId,type:y.IFRAME_SEND_MESSAGES_TYPES.SHOW_SERVICE_ON_MAP};T(e),w.showServiceOnMap=!1,w.showServiceOnMapId=void 0},7e3);break;case y.IFRAME_RECEIVED_MESSAGES_TYPES.VIEW_DETAILS:U(t.id,t.objectType);break;case y.IFRAME_RECEIVED_MESSAGES_TYPES.FLAG_SA:z(t.serviceAppointmentsId);break;case y.IFRAME_RECEIVED_MESSAGES_TYPES.API_REQUEST:H(t.method,t.filter,t.params).then(function(e){"getCustomActions"===t.method?N(e).then(function(e){e={response:e,feature:t.feature,type:y.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};T(e)}).catch(function(e){console.warn(e)}):"getReportRowsForMap"===t.method?I(e).then(function(e){e={response:e,feature:t.feature,type:y.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};T(e)}):"getReportsWithGeolocationCols"===t.method?G(e).then(function(e){e={response:e,feature:t.feature,type:y.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};T(e)}):"getMapReports"===t.method?B(e).then(function(e){e={response:e,feature:t.feature,type:y.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};T(e)}):(e={response:e,feature:t.feature,type:y.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED},T(e))}).catch(function(e){e={response:e,feature:t.feature,type:y.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_FAILED};T(e)});break;case y.IFRAME_RECEIVED_MESSAGES_TYPES.GET_ICON:D(t.hex,t.folder,t.icon,t.iconKey).then(function(e){e={response:e,iconKey:t.iconKey,type:y.IFRAME_SEND_MESSAGES_TYPES.GET_ICON_SUCCEED};T(e)}).catch(function(e){e={response:e,iconKey:t.iconKey,type:y.IFRAME_SEND_MESSAGES_TYPES.GET_ICON_FAILED};T(e)})}},A=function(e){switch(e.type){case y.POLYGON_MENU_ACTIONS.CUSTOM_ACTION:V(e.servicesIds,e.action);break;case y.POLYGON_MENU_ACTIONS.DISPATCH:n.changeStatus(e.servicesIds,h.DISPATCHED).then(function(e){n.drawServicesAndAbsences(e.services)}).catch(function(e){a.addNotification(window.customLabels.Action_Could_Not_Be_Performed,e.message||window.customLabels.user_is_not_allowed_to_perform_action)});break;case y.POLYGON_MENU_ACTIONS.UNSCHEDULE:n.unscheduleServices(e.servicesIds);break;case y.POLYGON_MENU_ACTIONS.SCHEDULE:t.schedule(e.servicesIds);break;case y.POLYGON_MENU_ACTIONS.IN_JEOPARDY:n.setInJeopardy(e.servicesIds)}},N=function(e){for(var t=o.defer(),n={},i=0;i<e.length;i++)a.hasCustomPermission(e[i][window.GanttMap.fieldNames.CustomGanttAction.Permission])&&"map"===e[i][window.GanttMap.fieldNames.CustomGanttAction.Section]&&(n[e[i].Id]=function(e){var t=o.defer();try{var n={};n.id=e.Id,n.name=e[window.GanttMap.fieldNames.CustomGanttAction.Label],n.className=e[window.GanttMap.fieldNames.CustomGanttAction.Class],n.order=e[window.GanttMap.fieldNames.CustomGanttAction.Order],n.permission=e[window.GanttMap.fieldNames.CustomGanttAction.Permission],n.section=e[window.GanttMap.fieldNames.CustomGanttAction.Section],n.visualforce=e[window.GanttMap.fieldNames.CustomGanttAction.Visualforce],e[window.GanttMap.fieldNames.CustomGanttAction.Icon]&&C(k(e[window.GanttMap.fieldNames.CustomGanttAction.Icon].split(","))).then(function(e){e=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),e=window.atob(e).replace(/fill="#[A-Za-z0-9]+"/,'fill="#17325c"'),e=window.btoa(e);n.icon="url('data:image/svg+xml;base64,"+e+"')",t.resolve(n)})}catch(e){t.reject(e)}return t.promise}(e[i]));return o.all(n).then(function(e){t.resolve(e)}).catch(function(e){console.warn(e.message),t.reject()}),t.promise},G=function(i){var e=a.butlerNotifications();if(0===Object.keys(i[0].report).length&&"error"===i[0].color)return 1<=e.filter(function(e){return e.title===window.customLabels.Report_Object_Access_Deny}).length?void 0:void a.addNotification(window.customLabels.Report_Object_Access_Deny,window.customLabels.Report_Object_Access_Error_Message,function(){});var s=o.defer(),t=[];try{for(var n,r=0;r<i.length;r++)i[r].icon&&(n=i[r].icon.split(","),t.push(D("#ffffff",n[0],n[1],"report_"+n[0]+"_"+n[1])))}catch(e){console.warn("failed to add icon to report based on configuration"),s.reject(e)}return o.all(t).then(function(e){for(var t=0,n=0;n<i.length;n++)i[n].icon&&(i[n].icon=e[t],t++);s.resolve(i)}).catch(function(e){s.resolve(reportRows)}),s.promise},B=function(e){for(var t=o.defer(),n=Object.keys(e),i={},s=0;s<n.length;s++)i[n[s]]=I(e[n[s]]);return o.all(i).then(function(e){t.resolve(e)}),t.promise},I=function(n){for(var i=o.defer(),e=[],t=0;t<n.length;t++){var s=n[t],r=s.sObjectType.split(/(?=[A-Z])/).join("_").toLowerCase();"ServiceAppointment"===s.sObjectType&&(r="work_order"),"ServiceResource"===s.sObjectType&&(r="home"),"Asset"===s.sObjectType&&(r="product"),e.push(D("#ffffff","standard",r,"report_"+r))}return o.all(e).then(function(e){for(var t=0;t<n.length;t++)n[t].reportIcon=e[t];i.resolve(n)}).catch(function(e){i.resolve(n)}),i.promise};function C(e){var t=o.defer(),n=new XMLHttpRequest;return n.onload=function(){var e;404==n.status?t.reject():((e=new FileReader).onloadend=function(){t.resolve(e.result)},e.readAsDataURL(n.response))},n.open("GET",e),n.responseType="blob",n.send(),t.promise}function k(e){var e=_slicedToArray(e,2),t=e[0];return window.GanttMap.icons.globalIcon+"/"+t+"/"+e[1]+".svg"}function D(t,n,e,i){var s=o.defer();try{w.dynamicIcons[i]?s.resolve(w.dynamicIcons[i]):C(k([n,e])).then(function(e){e=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),e=window.atob(e).replace(/fill="#[A-Za-z0-9]+"/,'fill="'+t+'"'),e=window.btoa(e);w.dynamicIcons[i]="data:image/svg+xml;charset=utf-8;base64,"+e,s.resolve(w.dynamicIcons[i])}).catch(function(e){C(k([n,"report"])).then(function(e){e=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),e=window.atob(e).replace(/fill="#[A-Za-z0-9]+"/,'fill="'+t+'"'),e=window.btoa(e);w.dynamicIcons[i]="data:image/svg+xml;charset=utf-8;base64,"+e,s.resolve(w.dynamicIcons[i])})})}catch(e){s.reject(e.message)}return s.promise}function R(e){var t;!e&&(b||w.reactMapInitialize)||(e=q(),t=P(),t={ganttMapDefinitions:window.GanttMap,livePositions:t,territories:e,type:y.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_INITIALIZATION,ganttDate:scheduler._min_date},T(t),b=!0)}function F(e,t){var n,i=2<arguments.length&&void 0!==arguments[2]&&arguments[2];w.reactMapInitialize?_.isEmpty(e)&&_.isEmpty(t)||(n={clearServices:!1,services:$(e),deletedServicesIds:t,type:y.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_SERVICES_UPDATE},T(n)):setTimeout(function(){F(e,t,i)},5e3)}function $(e){var t={};if(Array.isArray(e))for(var n=0;n<e.length;n++)t[e[n].id]=x(e[n]);else for(var i in e)t[e[i].id]=x(e[i]);return t}var H=function(s,r){for(var e=arguments.length,o=Array(2<e?e-2:0),t=2;t<e;t++)o[t-2]=arguments[t];var n={},i=RemoteActions.getReportsWithGeolocationCols.split("."),a=(n[i[i.length-1]]=!0,!(s in n));return new Promise(function(n,i){var e=(e=[RemoteActions[s]]).concat.apply(e,o).concat(function(e,t){t.status?n(e):i(t)}).concat({buffer:a,escape:!1}),t=e,t=r?e.filter(function(e){return!!e}):e.map(function(e){return void 0===e?null:e});Visualforce.remoting.Manager.invokeAction.apply(Visualforce.remoting.Manager,t)})},V=function(e,t){var n,i;t.visualforce?(n=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),i=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===e.length?l.open(t.name,t.visualforce+"?id="+e[0]+"&start="+n+"&end="+i):l.open(t.name,t.visualforce+"?services="+e.join(",")+"&start="+n+"&end="+i)):m.callRemoteAction(RemoteActions.runCustomServiceAction,t.className,e,scheduler._min_date,scheduler._max_date).then(function(e){v.updateGantt(),e&&a.addNotification(t.name,e,null,null)}).catch(function(e){return a.addNotification(t.name,e.message,null,null)})},U=function(e,t){switch(t){case"service":n.recentlyUsed[e]=!0,s.open(e);break;case"liveposition":case"resource":r.open(e);break;default:a.openSObjectLink(e)}},z=function(e){e.map(function(e){n.flagged[e]=!0,scheduler.updateEvent(e)})},O=function(){var e;w.reactMapInitialize?(e={filteredServices:j(),type:y.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_UPDATE_FILTER},T(e)):setTimeout(function(){R(!1)},5e3)},M=function e(){var t;w.reactMapInitialize?(t={relevantStms:W(),type:y.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_UPDATE_VIEW},T(t)):setTimeout(function(){e()},5e3)},E=function e(){var t;w.reactMapInitialize?(t={livePositions:P(),type:y.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_LIVE_POSITION},T(t)):setTimeout(function(){e(servicesToUpdate,deletedServicesIds,clearServices)},5e3)},e=(g.register("positions",function(e){E()}),_.debounce(O,300,{maxWait:1e3})),g=_.debounce(M,300,{maxWait:1e3}),j=function(){for(var e={},t=0;t<n.filteredServices.servicesArray.length;t++)e[n.filteredServices.servicesArray[t].id]=!0;return e},x=function(e){var t={fields:{}};t.latitude=e.latitude,t.longitude=e.longitude,t.pinned=e.pinned,t.statusCategory=e.statusCategory,t.resourceId=e.resourceId,t.id=e.id,t.Status=e.Status,t.AppointmentNumber=e.AppointmentNumber,t.dragData=e.isScheduled()?null:a.getRelevantDataForDraggingService(e),window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Drag_And_Drop||(t.dragData=null),t.icons=e.icons,t.color=window.paletteViewActive&&e.ganttPaletteColor?e.ganttPaletteColor.color:e.ganttColor||a.getColorHexByCategory(e.statusCategory);for(var n=0;n<w.serviceFields.length;n++){var i,s,r=void 0;void 0!==e.fields[w.serviceFields[n].APIName]&&(i=e.fields[w.serviceFields[n].APIName],s=e.fields[w.serviceFields[n].FullAPIName],r=w.serviceFields[n].APIName!==w.serviceFields[n].FullAPIName?{Value:i,Id:s}:{Value:i}),t.fields[w.serviceFields[n].APIName]=r}return t},W=function(){var e,t=scheduler.getState().min_date,n=scheduler.getState().max_date,i={},s=c.resourcesByPrimariesAndRelocations();for(e in s){var r,o=s[e];for(r in o){var a=o[r];isIntersect(t,n,a.effectiveStartDate,a.effectiveEndDate)&&(i[a.id]=a)}}return i},P=function(){var e,t=scheduler.getState().min_date,n=scheduler.getState().max_date,i=c.resourcesAndTerritories(),s={},r={};for(e in s=window.customPermissions.Hide_Live_Locations_Gantt_Map_Layer||isLastKnownFieldsNotAllowed?s:d.lastKnownPositions()){var o,a=i[e];for(o in a){var l=a[o];isIntersect(t,n,l.effectiveStartDate,l.effectiveEndDate)&&(r[s[e].id]={latitude:s[e].latitude,longitude:s[e].longitude,resource:l.serviceResource__r,lastKnowLocation:s[e]})}}return r},q=function(){var t=p.GetUserSettingsProperty("locations"),n=u.territories();return Object.keys(n).filter(function(e){return t.includes(e)}).reduce(function(e,t){return e[t]=n[t],e},{})};return{showServiceOnMap:function(e,t,n){w.showServiceOnMap=!0,w.showServiceOnMapId=e,"map"===n||t||i.$broadcast("changeWorkingState","map"),w.reactMapInitialize?setTimeout(function(){var e={serviceId:w.showServiceOnMapId,type:y.IFRAME_SEND_MESSAGES_TYPES.SHOW_SERVICE_ON_MAP};T(e),w.showServiceOnMap=!1,w.showServiceOnMapId=void 0},150):R(!1)},initializeGanttMap:R,updateGanttMapServices:F,updateGanttMapFilter:e,updateGanttMapView:g,IFRAME_SEND_MESSAGES_TYPES:y.IFRAME_SEND_MESSAGES_TYPES,reactDomain:w.reactDomain}}e.$inject=["$rootScope","$q","TimePhasedDataService","LastKnownPositionService","utils","servicesService","ServiceAppointmentLightboxService","ResourceLightboxService","bulkScheduleService","FieldSetFieldsService","GeneralLightbox","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","SERVICE_STATUS","RegisterService","DeltaService"],angular.module("serviceExpert").factory("MapService",e)}(),!function(){function e(i,s,r,a,l,e,c,d){for(var u=null,t=[],n=0;n<60;n++)t.push(n);function o(){l.setLightBoxStatus(!1),u.$destroy()}function p(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function m(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function h(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function g(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function v(){var e,t,n,i,s,r=[],o=void 0;for(s in u.selectedLocations)u.selectedLocations[s]&&r.push(s);0===r.length?alert(customLabels.noLocationWasSelected):(e=u.actionStart,(o=u.actionFinish).setDate(o.getDate()+1),t="noFilter"===u.optimizeSelectedFilter?null:u.optimizeSelectedFilter,a.SetUserSettingsProperty("Optimization_Request_Filter_Field__c",t),i="noFilter"===u.optimizeSelectedBoolean?__gantt.KeepAppointmentsScheduledNoneSelectValue:u.optimizeSelectedBoolean,n="all"===u.optimizeAllServices,l.setBulkActionRunning(),d.callRemoteAction(RemoteActions.runOptimization,e,o,r,n,u.orphanServices,u.selectedPolicy.Id,t,i).then(function(e){e?d.callRemoteAction(RemoteActions.getRequestObject,e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?c.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){c.openSObjectLink("../"+e)},e.Id):c.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){c.openSObjectLink("../"+e)},e.Id)}):c.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).catch(function(e){console.warn("runOptimization failed :("),console.log(e),c.addNotification(customLabels.Optimization_Failed,e.message)}).finally(function(){l.setBulkActionRunning(!1)}),u.closeLightbox())}function f(){return u.selectedPolicy[fieldNames.SchedulingPolicy.DailyOptimization]}return{open:function(){(u=s.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)});var e=a.GetUserSettingsProperty("locations");u.filteredLocations=e.map(function(e){return r.territories()[e]}).sort(function(e,t){return e.name.localeCompare(t.name)}),u.o2LocationsIds=u.filteredLocations.filter(function(e){return e.o2Enabled}).map(function(e){return e.id}),u.displayStayScheduled=window.customPermissions.Keep_Scheduled&&0<u.o2LocationsIds.length,u.disableStayScheduled=u.o2LocationsIds.length!==u.filteredLocations.length,u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate()-1,0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=p,u.dateSelectStartWidget=m,u.validateDatesStart=h,u.validateDatesEnd=g,u.optimizeAllServices="all",u.runOptimizion=v,u.selectedLocations={},u.checkBoxFields=c.checkBoxFields,u.optimizeSelectedFilter=a.GetUserSettingsProperty("Optimization_Request_Filter_Field__c")?a.GetUserSettingsProperty("Optimization_Request_Filter_Field__c"):"noFilter",u.optimizeSelectedBoolean=""===__gantt.bgo.stayScheduled?"noFilter":__gantt.bgo.stayScheduled,u.orphanServices=!1,u.isInDayPolicy=f,d.callRemoteAction(RemoteActions.getBooleanFieldsForOptimization,"filter").then(function(e){e=Object.entries(e);(e=e.map(function(e){return{value:e[0],label:e[1]}})).sort(function(e,t){return e.label.localeCompare(t.label)}),u.booleanFieldsForSAFiltering=e,void 0===u.booleanFieldsForSAFiltering.find(function(e){return e.value===u.optimizeSelectedFilter})&&(u.optimizeSelectedFilter="noFilter")}).catch(function(e){console.log(e),u.booleanFieldsForSAFiltering=[{value:"noFilter",label:"None"}]}),d.callRemoteAction(RemoteActions.getBooleanFieldsForOptimization,"stayScheduled").then(function(e){e=Object.entries(e);(e=e.map(function(e){return{value:e[0],label:e[1]}})).sort(function(e,t){return e.label.localeCompare(t.label)}),u.booleanFieldsForSAStayScheduled=e}).catch(function(e){console.log(e),u.booleanFieldsForSAStayScheduled=[{value:"noFilter",label:"None"}]}),u.changePolicy=function(){u.selectedPolicy[fieldNames.SchedulingPolicy.DailyOptimization]?u.optimizeSelectedBoolean=""===__gantt.inday.stayScheduled?"noFilter":__gantt.inday.stayScheduled:u.optimizeSelectedBoolean=""===__gantt.bgo.stayScheduled?"noFilter":__gantt.bgo.stayScheduled},u.onSelectTerritory=function(){var e,t=[];for(e in u.selectedLocations)u.selectedLocations[e]&&t.push(e);var n=t.filter(function(e){return u.o2LocationsIds.includes(e)});u.orphanServices&&n.length===t.length||0<t.length&&n.length===t.length?u.disableStayScheduled=!1:u.disableStayScheduled=!0},u.policyOptions=l.policies,u.selectedPolicy=u.policyOptions[0],u.changePolicy();for(var t=0;t<l.policies.length;t++)if(l.policies[t].Id===l.selectedPolicyId){u.selectedPolicy=l.policies[t];break}u.selectedPolicy[fieldNames.SchedulingPolicy.DailyOptimization]&&(u.optimizeSelectedBoolean=""===__gantt.inday.stayScheduled?"noFilter":__gantt.inday.stayScheduled),e='<svg aria-hidden="true" class="date-icon">\n                                <use xlink:href="'+lsdIcons.calendar+'"></use>\n                              </svg>';var n=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div id="BulkActionsLightbox" class="LightboxContainer OptimizationLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" fsl-key-press tabindex="0">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header optimization-light-box-header">'+customLabels.Optimize+'</h1>\n                        </div>\n\n                        <div class="lightboxContentContainerOptimization">\n\n                            <div class="field-container territories-field-container">\n                                    <label>\n                                    '+customLabels.ServiceTerritoriesLabel+"\n                                    <cs-tooltip>"+customLabels.ServiceTerritoryTooltip+'</cs-tooltip>\n                                    </label> \n                                    <multi-dropdown options="filteredLocations" type="territories"></multi-select-dropdown>\n                            </div>\n\n                            <div class="bulkOptimizeOptions bulkOptimizeOptionsOptimization">\n                                <div class="dates-container">\n                                    <div class="field-container">\n                                        <label>'+customLabels.StartDate+'</label>\n                                        <label id="bulkStartOptimize" class="bulkDatePickerOptimization" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></label>\n                                        '+e+'\n                                    </div>\n                                    <div class="field-container">\n                                        <label>'+customLabels.EndDateOptimization+'</label>\n                                        <label id="bulkFinishOptimize" class="bulkDatePickerOptimization" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></label>\n                                        '+e+'\n                                    </div>\n                                </div>\n\n                                <div class="field-container">\n                                    <label>'+customLabels.SAIncludedForOptimization+'</label>\n                                    <label>\n                                        <input type="radio" ng-model="optimizeAllServices" name="serviceOption" value="unscheduled">\n                                        '+customLabels.OnlyUnscheduled+'\n                                    </label>\n                                    <label>\n                                        <input type="radio" ng-model="optimizeAllServices" name="serviceOption" value="all">\n                                        '+customLabels.BothScheduledAndUnscheduled+'\n                                    </label>\n                                </div>\n\n                                <div class="field-container">\n                                    <label>'+customLabels.SelectOptimizationPolicy+'</label>\n                                    <select class="select-optimization-input" ng-model="selectedPolicy" title="{{selectedPolicy.Name}}" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>\n                                </div>\n\n                                <div class="field-container">\n                                    <label>\n                                        '+customLabels.FilterSABy+"\n                                        <cs-tooltip>"+customLabels.FilterTooltip+'</cs-tooltip>\n                                    </label>\n                                    <select ng-model="optimizeSelectedFilter" class="select-optimization-input">\n                                        <option ng-repeat="option in booleanFieldsForSAFiltering" value="{{option.value}}" ng-bind="option.label"></option>\n                                        <option value="noFilter">'+customLabels.IncludeAllTypes+'</option>\n\t\t\t\t\t\t\t\t    </select>\n                                </div>\n\n                                <div class="field-container" ng-show="displayStayScheduled">\n                                    <label>\n                                        '+customLabels.KeepTheseAppointmentsScheduled+"\n                                        <cs-tooltip>"+customLabels.KeepScheduledTootltip+'</cs-tooltip>\n                                    </label>\n                                    <select ng-disabled="disableStayScheduled" ng-model="optimizeSelectedBoolean" ng-class="{\'select-optimization-input-disabled\': disableStayScheduled === true}" class="select-optimization-input">\n                                        <option ng-repeat="option in booleanFieldsForSAStayScheduled" value="{{option.value}}" ng-bind="option.label"></option>\n                                        <option value="noFilter">'+customLabels.None+'</option>\n\t\t\t\t\t\t\t\t    </select>\n                                </div>\n\n\n                                <div class="inday-policy-selected" ng-show="isInDayPolicy()">'+customLabels.In_Day_Policy_Selected+'</div>\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <button class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</button>\n                        </div>\n\n\n                    </div>\n                </div>\n            ");n.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(n),u.closeLightbox=o,u.$on("$destroy",function(){return n.remove()}),i(n)(u),n.show(),l.setLightBoxStatus(),n.children().find("input[type=checkbox]").focus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("optimizeLightboxService",e)}(),function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(i.push(o.value),!n||i.length!==n);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")});function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function GanttService(e,t){if(!t){for(var n in this.sfdcType="service",this.fields={},e.Fields)this.fields[n]=e.Fields[n];this.id=e.Fields.Id||null,this.name=e.Fields.AppointmentNumber||null,this.AssignedResourceLastModifiedDate=e.AssignedResourceLastModifiedDate||null,this.ServiceAppointmentLastModifiedDate=e.ServiceAppointmentLastModifiedDate||null,this.accountName=e.Fields["Account.Name"]||null,this.accountId=e.Fields.AccountId||null,this.latitude=e.Fields.Latitude||null,this.longitude=e.Fields.Longitude||null,this.arrivalWindowEndTime=e.Fields.ArrivalWindowEndTime||null,this.arrivalWindowStartTime=e.Fields.ArrivalWindowStartTime||null,this.dueDate=e.Fields.DueDate||null,this.ganttDisplay=e.Fields.Gantt_Display_Date__c||null,this.durationType=e.Fields.DurationType||null,this.earliestStartTime=e.Fields.EarliestStartTime||null,this.estDuration=e.Fields.Duration||null,this.travelTimeFrom=e.Fields.EstimatedTravelTimeFrom__c||null,this.travelTimeTo=e.Fields.EstimatedTravelTime||null,this.ganttLabel=e.Fields.GanttLabel__c||null,this.jeopardy=e.Fields.InJeopardy__c||null,this.jeopardyReason=e.Fields.jeopardyReasonTranslated||e.Fields.InJeopardyReason__c||null,this.parentRecord=e.Fields.ParentRecordId||null,this.parentRecordStatus=e.Fields.ParentRecordStatusCategory||null,this.parentRecordType=e.Fields.ParentRecordType||null,this.pinned=e.Fields.Pinned__c||!1,this.isBundleMember=e.Fields.IsBundleMember||!1,this.isBundle=e.Fields.IsBundle||!1,this.RelatedBundle=e.Fields.RelatedBundleId||!1,this.schedEndTime=e.Fields.SchedEndTime||null,this.schedStartTime=e.Fields.SchedStartTime||null,this.serviceTerritory=e.Fields.ServiceTerritory||null,this.serviceTerritoryName=e.Fields["ServiceTerritory.Name"]||null,this.status=e.Fields.Status||null,this.statusCategory=e.Fields.StatusCategory||null,this.subject=e.Fields.Subject||null,this.ganttColor=e.Fields.GanttColor__c||null,this.resource=e.Resource||null,this.resourceName=e.ResourceName||null,this.resourceContractor=e.ResourceContractor||null,this.isAssignToCrew=e.IsAssignToCrew||null,this.assignedResource=e.AssignedResource||null,this.violations=null,this.relatedTo=e.relatedTo||null,this.relatedFather=null,this.priority=this.minPriority,this.relatedFather=e.relatedFather,this.policyUsed=e.Fields.Scheduling_Policy_Used__c||null,this.scheduleMode=e.Fields.Schedule_Mode__c||null,this.emergency=e.Fields.Emergency__c||!1,this.isServiceInChain=(usingNewMstModel||e.IsInO2Territory)&&e.isServiceInChain,this.relatedService2=e.relatedService2||null,this.relatedService1=e.relatedService1||null,this.relationshipType=e.relationshipType||null,this.isImmidietlyFollow="Immediately Follow"===e.relationshipType,this.isInO2Territory=e.IsInO2Territory,this.ganttPaletteColor=null,this.Use_Async_Logic=e.Fields.Use_Async_Logic__c||!1,this.icons=e.Fields.GanttIcon__c?e.Fields.GanttIcon__c.split(";"):null,this.totalModifiedTimes=this.ServiceAppointmentLastModifiedDate,this.fromGetCandidateFlow=!1,this.isOffsiteAppointment=e.Fields.IsOffsiteAppointment||!1,this.AssignedResourceLastModifiedDate&&(this.totalModifiedTimes+=this.AssignedResourceLastModifiedDate),this.icons&&(this.icons=this.icons.map(function(e){return window.encodeURI(e)}));var i,t="WorkOrder"==e.Fields.ParentRecordType?CustomSettings.woPriorityField:CustomSettings.woliPriorityField,t=(t&&e.ParentFields&&e.ParentFields[t]&&(this.priority=e.ParentFields[t]),fslNamespace?mdtBooleanField.replace(fslNamespace+"__",""):mdtBooleanField);for(i in this.isMDT=!!e.Fields[t],e.Fields.MDT_Operational_Time__c?this.calculateMdtTimes(e.Fields.MDT_Operational_Time__c):this.isMDT&&(this.mdtTimes={travel:[],working:[]}),this.parentFields={},e.ParentFields)this.parentFields[i]=e.ParentFields[i];this.setSchedulerProperties(),addFieldSetToServiceObject(GanttService.prototype.allFieldSetsSet,e.Fields,this),this.isMDT&&(this.travelTimeFrom=0,this.travelTimeTo=0)}}function isDateIntersectRange(e,t,n){return t<=e&&e<n}function getGanttResourceWithSecondaryStms(e){if(showSecondarySTMs){var t=e.resourceId.split(",");if(e.resourceBeforeDrag&&e.resourceBeforeDrag!=e.resourceId&&1<t.length)for(var n=0;n<t.length;n++)if(e.resourceBeforeDrag.split(",")[n]!=t[n]){e.resourceId=t[n];break}}}function addFieldSetToServiceObject(e,t,n){for(var i in e){var s=null;if((s=t[e[i].APIName])||0==s){switch(e[i].Type){case"DATE":case"DATETIME":if(null===s)continue;s=__setTimeZoneOffsetToDateField(s),n.fields[e[i].APIName]=s.getTime();break;case"REFERENCE":var r=e[i].JsAPIName.replace("__r","__c");n[r]=t[r]}n[e[i].APIName]=s}}}function LastKnownPosition(e){this.id=e.Id,this.latitude=e[fieldNames.ServiceResource.LastKnownLocation__Latitude__s],this.longitude=e[fieldNames.ServiceResource.LastKnownLocation__Longitude__s],this.lastModifiedDate=e[fieldNames.ServiceResource.LastKnownLocationUpdate__c];e=void 0;this.lastModifiedDate&&(e=60*new Date(this.lastModifiedDate).getTimezoneOffset()*1e3),this.lastModifiedDate=this.lastModifiedDate?new Date(this.lastModifiedDate+e):null}function OptimizationRequest(e){var t;if(this.id=e.Id,this.lastModifiedDate=e.LastModifiedDate,this.lastModifiedDate&&(t=60*new Date(this.lastModifiedDate).getTimezoneOffset()*1e3,this.lastModifiedDate=new Date(this.lastModifiedDate.valueOf()+t)),this.name=e.Name,this.scheduledAmount=e[fieldNames.Optimization_Request.Objects_Scheduled__c],this.objectToScheduled=e[fieldNames.Optimization_Request.Objects_To_Schedule__c],this.status=e[fieldNames.Optimization_Request.Status__c]||null,this.statusLabel=e.statusLabel||e[fieldNames.Optimization_Request.Status__c]||null,this.allTasks=e[fieldNames.Optimization_Request.All_Tasks_Mode__c]||null,this.includeEmptyLocations=e[fieldNames.Optimization_Request.Include_Services_With_Empty_Location__c]||null,this.type=e[fieldNames.Optimization_Request.Type__c]||null,this.failureReason=e[fieldNames.Optimization_Request.Failure_Reason__c]||null,this.failureDetails=e[fieldNames.Optimization_Request.Failure_Details__c]||null,this.optimizationData=e[fieldNames.Optimization_Request.Optimization_Data__c]||null,this.orgResourceAbsence=e[fieldNames.Optimization_Request.Originating_Resource_Absence__c]||null,this.orgServiceAppointment=e[fieldNames.Optimization_Request.Originating_Service_Appointment__c]||null,this.policy=e[fieldNames.Optimization_Request.Scheduling_Policy__c]||null,this.serviceAppointment=e[fieldNames.Optimization_Request.Service_Appointment__c]||null,this.resource=e[fieldNames.Optimization_Request.Service_Resource__c]||null,this.result=e[fieldNames.Optimization_Request.Result__c]||null,this.schedulingRecipe=e[fieldNames.Optimization_Request.Scheduling_Recipe__r]||null,this.territories=[],this.resourceName=null,this.resource&&(this.resourceName=e[fieldNames.Optimization_Request.Service_Resource__c.replace("__c","__r")].Name),this.requestProgressStart=e[fieldNames.Optimization_Request.Request_Progress_Start__c]||null,e[territoryOptimizationRequestRelationshipName])for(var n=0;n<e[territoryOptimizationRequestRelationshipName].length;n++)this.territories.push(new TerritoryOptimizationRequest(e[territoryOptimizationRequestRelationshipName][n]));this.timespan=null,this.finish=e[fieldNames.Optimization_Request.Finish__c]||null,this.start=e[fieldNames.Optimization_Request.Start__c]||null,this.start=__setTimeZoneOffsetToDateField(this.start),this.finish=__setTimeZoneOffsetToDateField(this.finish)}function ResourceAbsence(e){this.id=e.Id,this.end=e[fieldNames.ResourceAbsence.End],this.resource=e[fieldNames.ResourceAbsence.Resource],this.start=e[fieldNames.ResourceAbsence.Start],this.absenceType=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.reason=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.ganttLabel=e[fieldNames.ResourceAbsence.GanttLabel__c]||null,this.lastModifiedDate=e.LastModifiedDate||null,this.name=window.isOptimizationViewer?e.Id:e.AbsenceNumber,this.resourceName=window.isOptimizationViewer?e.ResourceId:e[fieldNames.ResourceAbsence.Resource__r].Name,this.ganttColor=e[fieldNames.ResourceAbsence.Gantt_Color__c],this.approved=e[fieldNames.ResourceAbsence.Approved__c],this.latitude=e.Latitude,this.longitude=e.Longitude,this.travelTo=e[fieldNames.ResourceAbsence.EstTravelTime__c]?60*e[fieldNames.ResourceAbsence.EstTravelTime__c]:0,this.travelFrom=e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]?60*e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]:0,this.sfdcType="absence",e.RecordType&&e.RecordType.DeveloperName&&"Non_Availability"==e.RecordType.DeveloperName?this.type="na":this.type="break",this.setSchedulerProperties()}function sortByServiceTerritoryType(n){var t={};try{var e=Object.keys(n);e.sort(function(e,t){return"P"===n[e].serviceTerritoryType&&"P"!==n[t].serviceTerritoryType?-1:"P"!==n[e].serviceTerritoryType&&"P"===n[t].serviceTerritoryType?1:0}),e.forEach(function(e){t[e]=n[e]})}catch(e){console.warn("sortByServiceTerritoryType failed: ",e)}return t}function ResourceCapacity(e){this.sfdcType="capacity",this.id=e.Id,this.end=e[fieldNames.ResourceCapacity.EndDate],this.resource=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceId=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceName=e[fieldNames.ResourceCapacity.ServiceResource__r]?e[fieldNames.ResourceCapacity.ServiceResource__r].Name:null,this.start=e[fieldNames.ResourceCapacity.StartDate],this.hoursInUse=e[fieldNames.ResourceCapacity.HoursInUse__c],this.hoursPerTimePeriod=void 0!==e[fieldNames.ResourceCapacity.CapacityInHours]?e[fieldNames.ResourceCapacity.CapacityInHours]:null,this.minutesUsed=e[fieldNames.ResourceCapacity.MinutesUsed__c],this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.CapacityNumber,this.timePeriod=e[fieldNames.ResourceCapacity.TimePeriod],this.workItemsAllocated=e[fieldNames.ResourceCapacity.Work_Items_Allocated__c],this.workItemsPerTimePeriod=void 0!==e[fieldNames.ResourceCapacity.CapacityInWorkItems]?e[fieldNames.ResourceCapacity.CapacityInWorkItems]:null,window.isOptimizationViewer&&(this.resourceName=e[fieldNames.ResourceCapacity.ServiceResource]),this.setSchedulerProperties()}function addDaysToDate(e,t){t*=864e5;return new Date(e.getTime()+t)}function calcCapacityPercentage(e,t){return parseFloat((e/t*100).toFixed(2))}function ResourcesAndTerritories(e){this.id=e.Id,this.name=e.MemberNumber,this.effectiveEndDate=e[fieldNames.ServiceTerritoryMember.EffectiveEndDate]||null,this.effectiveStartDate=e[fieldNames.ServiceTerritoryMember.EffectiveStartDate],this.latitude=e[fieldNames.ServiceTerritoryMember.Latitude],this.longitude=e[fieldNames.ServiceTerritoryMember.Longitude],this.serviceResource=e[fieldNames.ServiceTerritoryMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceTerritoryMember.ServiceResource__r],this.serviceTerritory=e[fieldNames.ServiceTerritoryMember.ServiceTerritory],this.serviceTerritory__r=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r],this.serviceTerritoryType=e[fieldNames.ServiceTerritoryMember.TerritoryType],this.operatingHours=e[fieldNames.ServiceTerritoryMember.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritoryMember.OperatingHours__r],this.effectiveStartDate=__setTimeZoneOffsetToDateField(this.effectiveStartDate,!1,!0),this.effectiveEndDate=__setTimeZoneOffsetToDateField(this.effectiveEndDate,!1),this.timezone=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r][fieldNames.ServiceTerritory.OperatingHours__r][fieldNames.OperatingHours.Timezone]}function ServiceCrewMember(e){this.id=e.Id,this.name=window.isOptimizationViewer?e.Id:e.Name,this.endDate=e[fieldNames.ServiceCrewMember.EndDate]||null,this.startDate=e[fieldNames.ServiceCrewMember.StartDate],this.serviceResource=e[fieldNames.ServiceCrewMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceCrewMember.ServiceResource__r],this.serviceCrew=e[fieldNames.ServiceCrewMember.ServiceCrew],this.serviceCrew__r=window.isOptimizationViewer?{Name:this.serviceCrew,Id:this.serviceCrew}:e[fieldNames.ServiceCrewMember.ServiceCrew__r],this.leader=e[fieldNames.ServiceCrewMember.Leader],this.ganttLabel=e[fieldNames.ServiceCrewMember.GanttLabel],this.ganttColor=e.ServiceCrew?e.ServiceCrew[fieldNames.ServiceCrew.GanttColor__c]:null,this.startDate=__setTimeZoneOffsetToDateField(this.startDate,!1,!0),this.endDate=__setTimeZoneOffsetToDateField(this.endDate,!1)}function getTimezoneOffset(e){return 1e3-(new Date((new Date).getTime()+1e3*(new Date).getTimezoneOffset()*60).getTime()-new Date((new Date).toLocaleString("en",{timeZone:e})).getTime())}function addTimezoneOffsetToDate(e,t){return new Date(e.getTime()+t)}function ServiceResource(e,t){var n=this;t||(this.id=e.Id,this.online=!1,this.isUndestaffOrOverStaff=!1,this.name=e.Name,this.isCapacityBased=e[fieldNames.ServiceResource.IsCapacityBased],this.description=e[fieldNames.ServiceResource.Description]||"",this.isOptimizationCapable=e[fieldNames.ServiceResource.IsOptimizationCapable],this.relatedRecord=e[fieldNames.ServiceResource.RelatedRecord],this.relatedRecord__r=e[fieldNames.ServiceResource.RelatedRecord__r],this.resourceType=e[fieldNames.ServiceResource.ResourceType],this.ganttLabel=e[fieldNames.ServiceResource.GanttLabel__c],this.lastKnownLongitude=e[fieldNames.ServiceResource.LastKnownLongitude],this.lastKnownLocationDate=e[fieldNames.ServiceResource.LastKnownLocationDate],this.lastKnownLatitude=e[fieldNames.ServiceResource.LastKnownLatitude],this.serviceCrew=e[fieldNames.ServiceResource.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceResource.ServiceCrew__r],this.relatedRecord__r&&(this.pictureLink=this.relatedRecord__r.SmallPhotoUrl),this.onlineOffset=e[fieldNames.ServiceResource.Online_Offset__c]||orgOnlineOffset,this.pictureLink&&this.pictureLink.endsWith("profilephoto/005/T")&&(this.pictureLink=null),e[fieldNames.ServiceResource.PictureLink]&&(this.pictureLink=e[fieldNames.ServiceResource.PictureLink]),this.skills={},(this.sobject=e)[fieldNames.ServiceResource.Skills]&&e[fieldNames.ServiceResource.Skills].forEach(function(e){n.checkIfResourceAlreadyHasSkill(n.skills,e.Id,e.SkillId)||(n.skills[e[fieldNames.ServiceResourceSkill.Skill]]?(Array.isArray(n.skills[e[fieldNames.ServiceResourceSkill.Skill]])||(n.skills[e[fieldNames.ServiceResourceSkill.Skill]]=[n.skills[e[fieldNames.ServiceResourceSkill.Skill]]]),n.skills[e[fieldNames.ServiceResourceSkill.Skill]].push(new ServiceResourceSkill(e))):n.skills[e[fieldNames.ServiceResourceSkill.Skill]]=new ServiceResourceSkill(e))}))}function ServiceResourceSkill(e){this.id=e.Id,this.name=e.SkillNumber,this.effectiveEndDate=window.isOptimizationViewer?e[fieldNames.ServiceResourceSkill.EffectiveEndDate]&&new Date(e[fieldNames.ServiceResourceSkill.EffectiveEndDate]).getTime():e[fieldNames.ServiceResourceSkill.EffectiveEndDate],this.effectiveStartDate=window.isOptimizationViewer?e[fieldNames.ServiceResourceSkill.EffectiveStartDate]&&new Date(e[fieldNames.ServiceResourceSkill.EffectiveEndDate]).getTime():e[fieldNames.ServiceResourceSkill.EffectiveStartDate],this.level=e[fieldNames.ServiceResourceSkill.SkillLevel],this.serviceResource=e[fieldNames.ServiceResourceSkill.ServiceResource],this.skill=e[fieldNames.ServiceResourceSkill.Skill];var e=void 0,t=void 0;this.effectiveStartDate&&(e=60*new Date(this.effectiveStartDate).getTimezoneOffset()*1e3),this.effectiveEndDate&&(t=60*new Date(this.effectiveEndDate).getTimezoneOffset()*1e3),this.effectiveStartDate=this.effectiveStartDate?new Date(this.effectiveStartDate+e):new Date(0),this.effectiveEndDate=this.effectiveEndDate?new Date(this.effectiveEndDate+t):new Date(864e11)}function ServiceTerritory(e){this.id=e.Id,this.name=e.Name,this.latitude=e[fieldNames.ServiceTerritory.Latitude],this.longitude=e[fieldNames.ServiceTerritory.Longitude],this.operatingHours=e[fieldNames.ServiceTerritory.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritory.OperatingHours__r],this.description=e[fieldNames.ServiceTerritory.Description],this.parentTerritory=e[fieldNames.ServiceTerritory.ParentTerritory__r]?e[fieldNames.ServiceTerritory.ParentTerritory]:void 0,this.isActive=e[fieldNames.ServiceTerritory.IsActive],this.o2Enabled=__gantt.isO2EngineOn&&(__gantt.isO2ForAllTerritoriesOn||e[fieldNames.ServiceTerritory.O2_Enabled__c]),e[fieldNames.ServiceTerritory.ParentTerritory__r]&&(this.parentTerritory=new ServiceTerritory(e[fieldNames.ServiceTerritory.ParentTerritory__r]))}function TerritoryOptimizationRequest(e){this.id=e.Id,this.optimizationRequest=e[fieldNames.TerritoryOptimizationRequest.OptimizationRequest]||null,this.serviceTerritory=e[fieldNames.TerritoryOptimizationRequest.ServiceTerritory]||null,this.serviceTerritoryName=null,this.serviceTerritory&&(this.serviceTerritoryName=e[fieldNames.TerritoryOptimizationRequest.ServiceTerritory.replace("__c","__r")].Name||null)}!function(){function e(t,o,a,i,N,G,B){var e,n={RESET:"RESET",UPDATE:"UPDATE"},l={CREATE:"1",UPDATE:"2"},s=window.__gantt.pushService.bulkSizeOfServicesToUpdate,c=void 0,r=void 0,d=void 0,u=void 0,p=void 0,$=0,H=2,m=!1,h=!0,g=!1,v=[],f=new Set,S=[],_=[],b=window.fslNamespace,y=null,w={ServiceAppointment:new Set,ResourceAbsence:new Set},V=new Set(["Latitude","Longitude","AbsenceNumber","Gantt_Color__c","EstTravelTime__c","EstTravelTimeFrom__c","Start","End","Resource.Name","Type","TypeLabel","GanttLabel__c","Approved__c","isDeleted"]),U=new Set(["LastKnownLocationDate","LastKnownLatitude","LastKnownLongitude"]),T=new Set(["ServiceResourceId","EstimatedTravelTime","EstimatedTravelTimeFrom__c"]),L={ServiceAppointment:["SchedStartTime","SchedEndTime"],ResourceAbsence:["Start","End","ResourceId",b+"__EstTravelTime__c",b+"__EstTravelTimeFrom__c"],AssignedResource:[].concat(_toConsumableArray(T))},A=[],z=[],I=b+"__Time_Dependency__c",C=b+"__Optimization_Request__c",k={positions:[],optimizationRequests:[],rules:[]},D=(_defineProperty(e={ServiceAppointment:[],ResourceAbsence:[],ServiceResource:[],AssignedResource:[],ServiceResourceCapacity:[]},I,[]),_defineProperty(e,C,[]),e),R=_defineProperty({ServiceAppointment:[],ResourceAbsence:[],ServiceResourceCapacity:[],AssignedResource:[]},I,[]);async function F(t){return new Promise(function(e){if(0===t.length)return e();D.ServiceAppointment=[].concat(_toConsumableArray(t.slice(s))),t=t.slice(0,s),o.callRemoteAction(RemoteActions.getServicesById,t).then(async function(e){e=u.updateTimePhaseData(e,"service").services;d.drawServicesAndAbsences(e),D.ServiceAppointment.size&&(t=D.ServiceAppointment,await F([].concat(_toConsumableArray(t))))}).catch(function(e){console.log(e)}).finally(function(){f=new Set([].concat(_toConsumableArray(f),_toConsumableArray(utils.getRelatedServices([].concat(_toConsumableArray(w.ServiceAppointment)))))),e()})})}function j(i){return new Promise(function(t){if(0===i.length)return t();var n=void 0;o.callRemoteAction(RemoteActions.getUpdatedAbsences,i,r).then(function(e){n=u.updateTimePhaseData(e,"na").absences;var t=e.map(function(e){return e.Id}),e=i.filter(function(e){return!t.includes(e)});d.drawServicesAndAbsences([],n,e)}).catch(function(e){console.log(e)}).finally(function(){var e=n.filter(function(e){return w.ResourceAbsence.has(e.id)}).map(function(e){return e.resource}).join(",");f=new Set([].concat(_toConsumableArray(f),_toConsumableArray(utils.getRelatedServices([].concat(_toConsumableArray(w.ResourceAbsence)),e)))),t()})})}function W(t){return new Promise(function(e){if(0===t.length)return e();o.getLivePositionsStreaming(t).then(function(e){var t=p.updatePositions(e);t.isUpdated&&k.positions.forEach(function(e){e(t.dic)})}).finally(function(){e()})})}function q(t){return new Promise(function(e){if(0===t.length)return e();o.getUpdatedResourceCapacities(t).then(function(e){e=u.updateTimePhaseData(e,"capacity").capacities;e&&d.drawServicesAndAbsences([],[],[],e)}).catch(function(e){console.log(e)}).finally(function(){e()})})}async function O(i,s){return new Promise(async function(e){if(0===i.length)return e();var t,n;t=i,n=s,await new Promise(function(e){o.callRemoteAction(RemoteActions.getServiceAppointmentIdByTimeDependencyId,t).then(function(e){var t=[];e.forEach(function(e){e=u.serviceAppointments()[e];e&&(e.isServiceInChain=n,t.push(e))}),d.drawServicesAndAbsences(t)}).catch(function(e){console.log(e)}).finally(function(){e()})}).then(function(){}).finally(function(){e()})})}function Z(t){return new Promise(function(e){if(0===t.length)return e();o.getOptimiztionRequestsUpdate(t).then(function(t){k.optimizationRequests.forEach(function(e){e(t)})}).catch(function(e){console.log(e)}).finally(function(){e()})})}async function K(r){return new Promise(async function(e){if(!function(){for(var e in R)if(R[e].length)return 1;return}())return e();var t=r.ServiceAppointment,n=r.ResourceAbsence,i=r.ServiceResourceCapacity,s=[].concat(_toConsumableArray(t),_toConsumableArray(n),_toConsumableArray(i)),s=(d.drawServicesAndAbsences([],[],s),t.forEach(function(e){delete u.serviceAppointments()[e]}),n.forEach(function(e){delete u.resourceAbsences()[e]}),i.forEach(function(e){delete u.resourceCapacities()[e]}),r[I]);s.length&&await O(s,!1),f=new Set([].concat(_toConsumableArray(f),_toConsumableArray(utils.getRelatedServices([].concat(_toConsumableArray(w.ServiceAppointment)))),_toConsumableArray(utils.getRelatedServices([].concat(_toConsumableArray(w.ResourceAbsence)))))),w.ServiceAppointment.clear(),w.ResourceAbsence.clear(),e()})}function M(e){r=e.territories||r;var t=e.services?[].concat(_toConsumableArray(S),_toConsumableArray(e.services)):S,n=e.absences?[].concat(_toConsumableArray(_),_toConsumableArray(e.absences)):_;c.send(JSON.stringify([{messageType:"GANTT_METADATA_CHANGED",messageID:$++,data:{operation:e.operation,serviceTerritories:r,viewStartTime:i.getDeltaDates().minDate,viewEndTime:i.getDeltaDates().maxDate,serviceResources:e.resources,serviceAppointments:t,resourceAbsences:n,shouldGetSAUpdatesOnEmptyTerritories:B.GetUserSettingsProperty("Show_Orphan_Services__c"),shouldGetUpdatesOnServiceResource:!window.isLastKnownFieldsNotAllowed}}])),S=[],_=[]}function E(){c.close()}function Y(e){return new Promise(async function(t,n){await new Promise(function(t,n){o.callRemoteAction(RemoteActions.setConnection).then(function(e){t(e)}).catch(function(e){n(e)})})||n("connection failure"),o.callRemoteAction(RemoteActions.getPushServiceTicketId,e).then(function(e){t(e)}).catch(function(e){n(e)})})}function J(e,t,n){var i=!0,s=!1,r=void 0;try{for(var o,a=n[Symbol.iterator]();!(i=(o=a.next()).done);i=!0){var l,c=o.value;if(L[e].includes(c)){"AssignedResource"===e?(l=t.map(function(e){return u.assignedResourceIdToServiceIdMap[e]}).filter(function(e){return e}),w.ServiceAppointment=new Set([].concat(_toConsumableArray(w.ServiceAppointment),_toConsumableArray(l)))):w[e]=new Set([].concat(_toConsumableArray(w[e]),_toConsumableArray(t)));break}}}catch(e){s=!0,r=e}finally{try{!i&&a.return&&a.return()}finally{if(s)throw r}}}function X(){k.rules.forEach(function(e){e([].concat(_toConsumableArray(f)),window.__gantt.checkRulesAfterDelta)})}function Q(e,t){return"ServiceAppointment"===e&&!x(t,v)||"ResourceAbsence"===e&&!x(t,V)||"ServiceResource"===e&&!x(t,U)||"AssignedResource"===e&&!x(t,T)}function x(e,t){var n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done);n=!0){var a=r.value;if(t.has(a.replace(b+"__","")))return 1}}catch(e){i=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw s}}}function ee(){return new Promise(function(t){for(var i=[],s=[D,R],r=0;r<s.length;r++)!function(){var e=s[r],n=[];e.AssignedResource.forEach(function(e){var t=u.assignedResourceIdToServiceIdMap()[e];t?n.push(t):i.push(e)}),e.ServiceAppointment=[].concat(_toConsumableArray(new Set([].concat(_toConsumableArray(e.ServiceAppointment),n))))}();0<i.length?o.callRemoteAction(RemoteActions.getServiceAppointmentIdByAssignedResourceId,i).then(function(e){Object.entries(e).forEach(function(e){var e=_slicedToArray(e,2),t=e[0],e=e[1];D.AssignedResource.includes(t)&&D.ServiceAppointment.push(e),R.AssignedResource.includes(t)&&R.ServiceAppointment.push(e),u.setAssignedResourceIdToServiceIdMap(t,e)}),M({services:Object.values(e),operation:n.UPDATE}),t()}):t()})}function te(){for(var e in D)D[e]=[];for(var t in R)R[t]=[];for(var n in w)w[n].clear()}function P(e,t){o.callRemoteAction(RemoteActions.WriteErrorToSplunk,e,t)}return N.$on("UserIsIdle",function(){m&&(P("USER_IS_IDLE",""),E())}),{connectToWebSocket:async function t(n){try{h&&(d=a.get("servicesService"),u=a.get("TimePhasedDataService"),p=a.get("LastKnownPositionService"),o.callRemoteAction(RemoteActions.getBaseQueriedFieldsForServiceAppointment).then(function(e){v=new Set([].concat(_toConsumableArray(v),_toConsumableArray(e))),G.serviceAppointmentFields().then(function(e){(v=new Set([].concat(_toConsumableArray(v),_toConsumableArray(e)))).delete("LastModifiedDate")}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)}),await(h=!1));var e=await Y(l.CREATE);if("SUCCESS"!==e.result)throw e.message;window.ticketId=e.ticketID,i=[e.ticketID,e.serverUrl,"wss"],s="{URL}topic/ObjectsChanges/1/ticketId/websocket",(r=["ticketId","{URL}","https"]).forEach(function(e,t){s=s.replace(r[t],i[t])}),(c=new WebSocket(s)).onopen=function(){m=!0,y=(new Date).getTime(),M(n)},c.onmessage=function(e){!async function(e){var t="a"===e.data[0]?JSON.parse(e.data.replace(/^[A-z]/,"")):e.data;if(window.debugMode&&console.log(t),Array.isArray(t))switch(t[0].messageType){case"DEBUG_MESSAGE":z.push({message:t[0].data.message,timestamp:new Date});break;case"GANTT_METADATA_CHANGED":break;case"FALLBACK_TO_DELTA":E(),P("FALLBACK_TO_DELTA","SESSION_TIME: "+(y=(new Date).getTime()-y)+" | ERROR: "+t[0].data.message);break;case"REFRESH_SESSION":try{P("REFRESH_SESSION","");var n=await Y(l.UPDATE);if("FAILED"===n.result)throw P("REFRESH_SESSION - failed to get ticket",n.message),n.message}catch(e){E()}break;case"CHANGE_EVENT":!async function e(t){if(g)A.push(t);else{var n=g=!0,i=!1,s=void 0;try{for(var r,o=t[Symbol.iterator]();!(n=(r=o.next()).done);n=!0){var a=r.value,l=a.data,c=l.entityIDs,d=l.entityName,u=l.changeType,p=l.changedFields;"DELETE"===u?R[d]=[].concat(_toConsumableArray(R[d]),_toConsumableArray(c)):["ServiceAppointment","ResourceAbsence"].includes(d)&&1===p.length&&"LastModifiedDate"===p[0]||"UPDATE"===u&&Q(d,p)||(D[d]=[].concat(_toConsumableArray(D[d]),_toConsumableArray(c)),d in L&&J(d,c,p))}}catch(e){i=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw s}}await ee(),i=[K(R),F(D.ServiceAppointment),j(D.ResourceAbsence),W(D.ServiceResource),q(D.ServiceResourceCapacity),O(D[I],!0),Z(D[C])],Promise.all(i).then(function(){f.size&&(X(),f.clear()),te(),g=!1,(t=A.shift())&&e(t)})}}(t)}}(e)},c.onerror=function(e){console.log("error: "+e),P("ON_ERROR_EVENT",e)},c.onclose=function(){console.log("socket is closed"),m=!1,P("ON_CLOSE_EVENT","")}}catch(e){window.debugMode&&console.log(e),0<H--&&"c2c failure"!=e&&t(n)}var i,s,r},updateSession:M,isPushServiceActive:function(){return m},MESSAGE_OPERATIONS:n,register:function(e,t){return k[e]&&k[e].push(t)},unRegister:function(e,t){k[e].splice(k[e].indexOf(t),1)},setCachedServices:function(e){S=[].concat(_toConsumableArray(S),_toConsumableArray(e))},setCachedAbsences:function(e){_=[].concat(_toConsumableArray(_),_toConsumableArray(e))}}}e.$inject=["$q","sfdcService","$injector","StateService","$rootScope","FieldSetFieldsService","userSettingsManager"],angular.module("serviceExpert").factory("PushServices",e)}(),!function(){function e(r,o,a,e,l,t,c,d){var u=null;function p(){l.setLightBoxStatus(!1),u.$destroy()}function m(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function h(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function g(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function v(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function f(){var e,t,n,i,s=void 0,r=new Date(u.actionStart);(s=new Date(u.actionFinish)).setDate(s.getDate()+1),t=u.optimizeSelectedFilter,e=u.optimizeCalloutSelectedFilter,n=!u.optimizeOnlyUnscheduledServices,i={optimizeOnlyUnscheduledServices:u.optimizeOnlyUnscheduledServices,scheduleOnlyResourceFutureJobs:u.scheduleOnlyResourceFutureJobs,selectedPolicy:u.selectedPolicy,optimizeSelectedFilter:u.optimizeSelectedFilter,optimizeCalloutSelectedFilter:u.optimizeCalloutSelectedFilter},localStorage.setItem(sfdcUser+"_RSO",JSON.stringify(i)),l.setBulkActionRunning(),d.callRemoteAction(RemoteActions.runRDOptimization,u.resource.id,r,s,n,u.scheduleOnlyResourceFutureJobs,u.selectedPolicy.Id,t,e).then(function(e){e?d.callRemoteAction(RemoteActions.getRequestObject,e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?c.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){c.openSObjectLink("../"+e)},e.Id):c.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){c.openSObjectLink("../"+e)},e.Id)}):c.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).catch(function(e){console.warn("runOptimization failed :("),console.log(e),c.addNotification(customLabels.Optimization_Failed,e.message)}).finally(function(){l.setBulkActionRunning(!1)}),u.closeLightbox()}return{open:function(e){(u=o.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)}),u.resource=a.getResources()[e];var e=JSON.parse(localStorage.getItem(sfdcUser+"_RSO"))||{},t=l.selectedPolicyId;e.selectedPolicy&&(t=e.selectedPolicy.Id),u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().min_date.getDate()===scheduler.getState().max_date.getDate()?scheduler.getState().max_date.getDate():scheduler.getState().max_date.getDate()-1,0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=m,u.dateSelectStartWidget=h,u.validateDatesStart=g,u.validateDatesEnd=v,"all"===e.optimizeAllServices?e.optimizeOnlyUnscheduledServices=!1:"unscheduled"===e.optimizeAllServices&&(e.optimizeOnlyUnscheduledServices=!0),u.optimizeOnlyUnscheduledServices=e.optimizeOnlyUnscheduledServices||!1,u.runOptimizion=f,u.checkBoxFields=c.checkBoxFields(),u.optimizeSelectedFilter=e.optimizeSelectedFilter||Object.keys(u.checkBoxFields)[0],u.optimizeCalloutSelectedFilter=e.optimizeCalloutSelectedFilter||Object.keys(u.checkBoxFields)[0],u.scheduleOnlyResourceFutureJobs=null==e.scheduleOnlyResourceFutureJobs||e.scheduleOnlyResourceFutureJobs,u.policyOptions=l.policies;for(var n=0;n<l.policies.length;n++)if(l.policies[n].Id===t){u.selectedPolicy=l.policies[n];break}e='<div id="ResourceToOptimize">'+customLabels.OptimizeTheFollowingResourceDay.replace("$0",'<span class="rdoResourceName">{{resource.name}}</span>').replace("$1",'<button id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></button>').replace("$2",'<button id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></button>')+"</div>",i=customLabels.OptimizeOnlySAsAssignedTo.replace("$0",'<span class="rdoResourceName" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">{{resource.name}}</span>');var i,s=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer rso-lb" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.RDOptimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <div class="bulkOptimizeOptions">\n                                '+e+'\n                            </div>\n   \n                            <div class="bulkOptimizeOptionsContainer">\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.Only_optimize_unscheduled_appointments+"\n                                        <cs-tooltip>"+customLabels.Only_optimize_unscheduled_appointments_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <input ng-model="optimizeOnlyUnscheduledServices" type="checkbox" name="optimizeAllServices" id="optimizeAllServices" />\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.SchedulingPolicyName+"\n                                        <cs-tooltip>"+customLabels.rso_scheduling_policy_tooltip+'</cs-tooltip>\n\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions">\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeFilterText+"\n                                        <cs-tooltip>"+customLabels.rso_filter_services_by_tooltip+'</cs-tooltip>\n\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeKeepTheFollowingSAsScheduled+"\n                                        <cs-tooltip>"+customLabels.OptimizeKeepTheFollowingSAsScheduled_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeCalloutSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                         </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">\n                                        '+i+"\n                                        <cs-tooltip>"+customLabels.OptimizeOnlySAsAssignedTo_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <input ng-model="scheduleOnlyResourceFutureJobs" type="checkbox" name="scheduleOnlyResourceFutureSa" id="scheduleOnlyResourceFutureSa" />\n                                    </div>\n                                </div>\n\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <button class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</button>\n                        </div>\n\n\n                    </div>\n                </div>\n            ");s.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(s),u.closeLightbox=p,u.$on("$destroy",function(){return s.remove()}),r(s)(u),s.show(),l.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("rdOptimizeLightboxService",e)}(),!function(){function e(n,i,s){return{register:function(e,t){n.register(e,t),i.register(e,t),"positions"!==e&&"optimizationRequests"!==e&&"rules"!==e||s.register(e,t)},unRegister:function(e,t){n.unRegister(e,t),i.unRegister(e,t),"positions"!==e&&"optimizationRequests"!==e&&"rules"!==e||s.unRegister(e,t)}}}e.$inject=["DeltaService","StreamingAPIService","PushServices"],angular.module("serviceExpert").factory("RegisterService",e)}(),angular.module("serviceExpert").factory("ResourceCapacitiesService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(c,d,e,u,p){var m={};return e.$on("gotNewTimePhasedObjects",function(e,t){if(p.areContractorsSupported()&&t.resourcesAndTerritories&&Object.keys(t.resourcesAndTerritories).length)for(var n=t.start,i=t.finish,s=new Date(n),r=null;s<i;){var o=u.formatDayToString(s);if(!m[o]){m[o]=!0,r=r||function(){for(var e=[],t=d.resourcesAndTerritories(),n=c.getCapacityBasedResources(),i=0;i<=n.length;i++){var s,r=n[i],o=t[r];for(s in o){var a=o[s];e.push(u.generateResourceId(r,a.serviceTerritory))}}return e}();var a=new Date(s);a.setDate(a.getDate()+1);for(var l=0;l<=r.length;l++)!function(e,t,n){if(e.getTime()!==t.getTime()){var i,s={};for(i in scheduler.matrix)s[i]=[n];scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:s,css:"capacityPattern"})}}(new Date(s),new Date(a),r[l])}s.setDate(s.getDate()+1)}}),{reset:function(){m={}}}}]),angular.module("serviceExpert").factory("ResourceCrewsService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(e,d,t,M,u){var p={};function E(e,t,n,i,s,r){var o=n.territoriesByType[s];if(void 0!==o&&(showSecondarySTMs||"R"===s))for(var a=0;a<o.length;a++){var l,c,d=o[a],u=useLocationTimezone?d.operatingHours.TimeZone:userTimeZone,p=useLocationTimezone?(l=P(d.start,d.operatingHours.TimeZone,u),P(d.finish,d.operatingHours.TimeZone,u)):(l=d.start,d.finish),p=M.intersectDates({start:l,finish:p},{start:e,finish:t}).intersection;null!==p&&(c=P(n.member.startDate,"GMT",u),u=P(n.member.endDate,"GMT",u),null!==(p=M.intersectDates({start:p.start,finish:p.finish},{start:c,finish:u}).intersection))&&x(p.start,p.finish,d.sectionsToDraw,"crewMember",i,"crewLabelStyle",r)}}function x(e,t,n,i,s,r,o){o="background: "+(o=o||"#a99be8")+"90; box-shadow: 0 0 0 1px "+o;scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:n.daily,css:i,html:'<div class="'+r+'" title="'+escapeHTML(s)+'" style="'+o+'">\n                            <svg aria-hidden="true" class="slds-icon relocationIcon">\n                                <use xlink:href="'+lsdIcons.crewMember+'"></use>\n                            </svg>\n                            '+escapeHTML(s)+"\n                          </div>"}),scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:n.monthly,html:'<div class="crewUtilizBox" title="'+escapeHTML(s)+'" style="'+o+'">\n                    <svg aria-hidden="true" class="slds-icon relocationIcon">\n                    <use xlink:href="'+lsdIcons.crewMember+'"></use>\n                    </svg></div>',css:"crewmember_monthly"})}function P(e,t,n){return M.convertDateBetweenTimeZones(e,t,n)}return t.$on("gotNewTimePhasedObjects",function(e,t){if(u.areCrewsSupported()&&t.serviceCrewMembers&&Object.keys(t.serviceCrewMembers).length)for(var n=t.start,i=t.finish,s=t,r=new Date(n),o=void 0;r<i;){var a=M.formatDayToString(r);if(!p[a]){void 0===o&&(o=function(e){var t,n={},i=d.resourcesAndTerritories();for(t in e){void 0===n[t]&&(n[t]={},n[t].territoriesByType={},n[t].member=e[t]);var s,r=i[e[t].serviceResource];for(s in r){var o=r[s],a=M.generateResourceId(e[t].serviceResource,o.serviceTerritory);void 0===n[t].territoriesByType[o.serviceTerritoryType]&&(n[t].territoriesByType[o.serviceTerritoryType]=[]),n[t].territoriesByType[o.serviceTerritoryType].push({start:o.effectiveStartDate,finish:o.effectiveEndDate,serviceTerritory:o.serviceTerritory,operatingHours:o.serviceTerritory__r.OperatingHours,type:o.serviceTerritoryType,id:o.id,section:a,sectionsToDraw:function(e){var t,n={monthly:{},daily:{}};for(t in scheduler.matrix)"MonthlyView"===t||"MTDView"===t||"LongView"===t?n.monthly[t]=[e]:n.daily[t]=[e];return n}(a)})}void 0!==n[t].territoriesByType.P&&n[t].territoriesByType.P.sort(M.sortByTime),void 0!==n[t].territoriesByType.R&&n[t].territoriesByType.R.sort(M.sortByTime),void 0!==n[t].territoriesByType.S&&n[t].territoriesByType.S.sort(M.sortByTime)}return n}(s.serviceCrewMembers)),p[a]=!0;var l,c=new Date(r);for(l in c.setDate(c.getDate()+1),o)!function(e,t,n){var i,s;if(e.getTime()!==t.getTime()){i=n.member.ganttLabel?n.member.ganttLabel.encodeHTML():customLabels.XCrewMember.replaceAll(n.member.serviceCrew__r.Name.encodeHTML()),s=n.member&&n.member.ganttColor||null,E(e,t,n,i,"S",s),E(e,t,n,i,"R",s);var r=e,o=t,a=n,l=i,c=s,d=a.territoriesByType.P,u=a.territoriesByType.R;if(void 0===u){var p=r,m=o,h=a,g=l,v=c,f=h.territoriesByType.P;if(void 0!==f)for(var S=0;S<f.length;S++){var _=f[S],b=useLocationTimezone?_.operatingHours.TimeZone:userTimeZone,y=P(h.member.startDate,"GMT",b),b=P(h.member.endDate,"GMT",b),y=M.intersectDates({start:p,finish:m},{start:y,finish:b}).intersection;null!==y&&null!==(b=M.intersectDates({start:_.start,finish:_.finish},{start:y.start,finish:y.finish}).intersection)&&x(b.start,b.finish,_.sectionsToDraw,"crewMember",g,"crewLabelStyle",v)}}else if(void 0!==d)for(var w=0;w<d.length;w++){var T=!1,L=d[w],A=useLocationTimezone?L.operatingHours.TimeZone:userTimeZone,I=P(a.member.startDate,"GMT",A),C=P(a.member.endDate,"GMT",A),I=M.intersectDates({start:I,finish:C},{start:r,finish:o}).intersection;if(null!==I){var k=M.intersectDates({start:L.start,finish:L.finish},{start:I.start,finish:I.finish}).intersection;if(null!==k){for(var D=0;D<u.length;D++){var R=u[D],F=useLocationTimezone?R.operatingHours.TimeZone:userTimeZone,O=P(R.start,F,A),R=P(R.finish,F,A),F=M.intersectDates({start:O,finish:R},{start:r,finish:o}).intersection;null!==F&&null!==(O=M.intersectDates({start:F.start,finish:F.finish},{start:k.start,finish:k.finish}).intersection)&&(!function(e,t,n,i,s){t.start.getTime()<e.start.getTime()&&x(t.start,e.start,n,"crewMember",i,"crewLabelStyle",s);e.finish.getTime()<t.finish.getTime()&&x(e.finish,t.finish,n,"crewMember",i,"crewLabelStyle",s)}(O,k,L.sectionsToDraw,l,c),T=!0)}T||null===k||x(k.start,k.finish,L.sectionsToDraw,"crewMember",l,"crewLabelStyle",c)}}}}}(new Date(r),new Date(c),o[l])}r.setDate(r.getDate()+1)}}),{reset:function(){p={}}}}]),angular.module("serviceExpert").factory("resourceFilterHelper",["$q","sfdcService","$sce","userSettingsManager",function(e,n,t,i){var s={sortBy:customLabels.name,asc:!0,showWorkingResource:!1,booleanFields:{},picklistField:"select_a_field",picklistOptions:[],picklistOptionsModel:[],picklistNullValues:!1,crewsOption:customLabels.showAll},r=JSON.parse(i.GetUserSettingsProperty("Resource_Filter__c"))||s,o=null,a=null,l={selectedPicklist:r.picklistField,resourceFilteringOptions:r.booleanFields,picklistOptionsModel:r.picklistOptionsModel,picklistOptions:r.picklistOptions,picklistNullValues:r.picklistNullValues,crewsSelectionOptions:{selectedPicklist:r.crewsOption,crewFilteringOptions:[customLabels.showAll,customLabels.hideCrewMembers,customLabels.showCrewsAndCrewMembers,customLabels.showOnlyCrews,customLabels.hideCrewsAndCrewMembers]}};function c(e){var t,n="",i="",s=customLabels.SelectAfieldToResourceFilter,r=(e&&(n="<b>"+customLabels.CurrentlyWorking+"</b>"),l.picklistOptions.map(function(e){return e&&e.encodeHTML()}));for(t in o)"BOOLEAN"===o[t][1]&&l.resourceFilteringOptions[o[t][2]]?""===n?n="<b>"+o[t][0].encodeHTML()+"</b>":n+=" "+customLabels.and+" <b>"+o[t][0].encodeHTML()+"</b>":"PICKLIST"===o[t][1]&&l.selectedPicklist===o[t][2]&&(0<(i=r.join("</b> "+customLabels.or+" <b>")).length&&(i="<b>"+o[t][0].encodeHTML()+"</b> is <b>"+i+"</b>"),l.picklistNullValues)&&(""===i?i="<b>"+customLabels.None+"</b>":i+=" "+customLabels.or+" <b>"+customLabels.None+"</b>");return""!==n&&""!==i?s=customLabels.Resources_That_Are_x_and_y.replaceAll(n,i):""===n&&""!==i?s=customLabels.Resources_That_Are_x.replaceAll(i):""!==n&&""==i&&(s=customLabels.Resources_That_Are_x.replaceAll(n)),s}return n.callRemoteAction(RemoteActions.getResourceFieldSetFields).then(function(e){for(var t in(o=e).Name=[customLabels.name,"STRING","Name"],o)"BOOLEAN"===o[t][1]&&(l.resourceFilteringOptions[t]=r.booleanFields[t]);monthlyViewSettings.isMonthlyAvailable&&(o.__Utilization__=[customLabels.AggregatedUtilization,"UTILIZATION","__Utilization__"])}).then(function(){var e,t=[];for(e in o)"PICKLIST"===o[e][1]&&t.push(e);n.callRemoteAction(RemoteActions.getResourcePicklistValues,t).then(function(e){a=e,$("#resourceExplainCrap").html(c(r.showWorkingResource))})}),{getResourceFieldset:function(){return o},getCrewFilteringOptions:function(){return l.crewsSelectionOptions.crewFilteringOptions},getPicklistNames:function(){return a},selectionInfo:l,updateSelectedPicklist:function(e,t){var n=l.picklistOptions.indexOf(e);-1===n?l.picklistOptions.push(e):l.picklistOptions.splice(n,1)},resetFilter:function(){for(var e in l.selectedPicklist="select_a_field",l.length=0,l.picklistOptions.length=0,l.picklistNullValues=!1,l.resourceFilteringOptions)l.resourceFilteringOptions[e]=!1},setAll:function(){for(var e in l.resourceFilteringOptions)l.resourceFilteringOptions[e]=!0},generateFilterExplanation:c,isResourceFilterApplied:function(){if(l.selectedPicklist&&(l.picklistOptions.length||l.picklistNullValues))return!0;for(var e in l.resourceFilteringOptions)if(l.resourceFilteringOptions[e])return!0;return!1},resourceFieldToSortyBy:r.sortBy,resourceCrewFilter:l.crewsSelectionOptions.selectedPicklist,resourceCrewDefaultFilter:customLabels.showAll,descending:r.asc,showWorkingResource:r.showWorkingResource}}]),!function(){function e(o,m,a,l,c,d,u,p,e,h,g,v,f,S){var _=null;function b(){_.killWatch&&_.killWatch(),d.setLightBoxStatus(!1),_.$destroy(),_=null}function y(e){if(e.ganttColor)return e.ganttColor;switch(e.statusCategory){case h.NONE:return"#a5e2d6";case h.SCHEDULED:return"#F9D058";case h.DISPATCHED:return"#8DD8FA";case h.IN_PROGRESS:return"#D68EF9";case h.COMPLETED:return"#95D055";case h.COULD_NOT_COMPLETE:return"#f58556";case h.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}}function w(e){e!==_.selectedTab&&(_.selectedTab=e)}function T(e){_.currentlyShowingOnMap=e.id;e=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);_.map.setCenter(e),_.map.setZoom(13)}function L(){_.bounds.isEmpty()||_.map.fitBounds(_.bounds),_.currentlyShowingOnMap=null}function A(){$("#mapCarouselWrapper").slideToggle("slow",function(){}),_.showSideRoute=!_.showSideRoute}function I(e){var t=Math.floor(e/60/60),e=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+e+customLabels.kpi_m}function C(){return(_.isDaily?customLabels.KPIsAreCalculatedFrom:customLabels.KPIsAreCalculatedFromTo).replaceAll(moment(scheduler._min_date).format("ll"),moment(scheduler._max_date).format("ll"))}function k(e){return e?moment(e).format("LT"):null}function D(e,t){return""===e||""===t?"":customLabels.Between_x_and_y.replaceAll(moment(e).format("ll"),moment(t).format("ll"))}function R(e){var t=M(),n=(__gantt.isO2EngineOn,t.serviceTerritory),i=__gantt.isO2ForAllTerritoriesOn,i=(n&&!i&&m.territories()[n].o2Enabled,_.resourceSLRPath={stroke:{weight:2,color:"#16325C"},path:[],geodesic:!0,toggle:!0},_.polyLinePath={path:[],geodesic:_.resourceSLRPath.geodesic,strokeColor:_.resourceSLRPath.stroke.color,strokeWeight:_.resourceSLRPath.stroke.weight,strokeOpacity:1},_.markersArray=[],_.bounds=new google.maps.LatLngBounds,_.resourceServices=function(e,t){var n=_.resourceServicesDate,i=new Date(n),s=(i.setHours(24,0,0,0),scheduler.getEvents(n,i));{var r;if("multi-route"!=e||null==t)return r=s.filter(function(e){return-1<e.resourceId.indexOf(_.terMemberKey)&&e.latitude&&("service"===e.type||_.showAbsencesOnMap&&"na"===e.type)}).sort(function(e,t){return e.start.getTime()-t.start.getTime()});var o,a={};for(o in t)!function(t){r=s.filter(function(e){return-1<e.resourceId.indexOf(t)&&e.latitude&&("service"===e.type||_.showAbsencesOnMap&&"na"===e.type)}).sort(function(e,t){return e.start.getTime()-t.start.getTime()}),a[t]=r}(o);return a}}(),{}),n=(t&&(t.latitude?i={latitude:t.latitude,longitude:t.longitude}:(n=m.territories()[t.serviceTerritory]).latitude&&(i={latitude:n.latitude,longitude:n.longitude})),null);i.latitude?(_.markersArray.push({id:t.serviceResource,type:"resource",coords:i,markerOptions:{icon:staticResources.homebase_png},resourceName:_.lightboxResource.name}),n=new google.maps.LatLng(i.latitude,i.longitude),_.polyLinePath.path.push(n),_.bounds.extend(n)):_.noHomeBase=!0;for(var s=0;s<_.resourceServices.length;s++){var r,o=_.resourceServices[s];o.latitude&&(_.showServices&&(r="service"===o.type?staticResources.service_png:staticResources.resource_absence_icon,r={id:o.id,type:o.type,coords:{latitude:o.latitude,longitude:o.longitude},markerOptions:{icon:r,labelContent:"<span>"+(s+1)+"</span>"+moment(o.start).format("LT"),labelClass:"ResourceMapServiceMarkerLabel",zIndex:200},item:o},_.markersArray.push(r)),r=new google.maps.LatLng(o.latitude,o.longitude),_.bounds.extend(r),_.resourceSLRPath.path.push({location:r,stopover:!0}),_.polyLinePath.path.push(r))}if(i.latitude&&_.polyLinePath.path.push(n),!e){if(_.showRoute)allowStreetLevelRouting&&0<_.resourceSLRPath.path.length?((i={})[((e={})[t.serviceResource]=t).serviceResource]=_.resourceServices.filter(function(e){return!e.isOffsiteAppointment}),t={origin:n||_.resourceSLRPath.path[0].location,destination:n||_.resourceSLRPath.path[_.resourceSLRPath.path.length-1].location,waypoints:_.resourceSLRPath.path},_.calloutFailures=0,function i(d,u,e){var t=__gantt.isO2EngineOn;var n=M().serviceTerritory;var s=__gantt.isO2ForAllTerritoriesOn;n&&!s&&(s=m.territories()[n].o2Enabled);if(t&&s){var v=function(e,t,n){null!=e&&console.log("ERROR -> "+e),_.calloutFailures++,1==_.calloutFailures?i(_.O2Parameters.resourceMap,_.O2Parameters.resourceServicesMap,_.O2Parameters.googlePolylineProp):(e=!1,null!=t&&("Route request with unsupported region"===t?window.alert(customLabels.O2UnsupportedRegionMessage):"NoRoute"===t?(t=null!=n?n:"",window.alert(customLabels.O2LocationsIsNotAccessible+" "+t)):e=!0),e&&window.alert(customLabels.O2Failed))},n=function(){for(var e in u){var t,n=null,i=null,s=null,r=null;d[e].latitude?(n=d[e].latitude,i=d[e].longitude,s=d[e].latitude,r=d[e].longitude):(t=m.territories()[d[e].serviceTerritory]).latitude&&(n=t.latitude,i=t.longitude,s=t.latitude,r=t.longitude),null==n&&null==i&&(n=u[e][0].latitude,i=u[e][0].longitude),null==s&&null==r&&(s=u[e][u[e].length-1].latitude,r=u[e][u[e].length-1].longitude),c(n,i);for(var o=0;o<u[e].length;o++){var a=u[e][o].latitude,l=u[e][o].longitude;c(a,l)}c(s,r)}function c(e,t){p.push({lat:e,lng:t})}},r=function(){for(var e in u)return{travel_profile:"car",vehicle_id:e}},o=(_.O2Parameters.resourceMap=d,_.O2Parameters.resourceServicesMap=u,_.O2Parameters.googlePolylineProp=e,_.drivingProfile={image:"",type:"",tolls:"",hazmat:""},[]),p=[],a=[],l=0;n();for(var c=0;c<p.length;c++)a.push(p[c]),c===p.length-1||1===l?(c===p.length-1&&1===a.length&&a.push(p[c]),o.push({locations:[].concat(_toConsumableArray(a)),overview:"full",vehicle:r()}),a=[],l=0,c!==p.length-1&&(a.push(p[c]),l++)):l++;t={routes:o};Visualforce.remoting.Manager.invokeAction(RemoteActions.getO2Polyline,JSON.stringify(t),moment(_.resourceServicesDate).format(),function(e,t){if(_.showRoute)if(200==t.statusCode&&"exception"!=t.type)if(null!=e.results){var n=e.results.results;if(null!=n){for(var i=0;i<_.O2PolyLineArray.length;i++)_.O2PolyLineArray[i].setMap(null);_.O2PolyLineArray=[];for(var s=0;s<n.length;s++)if("Ok"==n[s].code)for(var r=0;r<n[s].routes.length;r++){var o=n[s].routes[r],a=[],o={overview_polyline:{points:o.geometry}};null!=google.maps.geometry?a.push.apply(a,_toConsumableArray(google.maps.geometry.encoding.decodePath(o.overview_polyline.points))):v();for(var l=0;l<a.length;l++)_.bounds.extend(a[l]);o=new google.maps.Polyline({path:a,strokeColor:"#0088FF",strokeOpacity:.55,strokeWeight:6,fillColor:"#0088FF",map:_.map});_.O2PolyLineArray.push(o);for(var c=0;c<_.O2PolyLineArray.length;c++)_.O2PolyLineArray[c].setMap(_.map);_.map.fitBounds(_.bounds);for(var d=0;d<e.travelProfiles.length;d++){var u=e.travelProfiles[d],p=u.transportType;_.drivingProfile.type=p,null!=u.transportTypeLabel&&null!=u.transportTypeLabel?_.drivingProfile.type=u.transportTypeLabel:"Car"==p&&(_.drivingProfile.type=customLabels.Travel_Profile_Type_Car),_.drivingProfile.image=_.transportTypeToStaticResource[p],_.drivingProfile.tolls=1==u.canUseTollRoads?customLabels.Travel_Profile_Allowed_Value:customLabels.Travel_Profile_Not_Allowed_Value,_.drivingProfile.hazmat=1==u.isTransportingHazmat?customLabels.Travel_Profile_Allowed_Value:customLabels.Travel_Profile_Not_Allowed_Value}}else{var m,h=null;"Ok"!=n[s].code&&(h=n[s].code),"NoRoute"==n[s].code?((m=null)!=e.travelProfiles[0]&&null!=e.travelProfiles[0].transportType&&(m=null!=e.travelProfiles[0].transportTypeLabel&&null!=e.travelProfiles[0].transportTypeLabel?e.travelProfiles[0].transportTypeLabel:e.travelProfiles[0].transportType),v(h,n[s].code,m)):v(h)}}else{var g=null;null!=e.results.message&&(g=e.results.message),"Route request with unsupported region"==e.results.message?v(g,e.results.message):v(g)}}else{g=null;null!=e.results.message&&(g=e.results.message),v(g)}else{g=null;null!=t.message&&(g=t.message),v(g)}})}else O(e)}(e,i,t)):F();else{_.polyLineGoogleObj?_.polyLineGoogleObj.setMap(null):_.directionsDisplay&&_.directionsDisplay.setMap(null);for(var a=0;a<_.O2PolyLineArray.length;a++)_.O2PolyLineArray[a].setMap(null);_.O2PolyLineArray=[]}n=new google.maps.LatLng(37.794024,-122.394837);_.bounds.isEmpty()?_.map.setCenter(n):_.map.fitBounds(_.bounds)}var l,c=_.lightboxResource.id,d=g.lastKnownPositions();for(l in d)if(c===l){u=void 0;p=void 0;var u=d[l];var p=m.getResources()[u.id],u={id:u.id+"_position",markerOptions:{icon:staticResources.livepos_png},type:"lastKnownPosition",resourceId:u.id,coords:{latitude:u.latitude,longitude:u.longitude},item:angular.extend(angular.copy(u),{resourceName:p.name})};"lastKnownPosition"===u.type&&(window.customPermissions.Hide_Live_Locations_Resource_Map_Layer||isLastKnownFieldsNotAllowed)||_.markersArray.push(u)}}function F(){_.directionsDisplay&&(_.directionsDisplay.setMap(null),_.directionsDisplay=null),_.polyLineGoogleObj&&_.polyLineGoogleObj.setMap(null),_.polyLineGoogleObj=new google.maps.Polyline(_.polyLinePath),_.polyLineGoogleObj.setMap(_.map)}function O(e){var t=null,n=(null!=__gantt&&null!=__gantt&&null!=__gantt.CustomSettingsGeocode&&null!=__gantt.CustomSettingsGeocode&&null!=__gantt.CustomSettingsGeocode.p2pEnabled&&null!=__gantt.CustomSettingsGeocode.p2pEnabled&&(t=__gantt.CustomSettingsGeocode.p2pEnabled),!0),i=customLabels.Travel_Profile_Not_Allowed_Value;1==t&&(i=customLabels.Travel_Profile_Allowed_Value,n=!1),_.drivingProfile.type=customLabels.Travel_Profile_Type_Car,_.drivingProfile.image=staticResources.car_svg,_.drivingProfile.tolls=i,_.drivingProfile.hazmat=customLabels.Travel_Profile_Not_Allowed_Value,(new google.maps.DirectionsService).route({origin:e.origin,destination:e.destination,waypoints:e.waypoints,travelMode:google.maps.TravelMode.DRIVING,avoidTolls:n},function(e,t){t===google.maps.DirectionsStatus.OK?(_.polyLineGoogleObj&&(_.polyLineGoogleObj.setMap(null),_.polyLineGoogleObj=null),_.directionsDisplay||(_.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0})),_.directionsDisplay.setMap(_.map),_.directionsDisplay.setDirections(e)):(window.alert("Directions request failed due to "+t),F())})}function M(e){var t,n=null,i=_.resourceServicesDate,s=new Date(i),r=(s.setHours(24,0,0,0),u.resourcesAndTerritories());for(t in r){var o,a=r[t];for(o in a){var l=a[o];if("multi-route"==e)null==n&&(n={}),isIntersect(i,s,l.effectiveStartDate,l.effectiveEndDate)&&(n[t]=l);else if(-1<_.terMemberKey.indexOf(c.generateResourceId(l.serviceResource,l.serviceTerritory))&&isIntersect(i,s,l.effectiveStartDate,l.effectiveEndDate))return l}}return n}function E(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"resourceServicesDateStart",date:new Date(_.resourceServicesDate),navigation:!0,handler:function(e,t){_.$apply(function(){_.resourceServicesDate=e,_.generateMarkersAndRoute(),_.isLastKnownFieldsAllowedPermission()&&f.callRemoteAction(RemoteActions.getResourceActualRoute,_.lightboxResource.id,e).then(P)}),scheduler.destroyCalendar()}})}function x(e){_.resourceServicesDate.setDate(_.resourceServicesDate.getDate()+e),_.generateMarkersAndRoute(),_.isLastKnownFieldsAllowedPermission()&&f.callRemoteAction(RemoteActions.getResourceActualRoute,_.lightboxResource.id,_.resourceServicesDate).then(P)}function P(e){_.actualRoute&&(_.actualRoute.visible=!1,_.actualRoute.setMap(_.map));var t,n={},i=[];for(t in e.forEach(function(e){"LastKnownLatitude"!==e.Field&&"LastKnownLongitude"!==e.Field||(n[e.CreatedDate]=n[e.CreatedDate]||{},n[e.CreatedDate][-1<e.Field.indexOf("Long")?"lng":"lat"]=e.NewValue,n[e.CreatedDate].date=e.CreatedDate)}),n)n[t].lng&&n[t].lat&&i.push(n[t]);_.actualRoute=new google.maps.Polyline({path:i,geodesic:!0,strokeColor:"#ff73bf",strokeOpacity:1,strokeWeight:3}),_.isLastKnownFieldsAllowedPermission()&&_.showActual&&_.actualRoute.setMap(_.map)}function N(){_.isLastKnownFieldsAllowedPermission()&&_.actualRoute&&(_.actualRoute.visible=_.showActual,_.actualRoute.setMap(_.map))}function G(e){for(var t,n=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),i=[],s=[],r=0;r<n.length;r++)n[r].resource==e&&"contractorcapacity"==n[r].type&&("Week"==n[r].timePeriod&&i.push(n[r]),"Month"==n[r].timePeriod)&&s.push(n[r]);_.donutCharts=(t={segmentShowStroke:!1,segmentStrokeColor:"#fff",segmentStrokeWidth:2,percentageInnerCutout:75,animation:!0,animationSteps:100,animationEasing:"easeOutSine",animateRotate:!0,animateScale:!1,showTooltips:!0},{labels:[customLabels.Hours_Used,customLabels.Hours_Available],weekly:{data:[],percentage:"",start:"",end:"",show:!1,options:t},monthly:{data:[],percentage:"",start:"",end:"",show:!1,options:t}}),setTimeout(function(){var e,t=i[0],n=s[0];t?((e=t.hoursPerTimePeriod-t.hoursInUse)<0&&(e=0),_.donutCharts.weekly.data=[t.hoursInUse,e],_.donutCharts.weekly.percentage=B(t.hoursInUse,t.hoursPerTimePeriod)+"%",_.donutCharts.weekly.start=t.start_date,_.donutCharts.weekly.end=t.end_date,_.donutCharts.weekly.show=!0):(_.donutCharts.weekly.data=[0,10],_.donutCharts.weekly.show=!1,_.donutCharts.weekly.options.showTooltips=!1,_.donutCharts.weekly.start=_.kpiStart,_.donutCharts.weekly.end=_.kpiEnd),n?((e=n.hoursPerTimePeriod-n.hoursInUse)<0&&(e=0),_.donutCharts.monthly.data=[n.hoursInUse,e],_.donutCharts.monthly.percentage=B(n.hoursInUse,n.hoursPerTimePeriod)+"%",_.donutCharts.monthly.start=n.start_date,_.donutCharts.monthly.end=n.end_date,_.donutCharts.monthly.show=!0):(_.donutCharts.monthly.data=[0,10],_.donutCharts.monthly.show=!1,_.donutCharts.monthly.options.showTooltips=!1,_.donutCharts.monthly.start=scheduler.getState().min_date,_.donutCharts.monthly.end=scheduler.getState().max_date)},1e3)}function B(e,t){return parseFloat((e/t*100).toFixed(2))}function H(){p(function(){_.actualRoute&&_.actualRoute.setMap(_.map)},500)}return{open:function(e,t){if(!_){(_=o.$new(!0)).lightboxResource=m.getResources()[e],_.terMemberKey=t||u.getResoruceGanttIdByDate(e,scheduler.getState().min_date),_.selectedTab="details";var t="vf079_ResourceCalendar?id=",n=(__gantt.communityNetworkId&&""!==__gantt.communityNetworkId&&fslNamespace&&""!==fslNamespace&&(t=fslNamespace+"__vf079_ResourceCalendar?id="),_.urls={related:a.trustAsResourceUrl(customResourceRelatedListLightboxPage+"?id="+e+"&isdtp=p1").toString(),chatter:a.trustAsResourceUrl(customResourceChatter+"?id="+e).toString(),details:a.trustAsResourceUrl(customResourceLightboxPage+"?id="+e).toString(),calendar:a.trustAsResourceUrl(t+e).toString()},_.urls.custom1=CustomResourceTab1?a.trustAsResourceUrl(CustomResourceTab1+"?id="+e).toString():null,_.urls.custom2=CustomResourceTab2?a.trustAsResourceUrl(CustomResourceTab2+"?id="+e).toString():null,_.changeTab=w,_.closeLightbox=b,_.chatterAvailable=fieldTrackingEnabled.resource,_.formatTravel=I,_.openConsoleTab=c.openConsoleTab,_.formatKpitText=C,_.formatDateToTime=k,_.formatCapacityKpitText=D,_.getContractorCapacityStatus=G,_.isMapEnabled=d.isMapEnabled(),_.contractorSupport=d.areContractorsSupported(),_.isDaily="ZoomLevel3"==scheduler._mode,_.actualRoute=null,_.showActual=!0,_.toggleShowRoute=N,_.toggleActualVisibilityWhenMapTabClicked=H,_.boundOnCaruselItem=T,_.showSideRoute=!0,_.zoomOutToFitAll=L,_.slideToggle=A,_.currentlyShowingOnMap=null,_.changeDate=x,_.getColorByStatus=y,_.showAbsencesOnMap=window.showAbsencesOnMap,_.hideActulRoute=window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map,_.O2PolyLineArray=[],_.calloutFailures=0,_.allowStreetLevelRouting=window.allowStreetLevelRouting,_.drivingProfile={image:"",type:"",tolls:"",hazmat:""},_.transportTypeToStaticResource={Car:staticResources.car_svg,"Light Truck":staticResources.light_truck_svg,"Heavy Truck":staticResources.heavy_truck_svg,Bicycle:staticResources.bicycle_svg,Walking:staticResources.pedestrian_svg},_.O2Parameters={resourceMap:null,resourceServicesMap:null,googlePolylineProp:null},_.hideActulRoute=window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map||isLastKnownFieldsNotAllowed,Chart.defaults.global.colours=["#16325c","#DCDCDC","#F7464A","#46BFBD","#FDB45C","#949FB1","#4D5360"],_.donutCharts=null,_.isLastKnownFieldsAllowedPermission=function(){return!(window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map||isLastKnownFieldsNotAllowed)},_.haveItemsToShowOnSideRoute=function(e){for(var t=0;t<e.length;t++)if("na"===e[t].type||"service"===e[t].type)return!0;return!1},_.isMapEnabled&&(_.getServiceInfoRowClass=c.getServiceInfoRowClass,_.firstMapShow=!0,_.showRoute=!0,_.showTrafficLayer=!1,_.showServices=!0,_.mapControl={},_.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER},fullscreenControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}},_.serviceInfoWindow={show:!1},_.livePosInfoWindow={show:!1},_.resourceInfoWindow={show:!1},_.absenceInfoWindow={show:!1},_.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},absence:{pixelOffset:new google.maps.Size(0,-38)}},_.resourceServicesDate=scheduler.getState().min_date,_.markersArray=[],v.fieldsSetFields().then(function(e){_.serviceFields=e.MapInfo}),_.killWatch=_.$watch("selectedTab",function(e){"map"==e&&p(function(){var e,t;_.map=_.mapControl.getGMap(),google.maps.event.trigger(_.map,"resize"),_.firstMapShow&&(_.firstMapShow=!1,e=_.map.getStreetView(),t={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}},e.setOptions(t),_.firstMapShow=!1,_.generateMarkersAndRoute())},0)}),_.generateMarkersAndRoute=R,_.openDatePicker=E,_.routeToggled=function(){_.generateMarkersAndRoute();var e=_.showRoute?_.map:null;_.polyLineGoogleObj&&_.polyLineGoogleObj.setMap(e),_.directionsDisplay&&_.directionsDisplay.setMap(e)},_.markerClicked=function(e,t,n){var i=n.type;switch(_.serviceInfoWindow.show=!1,_.absenceInfoWindow.show=!1,_.livePosInfoWindow.show=!1,_.resourceInfoWindow.show=!1,_.currentMarker=n,i){case"service":_.serviceInfoWindow.show=!0;break;case"lastKnownPosition":_.livePosInfoWindow.show=!0;break;case"resource":_.resourceInfoWindow.show=!0;break;case"na":case"break":_.absenceInfoWindow.show=!0}p(function(){_.$apply(),c.setMapCloseButtonPosition()},0)},_.markerCloseClicked=function(){_.serviceInfoWindow.show=!1,_.livePosInfoWindow.show=!1,_.absenceInfoWindow={show:!1},_.resourceInfoWindow.show=!1,_.$apply()},_.openFieldSetLink=function(e,t){c.openLink(e,t)},_.openLink=function(e){c.openSObjectLink(e)}),e),i=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date);_.resourceKpi={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};for(var s=0;s<i.length;s++)i[s].resource==n&&("na"===i[s].type&&(_.resourceKpi.avgTravelTime+=i[s].travelTo+i[s].travelFrom),"service"===i[s].type)&&(_.resourceKpi.total++,i[s].statusCategory==h.COMPLETED&&_.resourceKpi.completed++,i[s].violations&&_.resourceKpi.violations++,i[s].jeopardy&&_.resourceKpi.jeopardy++,_.resourceKpi.avgTravelTime+=i[s].travelTo+i[s].travelFrom,i[s].start_date)&&i[s].end_date&&(_.resourceKpi.totalScheduledDuration+=(i[s].finish-i[s].start)/1e3);0<i.length&&0<_.resourceKpi.total?_.resourceKpi.avgTravelTime=Math.floor(_.resourceKpi.avgTravelTime/60/_.resourceKpi.total):_.resourceKpi.avgTravelTime=0,G(e);var r=angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="ResourceLightboxHeader">\n                            <svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                <use xlink:href="'+lsdIcons.close+'"></use>\n                            </svg>\n                            <img ng-show="lightboxResource.pictureLink" class="resourcePhotoLightbox" ng-src="{{ lightboxResource.pictureLink }}" alt="{{ lightboxResource.name }}" />\n                            <div ng-show="!lightboxResource.pictureLink" alt="{{ lightboxResource.name }}" class="ResourcePhotoIcon resourcePhotoLightbox"></div>\n\n                            <h1 class="lightboxHeader" id="resourceName" ng-bind="lightboxResource.name"></h1>\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'details\')" ng-class="{lightboxSelectedTab: selectedTab == \'details\'}">\n                                '+customLabels.Details+'\n                            </button>\n\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'relatedLists\')" ng-class="{lightboxSelectedTab: selectedTab == \'relatedLists\'}">\n                                '+customLabels.Related+'\n                            </button>\n\n                            <button ng-show="chatterAvailable" fsl-tab-switch role="tab" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </button>\n\n                            <button ng-if="isMapEnabled" fsl-tab-switch role="tab" ng-click="changeTab(\'map\'); " ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                                '+customLabels.Map+'\n                            </button>\n\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'calendar\')" ng-class="{lightboxSelectedTab: selectedTab == \'calendar\'}">\n                                '+customLabels.Calendar+'\n                            </button>\n                            \n                            <button ng-show="urls.custom1" fsl-tab-switch role="tab" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                                '+customLabels.CustomResourceTab1+'\n                            </button>\n                            \n                            <button ng-show="urls.custom2" fsl-tab-switch role="tab" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                                '+customLabels.CustomResourceTab2+'\n                            </button>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxResource.id)" target="_blank" href="../{{ lightboxResource.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        <use xlink:href="'+lsdIcons.external+'"></use>\n                                    </svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <section ng-if="isMapEnabled" id="resourceLightboxMap" ng-show ="selectedTab == \'map\'">\n                            <ui-gmap-google-map pan="false" control="mapControl" center="{latitude: 0 ,longitude: 0}" options="mapOptions" zoom="16" class="map-canvas">\n                                <ui-gmap-markers click="markerClicked" models="markersArray" idKey="id" coords="\'coords\'" options="\'markerOptions\'"">\n                                </ui-gmap-markers>\n\n                                <ui-gmap-window show="serviceInfoWindow.show" ng-show="currentMarket.type === \'service\'" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" src="'+staticResources.wo_icon_png+'"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-window show="resourceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.resource">\n                                    <div class="googleMapInfoWindowHomebase">\n                                        <svg aria-hidden="true" class="slds-icon homebaseTooltipIcon">\n                                            <use xlink:href="'+lsdIcons.home+'"></use>\n                                        </svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ "'+customLabels.homebase_of+'" | replaceLabels : currentMarker.resourceName }}</span></h1>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n                                \n                                \n                                \n                                \n                                <ui-gmap-window show="absenceInfoWindow.show && showAbsencesOnMap" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.absence">\n                                    <div class="googleMapInfoWindowAbsence">\n                                        <svg aria-hidden="true" class="slds-icon absenceeTooltipIcon">\n                                            <use xlink:href="'+lsdIcons.absence+'"></use>\n                                        </svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ $parent.$parent.currentMarker.item.name }}</span></h1>\n                                        <div>'+customLabels.Start_time+": {{ $parent.$parent.currentMarker.item.start | amDateFormat:'lll' }}</div>\n                                        <div>"+customLabels.Finish_time+": {{ $parent.$parent.currentMarker.item.end | amDateFormat:'lll' }}</div>\n                                        <div>"+customLabels.Reason+': {{ $parent.$parent.currentMarker.item.reason }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n                                \n                               \n                                <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                    <div class="googleMapInfoWindowLivePos">\n                                        <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                        \t<use xlink:href="'+lsdIcons.user+'"></use>\n                                    \t</svg>\n                                        <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                        <div>'+customLabels.Last_seen+' {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.resourceId)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-layer type="TrafficLayer" show=\'showTrafficLayer\'></ui-gmap-layer>\n                                \n                            </ui-gmap-google-map>\n                            <div id="ResourceMapOptions">\n                                <div id="ResourceMapOptionsWrapper">\n                                    <input ng-model="$parent.showServices" ng-change="generateMarkersAndRoute(true)" type="checkbox" id="ResourceServicesFilter"></input>\n                                    <label for="ResourceServicesFilter">'+customLabels.Show_services_for+'</label>\n                                    <div class="resourceMapDateArrow" fsl-key-press tabindex="0" ng-click="changeDate(-1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                           <use xlink:href="'+lsdIcons.chevronleft+'"></use>\n                                       </svg>\n                                    </div>\n                                    <u id="resourceServicesDateStart" class="bulkDatePicker" fsl-key-press tabindex="0" ng-click ="openDatePicker()" >{{resourceServicesDate | amDateFormat:\'L\'}}</u>\n                                    <div class="resourceMapDateArrow" fsl-key-press tabindex="0" ng-click="changeDate(1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                           <use xlink:href="'+lsdIcons.chevronright+'"></use>\n                                       </svg>\n                                    </div>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="$parent.showRoute" ng-change="routeToggled()" type="checkbox" id="RouteFilter"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="RouteFilter">'+customLabels.Route+'</label>\n                                    <input ng-hide="hideActulRoute || (lightboxResource.isCapacityBased && contractorSupport)" ng-model="$parent.showActual" ng-change="toggleShowRoute()" type="checkbox" id="actualToggle"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="hideActulRoute || (lightboxResource.isCapacityBased && contractorSupport)" for="actualToggle">'+customLabels.ActualRoute+'</label>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="showTrafficLayer" type="checkbox" id="trafficToggle"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="trafficToggle">'+customLabels.Traffic+'</label>\n                                    <div fsl-key-press tabindex="0" class="truncate" id="toggleResourceMapServiceCarousel" ng-click="slideToggle()">\n                                        {{showSideRoute ? "'+customLabels.HideDetailedRoute+'" : "'+customLabels.ToggleDetailedRoute+'"}}\n                                    </div>\n                                </div>\n                            </div>\n                            <div id="ResourceMapCarousel" ng-show="resourceServices.length > 0">\n\n                                <div id="mapCarouselWrapper">\n                                    <div class="carouselArrow crouselLeft">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon"><use xlink:href="'+lsdIcons.chevronleft+'"></use></svg>\n                                    </div>\n                                    <div class="carouselArrow crouselRight">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon"><use xlink:href="'+lsdIcons.chevronright+'"></use></svg>                                \n                                    </div>\n                                    \n                                    \n                                    <div class="resource-map-no-route" ng-hide="haveItemsToShowOnSideRoute(markersArray)">\n                                        There are no services or absences to show\n                                    </div>\n\n                                    <div class="carouselItem" ng-if="allowStreetLevelRouting && drivingProfile.type == \'\' && showRoute == true && calloutFailures != 2">\n                                        <img style="display: block; margin-left: auto; margin-right: auto; width: 20%; padding: 10px;" src="'+lsdIcons.spinnerGif+'" />\n                                    </div>\n                                    <div class="carouselItem" ng-if=" drivingProfile.type != \'\' && showRoute == true">\n                                        <span>\n                                            <div style="background-color: #8DB9F9; display: inline-flex; width: 32px; height: 32px;">\n                                                <object style="width: 75%; height: 75%; margin: auto;" data="{{drivingProfile.image}}"></object>\n                                            </div>\n                                        </span>\n                                        \x3c!-- <span>\n                                            <img style="max-height: 24px;" src="{{drivingProfile.image}}"/>\n                                        </span> --\x3e\n                                        <div style="display: inline-block;margin-left: 9px">\n                                            <span class="appointment-times">'+customLabels.Travel_Profile+'</span>\n                                            <span class="appointment-number">{{drivingProfile.type}}</span>\n                                        </div>\n                                        <div class="appointment-rows">\n                                            <div>'+customLabels.Use_Tollways+": {{drivingProfile.tolls}}</div>\n                                            <div>"+customLabels.Hazardous_Materials+': {{drivingProfile.hazmat}}</div>\n                                        </div>\n                                    </div>\n                                    <div ng-repeat="marker in markersArray" class="carouselItem" ng-if=" marker.type === \'na\' || marker.type == \'service\'">\n                                    \n                                        <div ng-if="marker.type === \'na\'">\n                                            <span class="numberingOnMapRouteSide numberingOnMapRouteSideNA" fsl-key-press tabindex="0" title="'+customLabels.CenterOnMapp+'" ng-click="boundOnCaruselItem(marker)">{{noHomeBase && $index+1 || $index}}</span>\n                                            <span class="appointment-times">{{formatDateToTime(marker.item.start)}} - {{formatDateToTime(marker.item.finish)}}</span>\n                                            <span class="appointment-number">{{marker.item.name}}</span>\n  \n                                            <div class="appointment-rows">\n                                                <div>'+customLabels.Start_time+": {{ marker.item.start | amDateFormat:'lll' }}</div>\n                                                <div>"+customLabels.Finish_time+": {{ marker.item.end | amDateFormat:'lll' }}</div>\n                                                <div>"+customLabels.Reason+': {{ marker.item.reason }}</div>\n                                            </div>\n                                        </div>\n                                    \n                                    \n                                        <div ng-if="marker.type == \'service\'">\n                                            <span class="numberingOnMapRouteSide" title="'+customLabels.CenterOnMapp+'" fsl-key-press tabindex="0" ng-click="boundOnCaruselItem(marker)" ng-style="{\'background-color\': getColorByStatus(marker.item)}">{{ noHomeBase && $index+1 || $index}}</span>\n                                            <span class="appointment-times">{{formatDateToTime(marker.item.start)}} - {{formatDateToTime(marker.item.finish)}}</span>\n                                            <span class="appointment-number">\n                                                {{marker.item.AppointmentNumber}}\n                                                <span ng-if="marker.item.isOffsiteAppointment">('+customLabels.Offsite+')</span>\n                                            </span>\n                                            \x3c!-- <div class="boundOnMarker globalBlueButton" ng-click="boundOnCaruselItem(marker)" ng-hide="currentlyShowingOnMap == marker.id">\n                                                 <svg aria-hidden="true" class="slds-icon boundIcon"><use xlink:href="'+lsdIcons.checkin+'"></use></svg>                                            \n                                            </div>\n                                            <div class="boundOnMarker globalBlueButton" ng-click="zoomOutToFitAll()" ng-show="currentlyShowingOnMap == marker.id">\n                                                 <svg aria-hidden="true" class="slds-icon boundIcon"><use xlink:href="'+lsdIcons.location+'"></use></svg>                                            \n                                            </div>--\x3e\n                                            <div class="appointment-rows">\n                                                <span ng-repeat="field in serviceFields" class="">\n                                                    <div ng-show="marker.item[field.JsAPIName]">{{field.Label}}: <span ng-click="openFieldSetLink(marker.item, field)" ng-class="getServiceInfoRowClass(field)">{{marker.item | displayFieldSetField : field}}</span></div>                                            \n                                                </span>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </section>\n\n                        <div class="capacitiesDonuts" ng-show="selectedTab == \'details\' && lightboxResource.isCapacityBased && contractorSupport">\n                            <div id="weeklyCapacity">\n                                <div id="weeklyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.weekly.show" ng-bind="donutCharts.weekly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.weekly.show">'+customLabels.No_Weekly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.weekly.show" title="'+customLabels.Weekly_Capacity+'">'+customLabels.Weekly_Capacity+'</div>\n                                </div>\n                                <canvas id="weeklyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.weekly.options"\n                                        chart-data="donutCharts.weekly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.weekly.start, donutCharts.weekly.end)}}</div>\n                            </div>\n\n                            <div id="monthlyCapacity">\n                                <div id="monthlyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.monthly.show" ng-bind="donutCharts.monthly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.monthly.show">'+customLabels.No_Monthly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.monthly.show" title="'+customLabels.Monthly_Capacity+'">'+customLabels.Monthly_Capacity+'</div> \n                                </div>\n                                <canvas id="monthlyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.monthly.options"\n                                        chart-data="donutCharts.monthly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.monthly.start, donutCharts.monthly.end)}}</div>\n                            </div>\n                        </div>\n\n                        <div id="KPIforResource" ng-show="selectedTab == \'details\'" ng-class="{KPIforResourceWithCapacity: (lightboxResource.isCapacityBased && contractorSupport)}">\n                            <div class="kpiIndicator" ng-show="!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport)">\n                                <div class="kpiResourceValue" >\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon"><use xlink:href="'+lsdIcons.clock+'"></use></svg>\n                                    {{ formatTravel(resourceKpi.totalScheduledDuration) }}\n                                </div>\n\n                                '+customLabels.Total_Scheduled+'\n                            </div>\n\n                            <div class="kpiIndicator" ng-show="isMapEnabled && (!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport))">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIconTravel"><use xlink:href="'+lsdIcons.car+'"></use></svg>\n                                    {{ formatTravel(resourceKpi.avgTravelTime * 60) }}\n                                </div>\n\n                                '+customLabels.Average_Travel+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon"><use xlink:href="'+lsdIcons.violation+'"></use></svg>\n                                    {{ resourceKpi.violations }}\n                                </div>\n\n                                '+customLabels.Violations+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon"><use xlink:href="'+lsdIcons.jeopardy+'"></use></svg>\n                                    {{ resourceKpi.jeopardy }}\n                                </div>\n                                 '+customLabels.In_Jeopardy+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon"><use xlink:href="'+lsdIcons.completed+'"></use></svg>\n                                    {{ resourceKpi.completed }}/{{ resourceKpi.total }}\n                                </div>\n\n                                '+customLabels.Completed+'\n                            </div>\n\n                            <div class="KpiRange">{{formatKpitText()}}</div>\n                        </div>\n\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.details }}" id="detailsIframeResource" ng-class="{detailsIframeResourceContractor: lightboxResource.isCapacityBased && contractorSupport}" ng-show="selectedTab == \'details\'"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.related }}" id="relatedListIframeResource" ng-show="selectedTab == \'relatedLists\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.chatter }}" ng-if="chatterAvailable" id="chatterIframeResource" ng-show="selectedTab == \'chatter\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.calendar }}" id="calendarIframeResource" ng-show="selectedTab == \'calendar\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}" class="resourceLightboxIframe"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}" class="resourceLightboxIframe"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>");r.find("#ResourceLightbox").draggable({containment:"document",handle:"#ResourceLightboxHeader"}),angular.element("body").append(r),d.setLightBoxStatus(),_.$on("$destroy",function(){return r.remove()}),_.$on("keypress",function(e,t){27==t.which&&_.$evalAsync(_.closeLightbox)}),l(r)(_),c.safeApply(_),_.hideActulRoute||f.callRemoteAction(RemoteActions.getResourceActualRoute,_.lightboxResource.id,scheduler.getState().min_date).then(function(e){S.promise(1).then(function(){_.map=_.mapControl.getGMap(),P(e)})})}}}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$sce","$compile","utils","StateService","TimePhasedDataService","$timeout","SERVICE_STATUS","SERVICE_CATEGORY","LastKnownPositionService","FieldSetFieldsService","sfdcService","uiGmapIsReady"],angular.module("serviceExpert").factory("ResourceLightboxService",e)}(),!function(){function e(r,o,s,l,e,c,d,u,p,t,a){var m=null,h=[];function g(){m.$destroy()}function v(){e.open(m.resourceId,m.section)}function f(t){var e,n,i,s,r=void 0,r=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),o=d.selectedPolicyId,a={FillInSchedule:{FunctionName:c.runFillInSchedule,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.Fill_in_Schedule),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.Fill_in_Schedule,m.menuResource.name.encodeHTML(),moment(r).format("L"))},FixOverlaps:{FunctionName:c.runFixOverlaps,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.FixOverlaps),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.FixOverlaps,m.menuResource.name.encodeHTML(),moment(r).format("L"))}};useLocationTimezone&&(n=addDaysToDate(e=r,1),i=p.getIntersectingSrstOffset({start_date:e,end_date:n},m.resourceId),s=l.getUserOffset(e),l.getUserOffset(n),r.setMinutes(e.getMinutes()+s-i)),(0,a[t].FunctionName)(r,m.resourceId,o).then(function(e){e?(e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?l.addNotification(a[t].NotificationHeaderText,a[t].NotificationText,function(e){l.openSObjectLink("../"+e)},e.Id):l.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){l.openSObjectLink("../"+e)},e.Id),u.updateOptimizationRequest(e)):l.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).then(function(){}).catch(function(e){console.warn(t+" failed :("),console.log(e),l.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)}).finally(function(){}),g()}function S(){var e,t=o.getResources(),n=p.currentCrewToShow,i=m.menuResource.serviceCrew,s=(p.selectedCrewIdToShow=i,n={},p.crewToServiceCrewMembers()[i]);for(e in n[m.resourceId]=m.menuResource,s)n[s[e].serviceResource]=t[s[e].serviceResource],void 0===n[s[e].serviceResource].members&&(n[s[e].serviceResource].members={}),n[s[e].serviceResource].members[e]=s[e];p.currentCrewToShow=n,r.currentCrewToShow=n,g(),r.$broadcast("moveToCrewView")}function _(){t.open(m.resourceId)}function b(t){var e,n,i,s=null,r=window.__lastResourceClicked.key.split("_")[1],o=p.resourcesAndTerritories()[m.resourceId];for(e in o)o[e].serviceTerritory===r&&(s=e);t.visualforce?(n=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),i=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),a.open(t.name,t.visualforce+"?id="+m.resourceId+"&stm="+s+"&start="+n+"&end="+i)):c.callRemoteAction(RemoteActions.runCustomResourceAction,t.className,m.resourceId,s,scheduler._min_date,scheduler._max_date).then(function(e){u.updateGantt(),e&&l.addNotification(t.name,e,null,null)}).catch(function(e){return l.addNotification(t.name,e.message,null,null)}),g()}return l.customActionsPromise.then(function(){var e=l.getCustomActions("resource");h.push.apply(h,_toConsumableArray(e))}),{open:function(e,t,n){(m=r.$new(!0)).menuResource=o.getResources()[e],m.resourceId=e,m.section=t,m.openResourceLightbox=v,m.runDynamicGanttFunction=f,m.hasCustomPermission=l.hasCustomPermission,m.showCrew=S,m.openResourceDayOptimizationLightbox=_,m.isCrew=!1,m.customActions=h,m.runCustomResourceAction=b,void 0!==o.getCrewResources()[e]&&(m.isCrew=!0);var i=angular.element('\n                    <div id="resourceMenu" class="resourceMenuContainer">\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceLightbox()" title="'+customLabels.Details+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.Details+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceDayOptimizationLightbox()" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Resource_Schedule_Optimization\')" title="'+customLabels.RDOptimize+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.magicwand+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.RDOptimize+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FixOverlaps\')" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Fix_Overlaps\')" title="'+customLabels.FixOverlaps+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.crossfilter+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.FixOverlaps+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FillInSchedule\')" ng-hide="!hasCustomPermission(\'Fill_in\')" title="'+customLabels.Fill_in_Schedule+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.summarydetail+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.Fill_in_Schedule+'\n                        </div>\n                        <div class="truncate resMenuSingleAction" ng-click="showCrew()" ng-show="isCrew" title="'+customLabels.showCrewAndHisMemebers+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon crew-icon-menu">\n                                    <use xlink:href="'+lsdIcons.crew+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.showCrew+'\n                        </div>                    \n                        \n                        <div ng-repeat="action in customActions" class="truncate resMenuSingleAction" ng-click="runCustomResourceAction(action)" title="{{action.name}}">\n                        \n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon customResourceAction" ng-show="action.icon">\n                                    <use xlink:href="{{action.icon}}"></use>\n                                \u2028</svg>\n                            </div>\n                        \n                            {{action.name}}\n                        </div>\n                    </div>\n                '),e=(t=$($(n).closest(".resourceMenuBtn"))).offset(),n=$(window).width()-(e.left+t.outerWidth());angular.element("body").append(i),$(".resourceMenuContainer").css({top:e.top}),d.isRtlDirection()?$(".resourceMenuContainer").css({right:n}):$(".resourceMenuContainer").css({left:e.left}),m.$on("$destroy",function(){return i.remove()}),angular.element("body").on("mousedown",function(e){for(var t=["resMenuSingleAction"],n=0;n<t.length;n++)if(e.target.classList.contains(t[n])||e.target.parentNode&&e.target.parentNode.classList.contains(t[n]))return;g(),e.stopPropagation(),angular.element("body").off("mousedown")}),s(i)(m),l.safeApply(m)}}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$compile","utils","ResourceLightboxService","sfdcService","StateService","DeltaService","TimePhasedDataService","rdOptimizeLightboxService","GeneralLightbox"],angular.module("serviceExpert").factory("ResourceSmallMenu",e)}(),!function(){function e(s,e,l){var c={territories:s.defer(),resources:s.defer(),operatingHours:s.defer()},d={},u={},p={},m=[],h={},g={},v={},f={};function S(e,t){return e.forEach(function(e){t[e.SkillId]=Object.assign({},e.Skill)}),t}function t(){var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,a=s.defer();return e.GetResourcesAndTerritories().then(function(e){o&&o(),a.resolve();var t,n=e.withoutSharingTerritories.reduce(function(e,t){return e[t.Id]=t,e},{}),i=(e.territories.forEach(function(e){e.IsActive&&(d[e.Id]=new ServiceTerritory(e),d[e.Id].hasSharing=!n[e.Id]),u[e.Id]=new ServiceTerritory(e)}),{});for(t in e.resourcesWithSkills.forEach(function(e){e.ServiceResourceSkills&&0<e.ServiceResourceSkills.length&&(i[e.Id]=e.ServiceResourceSkills,v=S(e.ServiceResourceSkills,v))}),e.resources.forEach(function(e){e.ServiceResourceSkills&&(v=S(e.ServiceResourceSkills,v),i[e.Id])&&(e.ServiceResourceSkills=e.ServiceResourceSkills.concat(i[e.Id])),p[e.Id]=new ServiceResource(e),p[e.Id].isCapacityBased&&m.push(e.Id),p[e.Id].serviceCrew&&(g[e.Id]=e,f[p[e.Id].serviceCrew]=e)}),e.operatingHours.forEach(function(e){h[e.Id]=new OperatingHours(e)}),d){var s,r=d[t].operatingHours;if(!h[r])throw(s={type:"operatingHours"}).message=r,s}bootstrap.loadedUserSettings.locations.length&&window.__gantt.pushService.pushServiceSettingEnabled&&(e={territories:bootstrap.loadedUserSettings.locations,resources:Object.keys(p),operation:l.MESSAGE_OPERATIONS.RESET},l.isPushServiceActive()?l.updateSession(e):l.connectToWebSocket(e)),c.territories.resolve(d),c.resources.resolve(p),c.operatingHours.resolve(h),window.setSplashScreenTabDone("loading-territories")}).catch(function(e){a.reject(e),c.resources.reject(),c.territories.reject(),c.operatingHours.reject(),console.warn("GetResourcesAndTeritorries: unable to load resources, territories, or operating hours"),bootstrap.handleError(e)}),a.promise}return t(),{promises:{territories:function(){return c.territories.promise},resources:function(){return c.resources.promise},operatingHours:function(){return c.operatingHours.promise}},territories:function(){return d},allTerritories:u,getResources:function(){return p},getResourcesSkills:function(){return v},operatingHours:h,getOperatingHours:function(){return h},getCapacityBasedResources:function(){return m},getCrewResources:function(){return g},getCrewToResources:function(){return f},contractorResources:function(){return m},crewResources:function(){return g},crewToResources:function(){return f},skillsList:function(){return v},getResourceAndTerritories:t,getResourceAndTerritoriesFromJson:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=s.defer(),i=(scheduler.clearAll(),d={},u={},p={},m=[],h={},g={},f={},v={},e&&e(),n.resolve(),[]);return t.Territories.forEach(function(e){d[e.Id]=new ServiceTerritoryOptiViewer(e),u[e.Id]=new ServiceTerritoryOptiViewer(e),i.push(e.OperatingHours)}),t.Resources.forEach(function(e){p[e.Id]=new ServiceResourceOptiViewer(e),e.ServiceTerritories.records.forEach(function(e){e.OperatingHours&&i.push(e.OperatingHours)}),p[e.Id].isCapacityBased&&m.push(e.Id),p[e.Id].serviceCrew&&(g[e.Id]=e,f[p[e.Id].serviceCrew]=e)}),i.forEach(function(e){h[e.Id]=new OperatingHoursOptiViewer(e,t.CalendarDays)}),c.territories.resolve(d),c.resources.resolve(p),c.operatingHours.resolve(h),n.promise},reset:function(){d={},p={},h={},m=[],g={},f={},v={}}}}e.$inject=["$q","sfdcService","PushServices"],angular.module("serviceExpert").factory("ResourcesAndTerritoriesService",e)}(),!function(){function e(i,s,o,a,l,c,d,u,p,m,h,g,e,v,t){var f=null;function S(){var e;d.getStreamingActiveState()||(e="On Demand"!==window.__gantt.checkRulesMode,t.getDelta(e))}function _(){switch(f.selectedTab){case"account":return f.lightboxService.accountId||f.lightboxService.id;case"wo":return f.lightboxService.parentRecord||f.lightboxService.id;default:return f.lightboxService.id}}function b(e){return!("wo"!==e||"WorkOrder"!==f.lightboxService.parentRecordType||!fieldTrackingEnabled.workorder)||!("wo"!==e||"WorkOrderLineItem"!==f.lightboxService.parentRecordType||!fieldTrackingEnabled.woli)||!("service"!==e||!fieldTrackingEnabled.service)}function y(e){return e===c.LINEITEM||e===c.WORKORDER}function w(){window.__updateGantt=null,d.setLightBoxStatus(!1),f.killWatch&&f.killWatch(),f.$destroy()}function T(e){e!==f.selectedTab&&(f.selectedTab=e)}return{open:function(e){(f=i.$new(!0)).lightboxService=s.serviceAppointments()[e],f.selectedTab="service";var r,t,n="&isdtp=p1";f.urls={service:o.trustAsResourceUrl(customLightboxPage+"?id="+e).toString()},f.lightboxService&&(f.lightboxService.accountId&&(f.urls.account=o.trustAsResourceUrl(customAccountLightbox+"?id="+f.lightboxService.accountId+n).toString()),f.urls.service_chatter=o.trustAsResourceUrl(customServiceChatterLightbox+"?id="+f.lightboxService.id).toString(),f.lightboxService.parentRecordType===c.WORKORDER?(f.urls.wo=o.trustAsResourceUrl(customWoLightbox+"?id="+f.lightboxService.parentRecord).toString(),f.urls.wo_chatter=o.trustAsResourceUrl(customWoChatterLightbox+"?id="+f.lightboxService.parentRecord).toString(),f.urls.related=o.trustAsResourceUrl(customWoRelatedLightbox+"?id="+f.lightboxService.parentRecord+n).toString(),(f.lightboxService.isBundle||f.lightboxService.isBundleMember)&&(f.urls.bundle=o.trustAsResourceUrl(customWoLightboxBundlerDetails+"?id="+f.lightboxService.id).toString())):f.lightboxService.parentRecordType===c.LINEITEM?(f.urls.wo=o.trustAsResourceUrl(customWoliLightbox+"?id="+f.lightboxService.parentRecord).toString(),f.urls.wo_chatter=o.trustAsResourceUrl(customWoliChatterLightbox+"?id="+f.lightboxService.parentRecord).toString(),f.urls.related=o.trustAsResourceUrl(customWoliRelatedLightbox+"?id="+f.lightboxService.parentRecord+n).toString()):f.lightboxService.parentRecordType===c.ACCOUNT?(f.urls.related=null,f.urls.account=o.trustAsResourceUrl(customAccountLightbox+"?id="+f.lightboxService.parentRecord+n).toString()):f.urls.related=null,f.urls.custom1=CustomServiceTab1?o.trustAsResourceUrl(CustomServiceTab1+"?id="+f.lightboxService.id).toString():null,f.urls.custom2=CustomServiceTab2?o.trustAsResourceUrl(CustomServiceTab2+"?id="+f.lightboxService.id).toString():null,f.changeTab=T,f.isChatterAvailable=b,f.closeLightbox=w,f.chatterAvailable=fieldTrackingEnabled.service,f.openConsoleTab=l.openConsoleTab,f.isMapEnabled=d.isMapEnabled(),f.selectedSubTabWo="details",f.selectedSubTabService="details",f.showWOTab=y,f.getIdOfObjectInActiveTab=_,f.isMapEnabled&&(f.serviceIcon=staticResources.wo_icon_png,f.resourceIcon=lsdIcons.user,f.lastSeenLabel=customLabels.Last_seen,f.getServiceInfoRowClass=l.getServiceInfoRowClass,f.currentMarker={},f.map=null,f.mapControl={zoom:19,center:{latitude:0,longitude:0}},f.allMarkersArray=[],f.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},f.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},f.serviceInfoWindow={show:!1},f.livePosInfoWindow={show:!1},m.fieldsSetFields().then(function(e){f.serviceFields=e.MapInfo}),null!=f.lightboxService.latitude&&null!=f.lightboxService.longitude&&(r=p(function(){if(!f.mapControl||f.mapControl.getGMap){p.cancel(r),f.map=f.mapControl.getGMap();var e=staticResources.service_png;f.lightboxService.statusCategory==v.COMPLETED&&(e=staticResources.service_completed_png),f.allMarkersArray.push({id:f.lightboxService.id,icon:e,type:"service",coords:{latitude:f.lightboxService.latitude,longitude:f.lightboxService.longitude},item:f.lightboxService});var t,n=h.lastKnownPositions();for(t in n){i=void 0;s=void 0;var i=n[t];var s=g.getResources()[i.id],i={id:i.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:i.id,coords:{latitude:i.latitude,longitude:i.longitude},item:angular.extend(angular.copy(i),{resourceName:s.name})};window.customPermissions.Hide_Live_Locations_Resource_Map_Layer||isLastKnownFieldsNotAllowed||f.allMarkersArray.push(i)}e=new google.maps.LatLng(f.lightboxService.latitude,f.lightboxService.longitude);f.map.setCenter(e)}},500)),f.openLink=function(e,t){l.openLink(e,t)},f.markerCloseClicked=function(){f.serviceInfoWindow.show=!1,f.livePosInfoWindow.show=!1,f.$apply()},f.markerClicked=function(e,t,n){var i=n.type;switch(f.serviceInfoWindow.show=!1,f.livePosInfoWindow.show=!1,f.currentMarker=n,i){case"service":f.serviceInfoWindow.show=!0;break;case"lastKnownPosition":f.livePosInfoWindow.show=!0}u(function(){f.$apply(),l.setMapCloseButtonPosition()},0)},f.killWatch=f.$watch("selectedTab",function(e){"map"==e&&u(function(){google.maps.event.trigger(f.map,"resize")},0)})),f.$on("$destroy",function(){return t.remove()}),f.$on("keypress",function(e,t){27==t.which&&f.$evalAsync(f.closeLightbox)}),(t=angular.element('<div class="LightboxBlackContainer">\n                <div class="LightboxContainer" id="ServiceLightbox">\n\n                    <div class="lightboxHeaderContainer" id="ServiceLightboxHeader">\n\n                        <svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                        <h1 class="lightboxHeader">{{lightboxService.name}}</h1>\n\n                        <button fsl-tab-switch role="tab" ng-click="changeTab(\'service\')" ng-class="{lightboxSelectedTab: selectedTab == \'service\'}">\n                            '+customLabels.Service+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-show="urls.bundle" ng-click="changeTab(\'bundle\')" ng-class="{lightboxSelectedTab: selectedTab == \'bundle\'}">\n                            '+customLabels.Bundle+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-click="changeTab(\'wo\')" ng-class="{lightboxSelectedTab: selectedTab == \'wo\'}">\n                            <div ng-show="lightboxService.parentRecordType === \'WorkOrder\'">'+customLabels.WorkOrder+"</div>\n                            <div ng-show=\"lightboxService.parentRecordType === 'WorkOrderLineItem'\">"+customLabels.Woli+'</div>\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-show="urls.related" ng-click="changeTab(\'relatedList\')" ng-class="{lightboxSelectedTab: selectedTab == \'relatedList\'}">\n                            '+customLabels.Related+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-if="isMapEnabled" ng-show="lightboxService.latitude && lightboxService.longitude" ng-click="changeTab(\'map\')" ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                            '+customLabels.Map+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-show="urls.account" ng-click="changeTab(\'account\')" ng-class="{lightboxSelectedTab: selectedTab == \'account\'}">\n                            '+customLabels.Account+'\n                        </button>\n                        \n                        <button fsl-tab-switch role="tab" ng-show="urls.custom1" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                            '+customLabels.CustomServiceTab1+'\n                        </button>\n                        \n                        <button fsl-tab-switch role="tab" ng-show="urls.custom2" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                            '+customLabels.CustomServiceTab2+'\n                        </button>\n\n                        <div class="ExtendedForm">\n                            <a ng-click="openConsoleTab($event,getIdOfObjectInActiveTab())" target="_blank" href="../{{ getIdOfObjectInActiveTab() }}" title="'+customLabels.ExtandedForm+'">\n                                <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                    \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                \u2028</svg>\n                            </a>\n                        </div>\n\n                    </div>\n                   \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'service\') && selectedTab == \'service\'">\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabService == \'details\'}" ng-click="selectedSubTabService=\'details\'"}">'+customLabels.Details+'</button>\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabService == \'feed\'}" ng-click="selectedSubTabService=\'feed\'">'+customLabels.Feed+'</button>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'wo\') && selectedTab == \'wo\'">\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabWo == \'details\'}" ng-click="selectedSubTabWo=\'details\'"}">'+customLabels.Details+'</button>\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabWo == \'feed\'}" ng-click="selectedSubTabWo=\'feed\'">'+customLabels.Feed+'</button>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo_chatter }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'service\' && selectedSubTabService == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'service\' && selectedSubTabService == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service_chatter }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'relatedList\' && urls.related" ng-src="{{ urls.related }}"></iframe>  \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'account\' && urls.account" ng-src="{{ urls.account }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'bundle\' && urls.bundle" ng-src="{{ urls.bundle }}"></iframe>\n\n\n                    <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}"></iframe>\n                    \n                    \n                    \n                    <div id="lightbox-loading-cover">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.loading+'\n                    </div>\n                    \n                 \n                    <section ng-if="isMapEnabled" id="serviceLightboxMap" ng-show ="selectedTab == \'map\'">\n                        <ui-gmap-google-map pan="false" control="mapControl" center="mapControl.center" options="mapOptions" zoom="mapControl.zoom" class="map-canvas">\n                            <ui-gmap-markers click="markerClicked" models="allMarkersArray" idKey="id" coords="\'coords\'" icon="\'icon\'">\n                            </ui-gmap-markers>\n\n                            <ui-gmap-window show="serviceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" ng-src="{{serviceIcon}}"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                            </ui-gmap-window>\n\n                            <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                <div class="googleMapInfoWindowLivePos">\n                                    <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                    \u2028\t<use xlink:href="{{resourceIcon}}"></use>\n                                \u2028\t</svg>\n                                    <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                    <div>{{lastSeenLabel}} {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                </div>\n                            </ui-gmap-window>\n                        </ui-gmap-google-map>\n                    </section>\n\n                </div>\n            </div>')).find("#ServiceLightbox").draggable({containment:"document",handle:"#ServiceLightboxHeader"}),d.setLightBoxStatus(),window.__updateGantt=S,a(t)(f),l.safeApply(f,function(){angular.element("body").append(t)}))}}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","PARENT_RECORD_TYPE","StateService","$timeout","$interval","FieldSetFieldsService","LastKnownPositionService","ResourcesAndTerritoriesService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService"],angular.module("serviceExpert").factory("ServiceAppointmentLightboxService",e)}(),!function(){function e(r,e,i,t,n,s,o){var a={},l=e.filter,c=[],d={},u=null,p=null;function m(e,t,n,i){var s=i&&i[t.selectedFilter]&&i[t.selectedFilter].old;return useNewFilters&&!s?r("servicesListFilterNew")(e,t,n):r("servicesListFilter")(e,t,n,i)}function h(){for(var e in a)a[e]=!1}n.register("services",function(e){e.deleted&&e.deleted.forEach(function(e){return delete a[e]})}),o.fieldsSetFields().then(function(e){c=e.ListColumns});return{SelectedServices:a,unselectAll:h,selectAll:function(){var e,t;d=m(i.serviceAppointments(),l,(e=l.selectedFilter,(e=s.getFilterById(e))&&e.Displayed_Fields&&0<e.Displayed_Fields.length?(t=[],e.Displayed_Fields.forEach(function(e){u[e]&&t.push(u[e])}),t):p.ListColumns),s.getFilterMap());for(var n=0;n<d.length;n++)a[d[n].id]=!0},selectViolations:function(){h();var e=angular.copy(l);e.selectedFilter="Violating","Custom filter"==l.selectedFilter&&(e.endDate=l.advancedFilter.maxDate),d=m(i.serviceAppointments(),l,c,s.getFilterMap()),d=m(d,e,c,s.getFilterMap());for(var t=0;t<d.length;t++)d[t].violations&&(a[d[t].id]=!0)},selectInJeopardy:function(){h();var e=angular.copy(l);e.selectedFilter="inJeopardy","Custom filter"==l.selectedFilter&&(e.endDate=l.advancedFilter.maxDate),d=m(i.serviceAppointments(),l,c,s.getFilterMap()),d=m(d,e,c,s.getFilterMap());for(var t=0;t<d.length;t++)d[t].jeopardy&&(a[d[t].id]=!0)},selectUnscheduled:function(){h();var e=angular.copy(l);e.selectedFilter="Unscheduled","Custom filter"==l.selectedFilter&&(e.endDate=l.advancedFilter.maxDate),d=m(i.serviceAppointments(),l,c,s.getFilterMap()),d=m(d,e,c,s.getFilterMap());for(var t=0;t<d.length;t++)d[t].isScheduled&&!d[t].isScheduled()&&(a[d[t].id]=!0)},countSelectedServices:function(){var e,t=0;for(e in a)a[e]&&t++;return t},getSelected:function(){var e,t=[];for(e in a)a[e]&&t.push(e);return t},setAllfieldsSetFieldsObject:function(e){p=e},setAllfieldsSetFieldsObjectOneLevel:function(e){u=e}}}e.$inject=["$filter","servicesService","TimePhasedDataService","sfdcService","RegisterService","GanttFilterService","FieldSetFieldsService"],angular.module("serviceExpert").factory("ServiceSelectorService",e)}(),!function(){function e(r,o,u){var n=[],i={skills:r.defer()},s=[],a={resourcesWithSkills:r.defer()},p={},m=null,l=[];function e(){return m}function h(t,e,n){return e.forEach(function(e){new ServiceResource(null,!0).checkIfResourceAlreadyHasSkill(t.skills,e.Id,e.SkillId)||(t.skills[n]?(Array.isArray(t.skills[n])||(t.skills[n]=[t.skills[n]]),t.skills[n].push(new ServiceResourceSkill(e))):t.skills[n]=new ServiceResourceSkill(e))}),t}return{getSkills:function(){return n},getServerResult:function(){return p},getServerSideSkill:e,doesHaveSkills:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;if(window.useResourceSkillFilter){var s=u.getResources()[e],r=m;p[e]&&(s=h(s,p[e],r.Id));for(var o=0,a=(t=Array.isArray(t)?t:[t]).length;o<a;o++){var l=s.skills[t[o]];if(!l)return!1;if(Array.isArray(l)){for(var c=!1,d=0;d<l.length;d++)n&&i&&isIntersect(n,i,l[d].effectiveStartDate,l[d].effectiveEndDate)&&(c=!0);if(!c)return!1}else if(n&&i&&!isIntersect(n,i,l.effectiveStartDate,l.effectiveEndDate))return!1}}return!0},doesHaveSomeSkills:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;if(!window.useResourceSkillFilter)return!0;var s=u.getResources()[e],r=m;p[e]&&(s=h(s,p[e],r.Id));for(var o=0,a=(t=Array.isArray(t)?t:[t]).length;o<a;o++){var l=s.skills[t[o]];if(l){if(Array.isArray(l))for(var c=0;c<l.length;c++)if(n&&i&&isIntersect(n,i,l[c].effectiveStartDate,l[c].effectiveEndDate))return!0;if(n&&i&&isIntersect(n,i,s.skills[t[o]].effectiveStartDate,s.skills[t[o]].effectiveEndDate))return!0}}return!1},getSkillsFromSfdc:function(){var t=r.defer();return o.callRemoteAction(RemoteActions.getSkills).then(function(e){n=e,t.resolve(t),i.skills.resolve(n)}).catch(function(e){t.reject(t),i.skills.reject(e),console.log(e),console.warn("unable to get skill list")}),t.promise},getSkillsFromResourcesList:function(e){var t,n=u.getResourcesSkills();for(t in e)n[t]||!0!==e[t]||l.push(t);return s=Object.values(u.getResourcesSkills()),0<l.length?o.callRemoteAction(RemoteActions.getSkillsList,l).then(function(e){return s=s.concat(e)}).catch(function(e){return console.log(e),console.warn("unable to get skill list"),s}):Promise.resolve(s)},getResourcesWithSelectedSkillIdFromServer:function(e,t,n,i){var s=r.defer();return o.callRemoteAction(RemoteActions.getResourcesWithSelectedSkill,t,e,n,i).then(function(e){p=e,s.resolve(s),a.resourcesWithSkills.resolve(e)}).catch(function(e){s.reject(s),a.resourcesWithSkills.reject(e),console.log(e),console.warn("unable to get skill list")}),s.promise},setServerSkill:function(e){m=e},setServerResult:function(e){p=e},cachedServerSideSkillIds:{},promises:{skills:function(){return i.skills.promise},resourcesWithSkills:function(){return a.resourcesWithSkills.promise}}}}e.$inject=["$q","sfdcService","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("SkillsService",e)}(),!function(){function e(e,t,n,i){var s={},r=0,o=!1;if(n.GetUserSettingsProperty("Toggled_Territories__c"))try{var a,l=JSON.parse(n.GetUserSettingsProperty("Toggled_Territories__c"));for(a in l)s[a]=l[a]}catch(e){console.warn("could not parse JSON - Toggled_Territories__c")}var c={policies:e.defer()};var n=userLocale?userLocale.split("_")[0]:"en",d=[];var u=!1;t.callRemoteAction(RemoteActions.getPolicies).then(function(e){d.push.apply(d,_toConsumableArray(e)),0<d.length?c.policies.resolve(d):c.policies.reject("no policies found")}).catch(function(e){c.policies.reject(e)});var p=!1;var m=!1;function h(){return m}var g,v={minDate:null,maxDate:null};return document.addEventListener("mousemove",function(){return r=0}),window.Worker&&((g=new Worker(window.__gantt.InactivityMonitorWorker)).onmessage=function(e){(r+=10)>=window.__gantt.maxSecondsOfInactivity&&!o&&(o=!0,console.warn("Dispatcher Console: User is inactive, disconnecting."),m&&$.cometd.disconnect(),g.terminate())}),{isOptimizationEnabled:isOptimizationEnabled,lang:n,isOSX:function(){return-1!=window.navigator.userAgent.indexOf("Mac OS X")},isRtlDirection:function(){return"rtl"===document.querySelector("html").getAttribute("dir")},isInConsole:function(){return"undefined"!=typeof sforce?sforce.console.isInConsole():null},policies:d,selectedPolicyId:null,areContractorsSupported:function(){return contractorSupport},isMapEnabled:function(){return mapMode},setLightBoxStatus:function(){p=!(0<arguments.length&&void 0!==arguments[0])||arguments[0]},isLightboxOpened:function(){return p},setBulkActionRunning:function(){u=!(0<arguments.length&&void 0!==arguments[0])||arguments[0]},isBulkActionRunning:function(){return u},schedulingRunningFor:{},isScheduleRunning:!1,ganttOpenedTerritories:s,areCrewsSupported:function(){return!0},getStreamingActiveState:h,setStreamingActiveState:function(e){m=e},setDeltaDates:function(e,t){e=[moment(e),moment(t)],v.minDate&&(e.push(moment(v.minDate)),e.push(moment(v.maxDate))),v.minDate=moment.min(e).toDate(),v.maxDate=moment.max(e).toDate()},getDeltaDates:function(){return null!==v.minDate&&null!==v.maxDate?{minDate:v.minDate.getTime(),maxDate:v.maxDate.getTime()}:{minDate:null,maxDate:null}},isUserIdle:function(){return o&&i.$broadcast("UserIsIdle"),o},promises:{policies:function(){return c.policies.promise}}}}e.$inject=["$q","sfdcService","userSettingsManager","$rootScope"],angular.module("serviceExpert").factory("StateService",e)}(),!function(){function e(o,a,e,l,c,d,u,p){var m={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]},h=!1,g=new Set,v=new Set,f=new Set,S=new Set,_=new Set,b=new Set,y=new Set,w=new Set,T=new Set,L=new Set;return{HandleNotification:function(e){if(h||(h=!0,setTimeout(function(){(e={}).deletedAbsencesArray=Array.from(g),e.updatedAbsencesArray=Array.from(v),e.deletedGanttServicesArray=Array.from(f),e.updatedGanttServicesArray=Array.from(S),e.deletedCapacitiesArray=Array.from(_),e.updatedCapacitiesArray=Array.from(b),e.resourcesIdsArray=Array.from(y),e.updatedAssignResourceArray=Array.from(w),e.updatedOptimizationRequestArray=Array.from(T),e.deletedTimeDependencyArray=Array.from(L);h=!1,g.clear(),v.clear(),f.clear(),S.clear(),_.clear(),b.clear(),y.clear(),w.clear(),T.clear(),L.clear();var t,n,e,i=[];{var s,r;0!=e.updatedOptimizationRequestArray.length&&i.push(function(e){var n=o.defer();return a.getOptimiztionRequestsUpdate(e).then(function(t){d.isOptimizationEnabled&&t&&0<t.length&&m.optimizationRequests.forEach(function(e){return e(t)}),n.resolve()}),n.promise}(e.updatedOptimizationRequestArray)),0!=e.updatedAssignResourceArray.length&&i.push(function(e){var i=o.defer();return a.getGanttServiceOnAssignedResourceUpdate(e).then(function(e){var t,n=[];e&&0<e.length&&(t={},0<e.length&&(t.updated=l.updateTimePhaseData(e,"service").services,n.push.apply(n,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(t.updated))))),t.updated)&&m.services.forEach(function(e){return e(t)}),i.resolve(n)}),i.promise}(e.updatedAssignResourceArray)),0!=e.resourcesIdsArray.length&&i.push(function(e){var n=o.defer();return a.getLivePositionsStreaming(e).then(function(e){var t=c.updatePositions(e);t.isUpdated&&m.positions.forEach(function(e){return e(t.dic)}),n.resolve()}),n.promise}(e.resourcesIdsArray)),0!=e.updatedCapacitiesArray.length&&i.push(function(e){var n=o.defer();return a.getUpdatedResourceCapacities(e).then(function(e){var t;e&&0<e.length&&((t={}).updated=l.updateTimePhaseData(e,"capacity").capacities,t.updated)&&m.capacities.forEach(function(e){return e(t)}),n.resolve()}),n.promise}(e.updatedCapacitiesArray)),0==e.updatedGanttServicesArray.length&&0==e.deletedTimeDependencyArray.length||i.push(function(e,t){var i=o.defer();return a.getUpdatedServices(e,t).then(function(e){var t,n=[];e&&0<e.length&&(t={},0<e.length&&(t.updated=l.updateTimePhaseData(e,"service").services,n.push.apply(n,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(t.updated))))),t.updated&&m.services.forEach(function(e){return e(t)}),p.calculateKpis()),i.resolve(n)}),i.promise}(e.updatedGanttServicesArray,e.deletedTimeDependencyArray)),0!=e.updatedAbsencesArray.length&&i.push(function(e){var i=o.defer();return a.getUpdatedAbsences(e).then(function(e){var t=[],n={};0<e.length&&(e=l.updateTimePhaseData(e,"na"),n.updated=e.absences,n.deleted=e.notApprovedAbsencesIds,e=n.updated.map(function(e){return e.resource}).join(","),t.push.apply(t,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(n.updated),e))),t.push.apply(t,_toConsumableArray(u.getRelatedServices(n.deleted))),n.updated||n.deleted)&&m.absences.forEach(function(e){return e(n)}),i.resolve(t)}),i.promise}(e.updatedAbsencesArray)),0!=e.deletedAbsencesArray.length&&i.push(function(e){var i=o.defer();return a.getDeletedAbsences(e).then(function(e){var t=[],n={};0<e.length&&(n.deleted=l.deleteTimePhaseData(e,"na").absences,t.push.apply(t,_toConsumableArray(u.getRelatedServices(n.deleted))),n.updated||n.deleted)&&m.absences.forEach(function(e){return e(n)}),i.resolve(t)}),i.promise}(e.deletedAbsencesArray)),0!=e.deletedGanttServicesArray.length&&(r=[],(s=e.deletedGanttServicesArray)&&0<s.length&&((t={}).deleted=l.deleteTimePhaseData(s,"service").services,r.push.apply(r,_toConsumableArray(u.getRelatedServices(t.deleted))),t.deleted&&m.services.forEach(function(e){return e(t)}),0<r.length)&&m.rules.forEach(function(e){return e(r)}))}0!=e.deletedCapacitiesArray.length&&(s=e.deletedCapacitiesArray)&&0<s.length&&((n={}).deleted=l.deleteTimePhaseData(s,"capacity").capacities,n.deleted)&&m.capacities.forEach(function(e){return e(n)});0!=i.length&&o.all(i).then(function(e){e.forEach(function(e){var t;(t=e)&&0<t.length&&m.rules.forEach(function(e){return e(t,window.__gantt.checkRulesAfterDelta)})})})},0)),-1<e.channel.indexOf("AbsencesTopic"))try{return void("deleted"==e.data.event.type?g:v).add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("ServicesTopic"))try{return void("deleted"==e.data.event.type?f.add(e.data.sobject):S.add(e.data.sobject.Id))}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("CapacitiesTopic"))try{return void("deleted"==e.data.event.type?_.add(e.data.sobject):b.add(e.data.sobject.Id))}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("LivePositionsTopic"))try{return void y.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("AssignedResourcesTopic"))try{return void w.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("OptReqTopic"))try{return void T.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("TimeDependencyTopic"))try{"deleted"==e.data.event.type?L.add(e.data.sobject.Id):(S.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment1]),S.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment2]))}catch(e){console.log("Streaming API failure : "+e)}},register:function(e,t){return m[e]&&m[e].push(t)},unRegister:function(e,t){m[e].splice(m[e].indexOf(t),1)}}}e.$inject=["$q","sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils","kpiCalculationsService"],angular.module("serviceExpert").factory("StreamingAPIService",e)}(),!function(){function e(e,n,t,i,s){var r=["ServicesTopic","AbsencesTopic","AssignedResourcesTopic","LivePositionsTopic","CapacitiesTopic","OptReqTopic","TimeDependencyTopic"],o=!1;function a(){$.cometd.addListener("/meta/handshake",function(e){if(e.successful){console.log("Handshake successful!");try{for(var t=0;t<r.length;t++)$.cometd.getExtension(r[t])||!function(e){var t="/topic/"+e,n=new cometdReplayExtension;n.setChannel(t),n.setReplay(-1),$.cometd.registerExtension(e,n)}(r[t]),$.cometd.subscribe("/topic/"+r[t],n.HandleNotification)}catch(e){console.log(e)}o||i.setStreamingActiveState(!0)}else o=!0,i.setStreamingActiveState(!1),console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful?o||i.setStreamingActiveState(!0):(o=!0,i.setStreamingActiveState(!1),console.warn("disconnected! error: "+e.error))}),t.connectToPush()}return{initStreaming:function(){try{1==i.getStreamingActiveState()&&a()}catch(e){console.log(e)}}}}e.$inject=["$q","StreamingAPIService","MstResolver","StateService","DeltaService"],angular.module("serviceExpert").factory("StreamingClientResolverService",e)}(),!function(){function e(c,L,A,I,C,k,D,d,R){var F={initialPhasedData:c.defer(),initialStmsPhasedData:c.defer()},O={},M={},E={},x={},P={},N={},G={},B={},H={},V={},U={},t={},z={},u=!1,p=!0,j=!0,W=!0,i=!1,q={};function s(t,n){var e,i,s,r,o=c.defer(),a=("LongView"!==scheduler._mode&&(t.setDate(t.getDate()-window.daysToLoadOnGanttInit),n.setDate(n.getDate()+window.daysToLoadOnGanttInit)),0===t.getMinutes()&&0===t.getHours()||(t.setHours(0),t.setMinutes(0)),0===n.getMinutes()&&0===n.getHours()||(n.setHours(0),n.setMinutes(0),n.setDate(n.getDate()+1)),"LongView"===scheduler._mode);if("LongView"!==scheduler._mode)for(var l=new Date(t);l<n;l.setDate(l.getDate()+1))if(!U[I.formatDayToString(l)]){a=!0;break}return a?(e=c.defer(),i=c.defer(),s=[],r=c.defer(),p?A.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,t,n,window.bootstrap.loadedUserSettings.locations).then(function(e){e?(u=!0,$("#FirstTimeLoading").remove(),C.get("LeftSideLocationFilteringService").open()):r.resolve(),window.splunkLoggingFinestFlagEnabled&&A.callRemoteAction(RemoteActions.sendDataToSplunk,"rowsOnGantt",t,n,window.bootstrap.loadedUserSettings.locations,null,null)}):r.resolve(),r.promise.then(function(){Z(i,t,n,!1,!1,null,null,null),Z(e,t,n,!0,!1,null,null,null,s),Z(i,t,n,!1,!0,null,null,null),p?p=!1:A.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,t,n,window.bootstrap.loadedUserSettings.locations).then(function(e){e&&I.addNotification(customLabels.MaxedRowsReachedOnGanttNotificationTitle,customLabels.MaxedRowsReachedOnGanttNotificationBody)})}),c.all([i.promise,e.promise]).then(function(e){0<Object.keys(s).length&&"Always"===window.__gantt.checkRulesMode&&L.$broadcast("timePhasedObjectsCheckRules",s),I.hasCustomPermission("Gantt_Palettes_View")&&d.GetUserSettingsProperty("Gantt_Palette__c")&&L.$broadcast("applyPalette"),o.resolve(e)})):o.resolve(),o.promise}function Z(S,_,b,y,w,e,t,n,T){e=[_,b,y,w,e,t,n];"LongView"===scheduler._mode&&e.push(window.__currentViewOptions.minServiceDuration,window.__currentViewOptions.minNaDuration,window.__currentViewOptions.showMdt),A.GetTimePhasedObjects.apply(A,e).then(function(e){var t,n=S,i=y,s=w,r=_,o=b,a=e,l=T,c=C.get("monthlyViewHelperService"),d=C.get("GanttPalettesService"),u={resourcesAndTerritories:{},resourcesByPrimariesAndRelocations:{},resourceOperatingHours:{},serviceAppointments:{},resourceAbsences:{},resourceCapacities:{},resourcesAndShifts:{},serviceCrewMembers:{},operatingHoursAndHolidays:{},start:r,finish:o},p={};if("LongView"===scheduler._mode&&(i?(window.__gantt.reachedMaxNumberOfServicesInLongView=!!a.maxServicesInLongTermExceeded,window.splunkLoggingFinestFlagEnabled&&j&&(A.callRemoteAction(RemoteActions.sendDataToSplunk,"servicesInLongTermView",r,o,I.getFilteredLocations(),window.__currentViewOptions.minServiceDuration,window.__currentViewOptions.showMdt),j=!1)):s&&(window.__gantt.reachedMaxNumberOfAbsencesInLongView=!!a.maxAbsencesInLongTermExceeded,window.splunkLoggingFinestFlagEnabled)&&W&&(A.callRemoteAction(RemoteActions.sendDataToSplunk,"absencesInLongTermView",r,o,I.getFilteredLocations(),window.__currentViewOptions.minNaDuration,null),W=!1),updateViewDebounced()),"LongView"!==scheduler._mode)for(var m=new Date(r);m<o;m.setDate(m.getDate()+1))U[I.formatDayToString(m)]=!0;if(0===F.initialPhasedData.promise.$$state.status&&F.initialPhasedData.resolve(),a.resourcesAndTerritories.forEach(function(e){e=new ResourcesAndTerritories(e);O[e.serviceResource]=O[e.serviceResource]||{},O[e.serviceResource][e.id]=e,u.resourcesAndTerritories[e.serviceResource]=u.resourcesAndTerritories[e.serviceResource]||{},"S"!==(u.resourcesAndTerritories[e.serviceResource][e.id]=e).serviceTerritoryType&&(M[e.serviceResource]=M[e.serviceResource]||{},M[e.serviceResource][e.id]=e,u.resourcesByPrimariesAndRelocations[e.serviceResource]=u.resourcesByPrimariesAndRelocations[e.serviceResource]||{},u.resourcesByPrimariesAndRelocations[e.serviceResource][e.id]=e),"P"!==e.serviceTerritoryType&&(p[e.serviceResource]=p[e.serviceResource]||{},p[e.serviceResource][e.id]=e)}),0<Object.keys(p).length){var h,g,v={},f={};for(h in E)p[E[h].resource]&&0<Object.keys(p[E[h].resource]).length&&(v[h]=E[h]);for(g in x)p[x[g].resource]&&0<Object.keys(p[x[g].resource]).length&&(f[g]=x[g]);L.$broadcast("gotNewTimePhasedObjects",{start:r,finish:o,serviceAppointments:v,resourceAbsences:f})}a.shifts.forEach(function(e){var t=new Shift(e);N[e.ServiceResourceId]||(N[e.ServiceResourceId]={}),N[e.ServiceResourceId][I.formatDayToString(t.startTime)]||(N[e.ServiceResourceId][I.formatDayToString(t.startTime)]=[]),N[e.ServiceResourceId][I.formatDayToString(t.startTime)].push(t)}),a.holidays.forEach(function(e){var n=new Holiday(e);(e.OperatingHoursHolidays||[]).forEach(function(e){var t,e=e.OperatingHoursId;e&&(z[e]||(z[e]={}),t=I.formatDayToString(n.date),z[e][t]||(z[e][t]=[]),z[e][t].push(n))})}),a.services.forEach(function(e){var t=new GanttService(e);d.updateGanttServicePaletteColor(t),(!E[t.id]||E[t.id].isChanged(t)||E[t.id].isChainChanged(t)||E[t.id].isGotNewSTM(t))&&(E[e.Id]=t,u.serviceAppointments[e.Id]=t,q[t.assignedResource]=e.Id,l.push(t.id),monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[t.id]||scheduler._events[e.Id])&&c.updateMonthlyCapacity(t)}),a.resourceAbsences.forEach(function(e){x[e.Id]&&e.LastModifiedDate===x[e.Id].lastModifiedDate||(x[e.Id]=new ResourceAbsence(e),u.resourceAbsences[e.Id]=x[e.Id],c.updateMonthlyCapacity(x[e.Id]))}),a.resourceCapacities.forEach(function(e){P[e.Id]&&e.LastModifiedDate===P[e.Id].lastModifiedDate||(P[e.Id]=new ResourceCapacity(e),useLocationTimezone||K(P[e.Id]),u.resourceCapacities[e.Id]=P[e.Id])}),a.serviceCrewMembers.forEach(function(e){G[e.Id]=new ServiceCrewMember(e);var t,n,i=userTimeZone;if(useLocationTimezone)for(var s in O[e.ServiceResourceId]){s=O[e.ServiceResourceId][s];if("P"===s.serviceTerritoryType)i=s.timezone;else if("R"===s.serviceTerritoryType){i=s.timezone;break}}if(G[e.Id].calculateTimeZone(i),B[G[e.Id].serviceResource]||(B[G[e.Id].serviceResource]={}),H[G[e.Id].serviceCrew]||(H[G[e.Id].serviceCrew]={}),H[G[e.Id].serviceCrew][e.Id]=G[e.Id],B[G[e.Id].serviceResource][e.Id]=G[e.Id],u.serviceCrewMembers[e.Id]=G[e.Id],L.crewViewActive){for(n in V=L.currentCrewToShow)if(V[n].serviceCrew){t=V[n].serviceCrew;break}e.ServiceCrewId===t&&(V[e.ServiceResourceId]||(V[e.ServiceResourceId]=k.getResources()[e.ServiceResourceId]),void 0===V[e.ServiceResourceId].members&&(V[e.ServiceResourceId].members={}),V[e.ServiceResourceId].members[e.Id]=G[e.Id])}}),L.$broadcast("gotNewTimePhasedObjects",u),D.isLoadingNewLocations=!1,i&&a.services.length===maxServicesToLoadEachBulkInGantt?(t=a.services[a.services.length-1].Id,Z(n,r,o,i,s,t,null,null,l)):s&&a.resourceAbsences.length===maxAbsencesToLoadEachBulkInGantt?(t=a.resourceAbsences[a.resourceAbsences.length-1].Id,Z(n,r,o,i,s,null,t,null)):i||s||!a.lastQueriedShiftId?i||s||a.lastQueriedShiftId?n.resolve():L.$broadcast("gotNewTimePhasedSTMsAndShifts",u):(t=a.lastQueriedShiftId[0],Z(n,r,o,i,s,null,null,t)),y||(window.setSplashScreenTabDone("loading-timephased"),F.initialStmsPhasedData.resolve()),y&&(a=e.services.map(function(e){return e.Id}),R.isPushServiceActive()?a.length&&R.updateSession({services:a,operation:R.MESSAGE_OPERATIONS.UPDATE}):R.setCachedServices(a)),w&&(n=e.resourceAbsences.map(function(e){return e.Id}),R.isPushServiceActive()?n.length&&R.updateSession({absences:n,operation:R.MESSAGE_OPERATIONS.UPDATE}):R.setCachedAbsences(n)),D.isLoadingNewLocations&&(D.isLoadingNewLocations=!1)}).catch(function(e){var t;0===F.initialPhasedData.promise.$$state.status&&F.initialPhasedData.reject(e),console.warn("GetTimePhasedObjects: something went wrong "+e.message),I.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),0===numberOfAllowedRecoveries?(console.log("maximum allowed times to recover reached"),$("#loading-timephased")&&!i&&(e.message.startsWith("No such column")&&e.message.endsWith(". If you are attempting to use a custom field, be sure to append the '__c' after the custom field name. Please reference your WSDL or the describe call for the appropriate names.")?(t=e.message.split("'"),cantLoadGantt(customLabels.dispatcher_console_error_loading+'<div class="otherMessage">'+customLabels.Deleted_field_in_settings_crashes_the_gantt.replace("$0",t[1]).replace("$1",t[3])+"</div>")):"operatingHours"===e.type?cantLoadGantt(customLabels.dispatcher_console_error_loading+'<div class="otherMessage">'+customLabels.NoAccessToOperatingHours.replace("$0",e.message)+"</div>"):bootstrap.handleError(e),i=!0)):(numberOfAllowedRecoveries--,y?(maxServicesToLoadEachBulkInGantt=Math.round(maxServicesToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxServicesToLoadEachBulkInGantt+" SERVICES","background: #222; color: #bada55")):w?(maxAbsencesToLoadEachBulkInGantt=Math.round(maxAbsencesToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxAbsencesToLoadEachBulkInGantt+" ABSENCES","background: #222; color: #bada55")):y||(maxShiftsToLoadEachBulkInGantt=Math.round(maxShiftsToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxShiftsToLoadEachBulkInGantt+" SHIFTS","background: #222; color: #bada55")),s(_,b))})}function K(e){var t=I.getUserOffset(e.start_date),n=I.getUserOffset(e.end_date),i=r(e,e.resource);e.start_date=e.start_date.setMinutes(e.start_date.getMinutes()+t-i),e.end_date=e.end_date.setMinutes(e.end_date.getMinutes()+n-i)}function n(t,n){Object.keys(t).forEach(function(e){n&&e===n||delete t[e]})}function r(e,t){var n,i=O[t],s=null;for(n in i){var r=i[n];if(isIntersect(r.effectiveStartDate,r.effectiveEndDate,e.start_date,e.end_date)&&window.bootstrap.loadedUserSettings.locations.includes(r.serviceTerritory)&&"R"===(s=r).serviceTerritoryType)break}t=s&&s.timezone?s.timezone:"GMT";return-moment.tz.zone(t).utcOffset(I.convertDtToMomentDt(e.start_date,t).valueOf())}return{resourcesAndTerritories:function(){return O},resourcesByPrimariesAndRelocations:function(){return M},serviceAppointments:function(){return E},resourceAbsences:function(){return x},resourceCapacities:function(){return P},resourceToServiceCrewMembers:function(){return B},resourcesAndShifts:function(){return N},crewToServiceCrewMembers:function(){return H},serviceCrewMembers:function(){return G},operatingHoursAndHolidays:function(){return z},getlongVistedDates:function(){return t},getGanttSectionsIdsByTerritory:function(e,t){var n,i={};for(n in O)for(var s in O[n]){s=O[n][s];e[s.serviceTerritory]&&s.effectiveStartDate<=t&&t<=s.effectiveEndDate&&(i[s.serviceTerritory]||(i[s.serviceTerritory]={tz:s.timezone,resources:{}}),i[s.serviceTerritory].resources[n]=!0)}return i},getRelevantSTMToGanttService:function(e){if(e.resourceId){var t,n=e.resourceId.split("_")[0],i=(e.resourceId.split("_")[1],O[n]);for(t in i){var s=i[t];if(isIntersect(s.effectiveStartDate,s.effectiveEndDate,e.start_date,e.end_date))return s}}return null},getTimePhasedObjects:s,updateTimePhaseData:function(e,n){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],s=C.get("monthlyViewHelperService"),r=C.get("GanttPalettesService"),o={absences:[],notApprovedAbsencesIds:[],services:[],capacities:[]};return(e=Array.isArray(e)?e:[e]).forEach(function(e){if("na"===n){if(i||x[e.Id]&&e.LastModifiedDate===x[e.Id].lastModifiedDate)return;var t=new ResourceAbsence(e);window.isApprovedAbsencesSupported&&!t.approved&&"break"!==t.type?(x[e.Id]&&(x[e.Id].isDeleted=!0,s.updateMonthlyCapacity(x[e.Id]),delete x[e.Id]),o.notApprovedAbsencesIds.push(e.Id)):(x[e.Id]=t,o.absences.push(x[e.Id]),s.updateMonthlyCapacity(x[e.Id]))}if("service"===n&&(t=new GanttService(e),r.updateGanttServicePaletteColor(t),i||!E[t.id]||E[t.id].isChanged(t)||E[t.id].isChainChanged(t))&&(E[e.Id]=t,o.services.push(t),q[t.assignedResource]=e.Id,scheduler._events[t.id]&&scheduler._events[t.id].violations&&t.isScheduled()&&(t.violations=scheduler._events[t.id].violations),monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[t.id]||scheduler._events[e.Id])&&s.updateMonthlyCapacity(t),"capacity"===n){if(P[e.Id]&&e.LastModifiedDate===P[e.Id].lastModifiedDate)return;P[e.Id]=new ResourceCapacity(e),useLocationTimezone||K(P[e.Id]),o.capacities.push(P[e.Id])}"stm"===n&&(t=new ResourcesAndTerritories(e),O[t.serviceResource]=O[t.serviceResource]||{},"S"!==(O[t.serviceResource][t.id]=t).serviceTerritoryType)&&(M[t.serviceResource]=M[t.serviceResource]||{},M[t.serviceResource][t.id]=t)}),L.$broadcast("updateTimePhaseData",o.services),o},deleteTimePhaseData:function(e,t){var n=C.get("monthlyViewHelperService"),i={absences:[],services:[],capacities:[]};return(e=Array.isArray(e)?e:[e]).forEach(function(e){"na"===t?(x[e.Id]&&(x[e.Id].isDeleted=!0),x[e.Id]&&n.updateMonthlyCapacity(x[e.Id]),delete x[e.Id],i.absences.push(e.Id)):"service"===t?(E[e.Id]&&(E[e.Id].isDeleted=!0),n.updateMonthlyCapacity(E[e.Id]),delete E[e.Id],i.services.push(e.Id)):"capacity"===t&&(delete P[e.Id],i.capacities.push(e.Id))}),L.$broadcast("deleteTimePhaseData",i.services),i},reset:function(e){n(O),n(M),n(E,e),n(x),n(P),n(G),n(N),n(V),n(B),n(H),n(U),n(t),n(z),n(q)},getResoruceGanttIdByDate:function(e,t){for(var n in O[e]){n=O[e][n];if(n.effectiveStartDate<=t&&t<=n.effectiveEndDate&&"R"===n.serviceTerritoryType)return I.generateResourceId(e,n.serviceTerritory)}var i,s=[];for(i in O[e]){var r=O[e][i];if(!showSecondarySTMs&&r.effectiveStartDate<=t&&t<=r.effectiveEndDate&&"P"===r.serviceTerritoryType)return I.generateResourceId(e,r.serviceTerritory);r.effectiveStartDate<=t&&t<=r.effectiveEndDate&&s.push(r.serviceTerritory)}return 0<s.length?I.generateResourceId(e,s):null},getResoruceGanttIdByDateAndTerritory:function(e,t,n){for(var i in O[e]){i=O[e][i];if(i.effectiveStartDate<=t&&t<=i.effectiveEndDate&&"R"===i.serviceTerritoryType)return I.generateResourceId(e,i.serviceTerritory)}var s,r=null,o=null;for(s in O[e]){var a=O[e][s];a.effectiveStartDate<=t&&t<=a.effectiveEndDate&&"P"===a.serviceTerritoryType&&(o=a.serviceTerritory),a.effectiveStartDate<=t&&t<=a.effectiveEndDate&&a.serviceTerritory===n&&(r=a.serviceTerritory)}return r?I.generateResourceId(e,r):I.generateResourceId(e,o)},getIntersectingSrstOffset:r,isTimephaseAvailable:function(e,t){var n,i=!1;for(n in O[e]){var s=O[e][n];isIntersect(t,t,s.effectiveStartDate,s.effectiveEndDate)&&(i=!0)}return i},isResourceRelocated:function(e,t){var n,i=e.split("_")[0],s=e.split("_")[1],r=O[i]||{};for(n in r){var o=r[n];if(o.serviceTerritory!==s&&"R"===o.serviceTerritoryType&&isIntersect(o.effectiveStartDate,o.effectiveEndDate,t,t))return!0}return!1},isResourceSecondary:function(e,t){var n,i=e.split("_")[0],s=e.split("_")[1],r=O[i]||{};for(n in r){var o=r[n];if(o.serviceTerritory===s&&"S"===o.serviceTerritoryType&&isIntersect(o.effectiveStartDate,o.effectiveEndDate,t,t))return!0}return!1},isResourceCrewMembers:function(e,t){var n,i=e.split("_")[0],s=(e.split("_")[1],B[i]||{});for(n in s){var r=s[n];if(isIntersect(r.tzStartDate,r.tzEndDate,t,t))return!0}return!1},isCrewViewActive:!1,selectedCrewIdToShow:null,currentCrewToShow:V,reachedMaxRows:function(){return u},resetReachedMaxRows:function(e){return u=!1},promises:{initialPhasedData:F.initialPhasedData.promise,initialStmsPhasedData:F.initialStmsPhasedData.promise},updateObjectsForOptimizationViewer:function(e){E=e.serviceAppointments,O=e.resourcesAndTerritories,x=e.resourceAbsences,N=e.resourcesAndShifts,G=e.serviceCrewMembers,H=e.crewToServiceCrewMembers,B=e.resourceToServiceCrewMembers},isOptimizationViewer:function(){return L.isOptimizationViewer},setResourceCapacityOffset:K,assignedResourceIdToServiceIdMap:function(){return q},setAssignedResourceIdToServiceIdMap:function(e,t){q[e]=t}}}e.$inject=["$q","$rootScope","sfdcService","utils","$injector","ResourcesAndTerritoriesService","StateService","userSettingsManager","PushServices"],angular.module("serviceExpert").factory("TimePhasedDataService",e)}(),!function(){function e(m,h,g){var v={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};return{calculateKpis:function(){var e,t=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),n=0;for(e in v)v[e]=0;for(var i=g.GetUserSettingsProperty("locations"),s=0;s<t.length;s++){var r,o,a=t[s],l=!0;if(showSecondarySTMs&&-1<t[s].resourceId.indexOf(",")){for(var c=t[s].resourceId.split(","),d=null,u=0;u<c.length;u++){var p=c[u].split("_")[1];if(-1<i.indexOf(p)){d=p;break}}if(!d)continue}else if(-1===i.indexOf(t[s].resourceId.split("_")[1]))continue;"na"!==a.type&&"break"!==a.type||(v.avgTravelTime+=a.travelTo+a.travelFrom),"service"===a.type&&(m.areContractorsSupported()&&a.resourceContractor?l=!1:n++,v.total++,a.statusCategory===h.COMPLETED&&v.completed++,a.violations&&v.violations++,a.jeopardy&&v.jeopardy++,l&&(a.isMDT?(r=0,a.mdtTimes.travel.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(r+=e.Finish-e.Start)}),v.avgTravelTime+=r/1e3):v.avgTravelTime+=a.travelTo+a.travelFrom),a.isMDT?(o=0,a.mdtTimes.working.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(o+=e.Finish-e.Start)}),v.totalScheduledDuration+=o/1e3):v.totalScheduledDuration+=(a.finish-a.start)/1e3)}0<t.length&&0<v.total&&0<n?m.areContractorsSupported()?v.avgTravelTime=Math.floor(v.avgTravelTime/60/n):v.avgTravelTime=Math.floor(v.avgTravelTime/60/v.total):v.avgTravelTime=0},kpis:v}}e.$inject=["StateService","SERVICE_CATEGORY","userSettingsManager"],angular.module("serviceExpert").factory("kpiCalculationsService",e)}(),!function(){function e(u,n,t,i,l,s,a,e,r){var p={regular:0,overtime:0},m={},h={},g={services:!0,na:!0,travel:!0,breaks:!0,overtime:!0},c=r.isRtlDirection();if(e.GetUserSettingsProperty("Utilization_Properties__c")){var o,d=JSON.parse(e.GetUserSettingsProperty("Utilization_Properties__c"));for(o in d)g[o]=d[o]}function v(e){if(-1<e.resourceId.indexOf(","))for(var t=e.resourceId.split(","),n=0;n<t.length;n++)m[t[n]]=m[t[n]]||{};else m[e.resourceId]=m[e.resourceId]||{};var i={start:new Date(e.start_date),finish:new Date(e.start)},s={start:new Date(e.start),finish:new Date(e.finish)},r={start:new Date(e.finish),finish:new Date(e.end_date)};return{travelBeforeSum:e.isMDT?f(e.mdtTimes.travel):f(i.start,i.finish),scheduledObjectSum:e.isMDT?f(e.mdtTimes.working):f(s.start,s.finish),travelAfterSum:e.isMDT?{}:f(r.start,r.finish)}}function f(e,i){var s={};if(i)for(var t=new Date(e);t<i;t=b(t)){var n=b(t),n=i<n?i:n;s[S(t)]=Math.round((n.getTime()-t.getTime())/1e3/60)}else e.forEach(function(e){i=new Date(e.Finish);for(var t=new Date(e.Start);t<i;t=b(t)){var n=b(t),n=i<n?i:n;s[S(t)]?s[S(t)]+=Math.round((n.getTime()-t.getTime())/1e3/60):s[S(t)]=Math.round((n.getTime()-t.getTime())/1e3/60)}});return s}function S(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function b(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0,0,0)}function y(e,t,n,i,s){for(var r,o=!(4<arguments.length&&void 0!==s)||s,a=t.split(","),l=0;l<a.length;l++)for(var c in t=a[l],n)m[t]=m[t]||{},void 0===m[t][c]&&(m[t][c]=new w),o?(m[t][c][i]+=n[c],-1===m[t][c].events.indexOf(e)&&m[t][c].events.push(e)):(m[t][c][i]-=n[c],-1<(r=m[t][c].events.indexOf(e))&&m[t][c].events.splice(r,1))}function w(){this.break=0,this.na=0,this.service=0,this.travel=0,this.capacity=-1,this.overtime=0,this.events=[]}function T(e,t){for(var n=new w,i=S(t),s=n.capacity=0;s<e.length;s++){var r,o=null,a=e[s].key;contractorSupport&&e[s].contractor||l.isResourceRelocated(a,t)||l.isResourceCrewMembers(a,t)||l.isResourceSecondary(a,t)||(m[a]||(m[a]={}),(o=m[a][i]?m[a][i]:o)||(m[a][i]=new w,o=m[a][i]),o.capacity,r=p,u.resourceToWorkingDates[a]&&u.resourceToWorkingDates[a][i]&&(r=u.resourceToWorkingDates[a][i]),o&&(n.break+=o.break,n.na+=o.na>r.regular?r.regular:o.na,n.service+=o.service,n.travel+=o.travel,n.capacity+=-1<r.regular?r.regular:0,n.overtime+=r.overtime))}return n}function L(e){var t=e%60;return{hours:Math.floor(e/60),minutes:t=t<10?"0"+t:t}}function A(e){return e.hours+"h "+e.minutes+"m"}function I(e,t,n){var i,n=2<arguments.length&&void 0!==n?n:p;e.service&&(i=L(e.service),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg>\n                        '+A(i)+"\n                        <div>"+customLabels.TotalScheduled+"</div>\n                    </div>"),e.travel&&(i=L(e.travel),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>\n                        '+A(i)+"\n                        <div>"+customLabels.TotalTravel+"</div>\n                    </div>"),e.na&&(i=L(e.na),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.na+'"></use></svg>\n                        '+A(i)+"\n                        <div>"+customLabels.TotalNAs+"</div>\n                    </div>"),e.break&&(i=L(e.break),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.coffee+'"></use></svg>\n                        '+A(i)+"\n                        <div>"+customLabels.TotalBreaks+"</div>\n                    </div>");return n.regular&&(e=L(n.regular),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.bucket+'"></use></svg>\n                        '+A(e)+"\n                        <div>"+customLabels.TotalCapacity+"</div>\n                    </div>"),n.overtime&&(i=L(n.overtime),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_overtime_icon"><use xlink:href="'+lsdIcons.overtime+'"></use></svg>\n                        '+A(i)+"\n                        <div>"+customLabels.TotalOvertime+"</div>\n                    </div>"),t}return scheduler.attachEvent("onSchedulerReady",function(){scheduler.attachEvent("onXScaleClick",function(e,t,n){"MonthlyView"===scheduler._mode&&scheduler.setCurrentView(t,"ZoomLevel3")}),scheduler.templates.MonthlyView_scalex_class=function(e){return"monthlyXScale"},scheduler.templates.MonthlyView_cell_value=function(e,t){var n=t.key;if(!contractorSupport||!t.contractor){if(t.children)return l=T(t.children,e),h[t.key]||(h[t.key]={}),l=h[t.key][S(e)]=l,i=t.key,s=t.name,o=S(e),a=0,g.services&&(a+=l.service),g.breaks&&(a+=l.break),g.na&&(a+=l.na),g.travel&&(a+=l.travel),0<(c=g.overtime?l.capacity+l.overtime:l.capacity)?(a=a/c,a=Math.round(100*a),d="",d=a<=monthlyViewSettings.high?"style='box-shadow: inset 0 -2px 0 rgb(24, 165, 146)'":monthlyViewSettings.high<a&&a<=monthlyViewSettings.critical?"style='box-shadow: inset 0 -2px 0 #FFEB3B'":"style='box-shadow: inset 0 -2px 0 rgb(236, 95, 84)'",r="",l.travel/c>monthlyViewSettings.highTravel/100&&(r='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),"<div "+d+' onmouseout="removeMonthlyLocationTooltip()" onmouseover="createLocationMonthlyTooltip(event,\''+i+"', '"+s.encodeHTML()+"', '"+o+"')\">"+r+'<div class="monthlyViewHoursContainer">'+a+"%</div></div>"):"";if(m[n]&&m[t.key][S(e)]){var i,s,r,o,a,l=0,c=m[n][S(e)],d=p;if(u.resourceToWorkingDates[n]&&(d=u.resourceToWorkingDates[n][S(e)]||p),g.services&&(l+=c.service),g.breaks&&(l+=c.break),g.na&&(i=c.na,l+=i=c.na>d.regular?d.regular:i),g.travel&&(l+=c.travel),0!==l)return o=s=void 0,0<(r=g.overtime?d.regular+d.overtime:d.regular)?(o=Math.round(100*(o=l/r)),a="",c.travel/r>monthlyViewSettings.highTravel/100&&(a='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),s="",s=o<=monthlyViewSettings.high?"rgba(125, 195, 125, "+o/100+")":monthlyViewSettings.high<o&&o<=monthlyViewSettings.critical?"rgba(242, 207, 91, "+(.11+o/100*.65)+")":"rgba(239, 110, 100, "+(.11+o/100*.65)+")",'<div class="utilz-container" onclick="createMonthlyTooltip(event, \''+n+"', '"+S(e)+'\')" style="background: '+s+'">'+a+'<div class="monthlyViewHoursContainer">'+o+"%</div></div>"):(s="rgba(239, 110, 100, 1)",'<div class="utilz-container" onclick="createMonthlyTooltip(event, \''+n+"', '"+S(e)+'\')" style="background: '+s+'"><div class="monthlyViewHoursContainer"><i class="fa fa-ban"></i></div></div>')}}}}),window.createLocationMonthlyTooltip=function(e,t,n,i){$("#MonthlyLocationViewTooltip").remove(),$("#MonthlyViewTooltip").remove();var t=h[t][i],t=I(t,"",{regular:t.capacity,overtime:t.overtime}),i=i.split("_"),i=new Date(i[2],i[1],i[0],0,0,0,0),s=(i=moment(i).format("ll"),window.innerHeight),r=e.clientX+340<=window.innerWidth?e.clientX:e.clientX-340,n=($('<div id="MonthlyLocationViewTooltip">\n                    <h1>'+_.escape(n)+" - "+_.escape(i)+'</h1>\n                    <div id="CapacityIconsContainer">'+t+"</div>\n               </div>").css("left",r+"px").css("top",e.clientY+5+"px").appendTo("body"),$("#MonthlyViewTooltip")),i=n.height();i+e.clientY>s&&n.css("top",e.clientY-i-20+"px"),c&&$("#MonthlyLocationViewTooltip").addClass("rtlDirection")},window.removeMonthlyLocationTooltip=function(){$("#MonthlyLocationViewTooltip").remove()},window.createMonthlyTooltip=function(e,t,n){e.stopPropagation(),$("#MonthlyViewTooltip").remove(),$("#MonthlyLocationViewTooltip").remove();var i=a.getResources()[t.split("_")[0]].name,s=m[t][n],r=p,r=(t=I(s,"",r=u.resourceToWorkingDates[t]&&u.resourceToWorkingDates[t][n]?u.resourceToWorkingDates[t][n]:r),s.events.sort(function(e,t){return scheduler._events[e].start_date.getTime()>scheduler._events[t].start_date.getTime()?-1:scheduler._events[e].start_date.getTime()<scheduler._events[t].start_date.getTime()?1:0}).map(function(e){var t="",n="",i=(scheduler._events[e]&&"service"===scheduler._events[e].type?(t="__monthlyViewFunctions.service('"+e+"')",n="<div onclick=\"__monthlyViewFunctions.flag(event, '"+e+'\')" class="monthlyViewFlag truncate">'+(flaggedServices[e]?customLabels.Unflag:customLabels.Flag)+"</div>"):t="__monthlyViewFunctions.absence('"+e+"')"," "),s=(i=(i+=scheduler._events[e]&&scheduler._events[e].jeopardy?"monthlyView_JeopardyTooltip":"")+(scheduler._events[e]&&scheduler._events[e].violations&&!scheduler._events[e].jeopardy?"monthlyView_ViolationsTooltip":""),""),r=(scheduler._events[e]&&"break"!==scheduler._events[e].type&&(s=""+A(L(s=Math.floor((scheduler._events[e].travelTo+scheduler._events[e].travelFrom)/60))),s='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg> '+s),Math.floor((scheduler._events[e].finish-scheduler._events[e].start)/1e3/60)),r=""+A(L(r)),o=(r='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg> '+r,""===s?"mytooltip_breakfix":"");return'\n                        <div class="'+i+' monthlyView_TooltipEventRow" title="'+(i=scheduler._events[e],customLabels.Start)+": "+moment(i.start).format("llll")+"\n"+customLabels.Finish+": "+moment(i.finish).format("llll")+'">\n                            <div class="monthlyView_EventName" onclick="'+t+'">'+scheduler._events[e].name+'</div>\n                            <div class="monthlyView_EventDate"><span class="mytooltip_duration '+o+'">'+r+'</span><span class="mytooltip_travel">'+s+"</span>"+n+"</div>\n                        </div>"})),s=n.split("_"),s=new Date(s[2],s[1],s[0],0,0,0,0),n=(s=moment(s).format("ll"),window.innerHeight),o=e.clientX+340<=window.innerWidth?e.clientX:e.clientX-340,i=($('<div id="MonthlyViewTooltip">\n                    <h1>\n                        '+_.escape(i)+" - "+s+'\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.close+'"></use></svg>\n                    </h1>\n                    <div id="CapacityIconsContainer">'+t+'</div>\n                    <div id="MonthlyTooltipListContainer">'+r.join("")+"</div>\n               </div>").css("left",o+"px").css("top",e.clientY+5+"px").appendTo("body"),$("#MonthlyViewTooltip")),s=i.height();s+e.clientY>n&&i.css("top",e.clientY-s-20+"px"),c&&$("#MonthlyViewTooltip").addClass("rtlDirection")},$("body").on("click",function(){$("#MonthlyViewTooltip").remove()}),window.__monthlyViewFunctions={service:function(e){i.open(e)},absence:function(e){t.open(e)},flag:function(e,t){e.currentTarget.innerHTML=e.currentTarget.innerHTML===customLabels.Flag?customLabels.Unflag:customLabels.Flag,e.stopPropagation(),n.$broadcast("flagService",t),n.$apply()}},{updateMonthlyCapacity:function(e){var t,n,i;e&&(e.setGanttResource(l.resourcesAndTerritories(),s.generateResourceId),i=scheduler._events[e.id],t=null,!e.resourceId&&!i||e.isMDT&&!e.mdtTimes||(i&&(n=v(i.eventBeforeDrag||i),i.eventBeforeDrag&&(i.eventBeforeDrag=null),"service"===e.type||"na"===e.type?(t=i.resourceName===e.resourceName?e.resourceId:i.resourceBeforeDrag||i.resourceId,i.resourceBeforeDrag=null):"break"===e.type&&(t=i.resourceId),y(i.id,t,n.travelBeforeSum,"travel",!1),y(i.id,t,n.scheduledObjectSum,i.type,!1),y(i.id,t,n.travelAfterSum,"travel",!1)),!e.resourceId||e.isDeleted||e.locationRemovedMe?e.locationRemovedMe&&(e.locationRemovedMe=!1):(i=v(e),y(e.id,e.resourceId,i.travelBeforeSum,"travel"),y(e.id,e.resourceId,i.scheduledObjectSum,e.type),y(e.id,e.resourceId,i.travelAfterSum,"travel"))))},capacityCalculationFields:g,workingTimesByLocation:h,calculateLocation:T,calculateLocationUtilization:function(e){var t=0;return g.services&&(t+=e.service),g.breaks&&(t+=e.break),g.na&&(t+=e.na),g.travel&&(t+=e.travel),0<(e=g.overtime?e.capacity+e.overtime:e.capacity)?(t=t/e,Math.round(100*t)):null},calculateDailyResourceCapacity:function(e,t){var n=new w,i=null,s=S(t),r=e.key;return n.capacity=0,contractorSupport&&e.contractor||l.isResourceRelocated(r,t)||l.isResourceCrewMembers(r,t)||l.isResourceSecondary(r,t)||(m[r]||(m[r]={}),(i=m[r][s]?m[r][s]:i)||(m[r][s]=new w,i=m[r][s]),e=p,u.resourceToWorkingDates[r]&&u.resourceToWorkingDates[r][s]&&(e=u.resourceToWorkingDates[r][s]),i&&(n.break+=i.break,n.na+=i.na>e.regular?e.regular:i.na,n.service+=i.service,n.travel+=i.travel,n.capacity+=-1<e.regular?e.regular:0,n.overtime+=e.overtime)),n},reset:function(){m={},h={}}}}e.$inject=["calendarsService","$rootScope","AbsenceLightboxService","ServiceAppointmentLightboxService","TimePhasedDataService","utils","ResourcesAndTerritoriesService","userSettingsManager","StateService"],angular.module("serviceExpert").factory("monthlyViewHelperService",e)}(),!function(){var c=7500;angular.module("MstResolver",[]).provider("MstResolver",function(){var l={fslOperationRemoteAction:null,getAsyncApexJobRemoteAction:null,apiVersion:"61.0",fieldNames:{Initiator:"Initiator__c",Request_Type:"Request_Type__c",ResultText:"ResultText__c"},autoConnect:!0};this.setConfig=function(e){return l=e},this.$get=function(e){var t=e,r=l,o={},n={},i=-1;function s(){$.cometd.addListener("/meta/handshake",function(e){var t;e.successful?(console.log("Handshake successful!"),null==$.cometd.getExtension("myReplayExtensionName")&&((t=new cometdReplayExtension).setChannel("/topic/MstCompletedChannel"),t.setReplay(i),$.cometd.registerExtension("myReplayExtensionName",t)),$.cometd.subscribe("/topic/MstCompletedChannel",a)):console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful||console.warn("disconnected! msg: "+e)});$.cometd.init({url:window.location.protocol+"//"+window.location.hostname+(null!=window.location.port?":"+window.location.port:"")+"/cometd/"+r.apiVersion+"/",requestHeaders:{Authorization:"OAuth "+sessionId}})}function a(e){var t;"deleted"!==e.data.event.type&&(console.info("message from stream, type: "+e.data.event.type+", replayId: "+e.data.event.replayId+", fslOp: "+e.data.sobject.Id),i=e.data.event.replayId,n[e.data.sobject.Id]=e,t=o[e.data.sobject.Id])&&t.deferred.resolve(e)}try{r.autoConnect&&s()}catch(e){console.log(e)}return{getUpdates:function(e){o[e]={time:(new Date).getTime()-3e3,deferred:t.defer(),mstPromise:t.defer(),asyncMethodCheckerTimeout:null,gotReply:!1};var s=o[e];return o[e].deferred.promise.then(function(e){r.fslOperationRemoteAction&&Visualforce.remoting.Manager.invokeAction(r.fslOperationRemoteAction,s.time,e.data.sobject.Id,function(e,t){if(t.status&&!e.fslOperation.fslOperation[r.fieldNames.ResultText]){if(e.fslOperation.result&&(e.fslOperation.result=JSON.parse(e.fslOperation.result)),"Get Candidates"===e.fslOperation.fslOperation[r.fieldNames.Request_Type]){var n,i=e.fslOperation.result.ResourceIDToScheduleData;for(n in i)i[n].SchedulingOptions.forEach(function(e){for(var t in e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf(),e.MSTOptions)e.MSTOptions[t].Interval.Start=moment(e.MSTOptions[t].Interval.Start).valueOf(),e.MSTOptions[t].Interval.Finish=moment(e.MSTOptions[t].Interval.Finish).valueOf()})}"Appointment Booking"===e.fslOperation.fslOperation[r.fieldNames.Request_Type]&&e.fslOperation.result.Slots.forEach(function(e){e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf()}),s.mstPromise.resolve(e)}else e&&e.fslOperation&&e.fslOperation.fslOperation?s.mstPromise.reject(e.fslOperation.fslOperation[r.fieldNames.ResultText]):s.mstPromise.reject(t);s.gotReply=!0},{buffer:!1,escape:!1,timeout:12e4})}),n[e]&&(s.deferred.resolve(n[e]),delete n[e]),o[e].asyncMethodCheckerTimeout=setInterval(function(){var n,i;i=o[n=e],Visualforce.remoting.Manager.invokeAction(r.getAsyncApexJobRemoteAction,n,function(e,t){e?("Aborted"!==e.Status&&"Failed"!==e.Status||(i.gotReply||i.mstPromise.reject({message:e.ExtendedStatus}),clearInterval(i.asyncMethodCheckerTimeout)),"Completed"===e.Status&&(i.deferred.resolve({data:{sobject:{Id:n}}}),clearInterval(i.asyncMethodCheckerTimeout))):(clearInterval(i.asyncMethodCheckerTimeout),t.status||(t.xhr&&"communication failure"===t.xhr.statusText?i.mstPromise.reject({message:t.message}):i.mstPromise.reject({message:customLabels.wentWrongContactSysAdmin}),console.log(t)))})},c),o[e].mstPromise.promise},connectToPush:s,handleCometdConnection:a}},this.$get.$inject=["$q"]})}(),GanttService.prototype.setSchedulerProperties=function(){var e,t={schedStartTime:"start",schedEndTime:"finish",dueDate:"dueDate",earliestStartTime:"earlyStart",arrivalWindowStartTime:"appStart",arrivalWindowEndTime:"appEnd",actualStartTime:"actualStartTime",actualEndTime:"actualEndTime",ganttDisplay:"ganttDisplay"};for(e in t)this[t[e]]=__setTimeZoneOffsetToDateField(this[e]);this.type="service",this.travelTo=this.travelTimeTo?60*parseInt(this.travelTimeTo):0,this.travelFrom=this.travelTimeFrom?60*parseInt(this.travelTimeFrom):0,this.estDuration=this.estDuration?parseFloat(this.estDuration):null,this.text=this.ganttLabel?this.ganttLabel.encodeHTML():this.name},GanttService.prototype.setGanttResource=function(e,t){if(this.isScheduled()){var n,i=e[this.resource],s=[];for(n in this.resourceId=null,this.start_date=__setTimeZoneOffsetToDateField(this.schedStartTime),this.end_date=__setTimeZoneOffsetToDateField(this.schedEndTime),i){var r=i[n];"R"===r.serviceTerritoryType&&(isDateIntersectRange(this.start_date,r.effectiveStartDate,r.effectiveEndDate)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}if(0===s.length)for(var o in i){o=i[o];isDateIntersectRange(this.start_date,o.effectiveStartDate,o.effectiveEndDate)&&s.push(o.serviceTerritory)}else if(showSecondarySTMs)for(var a in i){a=i[a];"S"===a.serviceTerritoryType&&isDateIntersectRange(this.start_date,a.effectiveStartDate,a.effectiveEndDate)&&s.push(a.serviceTerritory)}this.resourceId=t(this.resource,s),this.isScheduled()&&this.updateDatesBasedOnTravel()}},GanttService.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds||(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds),this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60))),this.travelTo)&&(this.travelTo<=maxTravelTimeInSeconds||(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds),this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)))},GanttService.prototype.isScheduled=function(){return this.resource&&this.schedEndTime&&this.schedStartTime},GanttService.prototype.getGanttResource=function(e){return e&&getGanttResourceWithSecondaryStms(this),this.resourceId&&this.resourceId.substr(0,18)},GanttService.prototype.getGanttTerritory=function(){return this.resourceId&&this.resourceId.substr(19,37)},GanttService.prototype.isChanged=function(e){return this.AssignedResourceLastModifiedDate!=e.AssignedResourceLastModifiedDate||this.ServiceAppointmentLastModifiedDate!=e.ServiceAppointmentLastModifiedDate},GanttService.prototype.isGotNewSTM=function(e){return""===this.resourceId&&e.resource},GanttService.prototype.isChainChanged=function(e){return this.isServiceInChain!=e.isServiceInChain||this.relatedService1!=e.relatedService1||this.relatedService2!=e.relatedService2},GanttService.prototype.minPriority=1e6,GanttService.copy=function(e){var t=new GanttService(null,!0);return angular.merge(t,e),t},GanttService.prototype.calculateMdtTimes=function(e){try{this.mdtTimes=JSON.parse(e);var i=1e3*(new Date).getTimezoneOffset()*60,s={travel:[],working:[]};this.mdtTimes.forEach(function(e){var t=moment.tz(e.Start,userTimeZone),n=moment.tz(e.Finish,userTimeZone),t=new Date(t.valueOf()+60*t._offset*1e3+i),n=new Date(n.valueOf()+60*n._offset*1e3+i);e.Start=t,e.Finish=n,"OperationalSlot"===e.Type?s.working.push(e):"Travel"===e.Type&&s.travel.push(e)}),this.mdtTimes=s}catch(e){this.mdtTimes={travel:[],working:[]}}},GanttService.prototype.hideTravelForResize=function(){this.backupDatesForResize={start_date:this.start_date,end_date:this.end_date,travelFrom:this.travelFrom,travelTo:this.travelTo},this.start_date=this.start,this.end_date=this.finish,this.travelFrom=0,this.travelTo=0},GanttService.prototype.restoreTravelForResize=function(){this.start_date=this.backupDatesForResize.start_date,this.end_date=this.backupDatesForResize.end_date,this.travelFrom=this.backupDatesForResize.travelFrom,this.travelTo=this.backupDatesForResize.travelTo},GanttService.prototype.wasSchedulingChanged=function(e){return this.AssignedResourceLastModifiedDate!=e.AssignedResourceLastModifiedDate||this.schedStartTime!=e.Fields.SchedStartTime||this.schedEndTime!=e.Fields.SchedEndTime||this.isServiceInChain!==e.isServiceInChain},window.Holiday=function(e){var t;this.id=e.Id,this.holidayId=e.Id,this.name=e[fieldNames.Holiday.Name],this.description=e[fieldNames.Holiday.Description],this.activityDate=e[fieldNames.Holiday.ActivityDate],this.nextOccurrenceDate=e[fieldNames.Holiday.NextOccurrenceDate],this.isAllDay=e[fieldNames.Holiday.IsAllDay],this.isRecurrence=e[fieldNames.Holiday.IsRecurrence],this.startTimeInMinutes=e[fieldNames.Holiday.StartTimeInMinutes],this.endTimeInMinutes=e[fieldNames.Holiday.EndTimeInMinutes],this.recurrenceType=e[fieldNames.Holiday.RecurrenceType],this.recurrenceInterval=e[fieldNames.Holiday.RecurrenceInterval],this.recurrenceStartDate=e[fieldNames.Holiday.RecurrenceStartDate],this.recurrenceEndDateOnly=e[fieldNames.Holiday.RecurrenceEndDateOnly],this.recurrenceDayOfMonth=e[fieldNames.Holiday.RecurrenceDayOfMonth],this.recurrenceDayOfWeekMask=e[fieldNames.Holiday.RecurrenceDayOfWeekMask],this.recurrenceMonthOfYear=e[fieldNames.Holiday.RecurrenceMonthOfYear],this.isRecurrence?(t=60*(e=new Date(this.nextOccurrenceDate)).getTimezoneOffset()*1e3,this.date=new Date(e.getTime()+t)):(e=60*new Date(this.activityDate).getTimezoneOffset()*1e3,this.date=new Date(this.activityDate+e))},!function(e){var a={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};e.TimeSlot=function(e){this.startHour=Math.floor(e[fieldNames.TimeSlot.StartTime]/1e3/60/60),this.startMinute=Math.ceil(e[fieldNames.TimeSlot.StartTime]/1e3/60/60%1*60),this.endHour=Math.floor(e[fieldNames.TimeSlot.EndTime]/1e3/60/60),this.endMinute=Math.ceil(e[fieldNames.TimeSlot.EndTime]/1e3/60/60%1*60),this.type=e[fieldNames.TimeSlot.Type],0==this.endHour&&(this.endHour=24)},e.TimeSlotOptiViewer=function(e){this.startHour=parseInt(e[fieldNames.TimeSlot.StartTime].split(":")[0]),this.startMinute=parseInt(e[fieldNames.TimeSlot.StartTime].split(":")[1]),this.endHour=parseInt(e[fieldNames.TimeSlot.EndTime].split(":")[0]),this.endMinute=parseInt(e[fieldNames.TimeSlot.EndTime].split(":")[1]),this.type=e[fieldNames.TimeSlot.Type],0==this.endHour&&(this.endHour=24)},e.OperatingHours=function(e){this.id=e.Id,this.name=e.Name,this.timezone=e[fieldNames.OperatingHours.Timezone],this.slots={};for(var t=(t=e[fieldNames.OperatingHours.Time_Slots__r])||[],n=0;n<t.length;n++){var i=t[n],s=i[fieldNames.TimeSlot.DayOfWeek],r=this.slots[s=a[s]];r||(this.slots[s]=r=[]),r.push(new TimeSlot(i))}},e.OperatingHoursOptiViewer=function(e,t){this.id=e.Id,this.name=e.Id,this.timezone=e[fieldNames.OperatingHours.Timezone],this.slots={};for(var n=(n=t)||[],i=0;i<n.length;i++){var s,r=n[i],o=r[fieldNames.TimeSlot.DayOfWeek],o=a[o];r.OperatingHoursId===this.id&&((s=this.slots[o])||(this.slots[o]=s=[]),s.push(new TimeSlotOptiViewer(r)))}}}(window),ResourceAbsence.prototype.setSchedulerProperties=function(){this.start=__setTimeZoneOffsetToDateField(this.start),this.finish=__setTimeZoneOffsetToDateField(this.end),this.end=__setTimeZoneOffsetToDateField(this.end)},ResourceAbsence.prototype.setGanttResource=function(e,t){var n={},i=[];if(this.resourceId=null,e[this.resource]&&(n=sortByServiceTerritoryType(e[this.resource])),this.isScheduled()){this.start_date=this.start?new Date(this.start.getTime()):null,this.end_date=this.finish?new Date(this.finish.getTime()):null;var s,r=!1;for(s in n){var o=n[s],r=!1;"R"===o.serviceTerritoryType&&(isIntersect(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.end_date)||!o.effectiveEndDate&&o.effectiveStartDate<this.end_date)&&((this.end_date>o.effectiveEndDate&&this.start_date<o.effectiveEndDate||this.start_date<o.effectiveStartDate&&this.end_date>o.effectiveStartDate)&&(r=!0),i.includes(o.serviceTerritory)||i.push(o.serviceTerritory))}if(0===i.length||r)for(var a in n){a=n[a];!(isIntersect(a.effectiveStartDate,a.effectiveEndDate,this.start_date,this.end_date)||!a.effectiveEndDate&&a.effectiveStartDate<this.end_date)||i.includes(a.serviceTerritory)||i.push(a.serviceTerritory)}else if(showSecondarySTMs)for(var l in n){l=n[l];"S"!==l.serviceTerritoryType||!(isIntersect(l.effectiveStartDate,l.effectiveEndDate,this.start_date,this.end_date)||!l.effectiveEndDate&&l.effectiveStartDate<this.end_date)||i.includes(l.serviceTerritory)||i.push(l.serviceTerritory)}this.resourceId=t(this.resource,i),this.isScheduled()&&this.updateDatesBasedOnTravel()}},ResourceAbsence.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds||(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds),this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60))),this.travelTo)&&(this.travelTo<=maxTravelTimeInSeconds||(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds),this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)))},ResourceAbsence.prototype.isScheduled=function(){return!!this.resource},ResourceAbsence.prototype.getGanttResource=function(){return this.resourceId&&this.resourceId.substr(0,18)},ResourceAbsence.prototype.hideTravelForResize=function(){this.backupDatesForResize={start_date:this.start_date,end_date:this.end_date,travelFrom:this.travelFrom,travelTo:this.travelTo},this.start_date=this.start,this.end_date=this.finish,this.travelFrom=0,this.travelTo=0},ResourceAbsence.prototype.restoreTravelForResize=function(){this.start_date=this.backupDatesForResize.start_date,this.end_date=this.backupDatesForResize.end_date,this.travelFrom=this.backupDatesForResize.travelFrom,this.travelTo=this.backupDatesForResize.travelTo},ResourceAbsence.prototype.wasSchedulingChanged=function(e){var t=window.fieldNames.ResourceAbsence.EstTravelTime__c,n=window.fieldNames.ResourceAbsence.EstTravelTimeFrom__c,i=__setTimeZoneOffsetToDateField(e.Start).getTime(),s=__setTimeZoneOffsetToDateField(e.End).getTime();return this.start.getTime()!==i||this.end.getTime()!==s||this.resource!==e.ResourceId||this.travelTo!==e[t]||this.travelFrom!==e[n]},ResourceCapacity.prototype.setSchedulerProperties=function(){switch(this.start_date=__setTimeZoneOffsetToDateField(this.start),this.end_date=__setTimeZoneOffsetToDateField(this.end),this.timePeriod){case"Day":this.end_date=addDaysToDate(this.start_date,1);break;case"Week":this.end_date=addDaysToDate(this.start_date,7);break;case"Month":this.end_date=addDaysToDate(this.end_date,1)}0!==this.end_date.getHours()&&(20<this.end_date.getHours()&&(this.end_date=addDaysToDate(this.end_date,1)),this.end_date.setHours(0)),void 0===this.minutesUsed&&void 0===this.workItemsAllocated?0<this.hoursPerTimePeriod&&0<this.workItemsPerTimePeriod?this.text="<b>"+customLabels.maximum_service_appointments_and_hours_allowed.replaceAll(this.workItemsPerTimePeriod,this.hoursPerTimePeriod)+"</b>":0===this.hoursPerTimePeriod?this.text="<b>"+customLabels.maximum_service_appointments_allowed.replaceAll(this.workItemsPerTimePeriod)+"</b>":0===this.workItemsPerTimePeriod&&(this.text="<b>"+customLabels.maximum_hours_allowed.replaceAll(this.hoursPerTimePeriod)+"</b>"):0<this.hoursPerTimePeriod?this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.hoursInUse,this.hoursPerTimePeriod)+"%")+"</b> (<b>"+customLabels.x_Hours_scheduled_out_of_y.replaceAll(this.hoursInUse,this.hoursPerTimePeriod)+"</b>)":0<this.workItemsPerTimePeriod&&(this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.workItemsAllocated,this.workItemsPerTimePeriod)+"%")+"</b> (<b>"+customLabels.NumServicesScheduled.replaceAll(this.workItemsAllocated,this.workItemsPerTimePeriod)+"</b>)"),this.type="contractorcapacity"},ResourceCapacity.prototype.setGanttResource=function(e,t){var n,i=e[this.resource],s=[];for(n in i){var r=i[n];(isIntersect(r.effectiveStartDate,r.effectiveEndDate,this.start_date,this.end_date)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}this.resourceId=t(this.resource,s)},ResourceCapacity.prototype.isScheduled=function(){return!!this.resource},ResourceCapacity.prototype.getGanttResource=function(){return this.resourceId&&this.resourceId.substr(0,18)},ServiceCrewMember.prototype.calculateTimeZone=function(e){e=getTimezoneOffset(e);this.tzStartDate=addTimezoneOffsetToDate(this.startDate,e),this.tzEndDate=addTimezoneOffsetToDate(this.endDate,e)},ServiceResource.prototype.checkIfResourceAlreadyHasSkill=function(e,t,n){return Array.isArray(e[n])?e[n].some(function(e){return e.id===t}):e[n]&&e[n].id===t},!function(e){e.Shift=function(e){this.id=e.Id,this.name=window.isOptimizationViewer?e.Id:e[fieldNames.Shift.ShiftNumber],this.label=e[fieldNames.Shift.Label]||"",this.serviceResourceId=e[fieldNames.Shift.ServiceResourceId]||null,this.serviceTerritoryId=e[fieldNames.Shift.ServiceTerritoryId]||null,this.status=window.isOptimizationViewer?e[fieldNames.Shift.StatusCategory]:e[fieldNames.Shift.Status],this.statusCategory=e[fieldNames.Shift.StatusCategory],this.timeSlotType=e[fieldNames.Shift.TimeSlotType],this.startTime=e[fieldNames.Shift.StartTime],this.endTime=e[fieldNames.Shift.EndTime],this.backgroundColor=e[fieldNames.Shift.BackgroundColor],isHolidayEnabled&&(this.isHolidayShift=e.IsHolidayShift);this.startTime&&(this.startTime=__setTimeZoneOffsetToDateField(this.startTime)),this.endTime&&(this.endTime=__setTimeZoneOffsetToDateField(this.endTime))},e.ShiftSlot=function(e){this.startTime=e.startTime,this.endTime=e.endTime,this.type=e.timeSlotType}}(window);var bootstrap={};function setSplashScreenTabDone(e){var t;setSplashScreenTabDone.doneElements[e]||(t=$("#"+e))&&(t.addClass("loading-task-done"),setSplashScreenTabDone.doneElements[e]=!0)}function handleTabSettingAndRecordTypesPermissions(d){return new Promise(function(e,t){var n=void 0,i=JSON.parse(d.Admin.replace(/&quot;/g,'"')),s=JSON.parse(d.Agent.replace(/&quot;/g,'"')),r=JSON.parse(d.Guest.replace(/&quot;/g,'"')),o=JSON.parse(d.Community.replace(/&quot;/g,'"')),a=JSON.parse(d.CommunityDispatcher.replace(/&quot;/g,'"')),l=JSON.parse(d.Dispatcher.replace(/&quot;/g,'"')),c=JSON.parse(d.Resource.replace(/&quot;/g,'"')),i=(d.Integration&&(n=JSON.parse(d.Integration.replace(/&quot;/g,'"'))),[createTabAndRecordTypePermission("FSL_Admin","Field Service Admin",i.tabSettings,i.recordTypeVisibilities,i.apexClasses),createTabAndRecordTypePermission("FSL_Agent","Field Service Agent",s.tabSettings,s.recordTypeVisibilities,s.apexClasses),createTabAndRecordTypePermission("FSL_Dispatcher","Field Service Dispatcher",l.tabSettings,l.recordTypeVisibilities,l.apexClasses),createTabAndRecordTypePermission("FSL_Community_Self_Service","Field Service Self Service",o.tabSettings,o.recordTypeVisibilities,o.apexClasses),createTabAndRecordTypePermission("FSL_Guest_User","Field Service Guest User",r.tabSettings,r.recordTypeVisibilities,r.apexClasses),createTabAndRecordTypePermission("FSL_Community_Dispatcher","Field Service Community Dispatcher",a.tabSettings,a.recordTypeVisibilities,a.apexClasses),createTabAndRecordTypePermission("FSL_Resource","Field Service Resource",c.tabSettings,c.recordTypeVisibilities,c.apexClasses)]);n&&i.push(createTabAndRecordTypePermission("sfdc_fieldservice","Field Service Integration",n.tabSettings,n.recordTypeVisibilities,n.apexClasses)),Promise.all(i).then(function(){e()},function(){e()})})}function createTabAndRecordTypePermission(a,l,c,d,u){new Promise(function(i,e){for(var t=window.location.origin,n='<soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:met="http://soap.sforce.com/2006/04/metadata"><soapenv:Header><met:SessionHeader><met:sessionId>'+sessionId+'</met:sessionId></met:SessionHeader></soapenv:Header><soapenv:Body><met:updateMetadata><met:metadata xsi:type="met:PermissionSet"><fullName>'+("sfdc_fieldservice"!=a?a+"_Permissions":a)+"</fullName><label>"+("Field Service Integration"!=l?l+" Permissions":l)+"</label>",s=0;s<c.length;s++)n+="<tabSettings><tab>"+c[s].tab+"</tab><visibility>"+c[s].visibility+"</visibility></tabSettings>";for(var r=0;r<d.length;r++)n+="<recordTypeVisibilities><recordType>"+d[r].recordType+"</recordType><visible>"+d[r].visible+"</visible></recordTypeVisibilities>";for(var o=0;o<u.length;o++)n+="<classAccesses><apexClass>"+u[o].apexClass+"</apexClass><enabled>"+u[o].enabled+"</enabled></classAccesses>";window.$.ajax({url:t+"/services/Soap/m/38.0",type:"POST",dataType:"xml",data:n+="</met:metadata></met:updateMetadata></soapenv:Body></soapenv:Envelope>",beforeSend:function(e){e.setRequestHeader("Content-Type","text/xml"),e.setRequestHeader("SOAPAction",'""')}}).then(function(e,t,n){i()},function(e,t,n){console.log("Failed to update permissions on load of VF"),i()})})}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}bootstrap.loadUserSettings=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.getUserSettings,function(e,t){t.status?(setSplashScreenTabDone("loading-user-setttings"),bootstrap.loadedUserSettings=JSON.parse(e.userSettings),angular.bootstrap(document.getElementById("serviceExpertApp"),["serviceExpert"]),e.isUserSettingsExist||($("#loading-timephased").remove(),$("#loading-finishing").remove())):bootstrap.handleError(t)},{buffer:!1,escape:!1,timeout:12e4})},bootstrap.Start=function(){bootstrap.UpdatePermissionSets()},bootstrap.UpdatePermissionSets=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.updatePermissionSets,function(e,t){if(e)try{handleTabSettingAndRecordTypesPermissions(e).then(function(){setSplashScreenTabDone("loading-permissions"),bootstrap.loadUserSettings()})}catch(e){console.log(e),bootstrap.loadUserSettings()}else setSplashScreenTabDone("loading-permissions"),bootstrap.loadUserSettings()})},setSplashScreenTabDone.doneElements={},bootstrap.handleError=function(e){var t,n=!1;for(t in{no_dispatcher_license_found:!0,Apex_CPU_time_limit_exceeded:!0})customLabels[t]===e.message&&(n=!0);-1<e.message.toLowerCase().indexOf("dml")?cantLoadGantt(customLabels.no_dispatcher_permissions_found.replace("{0}",'<a href="vf066_settings#page=0&tab=1" target="_blank">').replace("{1}","</a>")):"operatingHours"===e.type?cantLoadGantt(customLabels.dispatcher_console_error_loading+'<div class="otherMessage">'+customLabels.NoAccessToOperatingHours.replace("$0",e.message)+"</div>"):n?cantLoadGantt(e.message):e.message.includes("TimeZone")||cantLoadGantt(customLabels.dispatcher_console_error_loading+'<div class="otherMessage">'+e.message+"</div>")},bootstrap.UpdatePermissionSetsBootstrap=function(n,i){Visualforce.remoting.Manager.invokeAction(sharedRemoteActions.updatePermissionSets,function(e,t){if(e)try{handleTabSettingAndRecordTypesPermissions(e).then(function(){setSplashScreenTabDone("loading-permissions"),angular.bootstrap(document.getElementById(n),[i])})}catch(e){console.log(e),angular.bootstrap(document.getElementById(n),[i])}else setSplashScreenTabDone("loading-permissions"),angular.bootstrap(document.getElementById(n),[i])},{buffer:!1,timeout:12e4})},moment.defineLocale("en_NZ",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(e){var t=e%10;return e+(1==~~(e%100/10)?"th":1==t?"st":2==t?"nd":3==t?"rd":"th")},week:{dow:1,doy:4}}),moment.defineLocale("en_IN",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},dayOfMonthOrdinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(e){var t=e%10;return e+(1==~~(e%100/10)?"th":1==t?"st":2==t?"nd":3==t?"rd":"th")},week:{dow:0,doy:6}});var globalStatuses={},globalCategories={},flaggedServices={},contextShown=!1,snapTo=!1,globalSelectedGanttServices={},capacityDurationFilter="Day",cachedDomElements={},violationDelimiter="&lt;br/&gt;",minHourToDisplay=0,maxHourToDisplay=24,includeWeekends=!1,gameOn=!1,ctrlPressed=!1,paletteViewActive=!1,showCandidates={on:!1,id:null},folderJustToggled=!1,fontColor="";function setHoursToDisplay(e,t,n){minHourToDisplay=e,maxHourToDisplay=t,includeWeekends=n}function updateTimesToSnapIn(){var e,t;void 0!==cachedDomElements&&void 0!==cachedDomElements.timesDragFix&&(t=null,0!==(e=cachedDomElements.timesDragFix.html()).indexOf(customLabels.SchedulingTimesGantSnap)||ctrlPressed?0!==e.indexOf(customLabels.SchedulingTimesGantSnap)&&ctrlPressed&&(t=customLabels.SchedulingTimesGantSnap+" "+e.substr(customLabels.SchedulingTimesGant.length,e.length),cachedDomElements.timesDragFix.html(t)):(t=customLabels.SchedulingTimesGant+" "+e.substr(customLabels.SchedulingTimesGantSnap.length,e.length),cachedDomElements.timesDragFix.html(t)))}function showTimesWhenDragging(e,t){cachedDomElements.timesDragFix=cachedDomElements.timesDragFix||$("#timesDragFix");var n,i=(t.start_date.getMinutes()+t.travelTo/60)%60,s=i%serviceJumpsOnGantt,i=serviceJumpsOnGantt-i%serviceJumpsOnGantt;scheduler.getState().drag_id!==t.id?scheduler.getState().drag_id||cachedDomElements.timesDragFix.hide():(window.__gantt.currentResizableEvent===t.id?(n=generateTimeForResize(e,t),n=customLabels.SchedulingTimesGant+"<br/>"+n.startTime+" - "+n.endTime,cachedDomElements.timesDragFix.html(n)):(n=t.finish-t.start,(e=new Date(e)).setSeconds(0),t.travelTo&&e.setSeconds(e.getSeconds()+t.travelTo),e=i<s?new Date(e.getTime()+60*i*1e3):new Date(e.getTime()-60*s*1e3),t=new Date(e.getTime()+n),i=moment(e).format("lll"),s=moment(t).format("lll"),n=customLabels.SchedulingTimesGant+"<br/>"+i+" - "+s,ctrlPressed&&(n=customLabels.SchedulingTimesGantSnap+"<br/>"+i+" - "+s),cachedDomElements.timesDragFix.html(n))).show()}function generateTimeForResize(e,t){var n=void 0,i=void 0,s=!1,e=(n=new Date(t.start).getTime()===new Date(t.start_date).getTime()?(i=new Date(t.end_date),(t.end_date.getMinutes()+t.travelFrom/60)%60):(i=new Date(e),s=!0,(t.start_date.getMinutes()+t.travelTo/60)%60))%serviceJumpsOnGantt,n=serviceJumpsOnGantt-n%serviceJumpsOnGantt;return i.setSeconds(0),t.travelTo&&s&&i.setSeconds(i.getSeconds()+t.travelTo),t.travelFrom&&!s&&i.setSeconds(i.getSeconds()+t.travelFrom),i=n<e?new Date(i.getTime()+60*n*1e3):new Date(i.getTime()-60*e*1e3),{startTime:(s?moment(i):moment(t.start_date)).format("lll"),endTime:(s?moment(t.end_date):moment(i)).format("lll")}}function generateBreakEventHtml(e,t,n){var i="",e=("ZoomLevel2"==scheduler._mode||"ZoomLevel3"==scheduler._mode||"ZoomLevel4"==scheduler._mode||window.__gantt.horizontalScrolling&&("ZoomLevel5"==scheduler._mode||"ZoomLevel6"==scheduler._mode||"ZoomLevel7"==scheduler._mode)||(i='style="display:none;'),e.ganttLabel?'title="'+e.ganttLabel+'"':"");return n?'<div class="ServiceEvent" style="'+t+'" '+e+'>\n                    <div class="ServiceEventPadding">\n                        <img '+i+' src="'+lsdIcons.breakImg+'" class="breakIcon" draggable="false"/>     \n                    </div>\n                </div>':'<div class="ServiceEventPadding" style="'+t+'" '+e+">\n                <img "+i+' src="'+lsdIcons.breakImg+'" class="breakIcon" draggable="false"/>\n            </div>'}function generateCapacityHtml(e){var t="",n="fa-battery-empty",i=0;return void 0===e.minutesUsed&&void 0===e.workItemsAllocated?t+('<div class="ServiceEventPadding"><span class="Capacity_Label">'+e.text)+"</span></div>":(0<e.hoursPerTimePeriod?i=e.hoursInUse/e.hoursPerTimePeriod*100:0<e.workItemsPerTimePeriod&&(i=e.workItemsAllocated/e.workItemsPerTimePeriod*100),n=i<=25?"fa-battery-empty":i<=50?"fa-battery-quarter":i<=75?"fa-battery-half":i<=90?"fa-battery-three-quarters":"fa-battery-full",t+='<span class="contractorCapacityHoursUsed " style="width:calc('+(i=100<i?100:i)+'% - 5px);"></span>',e.text&&("ZoomLevel6"===scheduler._mode||"ZoomLevel7"===scheduler._mode?t+='<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+n+'"></i>'+e.text.split(" ")[0]+"</span></div>":t+="MonthlyView"===scheduler._mode||"LongView"===scheduler._mode?'<div class="ServiceEventPadding"><span class="Capacity_Label Capacity_Label_LongView">'+e.text.split(" ")[0]+"</span></div>":'<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+n+'"></i>'+e.text+"</span></div>"),t)}function generateNAhtml(e,t,n){var i=void 0,s=void 0,e=e.ganttLabel||e.reason||"";return t.includes("color")&&(i="fill:#"+fontColor,s="color:#"+fontColor),n?'<div class="ServiceEvent" style="'+t+'">\n                    <div class="ServiceEventPadding">\n                        <svg aria-hidden="true" class="slds-icon naIcon" style="'+i+'">\n                            <use xlink:href="'+lsdIcons.na+'"></use>\n                        </svg>\n                        <span class="NA_Label" style="'+s+'">\n                            '+e.encodeHTML()+"\n                        </span>\n                    </div>\n                </div>":'<div class="ServiceEventPadding" style="'+t+'">\n                <svg aria-hidden="true" class="slds-icon naIcon" style="'+i+'">\n                    <use xlink:href="'+lsdIcons.na+'"></use>\n                </svg>\n                <span class="NA_Label" style="'+s+'">\n                    '+e.encodeHTML()+"\n                </span>\n            </div>"}function generateIconsHtmlForService(e){var t,n="",i=(e.violations&&(n="<div class='violationsOnService'><i class='fa fa-warning'></i></div>"),e.isBundleMember&&(n="<div class='violationsOnService'>"+e.RelatedBundle+"</div>"),e.jeopardy&&(n='<div class="jeopardyOnService"><img src="'+lsdIcons.jeopardyImg+'"></div>'),e.icons&&(t="",e.icons.forEach(function(e){t+='<div class="customIconOnService"><img src="'+e+'"></div>'}),n+=t),"");return"service"===e.type&&e.ganttColor&&!globalSelectedGanttServices[e.id]&&(i=generateGanttTextColor(e.ganttColor.substr(1,7))),e.emergency&&(n+='<svg aria-hidden="true" class="slds-icon emergencyOnService" style="fill: #'+i+'"><use xlink:href="'+lsdIcons.emergency+'"></use></svg>'),e.pinned&&(n+='<svg aria-hidden="true" class="slds-icon onServiceIcon" style="fill: #'+i+'"><use xlink:href="'+lsdIcons.pin+'"></use></svg>'),e.isBundle&&(n+='<svg aria-hidden="true" class="slds-icon onServiceIcon" style="fill: #'+i+'"><use xlink:href="'+lsdIcons.bundleIcons+'#ad_set"></use></svg>'),flaggedServices[e.id]&&(n+='<svg aria-hidden="true" class="slds-icon onServiceIcon" style="fill: #'+i+'"><use xlink:href="'+lsdIcons.flag+'"></use></svg>'),(e.relatedFather||e.relatedTo||e.isServiceInChain)&&(n+='<svg aria-hidden="true" class="slds-icon onServiceIcon" style="fill: #'+i+'"><use xlink:href="'+lsdIcons.related+'"></use></svg>'),e.isMDT&&(n+='<svg aria-hidden="true" class="slds-icon onServiceIcon" style="fill: #'+i+'">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>'+('<svg aria-hidden="true" class="slds-icon onServiceIcon forwardIcon" style="fill: #'+i+'">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>')),n}function generateServiceColorAndFont(e,t){var n,i,s=t?"text-align:right;":"";return"na"===e.type&&e.ganttColor&&e.travelTo&&(s+="margin-right:-6px;"),(e.ganttPaletteColor||e.ganttColor)&&!globalSelectedGanttServices[e.id]&&(n=e.ganttColor,n=paletteViewActive&&e.ganttPaletteColor?e.ganttPaletteColor.color:n)&&(i=generateGanttTextColor(n.substr(1,7)),s+="color:#"+(fontColor=i)+";background:"+n+";",!t||e.travelFrom||e.travelTo||(s+="position:relative;right:-6px;")),"ZoomLevel3"!==scheduler._mode&&"ZoomLevel2"!==scheduler._mode&&(s+="font-size:10px;"),s}$(function(){$("body").keydown(function(e){ctrlPressed=e.ctrlKey,updateTimesToSnapIn()}).keyup(function(e){ctrlPressed=!1,updateTimesToSnapIn()})});var __lockedServicesIds={};function attchDatalessSchedulerEvents(){var h="rtl"===document.querySelector("html").getAttribute("dir"),t=(scheduler.date.ZoomLevel1_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.date.ZoomLevel2_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.templates.event_bar_text=function(e,t,n){var i,s,r,o,a,l=void 0,c=void 0,d=getMinAndMaxHoursToDisplay(),u=n.finish-n.start,p=new Date(e),m=window.__gantt.currentResizableEvent==n.id?"resizableEvent":"";return p.setSeconds(0),n.travelTo&&p.setSeconds(p.getSeconds()+n.travelTo),u=new Date(p.getTime()+u),showTimesWhenDragging(e,n),"contractorcapacity"===n.type?generateCapacityHtml(n):(i=generateIconsHtmlForService(n),s=generateServiceColorAndFont(n,h),r=!0,o=new Date(scheduler._min_date),a=new Date(scheduler._max_date),o.setHours(d.min),a.setHours(d.max),(r=isIntersect(p,u,o,a)||"ZoomLevel2"===scheduler._mode?r:!1)&&(n.travelTo||n.travelFrom)?(l=getXPositionOfEvent({start_date:p,end_date:u},!1,scheduler.matrix[scheduler._mode]),s+="width:"+(c=(c=getXPositionOfEvent({start_date:p,end_date:u},!0,scheduler.matrix[scheduler._mode])-l+12)<=2?3:c)+"px;",n.travelTo&&((d=new Date(e)).setMinutes(d.getMinutes()+n.travelTo/60),o=getXPositionOfEvent({start_date:n.start_date,end_date:d},!1,scheduler.matrix[scheduler._mode]),a=getXPositionOfEvent({start_date:n.start_date,end_date:d},!0,scheduler.matrix[scheduler._mode]),s+=(h?"margin-right:":"margin-left:")+(a-o+7)+"px;"),"na"===n.type?generateNAhtml(n,s,!0):"break"===n.type?generateBreakEventHtml(n,s,!0):'<div class="ServiceEvent" territory_id="'+n.getGanttTerritory()+'" style="'+s+'");"><div class="ServiceEventPadding '+m+'">'+i+n.text+"</div></div>"):"na"===n.type?generateNAhtml(n,s,!1):"break"===n.type?generateBreakEventHtml(n,s,!1):'<div class="ServiceEventPadding '+m+'" style="'+s+'">'+(r||n.isDummy?i+n.text:"")+"</div>")},scheduler.templates.event_class=function(e,t,n){var i="";return"break"===n.type&&window.__servicesInFilter&&window.__servicesInFilter.applied?i="NA_Break service-faded":"break"===n.type&&(i="NA_Break "),"break"===n.type||"na"===n.type?i+=" absence-layer ":"service"===n.type?i+=" service-layer ":"contractorcapacity"===n.type&&(i+=" capacity-layer "),n.showEventPopupEffect&&(i+=" ShowEventEffect "),window.__servicesInFilter&&window.__servicesInFilter.applied&&!window.__servicesInFilter[n.id]&&!n.isDummy&&(i+=" service-faded "),"na"===n.type&&(i+=" NA_Absence ","full"===window.__gantt.absenceOverlapHeight?i+=n.travelTo||n.travelFrom?" absenceFullHeightTravel ":" absenceFullHeight ":i+=" NA_Absence_Partial_Height ",n.isDummy&&(i+=" savingDummyService "),window.__gantt.currentResizableEvent!==n.id?i+=" notResizeableEvent ":i+=" resizeableNa "),"na"===n.type&&n.ganttColor&&!n.travelTo&&(i+=" na_with_color_no_travel_to "),"na"===n.type&&n.ganttColor&&n.travelTo&&(i+=" na_with_color "),"contractorcapacity"===n.type?(i+=" eventContractorCapacity","LongView"!==scheduler._mode&&"MonthlyView"!==scheduler._mode||(i+=" eventContractorCapacity_LongView"),0<n.hoursPerTimePeriod?0<n.hoursInUse&&n.hoursPerTimePeriod<n.hoursInUse&&(i+=" overCapacityPattern"):0<n.workItemsPerTimePeriod&&0<n.workItemsAllocated&&n.workItemsPerTimePeriod<n.workItemsAllocated&&(i+=" overCapacityPattern"),showCandidates.on&&(i+=" fadedSlot")):("service"===n.type&&(i+=getClassByStatus(n.statusCategory),n.isDummy||__lockedServicesIds[n.id])&&(i+=" savingDummyService "),n.isMDT&&(i+=" mdtEvent"),showCandidates.on&&n.id!==showCandidates.id&&(i+=" fadedSlot"),n.hiddenTravelFrom&&(i+=" dhx_long_travel_from_time_background"),n.hiddenTravelTo&&(i+=" dhx_long_travel_to_time_background"),i+=n.travelTo&&n.travelFrom?" dhx_travelToFrom dhx_travel_time_background":n.travelTo&&!n.travelFrom?" dhx_travelTo dhx_travel_time_background":!n.travelTo&&n.travelFrom?" dhx_travelFrom dhx_travel_time_background":"na"===n.type?" NA_Absence_NoTravel":" dhx_noTravel",window.__gantt.currentResizableEvent!==n.id&&(i+=" notResizeableEvent"),"service"===n.type&&(globalSelectedGanttServices[n.id]&&(n.travelTo||n.travelFrom)?i+=" selectedEvent":globalSelectedGanttServices[n.id]?i+=" selectedEventNoTravel":n.id===scheduler._select_id&&(n.travelTo||n.travelFrom)?i+=" selectedEvent":n.id===scheduler._select_id&&(i+=" selectedEventNoTravel")),n.status&&(i+=" GanttCustomStatus_"+n.status.split(" ").join(""))),i},!(scheduler.templates.tooltip_text=function(e,t,n){if(contextShown)return!1;var i=void 0,s='<div class="tooltipBody">',r=getLocationdIdByResource(n.resourceId),e=utils.getLocationOffset(e,r)-utils.getUserOffset(e),t=utils.getLocationOffset(t,r)-utils.getUserOffset(t),o=new Date(n.start),a=0,l=0,c=new Date(n.finish);if(!r)return!1;if(o.setMinutes(o.getMinutes()+e),c.setMinutes(c.getMinutes()+t),"contractorcapacity"===n.type)return i="fa-battery-empty",0<n.hoursPerTimePeriod?(a=n.hoursInUse/n.hoursPerTimePeriod*100,l=Math.floor(n.hoursInUse/n.hoursPerTimePeriod*100*100)/100):0<n.workItemsPerTimePeriod&&(a=n.workItemsAllocated/n.workItemsPerTimePeriod*100,l=Math.floor(n.workItemsAllocated/n.workItemsPerTimePeriod*100*100)/100),i=a<=25?"fa-battery-empty":a<=50?"fa-battery-quarter":a<=75?"fa-battery-half":a<=90?"fa-battery-three-quarters":"fa-battery-full",s+=void 0===n.minutesUsed&&void 0===n.workItemsAllocated?'<div class="tooltipLine"><b style="font-size:15px"> '+n.resourceName.encodeHTML()+"</b></div>":'<div class="tooltipLine"><b style="font-size:15px"><i class="fa '+i+'"></i> '+n.resourceName.encodeHTML()+"</b> ("+l+"%)</div>",n.workItemsPerTimePeriod&&(s+=void 0===n.workItemsAllocated?'<div class="tooltipLine"></div>':'<div class="tooltipLine">'+customLabels.NumServicesScheduled.replaceAll(n.workItemsAllocated,n.workItemsPerTimePeriod)+"</div>"),n.hoursPerTimePeriod&&(s+=void 0===n.minutesUsed?'<div class="tooltipLine"></div>':'<div class="tooltipLine">'+customLabels.NumHoursScheduled.replace("{0}",n.hoursInUse).replace("{1}",n.hoursPerTimePeriod)+"</div>"),s=(s=(s=(s+='<div class="tooltipHR"></div>')+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(n.start_date).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(n.end_date).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Duration_Type+"</span> "+n.timePeriod+"</div>"),0<n.workItemsAllocated&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.NumberOfServices+"</span> "+n.workItemsAllocated+"</div>"),s+="</div>";if("service"!==n.type)return i=absenceTypeIcon(n.type),n.ganttLabel?s+='<div class="tooltipLine"><b>'+i+'<span class="tooltipName">'+n.ganttLabel.encodeHTML()+"</span> </b> </div>":s+='<div class="tooltipLine"><b>'+i+'<span class="tooltipName">'+n.name+"</span> </b> </div>",s=(s=(s+='<div class="tooltipHR"></div>')+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(n.start).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(n.finish).format("llll")+"</div>"),e&&t&&!useLocationTimezone&&(s=(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>")+'<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),n.travelTo&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(n.travelTo/60)+"</div>"),n.travelFrom&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(n.travelFrom/60)+"</div>"),(n.reason||n.comment)&&(s+='<div class="tooltipHR"></div>'),n.reason&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.AbsenceCreatorType+"</span> "+n.reason.encodeHTML()+"</div>"),s+="</div>";var r="",a=n.ganttColor,l='<svg aria-hidden="true" class="slds-icon tooltipJeopardyIcon">\n                                <use xlink:href="'+lsdIcons.jeopardy+'"></use>\n                            </svg>',i='<svg aria-hidden="true" class="slds-icon tooltipMDTIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>',d='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>',u='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.emergency+'"></use>\n                            </svg>',p=((a=paletteViewActive&&n.ganttPaletteColor?n.ganttPaletteColor.color:a)&&(r='style="background:'+a+'"'),s+=n.ganttLabel?'<div class="tooltipLine"><div '+r+' class="tooltipStatus '+getClassByStatus(n.statusCategory)+'"></div><b style="font-size:15px">'+n.name+" / "+n.ganttLabel.encodeHTML()+"</b> ("+statusTranslations[n.status]+")</div>":'<div class="tooltipLine"><div '+r+' class="tooltipStatus '+getClassByStatus(n.statusCategory)+'"></div><b style="font-size:15px">'+n.name+"</b> ("+statusTranslations[n.status]+")</div>",n.jeopardy&&n.jeopardyReason&&(s+='<div class="tooltipJeopardy">'+l+"<span>"+customLabels.JeopardyTooltip+" "+n.jeopardyReason.encodeHTML()+"</span></div>"),n.emergency?s+='<div class="tooltipJEmergency">'+u+"<span>"+customLabels.ScheduledWithEmergency+"</span></div>":n.jeopardy&&(s+='<div class="tooltipJeopardy">'+l+"<span>"+customLabels.JeopardyTooltipLong+"</span></div>"),n.pinned&&(s+='<div class="tooltipLine tooltipPinned"><i>'+customLabels.Pinned_Tooltip+"</i></div>"),(window.isOptimizationViewer?GanttServiceOptiViewer:GanttService).prototype.allFieldSets.GanttToolTip);if(p)for(var m=0;m<p.length;m++){var h=n[p[m].APIName];!(h=n.fields[p[m].APIName+"_Translated"]?n.fields[p[m].APIName+"_Translated"]:h)||"STRING"!==p[m].Type&&"TEXTAREA"!==p[m].Type&&"REFERENCE"!==p[m].Type&&"PICKLIST"!==p[m].Type||(h=h.encodeHTML()),"Status"===p[m].APIName?h=statusTranslations[n.status]:"DATETIME"===p[m].Type&&h?h=moment(h).format("llll"):"DATE"===p[m].Type&&h?h=moment(h).format("L"):"BOOLEAN"===p[m].Type&&(h=h?customLabels.True:customLabels.False),h&&"BOOLEAN"!==p[m].Type?s+='<div class="tooltipLine"><b>'+p[m].Label.encodeHTML()+": </b> "+h+"</div>":"BOOLEAN"===p[m].Type&&(h=n[p[m].APIName],s+='<div class="tooltipLine"><b>'+p[m].Label.encodeHTML()+': </b> <input class="checkbox-on-tooltip" type="checkbox" '+(h?"checked":"")+" disabled></input></div>")}if(s=(s=(s+='<div class="tooltipHR"></div>')+('<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Start+"</span> "+moment(n.start).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Finish+"</span> "+moment(n.finish).format("llll")+"</div>"),(e||t||alwaysShowLocalTimeTooltip)&&!useLocationTimezone&&(s=(s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>")+'<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),n.hiddenTravelTo?s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(n.hiddenTravelTo.hiddenTravel/60)+"</div>":n.travelTo&&(s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(n.travelTo/60)+"</div>"),n.hiddenTravelFrom?s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(n.hiddenTravelFrom.hiddenTravel/60)+"</div>":n.travelFrom&&(s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(n.travelFrom/60)+"</div>"),n.tooltipText&&(s=(s+='<div class="tooltipHR"></div>')+'<div class="tooltipLine tooltipTitle">'+customLabels.Custom_Tooltip_Field+'</div><div class="tooltipLine">'+n.tooltipText.encodeHTML()+"</div>"),s+="</div>",(n.hiddenTravelTo||n.hiddenTravelFrom||n.isMDT)&&(s+='<div class="tooltipTravel">',(n.hiddenTravelTo||n.hiddenTravelFrom)&&(s=(s+='<div class="tooltipLine tooltipTitle"><i class="fa fa-car"></i>'+customLabels.Travel_time+"</div><div>")+customLabels.Travel_time_too_long.replace("{0}",maxTravelTimeInSeconds/60/60)+'<div class="travelExplain">'+customLabels.To_change_maximum_travel_hours+"</div></div>"),n.isMDT&&(s=(s+='<div class="tooltipLine tooltipTitle">'+i+d+customLabels.Multi_Day_Service+"</div><div>")+customLabels.This_service_spans_across_more_than_one_day+"</div>"),s+="</div>"),n.violations){for(var s=(s+='<div class="tooltipViolation">')+('<div class="tooltipLine tooltipTitle"><i class="fa fa-warning"></i>'+customLabels.Rule_violations_Tooltip+"</div><div>"),g=0;g<n.violations.length;g++)-1!=n.violations[g].ViolationString.indexOf(violationDelimiter)?s=(s=(s+=n.violations[g].RuleName+" - ")+n.violations[g].ViolationString.substring(0,n.violations[g].ViolationString.indexOf(violationDelimiter))+"<br/>")+n.violations[g].ViolationString.substring(n.violations[g].ViolationString.indexOf(violationDelimiter)+violationDelimiter.length)+"<br/>":s+=n.violations[g].RuleName+" - "+n.violations[g].ViolationString+"<br/>";s+="</div>"}return s}));function s(e){return window.__currentViewOptions.highlightWeekeneds&&(6===(e=e.getDay())||0===e&&1===window.firstDayOfTheWeek||5===e&&0===window.firstDayOfTheWeek)?"color-weekends-date":void 0}function n(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=[],i=s(e);return i&&n.push(i),(t&&hasHolidayInScaleX(e,1,"day")||hasHolidayInScaleX(e,scheduler.getView().x_step,scheduler.getView().x_unit))&&n.push("color-holiday-date"),n.join(" ")}function e(e){var t;return!(!a(e)&&(t=getMinAndMaxHoursToDisplay(),e.getHours()>=t.min)&&e.getHours()<t.max)}function a(e){if("ZoomLevel6"===scheduler._mode||"ZoomLevel7"===scheduler._mode||"MonthlyView"===scheduler._mode||"MTDView"===scheduler._mode||"LongView"===scheduler._mode){var t=0===firstDayOfTheWeek?6:0,n=0===firstDayOfTheWeek?5:6;if(!includeWeekends&&(e.getDay()===n||e.getDay()===t))return!0}return!1}function i(e,t){var n,i;return!gameOn&&(n=function(e){var t=getMinAndMaxHoursToDisplay();if(a(e.start_date)&&a(e.end_date)&&(i=e.start_date,(e.end_date.getTime()/1e3/60/60-i.getTime()/1e3/60/60)/24<5))return!1;var n=[];if("ZoomLevel2"===scheduler._mode)n.push({start:scheduler._min_date.getTime(),finish:scheduler._max_date.getTime()});else for(var i=scheduler._min_date.getTime(),s=scheduler._max_date.getTime(),r=i;r<s;r+=864e5){var o={start:r+1e3*t.min*60*60,finish:r+1e3*t.max*60*60};n.push(o)}return isMultipleIntersection({start:e.start_date.getTime(),finish:e.end_date.getTime()},n)}(t),i=!0,contractorSupport&&(t.resourceContractor&&(i=!1),"contractorcapacity"===t.type)&&t.timePeriod!=capacityDurationFilter&&(i=!1),n)&&i}return dhtmlxEvent(scheduler._obj,"mouseleave",function(e){scheduler.getState().drag_id&&(t=!0,scheduler._on_mouse_up(e),cachedDomElements.timesDragFix.hide(),window.getSelection().removeAllRanges())}),scheduler.attachEvent("onBeforeEventChanged",function(){return!t||(t=!1)}),scheduler._hover=null,scheduler.attachEvent("onMouseMove",function(e,t){var n,i;e?scheduler._events[e]&&(scheduler._events[e].relatedTo||scheduler._events[e].relatedFather)&&(i=null,0===(n=$(scheduler.getRenderedEvent(e)).find(".ServiceEvent")).length&&(n=$(scheduler.getRenderedEvent(e))),scheduler._events[e].relatedFather?0===(i=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather)).find(".ServiceEvent")).length&&(i=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather))):0===(i=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo)).find(".ServiceEvent")).length&&(i=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo))),scheduler._hover=e,n)&&i&&($(n).hasClass("hoverRelated")||($(n).addClass("hoverRelated"),$(i).addClass("hoverRelated"))):scheduler._hover&&($(".dhx_cal_event_line, .ServiceEvent").removeClass("hoverRelated"),scheduler._hover=null)}),scheduler.templates.ZoomLevel2_scale_date=function(e){var t=e.getHours(),e=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+":"+e+" AM":12===t?formatNumberToLocaleString(12)+":"+e+" PM":12<t?formatNumberToLocaleString(t-12)+":"+e+" PM":formatNumberToLocaleString(t)+":"+e+" AM":formatNumberToLocaleString(t)+":"+e},scheduler.templates.ZoomLevel3_scale_date=function(e){var t=e.getHours(),n=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+" AM":12==t?formatNumberToLocaleString(12)+" PM":12<t?formatNumberToLocaleString(t-12)+" PM":formatNumberToLocaleString(t)+" AM":(e.getHours()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getHours()):formatNumberToLocaleString(e.getHours()))+":"+n},scheduler.templates.ZoomLevel4_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel5_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel6_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel7_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel4_cell_class=function(e,t,n){var i="",t=(!n.children&&shouldSeparateCell(t)&&(i+="BorderForDayChange "),t.getDay());return!n.children&&window.__currentViewOptions.highlightWeekeneds&&(6===t||0===t&&1===window.firstDayOfTheWeek||5===t&&0===window.firstDayOfTheWeek)&&(i+=" color-weekends"),i},scheduler.templates.ZoomLevel2_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel3_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel5_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel6_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel7_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.MTDView_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.LongView_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel4_second_scalex_class=function(e){return n(e,!0)},scheduler.templates.ZoomLevel2_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel3_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel5_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel6_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel7_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel2_scalex_class=n,scheduler.templates.ZoomLevel3_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel4_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel5_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel6_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel7_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.MTDView_scalex_class=s,scheduler.templates.LongView_scalex_class=scheduler.templates.MTDView_scalex_class,scheduler.templates.MonthlyView_scalex_class=scheduler.templates.MTDView_scalex_class,scheduler.filter_ZoomLevel7=scheduler.filter_ZoomLevel6=scheduler.filter_ZoomLevel5=scheduler.filter_ZoomLevel4=scheduler.filter_ZoomLevel3=scheduler.filter_ZoomLevel2=scheduler.filter_ZoomLevel1=i,scheduler.filter_LongView=function(e,t){var n,i=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];return t instanceof ResourceCapacity&&t.timePeriod===capacityDurationFilter||!(i&&contractorSupport&&t.resourceContractor||window.__gantt.shouldShowLongTermError()||"break"===t.type)&&(i=(t.finish-t.start)/1e3/60/60,window.__currentViewOptions.showMdt?(n=0===window.mdtBooleanField.indexOf("FSL__")?window.mdtBooleanField.substr(5,window.mdtBooleanField.length-5):window.mdtBooleanField,"na"===t.type&&i>=window.__currentViewOptions.minNaDuration||"service"===t.type&&i>=window.__currentViewOptions.minServiceDuration&&t.fields[n]):"na"===t.type&&i>=window.__currentViewOptions.minNaDuration||"service"===t.type&&i>=window.__currentViewOptions.minServiceDuration)},scheduler.filter_MonthlyView=function(e,t){return"contractorcapacity"===t.type&&t.timePeriod===capacityDurationFilter},scheduler.filter_MTDView=function(e,t){return"contractorcapacity"===t.type&&t.timePeriod===capacityDurationFilter||t.isMDT||"na"===t.type},scheduler.ignore_ZoomLevel7=scheduler.ignore_ZoomLevel6=scheduler.ignore_ZoomLevel5=scheduler.ignore_ZoomLevel4=scheduler.ignore_ZoomLevel3=e,scheduler.ignore_MonthlyView=a,scheduler.ignore_LongView=scheduler.ignore_MonthlyView,scheduler.ignore_MTDView=scheduler.ignore_MonthlyView,{isDateInsideWeekend:a}}function shouldSeparateCell(e){var t=getMinAndMaxHoursToDisplay();switch(scheduler._mode){case"ZoomLevel4":t.max-=2;break;case"ZoomLevel5":t.max-=__gantt.horizontalScrolling?1:4;break;case"ZoomLevel6":case"ZoomLevel7":t.max-=__gantt.horizontalScrolling?1:6}if("ZoomLevel2"===scheduler._mode&&23===e.getHours()&&30===e.getMinutes())return!0;if(e.getHours()===t.max){e=new Date(e);if(e.setHours(e.getHours()+24),e<=scheduler._max_date)return!0}return!1}function getXPositionOfEvent(e,t,n){var i=0,s=n._step,r=n.round_position,o=0,e=t?e.end_date:e.start_date,a=(e=e.valueOf()>scheduler._max_date.valueOf()?scheduler._max_date:e)-scheduler._min_date_timeline;if(0<a){var l=scheduler._get_date_index(n,e);scheduler._ignores[l]&&(r=!0);for(var c=0;c<l;c++)i+=scheduler._cols[c];var d=scheduler.date.add(scheduler._min_date_timeline,scheduler.matrix[scheduler._mode].x_step*l,scheduler.matrix[scheduler._mode].x_unit);r?+d<+e&&t&&(o=scheduler._cols[l]):(a=e-d,n.first_hour||n.last_hour?((a-=n._start_correction)<0&&(a=0),(o=Math.round(a/s))>scheduler._cols[l]&&(o=scheduler._cols[l])):o=Math.round(a/s))}return i+=t?0===a||r?o-14:o-12:o+1}function getResourceEventsIds(e,t,n){var i,s=[];for(i in scheduler._events)"service"==scheduler._events[i].type&&scheduler._events[i].start_date>=e&&scheduler._events[i].end_date<=t&&scheduler._events[i].resourceId==n&&(s.push(i),scheduler._events[i].relatedTo&&s.push(scheduler._events[i].relatedTo),scheduler._events[i].relatedFather)&&s.push(scheduler._events[i].relatedFather);return s}function setCapacityFilter(e,t){contractorSupport&&(capacityDurationFilter=e,t)&&scheduler._is_initialized()&&updateViewDebounced()}function cantLoadGantt(e){$(".keypressEvents")&&($(".bodyDiv").css("background","#fff"),$(".keypressEvents").remove(),$("#ErrorLoadingGantt").show()),$("#ErrorContainer").append(e),-1<e.toUpperCase().indexOf("CPU TIME")?($("#OpenTerritoryButton").show(),$("#OpenTerritoryMessage").show(),$("#OpenTerritoryButton").click(function(){__openLocationFilteringAndReload()})):($("#OpenTerritoryButton").hide(),$("#OpenTerritoryMessage").hide())}function getLocationdIdByResource(e){for(var t=scheduler.serverList("resources"),n=e.split(","),i=0;i<t.length;i++)for(var s=0;s<t[i].children.length;s++)for(var r=0;r<n.length;r++)if(n[r]===t[i].children[s].key)return t[i].key;return null}function absenceTypeIcon(e){return"break"===e?'<svg aria-hidden="true" class="slds-icon tooltipBreakIcon">\n                    <use xlink:href="'+lsdIcons.break+'"></use>\n                </svg>':'<svg aria-hidden="true" class="slds-icon tooltipNAIcon">\n                <use xlink:href="'+lsdIcons.na+'"></use>\n            </svg>'}function getClassByStatus(e){switch(e){case globalCategories.NONE:return"eventStatusNew";case globalCategories.SCHEDULED:return"eventStatusAssigned";case globalCategories.DISPATCHED:return"eventStatusDispatched";case globalCategories.IN_PROGRESS:return"eventStatusTravel";case globalCategories.RUNNING_LONG:return"eventStatusOnSite";case globalCategories.COMPLETED:return"eventStatusCompleted";case globalCategories.MISSED:return"eventStatusIncomplete";case globalCategories.COULD_NOT_COMPLETE:return"eventStatusCouldntComplete";case globalCategories.CANCELED:return"eventStatusCancelled";default:return"eventCustomStatus"}}function getMinAndMaxHoursToDisplay(){var e=scheduler.getState().mode,t=minHourToDisplay,n=maxHourToDisplay,i=null;switch(e){case"ZoomLevel4":i=2;break;case"ZoomLevel5":i=__gantt.horizontalScrolling?1:4;break;case"ZoomLevel6":i=__gantt.horizontalScrolling?1:6;break;case"ZoomLevel7":i=__gantt.horizontalScrolling?1:12}return null!=i&&(t-=t%i,(e=i-n%i)!=i)&&(n+=e),{min:t,max:n}}function isIntersect(e,t,n,i){return e<i&&n<t}function isIntersectIncludeLimits(e,t,n,i){return e<=i&&n<=t}function isMultipleIntersection(e,t){for(var n=0;n<t.length;n++)if(isIntersect(e.start,e.finish,t[n].start,t[n].finish))return!0;return!1}function generateGanttTextColor(e){e=parseInt("0x"+e,16);return 128<.2126*(e>>16&255)+.7152*(e>>8&255)+.0722*(e>>0&255)?"000000":"ffffff"}function formatNumberToLocaleString(e){try{return e.toLocaleString(jsUserLocale)}catch(e){console.warn("Something wrong with your locale settings: "+jsUserLocale)}return e}function formatDateByLocaleWithDayOfTheWeek(e){var t=utils.formatDateWithDayOfWeek(e);return t||(-1!==["en_US"].indexOf(userLocale)?moment(e).format("ddd, MMM D YYYY"):moment(e).format("LL"))}$(function(){moment.locale(userLocale)}),$(function(){svg4everybody(),"function"==typeof srcUp&&$("body").css("margin","0")}),scheduler.attachEvent("onSchedulerReady",function(){function t(e){var t=e.getDay();return window.includeWeekends||(0!=window.firstDayOfTheWeek||5!==t&&6!==t)&&(1!=window.firstDayOfTheWeek||0!==t&&6!==t)?moment(e).format("ddd,  D"):""}scheduler.templates.ZoomLevel1_second_scale_date=function(e){return generateSecondScaleContent(e,formatDateByLocaleWithDayOfTheWeek)},scheduler.templates.MonthlyView_second_scale_date=function(e){return moment(e).format("MMM")},scheduler.templates.MTDView_second_scale_date=scheduler.templates.MonthlyView_second_scale_date,scheduler.templates.LongView_second_scale_date=scheduler.templates.MonthlyView_second_scale_date,scheduler.templates.ZoomLevel2_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel3_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel4_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel5_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel6_second_scale_date=function(e){return generateSecondScaleContent(e,t)},scheduler.templates.ZoomLevel7_second_scale_date=function(e){return generateSecondScaleContent(e,t,!0,!1)},scheduler.templates.ZoomLevel2_date=function(e,t){return e.getDate()!==t.getDate()?formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(t):formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel3_date=function(e,t){return formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel4_date=function(e,t){t=new Date(t);return t.setDate(t.getDate()-1),formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(t)},scheduler.templates.ZoomLevel5_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.ZoomLevel6_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.ZoomLevel7_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MonthlyView_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MTDView_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.LongView_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MonthlyView_scale_date=function(e){e=generateCalendarWeeksData(e);return"<span "+e.calendarWeeksTitle+">"+e.dateDisplay+(__gantt.showCalendarWeeks?" "+customLabels.CalendarWeekLabel.replaceAll(e.calendarWeek):"")+"</span>"},scheduler.templates.LongView_scale_date=function(e){e=generateCalendarWeeksData(e);return"<span "+e.calendarWeeksTitle+">"+e.dateDisplay+"</span>"}});var generateCalendarWeeksData=function(e){var t=moment(e),t=(t._locale._week.dow=window.firstDayOfTheWeek,moment(t).week());return{dateDisplay:moment(e).format("D"),calendarWeek:t,calendarWeeksTitle:__gantt.showCalendarWeeks?'title="'+(__gantt.showCalendarWeeks?customLabels.CalendarWeekNumberLabel.replaceAll(t):"")+'"':""}};function generateHoursMinutes(e){var t;return e<60?customLabels.MinutesGanttTooltip.replace("$0",e):(t=e%60,e=Math.floor(e/60),customLabels.MinutesHoursGanttTooltip.replace("$0",e).replace("$1",t))}function removeLightboxLoading(){$("#lightbox-loading-cover").remove()}function __setTimeZoneOffsetToDateField(e){var t,n,i=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],s=arguments[2],r=window.__gantt.drawingDistanceOnGantt;return e||0===e?(!s&&e&&((t=new Date).setFullYear(t.getFullYear()+r),new Date(e)>t)&&(e=t.getTime()),t=60*new Date(e).getTimezoneOffset()*1e3,n=60*new Date(e+t).getTimezoneOffset()*1e3,new Date(e+t-(t!=n?t-n:0))):i?null:(e=new Date,s?(e=scheduler._min_date&&new Date(scheduler._min_date)?new Date(scheduler._min_date):e).setFullYear(e.getFullYear()-r):(e=scheduler._max_date&&new Date(scheduler._max_date)?new Date(scheduler._max_date):e).setFullYear(e.getFullYear()+r),e)}function generateSecondScaleContent(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],i=!(3<arguments.length&&void 0!==arguments[3])||arguments[3],s=e.toISOString(),t=t(e),e=moment(e),r=(e._locale._week.dow=window.firstDayOfTheWeek,moment(e).week());if(!window.includeWeekends&&!["ZoomLevel2","ZoomLevel3","ZoomLevel4","ZoomLevel5"].includes(scheduler._mode)){e=e.format("dddd");if(0==window.firstDayOfTheWeek&&("Friday"===e||"Saturday"===e))return"";if(1==window.firstDayOfTheWeek&&("Sunday"===e||"Saturday"===e))return""}e=n?" "+customLabels.CalendarWeekLabel.replaceAll(r):", "+customLabels.WeekNumberLabel.replaceAll(r),e="<span>"+t+(__gantt.showCalendarWeeks?e:"")+"</span>";return'<div class="second-scale-content slds '+(n?"two-weeks-cw-label":"")+'" '+(__gantt.showCalendarWeeks?'title="'+t+(__gantt.showCalendarWeeks?", "+customLabels.CalendarWeekNumberLabel.replaceAll(r):"")+'"':"")+">\n                "+(e=matchHolidays(s)?i?generateHolidayButton(s)+e:generateHolidayLink(s,t):e)+"\n            </div>"}function generateHolidayButton(e){return'<button class="slds-button slds-button__icon holiday-toggle holiday-button-icon" data-date="'+e+'" onClick="toggleHolidayPopover(event)">\n                <svg class="slds-button__icon holiday-icon" aria-hidden="true">\n                    <use xlink:href="'+lsdIcons.holiday+'"></use>\n                </svg>\n                <span class="slds-assistive-text">'+customLabels.HolidayOpenPopover+"</span>\n            </button>"}function generateHolidayLink(e,t){return'<a class="holiday-toggle" data-date="'+e+'" onClick="toggleHolidayPopover(event)">'+t+"</a>"}function generateHolidayPopover(e){var t=sortHolidays(e);return'<div aria-label="Holiday" class="slds holiday-popover-wrapper" data-date="'+e+'">\n                <div class="slds-popover slds-nubbin--top holiday-popover">\n                    <div class="holiday-scroll">\n                        <button class="slds-button slds-button__icon slds-float--right slds-popover__close holiday-popover-close" onClick="closeHolidayPopover(event)">\n                            <svg class="slds-button__icon" aria-hidden="true">\n                                <use xlink:href="'+lsdIcons.close+'"></use>\n                            </svg>\n                            <span class="slds-assistive-text">'+customLabels.HolidayClosePopover+"</span>\n                        </button>\n                        <div>\n                            "+generateHolidaySections(t)+"\n                        </div>\n                    <div>\n                </div>\n            </div>"}function generateHolidaySections(e){return e&&'<div class="holiday-sections">'+Object.values(e).map(function(e){return""+generateHolidaySection(e)}).join("")+"</div>"}function generateHolidaySection(e){var t=moment(e.date).format("dddd, LL"),n=(e.isAllDay||(t=moment(e.date).startOf("day").add(e.startTimeInMinutes,"minute").format("LLLL")+" - "+moment(e.date).startOf("day").add(e.endTimeInMinutes,"minute").format("LT")),Object.values(e.territories).map(function(e){return e.name}).sort().join(", "));return'<div class="holiday-section">\n                <header class="holiday-header">\n                    <div class="slds-media slds-media--small slds-media--center slds-has-flexi-truncate">\n                        <div class="slds-media__figure holiday-figure">\n                            <span class="slds-icon_container" title="holiday">\n                                <svg class="slds-icon slds-icon--small slds-icon-text-default" aria-hidden="true">\n                                    <use xlink:href="'+lsdIcons.holiday+'"></use>\n                                </svg>\n                                <span class="slds-assistive-text">holiday</span>\n                            </span>\n                        </div>\n                        <div class="slds-media__body">\n                            <h3 class="slds-text-body--regular"><strong>'+e.name+'</strong></h3>\n                        </div>\n                    </div>\n                    <div class="slds-text-body--small">'+t+'</div>\n                </header>\n                <div>\n                    <div class="slds-text-body--regular">'+customLabels.HolidayObservingTerritories+':</div>\n                    <div class="slds-text-body--regular">'+n+"</div>\n                </div>\n            </div>"}function matchHolidays(e){return(scheduler.serverList("holidays")[0]||{})[e]}function sortHolidays(e){e=Object.values(matchHolidays(e)||{});return e.sort(function(e,t){return Object.values(t.territories).length-Object.values(e.territories).length||e.name.localeCompare(t.name)}),e}function toggleHolidayPopover(e){var e=findOrCreateHolidayPopover($(e.target).closest(".holiday-toggle")),t=e.is(":visible");closeAllHolidayPopovers(),t||togglePopoverInstance(e)}function findOrCreateHolidayPopover(e){var t='.holiday-popover-wrapper[data-date="'+e.data("date")+'"]',n=$(t);n.length||($("body").append(generateHolidayPopover(e.data("date"))),n=$(t));return $(e).data("popper")||(t=Popper.createPopper(e[0],n[0],{modifiers:[{name:"offset",options:{offset:[0,15]}}]}),e.data("popper",t)),n}function closeHolidayPopover(e){togglePopoverInstance($(e.target).closest(".holiday-popover-wrapper"),!0)}function closeAllHolidayPopovers(){$(".holiday-popover-wrapper").each(function(e,t){return togglePopoverInstance($(t),!0)})}function togglePopoverInstance(e){1<arguments.length&&void 0!==arguments[1]&&arguments[1]||e.is(":visible")?e.hide():e.show();var t=e.data("date"),t=$(".holiday-toggle[data-date='"+t+"'").data("popper");t&&t.setOptions({modifiers:[].concat(_toConsumableArray(t.state.options.modifiers),[{name:"eventListeners",enabled:!e.is(":hidden")}])})}function removeAllHolidayPopovers(){var t=this;$(".holiday-toggle").each(function(){var e=$(t).data("popper");e&&(e.destroy(),$(t).removeData("popper"))}),$(".holiday-popover-wrapper").remove()}function hasHolidayInScaleX(n,e){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"minute",i=moment(n).startOf("day").toDate().toISOString(),s=moment(n).add(e,t).toDate();return((scheduler.serverList("holidays")[1]||{})[i]||[]).some(function(e){var t=e.start;return!(e.finish<=n||s<=t)})}$(function(){-1<window.navigator.userAgent.indexOf("Edge")&&(document.body.className+=" EdgeBrowser")}),$(function(){$(document).click(function(e){$(e.target).closest(".holiday-toggle, .holiday-popover-wrapper").length||closeAllHolidayPopovers()})});var optiViewerStatusCategories={},serviceStatusCategories={},BrickBreaker=($.fn.visible=function(e){var t=$(this),n=$(window),i=n.scrollTop(),n=i+n.height(),s=t.offset().top,t=s+t.height();return(!0===e?s:t)<=n&&i<=(!0===e?t:s)},{play:function(){var o=function(){for(var e={scheduled:"#F9D058",new:"#A5E2D6",dispatched:"#8DD8FA",inprogress:"#D68EF9",completed:"#95D055",incomplete:"#EA8288",default:"#B7C9EA"},t=[],n=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),i=0;i<n.length;i++){var s=n[i],r=void 0,o=void 0,a=$(scheduler.getRenderedEvent(s.id));a.visible()&&(o=$(a.children()[0]).width(),"service"==s.type?r=e[s.Status.toLowerCase().replace(" ","")]:"break"==s.type?(r="#5e698f",o=a.width()):"na"==s.type&&(r="#d7dfe7"),t.push({color:r,top:a.offset().top-264,left:a.offset().left-$("#LeftSideContainer").width()+8,width:o,height:scheduler.matrix.ZoomLevel3.event_dy-2,name:s.name,status:1}))}return t}();gameOn=!0,updateViewDebounced(),$("#GanttContainer").append('<div id="bricks-overlay" style="position:absolute; top:100px; z-index:100">\n                                            <canvas id="brick-canvas"></canvas>\n                                        </div>');var a=(e=$(".dhx_cal_data")).width(),e=e.height(),l=document.getElementById("brick-canvas"),c=(l.width=a,l.height=e,l.getContext("2d")),d=15,u=l.width/2,p=l.height-30,m=5,h=-5,g=15,v=95,f=($("body").width()-v)/2,S=0,_=3;function t(e){e=e.clientX-l.offsetLeft;0<e&&e<l.width&&(f=e-v/2)}function b(){gameOn=!1,document.removeEventListener("mousemove",t),updateViewDebounced(),$("#bricks-overlay").remove()}return 15<$(".item").length||$(".item").length,document.addEventListener("mousemove",t,!1),function e(){c.clearRect(0,0,l.width,l.height);for(var t,n,i,s,r=0;r<o.length;r++)0!=o[r].status&&(t=o[r].left,n=o[r].top,i=o[r].width,s=o[r].height,c.beginPath(),c.rect(t,n,i,s),c.fillStyle=o[r].color,c.fill(),40<=i&&(c.font="10px Salesforce Sans",c.fillStyle="#000",c.fillText(o[r].name,t+5,n+10)),c.closePath());if(c.beginPath(),c.arc(u,p,d,0,2*Math.PI),c.fillStyle="#0095DD",c.fill(),c.closePath(),c.beginPath(),c.rect(f,l.height-g,v,g),c.fillStyle="#0095DD",c.fill(),c.closePath(),function(){for(var e=0;e<o.length;e++){var t=o[e];if(1==t.status&&t.left<=u&&u<=t.left+t.width&&t.top<=p&&p<=t.top+t.height&&(h=-h,t.status=0,(S+=10)/10==o.length))return alert("You win, great... ¯\\_(ツ)_/¯. back to work"),b()}}(),c.font="16px Salesforce Sans",c.fillStyle="#0095DD",c.fillText("Score: "+S+", Lives: "+_,a/2,25),(u+m>l.width-d||u+m<d)&&(m=-m),p+h<d)h=-h;else if(p+h>l.height-d)if(f<u&&u<f+v)h=-h;else{if(!--_)return alert("GAME OVER - back to work"),void b();u=l.width/2,p=l.height-30,h=-(m=5),f=(l.width-v)/2}u+=m,p+=h,requestAnimationFrame(e)}(),"GAME ON!"}}),schedulerConfig=(setTimeout(function e(){postMessage(10),setTimeout(e,1e4)},1e4),function(){var e={dateTitleFormat:"%D, %F %d",dateFormat:"%g:%i%A",resourceCellSize:170,locationCellHeight:44,rowHeight:46,eventHeight:42};return{timelineConfigs:e,configTimelines:function(){scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel2",x_unit:"minute",x_date:e.dateFormat,x_step:30,x_size:16,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel3",x_unit:"minute",x_date:e.dateFormat,x_step:60,x_size:24,x_start:0,x_length:24,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel4",x_unit:"minute",x_date:e.dateFormat,x_step:120,x_size:24,x_start:0,x_length:12,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel5",x_unit:"minute",x_date:e.dateFormat,x_step:240,x_size:18,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel6",x_unit:"minute",x_date:e.dateFormat,x_step:360,x_size:28,x_start:0,x_length:4,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel7",x_unit:"minute",x_date:e.dateFormat,x_step:720,x_size:28,x_start:0,x_length:2,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"MonthlyView",x_unit:"day",x_date:"%d",x_step:1,x_size:14,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"MTDView",x_unit:"day",x_date:"%d",x_step:1,x_size:35,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"LongView",x_unit:"day",x_date:"%d",x_step:1,x_size:20,x_start:0,x_length:7,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort})},setRowHeights:function(e,t){var n=32;switch(e){case"xsmall":n=27;break;case"small":n=32;break;case"normal":n=39;break;case"large":n=46;break;default:n=39}if(scheduler.matrix.ZoomLevel3.dy!==n){for(var i in scheduler.matrix)scheduler.matrix[i].dy=n,scheduler.matrix[i].event_dy=n-4,scheduler.matrix[i].folder_dy=n+2;t&&scheduler._is_initialized()&&scheduler.setCurrentView()}},setReadOnly:function(e){scheduler.config.readonly=e},setConfigurations:function(){var e="rtl"===document.querySelector("html").getAttribute("dir");scheduler.config.drag_resize=!1,scheduler.config.multisection=!0,scheduler.config.multisection_shift_all=!1,scheduler.config.limit_drag_out=!1,scheduler.config.dblclick_create=!1,scheduler.config.mark_now=!1,scheduler.config.time_step=1,scheduler.dhtmlXTooltip.config.className="dhtmlXTooltip tooltip expertTooltip",scheduler.dhtmlXTooltip.config.timeout_to_display=375,scheduler.dhtmlXTooltip.config.delta_x=10,scheduler.dhtmlXTooltip.config.delta_y=0,scheduler.config.minicalendar.mark_events=!1,scheduler.config.preserve_length=!1,scheduler.config.rtl=e,scheduler.config.touch=!1},sortEvents:function(e,t){var n=new Date(e.start_date),i=new Date(e.end_date),s=new Date(t.start_date),r=new Date(t.end_date);return"na"===e.type&&"na"!==t.type?(r<n||i<s)&&+s<+n?1:-1:"na"===t.type&&"na"!==e.type?!(i<s||r<n)||+s<+n?1:-1:+s<+n?1:-1}}}());function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.calendar_month=function(t){try{return new Intl.DateTimeFormat(window.userLocale.replace("_","-"),{month:"short",year:"numeric"}).format(t)}catch(e){return moment(t).format("LL")}},scheduler.templates.calendar_date=function(e){return moment(e).format("DD")},scheduler.templates.calendar_scale_date=function(e){return moment(e).format("ddd")},scheduler.templates.calendar_time=function(e){return moment(e).format("l")}}),angular.module("serviceExpert").controller("ctrlGanttOptiViewer",["$scope","$rootScope","$q","BundleService","BundleActions","sfdcService","servicesService","utils","calendarsService","userSettingsManager","resourceFilterHelper","monthlyViewHelperService","ResourcesAndTerritoriesService","TimePhasedDataService","StateService","CapacityLightboxService","ResourceSmallMenu","AbsencesService","SkillsService","AbsenceLightboxService","ResourceLightboxService","ServiceAppointmentLightboxService","kpiCalculationsService","ResourceCapacitiesService","ResourceCrewsService","SERVICE_STATUS","SERVICE_CATEGORY","GetSlotsService","bulkScheduleService","GeneralLightbox","StreamingClientResolverService","StreamingAPIService","OptimizationRequestsService","GanttPalettesService",function(g,s,e,v,f,a,S,b,G,n,r,B,c,d,y,H,V,l,i,u,U,o,p,z,j,w,W,q,Z,m,K,Y,h,T){var L="",A="",I={},C=!0,k=new dhtmlXMenuObject({parent:"contextZone_A",context:!0}),D=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});function t(){g.currentViewOptions.numOfMonths<=2?(scheduler.matrix.LongView.x_unit="day",scheduler.matrix.LongView.x_length=7,scheduler.matrix.LongView.x_size=30*g.currentViewOptions.numOfMonths):(scheduler.matrix.LongView.x_unit="week",scheduler.matrix.LongView.x_size=Math.ceil(4.5*g.currentViewOptions.numOfMonths),scheduler.matrix.LongView.x_length=1)}k.setOverflowHeight(15),D.setOverflowHeight(15),g.selectedGanttServices={},g.resourceFilterHelper=r,g.StateService=y,g.resources=[],g.searchEmployee="",g.resourceFieldToSortyBy="Name",g.successfullyScheduled=0,g.currentSchedulingIndex=0,g.timelineName="",g.nowTimespans=[],g.selectedSkills={},g.pinnedStatusesSF=CustomSettings.pinnedStatusesSF.split(","),g.hasCustomPermission=b.hasCustomPermission,g.crewViewActive=!1,g.crewsFilter=b.crewsFilter,g.useResourceSkillFilter=useResourceSkillFilter,g.numberOfDaysInUtilizationView=14,g.skillsLogicOperator=n.GetUserSettingsProperty("Skills_Logic_Operator__c")||"and",g.locations=n.GetUserSettingsProperty("locations")||[],g.isOptimizationViewer=!0,s.isOptimizationViewer=!0,g.editPalette=b.hasCustomPermission("Gantt_Palettes_Edit"),g.viewPalette=b.hasCustomPermission("Gantt_Palettes_View"),scheduler.attachEvent("onTemplatesReady",function(){scheduler.matrix.MonthlyView&&(scheduler.matrix.MonthlyView.x_size=n.GetUserSettingsProperty("DaysInUtilizationView__c")||14,g.numberOfDaysInUtilizationView=scheduler.matrix.MonthlyView.x_size),t()}),__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Gantt_Locker?g.ganttLocked=n.GetUserSettingsProperty("Lock_Gantt__c")||!1:(g.ganttLocked=!0,scheduler.config.readonly=!0),scheduler.config.readonly=g.ganttLocked,g.currentViewOptions={highlightWeekeneds:n.GetUserSettingsProperty("Highlight_Weekeneds__c")||!1,minServiceDuration:void 0===n.GetUserSettingsProperty("Longterm_Min_Service_Duration__c")?8:n.GetUserSettingsProperty("Longterm_Min_Service_Duration__c"),minNaDuration:void 0===n.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c")?8:n.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c"),numOfMonths:n.GetUserSettingsProperty("Longterm_Num_Of_Months__c")||1,showMdt:n.GetUserSettingsProperty("Show_Only_MDT_In_Longterm__c")||!1},window.__currentViewOptions=g.currentViewOptions,g.saveMdtFilterSa=_.debounce(function(){n.SetUserSettingsProperty("Show_Only_MDT_In_Longterm__c",g.currentViewOptions.showMdt),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.updateGanttDates()},400),g.saveHighlightWeekends=_.debounce(function(){n.SetUserSettingsProperty("Highlight_Weekeneds__c",g.currentViewOptions.highlightWeekeneds),updateViewDebounced()},400),g.saveMinimumLongtermServiceDuration=_.debounce(function(){n.SetUserSettingsProperty("Longterm_Min_Service_Duration__c",g.currentViewOptions.minServiceDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.updateGanttDates()},400),g.saveMinimumLongtermAbsenceDuration=_.debounce(function(){n.SetUserSettingsProperty("Longterm_Min_Absence_Duration__c",g.currentViewOptions.minNaDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.updateGanttDates()},400),g.handleLongTermViewSizeChange=_.debounce(function(){var e=n.GetUserSettingsProperty("Longterm_Num_Of_Months__c");g.currentViewOptions.numOfMonths||(g.currentViewOptions.numOfMonths=1),n.SetUserSettingsProperty("Longterm_Num_Of_Months__c",g.currentViewOptions.numOfMonths),t(),"LongView"===scheduler._mode&&scheduler.setCurrentView(),e<g.currentViewOptions.numOfMonths&&g.updateGanttDates()},200),g.shouldShowSkill=function(e,t){return e.toUpperCase().includes(t.toUpperCase())},g.saveUserPropSkillsLogic=function(){n.SetUserSettingsProperty("Skills_Logic_Operator__c",g.skillsLogicOperator)},g.paletteViewActive=!1,g.showPaletteView=function(){window.paletteViewActive=!0,g.paletteViewActive=!0,updateViewDebounced()},g.hidePaletteView=function(){window.paletteViewActive=!1,g.paletteViewActive=!1,updateViewDebounced()},g.$watch("StateService.isLoadingNewLocations",function(e,t){void 0!==t&&!1!==t||1!=e||(g.paletteViewActive=!1)}),s.statusTranslations=b.statusTranslations,s.$on("moveToCrewView",function(){s.crewViewActive=!0,g.crewViewActive=!0,d.isCrewViewActive=!0}),g.$watch("resourceFilterHelper",function(e,t){$("#resourceExplainCrap").html(g.resourceFilterHelper.generateFilterExplanation(g.resourceFilters.showWorkingResource)),angular.equals(e,t)||n.SetUserSettingsProperty("Resource_Filter__c",JSON.stringify({sortBy:g.resourceFilterHelper.resourceFieldToSortyBy,asc:g.resourceFilterHelper.descending,showWorkingResource:g.resourceFilters.showWorkingResource,booleanFields:g.resourceFilterHelper.selectionInfo.resourceFilteringOptions,picklistField:g.resourceFilterHelper.selectionInfo.selectedPicklist,picklistOptions:g.resourceFilterHelper.selectionInfo.picklistOptions,picklistOptionsModel:g.resourceFilterHelper.selectionInfo.picklistOptionsModel,picklistNullValues:g.resourceFilterHelper.selectionInfo.picklistNullValues,crewsOption:g.resourceFilterHelper.selectionInfo.crewsSelectionOptions.selectedPicklist}))},!0),g.absencesTypeLoaded=!1,g.defaultDragNa={selectedNaDuration:JSON.parse(n.GetUserSettingsProperty("Drag_Na_Duration__c"))||60,selectedNaType:n.GetUserSettingsProperty("Drag_Na_Type__c"),selectedNaLabel:n.GetUserSettingsProperty("Drag_Na_Label__c")},g.getEmployeeAbsenceTypes=function(){g.absencesTypeLoaded||l.getEmployeeAbsenceTypes().then(function(e){g.absencesTypeLoaded=!0,g.nonAvailabilityTypes=e,g.defaultDragNa.selectedNaType=n.GetUserSettingsProperty("Drag_Na_Type__c")||g.nonAvailabilityTypes[Object.keys(g.nonAvailabilityTypes)[0]]})},g.businessHoursRange={start:b.ganttSettings.startHour,end:b.ganttSettings.finishHour,includeWeekends:n.GetUserSettingsProperty("Include_Weekends__c")},g.resourceFilters={showWorkingResource:!!JSON.parse(n.GetUserSettingsProperty("Resource_Filter__c"))&&JSON.parse(n.GetUserSettingsProperty("Resource_Filter__c")).showWorkingResource,resourcesWorkingInRange:{}},g.isInConsole=y.isInConsole,g.openConsoleTab=b.openConsoleTab,g.capacityFields=B.capacityCalculationFields,Object.defineProperty(g.selectedGanttServices,"getSelected",{enumrable:!1,value:function(){var e,t=[];for(e in this)this[e]&&t.push(e);return t}}),g.isGanttFilterApplied=function(){return b.crewsFilter||g.skillsFilter||r.isResourceFilterApplied()||g.resourceFilters.showWorkingResource},cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix"));var R=!0;function F(){var e;R?R=!1:(setHoursToDisplay(g.businessHoursRange.start,g.businessHoursRange.end,g.businessHoursRange.includeWeekends),scheduler.setCurrentView(),b.ganttSettings.startHour=g.businessHoursRange.start,b.ganttSettings.finishHour=g.businessHoursRange.end,(e={}).Gantt_View_Start_Hour__c=b.ganttSettings.startHour,e.Gantt_View_Finish_Hour__c=b.ganttSettings.finishHour,e.Include_Weekends__c=g.businessHoursRange.includeWeekends,n.SetUserSettingProperties(e))}function O(e,t){null!==(t=""===t?prompt(customLabels.msg_to_post_to_chatter,""):t)&&(""===t?alert(customLabels.no_empty_msg_to_chatter):(1===e.length&&(S.recentlyUsed[e[0]]=!0),S.postToChatter(e,t).then(function(e){})))}g.$watchCollection("businessHoursRange",F),c.promises.resources().then(function(){g.resources=c.getResources}),g.saveDragNaDefaults=function(e){switch(e){case"duration":n.SetUserSettingsProperty("Drag_Na_Duration__c",g.defaultDragNa.selectedNaDuration);break;case"type":n.SetUserSettingsProperty("Drag_Na_Type__c",g.defaultDragNa.selectedNaType);break;case"label":n.SetUserSettingsProperty("Drag_Na_Label__c",g.defaultDragNa.selectedNaLabel)}},g.getTimePhasedObjects=function(e){var t=scheduler.getState().min_date,n=scheduler.getState().max_date,i=864e5;return"LongView"===scheduler._mode&&(i*=scheduler.matrix.LongView.x_length),"left"===e?(t.setTime(t.getTime()-i),n.setTime(n.getTime()-i)):"right"===e&&(t.setTime(t.getTime()+i),n.setTime(n.getTime()+i)),d.getTimePhasedObjects(t,n).then(function(e){var t;s.$broadcast("ganttFinishedLoadingServices"),updateViewDebounced(),C&&("Always"!==window.__gantt.checkRulesMode&&p.calculateKpis(),C=!1,updateViewDebounced(),t=null,-1<document.URL.indexOf("service=")&&(t=document.URL.substr(document.URL.indexOf("service=")+8,18)),scheduler._events[t]?(scheduler._select_id=t,scheduler.select(t),setTimeout(function(){b.showOnGantt(t)},0)):t&&alert(customLabels.cant_display_service))})},g.updateGanttDates=function(e){var t=scheduler.getState().min_date,n=scheduler.getState().max_date,i=864e5;return"LongView"===scheduler._mode&&(i*=scheduler.matrix.LongView.x_length),"left"===e?(t.setTime(t.getTime()-i),n.setTime(n.getTime()-i)):"right"===e&&(t.setTime(t.getTime()+i),n.setTime(n.getTime()+i)),function(e){var t;s.$broadcast("ganttFinishedLoadingServices"),updateViewDebounced(),C&&("Always"!==window.__gantt.checkRulesMode&&p.calculateKpis(),C=!1,updateViewDebounced(),t=null,-1<document.URL.indexOf("service=")&&(t=document.URL.substr(document.URL.indexOf("service=")+8,18)),scheduler._events[t]?(scheduler._select_id=t,scheduler.select(t),setTimeout(function(){b.showOnGantt(t)},0)):t&&alert(customLabels.cant_display_service))}},g.changeDatesByArrows=function(e){updateViewDebounced(),g.updateGanttDates(e)},scheduler.attachEvent("onDblClick",function(e,t){b.safeApply(g,function(){("service"===scheduler.getEvent(e).type?(S.recentlyUsed[e]=!0,o):"contractorcapacity"===scheduler.getEvent(e).type?H:u).open(e)})}),scheduler.attachEvent("onBeforeFolderToggle",function(e,t){return folderJustToggled=!0,b.safeApply(g,function(){y.ganttOpenedTerritories[e.key]=t,J()}),!0});var J=_.debounce(function(){n.SetUserSettingsProperty("Toggled_Territories__c",JSON.stringify(y.ganttOpenedTerritories))},800);function M(){for(var e in g.selectedGanttServices)delete g.selectedGanttServices[e]}scheduler.attachEvent("onBeforeViewChange",function(e,t,n,i){return"MonthlyView"===e&&"MonthlyView"!==n&&"__Utilization__"===r.resourceFieldToSortyBy&&(r.resourceFieldToSortyBy="Name"),!0}),scheduler.attachEvent("onViewChange",function(e,t){removeAllHolidayPopovers(),b.safeApply(g,function(){switch(scheduler._mode){case"ZoomLevel2":g.timelineName=customLabels.In_Day;break;case"ZoomLevel3":g.timelineName=customLabels.Daily;break;case"ZoomLevel4":g.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":g.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":g.timelineName=customLabels.Weekly;break;case"ZoomLevel7":g.timelineName=customLabels.TwoWeeks;break;case"MonthlyView":g.timelineName=customLabels.Utilization;break;case"MTDView":g.timelineName=customLabels.MDTVIEW;break;case"LongView":g.timelineName=customLabels.LongView}$("#MonthlyLocationViewTooltip").remove(),N(),updateViewDebounced(),scheduler._old.mode===e&&scheduler._old.date===t||p.calculateKpis()})}),scheduler.attachEvent("onBeforeDrag",function(e,t,n){if(!e||!scheduler._events[e].isDummy&&!window.__lockedServicesIds[e]){var i=void 0,n=n.ctrlKey||n.metaKey;if(!e||"create"===t){if(!n)for(i in g.selectedGanttServices)g.selectedGanttServices[i]=!1,scheduler.getRenderedEvent(i)&&scheduler.updateEvent(i);return!1}if(e&&"service"===scheduler.getEvent(e).type){if(n)return D.hide(),g.selectedGanttServices[e]?g.selectedGanttServices[e]=!1:g.selectedGanttServices[e]=!0,scheduler.updateEvent(e),!1;for(i in g.selectedGanttServices[e]=!0,g.selectedGanttServices)i!==e&&(g.selectedGanttServices[i]=!1,scheduler.getEvent(i))&&scheduler.getSection(scheduler.getEvent(i).resourceId)&&scheduler.updateEvent(i)}else if(!n&&1<=g.selectedGanttServices.getSelected().length)for(i in g.selectedGanttServices)g.selectedGanttServices[i]=!1,scheduler.getRenderedEvent(i)&&scheduler.updateEvent(i);if((window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Drag_And_Drop||!scheduler._events[e])&&!("service"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type||e&&"service"===scheduler.getEvent(e).type&&scheduler.getEvent(e).pinned&&preventUpdateOfPinned))return!0}}),g.$watchCollection("selectedGanttServices",function(e,t){globalSelectedGanttServices=g.selectedGanttServices}),g.jumpToDate=function(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"JumpToDate",date:scheduler._date,navigation:!0,handler:function(e,t){scheduler.setCurrentView(e),scheduler.destroyCalendar(),g.changeDatesByArrows()}})};var E=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});E.setOverflowHeight(15),E.addNewChild(E.topId,0,"details",b.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),E.attachEvent("onClick",function(e,t,n){switch(e){case"details":b.safeApply(g,function(){u.open(A)});break;case"delete":b.safeApply(g,function(){confirm(customLabels.naDeleteConfirm)&&l.deleteAbsence(A).then(function(e){e?scheduler.deleteEvent(A):alert(customLabels.Failed_To_Delete_Break)})});break;default:var i,s,r,o;0===e.indexOf("custom_")&&(i=scheduler._events[A].type,r=parseInt(e.split("_")[1]),(s=b.getCustomActions(i)[r]).visualforce?(r=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),o=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),m.open(s.name,s.visualforce+"?id="+A+"&type="+i+"&start="+r+"&end="+o)):a.callRemoteAction(RemoteActions.runCustomAbsenceAction,s.className,A,i,scheduler._min_date,scheduler._max_date).then(function(e){e&&b.addNotification(s.name,e,null,null)}).catch(function(e){return b.addNotification(s.name,e.message,null,null)}))}}),k.addNewChild(k.topId,0,"details",b.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),k.addNewChild(k.topId,3,"reschedule",b.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),window.customPermissions.Enable_Check_Rules&&k.addNewChild(k.topId,12,"validate",b.getSVGIconHTML(lsdIcons.violation)+customLabels.check_rules_action_label,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,4,"candidates",b.getSVGIconHTML(lsdIcons.candidates)+customLabels.Get_Candidates,!1),k.addNewChild(k.topId,10,"reshuffle",b.getSVGIconHTML(lsdIcons.retweet)+customLabels.Reshuffle,!1),k.addNewChild(k.topId,11,"groupNearby",b.getSVGIconHTML(lsdIcons.groupNearby)+customLabels.GroupNearby,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,5,"status",b.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),k.addNewChild(k.topId,6,"map",b.getSVGIconHTML(lsdIcons.world)+customLabels.Map,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,8,"unschedule",b.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),fieldTrackingEnabled.service&&(k.addNewChild(k.topId,7,"chatter",b.getSVGIconHTML(lsdIcons.chat)+customLabels.Chatter+"<i id='chatterArrowContext' class='fa fa-caret-right chatter-carret'></i>",!1),k.addNewChild("chatter",0,"chatter_welldone",b.getSVGIconHTML(lsdIcons.like)+customLabels.well_done,!1),k.addNewChild("chatter",1,"chatter_hurryup",b.getSVGIconHTML(lsdIcons.hurry)+customLabels.Hurry_up,!1),k.addNewChild("chatter",2,"chatter_requestupdate",b.getSVGIconHTML(lsdIcons.help)+customLabels.Request_update,!1),k.addNewChild("chatter",3,"chatter_custom",b.getSVGIconHTML(lsdIcons.threedots)+customLabels.Custom_message,!1)),b.customActionsPromise.then(function(){b.getCustomActions("gantt").forEach(function(e,t){e.icon?k.addNewChild(k.topId,12+t,"custom_"+t,b.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1):k.addNewChild(k.topId,12+t,"custom_"+t,e.name.encodeHTML(),!1)})}),v.isActive()&&b.hasCustomPermission("Bundle_Unbundle")&&(k.addNewChild(k.topId,41,"bundler",b.getSVGIconHTML(f.Bundle.icon)+f.Bundle.label,!1),k.addNewChild(k.topId,42,"unbundler",b.getSVGIconHTML(f.Unbundle.icon)+f.Unbundle.label,!1));var x={};function P(e){for(var t in g.selectedGanttServices)g.selectedGanttServices[t]&&(S.flagged[t]=e);updateViewDebounced()}function X(e){var e=0<arguments.length&&void 0!==e?e:1,t=Math.abs(scheduler._max_date.getTime()-scheduler._min_date.getTime()),t=Math.ceil(t/864e5)*e,e=new Date(scheduler._min_date);e.setDate(e.getDate()+t),scheduler.setCurrentView(e,scheduler._mode)}function N(){if(scheduler._is_initialized()&&g.datalessMethods){for(var e=0;e<g.nowTimespans.length;e++)scheduler.deleteMarkedTimespan(g.nowTimespans[e]);g.nowTimespans.length=0;for(var t=scheduler.serverList("resources"),n=getMinAndMaxHoursToDisplay(),i=0;i<t.length;i++){var s=new Date,s=new Date(s.valueOf()+6e4*s.getTimezoneOffset());if(useLocationTimezone?s.setMinutes(s.getMinutes()+b.getLocationOffset(s,t[i].key)):s=b.convertDateBetweenTimeZones(s,"GMT",userTimeZone),n.min<=s.getHours()&&s.getHours()<n.max&&!g.datalessMethods.isDateInsideWeekend(s)&&"MonthlyView"!==scheduler._mode){var r={};r[scheduler.getState().mode]=[];for(var o=0;o<t[i].children.length;o++)r[scheduler.getState().mode].push(t[i].children[o].key);g.nowTimespans.push(scheduler.addMarkedTimespan({start_date:s,end_date:scheduler.date.add(s,1,"minute"),css:"dhx_now_time dhx_matrix_now_time",sections:r}))}}}}scheduler.attachEvent("onContextMenu",function(e,t){if(!scheduler.config.readonly){if(e&&"service"!==scheduler.getEvent(e).type&&"break"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type)return!1;var n;if(v.isActive()&&(i=g.selectedGanttServices.getSelected(),n=[],i.map(function(e){n.push(scheduler._events[e])}),b.hasCustomPermission("Bulk_Bundle")&&(D.hideItem("bundler"),f.Bundle.canInvoke(n))&&D.showItem("bundler"),b.hasCustomPermission("Bulk_Unundle"))&&(D.hideItem("unbundler"),f.Unbundle.canInvoke(n))&&D.showItem("unbundler"),e){k.hide(),D.hide(),E.hide(),scheduler.dhtmlXTooltip.hide();var i=0,s=0;if(t.pageX||t.pageY?(i=t.pageX,s=t.pageY):(t.clientX||t.clientY)&&(i=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,s=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),g.selectedGanttServices.getSelected().length<2)if("break"===scheduler._events[e].type)E.removeItem("delete"),b.getCustomActions("na").forEach(function(e,t){E.removeItem("custom_"+t)}),b.getCustomActions("break").forEach(function(e,t){E.removeItem("custom_"+t)}),b.getCustomActions("break").forEach(function(e,t){E.addNewChild(k.topId,t+10,"custom_"+t,b.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1)}),E.showContextMenu(i,s),A=e;else if("na"===scheduler._events[e].type)E.removeItem("delete"),E.addNewChild(E.topId,1,"delete",b.getSVGIconHTML(lsdIcons.delete)+customLabels.Delete,!1),b.getCustomActions("na").forEach(function(e,t){E.removeItem("custom_"+t)}),b.getCustomActions("break").forEach(function(e,t){E.removeItem("custom_"+t)}),b.getCustomActions("na").forEach(function(e,t){E.addNewChild(k.topId,12+t,"custom_"+t,b.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1)}),E.showContextMenu(i,s),A=e;else{for(var r=e,o=!1,a=0;a<g.pinnedStatusesSF.length;a++)scheduler._events[r].status===g.pinnedStatusesSF[a]&&(o=!0);if(v.isActive()&&b.hasCustomPermission("Bundle_Unbundle")&&(f.Bundle.canInvoke([scheduler._events[r]])?k.showItem("bundler"):k.hideItem("bundler"),f.Unbundle.canInvoke([scheduler._events[r]])?k.showItem("unbundler"):k.hideItem("unbundler")),scheduler._events[r].pinned||o?(k.hideItem("reschedule"),k.hideItem("candidates"),k.hideItem("unschedule"),k.hideItem("status"),k.hideItem("reshuffle"),k.hideItem("groupNearby")):(k.showItem("reschedule"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("candidates"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("unschedule"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("status"),k.showItem("reshuffle"),k.showItem("groupNearby")),scheduler._events[r].pinned?k.hideItem("status"):(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("status"),scheduler._events[r].latitude&&scheduler._events[r].longitude&&b.hasCustomPermission("Group_Nearby")?k.showItem("groupNearby"):k.hideItem("groupNearby"),b.hasCustomPermission("Schedule")?scheduler._events[r].relatedService1&&scheduler._events[r].isImmidietlyFollow?(k.hideItem("reschedule"),k.hideItem("candidates")):scheduler._events[r].isImmidietlyFollow||k.showItem("reschedule"):k.hideItem("reschedule"),b.hasCustomPermission("Reshuffle")?k.showItem("reshuffle"):k.hideItem("reshuffle"),k.removeItem("showRelated"),(scheduler._events[r].isServiceInChain||scheduler._events[r].relatedTo||scheduler._events[r].relatedFather)&&k.addNewChild(k.topId,5,"showRelated",b.getSVGIconHTML(lsdIcons.related)+customLabels.Show_related,!1),y.isMapEnabled()&&null!==scheduler._events[r].latitude?k.showItem("map"):k.hideItem("map"),k.removeItem("flag"),S.flagged[r]?k.addNewChild(k.topId,1,"flag","<span class='emptyFlag'>"+b.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Unflag,!1):k.addNewChild(k.topId,1,"flag","<span class='fullFlag'>"+b.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Flag,!1),k.removeItem("pin"),scheduler._events[r].pinned?(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,9,"pin","<span class='emptyFlag'>"+b.getSVGIconHTML(lsdIcons.unpin)+"</span>"+customLabels.Unpin,!1):(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,9,"pin","<span class='fullFlag'>"+b.getSVGIconHTML(lsdIcons.pin)+"</span>"+customLabels.Pin,!1),k.removeItem("consoleTab"),g.isInConsole()&&k.addNewChild(k.topId,1,"consoleTab",b.getSVGIconHTML(lsdIcons.external)+customLabels.Open_Tab,!1),!scheduler.getEvent(e).pinned){var l=scheduler.getEvent(e).status,c=void 0,d=0;if(_.isEmpty(b.statusFlow)){if(k.removeItem("status"),!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)for(var u in k.addNewChild(k.topId,5,"status",b.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),b.statuses)c="ContextMenu_"+b.statusTranslations[b.statuses[u]].split(" ").join(""),k.addNewChild("status",d,"status_change_"+d,"<span class='StatusColorChanger "+c+" "+b.getCSSClassForContext(b.statusTranslations[b.statuses[u]],w)+"'></span>"+b.statusTranslations[b.statuses[u]],!1),x["status_change_"+d++]=b.statuses[u]}else if(b.statusFlow[l]&&0<b.statusFlow[l].length)for(k.removeItem("status"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,5,"status",b.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),x={},d=0;d<b.statusFlow[l].length;d++)c="ContextMenu_"+b.statusFlow[l][d].split(" ").join(""),k.addNewChild("status",d,"status_change_"+d,"<span class='StatusColorChanger "+c+" "+b.getCSSClassForContext(b.statusFlow[l][d],w)+"'></span>"+b.statusTranslations[b.statusFlow[l][d]],!1),x["status_change_"+d]=b.statusFlow[l][d];else k.removeItem("status")}k.showContextMenu(i,s),L=e}else{if(D.removeItem("selectedNumber"),D.addNewChild(D.topId,0,"selectedNumber","<i class='fa fa-check-square-o'></i> "+customLabels.x_services_selected.replaceAll(g.selectedGanttServices.getSelected().length),!0),D.removeItem("status"),!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226){D.addNewChild(D.topId,4,"status",b.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),x={};var p,m=0;for(p in b.statuses){var h="ContextMenu_"+b.statusTranslations[b.statuses[p]].split(" ").join("");D.addNewChild("status",m,"status_change_"+m,"<span class='StatusColorChanger "+h+" "+b.getCSSClassForContext(b.statusTranslations[b.statuses[p]],w)+"'></span>"+b.statusTranslations[b.statuses[p]],!1),x["status_change_"+m++]=b.statuses[p]}}D.showContextMenu(i,s)}return!1}A=L=""}return!0}),k.attachEvent("onShow",function(e){contextShown=!0}),k.attachEvent("onHide",function(e){contextShown=!1}),E.attachEvent("onShow",function(e){contextShown=!0}),E.attachEvent("onHide",function(e){contextShown=!1}),k.attachEvent("onClick",function(s,e,t){g.$evalAsync(function(){switch(s){case"bundler":f.Bundle.invoke([scheduler._events[L]],y.selectedPolicyId).then(function(e){M()},function(e){});break;case"unbundler":f.Unbundle.invoke([scheduler._events[L]],y.selectedPolicyId).then(function(){M()},function(){M()});break;case"details":b.safeApply(g,function(){o.open(L)});break;case"consoleTab":g.openConsoleTab(null,L);break;case"flag":g.$evalAsync(function(){S.flagged[L]=!S.flagged[L],scheduler.updateEvent(L)});break;case"pin":S.changePin([scheduler._events[L].id],!scheduler._events[L].pinned).then(function(){return updateViewDebounced()});break;case"reschedule":g.$evalAsync(function(){S.autoScheduleService(L).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),S.drawServicesAndAbsences(e.services,e.absences)}).catch(function(e){var t=d.serviceAppointments()[L].name;b.addNotification(t+" - "+customLabels.Action_Could_Not_Be_Performed,e.message,function(){o.open(L)})})});break;case"reshuffle":g.$evalAsync(function(){a.callRemoteAction(RemoteActions.runReshuffle,L,y.selectedPolicyId).then(function(e){},function(e){b.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)})});break;case"groupNearby":g.$evalAsync(function(){a.callRemoteAction(RemoteActions.runGroupNearby,L,y.selectedPolicyId).then(function(e){},function(e){b.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)})});break;case"candidates":q.get(L);break;case"chatter_welldone":O([L],customLabels.Well_done_mate);break;case"chatter_hurryup":O([L],customLabels.hurry_up_with_this_service);break;case"chatter_requestupdate":O([L],customLabels.please_update_service);break;case"chatter_custom":O([L],"");break;case"unschedule":g.$evalAsync(function(){ee([L])});break;case"map":g.showOnMap(L);break;case"showRelated":usingNewMstModel||scheduler._events[L].isServiceInChain?m.open(customLabels.ComplexRelatedServicesForGanttLB+" "+scheduler._events[L].name,mstPage+"?ingantt=true&id="+L):scheduler._events[scheduler._events[L].relatedFather]?b.showOnGantt(scheduler._events[L].relatedFather):scheduler._events[scheduler._events[L].relatedTo]?b.showOnGantt(scheduler._events[L].relatedTo):scheduler._events[L].relatedFather?alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[L].relatedFather].name)):alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[L].relatedTo].name));break;case"validate":S.checkRules([L]).then(S.drawViolationsOnGantt);break;default:if(0===s.indexOf("custom_")){var e=parseInt(s.split("_")[1]),t=[L],n=b.getCustomActions("gantt")[e];if(n.visualforce){var e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),i=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();m.open(n.name,n.visualforce+"?id="+L+"&start="+e+"&end="+i);break}a.callRemoteAction(RemoteActions.runCustomServiceAction,n.className,t,scheduler._min_date,scheduler._max_date).then(function(e){e&&b.addNotification(n.name,e,null,null)}).catch(function(e){return b.addNotification(n.name,e.message,null,null)})}else g.$evalAsync(function(){te([L],x[s])})}})}),$(".dhtmlxMenu_dhx_skyblue_SubLevelArea_Polygon").mouseover(function(){scheduler.dhtmlXTooltip.hide()}),D.addNewChild(D.topId,1,"flag",b.getSVGIconHTML(lsdIcons.flag)+customLabels.Flag,!1),D.addNewChild(D.topId,2,"unflag","<span class='emptyFlag'>"+b.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Unflag,!1),D.addNewChild(D.topId,3,"reschedule",b.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),window.customPermissions.Enable_Check_Rules&&D.addNewChild(D.topId,12,"validate",b.getSVGIconHTML(lsdIcons.violation)+customLabels.check_rules_action_label,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,5,"unschedule",b.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),(!window.customPermissions.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.customPermissions.ignoreReadonlyGantt226)&&(D.addNewChild(D.topId,7,"pin",b.getSVGIconHTML(lsdIcons.pin)+customLabels.Pin,!1),D.addNewChild(D.topId,8,"unpin","<span class='emptyFlag'>"+b.getSVGIconHTML(lsdIcons.unpin)+"</span>"+customLabels.Unpin,!1)),b.customActionsPromise.then(function(){b.getCustomActions("gantt").forEach(function(e,t){e.icon?D.addNewChild(D.topId,t+12,"custom_"+t,b.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1):D.addNewChild(D.topId,t+12,"custom_"+t,e.name.encodeHTML(),!1)})}),v.isActive()&&(b.hasCustomPermission("Bulk_Bundle")&&D.addNewChild(D.topId,41,"bundler",b.getSVGIconHTML(f.Bundle.icon)+f.Bundle.label,!1),b.hasCustomPermission("Bulk_Unbundle"))&&D.addNewChild(D.topId,42,"unbundler",b.getSVGIconHTML(f.Unbundle.icon)+f.Unbundle.label,!1),D.attachEvent("onShow",function(e){contextShown=!0}),D.attachEvent("onHide",function(e){contextShown=!1}),D.attachEvent("onClick",function(s,e,t){g.$evalAsync(function(){switch(s){case"flag":b.safeApply(g,function(){P(!0)});break;case"unflag":b.safeApply(g,function(){P(!1)});break;case"bundler":var e=(g.selectedGanttServices.getSelected()||[]).map(function(e){return scheduler._events[e]});f.Bundle.invoke(e,y.selectedPolicyId).then(function(e){M()},function(e){});break;case"unbundler":e=(g.selectedGanttServices.getSelected()||[]).map(function(e){return scheduler._events[e]});f.Unbundle.invoke(e,y.selectedPolicyId).then(function(e){M()},function(e){});break;case"reschedule":Z.schedule(g.selectedGanttServices.getSelected());break;case"pin":S.changePin(g.selectedGanttServices.getSelected(),!0).then(function(){return updateViewDebounced()});break;case"unpin":S.changePin(g.selectedGanttServices.getSelected(),!1).then(function(){return updateViewDebounced()});break;case"unschedule":ee(g.selectedGanttServices.getSelected());break;case"validate":S.checkRules(g.selectedGanttServices.getSelected()).then(S.drawViolationsOnGantt);break;default:if(0===s.indexOf("custom_")){var e=parseInt(s.split("_")[1]),t=g.selectedGanttServices.getSelected(),n=b.getCustomActions("gantt")[e];if(n.visualforce){var e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),i=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();m.open(n.name,n.visualforce+"?services="+t.join(",")+"&start="+e+"&end="+i);break}a.callRemoteAction(RemoteActions.runCustomServiceAction,n.className,g.selectedGanttServices.getSelected(),scheduler._min_date,scheduler._max_date).then(function(e){e&&b.addNotification(n.name,e,null,null)}).catch(function(e){return b.addNotification(n.name,e.message,null,null)})}else te(g.selectedGanttServices.getSelected(),x[s])}})}),scheduler.config.readonly=!0,g.ganttLocked=scheduler.config.readonly,g.lockGanttToggle=function(){(window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Gantt_Locker)&&(scheduler.config.readonly=!scheduler.config.readonly,g.ganttLocked=scheduler.config.readonly,n.SetUserSettingsProperty("Lock_Gantt__c",g.ganttLocked))},g.unSelecteAllSkills=function(){for(var e in g.selectedSkills)g.selectedSkills[e]=!1},g.selectAllSkills=function(){for(var e in g.selectedSkills)g.selectedSkills[e]=!0},g.getSkills=i.getSkills,scheduler.attachEvent("onYScaleClick",function(e,t,n){n.stopPropagation(),n.preventDefault(),window.__lastResourceClicked=t;for(var i=["resourceMenuBtn","resourceMenuIcon"],s=0;s<i.length;s++)if(n.target.classList&&n.target.classList.contains(i[s])||n.target.parentNode&&n.target.parentNode.classList.contains(i[s]))return void V.open(t.resourceId,t.key,n.target);t.children||U.open(t.resourceId,t.key)}),scheduler.attachEvent("onBeforeTooltip",function(e){return setTimeout(function(){var e=$(".dhtmlXTooltip");0!==e.length&&(e.position().top<0?e.css("height",e.height()+e.position().top-15+"px"):15<e.position().top&&e.css("height","initial"))},400),!0}),g.$on("keypress",function(e,t){if($("#MonthlyViewTooltip").remove(),!y.isLightboxOpened()&&!$("*:focus").is("textarea, input"))switch(t.which){case 13:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(S.recentlyUsed[scheduler._selected_id]=!0,o.open(scheduler._select_id));break;case 37:t.shiftKey?(X(-1),g.changeDatesByArrows()):$(".dhx_cal_prev_button").click();break;case 38:var n=$(".dhx_cal_data").scrollTop();$(".dhx_cal_data").scrollTop(n-30);break;case 39:t.shiftKey?(X(),g.changeDatesByArrows()):$(".dhx_cal_next_button").click();break;case 40:n=$(".dhx_cal_data").scrollTop(),$(".dhx_cal_data").scrollTop(n+30);break;case 87:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&scheduler.getEvent(scheduler._select_id).parentRecord&&(g.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._events[scheduler._select_id].parentRecord],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):b.openLightningPrimaryTab(scheduler._events[scheduler._select_id].parentRecord)}):window.open("../"+scheduler._events[scheduler._select_id].parentRecord));break;case 83:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&!scheduler.getEvent(scheduler._select_id).isDummy&&(g.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._select_id],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):b.openLightningPrimaryTab(scheduler._select_id)}):window.open("../"+scheduler._select_id));break;case 84:g.jumpToToday();break;case 70:1===g.selectedGanttServices.getSelected().length&&""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(S.flagged[scheduler._select_id]?S.flagged[scheduler._select_id]=!1:S.flagged[scheduler._select_id]=!0,scheduler.updateEvent(scheduler._select_id));break;case 48:case 96:g.changeTimeline(0);break;case 49:case 97:g.changeTimeline(1);break;case 50:case 98:g.changeTimeline(2);break;case 51:case 99:g.changeTimeline(3);break;case 55:g.changeTimeline(7);break;case 77:b.hasCustomPermission("MDT_View")&&!b.hasCustomPermission("Longterm_View")&&g.changeTimeline(35);break;case 85:b.hasCustomPermission("Monthly_Utilization")&&monthlyViewSettings.isMonthlyAvailable&&g.changeTimeline(30);break;case 103:g.changeTimeline(7)}}),g.changeTimeline=function(e){var t=scheduler._min_date,n=scheduler._max_date,i=void 0;switch(e){case 0:if((i="ZoomLevel2")===scheduler._mode)return;g.timelineName=customLabels.In_Day;break;case 1:if((i="ZoomLevel3")===scheduler._mode)return;g.timelineName=customLabels.Daily;break;case 2:if((i="ZoomLevel4")===scheduler._mode)return;g.timelineName=customLabels.X2_Days;break;case 3:if((i="ZoomLevel5")===scheduler._mode)return;g.timelineName=customLabels.X3_Days;break;case 7:if((i="ZoomLevel6")===scheduler._mode)return;g.timelineName=customLabels.Weekly;break;case 14:if((i="ZoomLevel7")===scheduler._mode)return;g.timelineName=customLabels.TwoWeeks;break;case 30:if((i="MonthlyView")===scheduler._mode)return;g.timelineName=customLabels.Utilization;break;case 35:if((i="MTDView")===scheduler._mode)return;g.timelineName=customLabels.MDTVIEW;break;case 180:if((i="LongView")===scheduler._mode)return;g.timelineName=customLabels.LongView}scheduler.setCurrentView(t,i),g.changeDatesByArrows(n)},setInterval(N,6e5),g.jumpToToday=function(){var e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),scheduler.setCurrentView(e),g.changeDatesByArrows()},s.$on("afterShowEvent",function(){setTimeout(function(){g.changeDatesByArrows(),N(),updateViewDebounced()},800)}),g.showOnMap=function(e){s.$broadcast("showServiceOnMap",e),b.safeApply(g)},scheduler.attachEvent("onBeforeEventChanged",function(e,t,n,i){var s=e.resourceId.split("_"),s=h.isTerritoryHasInDayOptimizationInProgress(e.start_date,e.end_date,s[1]);if(s){if(!1===confirm(customLabels.In_Day_Optimization_In_Progress_Confirm))return!1;"Rollback"===b.getSchedulingPolicyObject(s.policy)[fieldNames.SchedulingPolicy.Commit_Mode__c]&&h.updateProgressStatus(s.id,"Aborted")}var r,o,a;if(t.ctrlKey&&!e.isImmidietlyFollow&&S.handleSnap(e,t),e.resourceId===i.resourceId){if(s=e.start_date.getTime(),r=e.end_date.getTime(),o=i.start_date.getTime(),a=i.end_date.getTime(),Math.abs((s-o)/1e3/60)<minDragMinutes||Math.abs((r-a)/1e3/60)<minDragMinutes)return cachedDomElements.timesDragFix.hide(),!1}else if("na"===e.type)return!1;if(y.areContractorsSupported()&&"service"===e.type&&c.getResources()[e.getGanttResource()].isCapacityBased){for(var l in d.resourceCapacities()){l=d.resourceCapacities()[l];if(l.resource===c.getResources()[e.getGanttResource()].id&&(e.start.getTime()>=l.start_date.getTime()&&e.start.getTime()<=l.end_date.getTime()))return e.resourceBeforeDrag=i.resourceId,e.eventBeforeDrag=i,ne(e),!0}return cachedDomElements.timesDragFix.hide(),alert(customLabels.serviceCantBeAssignedWithoutCapacity),!1}return I=GanttService.copy(i),snapTo=t.ctrlKey,ne(e),e.resourceBeforeDrag=i.resourceId,e.eventBeforeDrag=i,!0}),g.updateMonthlyKpi=function(){"MonthlyView"===scheduler._mode&&updateViewDebounced(),Q()};var Q=_.debounce(function(){n.SetUserSettingsProperty("Utilization_Properties__c",JSON.stringify(g.capacityFields))},800);function ee(e){var t,n;confirm(customLabels.are_you_sure_unschedule)&&(t=[],n=[],e.forEach(function(e){n.push(d.serviceAppointments()[e]),t.push(d.serviceAppointments()[e].resource),S.recentlyUsed[e]=!0}),S.unscheduleServices(e,y.selectedPolicyId).then(function(e){M(),S.drawServicesAndAbsences(e.services,e.absences),p.calculateKpis()}).catch(function(e){b.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}))}function te(e,t){var n,i;t===w.CANCELED&&!confirm(customLabels.AreYouSureYouWantToCancel)||(n=[],i=[],e.forEach(function(e){i.push(d.serviceAppointments()[e]),n.push(d.serviceAppointments()[e].resource),S.recentlyUsed[e]=!0}),S.changeStatus(e,t).then(function(e){M(),S.drawServicesAndAbsences(e.services)}).catch(function(e){b.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}))}function ne(e){var t=(e.start_date.getMinutes()+e.travelTo/60)%60,n="na"===e.type?e.end-e.start:e.schedEndTime-e.schedStartTime,i=t%serviceJumpsOnGantt,t=serviceJumpsOnGantt-t%serviceJumpsOnGantt;0!=i&&(e.start_date=t<i?new Date(e.start_date.getTime()+60*t*1e3):new Date(e.start_date.getTime()-60*i*1e3),e.end_date=new Date(e.start_date.getTime()+n+1e3*e.travelFrom+1e3*e.travelTo),e.schedStartTime=e.start_date.getTime()+1e3*e.travelTo,e.schedEndTime=e.end_date.getTime()-1e3*e.travelFrom)}g.cancelCrewView=function(){s.crewViewActive=!1,g.crewViewActive=!1,d.isCrewViewActive=!1},s.$on("gotNewTimePhasedObjects",function(e,t){S.drawServicesAndAbsences(t.serviceAppointments,t.resourceAbsences,[],t.resourceCapacities)}),s.$on("timePhasedObjectsCheckRules",function(e,t){S.checkRules(t).then(S.drawViolationsOnGantt)}),scheduler.attachEvent("onEventChanged",function(e,t){"service"!==t.type&&"na"!==t.type||b.safeApply(g,function(){"na"===t.type?l.saveChangesToAbsence(I,t,y.selectedPolicyId).then(function(e){}).catch(function(e){console.warn("Couldn't update absence"),e[0].message?b.addNotification(customLabels.Action_Could_Not_Be_Performed,e[0].message):b.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")}):S.saveChangesToServiceAppointment(I,t).then(function(e){scheduler._select_id=t.id}).catch(function(e){console.warn("Couldn't update service. "+e[2]),b.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message.substr(e[0].message.indexOf(",")+1)||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")})})}),g.$on("JumpToDate",function(e,t){scheduler.setCurrentView(t),g.changeDatesByArrows()}),g.$on("GotSlots",function(e,t){var n=getMinAndMaxHoursToDisplay();(t.minDateOfCandidate.getHours()<n.min||t.minDateOfCandidate.getHours()>=n.max)&&confirm(customLabels.confirmChangeBusinessHours)&&(t.minDateOfCandidate.getHours()<n.min?g.businessHoursRange.start=t.minDateOfCandidate.getHours():g.businessHoursRange.end=24,F())}),g.changeUtilizaionDays=function(e){-1===e&&1===g.numberOfDaysInUtilizationView||1===e&&30===g.numberOfDaysInUtilizationView||(g.numberOfDaysInUtilizationView+=e,g.daysInUtilizationChanged())},g.daysInUtilizationChanged=function(){scheduler.matrix.MonthlyView.x_size=g.numberOfDaysInUtilizationView,n.SetUserSettingsProperty("DaysInUtilizationView__c",g.numberOfDaysInUtilizationView),"MonthlyView"===scheduler._mode&&(scheduler.updateView(),g.updateGanttDates())},g.getRowSizeClass=function(){return b.ganttSettings.resourceRowHeight+"-css"},g.filterVisibility={hours:!0,resources:!1,skills:!1,utilization:!1,palettes:!1},g.needToLoadSkills=!0,g.needToLoadPalettes=!0,g.werePalettesLoaded=T.werePalettesLoaded,g.changeGanttFilterTab=function(e){for(var t in"skills"===e&&g.needToLoadSkills&&i.getSkillsFromSfdc().then(function(){return g.needToLoadSkills=!1}),"palettes"===e&&g.needToLoadPalettes&&!T.werePalettesLoaded()&&T.getGanttPalettes(!0).then(function(){return g.needToLoadPalettes=!1}),g.filterVisibility)g.filterVisibility[t]=t===e},scheduler.attachEvent("onAfterEventDisplay",function(e){setTimeout(function(){e.showEventPopupEffect=!1,p.calculateKpis(),s.$broadcast("afterShowEvent")},2500)}),g.updateWorkingReosourcesFilter=_.debounce(function(){g.resourceFilterHelper.showWorkingResource=g.resourceFilters.showWorkingResource},300),s.$on("flagService",function(e,t){S.flagged[t]?S.flagged[t]=!S.flagged[t]:S.flagged[t]=!0,scheduler.updateEvent(t)})}]),!function(){function e(){function e(n,s,r,e,o,a,l,t,i,c,d,u,p,m,h){n.bulkActionsOrder=bulkActionsOrder,n.customActions=[],n.isOptimizationLoaded=h.isOptimizationLoaded,n.isShowingOutputJson=h.isShowingOutputJson,n.actionNames={"Select Optimization Request":{name:"Select Optimization Request",nameLabel:"Select OR",icon:lsdIcons.calendar},"Show Optimization Results":{name:"Show Optimization Results",nameLabel:"Show Results",icon:lsdIcons.calendar},"Show Gantt Before Optimization":{name:"Show Gantt Before Optimization",nameLabel:"Show Before",icon:lsdIcons.calendar},Schedule:{name:"Schedule",nameLabel:customLabels.Schedule,icon:lsdIcons.calendar},Dispatch:{name:"Dispatch",nameLabel:customLabels.Dispatch,icon:lsdIcons.dispatch},Optimize:{name:"Optimize",nameLabel:customLabels.Optimize,icon:lsdIcons.magicwand},"Flag-Unflag":{name:"Flag-Unflag",nameLabel:customLabels.Flag_Unflag,icon:lsdIcons.flag},Unschedule:{name:"Unschedule",nameLabel:customLabels.Unschedule,icon:lsdIcons.na},"Check Rules":{name:"Check Rules",nameLabel:customLabels.check_rules_action_label,icon:lsdIcons.violation,isAvailable:function(){return window.customPermissions.Enable_Bulk_Check_Rules}},Bundle:{name:"Bundle",nameLabel:p.Bundle.label,icon:p.Bundle.icon,isAvailable:function(){return m.isActive()}},Unbundle:{name:"Unbundle",nameLabel:p.Unbundle.label,icon:p.Unbundle.icon,isAvailable:function(){return m.isActive()}}},r.customActionsPromise.then(function(){var e,t=r.getCustomActions("bulk");(e=n.customActions).push.apply(e,_toConsumableArray(t))}),n.runCustomServiceAction=function(n){var e,t,i=a.getSelected();n.visualforce?(e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),t=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===i.length?d.open(n.name,n.visualforce+"?id="+i[0]+"&start="+e+"&end="+t):d.open(n.name,n.visualforce+"?services="+i.join(",")+"&start="+e+"&end="+t)):0!==i.length&&c.callRemoteAction(RemoteActions.runCustomServiceAction,n.className,i,scheduler._min_date,scheduler._max_date).then(function(t){c.callRemoteAction(RemoteActions.getServicesById,i).then(function(e){e=u.updateTimePhaseData(e,"service").services;s.drawServicesAndAbsences(e,[],[],[]),t&&r.addNotification(n.name,t,null,null)})}).catch(function(e){return r.addNotification(n.name,e.message,null,null)})},n.isActionAvailable=function(e){return!n.actionNames[e]||!n.actionNames[e].isAvailable||n.actionNames[e].isAvailable()},n.checkHasCustomPermission=function(e){return null==r.hasCustomPermission("Bulk_"+e)||r.hasCustomPermission("Bulk_"+e)},n.openBulkAction=function(e){switch(e){case"Select Optimization Request":h.open();break;case"Show Optimization Results":h.loadOptimizationResponseOutput();break;case"Show Gantt Before Optimization":h.loadOptimizationRequestInput(h.i_OptimizationRequestName());break;case"Unschedule":o.open();break;case"Optimize":l.open();break;case"Flag-Unflag":for(var t=a.getSelected(),n=0;n<t.length;n++)s.flagged[t[n]]=!s.flagged[t[n]];updateViewDebounced();break;case"Check Rules":var i=a.getSelected();0<i.length&&s.checkRules(i).then(s.drawViolationsOnGantt);break;case"Bundle":i=a.getSelected().map(function(e){return u.serviceAppointments()[e]});p.Bundle.invoke(i).then(function(){}).catch(function(e){});break;case"Unbundle":i=a.getSelected().map(function(e){return u.serviceAppointments()[e]});p.Unbundle.invoke(i).then(function(){}).catch(function(e){})}}}e.$inject=["$scope","servicesService","utils","bulkDispatchService","bulkUnscheduleService","ServiceSelectorService","optimizeLightboxService","bulkScheduleService","rdOptimizeLightboxService","sfdcService","GeneralLightbox","TimePhasedDataService","BundleActions","BundleService","LoadOptiViewerDataService"];return{restrict:"E",template:'<div id="quickActionsButtons">\n\t\t\t                    <div fsl-key-press tabindex="0" id="actionQuickFirst" \n                                    class="truncate quickActionBtn" \n                                    ng-click="openBulkAction(actionNames[\'Select Optimization Request\'].name)" \n                                    title="{{actionNames[\'Select Optimization Request\'].nameLabel}}">\n                                        {{actionNames[\'Select Optimization Request\'].nameLabel}}\n\t\t\t\t\t\t\t\t</div>\n                                <div fsl-key-press tabindex="0" id="actionQuickSecond" \n                                    class="truncate quickActionBtn"\n                                    ng-show="isOptimizationLoaded() && !isShowingOutputJson()" \n                                    ng-click="openBulkAction(actionNames[\'Show Optimization Results\'].name)" \n                                    title="{{actionNames[\'Show Optimization Results\'].nameLabel}}">\n                                        {{actionNames[\'Show Optimization Results\'].nameLabel}}\n\t\t\t\t\t\t\t\t</div>\n                                <div fsl-key-press tabindex="0" id="actionQuickSecond" \n                                    class="truncate quickActionBtn"\n                                    ng-show="isOptimizationLoaded() && isShowingOutputJson()"  \n                                    ng-click="openBulkAction(actionNames[\'Show Gantt Before Optimization\'].name)" \n                                    title="{{actionNames[\'Show Gantt Before Optimization\'].nameLabel}}">\n                                        {{actionNames[\'Show Gantt Before Optimization\'].nameLabel}}\n\t\t\t\t\t\t\t\t</div>\n\t                    </div>',scope:{},controller:e}}angular.module("serviceExpert").directive("bulkActionsButtonOptiViewer",e),e.$inject=[]}(),angular.module("serviceExpert").directive("dhxSchedulerOptiViewer",["$rootScope","$timeout","userSettingsManager","$q","sfdcService","ResourcesAndTerritoriesService","FieldSetFieldsService","TimePhasedDataService",function(c,d,u,p,e,m,h,g){return{restrict:"C",transclude:!0,template:'<div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div>',link:function(e,t,n){window.utils=angular.element("#serviceExpertApp").injector().get("utils");var i=_.debounce(function(e){scheduler.updateCollection("resources",e)},500),n=(e.$watch(n.resources,function(e){folderJustToggled?folderJustToggled=!1:i(e)},!0),t.addClass("dhx_cal_container"),schedulerConfig.configTimelines(),schedulerConfig.setConfigurations(),u.GetUserSettingsProperty("Gantt_View_Start_Hour__c")),s=u.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),r=u.GetUserSettingsProperty("Resource_Row_Height__c"),o=u.GetUserSettingsProperty("View_Capacity_Type__c"),a=u.GetUserSettingsProperty("Include_Weekends__c"),l=u.GetUserSettingsProperty("Load_On_Today__c");u.GetUserSettingsProperty("Absence_Overlap_Height__c");null!==r&&schedulerConfig.setRowHeights(r,!1),null!==o&&setCapacityFilter(o),null!==n&&null!==s&&setHoursToDisplay(n,s,a),c.policy=defaultPolicy,p.all([m.promises.territories(),m.promises.resources(),h.fieldsSetFields()]).then(function(){scheduler.init(t[0],new Date,"ZoomLevel3"),e.scheduler=scheduler,e.datalessMethods=attchDatalessSchedulerEvents(),d(function(){l&&scheduler.setCurrentView(new Date),$("#FirstTimeLoading").remove(),g.promises.initialStmsPhasedData.then(function(){$("#FirstTimeLoading").remove()}),e.getTimePhasedObjects().then(function(){}).catch(function(e){bootstrap.handleError(e)}),c.$broadcast("initCompleted")},20)}).catch(function(e){console.log("err:"+e)})}}}]);var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,i=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(i.push(o.value),!n||i.length!==n);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")};function GanttServiceOptiViewer(e,t){if(!t){for(var n in this.sfdcType="service",this.fields={},e.Fields)this.fields[n]=e.Fields[n];if(_.isEmpty(serviceStatusCategories))serviceStatuses;if(_.isEmpty(optiViewerStatusCategories))for(var i in serviceStatuses){var s=i;switch(i){case"COULD_NOT_COMPLETE":s="CannotComplete";break;case"IN_PROGRESS":s="InProgress";break;case"SCHEDULED":s="Scheduled";break;case"NONE":s="None";break;case"DISPATCHED":s="Dispatched";break;case"COMPLETED":s="Completed";break;case"CANCELED":s="Canceled"}optiViewerStatusCategories[serviceStatuses[i]]=s}this.id=e.Id||null,this.name=e.AppointmentNumber||e.Id||null,this.AssignedResourceLastModifiedDate=e.AssignedResourceLastModifiedDate||null,this.ServiceAppointmentLastModifiedDate=e.ServiceAppointmentLastModifiedDate||null,this.accountName=e["Account.Name"]||null,this.accountId=e.AccountId||null,this.latitude=e.Latitude||null,this.longitude=e.Longitude||null,this.arrivalWindowEndTime=e.ArrivalWindowEndTime||null,this.arrivalWindowStartTime=e.ArrivalWindowStartTime||null,this.dueDate=e.DueDate||null,this.ganttDisplay=e.Gantt_Display_Date__c||null,this.durationType=e.DurationType||null,this.earliestStartTime=e.EarliestStartTime||null,this.estDuration=e.Duration||null,this.travelTimeFrom=e.ServiceResources?e.ServiceResources.records[0].EstimatedTravelTimeFrom__c||e.ServiceResources.records[0].FSL__EstimatedTravelTimeFrom__c:null,this.travelTimeTo=e.ServiceResources?e.ServiceResources.records[0].EstimatedTravelTime:null,this.ganttLabel=e.GanttLabel__c||null,this.jeopardy=e.InJeopardy__c||null,this.jeopardyReason=e.jeopardyReasonTranslated||e.InJeopardyReason__c||null,this.parentRecord=e.ParentRecordId||null,this.parentRecordStatus=e.ParentRecordStatusCategory||null,this.parentRecordType=e.ParentRecordType||null,this.pinned=e.Pinned__c||!1,this.isBundleMember=e.IsBundleMember||!1,this.isBundle=e.IsBundle||!1,this.RelatedBundle=e.RelatedBundleId||!1,this.schedEndTime=e.SchedEndTime||null,this.schedStartTime=e.SchedStartTime||null,this.serviceTerritory=e.ServiceTerritory||null,this.serviceTerritoryName=e["ServiceTerritory.Name"]||null,this.status=e.Status||null,this.statusCategory=e.StatusCategory||window.optiViewerStatusCategories[e.Status]||null,this.subject=e.Subject||null,this.ganttColor=e.GanttColor__c||null,this.resource=e.ServiceResources?e.ServiceResources.records[0].ServiceResourceId:null,this.resourceName=e.ServiceResources?e.ServiceResources.records[0].ServiceResourceId:null,this.resourceContractor=e.ResourceContractor||null,this.isAssignToCrew=e.IsAssignToCrew||null,this.assignedResource=e.ServiceResources?e.ServiceResources.records[0].Id:null,this.violations=null,this.relatedTo=e.relatedTo||null,this.relatedFather=null,this.priority=this.minPriority,this.relatedFather=e.relatedFather,this.policyUsed=e.Scheduling_Policy_Used__c||null,this.scheduleMode=e.Schedule_Mode__c||null,this.emergency=e.Emergency__c||!1,this.isServiceInChain=(usingNewMstModel||e.IsInO2Territory)&&e.isServiceInChain,this.relatedService2=e.relatedService2||null,this.relatedService1=e.relatedService1||null,this.relationshipType=e.relationshipType||null,this.isImmidietlyFollow="Immediately Follow"===e.relationshipType,this.ganttPaletteColor=null,this.Use_Async_Logic=e.Use_Async_Logic__c||!1,this.icons=e.GanttIcon__c?e.GanttIcon__c.split(";"):null,this.totalModifiedTimes=this.ServiceAppointmentLastModifiedDate,this.fromGetCandidateFlow=!1,this.AssignedResourceLastModifiedDate&&(this.totalModifiedTimes+=this.AssignedResourceLastModifiedDate),this.icons&&(this.icons=this.icons.map(function(e){return window.encodeURI(e)}));var r,t="WorkOrder"==e.ParentRecordType?CustomSettings.woPriorityField:CustomSettings.woliPriorityField,t=(t&&e.ParentFields&&e.ParentFields[t]&&(this.priority=e.ParentFields[t]),fslNamespace?mdtBooleanField.replace(fslNamespace+"__",""):mdtBooleanField);for(r in this.isMDT=!!e[t],e.MDT_Operational_Time__c?this.calculateMdtTimes(e.MDT_Operational_Time__c):this.isMDT&&(this.mdtTimes={travel:[],working:[]}),this.parentFields={},e.ParentFields)this.parentFields[r]=e.ParentFields[r];this.setSchedulerProperties(),addFieldSetToServiceObject(GanttServiceOptiViewer.prototype.allFieldSetsSet,e,this),this.isMDT&&(this.travelTimeFrom=0,this.travelTimeTo=0)}}function getGanttResourceWithSecondaryStms(e){if(showSecondarySTMs){var t=e.resourceId.split(",");if(e.resourceBeforeDrag&&e.resourceBeforeDrag!=e.resourceId&&1<t.length)for(var n=0;n<t.length;n++)if(e.resourceBeforeDrag.split(",")[n]!=t[n]){e.resourceId=t[n];break}}}function addFieldSetToServiceObject(e,t,n){for(var i in e){var s=null;if((s=t[e[i].APIName])||0==s){switch(e[i].Type){case"DATE":case"DATETIME":s=__setTimeZoneOffsetToDateField(s),n[e[i].APIName]=s.getTime();break;case"REFERENCE":var r=e[i].JsAPIName.replace("__r","__c");n[r]=t[r]}n[e[i].APIName]=s}}}function ResourcesAndTerritoriesOptiViewer(e,t,n){function i(e,t){return e+60*(useLocationTimezone?-moment.tz.zone(t).utcOffset(utils.convertDtToMomentDt(new Date(e),t).valueOf()):utils.getUserOffset(new Date(e)))*1e3}this.id=t.Id,this.name=t.Id,this.effectiveEndDate=t.EffectiveEndDate?new Date(t.EffectiveEndDate).getTime():null,this.effectiveStartDate=t.EffectiveStartDate?new Date(t.EffectiveStartDate).getTime():null,this.latitude=t.Latitude||null,this.longitude=t.Longitude||null,this.serviceResource=e.Id,this.serviceResource__r={Id:e.Id,Name:e.Id,RelatedRecordId:e.RelatedRecordId,ResourceType:e.ResourceType},this.serviceTerritory=t.ServiceTerritoryId,this.serviceTerritory__r={Id:t.ServiceTerritoryId,OperatingHoursId:t.ServiceTerritory.OperatingHoursId,OperatingHours:{Id:t.ServiceTerritory.OperatingHoursId,TimeZone:n[t.ServiceTerritoryId]?n[t.ServiceTerritoryId].OperatingHours.TimeZone:null}},this.serviceTerritoryType=t.TerritoryType,this.operatingHours=t.OperatingHoursId||null,this.operatingHours__r=t.OperatingHoursId?{Id:t.OperatingHoursId,TimeZone:t.OperatingHours.TimeZone}:null,this.timezone=n[t.ServiceTerritoryId]?n[t.ServiceTerritoryId].OperatingHours.TimeZone:null,this.operatingHours__r&&this.operatingHours__r.TimeZone!==this.timezone&&console.warn("The Resource with STM - "+this.id+" has operating hours with different timezone!"),this.effectiveStartDate=this.effectiveStartDate?i(this.effectiveStartDate,this.timezone):null,this.effectiveEndDate=this.effectiveEndDate?i(this.effectiveEndDate,this.timezone):null,this.effectiveStartDate=__setTimeZoneOffsetToDateField(this.effectiveStartDate,!1,!0),this.effectiveEndDate=__setTimeZoneOffsetToDateField(this.effectiveEndDate,!1),this.IsCapacityBased=e.IsCapacityBased}function ServiceResourceOptiViewer(e){var t=this;this.id=e.Id,this.online=!1,this.isUndestaffOrOverStaff=!1,this.name=e.Id,this.isCapacityBased=e[fieldNames.ServiceResource.IsCapacityBased],this.description=e[fieldNames.ServiceResource.Description]||"",this.isOptimizationCapable=e[fieldNames.ServiceResource.IsOptimizationCapable],this.relatedRecord=e[fieldNames.ServiceResource.RelatedRecord],this.relatedRecord__r=e[fieldNames.ServiceResource.RelatedRecord__r],this.resourceType=e[fieldNames.ServiceResource.ResourceType],this.ganttLabel=e[fieldNames.ServiceResource.GanttLabel__c],this.lastKnownLongitude=e[fieldNames.ServiceResource.LastKnownLongitude],this.lastKnownLocationDate=e[fieldNames.ServiceResource.LastKnownLocationDate],this.lastKnownLatitude=e[fieldNames.ServiceResource.LastKnownLatitude],this.serviceCrew=e[fieldNames.ServiceResource.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceResource.ServiceCrew__r],this.relatedRecord__r&&(this.pictureLink=this.relatedRecord__r.SmallPhotoUrl),this.onlineOffset=e[fieldNames.ServiceResource.Online_Offset__c]||orgOnlineOffset,this.pictureLink&&this.pictureLink.endsWith("profilephoto/005/T")&&(this.pictureLink=null),e[fieldNames.ServiceResource.PictureLink]&&(this.pictureLink=e[fieldNames.ServiceResource.PictureLink]),this.skills={},(this.sobject=e)[fieldNames.ServiceResource.Skills]&&e[fieldNames.ServiceResource.Skills].records.forEach(function(e){t.skills[e[fieldNames.ServiceResourceSkill.Skill]]?(Array.isArray(t.skills[e[fieldNames.ServiceResourceSkill.Skill]])||(t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=[t.skills[e[fieldNames.ServiceResourceSkill.Skill]]]),t.skills[e[fieldNames.ServiceResourceSkill.Skill]].push(new ServiceResourceSkill(e))):t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=new ServiceResourceSkill(e)})}function ServiceTerritoryOptiViewer(e){this.id=e.Id,this.name=e.Id,this.latitude=e[fieldNames.ServiceTerritory.Latitude],this.longitude=e[fieldNames.ServiceTerritory.Longitude],this.operatingHours=e[fieldNames.ServiceTerritory.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritory.OperatingHours__r],this.description=e[fieldNames.ServiceTerritory.Description],this.parentTerritory=e[fieldNames.ServiceTerritory.ParentTerritory__r]?e[fieldNames.ServiceTerritory.ParentTerritory]:void 0,this.isActive=e[fieldNames.ServiceTerritory.IsActive],e[fieldNames.ServiceTerritory.ParentTerritory__r]&&(this.parentTerritory=new ServiceTerritoryOptiViewer(e[fieldNames.ServiceTerritory.ParentTerritory__r]))}!function(){function e(n,o,r,e,i,a,N,s,l,c,d,u,p,m,h){var g=null,v={},f={},S={},_={},b={},y={},w=void 0,T=void 0,t=!1,L=!1,A="fetchData.json",I={resourcesAndTerritories:v,resourcesByPrimariesAndRelocations:{},resourceOperatingHours:{},serviceAppointments:{},resourceAbsences:{},resourceCapacities:{},resourcesAndShifts:f,serviceCrewMembers:b,operatingHoursAndHolidays:{},start:{},finish:{},resourceToServiceCrewMembers:S,crewToServiceCrewMembers:_,currentCrewToShow:y},G=i.isRtlDirection();function C(){i.setLightBoxStatus(!1),g.$destroy()}function k(t,e){var n=void 0;switch(e){case"ServiceAppointment":n=["ArrivalWindowStartTime","ArrivalWindowEndTime","EarliestStartTime","DueDate","SchedStartTime","SchedEndTime","Gantt_Display_Date__c"];break;case"ResourceAbsence":n=["Start","End"];break;case"Shift":n=["StartTime","EndTime"];break;case"ServiceResourceCapacity":n=["EndDate","StartDate"];break;case"ServiceCrewMember":n=["StartDate","EndDate"];break;default:return}n.forEach(function(e){t[e]&&(t[e]=(e=t[e])?new Date(e).getTime():null)})}function D(e,t,n,i){return e&&t&&i?(e=R(e,t,i))?e.serviceTerritory__r.OperatingHours.TimeZone:null:n}function R(e,t,n){var i=void 0,s=!0,r=!1,o=void 0;try{for(var a,l=Object.entries(n)[Symbol.iterator]();!(s=(a=l.next()).done);s=!0){var c=_slicedToArray(a.value,2),d=(c[0],c[1]);isIntersect(F(e,d.timezone),F(t,d.timezone),d.effectiveStartDate,d.effectiveEndDate)&&(i=d)}}catch(e){r=!0,o=e}finally{try{!s&&l.return&&l.return()}finally{if(r)throw o}}return i}function F(e,t){return!e||useLocationTimezone&&!t?e:e+60*(useLocationTimezone?-moment.tz.zone(t).utcOffset(l.convertDtToMomentDt(new Date(e),t).valueOf()):l.getUserOffset(new Date(e)))*1e3}function O(t,e,n){var i=void 0;switch(e){case"ServiceAppointment":i=["ArrivalWindowStartTime","ArrivalWindowEndTime","EarliestStartTime","DueDate","SchedStartTime","SchedEndTime","Gantt_Display_Date__c"];break;case"ResourceAbsence":i=["Start","End"];break;case"Shift":i=["StartTime","EndTime"];break;case"ServiceResourceCapacity":i=["EndDate","StartDate"];break;default:return}i.forEach(function(e){t[e]&&(t[e]=F(t[e],n))})}function M(e){var t=v[e.ResourceId],e=R(e.Start,e.End,t);return e?e.serviceTerritory__r.OperatingHours.TimeZone:null}function E(e,t){k(e,"ResourceAbsence"),e.RecordType=t?{DeveloperName:"Break"}:{DeveloperName:"Non_Availability"},O(e,"ResourceAbsence",M(e)),I.resourceAbsences[e.Id]=new ResourceAbsence(e)}function x(i){s.callRemoteAction(RemoteActions.LoadInputDataToOptimizationViewer,i).then(async function(e){if(I={resourcesAndTerritories:v,resourcesByPrimariesAndRelocations:{},resourceOperatingHours:{},serviceAppointments:{},resourceAbsences:{},resourceCapacities:{},resourcesAndShifts:f,serviceCrewMembers:b,operatingHoursAndHolidays:{},start:{},finish:{},resourceToServiceCrewMembers:S,crewToServiceCrewMembers:_,currentCrewToShow:y},g.Errors=[],w=i,T=e&&e.id,e&&e.Territories)P(e);else{var t,n;if(null!=e["transaction-id"])return"Yes"==e.hasAttachments?(g.showO2FetchFilesButton=!1,n=window.location.origin+"/services/data/v56.0/query?q=SELECT+body+from+attachment+where+parentId='"+T+"'+AND+name='"+A+"'",t={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+sessionId}},n=await h.get(n,t),void P((await h.get(""+window.location.origin+n.data.records[0].Body,t)).data,e)):void(g.showO2FetchFilesButton=!0);g.showO2FetchFilesButton||g.Errors.push("no data!")}}).then(function(){0<g.Errors.length||o.$broadcast("gotNewTimePhasedSTMsAndShifts",I)}).then(function(){0<g.Errors.length||o.$broadcast("gotNewTimePhasedObjects",I)}).then(function(){var e;0<g.Errors.length||(e=I.start,e=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0),scheduler.setCurrentView(e),L=!(t=!0))}).then(function(){0==g.Errors.length&&C()})}function P(e,t){var n=c.get("monthlyViewHelperService"),i={},s=(e.Territories.forEach(function(e){i[e.Id]=e}),e.Resources&&e.Resources.forEach(function(n){v[n.Id]=v[n.Id]||{},n.ServiceTerritories.records.forEach(function(e){var t=new ResourcesAndTerritoriesOptiViewer(n,e,i);"S"!==(v[n.Id][e.Id]=t).serviceTerritoryType&&(I.resourcesByPrimariesAndRelocations[n.Id]=I.resourcesByPrimariesAndRelocations[n.Id]||{},I.resourcesByPrimariesAndRelocations[n.Id][e.Id]=t)}),n.ShiftServiceResources&&n.ShiftServiceResources.records.forEach(function(e){k(e,"Shift");O(e,"Shift",i[e.ServiceTerritoryId]||D(e.StartTime,e.EndTime,null,v[e.ServiceResourceId]));var t=new Shift(e);f[e.ServiceResourceId]||(f[e.ServiceResourceId]={}),f[e.ServiceResourceId][l.formatDayToString(t.startTime)]||(f[e.ServiceResourceId][l.formatDayToString(t.startTime)]=[]),f[e.ServiceResourceId][l.formatDayToString(t.startTime)].push(t)}),n.ServiceCrewMembers&&n.ServiceCrewMembers.records.forEach(function(e){if(k(e,"ServiceCrewMember"),b[e.Id]=new ServiceCrewMember(e),S[b[e.Id].serviceResource]||(S[b[e.Id].serviceResource]={}),_[b[e.Id].serviceCrew]||(_[b[e.Id].serviceCrew]={}),_[b[e.Id].serviceCrew][e.Id]=b[e.Id],S[b[e.Id].serviceResource][e.Id]=b[e.Id],o.crewViewActive){var t,n;for(n in y=o.currentCrewToShow)if(y[n].serviceCrew){t=y[n].serviceCrew;break}e.ServiceCrewId===t&&(y[e.ServiceResourceId]||(y[e.ServiceResourceId]=r.getResources()[e.ServiceResourceId]),void 0===y[e.ServiceResourceId].members&&(y[e.ServiceResourceId].members={}),y[e.ServiceResourceId].members[e.Id]=b[e.Id])}})}),e.Services&&e.Services.forEach(function(e){var t,n,i;k(e=e,"ServiceAppointment"),e.AppointmentNumber=e.Id,(i=!!e.ServiceResources&&e.ServiceResources.records)?(t=v[i[0].ServiceResourceId],n=!1,1<i.length&&i.forEach(function(e){"C"===e.ServiceResource.ResourceType&&(n=!0,t=v[e.ServiceResourceId])}),e.IsAssignToCrew=n,e.ResourceContractor=t&&t[Object.keys(t)[0]].IsCapacityBased,O(e,"ServiceAppointment",D(e.SchedStartTime,e.SchedEndTime,e.ServiceTerritory?e.ServiceTerritory.OperatingHours.TimeZone:null,t))):O(e,"ServiceAppointment",e.ServiceTerritory?e.ServiceTerritory.OperatingHours.TimeZone:null),I.serviceAppointments[e.Id]=new GanttServiceOptiViewer(e)}),e.Breaks&&e.Breaks.forEach(function(e){E(e,!0)}),e.NonAvailabilities&&e.NonAvailabilities.forEach(function(e){E(e,!1)}),e.Capacities&&e.Capacities.forEach(function(e){k(e,"ServiceResourceCapacity"),I.resourceCapacities[e.Id]=new ResourceCapacity(e)}),new Date(e.start||t.start)),t=new Date(e.finish||t.finish);I.start=new Date(s.getFullYear(),s.getMonth(),s.getDate()-1,0,0),I.finish=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1,23,59),a.updateObjectsForOptimizationViewer(I),r.getResourceAndTerritoriesFromJson(e,function(){n.reset(),r.reset(),scheduler._events={},scheduler.deleteMarkedTimespan(),d.reset(),u.reset(),p.reset(),m.reset()})}return{open:function(){(g=o.$new(!0)).$on("keypress",function(e,t){27==t.which&&g.$evalAsync(g.closeLightbox)}),g.loadOptimizationRequestInput=x,g.selectedOptimizationRequest="",g.currentResults=[];var e=angular.element('\n            <div class="LightboxBlackContainer">\n                <div class="LightboxContainer" id="BulkActionsLightbox" ng-class="{\'rtlDirection\': '+G+' }" >\n\n                    <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" id="CloseDispatchLightbox" fsl-key-press tabindex="0">\n                            <use xlink:href="'+lsdIcons.close+'"></use>\n                        </svg>\n                        <h1 class="light-box-header">Load New Optimization Request</h1>\n                    </div>\n\n                    <div>\n\n                        <div class="lightboxContentContainer">\n\n                            <p>Select Optimization Request to load</p>\n\n                            \n                            <div>\n                                \x3c!-- <label for="searchOptReqs">Search for Optimization Request to view </label> --\x3e\n                                <input class="OptiViewerSearch" type="text" placeholder="Search Optimiztion Request..." \n                                    ng-model="selectedOptimizationRequest"\n                                    ng-model-options="{debounce: 300}"\n                                    ng-change="ShowAllRelevantOptimizationRequests(selectedOptimizationRequest)"\n                                    name="searchOptReqs" \n                                    id="searchOptReqs" \n                                    ng-focus = "SearchBoxInFocus = true"\n                                    ng-blur = "loseFocusWithDelay()"/> \n                            </div>\n                            <div>\n                                <div class="OptiViewerListDiv" style="box-shadow: 0 2px 3px 0 rgb(0 0 0 / 16%);" ng-if="currentResults.length != 0 && SearchBoxInFocus">\n                                    <ul class="list-unstyled-optiViewer" role="presentation">\n                                        <li role="presentation" class="optiviewer-listbox__item" ng-repeat="optimization in currentResults" ng-click="updateSearchText(optimization.Name)">\n                                            <div onmouseover="this.style.backgroundColor = \'#f3f3f3\'" onmouseout="this.style.backgroundColor = \'#ffffff\'">\n                                                \n                                                    <svg class="slds-icon-optiViewer">\n                                                        <use class="slds-icon-use-optiViewer" xlink:href="'+lsdIcons.optimizationRequests+'"></use>\n                                                    </svg>\n                                            \n                                                <span>\n                                                        {{optimization.Name}}\n                                                        </br> \n                                                        {{optimization.Status__c || optimization.FSL__Status__c}} • {{optimization.Type__c || optimization.FSL__Type__c}}\n                                                </span>\n                                            </div>\n                                        </li>\n                                    </ul>\n                                </div>\n                                <div ng-if="Errors.length > 0 && (currentResults.length == 0 || !SearchBoxInFocus)">\n                                    <p class="optiViewerErrorMessage">This LS Optimization Request has no saved data. </br>\n                                        In order to save optimization data please login to the org via License Management App and open the Custom Settings --\x3e Field Service Optimization Settings (Manage button) --\x3e Edit button next to the relevant Optimization type --\x3e tick the checkbox "Save Optimization Data After OAAS Finish".</br>\n                                        Now when your optimization finishes, its data would be saved as an attachment on the related Optimization Data Object. </br>\n                                        <b>If this is a customer\'s org remember to turn this setting back off when you done working.</b> \n\n                                    </p>\n                                </div>\n                                <div ng-if="showO2FetchFilesButton && (currentResults.length == 0 || !SearchBoxInFocus)">\n                                    <p class="optiViewerErrorMessage">This ES&O Optimization Request has no saved data. \n                                    </br>\n                                    Before you click the \'Fetch Files From S3\' you need to enable the custom settings as mentioned <a href="https://salesforce.quip.com/i0GlAyC5MLjb">here</a>\n                                     </br>\n                                    <button class="truncate quickActionBtn" ng-click="GetO2FilesFromAWS(false)">Fetch ALL Files From S3</button>\n                                    <button class="truncate quickActionBtn" ng-click="GetO2FilesFromAWS(true)">Fetch Request & Response Files From S3</button>\n                                    </p>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <button class="lightboxSaveButton" ng-click="loadOptimizationRequestInput(selectedOptimizationRequest)">Load</button>\n                        </div>\n\n                    </div>\n                </div>\n\n            </div>\n            '),t=(e.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(e),g.closeLightbox=C,g.$on("$destroy",function(){return e.remove()}),n(e)(g),e.show(),i.setLightBoxStatus(),g.ShowAllRelevantOptimizationRequests=function(e){s.callRemoteAction(RemoteActions.ShowAllRelevantOptimizationRequests,e).then(function(e){e&&(g.currentResults=e,g.Errors=[])})},g.ShowAllRelevantOptimizationRequests("last 20"),g.updateSearchText=function(e){g.selectedOptimizationRequest=e,g.currentResults=[]},c.get("$timeout"));g.loseFocusWithDelay=function(){t(function(){g.SearchBoxInFocus=!1},200)},g.SearchBoxInFocus=!1,g.Errors=[],g.GetO2FilesFromAWS=function(e){s.callRemoteAction(RemoteActions.O2FetchFiles,T,e).then(function(e){console.log("O2FetchFiles results:"),console.log(e)})}},isOptimizationLoaded:function(){return t},isShowingOutputJson:function(){return L},loadOptimizationResponseOutput:function(){s.callRemoteAction(RemoteActions.LoadOutputDataToOptimizationViewer,w).then(async function(e){if(!e||0==e.length){var t,n=window.location.origin+"/services/data/v56.0/query?q=SELECT+body+from+attachment+where+parentId='"+T+"'+AND+name='sfsResponse.json'",i={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+sessionId}},n=await h.get(n,i),s=await h.get(""+window.location.origin+n.data.records[0].Body,i);for(t in e=[],s.data)switch(t){case"serviceAppointments":s.data.Services=s.data[t],delete s.data[t];break;case"assignedResourcesToDelete":s.data.AssignedResourcesToDelete=s.data[t],delete s.data[t];break;case"lunchBreaksToDelete":s.data.BreaksToDelete=s.data[t],delete s.data[t]}e.push(s.data)}var r=1,n=(e.forEach(function(e){e.Services&&e.Services.forEach(function(e){k(e,"ServiceAppointment");var t=I.serviceAppointments[e.Id].ServiceTerritory?I.serviceAppointments[e.Id].ServiceTerritory.OperatingHours.TimeZone:null;I.serviceAppointments[e.Id].schedEndTime=F(e.SchedEndTime,t),I.serviceAppointments[e.Id].schedStartTime=F(e.SchedStartTime,t),I.serviceAppointments[e.Id].setSchedulerPropertiesAfterOutputJson("service")}),e.AssignedResourcesToCreate&&e.AssignedResourcesToCreate.forEach(function(e){I.serviceAppointments[e.ServiceAppointmentId].resource=e.ServiceResourceId,I.serviceAppointments[e.ServiceAppointmentId].resourceName=e.ServiceResourceId,I.serviceAppointments[e.ServiceAppointmentId].assignedResource="Created By Optimizer",I.serviceAppointments[e.ServiceAppointmentId].travelTimeFrom=e.EstimatedTravelTimeFrom__c||e.FSL__EstimatedTravelTimeFrom__c,I.serviceAppointments[e.ServiceAppointmentId].travelTimeTo=e.EstimatedTravelTime,I.serviceAppointments[e.ServiceAppointmentId].status=serviceStatuses.SCHEDULED,I.serviceAppointments[e.ServiceAppointmentId].statusCategory="Scheduled",I.serviceAppointments[e.ServiceAppointmentId].setSchedulerPropertiesAfterOutputJson("assignedResource")}),e.AssignedResourcesToUpdate&&e.AssignedResourcesToUpdate.forEach(function(e){I.serviceAppointments[e.ServiceAppointmentId].resource=e.ServiceResourceId,I.serviceAppointments[e.ServiceAppointmentId].resourceName=e.ServiceResourceId,I.serviceAppointments[e.ServiceAppointmentId].assignedResource="Updated By Optimizer",I.serviceAppointments[e.ServiceAppointmentId].travelTimeFrom=e.EstimatedTravelTimeFrom__c||e.FSL__EstimatedTravelTimeFrom__c,I.serviceAppointments[e.ServiceAppointmentId].travelTimeTo=e.EstimatedTravelTime,I.serviceAppointments[e.ServiceAppointmentId].setSchedulerPropertiesAfterOutputJson("assignedResource")}),e.AssignedResourcesToDelete&&e.AssignedResourcesToDelete.forEach(function(e){I.serviceAppointments[e.ServiceAppointmentId].resource=null,I.serviceAppointments[e.ServiceAppointmentId].schedEndTime=null,I.serviceAppointments[e.ServiceAppointmentId].schedStartTime=null,I.serviceAppointments[e.ServiceAppointmentId].resourceName=null,I.serviceAppointments[e.ServiceAppointmentId].assignedResource="Deleted By Optimizer",I.serviceAppointments[e.ServiceAppointmentId].travelTimeFrom=null,I.serviceAppointments[e.ServiceAppointmentId].travelTimeTo=null,I.serviceAppointments[e.ServiceAppointmentId].status=serviceStatuses.NONE,I.serviceAppointments[e.ServiceAppointmentId].statusCategory="None",I.serviceAppointments[e.ServiceAppointmentId].setSchedulerPropertiesAfterOutputJson("assignedResource")}),e.Absences&&e.Absences.forEach(function(e){O(e,"ResourceAbsence",M(e)),I.resourceAbsences[e.Id].start=e.Start,I.resourceAbsences[e.Id].end=e.End,I.resourceAbsences[e.Id].travelTo=e.EstTravelTime__c?60*e.EstTravelTime__c:0,I.resourceAbsences[e.Id].travelFrom=e.EstTravelTimeFrom__c?60*e.EstTravelTimeFrom__c:0,I.resourceAbsences[e.Id].setSchedulerProperties()}),e.BreaksToDelete&&e.BreaksToDelete.forEach(function(e){scheduler.deleteEvent(I.resourceAbsences[e.Id].id),delete I.resourceAbsences[e.Id]}),e.BreaksToCreate&&e.BreaksToCreate.forEach(function(e){e.Id=r,E(e,!0),r++}),e.assignedResourcesToUpsert&&e.assignedResourcesToUpsert.forEach(function(e){e.ServiceResourceId&&(I.serviceAppointments[e.ServiceAppointmentId].resource=e.ServiceResourceId),I.serviceAppointments[e.ServiceAppointmentId].resourceName=e.ServiceResourceId,I.serviceAppointments[e.ServiceAppointmentId].assignedResource=e.Id?"Updated By Optimizer":"Created By Optimizer",e.FSL__EstimatedTravelTimeFrom__c||(I.serviceAppointments[e.ServiceAppointmentId].travelTimeFrom=e.EstimatedTravelTimeFrom__c||e.FSL__EstimatedTravelTimeFrom__c),e.EstimatedTravelTime||(I.serviceAppointments[e.ServiceAppointmentId].travelTimeTo=e.EstimatedTravelTime),e.Id||(I.serviceAppointments[e.ServiceAppointmentId].status=serviceStatuses.SCHEDULED),e.Id||(I.serviceAppointments[e.ServiceAppointmentId].statusCategory="Scheduled"),I.serviceAppointments[e.ServiceAppointmentId].setSchedulerPropertiesAfterOutputJson("assignedResource")}),e.lunchBreaksToUpsert&&e.lunchBreaksToUpsert.forEach(function(e){k(e,"ResourceAbsence"),e.Id?(O(e,"ResourceAbsence",M(e)),I.resourceAbsences[e.Id].start=e.Start,I.resourceAbsences[e.Id].end=e.End):(e.Id=r,E(e,!0),r++)}),e.resourceAbsencesToUpsert&&e.resourceAbsencesToUpsert.forEach(function(e){k(e,"ResourceAbsence"),O(e,"ResourceAbsence",M(e)),I.resourceAbsences[e.Id].start=e.Start,I.resourceAbsences[e.Id].end=e.End,I.resourceAbsences[e.Id].travelTo=e.EstTravelTime__c?60*e.EstTravelTime__c:0,I.resourceAbsences[e.Id].travelFrom=e.EstTravelTimeFrom__c?60*e.EstTravelTimeFrom__c:0,I.resourceAbsences[e.Id].setSchedulerProperties()}),e.resourceAbsencesToDelete&&e.resourceAbsencesToDelete.forEach(function(e){})}),a.updateObjectsForOptimizationViewer(I),o.$broadcast("gotNewTimePhasedObjects",I),I.start),n=new Date(n.getFullYear(),n.getMonth(),n.getDate()+1,0,0);scheduler.setCurrentView(n),L=!0})},loadOptimizationRequestInput:x,i_OptimizationRequestName:function(){return w}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","TimePhasedDataService","SERVICE_STATUS","sfdcService","utils","$injector","calendarsService","ResourceCrewsService","ResourceCapacitiesService","HolidayService","$http"],angular.module("serviceExpert").factory("LoadOptiViewerDataService",e)}(),GanttServiceOptiViewer.prototype.setSchedulerProperties=function(){var e,t={schedStartTime:"start",schedEndTime:"finish",dueDate:"dueDate",earliestStartTime:"earlyStart",arrivalWindowStartTime:"appStart",arrivalWindowEndTime:"appEnd",actualStartTime:"actualStartTime",actualEndTime:"actualEndTime",ganttDisplay:"ganttDisplay"};for(e in t)this[t[e]]=__setTimeZoneOffsetToDateField(this[e]);this.type="service",this.travelTo=this.travelTimeTo?60*parseInt(this.travelTimeTo):0,this.travelFrom=this.travelTimeFrom?60*parseInt(this.travelTimeFrom):0,this.estDuration=this.estDuration?parseFloat(this.estDuration):null,this.text=this.ganttLabel?this.ganttLabel.encodeHTML():this.name},GanttServiceOptiViewer.prototype.setSchedulerPropertiesAfterOutputJson=function(e){if("service"===e){var t,n={schedStartTime:"start",schedEndTime:"finish"};for(t in n)this[n[t]]=__setTimeZoneOffsetToDateField(this[t])}else"assignedResource"===e&&(this.travelTo=this.travelTimeTo?60*parseInt(this.travelTimeTo):0,this.travelFrom=this.travelTimeFrom?60*parseInt(this.travelTimeFrom):0)},GanttServiceOptiViewer.prototype.setGanttResource=function(e,t){if(this.isScheduled()){var n,i=e[this.resource],s=[];for(n in this.resourceId=null,this.start_date=__setTimeZoneOffsetToDateField(this.schedStartTime),this.end_date=__setTimeZoneOffsetToDateField(this.schedEndTime),i){var r=i[n];"R"===r.serviceTerritoryType&&(isIntersectIncludeLimits(r.effectiveStartDate,r.effectiveEndDate,this.start_date,this.end_date)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}if(0===s.length)for(var o in i){o=i[o];isIntersectIncludeLimits(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.start_date)&&s.push(o.serviceTerritory)}else if(showSecondarySTMs)for(var a in i){a=i[a];"S"===a.serviceTerritoryType&&isIntersectIncludeLimits(a.effectiveStartDate,a.effectiveEndDate,this.start_date,this.end_date)&&s.push(a.serviceTerritory)}this.resourceId=t(this.resource,s),this.isScheduled()&&this.updateDatesBasedOnTravel()}},GanttServiceOptiViewer.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds||(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds),this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60))),this.travelTo)&&(this.travelTo<=maxTravelTimeInSeconds||(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds),this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)))},GanttServiceOptiViewer.prototype.isScheduled=function(){return this.resource&&this.schedEndTime&&this.schedStartTime},GanttServiceOptiViewer.prototype.getGanttResource=function(e){return e&&getGanttResourceWithSecondaryStms(this),this.resourceId&&this.resourceId.substr(0,18)},GanttServiceOptiViewer.prototype.getGanttTerritory=function(){return this.resourceId&&this.resourceId.substr(19,37)},GanttServiceOptiViewer.prototype.isChanged=function(e){return this.AssignedResourceLastModifiedDate!=e.AssignedResourceLastModifiedDate||this.ServiceAppointmentLastModifiedDate!=e.ServiceAppointmentLastModifiedDate},GanttServiceOptiViewer.prototype.isGotNewSTM=function(e){return""===this.resourceId&&e.resource},GanttServiceOptiViewer.prototype.isChainChanged=function(e){return this.isServiceInChain!=e.isServiceInChain||this.relatedService1!=e.relatedService1||this.relatedService2!=e.relatedService2},GanttServiceOptiViewer.prototype.minPriority=1e6,GanttServiceOptiViewer.copy=function(e){var t=new GanttServiceOptiViewer(null,!0);return angular.merge(t,e),t},GanttServiceOptiViewer.prototype.calculateMdtTimes=function(e){try{this.mdtTimes=JSON.parse(e);var i=1e3*(new Date).getTimezoneOffset()*60,s={travel:[],working:[]};this.mdtTimes.forEach(function(e){var t=moment.tz(e.Start,userTimeZone),n=moment.tz(e.Finish,userTimeZone),t=new Date(t.valueOf()+60*t._offset*1e3+i),n=new Date(n.valueOf()+60*n._offset*1e3+i);e.Start=t,e.Finish=n,"OperationalSlot"===e.Type?s.working.push(e):"Travel"===e.Type&&s.travel.push(e)}),this.mdtTimes=s}catch(e){this.mdtTimes={travel:[],working:[]}}};