"use strict";(globalThis.webpackChunkmaps_desktop=globalThis.webpackChunkmaps_desktop||[]).push([[613],{6616:(e,s,t)=>{t.r(s),t.d(s,{default:()=>c});var o=t(257),r=t(6076),a=t(2646),i=t(5735),n=t.n(i);const{jQuery:l}=window,d={components:{Modal:a.u_,Spinner:a.$j},props:{modalOptions:{type:Object,default:()=>{}}},data:()=>({layerMap:{},recordsToRemoveMap:{},isLoading:!1,totalProgress:0,batchesComplete:0}),computed:{batchProgress(){const e=Math.round(this.batchesComplete/this.totalProgress*100);return Number.isNaN(e)?0:e},progressStyle(){return{width:`${this.batchProgress}%`}}},created(){this.createLayerMap()},methods:{close(){this.$emit("close")},processClearCoordinates(e=!1){this.isLoading=!0,this.totalProgress=0;const s={errorTotal:0},t=n()(((t,o)=>{this.clearCoordinates(t,e).then(((e=[])=>{e.forEach((e=>{e.success?(this.recordsToRemoveMap[e.queryId]||(this.recordsToRemoveMap[e.queryId]=[]),this.recordsToRemoveMap[e.queryId].push(e)):s.errorTotal++}))})).catch((e=>{const{message:o=this.$Labels.Common_Refresh_And_Try_Again_Contact_Admin}=e,{recordIds:r=[]}=t;s.errorTotal+=r.length,console.warn(`Clear Coordinates Error (${o}): `,t)})).finally((()=>{this.batchesComplete++,o()}))}),3),{records:o=[]}=this.modalOptions;this.createBatchableRecords(o,200).forEach((e=>{this.totalProgress++,t.push(e)})),t.drain=()=>{this.clearRecordsFromMap(e).finally((()=>{this.isLoading=!1})),s.errorTotal>0&&window.MAToastMessages.showWarning({message:(0,r.N4)(this.$Labels.Clear_Coordinates_Cannot_Clear,[s.errorTotal]),timeOut:0,closeButton:!0}),this.$nextTick((()=>{this.close()}))}},createLayerMap(){const e={};document.querySelectorAll("#PlottedQueriesTable .savedQuery").forEach((s=>{const t=s.getAttribute("qid");if(t){const o=l(s).data(),{options:r={},addressFields:a={}}=o;e[t]={coordinateFields:{AddressObject:r.addressObject||"",Latitude:a.latitude||"",Longitude:a.longitude||"",VerifiedLongitude:a.verifiedLongitude||"",VerifiedLatitude:a.verifiedLatitude||""},qid:t,layer:s}}})),this.layerMap=e},clearCoordinates(e,s){return new Promise(((t,r)=>{const a={ajaxResource:"TooltipAJAXResources",action:"clear_coordinates",serializedQueriesToClear:JSON.stringify([e]),includeVerifiedCoordinates:s};(new o.Z).setAction("maps.RemoteFunctions.processAJAXRequest").setErrorHandler((e=>{console.warn(e),r(e)})).invoke([a],(e=>{const{success:s=!1,data:o=[]}=e;if(s)t(o);else{const{details:s=this.$Labels.Clear_Coordinates_Cannot_Clear_Coordinates}=e;r(new Error(s))}}),{escape:!1,buffer:!1})}))},createBatchableRecords(e=[],s=200){const t={},o=[];for(let r=0;r<e.length;r++){const a=e[r];if(!a.isLiveRecord){const{qid:e=""}=a;t[e]||(t[e]=[]);const r=this.layerMap[e];if(a.polyObjectField){const s=a[a.polyObjectField]||{},{Id:o=""}=s;t[e].push(`${o}::${a.Id}`)}else if(-1===r.coordinateFields.Latitude.indexOf("."))t[e].push(`${a.Id}::${a.Id}`);else{const s=r.coordinateFields.Latitude.split("."),[o]=s,i=a[o]||{},{Id:n=""}=i;t[e].push(`${n}::${a.Id}`)}if(t[e].length===s){const s=this.layerMap[e];o.push({recordIds:t[e],coordinateFields:s.coordinateFields,queryId:e}),t[e]=[]}}}const r=Object.keys(t);for(let e=0;e<r.length;e++){const s=r[e],a=t[s];if(a.length>0){const e=this.layerMap[s];o.push({recordIds:a,coordinateFields:e.coordinateFields,queryId:s})}}return o},clearRecordsFromMap(e=!1){return new Promise((s=>{const t=[];Object.keys(this.recordsToRemoveMap).forEach((s=>{const o=this.recordsToRemoveMap[s];t.push(this.recordRemovalPromise(s,o,e))})),Promise.all(t).finally((()=>{s()}))}))},recordRemovalPromise(e,s,t=!1){return new Promise(((o,r)=>{const a=this.layerMap[e]||{},{layer:i,coordinateFields:n={}}=a,{VerifiedLatitude:d="",VerifiedLongitude:c=""}=n;if(i){const a=l(i).data("records");if(a){let e=0;const r=s.length,n=[];setTimeout((function u(){if(e<r){let o=0;for(;o<50&&e<r;){o++;const r=s[e],{markerId:i=""}=r,l=a[i];n.push(l);const u={lat:window.getProperty(l,d),lng:window.getProperty(l,c)};(t||!u.lat&&!u.lng)&&window.RemoveMarkerDesktop(l,{updateQueryInfo:!1}),e++}setTimeout(u,50)}else{if(n.length){const e={wholeLayer:!1,markers:n};window.MA.markerSelection.updateUnselected(e)}window.Plotting.updateQueryInfo(l(i)),o()}}),1)}else console.warn(`records not found for layer: ${e}`),r()}else console.warn(`layer not found: ${e}`),r()}))}}},c=(0,t(1900).Z)(d,(function(){var e=this,s=e._self._c;return s("Modal",{staticClass:"permission-modal",attrs:{title:e.$Labels.MA_Clear_Coordinates,labels:{close:e.$Labels.MA_Close}},on:{close:e.close}},[s("div",{attrs:{slot:"content"},slot:"content"},[e.isLoading?s("Spinner"):e._e(),e._v(" "),s("div",{directives:[{name:"show",rawName:"v-show",value:e.isLoading,expression:"isLoading"}],staticClass:"slds-progress-bar slds-progress-bar_small",staticStyle:{position:"absolute",top:"0",left:"0"},attrs:{"aria-valuemin":"0","aria-valuemax":"100","aria-valuenow":"25",role:"progressbar"}},[s("span",{staticClass:"slds-progress-bar__value",style:e.progressStyle},[s("span",{staticClass:"slds-assistive-text"},[e._v("Progress: 25%")])])]),e._v(" "),s("p",{staticClass:"popup-instructions"},[e._v(e._s(e.$Labels.MA_Clear_Coord_Info))])],1),e._v(" "),s("template",{slot:"footer"},[s("button",{staticClass:"slds-button slds-button_neutral",attrs:{disabled:e.isLoading},on:{click:e.close}},[e._v("\n            "+e._s(e.$Labels.MA_Cancel)+"\n        ")]),e._v(" "),s("button",{staticClass:"slds-button slds-button_brand",attrs:{disabled:e.isLoading},on:{click:function(s){return e.processClearCoordinates(!1)}}},[e._v("\n            "+e._s(e.$Labels.MA_Clear_Coord_Unverified)+"\n        ")]),e._v(" "),s("button",{staticClass:"slds-button slds-button_brand",attrs:{disabled:e.isLoading},on:{click:function(s){return e.processClearCoordinates(!0)}}},[e._v("\n            "+e._s(e.$Labels.MA_Clear_Coord_Verified)+"\n        ")])])],2)}),[],!1,null,null,null).exports}}]);